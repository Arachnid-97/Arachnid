<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Ubuntu下 FTP的搭建配置</title>
      <link href="/docs/Linux/Ubuntu%E4%B8%8B%20FTP%E7%9A%84%E6%90%AD%E5%BB%BA%E9%85%8D%E7%BD%AE/"/>
      <url>/docs/Linux/Ubuntu%E4%B8%8B%20FTP%E7%9A%84%E6%90%AD%E5%BB%BA%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<blockquote><p>平台：Ubuntu 18.04.6</p><p>vsftpd 官网：<span class="exturl" data-url="aHR0cHM6Ly9zZWN1cml0eS5hcHBzcG90LmNvbS92c2Z0cGQuaHRtbA==">https://security.appspot.com/vsftpd.html</span></p></blockquote><h1 id="安装"><a class="anchor" href="#安装">#</a> 安装</h1><p>安装 FTP 服务，命令行输入：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> vsftpd</pre></td></tr></table></figure><h1 id="配置"><a class="anchor" href="#配置">#</a> 配置</h1><p>先备份配置文件：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">sudo</span> <span class="token function">cp</span> /etc/vsftpd.conf /etc/vsftpd.conf.back</pre></td></tr></table></figure><p>vim 进入编辑信息：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">sudo</span> <span class="token function">vim</span> /etc/vsftpd.conf</pre></td></tr></table></figure><p>然后增加或修改以下信息：</p><figure class="highlight makefile"><figcaption data-lang="makefile"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># Example config file /etc/vsftpd.conf</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># The default compiled in settings are fairly paranoid. This sample file</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># loosens things up a bit, to make the ftp daemon more usable.</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># Please see vsftpd.conf.5 for all compiled in defaults.</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># READ THIS: This example file is NOT an exhaustive list of vsftpd options.</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># Please read the vsftpd.conf.5 manual page to get a full idea of vsftpd's</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># capabilities.</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># Run standalone?  vsftpd can run either from an inetd or as a standalone</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment"># daemon started from an initscript.</span></pre></td></tr><tr><td data-num="14"></td><td><pre>listen<span class="token operator">=</span>NO <span class="token comment">#是否开启侦听状态</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment"># This directive enables listening on IPv6 sockets. By default, listening</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment"># on the IPv6 "any" address (::) will accept connections from both IPv6</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment"># and IPv4 clients. It is not necessary to listen on *both* IPv4 and IPv6</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment"># sockets. If you want that (perhaps because you want to listen on specific</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment"># addresses) then you must run two copies of vsftpd with two configuration</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment"># files.</span></pre></td></tr><tr><td data-num="22"></td><td><pre>listen_ipv6<span class="token operator">=</span>YES <span class="token comment">#如果能使用 ipv6 的可以打开使用；只能用 ipv4 的必须注释掉，不然重启不了</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment"># Allow anonymous FTP? (Disabled by default).</span></pre></td></tr><tr><td data-num="25"></td><td><pre>anonymous_enable<span class="token operator">=</span>YES <span class="token comment">#允许匿名用户登录</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token comment"># Uncomment this to allow local users to log in.</span></pre></td></tr><tr><td data-num="28"></td><td><pre>local_enable<span class="token operator">=</span>YES <span class="token comment">#允许实名登录</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token comment"># Uncomment this to enable any form of FTP write command.</span></pre></td></tr><tr><td data-num="31"></td><td><pre>write_enable<span class="token operator">=</span>YES <span class="token comment">#允许实名用户进行写操作</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token comment"># Default umask for local users is 077. You may wish to change this to 022,</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token comment"># if your users expect that (022 is used by most other ftpd's)</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token comment">#local_umask=022</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token comment"># Uncomment this to allow the anonymous FTP user to upload files. This only</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token comment"># has an effect if the above global write enable is activated. Also, you will</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token comment"># obviously need to create a directory writable by the FTP user.</span></pre></td></tr><tr><td data-num="40"></td><td><pre>anon_upload_enable<span class="token operator">=</span>YES <span class="token comment">#允许匿名用户上传文件</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token comment"># Uncomment this if you want the anonymous FTP user to be able to create</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token comment"># new directories.</span></pre></td></tr><tr><td data-num="44"></td><td><pre>anon_mkdir_write_enable<span class="token operator">=</span>YES <span class="token comment">#允许匿名用户创建目录</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token comment"># Activate directory messages - messages given to remote users when they</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token comment"># go into a certain directory.</span></pre></td></tr><tr><td data-num="48"></td><td><pre>dirmessage_enable<span class="token operator">=</span>YES</pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token comment"># If enabled, vsftpd will display directory listings with the time</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token comment"># in  your  local  time  zone.  The default is to display GMT. The</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token comment"># times returned by the MDTM FTP command are also affected by this</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token comment"># option.</span></pre></td></tr><tr><td data-num="54"></td><td><pre>use_localtime<span class="token operator">=</span>YES</pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token comment"># Activate logging of uploads/downloads.</span></pre></td></tr><tr><td data-num="57"></td><td><pre>xferlog_enable<span class="token operator">=</span>YES</pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token comment"># Make sure PORT transfer connections originate from port 20 (ftp-data).</span></pre></td></tr><tr><td data-num="60"></td><td><pre>connect_from_port_20<span class="token operator">=</span>YES</pre></td></tr><tr><td data-num="61"></td><td><pre></pre></td></tr><tr><td data-num="62"></td><td><pre><span class="token comment"># If you want, you can arrange for uploaded anonymous files to be owned by</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token comment"># a different user. Note! Using "root" for uploaded files is not</span></pre></td></tr><tr><td data-num="64"></td><td><pre><span class="token comment"># recommended!</span></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token comment">#chown_uploads=YES</span></pre></td></tr><tr><td data-num="66"></td><td><pre><span class="token comment">#chown_username=whoever</span></pre></td></tr><tr><td data-num="67"></td><td><pre></pre></td></tr><tr><td data-num="68"></td><td><pre><span class="token comment"># You may override where the log file goes if you like. The default is shown</span></pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token comment"># below.</span></pre></td></tr><tr><td data-num="70"></td><td><pre><span class="token comment">#xferlog_file=/var/log/vsftpd.log</span></pre></td></tr><tr><td data-num="71"></td><td><pre></pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token comment"># If you want, you can have your log file in standard ftpd xferlog format.</span></pre></td></tr><tr><td data-num="73"></td><td><pre><span class="token comment"># Note that the default log file location is /var/log/xferlog in this case.</span></pre></td></tr><tr><td data-num="74"></td><td><pre><span class="token comment">#xferlog_std_format=YES</span></pre></td></tr><tr><td data-num="75"></td><td><pre></pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token comment"># You may change the default value for timing out an idle session.</span></pre></td></tr><tr><td data-num="77"></td><td><pre><span class="token comment">#idle_session_timeout=600</span></pre></td></tr><tr><td data-num="78"></td><td><pre></pre></td></tr><tr><td data-num="79"></td><td><pre><span class="token comment"># You may change the default value for timing out a data connection.</span></pre></td></tr><tr><td data-num="80"></td><td><pre><span class="token comment">#data_connection_timeout=120</span></pre></td></tr><tr><td data-num="81"></td><td><pre></pre></td></tr><tr><td data-num="82"></td><td><pre><span class="token comment"># It is recommended that you define on your system a unique user which the</span></pre></td></tr><tr><td data-num="83"></td><td><pre><span class="token comment"># ftp server can use as a totally isolated and unprivileged user.</span></pre></td></tr><tr><td data-num="84"></td><td><pre><span class="token comment">#nopriv_user=ftpsecure</span></pre></td></tr><tr><td data-num="85"></td><td><pre></pre></td></tr><tr><td data-num="86"></td><td><pre><span class="token comment"># Enable this and the server will recognise asynchronous ABOR requests. Not</span></pre></td></tr><tr><td data-num="87"></td><td><pre><span class="token comment"># recommended for security (the code is non-trivial). Not enabling it,</span></pre></td></tr><tr><td data-num="88"></td><td><pre><span class="token comment"># however, may confuse older FTP clients.</span></pre></td></tr><tr><td data-num="89"></td><td><pre><span class="token comment">#async_abor_enable=YES</span></pre></td></tr><tr><td data-num="90"></td><td><pre></pre></td></tr><tr><td data-num="91"></td><td><pre><span class="token comment"># By default the server will pretend to allow ASCII mode but in fact ignore</span></pre></td></tr><tr><td data-num="92"></td><td><pre><span class="token comment"># the request. Turn on the below options to have the server actually do ASCII</span></pre></td></tr><tr><td data-num="93"></td><td><pre><span class="token comment"># mangling on files when in ASCII mode.</span></pre></td></tr><tr><td data-num="94"></td><td><pre><span class="token comment"># Beware that on some FTP servers, ASCII support allows a denial of service</span></pre></td></tr><tr><td data-num="95"></td><td><pre><span class="token comment"># attack (DoS) via the command "SIZE /big/file" in ASCII mode. vsftpd</span></pre></td></tr><tr><td data-num="96"></td><td><pre><span class="token comment"># predicted this attack and has always been safe, reporting the size of the</span></pre></td></tr><tr><td data-num="97"></td><td><pre><span class="token comment"># raw file.</span></pre></td></tr><tr><td data-num="98"></td><td><pre><span class="token comment"># ASCII mangling is a horrible feature of the protocol.</span></pre></td></tr><tr><td data-num="99"></td><td><pre><span class="token comment">#ascii_upload_enable=YES</span></pre></td></tr><tr><td data-num="100"></td><td><pre><span class="token comment">#ascii_download_enable=YES</span></pre></td></tr><tr><td data-num="101"></td><td><pre></pre></td></tr><tr><td data-num="102"></td><td><pre><span class="token comment"># You may fully customise the login banner string:</span></pre></td></tr><tr><td data-num="103"></td><td><pre><span class="token comment">#ftpd_banner=Welcome to blah FTP service.</span></pre></td></tr><tr><td data-num="104"></td><td><pre></pre></td></tr><tr><td data-num="105"></td><td><pre><span class="token comment"># You may specify a file of disallowed anonymous e-mail addresses. Apparently</span></pre></td></tr><tr><td data-num="106"></td><td><pre><span class="token comment"># useful for combatting certain DoS attacks.</span></pre></td></tr><tr><td data-num="107"></td><td><pre><span class="token comment">#deny_email_enable=YES</span></pre></td></tr><tr><td data-num="108"></td><td><pre><span class="token comment"># (default follows)</span></pre></td></tr><tr><td data-num="109"></td><td><pre><span class="token comment">#banned_email_file=/etc/vsftpd.banned_emails</span></pre></td></tr><tr><td data-num="110"></td><td><pre></pre></td></tr><tr><td data-num="111"></td><td><pre><span class="token comment"># You may restrict local users to their home directories.  See the FAQ for</span></pre></td></tr><tr><td data-num="112"></td><td><pre><span class="token comment"># the possible risks in this before using chroot_local_user or</span></pre></td></tr><tr><td data-num="113"></td><td><pre><span class="token comment"># chroot_list_enable below.</span></pre></td></tr><tr><td data-num="114"></td><td><pre>chroot_local_user<span class="token operator">=</span>YES <span class="token comment">#用户访问将被限制在当前目录</span></pre></td></tr><tr><td data-num="115"></td><td><pre></pre></td></tr><tr><td data-num="116"></td><td><pre><span class="token comment"># You may specify an explicit list of local users to chroot() to their home</span></pre></td></tr><tr><td data-num="117"></td><td><pre><span class="token comment"># directory. If chroot_local_user is YES, then this list becomes a list of</span></pre></td></tr><tr><td data-num="118"></td><td><pre><span class="token comment"># users to NOT chroot().</span></pre></td></tr><tr><td data-num="119"></td><td><pre><span class="token comment"># (Warning! chroot'ing can be very dangerous. If using chroot, make sure that</span></pre></td></tr><tr><td data-num="120"></td><td><pre><span class="token comment"># the user does not have write access to the top level directory within the</span></pre></td></tr><tr><td data-num="121"></td><td><pre><span class="token comment"># chroot)</span></pre></td></tr><tr><td data-num="122"></td><td><pre><span class="token comment">#chroot_local_user=YES</span></pre></td></tr><tr><td data-num="123"></td><td><pre><span class="token comment">#chroot_list_enable=YES</span></pre></td></tr><tr><td data-num="124"></td><td><pre><span class="token comment"># (default follows)</span></pre></td></tr><tr><td data-num="125"></td><td><pre><span class="token comment">#chroot_list_file=/etc/vsftpd.chroot_list</span></pre></td></tr><tr><td data-num="126"></td><td><pre></pre></td></tr><tr><td data-num="127"></td><td><pre><span class="token comment"># You may activate the "-R" option to the builtin ls. This is disabled by</span></pre></td></tr><tr><td data-num="128"></td><td><pre><span class="token comment"># default to avoid remote users being able to cause excessive I/O on large</span></pre></td></tr><tr><td data-num="129"></td><td><pre><span class="token comment"># sites. However, some broken FTP clients such as "ncftp" and "mirror" assume</span></pre></td></tr><tr><td data-num="130"></td><td><pre><span class="token comment"># the presence of the "-R" option, so there is a strong case for enabling it.</span></pre></td></tr><tr><td data-num="131"></td><td><pre><span class="token comment">#ls_recurse_enable=YES</span></pre></td></tr><tr><td data-num="132"></td><td><pre></pre></td></tr><tr><td data-num="133"></td><td><pre><span class="token comment"># Customization</span></pre></td></tr><tr><td data-num="134"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="135"></td><td><pre><span class="token comment"># Some of vsftpd's settings don't fit the filesystem layout by</span></pre></td></tr><tr><td data-num="136"></td><td><pre><span class="token comment"># default.</span></pre></td></tr><tr><td data-num="137"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="138"></td><td><pre><span class="token comment"># This option should be the name of a directory which is empty.  Also, the</span></pre></td></tr><tr><td data-num="139"></td><td><pre><span class="token comment"># directory should not be writable by the ftp user. This directory is used</span></pre></td></tr><tr><td data-num="140"></td><td><pre><span class="token comment"># as a secure chroot() jail at times vsftpd does not require filesystem</span></pre></td></tr><tr><td data-num="141"></td><td><pre><span class="token comment"># access.</span></pre></td></tr><tr><td data-num="142"></td><td><pre>secure_chroot_dir<span class="token operator">=</span>/var/run/vsftpd/empty</pre></td></tr><tr><td data-num="143"></td><td><pre></pre></td></tr><tr><td data-num="144"></td><td><pre><span class="token comment"># This string is the name of the PAM service vsftpd will use.</span></pre></td></tr><tr><td data-num="145"></td><td><pre>pam_service_name<span class="token operator">=</span>vsftpd</pre></td></tr><tr><td data-num="146"></td><td><pre></pre></td></tr><tr><td data-num="147"></td><td><pre><span class="token comment"># This option specifies the location of the RSA certificate to use for SSL</span></pre></td></tr><tr><td data-num="148"></td><td><pre><span class="token comment"># encrypted connections.</span></pre></td></tr><tr><td data-num="149"></td><td><pre>rsa_cert_file<span class="token operator">=</span>/etc/ssl/certs/ssl-cert-snakeoil.pem</pre></td></tr><tr><td data-num="150"></td><td><pre>rsa_private_key_file<span class="token operator">=</span>/etc/ssl/<span class="token keyword">private</span>/ssl-cert-snakeoil.key</pre></td></tr><tr><td data-num="151"></td><td><pre>ssl_enable<span class="token operator">=</span>NO</pre></td></tr><tr><td data-num="152"></td><td><pre></pre></td></tr><tr><td data-num="153"></td><td><pre></pre></td></tr><tr><td data-num="154"></td><td><pre><span class="token comment"># Uncomment this to indicate that vsftpd use a utf8 filesystem.</span></pre></td></tr><tr><td data-num="155"></td><td><pre>utf8_filesystem<span class="token operator">=</span>YES</pre></td></tr><tr><td data-num="156"></td><td><pre></pre></td></tr><tr><td data-num="157"></td><td><pre></pre></td></tr><tr><td data-num="158"></td><td><pre>no_anon_password<span class="token operator">=</span>YES <span class="token comment">#匿名登录是否需要密码</span></pre></td></tr><tr><td data-num="159"></td><td><pre>anon_root<span class="token operator">=</span>/home/frd_lzy <span class="token comment">#匿名登录访问的文件路径</span></pre></td></tr><tr><td data-num="160"></td><td><pre></pre></td></tr><tr><td data-num="161"></td><td><pre>local_root<span class="token operator">=</span>/projects <span class="token comment">#实名登录访问的文件路径</span></pre></td></tr><tr><td data-num="162"></td><td><pre></pre></td></tr><tr><td data-num="163"></td><td><pre>allow_writeable_chroot<span class="token operator">=</span>YES</pre></td></tr></table></figure><p>编辑完成后， <code>:wq</code>  保存退出。</p><h1 id="重新加载配置文件"><a class="anchor" href="#重新加载配置文件">#</a> 重新加载配置文件</h1><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">sudo</span> /etc/init.d/vsftpd restart</pre></td></tr></table></figure><h1 id="启动服务"><a class="anchor" href="#启动服务">#</a> 启动服务</h1><p>在加载完后，重启服务器：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">sudo</span> systemctl restart vsftpd</pre></td></tr></table></figure><p>查看服务启动状态：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">sudo</span> systemctl status vsftpd</pre></td></tr></table></figure><p><img data-src="image-20221106152005206.png" alt="image-20221106152005206" /></p><p>设置开机启动：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> vsftpd</pre></td></tr></table></figure><p>如果想关闭开机启动：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">sudo</span> systemctl disable vsftpd</pre></td></tr></table></figure><h1 id="ftp连接"><a class="anchor" href="#ftp连接">#</a> FTP 连接</h1><p>本机连接：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">ftp</span> <span class="token number">127.0</span>.0.1</pre></td></tr></table></figure><p>其它电脑连接：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">ftp</span> <span class="token function">ip</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># eg:ftp 192.168.0.3</span></pre></td></tr></table></figure><p>1、输入用户名：（1）匿名：anonymous 或 ftp （2）主机用户名：即你当前主机名。</p><p>2、回车。</p><p>3、如果需要密码则进行相应输入，这里上面配置设了匿名登录不需要密码，所以以匿名登录时没有提示输入密码。</p><p>4、进入到相应的用户访问根目录里（ps：即进入到配置文件中设置的登录访问的文件路径，可以用  <code>ls</code>  查看是否对应上访问的文件目录），这样就可以愉快的玩耍了；输入：  <code>quit</code>  退出。</p><p>eg：本地连接并退出，如下图：</p><p><img data-src="image-20221106164252568.png" alt="image-20221106164252568" /></p><p>windows 下可视化文件访问：按  <code>Win</code>  +  <code>E</code>  快捷键，调用文件资源管理器，输入访问地址，回车：</p><p><img data-src="image-20221106160826118.png" alt="image-20221106160826118" /></p><p>windows 下命令行文件访问：同样按  <code>Win</code>  +  <code>E</code>  快捷键，调用文件资源管理器，然后在输写框跟上面 linux 访问连接一样输入  <code>ftp ip</code>  ，即可跳到 ftp 操作控制台中：</p><p><img data-src="image-20221106161411644.png" alt="image-20221106161411644" /></p><h1 id="ftp客户端常用命令"><a class="anchor" href="#ftp客户端常用命令">#</a> FTP 客户端常用命令</h1><p>在登录进入 ftp 后，可以使用  <code>help</code>  查看可以使用哪些指令操作：</p><p><img data-src="image-20221106163512272.png" alt="image-20221106163512272" /></p><ul><li><p>ls：和 linux 上的 ls 命令类似</p></li><li><p>Ctrl+Shift + L：清屏</p></li><li><p>put：使用  <code>put [本地文件路径+名称]</code>  上传</p></li><li><p>get：使用  <code>get [远程文件路径+名称]</code>  下载</p></li><li><p>mput：批量上传多个文件  <code>mput 文件名1 文件名2</code></p></li><li><p>mget：批量获取多个文件  <code>mget 文件名1 文件名2</code></p></li><li><p>prompt：屏蔽批量输出信息，批量上传下载文件就不需要一直回车确认了</p></li><li><p>quit：退出 ftp 访问</p></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> history </tag>
            
            <tag> Linux </tag>
            
            <tag> Ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>wireshark使用</title>
      <link href="/docs/Essay/wireshark%E4%BD%BF%E7%94%A8/"/>
      <url>/docs/Essay/wireshark%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<p>官方说明：</p><p><span class="exturl" data-url="aHR0cHM6Ly93aWtpLndpcmVzaGFyay5vcmcvSG9tZQ==">https://wiki.wireshark.org/Home</span></p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cud2lyZXNoYXJrLm9yZy9kb2NzL3dzdWdfaHRtbF9jaHVua2VkLw==">https://www.wireshark.org/docs/wsug_html_chunked/</span></p><h1 id="着色规则"><a class="anchor" href="#着色规则">#</a> 着色规则</h1><p>在 wireshark 监控界面上，不同的报文会显示不一样样的颜色，它们分别表示不同的含义；而这些颜色，都是是由着色规则设置的：</p><p><img data-src="image-20221006162351042.png" alt="image-20221006162351042" /></p><p>在默认的着色规则中，一般黑色背景代表报文的各类错误，红色背景代表各类异常情景，其它颜色代表正常。</p><p>官方的说明可以看：<span class="exturl" data-url="aHR0cHM6Ly93d3cud2lyZXNoYXJrLm9yZy9kb2NzL3dzdWdfaHRtbF9jaHVua2VkL0NoQ3VzdENvbG9yaXphdGlvblNlY3Rpb24uaHRtbA==">https://www.wireshark.org/docs/wsug_html_chunked/ChCustColorizationSection.html</span></p><p>着色规则分析：</p><p><strong>1、Bad TCP：</strong> tcp.analysis.flags &amp;&amp; !tcp.analysis.window_update &amp;&amp; !tcp.analysis.keep_alive &amp;&amp; !tcp.analysis.keep_alive_ack</p><p>即 TCP 包损坏，通常表示为重传，乱序，丢包，重复响应等都在此条规则的范围内。具体看第三大点。</p><p>参看：<span class="exturl" data-url="aHR0cHM6Ly93d3cud2lyZXNoYXJrLm9yZy9kb2NzL3dzdWdfaHRtbF9jaHVua2VkL0NoQWR2VENQQW5hbHlzaXMuaHRtbA==">https://www.wireshark.org/docs/wsug_html_chunked/ChAdvTCPAnalysis.html</span></p><p><strong>2、HSRP State Change：</strong> hsrp.state != 8 &amp;&amp; hsrp.state != 16</p><p>HSRP 即热备份路由协议（Hot Standby Router Protocol），这条规则表明当前报文状态非 Standby 和 Active。</p><p>HSRP 的状态值可以是以下几种：</p><ul><li>0 - Initial</li><li>1 - Learn</li><li>2 - Listen</li><li>4 - Speak</li><li>8 - Standby</li><li>16 - Active</li></ul><p>参考：<span class="exturl" data-url="aHR0cHM6Ly93d3cucmZjLWVkaXRvci5vcmcvcmZjL3JmYzIyODE=">https://www.rfc-editor.org/rfc/rfc2281</span></p><p><strong>3、Spanning Tree Topology  Change：</strong> stp.type == 0x80</p><p>当生成树协议的状态标记为  <code>0x80</code> ，表示着生成树拓扑发生变化。即 STP 协议数据单元 (BPDU) 的  <code>flag</code>  字段发生变化（使用 IEEE-802.1d）：</p><p><img data-src="bpdu.png" alt="img" /></p><p>参考：<span class="exturl" data-url="aHR0cHM6Ly90ZWNoaHViLmhwZS5jb20vZWdpbmZvbGliL25ldHdvcmtpbmcvZG9jcy9zd2l0Y2hlcy81OTgwLzUyMDAtMzkyMV9sMi1sYW5fY2cvY29udGVudC80OTkwMzY2NzIuaHRt">https://techhub.hpe.com/eginfolib/networking/docs/switches/5980/5200-3921_l2-lan_cg/content/499036672.htm</span></p><p><strong>4、OSPF State Change：</strong> ospf.msg != 1</p><p>OSPF（Open Shortest Path First，开放式最短路径优先协议）的 msg 类型不是 Hello 报文。</p><p>OSPF 报文的类型，有下面几种类型：</p><ul><li>1：Hello 报文；</li><li>2：DD 报文；</li><li>3：LSR 报文；</li><li>4：LSU 报文；</li><li>5：LSAck 报文。</li></ul><p>参考：<span class="exturl" data-url="aHR0cDovL3d3dy4wMjN3Zy5jb20vbWVzc2FnZS9tZXNzYWdlL2NkX2ZlYXR1cmVfb3NwZl9tZXNzYWdlLmh0bWw=">http://www.023wg.com/message/message/cd_feature_ospf_message.html</span></p><p><strong>5、ICMP errors：</strong> icmp.type eq 3 || icmp.type eq 4 || icmp.type eq 5 || icmp.type eq 11 || icmpv6.type eq 1 || icmpv6.type eq 2 || icmpv6.type eq 3 || icmpv6.type eq 4</p><p>ICMP 协议错误，协议的 type 字段值错误。</p><p><strong>6、ARP：</strong> arp</p><p>即 ARP 协议。</p><p><strong>7、ICMP：</strong> icmp || icmpv6</p><p>即 ICMP 协议。</p><p><strong>8、TCP RST：</strong> tcp.flags.reset eq 1</p><p>TCP 流产生 reset。</p><p><strong>9、SCTP ABORT：</strong> sctp.chunk_type eq ABORT</p><p>SCTP（即流控制传输协议）发生中止。</p><p>参考：<span class="exturl" data-url="aHR0cHM6Ly93d3cucmZjLWVkaXRvci5vcmcvcmZjL3JmYzQ5NjAjc2VjdGlvbi0zLjMuNw==">https://www.rfc-editor.org/rfc/rfc4960#section-3.3.7</span></p><p><strong>10、TTL low or unexpected：</strong> ( ! ip.dst == 224.0.0.0/4 &amp;&amp; ip.ttl &lt; 5 &amp;&amp; !pim &amp;&amp; !ospf) || (ip.dst == 224.0.0.0/24 &amp;&amp; ip.dst != 224.0.0.251 &amp;&amp; ip.ttl != 1 &amp;&amp; !(vrrp || carp))</p><p>TTL (Time-To-Live) 指解析记录在本地 DNS 服务器中的缓存时间。该规则表示 TTL 产生异常。</p><p>在 IP 组播中，通过 TTL 控件来管理转发数据包的范围，按照惯例：</p><ul><li>0 - 仅限于同一主机上</li><li>1 - 被限制在同一个子网内</li><li>32 仅限于同一站点</li><li>64 - 仅限于同一区域</li><li>128 - 仅限于同一大陆</li><li>255 - 不受限制</li></ul><p>参考：<span class="exturl" data-url="aHR0cHM6Ly93d3cudGVjaHRhcmdldC5jb20vc2VhcmNobmV0d29ya2luZy9kZWZpbml0aW9uL3RpbWUtdG8tbGl2ZQ==">https://www.techtarget.com/searchnetworking/definition/time-to-live</span></p><p><strong>11、Checksum Errors：</strong> eth.fcs.status == &quot;Bad&quot; || ip.checksum.status == &quot;Bad&quot; || tcp.checksum.status == &quot;Bad&quot; || udp.checksum.status == &quot;Bad&quot; || sctp.checksum.status == &quot;Bad&quot; || mstp.checksum.status == &quot;Bad&quot; || cdp.checksum.status == &quot;Bad&quot; || edp.checksum.status == &quot;Bad&quot; || wlan.fcs.status == &quot;Bad&quot; || stt.checksum.status == &quot;Bad&quot;</p><p>条件中的各类协议的 checksum 出现异常。</p><p><strong>12、SMB：</strong> smb || nbss || nbns || netbios</p><p>Server Message Block 类协议。</p><p><strong>13、HTTP：</strong> http || tcp.port == 80 || http2</p><p>Hyper Text Transfer Protocol（超文本传输协议），这是很简陋的识别方法。</p><p><strong>14、DCERPC：</strong> dcerpc</p><p>即 DCE/RPC，分散式运算环境 / 远端过程调用（Distributed Computing Environment / Remote Procedure Calls）协议。</p><p><strong>15、Routing：</strong> hsrp || eigrp || ospf || bgp || cdp || vrrp || carp || gvrp || igmp || ismp</p><p>路由类协议。</p><p>**16、TCP SYN/FIN： ** tcp.flags &amp; 0x02 || tcp.flags.fin == 1</p><p>TCP 连接的起始和关闭。</p><p><strong>17、TCP：</strong> tcp</p><p>TCP 协议。</p><p><strong>18、UDP：</strong> udp</p><p>UDP 协议。</p><p><strong>19、Broadcast：</strong> eth[0] &amp; 1</p><p>广播数据。</p><p><strong>20、System Event：</strong> systemd_journal || sysdig</p><p>系统调用及系统事件等系统活动。</p><h1 id="专家信息"><a class="anchor" href="#专家信息">#</a> 专家信息</h1><p>在报文的信息栏中，通常也有颜色限定，如下图：</p><p><img data-src="image-20221006185352059.png" alt="image-20221006185352059" /></p><p>而这次的颜色区别是属于对应的信息条目的：</p><p><img data-src="image-20221006185105048.png" alt="image-20221006185105048" /></p><p>每个专家信息项都有一个严重性级别。使用以下级别，从最低到最高。Wireshark 使用不同的颜色标记它们：</p><ul><li><p>聊天（蓝色）</p><p>有关常用的工作流程信息，例如设置了 SYN 标志的 TCP 数据包；数据包都符合常规流量的特征，包括 SYN、FIN、RST 以及各种状态码的 HTTP 事件。</p></li><li><p>注意（青色）</p><p>值得注意的事件，例如应用程序返回了一个常见的错误代码，例如 HTTP 404；数据包中有可能会引发故障的异常现象，例如 TCP 重传、重复确认、快速重传等现象。</p></li><li><p>警告（黄色）</p><p>警告，例如应用程序返回异常错误代码，如连接问题。</p><p>与 TCP 窗口有关的事件 TCP window full 或 TCP zero window，一般是连接设备忙不过来所致。</p><p>与 TCP 报文段丢失或失序有关的事件，丢失是因为未抓全某个 TCP 数据流的所有 TCP 报文段；失序是因其感知到了 TCP 报文段未按发出的顺序到达接收主机。</p></li><li><p>错误（红色）</p><p>严重的问题。</p><p>校验和错误：Ethernet 及 IP 校验和错误。</p><p>伪造的数据包：一般涉及具体的应用层协议。</p></li></ul><p>参看：<span class="exturl" data-url="aHR0cHM6Ly93d3cud2lyZXNoYXJrLm9yZy9kb2NzL3dzdWdfaHRtbF9jaHVua2VkL0NoQWR2RXhwZXJ0Lmh0bWw=">https://www.wireshark.org/docs/wsug_html_chunked/ChAdvExpert.html</span></p><h1 id="tcp-info"><a class="anchor" href="#tcp-info">#</a> TCP Info</h1><p>参看：<span class="exturl" data-url="aHR0cHM6Ly93aWtpLndpcmVzaGFyay5vcmcvVENQX0FuYWx5emVfU2VxdWVuY2VfTnVtYmVycw==">https://wiki.wireshark.org/TCP_Analyze_Sequence_Numbers</span></p><h2 id="a-ack信息"><a class="anchor" href="#a-ack信息">#</a> A、ACK 信息</h2><p><strong>1、TCP ACKed unseen segment</strong></p><p>表示 Wireshark 发现该条 ACK 在整个网络包中找不到所对应的 Seq（排除了乱序），就会提示。</p><p><img data-src="image-20221012210009741.png" alt="image-20221012210009741" /></p><p>如图，在这组网络中，第 296 号包出现这种情况，然后在上面的包中是找不到它所对应的 Seq 的。</p><p><strong>2、TCP Dup ACK <em>&lt;frame&gt;</em> #<em>&lt;acknowledgement number&gt;</em></strong></p><p>重复 ACK 包，当收发不稳定时，会出现重复响应的情况；而这种情况就是响应端会向请求端回复重复 ACK。 <code>#</code>  符号前面的数字表示对应的重复包号，后面的数字表示确认次数，也可以说是出现的次数。</p><p><img data-src="image-20221012221850769.png" alt="image-20221012221850769" /></p><p>如图，在第 31191 号包的信息中可以看到提示是说跟第 31188 号包出现重复，通过查看第 31188 号包，而这一包其实是为了响应第 31187 号的。</p><p><strong>3、TCP Fast Retransmission</strong></p><p>标志着前面接收到重复的 ACK 包（即出现了 [TCP Dup ACK] ）达 3 个或 3 个以上，进而触发了 TCP 的快速重传（这是 RFC 的规定）。</p><p><img data-src="image-20221012224854822.png" alt="image-20221012224854822" /></p><p>如图， [TCP Dup ACK] 出现了 3 次，而且都是对应第 1309 号包，因此触发快速重传包第 1330 号包，重传了第 1309 号包所响应的请求包第 1245 号包，如下图：</p><p><img data-src="image-20221012230828693.png" alt="image-20221012230828693" /></p><p>然后通过对比原包第 1245 号包和快速重传包第 1330 号包，你会发现并不相同，实际上原始数据应该是相同的，只不过数据加密了，才出现不同的现象。</p><h2 id="b-保活探测"><a class="anchor" href="#b-保活探测">#</a> B、保活探测</h2><p><strong>4、TCP Keep-Alive</strong></p><p>这个应该不陌生，一般 TCP 长链接时，如果启用保活功能，则在特定时间段没有数据交互，那么将会传输一条保活字段，如下图：</p><p><img data-src="image-20221012233735152.png" alt="image-20221012233735152" /></p><p><strong>5、TCP Keep-Alive ACK</strong></p><p>作为上一点 [TCP Keep-Alive] 的响应包，例图看上一张。</p><h2 id="c-乱序-or-丢包"><a class="anchor" href="#c-乱序-or-丢包">#</a> C、乱序 or 丢包</h2><p><strong>6、TCP Out-Of-Order</strong></p><p>标志着 TCP 传输出现乱序。</p><p><img data-src="image-20221013201521709.png" alt="image-20221013201521709" /></p><p>如图，在 TCP 传输过程中（不包括三次握手和四次挥手），同一台主机发出的数据包应该是连续的，即后一个包的 Seq 号等于前一个包的 Seq + Len；也可以说，后一个包的 Seq 会大于或等于前一个包的 Seq。当 Wireshark 发现后一个包的 Seq 值小于前一个包的 Seq + Len 时，就会认为是乱序了，因此标志 [TCP Out-of-Order]。</p><p>在连续传输数据过程中，可以看到从第 330 号包一直到第 337 包被标志为乱序这几个包，应当是连续的，但是可以发现第 336 号包跟第 337 号包调转了，因此第 336 号包被标志为上一包未捕获，而第 337 号包则被标志为乱序。</p><p>然后来分析一下，例如第 337 号包的 Seq = 83518，Len = 1380，那么 Seq + Len = 84898，可以发现其实该包列栏中  <code>Sequence Number</code>  的  <code>83518</code>  数据对应 Seq， <code>NextSequence Number</code>  的  <code>84898</code>  数据对应 Seq + Len。根据上面的结论，在发生错误前的第 335 号包它的  <code>NextSequence Number</code>  表明下一包第 336 号包的 Seq 值应当是  <code>83518</code>  ，但是实际上第 336 号包的 Seq 值为  <code>84898</code>  ，当到了第 337 号包的时候，才出现理应对应的值  <code>83518</code>  ，这时 Wireshark 通过对比在发生错误前的第 335 号包至理论连续的第 337 号包之间看是否有出现调转包，有则标志 [TCP Out-of-Order]。一般出现 [TCP Out-of-Order] 时都会伴随出现 [TCP Previous segment not captured] 。</p><p><strong>7、TCP Previous segment not captured</strong></p><p>在 TCP 传输过程中，同一台主机发出的数据段应该是连续的，即后一个包的 Seq 号等于前一个包的 Seq + Len（三次握手和四次挥手是例外）。如果 Wireshark 发现后一个包的 Seq 值大于前一个包的 Seq + Len，就知道中间缺失了一段数据。</p><p>依然沿用上一张图，在发生错误前的第 335 号包 Seq + Len 值为  <code>83518</code>  ，但下一包的 Seq 值为  <code>84898</code>  ，因此出现后一个包的 Seq 值大于前一个包的 Seq + Len，而非等于，所以预示着该数据包的上一个包未捕获到，但后面我们也有发现虽然显示上一个包未捕获到，实际紧随它的后一个包就是它们之间的数据包，只是调转了包而已。</p><h2 id="d-端口"><a class="anchor" href="#d-端口">#</a> D、端口</h2><p><strong>8、TCP Port numbers reused</strong></p><p>这个死活没捕捉出来，就简单说一下吧。</p><p>当发送 SYN 标志时（不是 SYN + ACK），如果已经存在一个使用相同地址和端口的现有会话，那么将会被 Wireshark 标记 [TCP Port numbers reused]。</p><h2 id="e-重传"><a class="anchor" href="#e-重传">#</a> E、重传</h2><p><strong>9、TCP Spurious Retransmission</strong></p><p>TCP 虚假重传，意味着发送端认为发送的包已经丢失了，然后就重传了，尽管此时接收端已经发送了对这些包的确认（确认还没收到或者已经丢失了）。</p><p><img data-src="image-20221013232224434.png" alt="image-20221013232224434" /></p><p>如图，第 459 号包出现虚拟重传现象，实际为第 453 号包的重传，可从显示来看第 453 号包是已经是得到接收端的 ACK 响应了，理论来讲是不会重传的，但前面也有说到了，可能会出现接收端确认了请求（已经发出去了），发送端却还没收到或者已经丢失了，那么发送端将会重传数据，而由于这时这段数据包在初包发送后接收端有回一次请求，这次重传相当于接收端又回了一次请求（即重复了两次响应，可以看到第 460 号包标志为 [TCP Dup ACK] 了），所以对于这种有回 ACK 还重传的数据包将被标志为 [TCP Spurious Retransmission] 。然后至于为什么是重传了第 453 号包，可以看到第 460 号包的信息提示，这是 ACK 响应第 459 号包的，但同时也是跟第 454 号包重复，而第 454 号包对应响应第 453 号包的，那自然而然地得到第 459 号包为第 453 号包的重传。</p><p><strong>10、TCP Retransmission</strong></p><p>TCP 重传，与上面不同的是如果一个包不确定是否丢了，但它又没有像上面 [TCP Spurious Retransmission] 那样得到接收端的 ACK 响应，那它大概率就是丢包了，就不会快速重传；而针对这种情况，发送方也就只好等到超时了再重传，此类重传包就会被 Wireshark 标志 [TCP Retransmission] 。</p><p><img data-src="image-20221014221501852.png" alt="image-20221014221501852" /></p><p>如图，第 33 号包被标志为 [TCP Previous segment not captured]，预示着有可能出现丢包，并且在后面一段时间内也没有像前面那样有标志 [TCP Out-Of-Order] 提示的包，排除了乱序情况，最终等待超时，重传数据包，于是第 33 号重传包就有了 [TCP Retransmission] 标志。TCP 重传是 TCP 通讯中常有的事情，有时候看到一大堆黑漆漆一片的 error 事件，可能就是这种情况。</p><h2 id="f-tcp-window"><a class="anchor" href="#f-tcp-window">#</a> F、TCP Window</h2><p><strong>11、TCP Window Full</strong></p><p>顾名思义，就是窗口已满，指的发送端发送的数据已经达到的接受窗口的上限；那么发送端暂停发送，等待新的接收窗口的通告。</p><p><img data-src="image-20221014235639055.png" alt="image-20221014235639055" /></p><p>如图，在这组数据中，从第 526323 号包开始，出现了 [TCP Window Full] 表明发送数据达到上限了，同时还有另一个 [TCP Spurious Retransmission] 表明了虚假重传，但可惜的是接收端后续都没有响应，最终导致在发送 RST 报文后，关闭 TCP 连接。</p><p><strong>12、TCP Window Update</strong></p><p>TCP 协议允许随时改变窗口的大小，并且通过发送标识有 WindowUpdate 的报文通知对端；或者当接收端的应用程序消耗完了已经从 RX 缓冲区接收到的数据时，也会发生 WindowUpdate，以指示缓冲区中现在有更多可用空间；以上这些数据包将被标志 [TCP Window Update]。[TCP Window Update] 是 TCP 通信中的一个状态，它可以发生的原因还有有很多，通常在 TCP ZeroWindow 条件发生后看到。</p><p><img data-src="image-20221014234941548.png" alt="image-20221014234941548" /></p><p><strong>13、TCP ZeroWindow</strong></p><p>如图，当接收窗口值大小为零（Win = 0）且非 SYN、FIN 或 RST 数据时设置。</p><p><img data-src="image-20221014223515008.png" alt="image-20221014223515008" /></p><p>在每个 TCP 报头中的窗口字段表明着接收端可以接受的数据量大小；如果接收端不能接受任何数据，它将把窗口值设置为零，这告诉发送端暂停其传输。在某些特定情况下，这是正常的，例如，打印机可能会在加载或翻转一张纸时使用零窗口暂停打印作业的传输；然而，在大多数情况下，这表明接收端存在性能或容量问题。恢复暂停的连接可能需要很长时间 (有时需要几分钟)，即使导致零窗口的底层条件很快就会清除。</p><p><strong>14、TCP ZeroWindowProbe</strong></p><p>当通信的一方接收到 TCP ZeroWindow 报文后，会定时发送 TCP ZeroWindowProbe 报文进行探测；探测报文是需要发送下一字节数据，然后通过接收端的响应，由此来判断接收端窗口值是否仍然为 0，如果接收方回复窗口大小仍然为零，则发送端继续探测。ZeroWindowProbe 它有助于证明发送端已经确认到接收端其 TCP 窗口大小为零，但仍试图让数据继续交互而非关闭通讯。</p><p><img data-src="windows-3.png" alt="img" /></p><p><strong>15、TCP ZeroWindowProbeAck</strong></p><p>作为 [TCP ZeroWindowProbe] 的 ACK 应答，结合 TCP ZeroWindowProbe 理解。ZeroWindowProbeAck 数据包的存在也表明网络正在传递数据包并且设备没有关闭。</p><h2 id="g-交互"><a class="anchor" href="#g-交互">#</a> G、交互</h2><p><strong>16、TCP Conversation Completeness</strong></p><ul><li>SYN</li><li>SYN-ACK</li><li>ACK</li><li>DATA</li><li>FIN</li><li>RST</li></ul><p><img data-src="0.jpg" alt="img" /></p><h1 id="常见表达式"><a class="anchor" href="#常见表达式">#</a> 常见表达式</h1><p><strong>1、运算符</strong></p><table><thead><tr><th style="text-align:center">英文写法</th><th style="text-align:center">别名</th><th style="text-align:center">C-like</th><th style="text-align:center">描述</th><th style="text-align:center">例子</th></tr></thead><tbody><tr><td style="text-align:center">eq</td><td style="text-align:center">any_eq</td><td style="text-align:center">==</td><td style="text-align:center">相等（如果超过一个）</td><td style="text-align:center"><code>ip.src == 10.0.0.5</code></td></tr><tr><td style="text-align:center">ne</td><td style="text-align:center">all_ne</td><td style="text-align:center">!=</td><td style="text-align:center">不相等（如果多于一个，则全部）</td><td style="text-align:center"><code>ip.src != 10.0.0.5</code></td></tr><tr><td style="text-align:center"></td><td style="text-align:center">all_eq</td><td style="text-align:center">===</td><td style="text-align:center">相等（如果多于一个，则全部）</td><td style="text-align:center"><code>ip.src === 10.0.0.5</code></td></tr><tr><td style="text-align:center"></td><td style="text-align:center">any_ne</td><td style="text-align:center">!==</td><td style="text-align:center">不相等（如果多于一个，则任意）</td><td style="text-align:center"><code>ip.src !== 10.0.0.5</code></td></tr><tr><td style="text-align:center">gt</td><td style="text-align:center"></td><td style="text-align:center">&gt;</td><td style="text-align:center">大于</td><td style="text-align:center"><code>frame.len &gt; 10</code></td></tr><tr><td style="text-align:center">lt</td><td style="text-align:center"></td><td style="text-align:center">&lt;</td><td style="text-align:center">小于</td><td style="text-align:center"><code>frame.len &lt; 128</code></td></tr><tr><td style="text-align:center">ge</td><td style="text-align:center"></td><td style="text-align:center">&gt;=</td><td style="text-align:center">大于或等于</td><td style="text-align:center"><code>frame.len ge 0x100</code></td></tr><tr><td style="text-align:center">le</td><td style="text-align:center"></td><td style="text-align:center">&lt;=</td><td style="text-align:center">小于或等于</td><td style="text-align:center"><code>frame.len &lt;= 0x20</code></td></tr></tbody></table><p><strong>2、逻辑符</strong></p><table><thead><tr><th style="text-align:center">英文写法</th><th style="text-align:center">C-like</th><th style="text-align:center">描述</th><th style="text-align:center">例子</th></tr></thead><tbody><tr><td style="text-align:center">and</td><td style="text-align:center">&amp;&amp;</td><td style="text-align:center">逻辑与</td><td style="text-align:center"><code>ip.src==10.0.0.5 and tcp.flags.fin</code></td></tr><tr><td style="text-align:center">or</td><td style="text-align:center" rowspan="2">||</td><td style="text-align:center">逻辑或</td><td style="text-align:center"><code>ip.src==10.0.0.5 or ip.src==192.1.1.1</code></td></tr><tr><td style="text-align:center">xor</td><td style="text-align:center">异或</td><td style="text-align:center"><code>tr.dst[0:3] == 0.6.29 xor tr.src[0:3] == 0.6.29</code></td></tr><tr><td style="text-align:center">not</td><td style="text-align:center">!</td><td style="text-align:center">逻辑非</td><td style="text-align:center"><code>not llc</code></td></tr></tbody></table><p><strong>3、协议过滤</strong></p><pre><code>ip.proto == xxxnote: xxx表示为对应的协议，如 TCP：ip.proto == TCP</code></pre><ul><li><strong>TCP：</strong> 只显示 TCP 协议的数据流</li><li><strong>UDP：</strong> 只显示 UDP 协议的数据流</li><li><strong>HTTP：</strong> 只显示 HTTP 协议的数据流</li><li><strong>ICMP：</strong> 只显示 ICMP 协议的数据流</li><li><strong>ARP：</strong> 只显示 ARP 协议的数据流</li><li><strong>DNS：</strong> 只显示 DNS 协议的数据流</li></ul><p><strong>4、IP 过滤</strong></p><ul><li><code>ip.addr == 192.168.116.138</code>  ，只显示 <strong>IP 地址</strong>为  <code>192.168.116.138</code>  有关的数据流</li><li><code>ip.src == 192.168.116.138</code>  ，只显示<strong>源 IP 地址</strong>为  <code>192.168.116.138</code>  的数据流</li><li><code>ip.dst == 192.168.116.138</code>  ，只显示<strong>目标 IP 地址</strong>为  <code>192.168.116.138</code>  的数据流</li></ul><p><strong>5、端口过滤</strong></p><ul><li><code>tcp.port == 80</code>  ，只显示 80 端口 TCP 数据流</li><li><code>udp.prot == 67</code>  ，只显示 67 端口 UDP 数据流</li><li><code>tcp.srcport == 80</code>  , 只显示源地址的 80 端口数据流</li><li><code>tcp.dstport == 80</code>  ，只显示目的地址 80 端口数据流</li></ul><p><strong>6、过滤 HTTP 协议</strong></p><ul><li><code>http.request.method == &quot;GET&quot;</code>  ，显示 GET 请求</li><li><code>http.request.method == &quot;POST&quot;</code>  ，显示 POST 请求</li><li><code>http.request.code == 404</code>  ，显示状态码为 404</li></ul><p>参看：<span class="exturl" data-url="aHR0cHM6Ly93d3cud2lyZXNoYXJrLm9yZy9kb2NzL3dzdWdfaHRtbF9jaHVua2VkL0NoV29ya0J1aWxkRGlzcGxheUZpbHRlclNlY3Rpb24uaHRtbA==">https://www.wireshark.org/docs/wsug_html_chunked/ChWorkBuildDisplayFilterSection.html</span></p><h1 id="列信息增删"><a class="anchor" href="#列信息增删">#</a> 列信息增删</h1><p><strong>1、增加列信息</strong></p><p>在报文的信息栏，选着想要显示的信息，右键点击添加：</p><p><img data-src="image-20221006221325561.png" alt="image-20221006221325561" /></p><p><strong>2、删除列信息</strong></p><p>在监控报文栏，选择不需要的列，右键选中：</p><p><img data-src="image-20221006221434994.png" alt="image-20221006221434994" /></p><p><strong>3、隐藏列信息</strong></p><p>同样在监控报文栏操作，随便选择一列，右键选中，然后把想要隐藏的列去掉勾选，这里就不放图了。</p>]]></content>
      
      
      
        <tags>
            
            <tag> history </tag>
            
            <tag> 工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>博客搭建笔记之功能扩展</title>
      <link href="/docs/Hexo/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%8A%9F%E8%83%BD%E6%89%A9%E5%B1%95/"/>
      <url>/docs/Hexo/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%8A%9F%E8%83%BD%E6%89%A9%E5%B1%95/</url>
      
        <content type="html"><![CDATA[<h1 id="搜索功能"><a class="anchor" href="#搜索功能">#</a> 搜索功能</h1><h2 id="algolia搜索功能"><a class="anchor" href="#algolia搜索功能">#</a> algolia 搜索功能</h2><p><div class="links"><div class="item" title="algolia 官网" style="--block-color:#5468FF;"><span class="exturl image" data-url="aHR0cHM6Ly93d3cuYWxnb2xpYS5jb20v" data-background-image="https://www.algolia.com/assets/auth/algolia-logo-light-9d5a83fff4752711153b4c8a6fbf830787e5c538a3475edba9f1c8aaffa79a54.svg"></span>          <div class="info">          <span class="exturl title" data-url="aHR0cHM6Ly93d3cuYWxnb2xpYS5jb20v">algolia 官网</span>          <p class="desc">algolia官方地址</p>          </div></div></div></p><p><strong>需要安装  <code>hexo-algoliasearch</code>  插件。</strong></p><ol><li><p>注册 algolia，创建 Index：</p><p><img data-src="image-20220530210920658.png" alt="image-20220530210920658" /></p></li><li><p>获取 Key，修改站点配置：</p><ul><li><p>新建 API Key：<img data-src="image-20220530212532566.png" alt="image-20220530212532566" /></p></li><li><p>获取相应的 Key，并填入配置信息：</p><p><img data-src="image-20220530212807371.png" alt="image-20220530212807371" /></p></li></ul></li><li><p>在配置完 Key 后，回到终端控制台，键入以下命令上传数据到  <code>algolia</code>  ：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>hexo algolia</pre></td></tr></table></figure></li></ol><p>配置参考：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">algolia</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>   <span class="token key atrule">appId</span><span class="token punctuation">:</span> <span class="token string">"Application ID对应码"</span></pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token key atrule">apiKey</span><span class="token punctuation">:</span> <span class="token string">"API Keys页面的All API Keys中刚刚新建的API key的对应码"</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token key atrule">adminApiKey</span><span class="token punctuation">:</span> <span class="token string">"Admin API Key对应码"</span></pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token key atrule">chunkSize</span><span class="token punctuation">:</span> <span class="token number">5000</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   <span class="token key atrule">indexName</span><span class="token punctuation">:</span> <span class="token string">"你填写的Indices部分"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>   <span class="token key atrule">fields</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>     <span class="token punctuation">-</span> title <span class="token comment">#必须配置</span></pre></td></tr><tr><td data-num="9"></td><td><pre>     <span class="token punctuation">-</span> path <span class="token comment">#必须配置</span></pre></td></tr><tr><td data-num="10"></td><td><pre>     <span class="token punctuation">-</span> categories <span class="token comment">#推荐配置</span></pre></td></tr><tr><td data-num="11"></td><td><pre>     <span class="token punctuation">-</span> content<span class="token punctuation">:</span>strip<span class="token punctuation">:</span>truncate<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">4000</span></pre></td></tr><tr><td data-num="12"></td><td><pre>     <span class="token punctuation">-</span> gallery</pre></td></tr><tr><td data-num="13"></td><td><pre>     <span class="token punctuation">-</span> photos</pre></td></tr><tr><td data-num="14"></td><td><pre>     <span class="token punctuation">-</span> tags</pre></td></tr></table></figure><p>注：每次更新修改文章后还需要执行  <code>hexo algolia</code>  的指令，否则，搜索数据没有或者对不上。</p><h2 id="本地搜索功能"><a class="anchor" href="#本地搜索功能">#</a> 本地搜索功能</h2><h1 id="字数及阅读时间统计"><a class="anchor" href="#字数及阅读时间统计">#</a> 字数及阅读时间统计</h1><p><strong>需要安装  <code>hexo-symbols-count-time</code>  插件。</strong></p><p>安装后不需要修改站点配置文件，直接使用插件默认配置就行，如需进行配置，可参考：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># hexo-symbols-count-time</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">## shoka 主题默认采取了默认的配置，所以覆盖相应配置就行了</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">symbols_count_time</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">symbols</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">time</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">total_symbols</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">total_time</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">exclude_codeblock</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">awl</span><span class="token punctuation">:</span> <span class="token number">4</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">wpm</span><span class="token punctuation">:</span> <span class="token number">245</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token key atrule">suffix</span><span class="token punctuation">:</span> <span class="token string">"mins."</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">#exclude_codeblock: 是否排除代码块区域的字数统计</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">#awl: 平均字符长度 (多少符字算一个中文或英文) 中文约是 2，英文约是 5，其他约是 6</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">#wpm: 每分钟阅读字数  正常值约为 275 字，较小值约为 200 字，较快值约 350 字</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">#suffix: 当总字数小于每分钟阅读字数时，默认采取的时间类型，不填写默认类型采取 "mins."</span></pre></td></tr></table></figure><p>启用则需要找到  <code>footer</code>  和  <code>post</code>  的两处  <code>count</code>  ，修改为  <code>true</code>  ：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 页尾全站统计</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">footer</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token key atrule">since</span><span class="token punctuation">:</span> <span class="token number">2010</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">count</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 文章界面统计</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token key atrule">post</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">count</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr></table></figure><h1 id="访问及阅读统计"><a class="anchor" href="#访问及阅读统计">#</a> 访问及阅读统计</h1><p>LeanCloud 评价里面是有阅读访问统计，但是，目前由于 LeanCloud 国际版不对国内用户提供服务了，因此改用其它记录统计，这里可以使用简单的<span class="exturl" data-url="aHR0cDovL2J1c3VhbnppLmlicnVjZS5pbmZvLw==">不蒜子</span>计数，操作更改也比较简单： <strong>引脚本 + 写标签</strong></p><p>1、调用不蒜子的官方脚本，这个比较简单，在你需要的地方调用如下代码</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre># 引脚本</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">&lt;</span>script <span class="token keyword">async</span> src<span class="token operator">=</span><span class="token string">"//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre># 写标签</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token operator">&lt;</span>span id<span class="token operator">=</span><span class="token string">"busuanzi_value_page_pv"</span><span class="token operator">></span> # 当前访问页面次数</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token operator">&lt;</span>span id<span class="token operator">=</span><span class="token string">"busuanzi_container_site_uv"</span><span class="token operator">></span> # 站点访客次数</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token operator">&lt;</span>span id<span class="token operator">=</span><span class="token string">"busuanzi_container_site_pv"</span><span class="token operator">></span> # 站点访问总量</pre></td></tr></table></figure><p>2、静态部署调用，这个需要在  <code>&lt;root&gt;/source/js</code>  路径下创建  <code>busuanzi.pure.min.js</code>  文件，如果  <code>js</code>  目录不存在则自己新建，并且把如下代码添加进去，并保存：</p><figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">var</span> bszCaller<span class="token punctuation">,</span>bszTag<span class="token punctuation">;</span><span class="token operator">!</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">var</span> c<span class="token punctuation">,</span>d<span class="token punctuation">,</span>e<span class="token punctuation">,</span>a<span class="token operator">=</span><span class="token operator">!</span><span class="token number">1</span><span class="token punctuation">,</span>b<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token function-variable function">ready</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">c</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> a<span class="token operator">||</span><span class="token string">"interactive"</span><span class="token operator">===</span>document<span class="token punctuation">.</span>readyState<span class="token operator">||</span><span class="token string">"complete"</span><span class="token operator">===</span>document<span class="token punctuation">.</span>readyState<span class="token operator">?</span><span class="token function">c</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token operator">:</span>b<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">c</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token function-variable function">d</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> a<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>c<span class="token operator">=</span>b<span class="token punctuation">.</span>length<span class="token punctuation">;</span>c<span class="token operator">></span>a<span class="token punctuation">;</span>a<span class="token operator">++</span><span class="token punctuation">)</span>b<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">;</span>b<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token function-variable function">e</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>a<span class="token operator">||</span><span class="token punctuation">(</span>a<span class="token operator">=</span><span class="token operator">!</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token function">d</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">,</span>document<span class="token punctuation">.</span>removeEventListener<span class="token operator">?</span>document<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">"DOMContentLoaded"</span><span class="token punctuation">,</span>e<span class="token punctuation">,</span><span class="token operator">!</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">:</span>document<span class="token punctuation">.</span>attachEvent<span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">detachEvent</span><span class="token punctuation">(</span><span class="token string">"onreadystatechange"</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">,</span>window<span class="token operator">==</span>window<span class="token punctuation">.</span>top<span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span><span class="token function">clearInterval</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">,</span>c<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>document<span class="token punctuation">.</span>addEventListener<span class="token operator">?</span>document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"DOMContentLoaded"</span><span class="token punctuation">,</span>e<span class="token punctuation">,</span><span class="token operator">!</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">:</span>document<span class="token punctuation">.</span>attachEvent<span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">attachEvent</span><span class="token punctuation">(</span><span class="token string">"onreadystatechange"</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">loaded|complete</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>readyState<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>window<span class="token operator">==</span>window<span class="token punctuation">.</span>top<span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>c<span class="token operator">=</span><span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">try</span><span class="token punctuation">&#123;</span>a<span class="token operator">||</span>document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span><span class="token function">doScroll</span><span class="token punctuation">(</span><span class="token string">"left"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>bszCaller<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token function-variable function">fetch</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>b</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">var</span> c<span class="token operator">=</span><span class="token string">"BusuanziCallback_"</span><span class="token operator">+</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token number">1099511627776</span><span class="token operator">*</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>window<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">evalCall</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span>a<span class="token operator">=</span>a<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"=BusuanziCallback"</span><span class="token punctuation">,</span><span class="token string">"="</span><span class="token operator">+</span>c<span class="token punctuation">)</span><span class="token punctuation">,</span>scriptTag<span class="token operator">=</span>document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"SCRIPT"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>scriptTag<span class="token punctuation">.</span>type<span class="token operator">=</span><span class="token string">"text/javascript"</span><span class="token punctuation">,</span>scriptTag<span class="token punctuation">.</span>defer<span class="token operator">=</span><span class="token operator">!</span><span class="token number">0</span><span class="token punctuation">,</span>scriptTag<span class="token punctuation">.</span>src<span class="token operator">=</span>a<span class="token punctuation">,</span>scriptTag<span class="token punctuation">.</span>referrerPolicy<span class="token operator">=</span><span class="token string">"no-referrer-when-downgrade"</span><span class="token punctuation">,</span>document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">"HEAD"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>scriptTag<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token function-variable function">evalCall</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">b</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">try</span><span class="token punctuation">&#123;</span><span class="token function">a</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span>scriptTag<span class="token punctuation">.</span>parentElement<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>scriptTag<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>bszTag<span class="token punctuation">.</span><span class="token function">hides</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>bszCaller<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"//busuanzi.ibruce.info/busuanzi?jsonpCallback=BusuanziCallback"</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>bszTag<span class="token punctuation">.</span><span class="token function">texts</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span>bszTag<span class="token punctuation">.</span><span class="token function">shows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>bszTag<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token literal-property property">bszs</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">"site_pv"</span><span class="token punctuation">,</span><span class="token string">"page_pv"</span><span class="token punctuation">,</span><span class="token string">"site_uv"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token function-variable function">texts</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>bszs<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">b</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">var</span> c<span class="token operator">=</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"busuanzi_value_"</span><span class="token operator">+</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>c<span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>innerHTML<span class="token operator">=</span>a<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token function-variable function">hides</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>bszs<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">var</span> b<span class="token operator">=</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"busuanzi_container_"</span><span class="token operator">+</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>b<span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display<span class="token operator">=</span><span class="token string">"none"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token function-variable function">shows</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>bszs<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">var</span> b<span class="token operator">=</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"busuanzi_container_"</span><span class="token operator">+</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>b<span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display<span class="token operator">=</span><span class="token string">"inline"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>然后更改上面第一条代码的引用路径为本地路径，例如： <code>&lt;script async src=&quot;https://xxx.example.com/js/busuanzi.pure.min.js&quot;&gt;&lt;/script&gt;</code>  ， <code>xxx.example.com</code>  为你的部署网站。后面三行的代码的  <code>&lt;span id=&quot;xxx&quot;&gt;</code>  不用变动，只需在合适的地方调用想用的计数代码即可。</p><p>3、举个例子，替换 shoka 主题原有的页面访问计数。在  <code>&lt;root&gt;/themes/shoka/layout/_partials/post/footer.njk</code>  文件中，添加并替换即可。如下图：</p><p><img data-src="image-20221115121446459.png" alt="image-20221115121446459" /></p><h1 id="rss订阅"><a class="anchor" href="#rss订阅">#</a> RSS 订阅</h1><p><strong>需要安装  <code>hexo-generator-feed</code>  插件。</strong></p><p>安装完成后，需要在  <code>&lt;root&gt;/_config.yml</code>  配置中添加如下信息，并填写自己需要的信息：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">feed</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token key atrule">type</span><span class="token punctuation">:</span> atom</pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">path</span><span class="token punctuation">:</span> atom.xml</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">limit</span><span class="token punctuation">:</span> <span class="token number">20</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">hub</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">content</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">content_limit</span><span class="token punctuation">:</span> <span class="token number">140</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">content_limit_delim</span><span class="token punctuation">:</span> <span class="token string">' '</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">order_by</span><span class="token punctuation">:</span> <span class="token punctuation">-</span>date</pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token key atrule">icon</span><span class="token punctuation">:</span> icon.png</pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token key atrule">autodiscovery</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  template<span class="token punctuation">:</span></pre></td></tr></table></figure><p>具体内容可参看：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2hleG9qcy9oZXhvLWdlbmVyYXRvci1mZWVk">https://github.com/hexojs/hexo-generator-feed</span></p><p>当然，如果有能力的，可以自建 rss 模板，shoka 主题上也有提供，只需要如下调用模板即可：</p><p><img data-src="image-20221115164425176.png" alt="image-20221115164425176" /></p><p>最后，在需要获取 RSS 链接的地方添加  <code>/atom.xml</code>  即可。</p><h1 id="站点运行时间"><a class="anchor" href="#站点运行时间">#</a> 站点运行时间</h1><p>在配置站点页脚的  <code>&lt;root&gt;/themes/shoka/layout/_partials/footer.njk</code>  文件上，选择合适的地方添加如下代码：</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>swig￼<span class="token number">1</span><span class="token operator">--</span><span class="token operator">></span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"create_time"</span><span class="token operator">></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token operator">&lt;</span>span id<span class="token operator">=</span><span class="token string">"timeDate"</span><span class="token operator">></span>加载日期<span class="token operator">...</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token operator">&lt;</span>span id<span class="token operator">=</span><span class="token string">"times"</span><span class="token operator">></span>加载时间<span class="token operator">...</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token operator">&lt;</span>script<span class="token operator">></span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token keyword">var</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token keyword">function</span> <span class="token function">createtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">var</span> grt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        now<span class="token punctuation">.</span><span class="token function">setTime</span><span class="token punctuation">(</span>now<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        days <span class="token operator">=</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> grt<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span> <span class="token operator">/</span> <span class="token number">60</span> <span class="token operator">/</span> <span class="token number">60</span> <span class="token operator">/</span> <span class="token number">24</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        dnum <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>days<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        hours <span class="token operator">=</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> grt<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span> <span class="token operator">/</span> <span class="token number">60</span> <span class="token operator">/</span> <span class="token number">60</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">24</span> <span class="token operator">*</span> dnum<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        hnum <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>hours<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span>hnum<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>          hnum <span class="token operator">=</span> <span class="token string">"0"</span> <span class="token operator">+</span> hnum<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        minutes <span class="token operator">=</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> grt<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span> <span class="token operator">/</span> <span class="token number">60</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> dnum<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">60</span> <span class="token operator">*</span> hnum<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        mnum <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>minutes<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span>mnum<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>          mnum <span class="token operator">=</span> <span class="token string">"0"</span> <span class="token operator">+</span> mnum<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        seconds <span class="token operator">=</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> grt<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> dnum<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> hnum<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">60</span> <span class="token operator">*</span> mnum<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        snum <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>seconds<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span>snum<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>          snum <span class="token operator">=</span> <span class="token string">"0"</span> <span class="token operator">+</span> snum<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"timeDate"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">" 本站存活 "</span> <span class="token operator">+</span> dnum <span class="token operator">+</span> <span class="token string">" 天 "</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"times"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> hnum <span class="token operator">+</span> <span class="token string">" 小时 "</span> <span class="token operator">+</span> mnum <span class="token operator">+</span> <span class="token string">" 分 "</span> <span class="token operator">+</span> snum <span class="token operator">+</span> <span class="token string">" 秒"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token string">"createtime()"</span><span class="token punctuation">,</span> <span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span></pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>swig￼<span class="token number">3</span><span class="token operator">--</span><span class="token operator">></span></pre></td></tr></table></figure><p>再在主题配置文件  <code>&lt;root&gt;/themes/shoka/_config.yml</code>  中添加：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># Runing Time</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">running_time</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">create_time</span><span class="token punctuation">:</span> <span class="token string">"01/01/1945 19:00:00"</span> <span class="token comment">#此处修改你的建站时间或者网站上线时间</span></pre></td></tr></table></figure><h1 id="seo-优化及站点收录"><a class="anchor" href="#seo-优化及站点收录">#</a> SEO 优化及站点收录</h1><p>辛辛苦苦搭好网站，当然是想跟其他人一起分享博文啦；但是，对于个人博客，如果没有被搜索引擎收录的话，别人在搜索引擎基本上是看不到的。那么如何查看个人博客网站是否被收录？只需要在对应的搜索引擎搜索框上输入：</p><figure class="highlight http"><figcaption data-lang="HTTP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token header"><span class="token header-name keyword">site</span><span class="token punctuation">:</span><span class="token header-value">your_website</span></span></pre></td></tr></table></figure><p>eg:</p><p><img data-src="image-20221126231952585.png" alt="image-20221126231952585" /></p><h2 id="google收录"><a class="anchor" href="#google收录">#</a> Google 收录</h2><p>谷歌收录相对简单，只需要准备一个谷歌账号，然后访问 <span class="exturl" data-url="aHR0cHM6Ly9zZWFyY2guZ29vZ2xlLmNvbS9zZWFyY2gtY29uc29sZS93ZWxjb21l">Google Search Console</span> 如下图：</p><p><img data-src="image-20221126232456573.png" alt="image-20221126232456573" /></p><p>先登录账号，然后再输入个人博客网站域名。然后弹出验证网站所有权窗口，这里一般选择  <code>CNAME验证</code>  ，接着根据提示操作即可，这里就不贴图，并且在你的网站管理那里添加给出来的 DNS 解析；最后等 DNS 更改生效，验证通过即可。完成后进入配置，添加站点地图链接，可能添加完后刷新会显示  <code>无法获取</code>  的状态，但其实是已经配置完成了。</p><h2 id="bing收录"><a class="anchor" href="#bing收录">#</a> Bing 收录</h2><p>进入 <span class="exturl" data-url="aHR0cHM6Ly93d3cuYmluZy5jb20vd2VibWFzdGVycy9hYm91dA==">Bing Webmaster Tools</span> ，这个可以选择使用 GSC 导入网站，只需要授权一下即可；或者手动添加通过  <code>CNAME验证</code>  添加，如下图：</p><p><img data-src="image-20221126234903144.png" alt="image-20221126234903144" /></p><p>通过后，同样的添加站点地图链接。</p><h2 id="baidu收录"><a class="anchor" href="#baidu收录">#</a> Baidu 收录</h2><p>访问 <span class="exturl" data-url="aHR0cHM6Ly96aXl1YW4uYmFpZHUuY29tLw==">百度搜索资源平台</span> ，点击  <code>用户中心</code>  -&gt;  <code>站点管理</code>  ，然后添加网站，一路到验证通过，这里同样的使用  <code>CNAME验证</code>  即可，当然选择其他的也行，哪种方便用哪种：</p><p><img data-src="image-20221127000022983.png" alt="image-20221127000022983" /></p><p>验证完毕后，找到  <code>普通收录</code>  ，选择  <code>sitemap</code>  ，接着添加站点地图链接：</p><p><img data-src="image-20221127000321081.png" alt="image-20221127000321081" /></p><h1 id="看板卡通模型"><a class="anchor" href="#看板卡通模型">#</a> 看板卡通模型</h1><p>这里使用  <code>live2d模块</code>  ，比较简单。</p><p>安装插件  <code>npm install --save hexo-helper-live2d</code>  ，选则安装所需的卡通模型：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3hpYXpleXUvbGl2ZTJkLXdpZGdldC1tb2RlbHM=">https://github.com/xiazeyu/live2d-widget-models</span> ，例如，安装名为 <strong>unitychan</strong> 的模型：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">npm</span> <span class="token function">install</span> live2d-widget-model-unitychan</pre></td></tr></table></figure><p>配置插件，在  <code>&lt;root&gt;/_config.yml</code>  中添加及更改如下信息：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">live2d</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token key atrule">scriptFrom</span><span class="token punctuation">:</span> local <span class="token comment"># 默认</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">pluginRootPath</span><span class="token punctuation">:</span> live2dw/ <span class="token comment"># 插件在站点上的根目录 (相对路径)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">pluginJsPath</span><span class="token punctuation">:</span> lib/ <span class="token comment"># 脚本文件相对与插件根目录路径</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">pluginModelPath</span><span class="token punctuation">:</span> assets/ <span class="token comment"># 模型文件相对与插件根目录路径</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">tagMode</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 标签模式，是否仅替换 live2d tag 标签而非插入到所有页面中</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">debug</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 调试，是否在控制台输出日志</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">model</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">use</span><span class="token punctuation">:</span> live2d<span class="token punctuation">-</span>widget<span class="token punctuation">-</span>model<span class="token punctuation">-</span>unitychan</pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token key atrule">display</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">position</span><span class="token punctuation">:</span> right <span class="token comment">#动画位置</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">width</span><span class="token punctuation">:</span> <span class="token number">210</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token key atrule">height</span><span class="token punctuation">:</span> <span class="token number">380</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment"># 位置配置，这个在左侧边栏位置很居中</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token key atrule">hOffset</span><span class="token punctuation">:</span> <span class="token number">50</span>  <span class="token comment"># 调节水平位置</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token key atrule">vOffset</span><span class="token punctuation">:</span> <span class="token number">-25</span>  <span class="token comment"># 调节垂直位置</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token key atrule">mobile</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token key atrule">show</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 是否在移动设备上显示</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token key atrule">scale</span><span class="token punctuation">:</span> <span class="token number">0.5</span> <span class="token comment"># 移动设备上的缩放</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token key atrule">react</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token key atrule">opacityDefault</span><span class="token punctuation">:</span> <span class="token number">0.7</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token key atrule">opacityOnHover</span><span class="token punctuation">:</span> <span class="token number">0.8</span></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Hexo-shoka </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>博客搭建笔记之 shoka配置</title>
      <link href="/docs/Hexo/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA%E7%AC%94%E8%AE%B0%E4%B9%8B%20shoka%E9%85%8D%E7%BD%AE/"/>
      <url>/docs/Hexo/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA%E7%AC%94%E8%AE%B0%E4%B9%8B%20shoka%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<blockquote><p>以下配置皆在文件   <code>&lt;root&gt;/_config.shoka.yml</code>  修改。大部分摘录自：<span class="exturl" data-url="aHR0cHM6Ly9zaG9rYS5sb3N0eXUubWUvY29tcHV0ZXItc2NpZW5jZS9ub3RlL3RoZW1lLXNob2thLWRvYy9jb25maWcv">https://shoka.lostyu.me/computer-science/note/theme-shoka-doc/config/</span></p></blockquote><h1 id="站点名称"><a class="anchor" href="#站点名称">#</a> 站点名称</h1><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">alternate</span><span class="token punctuation">:</span> Yume Shoka</pre></td></tr></table></figure><p>这里设置的名称代替 Logo，显示在页面顶部，以及页尾 ©️ 处。</p><h1 id="资源文件"><a class="anchor" href="#资源文件">#</a> 资源文件</h1><p>支持本地静态文件跟 cdn 加速，默认值是  <code>/</code>  ，指使用本地静态文件。</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># local static</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">statics</span><span class="token punctuation">:</span> /</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>or</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># jsdelivr cdn</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token key atrule">statics</span><span class="token punctuation">:</span> //cdn.jsdelivr.net/gh/Arachnid<span class="token punctuation">-</span>97/arachnid@latest/</pre></td></tr></table></figure><p>当然，也可以修改成  <code>//cdn.jsdelivr.net/gh/您的github用户名/您的项目名@latest/</code>  这种形式，以使用 jsDelivr 进行加速。</p><p>PS：jsDelivr 并不是实时更新，重新生成文件后需要耐心等待（更新于 2022.05.25），目前 jsDelivr 对于大陆已经失效，部署后需要使用魔法才能访问，至于为啥，就不多说了。</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">css</span><span class="token punctuation">:</span> css</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">js</span><span class="token punctuation">:</span> js</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">images</span><span class="token punctuation">:</span> images</pre></td></tr></table></figure><p>静态文件所处目录的实际目录名，这些一般不改。</p><h1 id="夜间模式"><a class="anchor" href="#夜间模式">#</a> 夜间模式</h1><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">darkmode</span><span class="token punctuation">:</span> <span class="token comment"># true</span></pre></td></tr></table></figure><p>默认情况下，是否开启夜间模式取决于（优先级从高到低）：</p><ol><li>访客点击页面头部切换按钮的自行选择</li><li>访客切换了浏览设备的主题色调</li><li>您的  <code>darkmode</code>  配置项</li></ol><h1 id="自动定位"><a class="anchor" href="#自动定位">#</a> 自动定位</h1><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">auto_scroll</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr></table></figure><p>默认情况下，再次打开页面时，会自动滚动到上次浏览的位置。<br />这个选项设为  <code>false</code>  时将停用此功能。</p><h1 id="加载动画"><a class="anchor" href="#加载动画">#</a> 加载动画</h1><pre><code># 是否显示页面加载动画 loading-catloader:  start: true # 当初次打开页面时，显示加载动画  switch: true # tab 切换到其他页面时，显示加载动画</code></pre><p>注：tab 切换后只是显示 loading 动画，实际并未重新加载页面。</p><h2 id="动画替换"><a class="anchor" href="#动画替换">#</a> 动画替换</h2><p>CSS 样式对应修改的文件位置：  <code>&lt;root&gt;/themes/shoka/source/css/_common/components/third-party</code>  中的  <code>loading.styl</code>  文件。</p><figure class="highlight stylus"><figcaption data-lang="stylus"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token selector"><span class="token comment">//css</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">//\themes\shoka\source\css\_common\components\third-party\loading.styl</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// 保留下面这几行，其余删除后写入新样式</span></pre></td></tr><tr><td data-num="4"></td><td><pre>#loading <span class="token punctuation">&#123;</span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token atrule-declaration"><span class="token atrule">@extend</span> $fix-fullscreen<span class="token punctuation">;</span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token property-declaration"><span class="token property">background-color</span><span class="token punctuation">:</span> <span class="token func"><span class="token function">var</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token operator">-</span><span class="token color">grey</span><span class="token number">-1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token func"><span class="token function">if</span><span class="token punctuation">(</span><span class="token operator">!</span>hexo-config<span class="token punctuation">(</span><span class="token string">'loader.start'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token property-declaration"><span class="token property">display</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token selector"><span class="token comment">//</span></span></pre></td></tr><tr><td data-num="12"></td><td><pre>你的CSS样式代码</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">//</span></pre></td></tr></table></figure><p>html 对应修改的文件位置：  <code>&lt;root&gt;/themes/shoka/layout/_partials</code>  中的  <code>layout.njk</code>  文件。</p><pre><code class="language-nunjucks">//HTML//\themes\shoka\layout\_partials\layout.njk&lt;body itemscope itemtype=&quot;https://schema.org/WebPage&quot;&gt;  &lt;div id=&quot;loading&quot;&gt;//此处删除并重新写入css样式对应的html代码  &lt;/div&gt;  &lt;div id=&quot;container&quot;&gt;</code></pre><h1 id="烟花效果"><a class="anchor" href="#烟花效果">#</a> 烟花效果</h1><p>单击页面的烟花效果配置如下：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">fireworks</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 是否启用</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token key atrule">color</span><span class="token punctuation">:</span> <span class="token comment"># 烟花颜色</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">-</span> <span class="token string">"rgba(255,182,185,.9)"</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">-</span> <span class="token string">"rgba(250,227,217,.9)"</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">-</span> <span class="token string">"rgba(187,222,214,.9)"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">-</span> <span class="token string">"rgba(138,198,209,.9)"</span></pre></td></tr></table></figure><h1 id="加载谷歌字体"><a class="anchor" href="#加载谷歌字体">#</a> 加载谷歌字体</h1><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">font</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token comment"># Font options:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token comment"># `external: true` will load this font family from `host` above.</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token comment"># `family: Times New Roman`. Without any quotes.</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token comment"># `size: x.x`. Use `em` as unit. Default: 1 (16px)</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token comment"># Global font settings used for all elements inside &lt;body>.</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">global</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">external</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">family</span><span class="token punctuation">:</span> Mulish</pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">size</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment"># Font settings for alternate title.</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token key atrule">logo</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token key atrule">external</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token key atrule">family</span><span class="token punctuation">:</span> Fredericka the Great</pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token key atrule">size</span><span class="token punctuation">:</span> <span class="token number">3.5</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token comment"># Font settings for site title.</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token key atrule">title</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token key atrule">external</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token key atrule">family</span><span class="token punctuation">:</span> Noto Serif JP</pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token key atrule">size</span><span class="token punctuation">:</span> <span class="token number">2.5</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token comment"># Font settings for headlines (&lt;h1> to &lt;h6>).</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token key atrule">headings</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token key atrule">external</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token key atrule">family</span><span class="token punctuation">:</span> Noto Serif SC</pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token key atrule">size</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token comment"># Font settings for posts.</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token key atrule">posts</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token key atrule">external</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token key atrule">family</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token comment"># Font settings for &lt;code> and code blocks.</span></pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token key atrule">codes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token key atrule">external</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token key atrule">family</span><span class="token punctuation">:</span> Inconsolata</pre></td></tr></table></figure><p>此功能基本参考 NexT。<br />加粗标题的字体总是使用  <code>Noto Serif</code>  ，为了正确友好的显示日文中的汉字，会先后加载  <code>headings</code>  和  <code>title</code>  的字体设置。</p><h1 id="iconfont-图标"><a class="anchor" href="#iconfont-图标">#</a> iconfont 图标</h1><p>对应文件位置：  <code>&lt;root&gt;/themes/shoka/source/css</code>  中的  <code>_iconfont.styl</code>  文件。</p><p><code>font-family</code>  设为  <code>ic</code>  ，所有字体样式前缀为  <code>i-</code>  。</p><h2 id="自定义图标"><a class="anchor" href="#自定义图标">#</a> 自定义图标</h2><p>在  <code>&lt;root&gt;/source/_data/</code>  目录新建文件  <code>iconfont.styl</code>  ，把新增或修改的图标样式复制到这个文件中。</p><blockquote><p>自定义  <code>iconfont.styl</code>  文件将覆盖主题默认样式，为了避免出错，请保证原有样式名均存在，在原有样式基础上进行增删改。</p></blockquote><h1 id="菜单"><a class="anchor" href="#菜单">#</a> 菜单</h1><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">menu</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">home</span><span class="token punctuation">:</span> / <span class="token punctuation">|</span><span class="token punctuation">|</span> home</pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token key atrule">posts</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token key atrule">default</span><span class="token punctuation">:</span> / <span class="token punctuation">|</span><span class="token punctuation">|</span> feather</pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">archives</span><span class="token punctuation">:</span> /archives/ <span class="token punctuation">|</span><span class="token punctuation">|</span> list<span class="token punctuation">-</span>alt</pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">categories</span><span class="token punctuation">:</span> /categories/ <span class="token punctuation">|</span><span class="token punctuation">|</span> th</pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token key atrule">tags</span><span class="token punctuation">:</span> /tags/ <span class="token punctuation">|</span><span class="token punctuation">|</span> tags</pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">friends</span><span class="token punctuation">:</span> /friends/ <span class="token punctuation">|</span><span class="token punctuation">|</span> heart</pre></td></tr></table></figure><p><code>menu</code>  支持一级子目录，子目录设置中的第一项必须为  <code>default</code>  ，用来定义父级按钮的样式。</p><h1 id="社交按钮"><a class="anchor" href="#社交按钮">#</a> 社交按钮</h1><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># Social Links</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># Usage: `Key: permalink || icon || color`</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># Key is the link label showing to end users.</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># Value before `||` delimiter is the target permalink,</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># secend value is the name of Font icon.</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">social</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">github</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//github.com/amehime <span class="token punctuation">|</span><span class="token punctuation">|</span> github <span class="token punctuation">|</span><span class="token punctuation">|</span> "<span class="token comment">#191717"</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token comment">#google: https://plus.google.com/yourname || google</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">twitter</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//twitter.com/amehime <span class="token punctuation">|</span><span class="token punctuation">|</span> twitter <span class="token punctuation">|</span><span class="token punctuation">|</span> "<span class="token comment">#00aff0"</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">zhihu</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//www.zhihu.com/people/rurismzk <span class="token punctuation">|</span><span class="token punctuation">|</span> zhihu <span class="token punctuation">|</span><span class="token punctuation">|</span> "<span class="token comment">#1e88e5"</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token key atrule">music</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//music.163.com/<span class="token comment">#/user/home?id=12886823 || cloud-music || "#e60026"</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token key atrule">weibo</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//weibo.com/amehime <span class="token punctuation">|</span><span class="token punctuation">|</span> weibo <span class="token punctuation">|</span><span class="token punctuation">|</span> "<span class="token comment">#ea716e"</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token key atrule">about</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//about.me/amehime <span class="token punctuation">|</span><span class="token punctuation">|</span> address<span class="token punctuation">-</span>card <span class="token punctuation">|</span><span class="token punctuation">|</span> "<span class="token comment">#3b5998"</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment">#email: mailto:yourname@mail.com || envelope || "#55acd5"</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token comment">#facebook: https://www.facebook.com/yourname || facebook</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token comment">#stackoverflow: https://stackoverflow.com/yourname || stack-overflow</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token comment">#youtube: https://youtube.com/yourname || youtube</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token comment">#instagram: https://instagram.com/yourname || instagram</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token comment">#skype: skype:yourname?call|chat || skype</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token comment">#douban: https://www.douban.com/people/yourname/ || douban</span></pre></td></tr></table></figure><p>如上，使用  <code>||</code>  作为分隔符，依次为  <code>链接 || 图标 || 颜色</code>  。<br />注意，只需要写图标名称，如  <code>github</code>  ，则会自动转换为  <code>ic i-github</code>  。<br />十六进制颜色码需要  <code>&quot;&quot;</code>  包绕。</p><h1 id="边栏配置"><a class="anchor" href="#边栏配置">#</a> 边栏配置</h1><p>边栏可以选择在左侧，或右侧。</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">sidebar</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token comment"># Sidebar Position.</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token key atrule">position</span><span class="token punctuation">:</span> left</pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token comment">#position: right</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token comment"># Replace the default avatar image and set the url here.</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">avatar</span><span class="token punctuation">:</span> avatar.jpg</pre></td></tr></table></figure><p>修改头像文件的地址，相对于静态文件目录  <code>images</code>  中配置的路径。</p><p>可以将自己的图片放在  <code>&lt;root&gt;/source/_data/images/</code>  目录，甚至以同名覆盖主题内默认的头像图片。</p><h1 id="底部-widgets"><a class="anchor" href="#底部-widgets">#</a> 底部 widgets</h1><p>目前页面底部可以显示两个小部件，即  <code>随机文章</code>  和  <code>最近评论</code>  。</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">widgets</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">random_posts</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 显示随机文章</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token key atrule">recent_comments</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 显示最近评论</span></pre></td></tr></table></figure><h1 id="打赏功能"><a class="anchor" href="#打赏功能">#</a> 打赏功能</h1><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># Reward (Donate)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">reward</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token comment"># If true, reward will be displayed in every article by default.</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">account</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">wechatpay</span><span class="token punctuation">:</span> /wechatpay.png</pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token key atrule">alipay</span><span class="token punctuation">:</span> /alipay.png</pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment"># paypal: /paypal.png</span></pre></td></tr></table></figure><p>默认打开，对应的奖赏图片在  <code>&lt;root&gt;/themes/shoka/source/images</code>  中找到对应的名称图片。</p><h1 id="标签显示"><a class="anchor" href="#标签显示">#</a> 标签显示</h1><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># TagCloud settings for tags page.</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">tagcloud</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token comment"># All values below are same as default, change them by yourself.</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">min</span><span class="token punctuation">:</span> <span class="token number">16</span> <span class="token comment"># Minimun font size in px</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">max</span><span class="token punctuation">:</span> <span class="token number">22</span> <span class="token comment"># Maxium font size in px</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">start</span><span class="token punctuation">:</span> <span class="token string">"#72cecf"</span> <span class="token comment"># Start color (hex, rgba, hsla or color keywords)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">end</span><span class="token punctuation">:</span> <span class="token string">"#ffbac3"</span> <span class="token comment"># End color (hex, rgba, hsla or color keywords)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">amount</span><span class="token punctuation">:</span> <span class="token number">200</span> <span class="token comment"># Amount of tags, change it if you have more than 200 tags</span></pre></td></tr></table></figure><h1 id="背景音乐"><a class="anchor" href="#背景音乐">#</a> 背景音乐</h1><p>在主题配置文件中，设置全局播放列表。<br />在文章的 Front Matter 中，设置文章专有播放列表，访问该文章页面时，将覆盖全局配置。</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">audio</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token punctuation">-</span> https<span class="token punctuation">:</span>//music.163.com/song<span class="token punctuation">?</span>id=1387098940</pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token punctuation">-</span> https<span class="token punctuation">:</span>//music.163.com/<span class="token comment">#/playlist?id=2088001742</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token punctuation">-</span> https<span class="token punctuation">:</span>//www.xiami.com/collect/250830668</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token punctuation">-</span> https<span class="token punctuation">:</span>//y.qq.com/n/yqq/playsquare/3535982902.html</pre></td></tr></table></figure><p>如上，可以直接使用网易云、虾米、QQ 音乐的播放列表、单曲，可以同时填写多个。</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">audio</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">title</span><span class="token punctuation">:</span> 列表1</pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">list</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token punctuation">-</span> https<span class="token punctuation">:</span>//music.163.com/<span class="token comment">#/playlist?id=2943811283</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token punctuation">-</span> https<span class="token punctuation">:</span>//music.163.com/<span class="token comment">#/playlist?id=2297706586</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">title</span><span class="token punctuation">:</span> 列表2</pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token key atrule">list</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token punctuation">-</span> https<span class="token punctuation">:</span>//music.163.com/<span class="token comment">#/playlist?id=2031842656</span></pre></td></tr></table></figure><p>如果需要自定义媒体文件，可以按照以下格式填写：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">audio</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"曲目1"</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">url</span><span class="token punctuation">:</span> <span class="token string">"播放地址"</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token key atrule">artist</span><span class="token punctuation">:</span> <span class="token string">"艺术家"</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">cover</span><span class="token punctuation">:</span> <span class="token string">"封面"</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">lrc</span><span class="token punctuation">:</span> <span class="token string">"歌词"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"曲目2"</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token key atrule">url</span><span class="token punctuation">:</span> <span class="token string">"播放地址"</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">artist</span><span class="token punctuation">:</span> <span class="token string">"艺术家"</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">cover</span><span class="token punctuation">:</span> <span class="token string">"封面"</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">lrc</span><span class="token punctuation">:</span> <span class="token string">"歌词"</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token key atrule">audio</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">title</span><span class="token punctuation">:</span> 列表1</pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token key atrule">list</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"曲目1"</span></pre></td></tr><tr><td data-num="16"></td><td><pre>          <span class="token key atrule">url</span><span class="token punctuation">:</span> <span class="token string">"播放地址"</span></pre></td></tr><tr><td data-num="17"></td><td><pre>          <span class="token key atrule">artist</span><span class="token punctuation">:</span> <span class="token string">"艺术家"</span></pre></td></tr><tr><td data-num="18"></td><td><pre>          <span class="token key atrule">cover</span><span class="token punctuation">:</span> <span class="token string">"封面"</span></pre></td></tr><tr><td data-num="19"></td><td><pre>          <span class="token key atrule">lrc</span><span class="token punctuation">:</span> <span class="token string">"歌词"</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"曲目2"</span></pre></td></tr><tr><td data-num="21"></td><td><pre>          <span class="token key atrule">url</span><span class="token punctuation">:</span> <span class="token string">"播放地址"</span></pre></td></tr><tr><td data-num="22"></td><td><pre>          <span class="token key atrule">artist</span><span class="token punctuation">:</span> <span class="token string">"艺术家"</span></pre></td></tr><tr><td data-num="23"></td><td><pre>          <span class="token key atrule">cover</span><span class="token punctuation">:</span> <span class="token string">"封面"</span></pre></td></tr><tr><td data-num="24"></td><td><pre>          <span class="token key atrule">lrc</span><span class="token punctuation">:</span> <span class="token string">"歌词"</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">title</span><span class="token punctuation">:</span> 列表2</pre></td></tr><tr><td data-num="26"></td><td><pre>      <span class="token key atrule">list</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token punctuation">-</span> https<span class="token punctuation">:</span>//music.163.com/<span class="token comment">#/playlist?id=2031842656</span></pre></td></tr></table></figure><p>如果要关闭当前页面的背景音乐播放器，则在文章 Front Matter 中配置：</p><figure class="highlight markdown"><figcaption data-lang="markdown"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token front-matter-block"><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token front-matter yaml language-yaml"><span class="token key atrule">title</span><span class="token punctuation">:</span> 关闭背景音乐</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">audio</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">---</span></span></pre></td></tr></table></figure><h1 id="随机图库"><a class="anchor" href="#随机图库">#</a> 随机图库</h1><ul><li><p>默认的图片列表位于  <code>&lt;root&gt;/themes/shoka/_images.yml</code>  中。<br />使用了渣浪图库，使用一些上传工具，比如<span class="exturl" data-url="aHR0cHM6Ly9waWMuZ2ltaG95LmNvbS8=">这里</span><br />上传后图片的链接是  <code>http://wx4.sinaimg.cn/large/6833939bly1gicmnywqgpj20zk0m8dwx.jpg</code>  。<br />只需要新一行写上  <code>- 6833939bly1gicmnywqgpj20zk0m8dwx.jpg</code>  。</p><p>如果想要自定义，则在  <code>&lt;root&gt;/source/_data/</code>  目录新建一个  <code>images.yml</code>  文件，这个文件中的图片至少 6 枚，将完全覆盖默认的图片列表。</p></li><li><p>也可以直接在图片列表 yml 文件中，写上任意外链图片地址</p></li></ul><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">-</span> https<span class="token punctuation">:</span>//i.loli.net/2020/10/30/qAMYEFXxJcKRsiG.gif</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">-</span> https<span class="token punctuation">:</span>//i.loli.net/2020/10/30/rjdhcSgEN8COBPA.jpg</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">-</span> https<span class="token punctuation">:</span>//i.loli.net/2020/10/30/HKyzSd7NI3mlBpt.jpg</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">-</span> https<span class="token punctuation">:</span>//i.loli.net/2020/10/30/Y1CBXqgeokEs457.jpg</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">-</span> https<span class="token punctuation">:</span>//i.loli.net/2020/10/30/Z5W6r2BSoiThHG1.jpg</pre></td></tr></table></figure><ul><li>也可以在主题配置文件中，设置图床 API：</li></ul><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">image_server</span><span class="token punctuation">:</span> <span class="token string">"https://acg.xydwz.cn/api/api.php"</span></pre></td></tr></table></figure><h1 id="网页标题栏签名"><a class="anchor" href="#网页标题栏签名">#</a> 网页标题栏签名</h1><p>原样式：</p><ul><li><p><strong>（●´3｀●）やれやれだぜ</strong></p></li><li><p><strong>（´Д｀）大変だ！</strong></p></li></ul><p>对应修改文件位置：  <code>&lt;root&gt;\themes\shoka\languages</code>  中对应语言中的  <code>favicon</code>  元素：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">favicon</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">show</span><span class="token punctuation">:</span> <span class="token comment"># 切换回来的提示语</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token key atrule">hide</span><span class="token punctuation">:</span> <span class="token comment"># 退出页面的签名</span></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Hexo-shoka </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>博客搭建笔记之 Hexo-shoka</title>
      <link href="/docs/Hexo/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA%E7%AC%94%E8%AE%B0%E4%B9%8B%20Hexo-shoka/"/>
      <url>/docs/Hexo/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA%E7%AC%94%E8%AE%B0%E4%B9%8B%20Hexo-shoka/</url>
      
        <content type="html"><![CDATA[<h1 id="前言"><a class="anchor" href="#前言">#</a> 前言</h1><ol><li><p>欢迎访问 “ <strong>Arachnid's blog</strong> ”：<a href="https://arachnid.cc">https://arachnid.cc</a></p></li><li><p>本系列专属于记录个人博客搭建过程，使用 Hexo 框架 + shoka 主题 + Github pages 服务；你说有啥好？那就是：gayhub 不倒博客继续跑。</p></li><li><p>目前功能效果：分类、标签、评论、搜索、背景音乐、赞赏、字数统计、阅读量统计、随机图库、社交外链、页面特效等等。</p></li></ol><h1 id="准备工作"><a class="anchor" href="#准备工作">#</a> 准备工作</h1><p>此处开始之前，默认你已经实现了以下操作：</p><ul><li>拥有一个 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tLw==">Github</span> 账号，没有的话去注册一个；</li><li>安装了 <span class="exturl" data-url="aHR0cHM6Ly9ub2RlanMub3JnL2VuLw==">Node.js</span> （注意 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlvL3poLWNuL2RvY3MvI05vZGUtanMtJUU3JTg5JTg4JUU2JTlDJUFDJUU5JTk5JTkwJUU1JTg4JUI2">Hexo 版本限制</span>），并了解相关 npm 的基础知识；</li><li>安装了 <span class="exturl" data-url="aHR0cHM6Ly9naXQtc2NtLmNvbS8=">git</span>（或者其它终端），以下默认你的终端服务为 git 。</li></ul><p>然后其他的 git 绑定 Github、生成 ssh 这些操作也默认你准备完成了，实在不懂就网上搜一下吧。</p><h1 id="网站建立"><a class="anchor" href="#网站建立">#</a> 网站建立</h1><h2 id="本地建站"><a class="anchor" href="#本地建站">#</a> 本地建站</h2><p><strong>1、安装 Hexo</strong></p><p>打开 git 终端，输入安装命令并回车：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">npm</span> <span class="token function">install</span> <span class="token parameter variable">-g</span> hexo-cli</pre></td></tr></table></figure><p>然后拓展一下 npm 常规命令：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">npm</span> <span class="token function">ls</span> <span class="token parameter variable">-dept</span> <span class="token number">0</span> <span class="token comment">#查看已安装插件</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">npm</span> <span class="token function">install</span> Plugin_name <span class="token parameter variable">--save</span> <span class="token comment">#安装名为 Plugin_name 的插件</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">npm</span> uninstall Plugin_name <span class="token comment">#卸载名为 Plugin_name 的插件</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">npm</span> outdated <span class="token comment">#检查插件更新</span></pre></td></tr></table></figure><p><strong>2、建立本地存储</strong></p><p><strong>创建</strong>并<strong>打开</strong>你需要存放 blog 网站代码的文件夹，例如 “<em>blog_dir</em>” ：</p><pre><code>mkdir &quot;blog_dir&quot;cd &quot;blog_dir&quot;</code></pre><p>初始化 Hexo，输入命令并回车：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>hexo init</pre></td></tr></table></figure><p>然后启动本地服务查看，此处为动态访问，非静态网页：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>hexo s</pre></td></tr></table></figure><p>最后根据输出提示，浏览器打开链接 <span class="exturl" data-url="aHR0cDovL2xvY2FsaG9zdDo0MDAwLw==">http://localhost:4000/</span>，你将会访问到 Hello World；至此，你已经完成本地博客搭建了，请为自己欢呼 &quot;tada&quot;</p><p><strong>note：</strong> 可能有些在启动本地服务查看时会出现端口被占用的情况，那么可以通过更改端口来实现访问，具体命令看下一点。</p><p><strong>3、hexo 常用命令</strong></p><figure class="highlight raw"><figcaption data-lang=""></figcaption><table><tr><td data-num="1"></td><td><pre>hexo new &quot;postName&quot; #新建文章</pre></td></tr><tr><td data-num="2"></td><td><pre>hexo new page &quot;pageName&quot; #新建页面</pre></td></tr><tr><td data-num="3"></td><td><pre>hexo new draft &quot;draftName&quot; #新建草稿</pre></td></tr><tr><td data-num="4"></td><td><pre>hexo generate #生成静态页面至 public 目录</pre></td></tr><tr><td data-num="5"></td><td><pre>hexo server #本地动态访问页面（默认端口 4000，&#39;ctrl + c&#39; 关闭 server）</pre></td></tr><tr><td data-num="6"></td><td><pre>hexo deploy #部署到服务器</pre></td></tr><tr><td data-num="7"></td><td><pre>hexo clean #删除缓存文件及静态文件</pre></td></tr><tr><td data-num="8"></td><td><pre>hexo help  #查看帮助</pre></td></tr><tr><td data-num="9"></td><td><pre>hexo version  #查看 Hexo 的版本</pre></td></tr></table></figure><p>更多操作可查看：<span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlvL3poLWNuL2RvY3MvY29tbWFuZHMuaHRtbA==">Hexo 指令</span></p><p>关于有用的指令缩写：</p><figure class="highlight raw"><figcaption data-lang=""></figcaption><table><tr><td data-num="1"></td><td><pre>hexo cl &#x3D;&#x3D; hexo clean</pre></td></tr><tr><td data-num="2"></td><td><pre>hexo n &#x3D;&#x3D; hexo new</pre></td></tr><tr><td data-num="3"></td><td><pre>hexo g &#x3D;&#x3D; hexo generate</pre></td></tr><tr><td data-num="4"></td><td><pre>hexo s &#x3D;&#x3D; hexo server</pre></td></tr><tr><td data-num="5"></td><td><pre>hexo d &#x3D;&#x3D; hexo deploy</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>hexo s -p &quot;new_port&quot; #更改访问端口并启动访问服务</pre></td></tr><tr><td data-num="8"></td><td><pre>hexo s -s #调用静态页面进行本地访问，确保调用过 &#96;hexo g&#96; 命令</pre></td></tr><tr><td data-num="9"></td><td><pre>hexo d -g #预先生成静态文件并部署到服务器</pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>hexo cl &amp;&amp; hexo d -g #清缓存、重构静态页面、部署 --- 俗称 &quot;一键三连&quot;</pre></td></tr></table></figure><h2 id="云端部署-基于-github-pages"><a class="anchor" href="#云端部署-基于-github-pages">#</a> 云端部署 --- 基于 Github pages</h2><p><strong>1、创建仓库</strong></p><p>前往 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tLw==">GitHub</span> 并<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL25ldw==">创建</span>一个名为 <strong><em>username</em> .github.io</strong> 的公共存储库，其中<em> username</em> 是您在 GitHub 上的用户名（注意必须要对应上，否则无法使用）</p><p><strong>2、关联服务器地址</strong></p><p>打开你的 “<em>blog_dir</em>” 文件夹，在根目录下找到  <code>_config.yml</code>  文件对其进行以下修改：</p><p><img data-src="image-20220503173246533.png" alt="image-20220503173246533" /></p><p><code>repo</code>  为上面创建的仓库地址， <code>branch</code>  填写主分支（新的是  <code>main</code>  ，以前旧的是  <code>master</code> ）</p><p>安装关联插件：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">npm</span> <span class="token function">install</span> hexo-deployer-git <span class="token parameter variable">--save</span></pre></td></tr></table></figure><p>其他的就不多作解释了，详细可看：<span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlvL2RvY3Mvb25lLWNvbW1hbmQtZGVwbG95bWVudA==">Hexo 一站式部署</span></p><p><strong>3、一键三连</strong></p><p>执行：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>hexo cl <span class="token operator">&amp;&amp;</span> hexo d <span class="token parameter variable">-g</span></pre></td></tr></table></figure><h2 id="域名绑定可选"><a class="anchor" href="#域名绑定可选">#</a> 域名绑定（可选）</h2><p><strong>1、注册购买域名</strong></p><p>一般的话，国内比较好的就 <span class="exturl" data-url="aHR0cHM6Ly93YW53YW5nLmFsaXl1bi5jb20vZG9tYWluLw==">阿里云</span>或者 <span class="exturl" data-url="aHR0cHM6Ly9kbnNwb2QuY2xvdWQudGVuY2VudC5jb20v">腾讯云</span>，国外就 <span class="exturl" data-url="aHR0cHM6Ly93d3cubmFtZXNpbG8uY29tLw==">NameSilo</span> 和 <span class="exturl" data-url="aHR0cHM6Ly93d3cuZHluYWRvdC5jb20v">Dynadot</span>，当然，除了这些还有很多域名购买网站；然而，最好就是找那些比较大型稳定的网站购买；除此之外，你也可以到 <span class="exturl" data-url="aHR0cHM6Ly93d3cubmF6aHVtaS5jb20v">https://www.nazhumi.com/</span> 中查看在哪里购买会性价比更高一些。</p><p><strong>2、域名解析</strong></p><p>对于不同的购买网站，其操作不同，这里用的是 NameSilo：</p><p><img data-src="image-20220512223909467.png" alt="image-20220512223909467" /></p><p>进入域名管理，然后在你想要设置的域名中，配置 DNS 解析。</p><p><img data-src="image-20220512224914568.png" alt="image-20220512224914568" /></p><p>在 DNS 设置部分，你可以删除自带的记录，再重新添加；又或者直接编辑原有的记录，不过要对应上类型，一般只需要  <code>C</code>  和  <code>CNAME</code>  这两个类型就足够了。</p><p><strong>3、绑定域名到 Hexo 博客</strong></p><p>进入本地博客文件夹的 source 目录，打开记事本，里面输入自己的域名，如 <span class="exturl" data-url="aHR0cDovL3d3dy5leGFtcGxlLmNvbQ==">http://www.example.com</span>，保存名称为 “CNAME”。如我的是：</p><p><img data-src="image-20220512230351288.png" alt="image-20220512230351288" /></p><p>记住，直接是 “CNAME” 文件，是不带后缀的。</p><p><strong>4、开启 HTTPS 服务</strong></p><p>在完成上一步域名文件创建后，通过 “一键三连” 重新部署网站，然后来到 GitHub 博客仓库里进行打开：</p><p><img data-src="image-20220512231152522.png" alt="image-20220512231152522" /></p><p>HTTPS 证书部署成功需要一定时间，等大概几分钟再访问域名，就可以看到域名前面的小绿锁了，至此 HTTPS 配置完成！</p><h1 id="主题修改"><a class="anchor" href="#主题修改">#</a> 主题修改</h1><p>hexo 目前收录了三百多个<span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlvL3RoZW1lcy8=">主题</span>，你可以对他们进行一直修改，这些都是可以的，当然，如果你也可以自己创作一个专属于你自己的主题。以下皆以 shoka 主题进行解说。</p><h2 id="应用主题"><a class="anchor" href="#应用主题">#</a> 应用主题</h2><h3 id="安装主题文件"><a class="anchor" href="#安装主题文件">#</a> 安装主题文件</h3><p>拉取 Shoka 主题到  <code>themes/shoka</code>  目录，在 Hexo 根目录（即你的 blog 根目录，后面全部统称  <code>&lt;root&gt;</code>  ）执行下面的命令：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">git</span> clone https://github.com/amehime/hexo-theme-shoka.git ./themes/shoka</pre></td></tr></table></figure><h3 id="更换主题模式"><a class="anchor" href="#更换主题模式">#</a> 更换主题模式</h3><p>修改配置文件，更改主题模式为  <code>shoka</code>  ；在  <code>&lt;root&gt;/_config.yml</code>  文件中找到  <code>theme</code>  ，做如下更改：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">theme</span><span class="token punctuation">:</span> shoka</pre></td></tr></table></figure><h3 id="修改主题配置"><a class="anchor" href="#修改主题配置">#</a> 修改主题配置</h3><p>主题配置的所有参数在  <code>&lt;root&gt;/themes/shoka/_config.yml</code>  文件中。</p><p>为了避免以后主题版本升级或者提交出现配置合并或冲突，建议复制主题目录下的   <code>_config.yml</code>  到 Hexo 根目录，并命名为  <code>_config.shoka.yml</code>  ，也就是说，所有主题的自定义配置均保存于  <code>&lt;root&gt;/_config.shoka.yml</code>  文件。现在，您可以删除 shoka 主题目录下的  <code>_config.yml</code>  文件，或将它重命名为  <code>_config.yml.template</code>  。</p><p>然后，里面的配置信息，这里就不阐述了，直接看 shoka 主题的博主姐姐的文章吧：</p><p><span class="exturl" data-url="aHR0cHM6Ly9zaG9rYS5sb3N0eXUubWUvY29tcHV0ZXItc2NpZW5jZS9ub3RlL3RoZW1lLXNob2thLWRvYy9jb25maWcv">主题的基础配置可以参考这里</span><br /><span class="exturl" data-url="aHR0cHM6Ly9zaG9rYS5sb3N0eXUubWUvY29tcHV0ZXItc2NpZW5jZS9ub3RlL3RoZW1lLXNob2thLWRvYy9kaXNwbGF5Lw==">界面显示相关的配置参考这里</span></p><h2 id="插件依赖"><a class="anchor" href="#插件依赖">#</a> 插件依赖</h2><p>根据 shoka 主题的博主姐姐写的<span class="exturl" data-url="aHR0cHM6Ly9zaG9rYS5sb3N0eXUubWUvY29tcHV0ZXItc2NpZW5jZS9ub3RlL3RoZW1lLXNob2thLWRvYy9kZXBlbmRlbnRzLw==">文章</span> ，净化的 shoka 主题必须安装以下两个插件：</p><table><thead><tr><th>插件名称</th><th>npm 地址</th><th>功能</th></tr></thead><tbody><tr><td>hexo-renderer-multi-markdown-it</td><td><span class="exturl" data-url="aHR0cHM6Ly93d3cubnBtanMuY29tL3BhY2thZ2UvaGV4by1yZW5kZXJlci1tdWx0aS1tYXJrZG93bi1pdA==">链接</span></td><td>md 文件渲染器，压缩 css/js/html</td></tr><tr><td>hexo-autoprefixer</td><td><span class="exturl" data-url="aHR0cHM6Ly93d3cubnBtanMuY29tL3BhY2thZ2UvaGV4by1hdXRvcHJlZml4ZXI=">链接</span></td><td>给生成的 css 文件们添加浏览器前缀</td></tr></tbody></table><p>然后安装完以上插件后，修改站点配置文件  <code>&lt;root&gt;/_config.yml</code>  ，加入相关配置。</p><h3 id="multi-markdown-it-安装与配置"><a class="anchor" href="#multi-markdown-it-安装与配置">#</a> multi-markdown-it 安装与配置</h3><h4 id="安装"><a class="anchor" href="#安装">#</a> 安装</h4><ol><li><p>安装前，记得务必卸载掉默认的  <code>hexo-renderer-marked</code>  ，以及别的 markdown 文件渲染器。</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">npm</span> un hexo-renderer-marked <span class="token parameter variable">--save</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 或者</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">yarn</span> remove hexo-renderer-marked</pre></td></tr></table></figure></li><li><p>安装插件</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">npm</span> i hexo-renderer-multi-markdown-it <span class="token parameter variable">--save</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 或者</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">yarn</span> <span class="token function">add</span> hexo-renderer-multi-markdown-it</pre></td></tr></table></figure></li></ol><h4 id="配置"><a class="anchor" href="#配置">#</a> 配置</h4><ol><li><p>加入  <code>markdown</code>  配置，用来渲染 md 文件</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">markdown</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">render</span><span class="token punctuation">:</span> <span class="token comment"># 渲染器设置</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">html</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 过滤 HTML 标签</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token key atrule">xhtmlOut</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 使用 '/' 来闭合单标签 （比如 &lt;br />）。</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">breaks</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 转换段落里的 '\n' 到 &lt;br>。</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">linkify</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 将类似 URL 的文本自动转换为链接。</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token key atrule">typographer</span><span class="token punctuation">:</span> </pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token key atrule">quotes</span><span class="token punctuation">:</span> <span class="token string">'“”‘’'</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">plugins</span><span class="token punctuation">:</span> <span class="token comment"># markdown-it 插件设置</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">plugin</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token key atrule">name</span><span class="token punctuation">:</span> markdown<span class="token punctuation">-</span>it<span class="token punctuation">-</span>toc<span class="token punctuation">-</span>and<span class="token punctuation">-</span>anchor</pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token key atrule">options</span><span class="token punctuation">:</span> <span class="token comment"># 文章目录以及锚点应用的 class 名称，shoka 主题必须设置成这样</span></pre></td></tr><tr><td data-num="14"></td><td><pre>          <span class="token key atrule">tocClassName</span><span class="token punctuation">:</span> <span class="token string">'toc'</span></pre></td></tr><tr><td data-num="15"></td><td><pre>          <span class="token key atrule">anchorClassName</span><span class="token punctuation">:</span> <span class="token string">'anchor'</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">plugin</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token key atrule">name</span><span class="token punctuation">:</span> markdown<span class="token punctuation">-</span>it<span class="token punctuation">-</span>multimd<span class="token punctuation">-</span>table</pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token key atrule">options</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>          <span class="token key atrule">multiline</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="21"></td><td><pre>          <span class="token key atrule">rowspan</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="22"></td><td><pre>          <span class="token key atrule">headerless</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">plugin</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token key atrule">name</span><span class="token punctuation">:</span> ./markdown<span class="token punctuation">-</span>it<span class="token punctuation">-</span>furigana</pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token key atrule">options</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="27"></td><td><pre>          <span class="token key atrule">fallbackParens</span><span class="token punctuation">:</span> <span class="token string">"()"</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">plugin</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token key atrule">name</span><span class="token punctuation">:</span> ./markdown<span class="token punctuation">-</span>it<span class="token punctuation">-</span>spoiler</pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token key atrule">options</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="32"></td><td><pre>          <span class="token key atrule">title</span><span class="token punctuation">:</span> <span class="token string">"你知道得太多了"</span></pre></td></tr></table></figure></li><li><p>加入  <code>minify</code>  配置，压缩 css/js/html</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">minify</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">html</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token key atrule">exclude</span><span class="token punctuation">:</span> <span class="token comment"># 排除 hexo-feed 用到的模板文件</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token punctuation">-</span> <span class="token string">'**/json.ejs'</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token punctuation">-</span> <span class="token string">'**/atom.ejs'</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token punctuation">-</span> <span class="token string">'**/rss.ejs'</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">css</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">exclude</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token punctuation">-</span> <span class="token string">'**/*.min.css'</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token key atrule">js</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token key atrule">mangle</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token key atrule">toplevel</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token key atrule">output</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token key atrule">compress</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token key atrule">exclude</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token punctuation">-</span> <span class="token string">'**/*.min.js'</span></pre></td></tr></table></figure></li><li><p>停用默认代码高亮功能，否则代码块的 mac 样式不能正常显示。</p><p>在  <code>&lt;root&gt;/_config.yml</code>  中找到  <code>highlight</code>  和  <code>prismjs</code>  ，把  <code>enable</code>  改成  <code>false</code>  。</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">highlight</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token key atrule">prismjs</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></pre></td></tr></table></figure></li></ol><h3 id="autoprefixer-安装与配置"><a class="anchor" href="#autoprefixer-安装与配置">#</a> autoprefixer 安装与配置</h3><h4 id="安装-2"><a class="anchor" href="#安装-2">#</a> 安装</h4><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre>npm i hexo<span class="token punctuation">-</span>autoprefixer <span class="token punctuation">-</span><span class="token punctuation">-</span>save</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 或者</span></pre></td></tr><tr><td data-num="3"></td><td><pre>yarn add hexo<span class="token punctuation">-</span>autoprefixer</pre></td></tr></table></figure><h4 id="配置-2"><a class="anchor" href="#配置-2">#</a> 配置</h4><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">autoprefixer</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">exclude</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token punctuation">-</span> <span class="token string">'*.min.css'</span></pre></td></tr></table></figure><h1 id="站点基本配置"><a class="anchor" href="#站点基本配置">#</a> 站点基本配置</h1><h2 id="设置站点资料"><a class="anchor" href="#设置站点资料">#</a> 设置站点资料</h2><p>在  <code>&lt;root&gt;/_config.yml</code>  中的  <code># Site</code>  栏目可以配置属于自己信息：</p><table><thead><tr><th style="text-align:center">参数</th><th style="text-align:center">描述</th></tr></thead><tbody><tr><td style="text-align:center">title</td><td style="text-align:center">网站标题</td></tr><tr><td style="text-align:center">subtitle</td><td style="text-align:center">网站副标题</td></tr><tr><td style="text-align:center">description</td><td style="text-align:center">网站描述</td></tr><tr><td style="text-align:center">keywords</td><td style="text-align:center">网站关键词，搜索引擎会搜索这些关键词</td></tr><tr><td style="text-align:center">author</td><td style="text-align:center">博主名字</td></tr><tr><td style="text-align:center">language</td><td style="text-align:center">网站语言，默认为英语 en，中文为 zh-CN</td></tr><tr><td style="text-align:center">timezone</td><td style="text-align:center">网站使用时区，默认使用访问电脑所在时区也可以指定比如使用上海时区  <code>Asia/Shanghai</code>  。建议使用默认就行了</td></tr></tbody></table><h2 id="配置-about-页面"><a class="anchor" href="#配置-about-页面">#</a> 配置 About 页面</h2><p>在 Hexo 根目录下执行：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>hexo new page <span class="token string">"about"</span></pre></td></tr></table></figure><p>在  <code>&lt;root&gt;/source/about/index.md</code>  文件中添加下面的字段：</p><figure class="highlight markdown"><figcaption data-lang="markdown"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token front-matter-block"><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token front-matter yaml language-yaml"><span class="token key atrule">title</span><span class="token punctuation">:</span> 自我介绍标题</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">layout</span><span class="token punctuation">:</span> about</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">---</span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>自我介绍正文</pre></td></tr></table></figure><p>其中 Front-matter 的  <code>layout: about</code>  字段为<strong>必要的</strong>且<strong>不可修改</strong>为其它值；Front-matter 的  <code>title</code>  和正文内容由您自定义编写。</p><h2 id="配置-404-页面"><a class="anchor" href="#配置-404-页面">#</a> 配置 404 页面</h2><p><span class="red">一般来说，hexo 的 404 页面配置是通过如下来设置的：</span></p><p>在 Hexo 根目录下  <code>source</code>  中创建  <code>404.md</code>  文件，添加字段如下：</p><figure class="highlight markdown"><figcaption data-lang="markdown"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token front-matter-block"><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token front-matter yaml language-yaml"><span class="token key atrule">layout</span><span class="token punctuation">:</span> <span class="token number">404</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">title</span><span class="token punctuation">:</span> <span class="token string">"[404]"</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">"May the Force be with you :&amp;#41;"</span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">---</span></span></pre></td></tr></table></figure><p>其中 Front-matter 的  <code>layout: 404</code>  字段为<strong>必要的</strong>且<strong>不可修改</strong>为其它值， <code>title</code>  字段为您自定义的标题， <code>description</code>  字段为 404 页面的自定义描述。</p><p><span class="red">但是，在 shoka 主题上，主题作者是写死了 404 页面的，因此只能做一些简单的修改，当然，你也可以魔改： </span></p><ol><li><p><strong>显示图片：</strong></p><p>在  <code>&lt;root&gt;\themes\shoka\source\images</code>  中找到  <code>404.png</code>  ，用你喜欢的图片替换即可，如果是其它格式的，在 ``&lt;root&gt;\themes\shoka\source\css_common\components\pages\pages.styl <code>搜索</code>  404.png` 替换即可；</p><p>需要注意的是， <code>links</code>  链接块中站点图片默认设为  <code>./*/images/404.png</code>  。</p></li><li><p><strong>标题文字：</strong></p><p>在 ``&lt;root&gt;themes\shoka\languages <code>文件夹中，找到你当前设置的语言文件，对</code>  not_found` 字段进行更改 。</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> Hexo-shoka </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>markdown语法测试</title>
      <link href="/docs/markdown%E8%AF%AD%E6%B3%95%E6%B5%8B%E8%AF%95/"/>
      <url>/docs/markdown%E8%AF%AD%E6%B3%95%E6%B5%8B%E8%AF%95/</url>
      
        <content type="html"><![CDATA[<h1 id="welcome-to-arachnids-blog"><a class="anchor" href="#welcome-to-arachnids-blog">#</a> Welcome to Arachnid‘s blog!</h1><h2 id="排版"><a class="anchor" href="#排版">#</a> 排版</h2><p><strong>粗体</strong> <em>斜体</em></p><p><s>这是一段错误的文本。</s></p><p>引用:</p><blockquote><p>引用鲁迅的话：我以为 “别人尊重我，是因为我很优秀”，后来才明白，“别人尊重我，是因为别人很优秀。</p></blockquote><p>有序列表:</p><ol><li>支持 Vim</li><li>支持 Emacs</li></ol><p>无序列表:</p><ul><li>项目 1</li><li>项目 2</li></ul><h2 id="图片与链接"><a class="anchor" href="#图片与链接">#</a> 图片与链接</h2><p>图片:</p><p><img data-src="https://avatars.githubusercontent.com/u/48347583?v=4" alt="test Image" title="test Image" /></p><p>链接:</p><p><a href="https://arachnid.cc">这是去往 Arachnid 博客的链接</a></p><h2 id="标题"><a class="anchor" href="#标题">#</a> 标题</h2><p>以下是各级标题，最多支持 5 级标题</p><pre><code># h1## h2### h3#### h4##### h4###### h5</code></pre><h2 id="代码"><a class="anchor" href="#代码">#</a> 代码</h2><p>示例:</p><pre><code>function get(key) &#123;    return m[key];&#125;</code></pre><p>代码高亮示例:</p><figure class="highlight javascript"><figcaption data-lang="javascript"><span>t</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="2"></td><td><pre>* nth element in the fibonacci series.</pre></td></tr><tr><td data-num="3"></td><td><pre>* @param n >= 0</pre></td></tr><tr><td data-num="4"></td><td><pre>* @return the nth element, >= 0.</pre></td></tr><tr><td data-num="5"></td><td><pre>*/</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">function</span> <span class="token function">fib</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token keyword">var</span> tmp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>n <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    tmp <span class="token operator">=</span> a<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    a <span class="token operator">+=</span> b<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    b <span class="token operator">=</span> tmp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">return</span> a<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre> </pre></td></tr><tr><td data-num="17"></td><td><pre>document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token function">fib</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">Employee</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>   empCount <span class="token operator">=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="3"></td><td><pre> </pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> salary<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name</pre></td></tr><tr><td data-num="6"></td><td><pre>        self<span class="token punctuation">.</span>salary <span class="token operator">=</span> salary</pre></td></tr><tr><td data-num="7"></td><td><pre>        Employee<span class="token punctuation">.</span>empCount <span class="token operator">+=</span> <span class="token number">1</span></pre></td></tr></table></figure><h1 id="markdown-扩展"><a class="anchor" href="#markdown-扩展">#</a> Markdown 扩展</h1><p>Markdown 扩展支持:</p><ul><li>表格</li><li>定义型列表</li><li>Html 标签</li><li>脚注</li><li>目录</li><li>时序图与流程图</li><li>MathJax 公式</li></ul><h2 id="表格"><a class="anchor" href="#表格">#</a> 表格</h2><table><thead><tr><th>Item</th><th>Value</th></tr></thead><tbody><tr><td>Computer</td><td>$1600</td></tr><tr><td>Phone</td><td>$12</td></tr><tr><td>Pipe</td><td>$1</td></tr></tbody></table><p>可以指定对齐方式，如 Item 列左对齐，Value 列右对齐，Qty 列居中对齐</p><table><thead><tr><th style="text-align:left">Item</th><th style="text-align:right">Value</th><th style="text-align:center">Qty</th></tr></thead><tbody><tr><td style="text-align:left">Computer</td><td style="text-align:right">$1600</td><td style="text-align:center">5</td></tr><tr><td style="text-align:left">Phone</td><td style="text-align:right">$12</td><td style="text-align:center">12</td></tr><tr><td style="text-align:left">Pipe</td><td style="text-align:right">$1</td><td style="text-align:center">234</td></tr></tbody></table><h2 id="定义型列表"><a class="anchor" href="#定义型列表">#</a> 定义型列表</h2><dl><dt>名词 1</dt><dd><p>定义 1（左侧有一个可见的冒号和四个不可见的空格）</p></dd><dt>代码块 2</dt><dd><p>这是代码块的定义（左侧有一个可见的冒号和四个不可见的空格）</p><pre><code>  代码块（左侧有八个不可见的空格）</code></pre></dd></dl><h2 id="html-标签"><a class="anchor" href="#html-标签">#</a> Html 标签</h2><p>支持在 Markdown 语法中嵌套 Html 标签，譬如，你可以用 Html 写一个纵跨两行的表格，最后使用  <code>` `</code>  把 Html 代码包裹起来应该就可以了：</p><pre><code>&lt;table&gt;    &lt;tr&gt;        &lt;th rowspan=&quot;2&quot;&gt;值班人员&lt;/th&gt;        &lt;th&gt;星期一&lt;/th&gt;        &lt;th&gt;星期二&lt;/th&gt;        &lt;th&gt;星期三&lt;/th&gt;    &lt;/tr&gt;    &lt;tr&gt;        &lt;td&gt;李强&lt;/td&gt;        &lt;td&gt;张明&lt;/td&gt;        &lt;td&gt;王平&lt;/td&gt;    &lt;/tr&gt;&lt;/table&gt;</code></pre><p><table>    <tr>        <th rowspan="2">值班人员</th>        <th>星期一</th>        <th>星期二</th>        <th>星期三</th>    </tr>    <tr>        <td>李强</td>        <td>张明</td>        <td>王平</td>    </tr></table></p><p><strong>提示</strong>，如果想对图片的宽度和高度进行控制，你也可以通过 img 标签，如:</p><p><img data-src="https://avatars.githubusercontent.com/u/48347583?v=4" width="50px" /></p><h2 id="脚注"><a class="anchor" href="#脚注">#</a> 脚注</h2><p>Markdown<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup> 来创建一个脚注</p><h2 id="目录"><a class="anchor" href="#目录">#</a> 目录</h2><p>通过  <code>[TOC]</code>  在文档中插入目录，如:</p><p>[TOC]</p><h2 id="时序图与流程图"><a class="anchor" href="#时序图与流程图">#</a> 时序图与流程图</h2><figure class="highlight mermaid"><figcaption data-lang="mermaid"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">sequenceDiagram</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    Alice<span class="token arrow operator">-></span>Bob<span class="token operator">:</span> Hello Bob, how are you?</pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">Note right of</span> Bob<span class="token operator">:</span> Bob thinks</pre></td></tr><tr><td data-num="4"></td><td><pre>    Bob<span class="token arrow operator">--></span>Alice<span class="token operator">:</span> I am good thanks!</pre></td></tr></table></figure><p>流程图:</p><figure class="highlight mermaid"><figcaption data-lang="mermaid"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">graph</span> TB</pre></td></tr><tr><td data-num="2"></td><td><pre>    A<span class="token text string">[Hard]</span> <span class="token arrow operator">--></span><span class="token label property">|Text|</span> B<span class="token text string">(Round)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    B <span class="token arrow operator">--></span> C<span class="token text string">&#123;Decision&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    C <span class="token arrow operator">--></span><span class="token label property">|One|</span> D<span class="token text string">[Result 1]</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    C <span class="token arrow operator">--></span><span class="token label property">|Two|</span> E<span class="token text string">[Result 2]</span></pre></td></tr></table></figure><blockquote><p><strong>提示:</strong> 更多关于时序图与流程图的语法请参考:</p><ul><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL21lcm1haWQtanMvbWVybWFpZC9ibG9iL2RldmVsb3AvUkVBRE1FLnpoLUNOLm1k">Mermaid</span></li></ul></blockquote><h2 id="katex-数学公式"><a class="anchor" href="#katex-数学公式">#</a> KaTex 数学公式</h2><p>$ 表示行内公式：</p><p>质能守恒方程可以用一个很简洁的方程式 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi><mo>=</mo><mi>m</mi><msup><mi>c</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">E=mc^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span> 来表达。</p><p><code>$$</code>  表示整行公式：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><msub><mi>a</mi><mi>i</mi></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\sum_{i=1}^n a_i=0 </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.929066em;vertical-align:-1.277669em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6513970000000002em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3000050000000005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.277669em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span></span></p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mi>x</mi></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>x</mi><mi>n</mi></msub><mo stretchy="false">)</mo><mo>=</mo><msubsup><mi>x</mi><mn>1</mn><mn>2</mn></msubsup><mo>+</mo><msubsup><mi>x</mi><mn>2</mn><mn>2</mn></msubsup><mo>+</mo><mo>⋯</mo><mo>+</mo><msubsup><mi>x</mi><mi>n</mi><mn>2</mn></msubsup></mrow><annotation encoding="application/x-tex">f(x_1,x_x,\ldots,x_n) = x_1^2 + x_2^2 + \cdots + x_n^2 </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.1111079999999998em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.1111079999999998em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.1111079999999998em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span></span></p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><munderover><mo>∑</mo><mrow><mi>k</mi><mo>=</mo><mn>0</mn></mrow><mrow><mi>j</mi><mo>−</mo><mn>1</mn></mrow></munderover><mrow><msub><mover accent="true"><mi>γ</mi><mo stretchy="true">^</mo></mover><mrow><mi>k</mi><mi>j</mi></mrow></msub><msub><mi>z</mi><mi>k</mi></msub></mrow></mrow><annotation encoding="application/x-tex">\sum^{j-1}_{k=0}{\widehat{\gamma}_{kj} z_k} </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.16089em;vertical-align:-1.302113em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8587770000000001em;"><span style="top:-1.8478869999999998em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.347113em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.302113em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.67056em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span></span></span><span class="svg-align" style="top:-3.43056em;"><span class="pstrut" style="height:3em;"></span><span style="height:0.24em;"><svg width='100%' height='0.24em' viewBox='0 0 1062 239' preserveAspectRatio='none'><path d='M529 0h5l519 115c5 1 9 5 9 10 0 1-1 2-1 3l-4 22c-1 5-5 9-11 9h-2L532 67 19 159h-2c-5 0-9-4-11-9l-5-22c-1-6 2-12 8-13z'/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></span></p><p>更复杂的公式：</p>\begin{eqnarray}\vec\nabla \times (\vec\nabla f) & = & 0  \cdots\cdots梯度场必是无旋场\\\vec\nabla \cdot(\vec\nabla \times \vec F) & = & 0\cdots\cdots旋度场必是无散场\\\vec\nabla \cdot (\vec\nabla f) & = & {\vec\nabla}^2f\\\vec\nabla \times(\vec\nabla \times \vec F) & = & \vec\nabla(\vec\nabla \cdot \vec F) - {\vec\nabla}^2 \vec F\\\end{eqnarray} <p>访问 <span class="exturl" data-url="aHR0cHM6Ly9rYXRleC5vcmcv">KaTex</span> 参考更多使用方法。</p><hr class="footnotes-sep" /><section class="footnotes"><ol class="footnotes-list"><li id="fn1" class="footnote-item"><p>Markdown 是一种轻量级标记语言. <a href="#fnref1" class="footnote-backref">↩︎</a></p></li></ol></section>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>基于官方指导安装 Arch Linux</title>
      <link href="/docs/Linux/%E5%9F%BA%E4%BA%8E%E5%AE%98%E6%96%B9%E6%8C%87%E5%AF%BC%E5%AE%89%E8%A3%85%20Arch%20Linux/"/>
      <url>/docs/Linux/%E5%9F%BA%E4%BA%8E%E5%AE%98%E6%96%B9%E6%8C%87%E5%AF%BC%E5%AE%89%E8%A3%85%20Arch%20Linux/</url>
      
        <content type="html"><![CDATA[<blockquote><p>官方 wiki 安装中文指导：<span class="exturl" data-url="aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvSW5zdGFsbGF0aW9uX2d1aWRlXyglRTclQUUlODAlRTQlQkQlOTMlRTQlQjglQUQlRTYlOTYlODcp">https://wiki.archlinux.org/title/Installation_guide_(简体中文)</span></p><p>最好还是以<strong>英文版</strong>的为基准，因为 ArchLinux 是一个激进的系统，更新比较快，可能刚写完这篇笔记，转头已经有些对应不上了，哈哈哈。</p></blockquote><h2 id="系统镜像"><a class="anchor" href="#系统镜像">#</a> 系统镜像</h2><p>官方镜像下载地址：<span class="exturl" data-url="aHR0cHM6Ly9hcmNobGludXgub3JnL2Rvd25sb2FkLw==">https://archlinux.org/download/</span></p><p>当然，也可以去各大高校提供的镜像源网站下载。</p><h2 id="启动盘制作"><a class="anchor" href="#启动盘制作">#</a> 启动盘制作</h2><p><strong>1、windows 平台</strong></p><p>可以使用 Rufus：<span class="exturl" data-url="aHR0cHM6Ly9ydWZ1cy5pZS96aC8=">https://rufus.ie/zh/</span></p><p>这是一款开源、免费、小巧（1.1mb）纯粹的系统启动盘制作工具。<br />目前所支持的 ISO 镜像如下：</p><p><img data-src="image-20220412112425056.png" alt="image-20220412112425056" /></p><p><strong>2、Uinx 平台</strong></p><p>类 Unix 系统可以直接使用  <code>dd</code>  命令来制作启动盘。</p><p><code>dd</code>  命令使用可参考：<span class="exturl" data-url="aHR0cHM6Ly93d3cucnVub29iLmNvbS9saW51eC9saW51eC1jb21tLWRkLmh0bWw=">https://www.runoob.com/linux/linux-comm-dd.html</span></p><p><strong>3、多平台</strong></p><p>可以使用开源的 etcher：<span class="exturl" data-url="aHR0cHM6Ly93d3cuYmFsZW5hLmlvL2V0Y2hlci8=">https://www.balena.io/etcher/</span></p><blockquote><p>然后本篇文章是基于官方指导的总结分析安装的笔记，如下开始正式安装配置，因为是以官方 wiki 安装为指导，所以下面用到的操作的标题将一一对应官方 wiki 的标题，没用到的将忽略不写，以及需要增加的将给出说明。目前使用的镜像版本： <code>archlinux-2022.04.01-x86_64.iso</code></p></blockquote><h2 id="引导安装"><a class="anchor" href="#引导安装">#</a> 引导安装</h2><p>Arch 的启动引导过程有两种：<span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQklPUw==">BIOS</span> 和 <span class="exturl" data-url="aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvVUVGSQ==">UEFI</span> 系统，这两者的引导过程是完全不同的。在 Arch 中它们的引导加载及区别可看：<span class="exturl" data-url="aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvQXJjaF9ib290X3Byb2Nlc3M=">https://wiki.archlinux.org/title/Arch_boot_process</span></p><p>目前大部分设备的引导方式主要分为  <code>UEFI 引导 + GPT 分区表</code>  和  <code>BIOS(LEGACY) 引导 + MBR 分区表</code>  这两种，而在新的机器里大部分都采用了  <code>UEFI/GPT</code>  引导的方式，当然，同时也兼容  <code>BIOS/MBR</code>  。</p><p>UEFI 进入：</p><p><img data-src="image-20220412115757611.png" alt="image-20220412115757611" /></p><p>BIOS 进入：</p><p><img data-src="image-20220412120426116.png" alt="image-20220412120426116" /></p><p>启动安装后，最终界面出现的效果是一样的：</p><p><img data-src="image-20220412153955531.png" alt="image-20220412153955531" /></p><h2 id="验证引导模式"><a class="anchor" href="#验证引导模式">#</a> 验证引导模式</h2><p>键入如下命令：（ <code>ls</code> ：表示列出目录内容；后面的路径可以利用 Tab 键 自动补全，即键入命令或文件名的前几个字符，然后按 [Tab] 键）</p><pre><code>ls /sys/firmware/efi/efivars</code></pre><p>如果命令结果显示了目录且没有报告错误，则系统以 UEFI 模式引导。</p><p>如果目录不存在，则系统可能 **（注意是可能，并不一定确是 BIOS 模式）** 以 <span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvemg6QklPUw==">BIOS</span> 模式 (或 <span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ29tcGF0aWJpbGl0eV9TdXBwb3J0X01vZHVsZQ==">CSM</span> 模式) 引导，如显示：</p><pre><code>ls: cannot access '/sys/firmware/efi/efivars': No such file or directory</code></pre><p>对于一些不是新的 / 格式过的磁盘，可能就不太适用了，当然，最好方法就是查看安装的主分区磁盘的属性。</p><h2 id="连接到因特网"><a class="anchor" href="#连接到因特网">#</a> 连接到因特网</h2><p>1、检查网络接口是否启用</p><pre><code>ip link</code></pre><p>2、连接到网络</p><ul><li>有线：连接网线，并保证上级路由有网。</li><li>无线：使用 <span class="exturl" data-url="aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvSXdkXyglRTclQUUlODAlRTQlQkQlOTMlRTQlQjglQUQlRTYlOTYlODcpI2l3Y3Rs">iwctl</span> 验证无线网络，具体操作点击链接查看。</li></ul><p>3、配置网络连接</p><ul><li><p>动态：需要支持 DHCP，然后执行以下命令。</p><pre><code>dhcpcd</code></pre></li><li><p>静态：直接按照 <span class="exturl" data-url="aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvTmV0d29ya19jb25maWd1cmF0aW9uXyglRTclQUUlODAlRTQlQkQlOTMlRTQlQjglQUQlRTYlOTYlODcpIyVFOSU5RCU5OSVFNiU4MCU4MV9JUF8lRTUlOUMlQjAlRTUlOUQlODA=">静态 IP 地址</span> 这个链接进行操作。</p></li></ul><p>4、检查网络连接</p><p>在确认无误完成上面的操作后，通过 PING IP 来检查：</p><pre><code>ping archlinux.org</code></pre><p>**note：** 关于网络部分的，详情请看 <span class="exturl" data-url="aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvTmV0d29ya19jb25maWd1cmF0aW9u">https://wiki.archlinux.org/title/Network_configuration</span></p><h2 id="更新系统时间"><a class="anchor" href="#更新系统时间">#</a> 更新系统时间</h2><p>执行：</p><pre><code>timedatectl set-ntp true</code></pre><p>然后正常情况下是并没有输出的，所谓没有消息就是最好的消息，这就是 Linux/Unix 系统的设计思想。</p><p>最后，执行如下命令来检查服务状态：</p><pre><code>timedatectl status</code></pre><h2 id="建立硬盘分区"><a class="anchor" href="#建立硬盘分区">#</a> 建立硬盘分区</h2><p>系统如果识别到磁盘，就会将其分配为一个块设备，如  <code>/dev/sda</code> 、 <code>/dev/nvme0n1</code>  或  <code>/dev/mmcblk0</code>  等等。然后可以执行如下命令查看：</p><pre><code>fdisk -l</code></pre><p>然后，针对不同的引导方式，其分区布局是不一样的，以官方给出的分区为例：</p><ul><li><p><strong>UEFI 与</strong> <span class="exturl" data-url="aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvUGFydGl0aW9uaW5nXyglRTclQUUlODAlRTQlQkQlOTMlRTQlQjglQUQlRTYlOTYlODcpI0dVSURfJUU1JTg4JTg2JUU1JThDJUJBJUU4JUExJUE4">GPT</span></p><table><thead><tr><th>挂载点</th><th>分区</th><th>分区类型</th><th>建议大小</th></tr></thead><tbody><tr><td>/mnt/boot</td><td>/dev/<em>efi_system_partition</em></td><td>EFI 系统分区</td><td>至少 300 MiB</td></tr><tr><td>[SWAP]</td><td>/dev/<em>swap_partition</em></td><td>Linux swap (交换空间)</td><td>大于 512 MiB</td></tr><tr><td>/mnt</td><td>/dev/<em>root_partition</em></td><td>Linux x86-64 根目录 (/)</td><td>剩余空间</td></tr></tbody></table></li><li><p><strong>BIOS 与</strong> <span class="exturl" data-url="aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvUGFydGl0aW9uaW5nXyglRTclQUUlODAlRTQlQkQlOTMlRTQlQjglQUQlRTYlOTYlODcpI01hc3Rlcl9Cb290X1JlY29yZA==">MBR</span></p><table><thead><tr><th>挂载点</th><th>分区</th><th>分区类型</th><th>建议大小</th></tr></thead><tbody><tr><td>[SWAP]</td><td>/dev/<em>swap_partition</em></td><td>Linux swap (交换空间)</td><td>大于 512 MiB</td></tr><tr><td>/mnt</td><td>/dev/<em>root_partition</em></td><td>Linux x86-64 根目录 (/)</td><td>剩余空间</td></tr></tbody></table><p>然后在这里拓展一下  <code>MiB</code>  跟  <code>MB</code>  这两个单位， <code>MB</code>  是国际单位制 SI 制定的十进制标准单位制，这个 M 是 1000K，而  <code>MiB</code>  是国际电工委员会 IEC 制定的二进制标准，这个 M 是 1024K 。参看：<span class="exturl" data-url="aHR0cHM6Ly9waHlzaWNzLm5pc3QuZ292L2N1dS9Vbml0cy9iaW5hcnkuaHRtbA==">https://physics.nist.gov/cuu/Units/binary.html</span></p></li><li><p>其它的布局实例可看：<span class="exturl" data-url="aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvUGFydGl0aW9uaW5nXyglRTclQUUlODAlRTQlQkQlOTMlRTQlQjglQUQlRTYlOTYlODcpIyVFNSVCOCU4MyVFNSVCMSU4MCVFNyVBNCVCQSVFNCVCRSU4Qg==">https://wiki.archlinux.org/title/Partitioning_(简体中文)# 布局示例</span></p></li></ul><p>在了解上面的布局后，然后我们常用的引导方式有  <code>UEFI 引导 + GPT 分区表</code>  和  <code>BIOS(LEGACY) 引导 + MBR 分区表</code>  这两种，所以下面分开说明：</p><ol><li><p><strong>BIOS/MBR</strong></p><p>这种方式相对于另一种比较简单，所以就先说了。</p><p>首先，先来了解一下  <code>[SWAP]</code>  挂载点和  <code>/mnt</code>  挂载点：</p><ul><li><p><code>[SWAP]</code> ：swap 分区通常被称为交换分区，这是一块特殊的硬盘空间，即当实际内存（物理内存，可以理解为内存条容量）不够用的时候，操作系统会从内存中取出一部分暂时不用的数据，放在交换分区中，从而为当前运行的程序腾出足够的内存空间（有点类似于 windows 系统下的虚拟内存）。也就是说，当内存不够用时，我们使用 swap 分区来临时顶替，等到那些程序要运行时，再从 swap 中恢复保存的数据到内存中。这种 “拆东墙，补西墙” 的方式应用于几乎所有的操作系统中。</p><p>使用 swap 交换分区，显著的优点是，通过操作系统的调度，应用程序实际可以使用的内存空间将远远超过系统的物理内存。</p><p>那么 swap 分区到底设置成多大才最优？少了又觉得不够，多了又感觉浪费，那么我们可以参考 Redhat 官方文档中 <span class="exturl" data-url="aHR0cHM6Ly9hY2Nlc3MucmVkaGF0LmNvbS9kb2N1bWVudGF0aW9uL2VuLXVzL3JlZF9oYXRfZW50ZXJwcmlzZV9saW51eC82L2h0bWwvaW5zdGFsbGF0aW9uX2d1aWRlL3MyLWRpc2twYXJ0cmVjb21tZW5kLXBwYyNpZDQzOTQwMDc=">关于 swap 分区大小设置的建议</span>：</p><table><thead><tr><th style="text-align:center">物理内存</th><th style="text-align:center">建议的交换空间大小</th><th style="text-align:center">如果开启休眠功能建议的交换空间大小</th></tr></thead><tbody><tr><td style="text-align:center">⩽ 2GB</td><td style="text-align:center">内存的 2 倍</td><td style="text-align:center">内存的 3 倍</td></tr><tr><td style="text-align:center">&gt; 2GB – 8GB</td><td style="text-align:center">等于内存大小</td><td style="text-align:center">内存的 2 倍</td></tr><tr><td style="text-align:center">&gt; 8GB – 64GB</td><td style="text-align:center">至少 4G</td><td style="text-align:center">内存的 1.5 倍</td></tr><tr><td style="text-align:center">&gt; 64GB</td><td style="text-align:center">至少 4G</td><td style="text-align:center">不建议使用休眠</td></tr></tbody></table><p>最后结合日常使用，一般来说可以按照如下规则设置 swap 大小：</p><ul><li>4G 以内的物理内存，SWAP 设置为内存的 2 倍，不超过 4G。</li><li>4-8G 的物理内存，SWAP 等于内存大小。</li><li>8-64G 的物理内存，SWAP 设置为 8G。</li><li>64-256G 物理内存，SWAP 设置为 16G。</li></ul></li><li><p><code>/mnt</code> ：全称  <code>mount</code>  可直接理解为 “挂载”，用于存放手动挂载的硬件。这部分是根目录 <code>/</code>  下的目录，用来挂载文件系统。</p><p>一般的 Linux 根目录展开如下图：</p><p><img data-src="994198-20160908160724832-375737054.png" alt="img" /></p><p>然后按照官方的说明，是想把将根磁盘卷挂载到  <code>/mnt</code>  目录下，即  <code>/mnt</code>  变成  <code>/</code>  根目录。</p></li></ul><p><strong>好了，了解完后下面正式开始。</strong></p><p>执行命令：</p><pre><code>fdisk /dev/sdx （sdx可以为sda、sdb等，具体以你实际需要挂载的磁盘名称为准）</code></pre><p>接着你就进入了  <code>fdisk</code>  操作环境，为了获取该命令下的操作功能，根据提示输入  <code>m</code>  并回车查看各命令的作用：</p><p><img data-src="image-20220414144302934.png" alt="image-20220414144302934" /></p><p>在  <code>fdisk</code>  操作环境下：</p><p>1、对于一个全新的磁盘（格式化了），输入  <code>o</code>  来创建一个全新的  <code>MBR</code>  分区表（因为这里是 BIOS 引导）；如果是旧磁盘（要么原本有  <code>MBR</code>  分区表，要么不是  <code>MBR</code>  属性  <code>DOS</code>  的），那对于非  <code>MBR</code>  分区表可能得更改分区表或者格式化，而已有  <code>MBR</code>  分区表的直接执行第 2 步。</p><p>2、输入  <code>n</code>  创建一个新的分区，首先会让你选择类型分区，输入  <code>p</code>  选择主分区，回车接着选择分区号，这里一般直接回车使用默认数值，这样可以避免自己定义出现冲突；紧接着选择开始起扇区地址，如果不知道原有区域划分情况，那一般直接回车使用默认数值即可；随后，输入结束扇区地址或者容量大小，这里决定了你为该分区创建的容量大小；我们按照表格顺序创建分区，那这第一个就是  <code>swap</code>  交换分区，例如我分配的是 8G 容量，那可以直接输入容量大小： <code>+8G</code>  。</p><p>3、创建完毕后，可以输入  <code>p</code>  来查看创建的分区。</p><p>4、重复第 2 项创建根目录分区和第 3 项确认最后的分区信息，至此就有两个分区（对应表格）。</p><p>5、最后输入  <code>w</code>  将之前所有的操作写入磁盘并生效。</p></li><li><p><strong>UEFI/GPT</strong></p><p>与上一种引导方式相比，根据表格显示，只多了一个 <strong>EFI 系统分区</strong>，然后了解一下这个挂载点：</p><ul><li><code>/mnt/boot</code> ：上面说了官方是想把将根磁盘卷挂载到  <code>/mnt</code>  目录下，那这个 boot 引导自然就挂载到了新的  <code>/mnt</code>  目录下了。</li></ul><p>在该引导模式下的操作就如下。</p><p>执行命令如下进入  <code>fdisk</code>  操作环境：</p><pre><code>fdisk /dev/sdx （sdx可以为sda、sdb等，具体以你实际需要挂载的磁盘名称为准）</code></pre><p>在  <code>fdisk</code>  操作环境下：</p><p>1、对于一个全新的磁盘（格式化了），这里则输入  <code>g</code>  来创建一个全新的  <code>GPT</code>  分区表（因为到这里是 UEFI 引导）；同样的如果是旧磁盘那跟上面的 BIOS 引导操作差不多，只不过这里是  <code>GPT</code>  属性了。</p><p>2、输入  <code>n</code>  创建一个新的分区，让你选择分区号 **（UEFI 比 BIOS 少了类型分区选择）**，这里一般直接回车使用默认数值，这样可以避免自己定义出现冲突；紧接着选择开始起扇区地址，如果不知道原有区域划分情况，那一般直接回车使用默认数值即可；随后，输入结束扇区地址或者容量大小，这里决定了你为该分区创建的容量大小；我们按照表格顺序创建分区，那这第一个就是  <code>/mnt/boot</code>  引导分区，例如我取的是 512MiB 容量，那可以直接输入容量大小： <code>+512M</code>  。</p><p>3、创建完毕后，可以输入  <code>p</code>  来查看创建的分区。</p><p>4、重复第 2 项和第 3 项两次，分别创建  <code>[SWAP]</code>  和  <code>/mnt</code> ，至此就有三个分区（对应表格）。</p><p>5、最后输入  <code>w</code>  将之前所有的操作写入磁盘并生效。</p></li></ol><h2 id="格式化分区"><a class="anchor" href="#格式化分区">#</a> 格式化分区</h2><ul><li><p><strong>EFI 系统分区（仅对于 UEFI/GPT 引导方式）</strong></p><p>使用  <code>mkfs.fat</code>  命令将其格式化为 Fat32：</p><pre><code>mkfs.fat -F 32 /dev/sdxY （sdxY为上面创建的 EFI 系统分区符）</code></pre></li><li><p><strong>swap 交换分区</strong></p><p>如果有创建，则请使用  <code>mkswap</code>  命令将其初始化：</p><pre><code>mkswap /dev/sdxY （sdxY为上面创建的交换空间分区符）</code></pre></li><li><p><strong> <code>/mnt</code>  根目录分区</strong></p><p>执行以下命令创建一个 Ext4 文件系统：</p><pre><code>mkfs.ext4 /dev/sdxY （sdxY为上面创建的根分区符）</code></pre></li></ul><h2 id="挂载分区"><a class="anchor" href="#挂载分区">#</a> 挂载分区</h2><p>1、将根磁盘卷挂载到  <code>/mnt</code> ，执行：</p><pre><code>mount /dev/sdxY /mnt （把 sdxY替换为上面创建根分区符）</code></pre><p>2、如果创建了  <code>swap</code>  交换空间卷，执行：</p><pre><code>swapon /dev/sdxY （把 sdxY替换为上面创建的交换空间分区符）</code></pre><p>3、对于 UEFI 系统，挂载 EFI 系统分区：</p><pre><code>mkdir /mnt/bootmount /dev/sdxY /mnt/boot （把 sdxY替换为上面创建的 EFI 系统分区符）</code></pre><h2 id="选择镜像"><a class="anchor" href="#选择镜像">#</a> 选择镜像</h2><p>文件  <code>/etc/pacman.d/mirrorlist</code>  定义了软件包会从哪个镜像源下载。在列表中越前的镜像在下载软件包时有越高的优先权。</p><p>各地区镜像源获取：<span class="exturl" data-url="aHR0cHM6Ly9hcmNobGludXgub3JnL21pcnJvcmxpc3Qv">https://archlinux.org/mirrorlist/</span> ，然后点击生成：</p><p><img data-src="image-20220415095310180.png" alt="image-20220415095310180" /></p><p>编辑  <code>/etc/pacman.d/mirrorlist</code>  文件，执行：</p><pre><code>vim /etc/pacman.d/mirrorlist</code></pre><p>然后进入 VIM 环境，输入  <code>i</code>  进入编辑状态，然后根据上面生成提供的镜像表，选择几个放到文件最顶端，在这里笔者选择阿里云镜像：</p><p><img data-src="image-20220415103048537.png" alt="image-20220415103048537" /></p><p>如果其速度不佳，可以手动指定其他镜像源，像中科大或者清华的放在最上面即可：</p><pre><code>Server = https://mirrors.ustc.edu.cn/archlinux/$repo/os/$archServer = https://mirrors.tuna.tsinghua.edu.cn/archlinux/$repo/os/$arch</code></pre><p>然后，按  <code>Esc</code>  键退出编程，最后输入  <code>:wq</code>  保存退出。</p><p>关于 vim 命令的使用，可看：<span class="exturl" data-url="aHR0cHM6Ly93d3cucnVub29iLmNvbS9saW51eC9saW51eC12aW0uaHRtbA==">https://www.runoob.com/linux/linux-vim.html</span></p><h2 id="安装必需的软件包"><a class="anchor" href="#安装必需的软件包">#</a> 安装必需的软件包</h2><p>使用  <code>pacstrap</code>  脚本，安装 <span class="exturl" data-url="aHR0cHM6Ly9hcmNobGludXgub3JnL3BhY2thZ2VzLz9uYW1lPWJhc2U=">base</span> 软件包和 Linux <span class="exturl" data-url="aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvS2VybmVsXyglRTclQUUlODAlRTQlQkQlOTMlRTQlQjglQUQlRTYlOTYlODcp">内核</span>以及常规硬件的固件：</p><pre><code>pacstrap /mnt base base-devel linux linux-headers linux-firmware （base-devel在 AUR包的安装是必须的）</code></pre><h2 id="fstab配置"><a class="anchor" href="#fstab配置">#</a> Fstab 配置</h2><p>生成自动挂载分区的  <code>fstab</code>  文件，执行命令：</p><pre><code>genfstab -U /mnt &gt;&gt; /mnt/etc/fstab</code></pre><p>然后  <code>cat</code>  一下检查生成的  <code>/mnt/etc/fstab</code>  文件是否正确：</p><pre><code>cat /mnt/etc/fstab</code></pre><p>执行后将显示各分区挂载情况及属性信息。</p><h2 id="chroot配置"><a class="anchor" href="#chroot配置">#</a> Chroot 配置</h2><p><span class="exturl" data-url="aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvQ2hhbmdlX3Jvb3RfKCVFNyVBRSU4MCVFNCVCRCU5MyVFNCVCOCVBRCVFNiU5NiU4Nyk=">Change root</span> 到新安装的系统：</p><pre><code>arch-chroot /mnt</code></pre><p>执行了这步以后，我们的操作都相当于在磁盘上新装的系统中进行。</p><h2 id="时区配置"><a class="anchor" href="#时区配置">#</a> 时区配置</h2><p>设置时区：</p><pre><code>ln -sf /usr/share/zoneinfo/Region（地区名）/City（城市名） /etc/localtime</code></pre><p>eg：以上海为例，执行  <code>ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</code></p><p>然后运行  <code>hwclock</code>  以生成  <code>/etc/adjtime</code> ：</p><pre><code>hwclock --systohc</code></pre><h2 id="本地化配置"><a class="anchor" href="#本地化配置">#</a> 本地化配置</h2><p>程序和库如果需要本地化文本，则需要根据区域设置 Locale，以明确规定地域、货币、时区日期的格式、字符排列方式和其他本地化标准。</p><p>需在这两个文件设置： <code>locale.gen</code>  与  <code>locale.conf</code> 。</p><p>通过前面的 Chroot 配置，我们已经处于 chroot 环境下了，这就意味这现在所在的系统中只有一些最基本的包（组件），而 VIM 组件并未包含在里面，这时候就需要自己安装组件包了。利用 Archlinux 下非常强大的包管理工具  <code>pacman</code> ，其安装包的命令格式为  <code>pacman -S 包名</code> ， <code>pacman</code>  会自动检查这个包所需要的其他包（即为依赖）并一起装上。</p><p>然后我们安装 VIM 组件，执行：</p><pre><code>pacman -S vim</code></pre><p>1、利用刚安装的  <code>vim</code>  ，编辑  <code>locale.gen</code>  文件：</p><pre><code>vim /etc/locale.gen</code></pre><p>找到  <code>zh_CN.UTF-8 UTF-8</code> 、 <code>en_US.UTF-8 UTF-8</code>  这两行，去掉注释并保存。</p><p>紧接着执行  <code>locale-gen</code>  以生成 locale 信息：</p><pre><code>locale-gen</code></pre><p>2、然后创建 <span class="exturl" data-url="aHR0cHM6Ly9tYW4uYXJjaGxpbnV4Lm9yZy9tYW4vbG9jYWxlLmNvbmYuNQ==">locale.conf</span> 文件，并 <span class="exturl" data-url="aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvTG9jYWxlXyglRTclQUUlODAlRTQlQkQlOTMlRTQlQjglQUQlRTYlOTYlODcpIyVFNyVCMyVCQiVFNyVCQiU5RiVFNSU4QyVCQSVFNSU5RiU5RiVFOCVBRSVCRSVFNyVCRCVBRQ==">编辑设定 LANG 变量</span>，</p><pre><code>echo LANG=en_US.UTF-8 &gt; /etc/locale.conf</code></pre><h2 id="网络配置"><a class="anchor" href="#网络配置">#</a> 网络配置</h2><p>创建  <code>/etc/hostname</code>  文件，并设定的一个  <code>myhostname</code> ：</p><pre><code>echo myhostname &gt; /etc/hostname （myhostname是你想要为该系统设置的名称）</code></pre><p>这步在我目前使用的功能里好像没用到。。。</p><p>然后，在官方文档中有一条说明：</p><blockquote><p>请注意，目前的 <span class="exturl" data-url="aHR0cHM6Ly9hcmNobGludXgub3JnL3BhY2thZ2VzLz9uYW1lPWJhc2U=">base</span> 不含有任何网络管理工具。对于新安装的系统环境，请接着完成<span class="exturl" data-url="aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvJUU3JUJEJTkxJUU3JUJCJTlDJUU5JTg1JThEJUU3JUJEJUFF">网络配置</span>，配置过程中可能包括要安装合适的<span class="exturl" data-url="aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvJUU3JUJEJTkxJUU3JUJCJTlDJUU3JUFFJUExJUU3JTkwJTg2">网络管理</span>软件。</p></blockquote><p>因此，我们需要安装网络配置管理包（<span class="exturl" data-url="aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvRGhjcGNkXyglRTclQUUlODAlRTQlQkQlOTMlRTQlQjglQUQlRTYlOTYlODcp">DHCP</span> 客户端和 <span class="exturl" data-url="aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvTmV0Y3RsXyglRTclQUUlODAlRTQlQkQlOTMlRTQlQjglQUQlRTYlOTYlODcp">netctl</span> 网络管理器）：</p><pre><code>pacman -S dhcpcd netctl</code></pre><h2 id="root-密码"><a class="anchor" href="#root-密码">#</a> Root 密码</h2><p><code>Root</code>  是  <code>Linux</code>  中具有最高权限帐户，有些敏感的操作必须通过  <code>Root</code>  用户进行，比如使用 <code>pacman</code>  命令。</p><p>执行以下命令，然后根据提示输入两次密码即可（注意输入是不显示出来）：</p><pre><code>passwd root</code></pre><h2 id="安装引导程序"><a class="anchor" href="#安装引导程序">#</a> 安装引导程序</h2><p>如果是 Intel 或 AMD 的 CPU，启用 <span class="exturl" data-url="aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvTWljcm9jb2RlXyglRTclQUUlODAlRTQlQkQlOTMlRTQlQjglQUQlRTYlOTYlODcp">微码</span> 更新：</p><ul><li><p>Intel</p><pre><code>pacman -S intel-ucode</code></pre></li><li><p>AMD</p><pre><code>pacman -S amd-ucode</code></pre></li></ul><p>接着，官方推荐的引导加载是 <span class="exturl" data-url="aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvR1JVQl8oJUU3JUFFJTgwJUU0JUJEJTkzJUU0JUI4JUFEJUU2JTk2JTg3KQ==">GRUB</span> （其他的引导加载可看：<span class="exturl" data-url="aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvQXJjaF9ib290X3Byb2Nlc3NfKCVFNyVBRSU4MCVFNCVCRCU5MyVFNCVCOCVBRCVFNiU5NiU4NykjJUU1JThBJTlGJUU4JTgzJUJEJUU2JUFGJTk0JUU4JUJFJTgz">引导功能比较</span>），因此我们对其安装并配置，不同的引导系统，其操作不一样：</p><ul><li><p><strong>BIOS/MBR</strong></p><p>1、安装  <code>grub</code> ：</p><pre><code>pacman -S grub</code></pre><p>2、部署  <code>grub</code> ：</p><pre><code>grub-install --target=i386-pc /dev/sdx （sdx为要安装 GRUB 的磁盘，注意不是分区）</code></pre></li><li><p><strong>UEFI/GPT</strong></p><p>1、安装  <code>grub</code>  和  <code>efibootmgr</code> ：</p><pre><code>pacman -S grub efibootmgr</code></pre><p>2、部署  <code>grub</code> ：</p><pre><code>grub-install --target=x86_64-efi --efi-directory=esp --bootloader-id=GRUB （这里的 esp 替换成挂载点）</code></pre><p>像在这里，那就是：</p><pre><code>grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=GRUB</code></pre></li></ul><p><strong>最后，不管是哪个引导方式，都执行第三步：</strong></p><p>3、生成配置文件：</p><pre><code>grub-mkconfig -o /boot/grub/grub.cfg</code></pre><p>执行后，最后显示  <code>done</code>  即完成操作。</p><p><strong>note：这一步是至关重要的一步，请检查是否正确安装好引导加载程序后再重新启动，否则下次重启后将无法正常进入系统。</strong></p><h2 id="重启"><a class="anchor" href="#重启">#</a> 重启</h2><p>最最最后，你需要进行重启来启动已经安装好的系统。</p><p>1、输入以下命令退出 chroot 环境：</p><pre><code>exit</code></pre><p>2、手动取消挂载的分区（这有助于发现任何「繁忙」的分区）：</p><p><strong>如果挂载了  <code>/mnt/boot</code> ，先  <code>umount -r /mnt/boot</code> ，再  <code>umount -r /mnt</code> ，否则直接  <code>umount /mnt</code> 。</strong></p><pre><code>umount -r /mnt/bootumount -r /mnt</code></pre><p>3、执行重启：</p><pre><code>reboot</code></pre><h2 id="other"><a class="anchor" href="#other">#</a> Other</h2><p>另外一些比较详细的安装教程：</p><p><span class="exturl" data-url="aHR0cHM6Ly9hcmNobGludXhzdHVkaW8uZ2l0aHViLmlvL0FyY2hMaW51eFR1dG9yaWFsLyMvP2lkPWFyY2gtbGludXgtJUU1JUFFJTg5JUU4JUEzJTg1JUU0JUJEJUJGJUU3JTk0JUE4JUU2JTk1JTk5JUU3JUE4JThCLWFyY2h0dXRvcmlhbC1hcmNoLWxpbnV4LXN0dWRpbw==">Arch Linux 安装使用教程</span></p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cudmlzZWF0b3IuY29tLzIwMTcvMDUvMTcvYXJjaF9pbnN0YWxsLw==">以官方 Wiki 的方式安装 ArchLinux</span></p>]]></content>
      
      
      
        <tags>
            
            <tag> history </tag>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>X/YModem传输协议</title>
      <link href="/docs/%E9%80%9A%E8%AE%AF%E5%8D%8F%E8%AE%AE/XYModem%E4%BC%A0%E8%BE%93%E5%8D%8F%E8%AE%AE/"/>
      <url>/docs/%E9%80%9A%E8%AE%AF%E5%8D%8F%E8%AE%AE/XYModem%E4%BC%A0%E8%BE%93%E5%8D%8F%E8%AE%AE/</url>
      
        <content type="html"><![CDATA[<h1 id="文件传输"><a class="anchor" href="#文件传输">#</a> 文件传输</h1><p>最常用的几种文件传输协议有：XModem、YModem、ZModem 等。</p><ul><li><p>XModem 是最早的文件传输协议之一，由于出现较早，几乎大部分的通讯程序所支持的文件传输都使用该协议，通常是传输 128 字节的信息块；这种古老的传输协议速度虽然较慢，但由于使用了 CRC 错误校验方法，传输的准确率可高达 99.6%。</p></li><li><p>YModem 协议是 XModem 的改进版，它最早用于调制解调器之间的文件传输，具有快速，稳定传输的优点。它的传输速度比 XModem 快，这是由于它可以一次传输 1024 字节的信息块，同时它还支持传输多个文件，也就是常说的批文件传输。</p></li><li><p>ZModem 协议的处理速度快于 XModem 和 YModem，这是因为它采用了串流式（streaming）传输方式，而且还具有自动改变区段大小和断点续传、快速错误侦测等功能，可以很好地进行断开后恢复传输。这是目前最流行的文件传输协议。</p></li><li><p>除开上面介绍的三种 X / Y / ZModem 协议，还有个常见的传输协议 --- ASCII 协议，这是最快的传输协议，但只能传送文本文件。</p></li></ul><p>X / Ymodem 协议：<br /><span class="exturl" data-url="aHR0cDovL3BhdWlsbGFjLmlucmlhLmZyL35kb2xpZ2V6L3ptb2RlbS95bW9kZW0udHh0">http://pauillac.inria.fr/~doligez/zmodem/ymodem.txt</span></p><p>Zmodem 协议：<br /><span class="exturl" data-url="aHR0cDovL2dhbGxpdW0uaW5yaWEuZnIvfmRvbGlnZXovem1vZGVtL3ptb2RlbS50eHQ=">http://gallium.inria.fr/~doligez/zmodem/zmodem.txt</span></p><h1 id="控制字符定义"><a class="anchor" href="#控制字符定义">#</a> 控制字符定义</h1><pre><code>&lt;SOH&gt; 01H       // 传输 128Byte 启动标志&lt;STX&gt; 02H // 传输 1024Byte 启动标志&lt;EOT&gt; 04H       // 传输结束&lt;ACK&gt; 06H       // 应答&lt;NAK&gt; 15H       // 没应答&lt;CAN&gt; 18H       // 取消传输&lt;C&gt; 43H         // ASCII 'C' CRC校验请求&lt;NUL&gt; 00H       // 空符填充&lt;CPMEOF&gt; 1AH    // 数据填充 (^Z)</code></pre><h1 id="xmodem通讯"><a class="anchor" href="#xmodem通讯">#</a> XModem 通讯</h1><p>Xmodem 是使用最广泛的文件传输协议之一。原始的 Xmodem 协议使用 128 字节数据包和一个简单的 “校验和 &quot; 错误检测方法。后面增强为 Xmodem-CRC，使用了更安全的循环冗余校验 (CRC) 用于错误检测方法。Xmodem 协议总是首先尝试使用 CRC。如果发件人不确认对 CRC 的请求，接收器将转移到 ” 校验和 “ 模式并继续其传输请求。</p><p>增强型 Xmodem-1K 本质上是 Xmodem CRC 模式传输 1K (1024 字节) 数据包。在某些系统和通报上它也可以称为 Ymodem。</p><p>Xmodem 协议传输由接收程序和发送程序完成，先由接收程序发送协商字符，协商校验方式，协商通过之后发送程序就开始发送数据包，接收程序接收到完整的一个数据包之后按照协商的方式对数据包进行校验。校验通过之后发送确认字符，然后发送程序继续发送下一包；如果校验失败，则发送否认字符，发送程序重传此数据包。<strong>信息报中如果剩余的数据不足 128 字节，不足的部分将以  <code>0x1A</code>  填充。</strong></p><h2 id="校验和模式"><a class="anchor" href="#校验和模式">#</a> 校验和模式</h2><h3 id="帧包格式"><a class="anchor" href="#帧包格式">#</a> 帧包格式</h3><table><thead><tr><th style="text-align:center">Byte1</th><th style="text-align:center">Byte2</th><th style="text-align:center">Byte3</th><th style="text-align:center">Byte4~131</th><th style="text-align:center">Byte132</th></tr></thead><tbody><tr><td style="text-align:center">Start Of Header(SOH)</td><td style="text-align:center">Packet NumberID</td><td style="text-align:center">~(Packet NumberID)</td><td style="text-align:center">Packet Data[128]</td><td style="text-align:center">CheckSUM</td></tr></tbody></table><h3 id="传输方式"><a class="anchor" href="#传输方式">#</a> 传输方式</h3><table><thead><tr><th style="text-align:center">Sender</th><th style="text-align:center">Flow</th><th style="text-align:center">Receiver</th></tr></thead><tbody><tr><td style="text-align:center"></td><td style="text-align:center">&lt;---</td><td style="text-align:center">NAK</td></tr><tr><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center">Time out after 3 Second</td></tr><tr><td style="text-align:center"></td><td style="text-align:center">&lt;---</td><td style="text-align:center">NAK</td></tr><tr><td style="text-align:center">&lt;SOH&gt; &lt;0x01&gt; &lt;0xFE&gt; &lt;Data[0-127]&gt; &lt;Chksum&gt;</td><td style="text-align:center">---&gt;</td><td style="text-align:center">Packet OK</td></tr><tr><td style="text-align:center"></td><td style="text-align:center">&lt;---</td><td style="text-align:center">ACK</td></tr><tr><td style="text-align:center">&lt;SOH&gt; &lt;0x02&gt; &lt;0xFD&gt; &lt;Data[0-127]&gt; &lt;Chksum&gt;</td><td style="text-align:center">---&gt;</td><td style="text-align:center"><strong>Line hit during transmission</strong></td></tr><tr><td style="text-align:center"></td><td style="text-align:center">&lt;---</td><td style="text-align:center"><strong>NAK</strong></td></tr><tr><td style="text-align:center">&lt;SOH&gt; &lt;0x02&gt; &lt;0xFD&gt; &lt;Data[0-127]&gt; &lt;Chksum&gt;</td><td style="text-align:center">---&gt;</td><td style="text-align:center">Packet OK</td></tr><tr><td style="text-align:center"></td><td style="text-align:center">&lt;---</td><td style="text-align:center">ACK</td></tr><tr><td style="text-align:center">&lt;SOH&gt; &lt;0x03&gt; &lt;0xFC&gt; &lt;Data[0-127]&gt; &lt;Chksum&gt;</td><td style="text-align:center">---&gt;</td><td style="text-align:center">Packet OK</td></tr><tr><td style="text-align:center"><strong>ACK get garbaged</strong></td><td style="text-align:center">&lt;---</td><td style="text-align:center">ACK</td></tr><tr><td style="text-align:center">&lt;SOH&gt; &lt;0x03&gt; &lt;0xFC&gt; &lt;Data[0-127]&gt; &lt;Chksum&gt;</td><td style="text-align:center">---&gt;</td><td style="text-align:center"><strong>Duplicate packet</strong></td></tr><tr><td style="text-align:center"></td><td style="text-align:center">&lt;---</td><td style="text-align:center"><strong>NAK</strong></td></tr><tr><td style="text-align:center">&lt;SOH&gt; &lt;0x04&gt; &lt;0xFB&gt; &lt;Data[0-127]&gt; &lt;Chksum&gt;</td><td style="text-align:center">---&gt;</td><td style="text-align:center"><strong>UART Framing err on any byte</strong></td></tr><tr><td style="text-align:center"></td><td style="text-align:center">&lt;---</td><td style="text-align:center"><strong>NAK</strong></td></tr><tr><td style="text-align:center">&lt;SOH&gt; &lt;0x04&gt; &lt;0xFB&gt; &lt;Data[0-127]&gt; &lt;Chksum&gt;</td><td style="text-align:center">---&gt;</td><td style="text-align:center">Packet OK</td></tr><tr><td style="text-align:center"></td><td style="text-align:center">&lt;---</td><td style="text-align:center">ACK</td></tr><tr><td style="text-align:center">&lt;SOH&gt; &lt;0x05&gt; &lt;0xFA&gt; &lt;Data[0-127]&gt; &lt;Chksum&gt;</td><td style="text-align:center">---&gt;</td><td style="text-align:center"><strong>UART Overrun err on any byte</strong></td></tr><tr><td style="text-align:center"></td><td style="text-align:center">&lt;---</td><td style="text-align:center"><strong>NAK</strong></td></tr><tr><td style="text-align:center">&lt;SOH&gt; &lt;0x05&gt; &lt;0xFA&gt; &lt;Data[0-127]&gt; &lt;Chksum&gt;</td><td style="text-align:center">---&gt;</td><td style="text-align:center">Packet OK</td></tr><tr><td style="text-align:center"></td><td style="text-align:center">&lt;---</td><td style="text-align:center">ACK</td></tr><tr><td style="text-align:center">EOT</td><td style="text-align:center">---&gt;</td><td style="text-align:center">Packet OK</td></tr><tr><td style="text-align:center"><strong>ACK get garbaged</strong></td><td style="text-align:center">&lt;---</td><td style="text-align:center">ACK</td></tr><tr><td style="text-align:center">EOT</td><td style="text-align:center">---&gt;</td><td style="text-align:center">Packet OK</td></tr><tr><td style="text-align:center">Finished</td><td style="text-align:center">&lt;---</td><td style="text-align:center">ACK</td></tr></tbody></table><h2 id="crc模式"><a class="anchor" href="#crc模式">#</a> CRC 模式</h2><p>计算 16 位 CRC 校验的除数多项式为： <code>X ^ 16 + X ^ 12 + X ^ 5 + 1</code> ，信息报中的 128 数据字节将参加 CRC 校验的计算，在发送端 CRC-16 的高字节在前，低字节在后。</p><h3 id="帧包格式-2"><a class="anchor" href="#帧包格式-2">#</a> 帧包格式</h3><table><thead><tr><th style="text-align:center">Byte1</th><th style="text-align:center">Byte2</th><th style="text-align:center">Byte3</th><th style="text-align:center">Byte4~131</th><th style="text-align:center">Byte132~133</th></tr></thead><tbody><tr><td style="text-align:center">Start Of Header(SOH)</td><td style="text-align:center">Packet NumberID</td><td style="text-align:center">~(Packet NumberID)</td><td style="text-align:center">Packet Data[128]</td><td style="text-align:center">16-Bit CRC</td></tr></tbody></table><h3 id="传输方式-2"><a class="anchor" href="#传输方式-2">#</a> 传输方式</h3><p>传输流程：接收方要求发送方以 CRC 校验方式发送时以 ‘C’ 来请求，发送方将对此作出应答。</p><table><thead><tr><th style="text-align:center">Sender</th><th style="text-align:center">Flow</th><th style="text-align:center">Receiver</th></tr></thead><tbody><tr><td style="text-align:center"></td><td style="text-align:center">&lt;---</td><td style="text-align:center">'C'</td></tr><tr><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center">Time out after 3 Second</td></tr><tr><td style="text-align:center"></td><td style="text-align:center">&lt;---</td><td style="text-align:center">'C'</td></tr><tr><td style="text-align:center">&lt;SOH&gt; &lt;0x01&gt; &lt;0xFE&gt; &lt;Data[0-127]&gt; &lt;CRC16&gt;</td><td style="text-align:center">---&gt;</td><td style="text-align:center">Packet OK</td></tr><tr><td style="text-align:center"></td><td style="text-align:center">&lt;---</td><td style="text-align:center">ACK</td></tr><tr><td style="text-align:center">&lt;SOH&gt; &lt;0x02&gt; &lt;0xFD&gt; &lt;Data[0-127]&gt; &lt;CRC16&gt;</td><td style="text-align:center">---&gt;</td><td style="text-align:center"><strong>Line hit during transmission</strong></td></tr><tr><td style="text-align:center"></td><td style="text-align:center">&lt;---</td><td style="text-align:center"><strong>NAK</strong></td></tr><tr><td style="text-align:center">&lt;SOH&gt; &lt;0x02&gt; &lt;0xFD&gt; &lt;Data[0-127]&gt; &lt;CRC16&gt;</td><td style="text-align:center">---&gt;</td><td style="text-align:center">Packet OK</td></tr><tr><td style="text-align:center"></td><td style="text-align:center">&lt;---</td><td style="text-align:center">ACK</td></tr><tr><td style="text-align:center">&lt;SOH&gt; &lt;0x03&gt; &lt;0xFC&gt; &lt;Data[0-127]&gt; &lt;CRC16&gt;</td><td style="text-align:center">---&gt;</td><td style="text-align:center">Packet OK</td></tr><tr><td style="text-align:center"></td><td style="text-align:center">&lt;---</td><td style="text-align:center">ACK</td></tr><tr><td style="text-align:center">EOT</td><td style="text-align:center">---&gt;</td><td style="text-align:center">Packet OK</td></tr><tr><td style="text-align:center">ACK get garbaged</td><td style="text-align:center">&lt;---</td><td style="text-align:center">ACK</td></tr><tr><td style="text-align:center">EOT</td><td style="text-align:center">---&gt;</td><td style="text-align:center">Packet OK</td></tr><tr><td style="text-align:center">Finished</td><td style="text-align:center">&lt;---</td><td style="text-align:center">ACK</td></tr></tbody></table><h2 id="扩展"><a class="anchor" href="#扩展">#</a> 扩展</h2><p>关于校验和和 CRC 校验可以看以前的文章《<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQyOTkyMDg0L2FydGljbGUvZGV0YWlscy8xMTY0NjYwMjk=">常用校验算法</span>》</p><p><span class="exturl" data-url="aHR0cHM6Ly93ZWIubWl0LmVkdS82LjExNS93d3cvYW11bGV0L3htb2RlbS5odG0=">XModem Protocol with CRC</span></p><h1 id="ymodem通讯"><a class="anchor" href="#ymodem通讯">#</a> YModem 通讯</h1><p>Ymodem 本质上是允许多个批处理文件传输的 Xmodem-1K，也可表示为 YModem-1K。</p><p>Ymodem 在 Xmodem-1K 基础上发展，沿用了  <code>TeLink</code>  协议的添加空头块的做法，也就是增加  <code>block 0</code> 。该 block 标识即将发送文件的  <code>文件名</code> ， <code>文件大小</code>  和   <code>文件创建时间戳(一般不填写)</code></p><p>Ymodem-g 是 Ymodem 的变体。它设计用于支持错误控制的调制解调器。该协议不提供软件纠错或恢复，但期望调制解调器提供服务。它是一种流式传输协议，以连续流的形式发送和接收 1K 个数据包，直到指示停止。YModem-g 传输形式与 YModem-1K 差不多，同时在发送完一个数据块后，它不会等待应答确认，而是快速连续地发送下一个数据块；如果有任何块不成功转移，整个转移被取消。</p><h2 id="起始帧block-0"><a class="anchor" href="#起始帧block-0">#</a> 起始帧（block 0）</h2><p>YModem 的起始帧并不直接传输文件的数据，而是将文件名与文件的大小放在数据帧中传输，它的帧长 = 3 字节数据首部 + 128 字节数据 + 2 字节 CRC16 校验码 = 33 字节。</p><table><thead><tr><th style="text-align:center">Byte1</th><th style="text-align:center">Byte2</th><th style="text-align:center">Byte3</th><th style="text-align:center">Byte4~131</th><th style="text-align:center">Byte132~133</th></tr></thead><tbody><tr><td style="text-align:center">Start Of Header(SOH)</td><td style="text-align:center">0x00</td><td style="text-align:center">0xFF</td><td style="text-align:center">[ &lt; <code>filename</code> &gt; &lt; <code>filezise</code> &gt; &lt;NUL&gt; ]</td><td style="text-align:center">16-Bit CRC</td></tr></tbody></table><p>说明：</p><ul><li>Byte 1~3：头标志是 SOH，起始帧序固定为 0x00，帧序取反为 0xFF。</li><li>Byte 4~131：<ul><li><code>filename</code>  是传输的文件名字，如文件名  <code>foo.c</code> ，它在起始帧中的格式为： <code>66 6F 6F 2E 63 00</code> ，也就是把 ASCII 码转成十六进制，最后的 0x00 代表文件名结束。</li><li><code>filesize</code>  是要传输的文件的大小，比如文件大小为 120 KByte，转换为  <code>120 * 1024 = 122880</code>  Byte，转化为十六进制为  <code>0x1E00</code> ，它在起始帧中的格式为： <code>31 45 30 30 00</code> ，对应 ASCII 为  <code>1E00</code> ，最后的 0x00 代表文件长度结束。</li><li>最后  <code>NUL</code>  代表剩余不足 128 Byte 部分用 0x00 填充。</li></ul></li><li>Byte 132~133：CRCH、CRCL 分别表示 16 位 CRC 校验码的高 8 位与低 8 位，高字节在前，低字节在后。</li></ul><h2 id="数据帧block-n"><a class="anchor" href="#数据帧block-n">#</a> 数据帧（block n）</h2><table><thead><tr><th style="text-align:center">Byte1</th><th style="text-align:center">Byte2</th><th style="text-align:center">Byte3</th><th style="text-align:center">Byte4~1027</th><th style="text-align:center">Byte1028~1029</th></tr></thead><tbody><tr><td style="text-align:center">Start Of Header(STX)</td><td style="text-align:center">Packet NumberID</td><td style="text-align:center">~(Packet NumberID)</td><td style="text-align:center">Packet Data[1024]</td><td style="text-align:center">16-Bit CRC</td></tr></tbody></table><p>注意：有一种特殊的情况是，如果文件总大小小于等于 128 字节或者文件数据最后剩余的数据小于 128 字节，则 YModem 会选择 SOH 数据帧格式用 128 字节来传输数据，而数据不满 128 字节，剩余的数据用  <code>0x1A</code>  填充。</p><p>这时数据帧的结构就变成了：</p><p>文件大小小于 128 字节： <code>&lt;SOH&gt; &lt;01&gt; &lt;FE&gt; &lt;data1&gt; &lt;data2&gt; ... &lt;datan&gt;  &lt;CPMEOF&gt; ... &lt;CRCH&gt; &lt;CRCL&gt;</code></p><p>文件最后剩余数据小于 128 字节： <code>&lt;SOH&gt; &lt;ID&gt; &lt;~ID&gt; &lt;data1&gt; &lt;data2&gt; ... &lt;datan&gt; &lt;CPMEOF&gt; ... &lt;CRCH&gt; &lt;CRCL&gt;</code></p><h2 id="结束帧block-n1"><a class="anchor" href="#结束帧block-n1">#</a> 结束帧（block n+1）</h2><p>YModem 的结束帧数据也采用 SOH 的 128 字节数据帧</p><table><thead><tr><th style="text-align:center">Byte1</th><th style="text-align:center">Byte2</th><th style="text-align:center">Byte3</th><th style="text-align:center">Byte4~131</th><th style="text-align:center">Byte132~133</th></tr></thead><tbody><tr><td style="text-align:center">Start Of Header(SOH)</td><td style="text-align:center">0x00</td><td style="text-align:center">0xFF</td><td style="text-align:center">&lt;NUL&gt;</td><td style="text-align:center">16-Bit CRC</td></tr></tbody></table><h2 id="传输流程"><a class="anchor" href="#传输流程">#</a> 传输流程</h2><p>以把 foo.c，大小为 4196Byte（16 进制为 0x1064）的文件作为传输的对象：</p><table><thead><tr><th style="text-align:center">Sender</th><th style="text-align:center">Flow</th><th style="text-align:center">Receiver</th></tr></thead><tbody><tr><td style="text-align:center"></td><td style="text-align:center">&lt;---</td><td style="text-align:center">'C'</td></tr><tr><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center">Time out after 3 Second</td></tr><tr><td style="text-align:center"></td><td style="text-align:center">&lt;---</td><td style="text-align:center">'C'</td></tr><tr><td style="text-align:center">&lt;SOH&gt; &lt;0x00&gt; &lt;0xFF&gt; &lt;Data[  <code>&lt;foo.c&gt;</code>  |  <code>&lt;0x1064&gt;</code>  | &lt;NUL&gt; ]&gt; &lt;CRC16&gt;</td><td style="text-align:center">---&gt;</td><td style="text-align:center">Packet OK</td></tr><tr><td style="text-align:center"></td><td style="text-align:center">&lt;---</td><td style="text-align:center">ACK</td></tr><tr><td style="text-align:center"></td><td style="text-align:center">&lt;---</td><td style="text-align:center">'C'</td></tr><tr><td style="text-align:center">&lt;STX&gt; &lt;0x01&gt; &lt;0xFE&gt; &lt;Data[0-1023]&gt; &lt;CRC16&gt;</td><td style="text-align:center">---&gt;</td><td style="text-align:center">Packet OK</td></tr><tr><td style="text-align:center"></td><td style="text-align:center">&lt;---</td><td style="text-align:center">ACK</td></tr><tr><td style="text-align:center">&lt;STX&gt; &lt;0x02&gt; &lt;0xFD&gt; &lt;Data[0-1023]&gt; &lt;CRC16&gt;</td><td style="text-align:center">---&gt;</td><td style="text-align:center">Packet OK</td></tr><tr><td style="text-align:center"></td><td style="text-align:center">&lt;---</td><td style="text-align:center">ACK</td></tr><tr><td style="text-align:center">&lt;STX&gt; &lt;0x03&gt; &lt;0xFC&gt; &lt;Data[0-1023]&gt; &lt;CRC16&gt;</td><td style="text-align:center">---&gt;</td><td style="text-align:center">Packet OK</td></tr><tr><td style="text-align:center"></td><td style="text-align:center">&lt;---</td><td style="text-align:center">ACK</td></tr><tr><td style="text-align:center">&lt;STX&gt; &lt;0x04&gt; &lt;0xFB&gt; &lt;Data[0-1023]&gt; &lt;CRC16&gt;</td><td style="text-align:center">---&gt;</td><td style="text-align:center">Packet OK</td></tr><tr><td style="text-align:center"></td><td style="text-align:center">&lt;---</td><td style="text-align:center">ACK</td></tr><tr><td style="text-align:center">&lt;SOH&gt; &lt;0x05&gt; &lt;0xFA&gt; &lt;Data[0-99]&gt; &lt;CPMEOF[0-27]&gt; &lt;CRC16&gt;</td><td style="text-align:center">---&gt;</td><td style="text-align:center">Packet OK</td></tr><tr><td style="text-align:center"></td><td style="text-align:center">&lt;---</td><td style="text-align:center">ACK</td></tr><tr><td style="text-align:center">EOT</td><td style="text-align:center">---&gt;</td><td style="text-align:center">Packet OK</td></tr><tr><td style="text-align:center"></td><td style="text-align:center">&lt;---</td><td style="text-align:center"><strong>NAK</strong></td></tr><tr><td style="text-align:center">EOT</td><td style="text-align:center">---&gt;</td><td style="text-align:center">Packet OK</td></tr><tr><td style="text-align:center"></td><td style="text-align:center">&lt;---</td><td style="text-align:center">ACK</td></tr><tr><td style="text-align:center"></td><td style="text-align:center">&lt;---</td><td style="text-align:center">'C'</td></tr><tr><td style="text-align:center">&lt;SOH&gt; &lt;0x00&gt; &lt;0xFF&gt; &lt;NUL[0-127]&gt; &lt;CRC16&gt;</td><td style="text-align:center">---&gt;</td><td style="text-align:center">Packet OK</td></tr><tr><td style="text-align:center">Finished</td><td style="text-align:center">&lt;---</td><td style="text-align:center">ACK</td></tr></tbody></table><h1 id="参考"><a class="anchor" href="#参考">#</a> 参考</h1><p><span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvWE1PREVN">https://en.wikipedia.org/wiki/XMODEM</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvWU1PREVN">https://en.wikipedia.org/wiki/YMODEM</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvWk1PREVN">https://en.wikipedia.org/wiki/ZMODEM</span></p><p><span class="exturl" data-url="aHR0cDovL3dlYi5jZWNzLnBkeC5lZHUvfnJvb3RkL2NhdGRvYy9ndWlkZS9UaGVHdWlkZV90b2MuaHRtbCNTRUMyMzc=">XMODEM, YMODEM, and ZMODEM</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9zbGlkZXBsYXllci5wbC9zbGlkZS80MzQ1NzIv">Transmisja modemowa - Xmodem, Ymodem, Zmodem</span></p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cub2hzZS5kZS91d2Uvc29mdHdhcmUvbHJ6c3ouaHRtbA==">lrzsz: free x/y/zmodem implementation</span></p><h1 id="附录"><a class="anchor" href="#附录">#</a> 附录</h1><p>CRC 校验计算：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">int</span> <span class="token function">calcrc</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">int</span>  crc<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">char</span> i<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    crc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>count <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        crc <span class="token operator">=</span> crc <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">*</span>ptr<span class="token operator">++</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        i <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">do</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>crc <span class="token operator">&amp;</span> <span class="token number">0x8000</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                crc <span class="token operator">=</span> crc <span class="token operator">&lt;&lt;</span> <span class="token number">1</span> <span class="token operator">^</span> <span class="token number">0x1021</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token keyword">else</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                crc <span class="token operator">=</span> crc <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">--</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span>crc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> history </tag>
            
            <tag> Modem </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Modbus家族之 ASCII</title>
      <link href="/docs/%E9%80%9A%E8%AE%AF%E5%8D%8F%E8%AE%AE/Modbus%E5%AE%B6%E6%97%8F%E4%B9%8B%20ASCII/"/>
      <url>/docs/%E9%80%9A%E8%AE%AF%E5%8D%8F%E8%AE%AE/Modbus%E5%AE%B6%E6%97%8F%E4%B9%8B%20ASCII/</url>
      
        <content type="html"><![CDATA[<blockquote><p>嗨，相信在上一篇经过我的兄弟 RTU 的介绍之后，已经对 Modbus 有了一定的了解了吧；那么本篇就跟紧我的脚步一起学习新的知识吧。</p></blockquote><h1 id="描述"><a class="anchor" href="#描述">#</a> 描述</h1><p>Modbus 在串行设备中通过实现主从模型结构，解决了电子设备之间的数据通讯问题；在采用 Modbus 协议时，它有两种主要的原始传输方式 ---- Modbus RTU 和 Modbus ASCII。而 Modbus RTU 已经在上一篇介绍了，那么就在本篇中瞅瞅 ASCII 吧。</p><h1 id="通讯方式"><a class="anchor" href="#通讯方式">#</a> 通讯方式</h1><h2 id="帧格式"><a class="anchor" href="#帧格式">#</a> 帧格式</h2><table><thead><tr><th style="text-align:center">Name</th><th style="text-align:center">Length (bytes)</th><th style="text-align:center">Description</th></tr></thead><tbody><tr><td style="text-align:center">Start</td><td style="text-align:center">1</td><td style="text-align:center">Starts with colon : (ASCII hex value is 3A)&lt;br/&gt;（以冒号  <code>:</code>  开头，ASCII 十六进制值为 3A）</td></tr><tr><td style="text-align:center">Address</td><td style="text-align:center">2</td><td style="text-align:center">Node address in hex&lt;br/&gt;（十六进制节点地址，字符表示）</td></tr><tr><td style="text-align:center">Function</td><td style="text-align:center">2</td><td style="text-align:center">Function code in hex&lt;br/&gt;（十六进制功能码，字符表示）</td></tr><tr><td style="text-align:center">Data</td><td style="text-align:center">n x 2</td><td style="text-align:center">n is the number of data bytes, it depends on function&lt;br/&gt;（n 是数据字节数，它取决于功能码）</td></tr><tr><td style="text-align:center">LRC</td><td style="text-align:center">2</td><td style="text-align:center">Longitudinal redundancy check&lt;br/&gt;（LRC 校验码）</td></tr><tr><td style="text-align:center">End</td><td style="text-align:center">2</td><td style="text-align:center">CR / LF</td></tr></tbody></table><p>注：地址、功能、数据和 LRC 都是表示 8 位值 (0-255) 的<strong>大写</strong>十六进制可读字符对；即：在 Modbus ASCII 中，每个数据字节被分割成表示十六进制值中的两个 ASCII 字符的两个字节。</p><p>在 ASCII 模式下，消息以冒号  <code>:</code>  字符开头（ASCII 表示为 0x3A），以回车换行对  <code>\r\n</code>  （ASCII 表示为 0x0D 和 0x0A）结尾；所有其他字段传输的数据所允许的十六进制表示字符为的  <code>0-9</code> 、 <code>A-F</code> 。</p><table><thead><tr><th style="text-align:center">START</th><th style="text-align:center">ADDRESS</th><th style="text-align:center">FUNCTION</th><th style="text-align:center">DATA</th><th style="text-align:center">LRC CHECK</th><th style="text-align:center">END</th></tr></thead><tbody><tr><td style="text-align:center">1 CHAR&lt;br/&gt;:</td><td style="text-align:center">2 CHARS</td><td style="text-align:center">2 CHARS</td><td style="text-align:center">n CHARS</td><td style="text-align:center">2 CHARS</td><td style="text-align:center">2 CHARS&lt;br/&gt;CRLF</td></tr></tbody></table><p><img data-src="image-20220326235527004.png" alt="image-20220326235527004" /></p><h2 id="功能码"><a class="anchor" href="#功能码">#</a> 功能码</h2><p>ASCII 最常用的功能代码跟 RTU 的功能代码定义是一样的，这里就不多说了，可以去查看 《<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQyOTkyMDg0L2FydGljbGUvZGV0YWlscy8xMjM2MDU5MTI=">Modbus 家族之 RTU</span>》篇章的功能码部分，这里只是格式上有所不同而已，<s>下一篇会对这两个原始传输方式进行对比的。</s> 嘛，还是直接合并到本篇，对 RTU 和 ASCII 进行对比分析吧，顺便回顾一下 RTU 协议。</p><table><thead><tr><th style="text-align:center">访问地址：address</th><th style="text-align:center">映射地址</th><th style="text-align:center">描述</th><th style="text-align:center">功能</th><th style="text-align:center">R/W</th></tr></thead><tbody><tr><td style="text-align:center">1 ~ 10000</td><td style="text-align:center">address-1</td><td style="text-align:center">Coils</td><td style="text-align:center">01/05/15</td><td style="text-align:center">R/W</td></tr><tr><td style="text-align:center">10001 ~ 20000</td><td style="text-align:center">address-10001</td><td style="text-align:center">Discrete Inputs</td><td style="text-align:center">02</td><td style="text-align:center">R</td></tr><tr><td style="text-align:center">30001 ~ 40000</td><td style="text-align:center">address-30001</td><td style="text-align:center">Input Registers</td><td style="text-align:center">04</td><td style="text-align:center">R</td></tr><tr><td style="text-align:center">40001 ~ 50000</td><td style="text-align:center">address-40001</td><td style="text-align:center">Holding Registers</td><td style="text-align:center">03/06/16</td><td style="text-align:center">R/W</td></tr></tbody></table><p>在这里，简单的举个 ASCII 传输例子：</p><p>例如，要读取 VAR1，你需要从地址 0x20C1 读取 2 个寄存器，所以你需要发送以下 ASCII 消息：</p><p><code>:010420C1000218&lt;CRLF&gt;</code></p><ul><li><p>请求：</p><table><thead><tr><th style="text-align:center">Name</th><th style="text-align:center">Description</th></tr></thead><tbody><tr><td style="text-align:center">‘:’</td><td style="text-align:center">Start of message - 0x3A</td></tr><tr><td style="text-align:center">‘0’ ‘1’</td><td style="text-align:center">Node address – 0x01</td></tr><tr><td style="text-align:center">‘0’ ‘4’</td><td style="text-align:center">Function code (Read Input Registers) – 0x04</td></tr><tr><td style="text-align:center">‘2’ ‘0’ ‘C’ ‘1’</td><td style="text-align:center">Register address for reading VAR1 – 0x20C1</td></tr><tr><td style="text-align:center">‘0’ ‘0’ ‘0’ ‘2’</td><td style="text-align:center">Length of registers to be read (must be 2) – 0x0002</td></tr><tr><td style="text-align:center">‘1’ ‘8’</td><td style="text-align:center">LRC</td></tr><tr><td style="text-align:center">&lt;CRLF&gt;</td><td style="text-align:center">End of message, carriage return and line feed – 0x0D0A</td></tr></tbody></table></li></ul><p>此消息的响应如下：</p><p><code>:01040400001234B1&lt;CRLF&gt;</code></p><ul><li><p>响应：</p><table><thead><tr><th style="text-align:center">Name</th><th style="text-align:center">Description</th></tr></thead><tbody><tr><td style="text-align:center">‘:’</td><td style="text-align:center">Start of message - 0x3A</td></tr><tr><td style="text-align:center">‘0’ ‘1’</td><td style="text-align:center">Node address – 0x01</td></tr><tr><td style="text-align:center">‘0’ ‘4’</td><td style="text-align:center">Function code (Read Input Registers) – 0x04</td></tr><tr><td style="text-align:center">‘0’ ‘4’</td><td style="text-align:center">Read data length (4 bytes) – 0x04</td></tr><tr><td style="text-align:center">‘0’ ‘0’ ‘0’ ‘0’ ‘1’ ‘2’ ‘3’ ‘4’</td><td style="text-align:center">Value read from VAR1 – 0x00001234</td></tr><tr><td style="text-align:center">‘B’ ‘1’</td><td style="text-align:center">LRC</td></tr><tr><td style="text-align:center">&lt;CRLF&gt;</td><td style="text-align:center">End of message, carriage return and line feed – 0x0D0A</td></tr></tbody></table></li></ul><p>好了，那么就直入主题吧，常用功能码部分依然是如下几个：</p><h3 id="功能-0101h读线圈"><a class="anchor" href="#功能-0101h读线圈">#</a> 功能 01（01H）读线圈</h3><ul><li><p>请求</p><p>读取从机中线圈的 ON/OFF 状态。不支持广播。请求消息指定了开始线圈和要读取的线圈数量。</p><p>下面是一个请求读取线圈的例子：19 - 55（Coil 20 to 56），37 个线圈，从设备节点 3（注意起始地址是 19 或 0x13，比线圈 20 小 1）：</p><p><img data-src="image-20220327151916968.png" alt="image-20220327151916968" /></p></li><li><p>响应</p><p>线圈状态响应消息被打包为数据字段的每比特表示一个线圈。状态表示为：1 = ON，0 = OFF。第一个数据字节的 LSB 包含请求中寻址的线圈。其他线圈跟随这个字节的高阶末端，并在随后的字节中从低阶到高阶。</p><p>例如，当线圈 20 - 27 的状态显示  <code>ON - ON - OFF - OFF - ON - OFF - ON - OFF - ON - OFF</code>  时，以字节值二进制  <code>0101 0011 (0x53)</code>  表示。一个字节包含八个线圈的状态。如果返回的线圈数量不是 8 的倍数，则最终数据字节中的剩余位将用 0 填充 (朝向字节的高阶末端)；字节计数字段指定数据的完整字节数。</p><blockquote><p>Figure 6 shows an example of a response to the query shown in Figure 5：</p></blockquote><p><img data-src="image-20220327152253123.png" alt="image-20220327152253123" /></p></li></ul><h3 id="功能-0202h读离散输入"><a class="anchor" href="#功能-0202h读离散输入">#</a> 功能 02（02H）读离散输入</h3><ul><li><p>请求</p><p>读取从机中离散输入的 ON/OFF 状态。不支持广播。请求消息指定起始输入和要读取的输入数量。</p><p>下面是一个从从设备节点 3 读取离散输入 10101 - 10120，总共 20 个输入的例子（注意起始地址是 100 或 0x64，比输入 10101 小 10001）：</p><p><img data-src="image-20220327155421391.png" alt="image-20220327155421391" /></p></li><li><p>响应</p><p>离散输入状态响应消息的构造与线圈状态 (01H) 操作相同。</p><blockquote><p>Figure 8 shows an example of a response to the query shown in Figure 7：</p></blockquote><p><img data-src="image-20220327155851480.png" alt="image-20220327155851480" /></p></li></ul><h3 id="功能-0303h读保持寄存器"><a class="anchor" href="#功能-0303h读保持寄存器">#</a> 功能 03（03H）读保持寄存器</h3><ul><li><p>请求</p><p>读取从机中保持寄存器的二进制内容。不支持广播。请求消息指定起始寄存器和要读取的寄存器数量。</p><p>下面是一个从从设备节点 7 读取保持寄存器 40201 - 40203，总共 3 个寄存器的请求的例子（注意起始地址是 200 或 0xC8，比寄存器 40201 小 40001）：</p><p><img data-src="image-20220327160332698.png" alt="image-20220327160332698" /></p></li><li><p>响应</p><p>响应消息中的保持寄存器数据在每个寄存器中打包为两个字节，二进制内容在每个字节中右对齐；对于每个寄存器，第一个字节包含高阶位，第二个字节包含低阶位。</p><blockquote><p>Figure 10 shows an example of a response to the query shown in Figure 9：</p></blockquote><p><img data-src="image-20220327160607639.png" alt="image-20220327160607639" /></p></li></ul><h3 id="功能-0404h读输入寄存器"><a class="anchor" href="#功能-0404h读输入寄存器">#</a> 功能 04（04H）读输入寄存器</h3><ul><li><p>请求</p><p>读取从机中保持寄存器的二进制内容。不支持广播。请求消息指定起始寄存器和要读取的寄存器数量。</p><p>下面是一个从从设备节点 7 读取输入寄存器 30301 - 30303，总共 3 个寄存器的请求的例子（注意起始地址是 300 或 0x12C，比寄存器 30301 小 30001）：</p><p><img data-src="image-20220327171629490.png" alt="image-20220327171629490" /></p></li><li><p>响应</p><p>读输入寄存器数据的响应消息的构造与读取保持寄存器 (03H) 操作相同。</p><blockquote><p>Figure 12 shows an example of a response to the query shown in Figure 11：</p></blockquote><p><img data-src="image-20220327171942458.png" alt="image-20220327171942458" /></p></li></ul><h3 id="功能-0505h写单线圈"><a class="anchor" href="#功能-0505h写单线圈">#</a> 功能 05（05H）写单线圈</h3><ul><li><p>请求</p><p>将单个线圈写入 ON 或 OFF。当广播时，该函数强制所有附加的从机使用相同的线圈引用。请求消息指定要写入的线圈引用（启动线圈和状态）。</p><p><code>FF 00</code>  的值要求线圈打开，值为  <code>00 00</code>  的请求为关闭，所有其他值都是非法的，不会影响线圈。</p><p>下面是一个在从设备节点 3 中请求打开线圈 150 的例子（注意起始地址是 149 或 0x95，比线圈 150 小 1）：</p><p><img data-src="image-20220327172937327.png" alt="image-20220327172937327" /></p></li><li><p>响应</p><p>正常的响应是请求的回显，在写入线圈状态之后返回。</p><blockquote><p>Figure 14 shows an example of a response to the query shown in Figure 13：</p></blockquote><p><img data-src="image-20220327173100544.png" alt="image-20220327173100544" /></p></li></ul><h3 id="功能-0606h写单个保持寄存器"><a class="anchor" href="#功能-0606h写单个保持寄存器">#</a> 功能 06（06H）写单个保持寄存器</h3><ul><li><p>请求</p><p>将一个值写入单个保持寄存器中。当广播时，该函数在所有附加的从机上设置相同的寄存器引用。请求消息指定要写入的寄存器引用（指定地址和数值）。</p><p>下面是一个请求从从设备节点 3 中的保持寄存器 40150 写入 1000 数值的例子（注意起始地址为 149 或 0x95，比寄存器 40150 小 40001）：</p><p><img data-src="image-20220327175033869.png" alt="image-20220327175033869" /></p></li><li><p>响应</p><p>正常的响应是请求的回显，在写入保持寄存器内容之后返回。</p><blockquote><p>Figure 16 shows an example of a response to the query shown in Figure 15：</p></blockquote><p><img data-src="image-20220327175344005.png" alt="image-20220327175344005" /></p></li></ul><h3 id="功能-150fh写多个线圈"><a class="anchor" href="#功能-150fh写多个线圈">#</a> 功能 15（0FH）写多个线圈</h3><ul><li><p>请求</p><p>将一个线圈序列中的每个线圈写入 ON 或 OFF。当广播时，该函数强制所有附加的从机使用相同的线圈引用。请求消息指定要写入的线圈引用（起始线圈和状态）。</p><p>下面的示例显示了从设备节点 5 中的线圈 20 开始写入一系列 10 个线圈状态的请求。二进制位与线圈的对应方式如下（注意起始地址是 19 或 0x13，比线圈 20 小 1）：</p><table><thead><tr><th>Bit</th><th>1</th><th>1</th><th>0</th><th>1</th><th>0</th><th>0</th><th>0</th><th>1</th><th>0</th><th>0</th><th>0</th><th>0</th><th>0</th><th>1</th><th>0</th><th>1</th></tr></thead><tbody><tr><td>Coil</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>30</td><td>29</td><td>28</td></tr></tbody></table><p><img data-src="image-20220327182406708.png" alt="image-20220327182406708" /></p></li><li><p>响应</p><p>正常响应返回从地址、功能代码、起始地址和写入的线圈数量，不包括字节数和对应写入的状态。</p><blockquote><p>Figure 24 shows an example of a response to the query shown in Figure 23：</p></blockquote><p><img data-src="image-20220327182618637.png" alt="image-20220327182618637" /></p></li></ul><h3 id="功能-1610h写多个保持寄存器"><a class="anchor" href="#功能-1610h写多个保持寄存器">#</a> 功能 16（10H）写多个保持寄存器</h3><ul><li><p>请求</p><p>将值写入到一个保持寄存器序列中。当广播时，该函数在所有附加的从机上设置相同的寄存器引用。请求消息指定要写入的寄存器引用（起始寄存器和数值）。</p><p>下面是一个请求从从设备节点 5 中的保持寄存器 40020 到 40022 写入以下数据的示例（注意起始地址是 19 或 0x13，比寄存器 40020 小 40001）：</p><table><thead><tr><th>address</th><th>data</th></tr></thead><tbody><tr><td>40020</td><td>0x0164</td></tr><tr><td>40021</td><td>0x0165</td></tr><tr><td>40022</td><td>0x0166</td></tr></tbody></table><p><img data-src="image-20220327184941057.png" alt="image-20220327184941057" /></p></li><li><p>响应</p><p>正常响应返回从地址、功能代码、起始地址和写入的寄存器数量，不包括字节数和对应写入的数据。</p><blockquote><p>Figure 26 shows an example of a response to the query shown in Figure 25：</p></blockquote><p><img data-src="image-20220327185223421.png" alt="image-20220327185223421" /></p></li></ul><h2 id="lrc校验"><a class="anchor" href="#lrc校验">#</a> LRC 校验</h2><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">unsigned</span> <span class="token keyword">char</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">ucMBLRC</span><span class="token punctuation">(</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span> pucFrame<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> usLen <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> ucLRC <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">/* LRC char initialized */</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span> usLen<span class="token operator">--</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        ucLRC <span class="token operator">+=</span> <span class="token operator">*</span>pucFrame<span class="token operator">++</span><span class="token punctuation">;</span>   <span class="token comment">/* Add buffer byte without carry */</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">/* Return twos complement */</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    ucLRC <span class="token operator">=</span> <span class="token punctuation">(</span> UCHAR <span class="token punctuation">)</span> <span class="token punctuation">(</span> <span class="token operator">-</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> CHAR <span class="token punctuation">)</span> ucLRC <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">return</span> ucLRC<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>校验原理可看 <span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQyOTkyMDg0L2FydGljbGUvZGV0YWlscy8xMTY0NjYwMjk=">常用校验算法</span> - LRC 章节</p>]]></content>
      
      
      <categories>
          
          <category> modbus </category>
          
      </categories>
      
      
        <tags>
            
            <tag> history </tag>
            
            <tag> modbus </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Modbus家族之 RTU</title>
      <link href="/docs/%E9%80%9A%E8%AE%AF%E5%8D%8F%E8%AE%AE/Modbus%E5%AE%B6%E6%97%8F%E4%B9%8B%20RTU/"/>
      <url>/docs/%E9%80%9A%E8%AE%AF%E5%8D%8F%E8%AE%AE/Modbus%E5%AE%B6%E6%97%8F%E4%B9%8B%20RTU/</url>
      
        <content type="html"><![CDATA[<blockquote><p>您好啊，我是 Modbus 家族成员的 RTU，同时期诞生的还有我的兄弟，它就是 ASCII。本篇呢就来让大家熟悉一下我吧，下一篇则由我兄弟 ASCII 进行介绍。好了，废话不多说，接下来就带你们来认识一下我吧。</p></blockquote><h1 id="描述"><a class="anchor" href="#描述">#</a> 描述</h1><p>Modbus RTU（远程终端单元）是原始 Modbus 规范中定义的两种传输模式之一。 这两种模式是 Modbus RTU 和 ASCII，它们被设计用于支持 RS232，RS485 和 RS422 接口的串行设备。 Modbus RTU 的一个显着特点是它使用二进制编码和强大的 CRC 错误检查。 Modbus RTU 是 Modbus 协议的实现，最常用于工业应用和自动化生产设施。嘻嘻，我可是很受工业场景应用的哦。</p><h1 id="通讯方式"><a class="anchor" href="#通讯方式">#</a> 通讯方式</h1><h2 id="帧格式"><a class="anchor" href="#帧格式">#</a> 帧格式</h2><table><thead><tr><th style="text-align:center">Name</th><th style="text-align:center">Length (bytes)</th><th style="text-align:center">Description</th></tr></thead><tbody><tr><td style="text-align:center">Address</td><td style="text-align:center">1</td><td style="text-align:center">Node address（节点地址）</td></tr><tr><td style="text-align:center">Function</td><td style="text-align:center">1</td><td style="text-align:center">Function code（功能代码）</td></tr><tr><td style="text-align:center">Data</td><td style="text-align:center">n</td><td style="text-align:center">n is the number of data bytes, it depends on function&lt;br/&gt;（n 是数据字节数，它取决于功能码）</td></tr><tr><td style="text-align:center">CRC</td><td style="text-align:center">2</td><td style="text-align:center">Cyclic redundancy check&lt;br/&gt;（CRC 校验码）</td></tr></tbody></table><p>在 RTU 模式下，消息以至少 3.5 个字符的静默间隔为开始，以至少 3.5 个字符的类似间隔结束。这是最容易实现的以波特率在网络上使用的字符次数的倍数 (如下图中所示的 T1 - T2 - T3 - T4)。</p><table><thead><tr><th>START</th><th>ADDRESS</th><th>FUNCTION</th><th>DATA</th><th>CRC CHECK</th><th>END</th></tr></thead><tbody><tr><td><strong>*T1–T2–T3–T4</strong></td><td>8 BITS</td><td>8 BITS</td><td>n x 8 BITS</td><td>16 BITS</td><td><strong>*T1–T2–T3–T4</strong></td></tr></tbody></table><p><strong>*T1-T2-T3-T4</strong>：表示不通信时的 3.5 个字符。</p><p>所有其他字段都由 8 位数据组成。</p><p><img data-src="image-20220319201759692.png" alt="image-20220319201759692" /></p><h2 id="功能码"><a class="anchor" href="#功能码">#</a> 功能码</h2><p>Modbus 设备最常用的功能代码如下表所示：</p><p><img data-src="image-20220319195917761.png" alt="image-20220319195917761" /></p><h3 id="功能-0101h读线圈"><a class="anchor" href="#功能-0101h读线圈">#</a> 功能 01（01H）读线圈</h3><ul><li><p>请求：</p><table><thead><tr><th>名称</th><th>长度</th><th>说明</th></tr></thead><tbody><tr><td>设备地址</td><td>1 字节</td><td></td></tr><tr><td>功能码</td><td>1 字节</td><td><strong>0x01</strong></td></tr><tr><td>开始地址</td><td>2 字节</td><td>0x0000 to 0xFFFF</td></tr><tr><td>线圈数量</td><td>2 字节</td><td>1 to 2000 (0x7D0)</td></tr><tr><td>CRC 校验码</td><td>2 字节</td><td></td></tr></tbody></table><p>指令：设备地址（1byte）+ <strong>0x01</strong>（1byte）+ 起始地址（2byte）+ 线圈数（2byte）+ CRC（2byte）</p></li><li><p>应答：</p><table><thead><tr><th>名称</th><th>长度</th><th>说明</th></tr></thead><tbody><tr><td>设备地址</td><td>1 字节</td><td></td></tr><tr><td>功能码</td><td>1 字节</td><td><strong>0x01</strong></td></tr><tr><td>线圈数量对应的字节数</td><td>1 字节</td><td><strong>*N</strong></td></tr><tr><td>线圈数据 1</td><td>1 字节</td><td></td></tr><tr><td>线圈数据 2</td><td>1 字节</td><td></td></tr><tr><td>线圈数据 n</td><td>1 字节</td><td>n = N or N+1</td></tr><tr><td>CRC 校验码</td><td>2 字节</td><td></td></tr></tbody></table><p><strong>*N</strong> = 线圈数量 / 8，如果余数非 0，则 N = N+1</p><p>指令：设备地址（1byte）+ <strong>0x01</strong>（1byte）+ 字节数（1byte）+ 线圈状态（Nbyte）+ CRC（2byte）</p></li><li><p>错误返回：</p><table><thead><tr><th>名称</th><th>长度</th><th>说明</th></tr></thead><tbody><tr><td>设备地址</td><td>1 字节</td><td></td></tr><tr><td>功能码</td><td>1 字节</td><td><strong>0x81</strong></td></tr><tr><td>错误码</td><td>1 字节</td><td>01 or 02 or 03 or 04</td></tr><tr><td>CRC 校验码</td><td>2 字节</td><td></td></tr></tbody></table></li></ul><p><strong>流程图：</strong></p><p><img data-src="image-20220319211327513.png" alt="image-20220319211327513" /></p><h3 id="功能-0202h读离散输入"><a class="anchor" href="#功能-0202h读离散输入">#</a> 功能 02（02H）读离散输入</h3><ul><li><p>请求：</p><table><thead><tr><th>名称</th><th>长度</th><th>说明</th></tr></thead><tbody><tr><td>设备地址</td><td>1 字节</td><td></td></tr><tr><td>功能码</td><td>1 字节</td><td><strong>0x02</strong></td></tr><tr><td>开始地址</td><td>2 字节</td><td>0x0000 to 0xFFFF</td></tr><tr><td>离散状态数量</td><td>2 字节</td><td>1 to 2000 (0x7D0)</td></tr><tr><td>CRC 校验码</td><td>2 字节</td><td></td></tr></tbody></table><p>指令：设备地址（1byte）+ <strong>0x02</strong>（1byte）+ 起始地址（2byte）+ 离散数（2byte）+ CRC（2byte）</p></li><li><p>应答：</p><table><thead><tr><th>名称</th><th>长度</th><th>说明</th></tr></thead><tbody><tr><td>设备地址</td><td>1 字节</td><td></td></tr><tr><td>功能码</td><td>1 字节</td><td><strong>0x02</strong></td></tr><tr><td>离散状态数量对应的字节数</td><td>1 字节</td><td><strong>*N</strong></td></tr><tr><td>离散数据 1</td><td>1 字节</td><td></td></tr><tr><td>离散数据 2</td><td>1 字节</td><td></td></tr><tr><td>离散数据 n</td><td>1 字节</td><td>n = N or N+1</td></tr><tr><td>CRC 校验码</td><td>2 字节</td><td></td></tr></tbody></table><p><strong>*N</strong> = 离散状态数量 / 8，如果余数非 0，则 N = N+1</p><p>指令：设备地址（1byte）+ <strong>0x01</strong>（1byte）+ 字节数（1byte）+ 离散状态（Nbyte）+ CRC（2byte）</p></li><li><p>错误返回：</p><table><thead><tr><th>名称</th><th>长度</th><th>说明</th></tr></thead><tbody><tr><td>设备地址</td><td>1 字节</td><td></td></tr><tr><td>功能码</td><td>1 字节</td><td><strong>0x82</strong></td></tr><tr><td>错误码</td><td>1 字节</td><td>01 or 02 or 03 or 04</td></tr><tr><td>CRC 校验码</td><td>2 字节</td><td></td></tr></tbody></table></li></ul><p><strong>流程图：</strong></p><p><img data-src="image-20220319212623922.png" alt="image-20220319212623922" /></p><h3 id="功能-0303h读保持寄存器"><a class="anchor" href="#功能-0303h读保持寄存器">#</a> 功能 03（03H）读保持寄存器</h3><ul><li><p>请求：</p><table><thead><tr><th>名称</th><th>长度</th><th>说明</th></tr></thead><tbody><tr><td>设备地址</td><td>1 字节</td><td></td></tr><tr><td>功能码</td><td>1 字节</td><td><strong>0x03</strong></td></tr><tr><td>开始地址</td><td>2 字节</td><td>0x0000 to 0xFFFF</td></tr><tr><td>保持寄存器数量</td><td>2 字节</td><td>1 to 125 (0x7D)</td></tr><tr><td>CRC 校验码</td><td>2 字节</td><td></td></tr></tbody></table><p>指令：设备地址（1byte）+ <strong>0x03</strong>（1byte）+ 起始地址（2byte）+ 保持寄存器数（2byte）+ CRC（2byte）</p></li><li><p>应答：</p><table><thead><tr><th>名称</th><th>长度</th><th>说明</th></tr></thead><tbody><tr><td>设备地址</td><td>1 字节</td><td></td></tr><tr><td>功能码</td><td>1 字节</td><td><strong>0x03</strong></td></tr><tr><td>保持寄存器数量对应的字节数</td><td>1 字节</td><td>2 * N</td></tr><tr><td>寄存器数值 1</td><td>2 字节</td><td></td></tr><tr><td>寄存器数值 2</td><td>2 字节</td><td></td></tr><tr><td>寄存器数值 n</td><td>2 字节</td><td>n = N</td></tr><tr><td>CRC 校验码</td><td>2 字节</td><td></td></tr></tbody></table><p>指令：设备地址（1byte）+ <strong>0x03</strong>（1byte）+ 字节数（1byte）+ 保持寄存器值（2 * Nbyte）+ CRC（2byte）</p></li><li><p>错误返回：</p><table><thead><tr><th>名称</th><th>长度</th><th>说明</th></tr></thead><tbody><tr><td>设备地址</td><td>1 字节</td><td></td></tr><tr><td>功能码</td><td>1 字节</td><td><strong>0x83</strong></td></tr><tr><td>错误码</td><td>1 字节</td><td>01 or 02 or 03 or 04</td></tr><tr><td>CRC 校验码</td><td>2 字节</td><td></td></tr></tbody></table></li></ul><p><strong>流程图：</strong></p><p><img data-src="image-20220319213419588.png" alt="image-20220319213419588" /></p><h3 id="功能-0404h读输入寄存器"><a class="anchor" href="#功能-0404h读输入寄存器">#</a> 功能 04（04H）读输入寄存器</h3><ul><li><p>请求：</p><table><thead><tr><th>名称</th><th>长度</th><th>说明</th></tr></thead><tbody><tr><td>设备地址</td><td>1 字节</td><td></td></tr><tr><td>功能码</td><td>1 字节</td><td><strong>0x04</strong></td></tr><tr><td>开始地址</td><td>2 字节</td><td>0x0000 to 0xFFFF</td></tr><tr><td>输入寄存器数量</td><td>2 字节</td><td>1 to 125 (0x7D)</td></tr><tr><td>CRC 校验码</td><td>2 字节</td><td></td></tr></tbody></table><p>指令：设备地址（1byte）+ <strong>0x04</strong>（1byte）+ 起始地址（2byte）+ 输入寄存器数（2byte）+ CRC（2byte）</p></li><li><p>应答：</p><table><thead><tr><th>名称</th><th>长度</th><th>说明</th></tr></thead><tbody><tr><td>设备地址</td><td>1 字节</td><td></td></tr><tr><td>功能码</td><td>1 字节</td><td><strong>0x04</strong></td></tr><tr><td>保持寄存器数量对应的字节数</td><td>1 字节</td><td>2 * N</td></tr><tr><td>寄存器数值 1</td><td>2 字节</td><td></td></tr><tr><td>寄存器数值 2</td><td>2 字节</td><td></td></tr><tr><td>寄存器数值 n</td><td>2 字节</td><td>n = N</td></tr><tr><td>CRC 校验码</td><td>2 字节</td><td></td></tr></tbody></table><p>指令：设备地址（1byte）+ <strong>0x04</strong>（1byte）+ 字节数（1byte）+ 输入寄存器值（2 * Nbyte）+ CRC（2byte）</p></li><li><p>错误返回：</p><table><thead><tr><th>名称</th><th>长度</th><th>说明</th></tr></thead><tbody><tr><td>设备地址</td><td>1 字节</td><td></td></tr><tr><td>功能码</td><td>1 字节</td><td><strong>0x84</strong></td></tr><tr><td>错误码</td><td>1 字节</td><td>01 or 02 or 03 or 04</td></tr><tr><td>CRC 校验码</td><td>2 字节</td><td></td></tr></tbody></table></li></ul><p><strong>流程图：</strong></p><p><img data-src="image-20220319214513539.png" alt="image-20220319214513539" /></p><h3 id="功能-0505h写单线圈"><a class="anchor" href="#功能-0505h写单线圈">#</a> 功能 05（05H）写单线圈</h3><ul><li><p>请求：</p><table><thead><tr><th>名称</th><th>长度</th><th>说明</th></tr></thead><tbody><tr><td>设备地址</td><td>1 字节</td><td></td></tr><tr><td>功能码</td><td>1 字节</td><td><strong>0x05</strong></td></tr><tr><td>输出地址</td><td>2 字节</td><td>0x0000 to 0xFFFF</td></tr><tr><td><strong>* 线圈数值</strong></td><td>2 字节</td><td>0x0000 or 0xFF00</td></tr><tr><td>CRC 校验码</td><td>2 字节</td><td></td></tr></tbody></table><p>*<strong> 线圈数值</strong> ：0xFF00 -&gt; 请求线圈状态为 ON</p><p>​0x0000 -&gt; 请求线圈状态为 OFF</p><p>​其他值 -&gt; 非法且对线圈不起作用</p><p>指令：设备地址（1byte）+ <strong>0x05</strong>（1byte）+ 输出地址（2byte）+ 线圈值（2byte）+ CRC（2byte）</p></li><li><p>应答：</p><table><thead><tr><th>名称</th><th>长度</th><th>说明</th></tr></thead><tbody><tr><td>设备地址</td><td>1 字节</td><td></td></tr><tr><td>功能码</td><td>1 字节</td><td><strong>0x05</strong></td></tr><tr><td>输出地址</td><td>2 字节</td><td>0x0000 to 0xFFFF</td></tr><tr><td>线圈数值</td><td>2 字节</td><td>0x0000 or 0xFF00</td></tr><tr><td>CRC 校验码</td><td>2 字节</td><td></td></tr></tbody></table><p>指令：正常响应是请求的应答</p></li><li><p>错误返回：</p><table><thead><tr><th>名称</th><th>长度</th><th>说明</th></tr></thead><tbody><tr><td>设备地址</td><td>1 字节</td><td></td></tr><tr><td>功能码</td><td>1 字节</td><td><strong>0x85</strong></td></tr><tr><td>错误码</td><td>1 字节</td><td>01 or 02 or 03 or 04</td></tr><tr><td>CRC 校验码</td><td>2 字节</td><td></td></tr></tbody></table></li></ul><p><strong>流程图：</strong></p><p><img data-src="image-20220319215633462.png" alt="image-20220319215633462" /></p><h3 id="功能-0606h写单个保持寄存器"><a class="anchor" href="#功能-0606h写单个保持寄存器">#</a> 功能 06（06H）写单个保持寄存器</h3><ul><li><p>请求：</p><table><thead><tr><th>名称</th><th>长度</th><th>说明</th></tr></thead><tbody><tr><td>设备地址</td><td>1 字节</td><td></td></tr><tr><td>功能码</td><td>1 字节</td><td><strong>0x06</strong></td></tr><tr><td>寄存器地址</td><td>2 字节</td><td>0x0000 to 0xFFFF</td></tr><tr><td>寄存器数值</td><td>2 字节</td><td>0x0000 to 0xFFFF</td></tr><tr><td>CRC 校验码</td><td>2 字节</td><td></td></tr></tbody></table><p>指令：设备地址（1byte）+ <strong>0x06</strong>（1byte）+ 保持寄存器地址（2byte）+ 保持寄存器值（2byte）+ CRC（2byte）</p></li><li><p>应答：</p><table><thead><tr><th>名称</th><th>长度</th><th>说明</th></tr></thead><tbody><tr><td>设备地址</td><td>1 字节</td><td></td></tr><tr><td>功能码</td><td>1 字节</td><td><strong>0x06</strong></td></tr><tr><td>寄存器地址</td><td>2 字节</td><td>0x0000 to 0xFFFF</td></tr><tr><td>寄存器数值</td><td>2 字节</td><td>0x0000 to 0xFFFF</td></tr><tr><td>CRC 校验码</td><td>2 字节</td><td></td></tr></tbody></table><p>指令：正常响应是请求的应答</p></li><li><p>错误返回：</p><table><thead><tr><th>名称</th><th>长度</th><th>说明</th></tr></thead><tbody><tr><td>设备地址</td><td>1 字节</td><td></td></tr><tr><td>功能码</td><td>1 字节</td><td><strong>0x86</strong></td></tr><tr><td>错误码</td><td>1 字节</td><td>01 or 02 or 03 or 04</td></tr><tr><td>CRC 校验码</td><td>2 字节</td><td></td></tr></tbody></table></li></ul><p><strong>流程图：</strong></p><p><img data-src="image-20220319220604204.png" alt="image-20220319220604204" /></p><h3 id="功能-150fh写多个线圈"><a class="anchor" href="#功能-150fh写多个线圈">#</a> 功能 15（0FH）写多个线圈</h3><ul><li><p>请求：</p><table><thead><tr><th>名称</th><th>长度</th><th>说明</th></tr></thead><tbody><tr><td>设备地址</td><td>1 字节</td><td></td></tr><tr><td>功能码</td><td>1 字节</td><td><strong>0x0F</strong></td></tr><tr><td>开始地址</td><td>2 字节</td><td>0x0000 to 0xFFFF</td></tr><tr><td>线圈输出数量</td><td>2 字节</td><td>1 to 1968 (0x7B0)</td></tr><tr><td>线圈数量对应的字节数</td><td>1 字节</td><td><strong>*N</strong></td></tr><tr><td>线圈输出数据 1</td><td>1 字节</td><td></td></tr><tr><td>线圈输出数据 2</td><td>1 字节</td><td></td></tr><tr><td>线圈输出数据 n</td><td>1 字节</td><td>n = N or N+1</td></tr><tr><td>CRC 校验码</td><td>2 字节</td><td></td></tr></tbody></table><p><strong>*N</strong> = 线圈输出数量 / 8，如果余数非 0，则 N = N+1</p><p>指令：设备地址（1byte）+ <strong>0x0F</strong>（1byte）+ 起始地址（2byte）+ 线圈输出数（2byte）+ 字节数（1byte）+ 线圈输出数据（Nbyte）+ CRC（2byte）</p></li><li><p>应答：</p><table><thead><tr><th>名称</th><th>长度</th><th>说明</th></tr></thead><tbody><tr><td>设备地址</td><td>1 字节</td><td></td></tr><tr><td>功能码</td><td>1 字节</td><td><strong>0x0F</strong></td></tr><tr><td>开始地址</td><td>2 字节</td><td>0x0000 to 0xFFFF</td></tr><tr><td>线圈输出数量</td><td>2 字节</td><td>1 to 1968 (0x7B0)</td></tr><tr><td>CRC 校验码</td><td>2 字节</td><td></td></tr></tbody></table><p>指令：设备地址（1byte）+ <strong>0x0F</strong>（1byte）+ 起始地址（2byte）+ 线圈输出数（2byte）+ CRC（2byte）</p></li><li><p>错误返回：</p><table><thead><tr><th>名称</th><th>长度</th><th>说明</th></tr></thead><tbody><tr><td>设备地址</td><td>1 字节</td><td></td></tr><tr><td>功能码</td><td>1 字节</td><td><strong>0x8F</strong></td></tr><tr><td>错误码</td><td>1 字节</td><td>01 or 02 or 03 or 04</td></tr><tr><td>CRC 校验码</td><td>2 字节</td><td></td></tr></tbody></table></li></ul><p><strong>流程图：</strong></p><p><img data-src="image-20220319223636555.png" alt="image-20220319223636555" /></p><h3 id="功能-1610h写多个保持寄存器"><a class="anchor" href="#功能-1610h写多个保持寄存器">#</a> 功能 16（10H）写多个保持寄存器</h3><ul><li><p>请求：</p><table><thead><tr><th>名称</th><th>长度</th><th>说明</th></tr></thead><tbody><tr><td>设备地址</td><td>1 字节</td><td></td></tr><tr><td>功能码</td><td>1 字节</td><td><strong>0x10</strong></td></tr><tr><td>开始地址</td><td>2 字节</td><td>0x0000 to 0xFFFF</td></tr><tr><td>寄存器数量</td><td>2 字节</td><td>1 to 123 (0x7B)</td></tr><tr><td>寄存器数量对应的字节数</td><td>1 字节</td><td>2 * N</td></tr><tr><td>寄存器数值 1</td><td>2 字节</td><td></td></tr><tr><td>寄存器数值 2</td><td>2 字节</td><td></td></tr><tr><td>寄存器数值 n</td><td>2 字节</td><td>n = N</td></tr><tr><td>CRC 校验码</td><td>2 字节</td><td></td></tr></tbody></table><p>指令：设备地址（1byte）+ <strong>0x10</strong>（1byte）+ 起始地址（2byte）+ 寄存器数（2byte）+ 字节数（1byte）+ 寄存器数值（2 * Nbyte）+ CRC（2byte）</p></li><li><p>应答：</p><table><thead><tr><th>名称</th><th>长度</th><th>说明</th></tr></thead><tbody><tr><td>设备地址</td><td>1 字节</td><td></td></tr><tr><td>功能码</td><td>1 字节</td><td><strong>0x10</strong></td></tr><tr><td>开始地址</td><td>2 字节</td><td>0x0000 to 0xFFFF</td></tr><tr><td>寄存器数量</td><td>2 字节</td><td>1 to 123 (0x7B)</td></tr><tr><td>CRC 校验码</td><td>2 字节</td><td></td></tr></tbody></table><p>指令：设备地址（1byte）+ <strong>0x10</strong>（1byte）+ 起始地址（2byte）+ 保持寄存器数（2byte）+ CRC（2byte）</p></li><li><p>错误返回：</p><table><thead><tr><th>名称</th><th>长度</th><th>说明</th></tr></thead><tbody><tr><td>设备地址</td><td>1 字节</td><td></td></tr><tr><td>功能码</td><td>1 字节</td><td><strong>0x90</strong></td></tr><tr><td>错误码</td><td>1 字节</td><td>01 or 02 or 03 or 04</td></tr><tr><td>CRC 校验码</td><td>2 字节</td><td></td></tr></tbody></table></li></ul><p><strong>流程图：</strong></p><p><img data-src="image-20220319224924985.png" alt="image-20220319224924985" /></p><h2 id="crc校验"><a class="anchor" href="#crc校验">#</a> CRC 校验</h2><ul><li><p>CRC16_MODBUS 查表法：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> aucCRCHi<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xC1</span><span class="token punctuation">,</span> <span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xC0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xC0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xC1</span><span class="token punctuation">,</span> <span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xC0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xC1</span><span class="token punctuation">,</span> <span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xC1</span><span class="token punctuation">,</span> <span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xC0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xC0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xC1</span><span class="token punctuation">,</span> <span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xC1</span><span class="token punctuation">,</span> <span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xC0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xC1</span><span class="token punctuation">,</span> <span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xC0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xC0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xC1</span><span class="token punctuation">,</span> <span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xC0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xC1</span><span class="token punctuation">,</span> <span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xC1</span><span class="token punctuation">,</span> <span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xC0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xC1</span><span class="token punctuation">,</span> <span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xC0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xC0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xC1</span><span class="token punctuation">,</span> <span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xC1</span><span class="token punctuation">,</span> <span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xC0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xC0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xC1</span><span class="token punctuation">,</span> <span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xC0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xC1</span><span class="token punctuation">,</span> <span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xC1</span><span class="token punctuation">,</span> <span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xC0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xC0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xC1</span><span class="token punctuation">,</span> <span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xC1</span><span class="token punctuation">,</span> <span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xC0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xC1</span><span class="token punctuation">,</span> <span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xC0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xC0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xC1</span><span class="token punctuation">,</span> <span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xC1</span><span class="token punctuation">,</span> <span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xC0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xC0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xC1</span><span class="token punctuation">,</span> <span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xC0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xC1</span><span class="token punctuation">,</span> <span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xC1</span><span class="token punctuation">,</span> <span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xC0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xC1</span><span class="token punctuation">,</span> <span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xC0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xC0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xC1</span><span class="token punctuation">,</span> <span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xC0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xC1</span><span class="token punctuation">,</span> <span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xC1</span><span class="token punctuation">,</span> <span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xC0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xC0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xC1</span><span class="token punctuation">,</span> <span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xC1</span><span class="token punctuation">,</span> <span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xC0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xC1</span><span class="token punctuation">,</span> <span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xC0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xC0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xC1</span><span class="token punctuation">,</span> <span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token number">0x40</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> aucCRCLo<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xC0</span><span class="token punctuation">,</span> <span class="token number">0xC1</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xC3</span><span class="token punctuation">,</span> <span class="token number">0x03</span><span class="token punctuation">,</span> <span class="token number">0x02</span><span class="token punctuation">,</span> <span class="token number">0xC2</span><span class="token punctuation">,</span> <span class="token number">0xC6</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x07</span><span class="token punctuation">,</span> <span class="token number">0xC7</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token number">0x05</span><span class="token punctuation">,</span> <span class="token number">0xC5</span><span class="token punctuation">,</span> <span class="token number">0xC4</span><span class="token punctuation">,</span> <span class="token number">0x04</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0x0C</span><span class="token punctuation">,</span> <span class="token number">0x0D</span><span class="token punctuation">,</span> <span class="token number">0xCD</span><span class="token punctuation">,</span> <span class="token number">0x0F</span><span class="token punctuation">,</span> <span class="token number">0xCF</span><span class="token punctuation">,</span> <span class="token number">0xCE</span><span class="token punctuation">,</span> <span class="token number">0x0E</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token number">0x0A</span><span class="token punctuation">,</span> <span class="token number">0xCA</span><span class="token punctuation">,</span> <span class="token number">0xCB</span><span class="token punctuation">,</span> <span class="token number">0x0B</span><span class="token punctuation">,</span> <span class="token number">0xC9</span><span class="token punctuation">,</span> <span class="token number">0x09</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token punctuation">,</span> <span class="token number">0xC8</span><span class="token punctuation">,</span> <span class="token number">0xD8</span><span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">,</span> <span class="token number">0x19</span><span class="token punctuation">,</span> <span class="token number">0xD9</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token number">0x1B</span><span class="token punctuation">,</span> <span class="token number">0xDB</span><span class="token punctuation">,</span> <span class="token number">0xDA</span><span class="token punctuation">,</span> <span class="token number">0x1A</span><span class="token punctuation">,</span> <span class="token number">0x1E</span><span class="token punctuation">,</span> <span class="token number">0xDE</span><span class="token punctuation">,</span> <span class="token number">0xDF</span><span class="token punctuation">,</span> <span class="token number">0x1F</span><span class="token punctuation">,</span> <span class="token number">0xDD</span><span class="token punctuation">,</span> <span class="token number">0x1D</span><span class="token punctuation">,</span> <span class="token number">0x1C</span><span class="token punctuation">,</span> <span class="token number">0xDC</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token number">0x14</span><span class="token punctuation">,</span> <span class="token number">0xD4</span><span class="token punctuation">,</span> <span class="token number">0xD5</span><span class="token punctuation">,</span> <span class="token number">0x15</span><span class="token punctuation">,</span> <span class="token number">0xD7</span><span class="token punctuation">,</span> <span class="token number">0x17</span><span class="token punctuation">,</span> <span class="token number">0x16</span><span class="token punctuation">,</span> <span class="token number">0xD6</span><span class="token punctuation">,</span> <span class="token number">0xD2</span><span class="token punctuation">,</span> <span class="token number">0x12</span><span class="token punctuation">,</span> <span class="token number">0x13</span><span class="token punctuation">,</span> <span class="token number">0xD3</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token number">0x11</span><span class="token punctuation">,</span> <span class="token number">0xD1</span><span class="token punctuation">,</span> <span class="token number">0xD0</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token number">0xF0</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token number">0x31</span><span class="token punctuation">,</span> <span class="token number">0xF1</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0xF3</span><span class="token punctuation">,</span> <span class="token number">0xF2</span><span class="token punctuation">,</span> <span class="token number">0x32</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token number">0x36</span><span class="token punctuation">,</span> <span class="token number">0xF6</span><span class="token punctuation">,</span> <span class="token number">0xF7</span><span class="token punctuation">,</span> <span class="token number">0x37</span><span class="token punctuation">,</span> <span class="token number">0xF5</span><span class="token punctuation">,</span> <span class="token number">0x35</span><span class="token punctuation">,</span> <span class="token number">0x34</span><span class="token punctuation">,</span> <span class="token number">0xF4</span><span class="token punctuation">,</span> <span class="token number">0x3C</span><span class="token punctuation">,</span> <span class="token number">0xFC</span><span class="token punctuation">,</span> <span class="token number">0xFD</span><span class="token punctuation">,</span> <span class="token number">0x3D</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token number">0xFF</span><span class="token punctuation">,</span> <span class="token number">0x3F</span><span class="token punctuation">,</span> <span class="token number">0x3E</span><span class="token punctuation">,</span> <span class="token number">0xFE</span><span class="token punctuation">,</span> <span class="token number">0xFA</span><span class="token punctuation">,</span> <span class="token number">0x3A</span><span class="token punctuation">,</span> <span class="token number">0x3B</span><span class="token punctuation">,</span> <span class="token number">0xFB</span><span class="token punctuation">,</span> <span class="token number">0x39</span><span class="token punctuation">,</span> <span class="token number">0xF9</span><span class="token punctuation">,</span> <span class="token number">0xF8</span><span class="token punctuation">,</span> <span class="token number">0x38</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token number">0x28</span><span class="token punctuation">,</span> <span class="token number">0xE8</span><span class="token punctuation">,</span> <span class="token number">0xE9</span><span class="token punctuation">,</span> <span class="token number">0x29</span><span class="token punctuation">,</span> <span class="token number">0xEB</span><span class="token punctuation">,</span> <span class="token number">0x2B</span><span class="token punctuation">,</span> <span class="token number">0x2A</span><span class="token punctuation">,</span> <span class="token number">0xEA</span><span class="token punctuation">,</span> <span class="token number">0xEE</span><span class="token punctuation">,</span> <span class="token number">0x2E</span><span class="token punctuation">,</span> <span class="token number">0x2F</span><span class="token punctuation">,</span> <span class="token number">0xEF</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token number">0x2D</span><span class="token punctuation">,</span> <span class="token number">0xED</span><span class="token punctuation">,</span> <span class="token number">0xEC</span><span class="token punctuation">,</span> <span class="token number">0x2C</span><span class="token punctuation">,</span> <span class="token number">0xE4</span><span class="token punctuation">,</span> <span class="token number">0x24</span><span class="token punctuation">,</span> <span class="token number">0x25</span><span class="token punctuation">,</span> <span class="token number">0xE5</span><span class="token punctuation">,</span> <span class="token number">0x27</span><span class="token punctuation">,</span> <span class="token number">0xE7</span><span class="token punctuation">,</span> <span class="token number">0xE6</span><span class="token punctuation">,</span> <span class="token number">0x26</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token number">0x22</span><span class="token punctuation">,</span> <span class="token number">0xE2</span><span class="token punctuation">,</span> <span class="token number">0xE3</span><span class="token punctuation">,</span> <span class="token number">0x23</span><span class="token punctuation">,</span> <span class="token number">0xE1</span><span class="token punctuation">,</span> <span class="token number">0x21</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token number">0xE0</span><span class="token punctuation">,</span> <span class="token number">0xA0</span><span class="token punctuation">,</span> <span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token number">0x61</span><span class="token punctuation">,</span> <span class="token number">0xA1</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token number">0x63</span><span class="token punctuation">,</span> <span class="token number">0xA3</span><span class="token punctuation">,</span> <span class="token number">0xA2</span><span class="token punctuation">,</span> <span class="token number">0x62</span><span class="token punctuation">,</span> <span class="token number">0x66</span><span class="token punctuation">,</span> <span class="token number">0xA6</span><span class="token punctuation">,</span> <span class="token number">0xA7</span><span class="token punctuation">,</span> <span class="token number">0x67</span><span class="token punctuation">,</span> <span class="token number">0xA5</span><span class="token punctuation">,</span> <span class="token number">0x65</span><span class="token punctuation">,</span> <span class="token number">0x64</span><span class="token punctuation">,</span> <span class="token number">0xA4</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token number">0x6C</span><span class="token punctuation">,</span> <span class="token number">0xAC</span><span class="token punctuation">,</span> <span class="token number">0xAD</span><span class="token punctuation">,</span> <span class="token number">0x6D</span><span class="token punctuation">,</span> <span class="token number">0xAF</span><span class="token punctuation">,</span> <span class="token number">0x6F</span><span class="token punctuation">,</span> <span class="token number">0x6E</span><span class="token punctuation">,</span> <span class="token number">0xAE</span><span class="token punctuation">,</span> <span class="token number">0xAA</span><span class="token punctuation">,</span> <span class="token number">0x6A</span><span class="token punctuation">,</span> <span class="token number">0x6B</span><span class="token punctuation">,</span> <span class="token number">0xAB</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token number">0x69</span><span class="token punctuation">,</span> <span class="token number">0xA9</span><span class="token punctuation">,</span> <span class="token number">0xA8</span><span class="token punctuation">,</span> <span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token number">0x78</span><span class="token punctuation">,</span> <span class="token number">0xB8</span><span class="token punctuation">,</span> <span class="token number">0xB9</span><span class="token punctuation">,</span> <span class="token number">0x79</span><span class="token punctuation">,</span> <span class="token number">0xBB</span><span class="token punctuation">,</span> <span class="token number">0x7B</span><span class="token punctuation">,</span> <span class="token number">0x7A</span><span class="token punctuation">,</span> <span class="token number">0xBA</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token number">0xBE</span><span class="token punctuation">,</span> <span class="token number">0x7E</span><span class="token punctuation">,</span> <span class="token number">0x7F</span><span class="token punctuation">,</span> <span class="token number">0xBF</span><span class="token punctuation">,</span> <span class="token number">0x7D</span><span class="token punctuation">,</span> <span class="token number">0xBD</span><span class="token punctuation">,</span> <span class="token number">0xBC</span><span class="token punctuation">,</span> <span class="token number">0x7C</span><span class="token punctuation">,</span> <span class="token number">0xB4</span><span class="token punctuation">,</span> <span class="token number">0x74</span><span class="token punctuation">,</span> <span class="token number">0x75</span><span class="token punctuation">,</span> <span class="token number">0xB5</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token number">0x77</span><span class="token punctuation">,</span> <span class="token number">0xB7</span><span class="token punctuation">,</span> <span class="token number">0xB6</span><span class="token punctuation">,</span> <span class="token number">0x76</span><span class="token punctuation">,</span> <span class="token number">0x72</span><span class="token punctuation">,</span> <span class="token number">0xB2</span><span class="token punctuation">,</span> <span class="token number">0xB3</span><span class="token punctuation">,</span> <span class="token number">0x73</span><span class="token punctuation">,</span> <span class="token number">0xB1</span><span class="token punctuation">,</span> <span class="token number">0x71</span><span class="token punctuation">,</span> <span class="token number">0x70</span><span class="token punctuation">,</span> <span class="token number">0xB0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token number">0x50</span><span class="token punctuation">,</span> <span class="token number">0x90</span><span class="token punctuation">,</span> <span class="token number">0x91</span><span class="token punctuation">,</span> <span class="token number">0x51</span><span class="token punctuation">,</span> <span class="token number">0x93</span><span class="token punctuation">,</span> <span class="token number">0x53</span><span class="token punctuation">,</span> <span class="token number">0x52</span><span class="token punctuation">,</span> <span class="token number">0x92</span><span class="token punctuation">,</span> <span class="token number">0x96</span><span class="token punctuation">,</span> <span class="token number">0x56</span><span class="token punctuation">,</span> <span class="token number">0x57</span><span class="token punctuation">,</span> <span class="token number">0x97</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token number">0x55</span><span class="token punctuation">,</span> <span class="token number">0x95</span><span class="token punctuation">,</span> <span class="token number">0x94</span><span class="token punctuation">,</span> <span class="token number">0x54</span><span class="token punctuation">,</span> <span class="token number">0x9C</span><span class="token punctuation">,</span> <span class="token number">0x5C</span><span class="token punctuation">,</span> <span class="token number">0x5D</span><span class="token punctuation">,</span> <span class="token number">0x9D</span><span class="token punctuation">,</span> <span class="token number">0x5F</span><span class="token punctuation">,</span> <span class="token number">0x9F</span><span class="token punctuation">,</span> <span class="token number">0x9E</span><span class="token punctuation">,</span> <span class="token number">0x5E</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token number">0x5A</span><span class="token punctuation">,</span> <span class="token number">0x9A</span><span class="token punctuation">,</span> <span class="token number">0x9B</span><span class="token punctuation">,</span> <span class="token number">0x5B</span><span class="token punctuation">,</span> <span class="token number">0x99</span><span class="token punctuation">,</span> <span class="token number">0x59</span><span class="token punctuation">,</span> <span class="token number">0x58</span><span class="token punctuation">,</span> <span class="token number">0x98</span><span class="token punctuation">,</span> <span class="token number">0x88</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x49</span><span class="token punctuation">,</span> <span class="token number">0x89</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token number">0x4B</span><span class="token punctuation">,</span> <span class="token number">0x8B</span><span class="token punctuation">,</span> <span class="token number">0x8A</span><span class="token punctuation">,</span> <span class="token number">0x4A</span><span class="token punctuation">,</span> <span class="token number">0x4E</span><span class="token punctuation">,</span> <span class="token number">0x8E</span><span class="token punctuation">,</span> <span class="token number">0x8F</span><span class="token punctuation">,</span> <span class="token number">0x4F</span><span class="token punctuation">,</span> <span class="token number">0x8D</span><span class="token punctuation">,</span> <span class="token number">0x4D</span><span class="token punctuation">,</span> <span class="token number">0x4C</span><span class="token punctuation">,</span> <span class="token number">0x8C</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token number">0x44</span><span class="token punctuation">,</span> <span class="token number">0x84</span><span class="token punctuation">,</span> <span class="token number">0x85</span><span class="token punctuation">,</span> <span class="token number">0x45</span><span class="token punctuation">,</span> <span class="token number">0x87</span><span class="token punctuation">,</span> <span class="token number">0x47</span><span class="token punctuation">,</span> <span class="token number">0x46</span><span class="token punctuation">,</span> <span class="token number">0x86</span><span class="token punctuation">,</span> <span class="token number">0x82</span><span class="token punctuation">,</span> <span class="token number">0x42</span><span class="token punctuation">,</span> <span class="token number">0x43</span><span class="token punctuation">,</span> <span class="token number">0x83</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0x40</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token keyword">unsigned</span> <span class="token keyword">short</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token function">usMBCRC16</span><span class="token punctuation">(</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span> pucFrame<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> usLen <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>   ucCRCHi <span class="token operator">=</span> <span class="token number">0xFF</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>   ucCRCLo <span class="token operator">=</span> <span class="token number">0xFF</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token keyword">int</span>             iIndex<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span> usLen<span class="token operator">--</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        iIndex <span class="token operator">=</span> ucCRCLo <span class="token operator">^</span> <span class="token operator">*</span><span class="token punctuation">(</span> pucFrame<span class="token operator">++</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>        ucCRCLo <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token punctuation">)</span><span class="token punctuation">(</span> ucCRCHi <span class="token operator">^</span> aucCRCHi<span class="token punctuation">[</span>iIndex<span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>        ucCRCHi <span class="token operator">=</span> aucCRCLo<span class="token punctuation">[</span>iIndex<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token punctuation">)</span><span class="token punctuation">(</span> ucCRCHi <span class="token operator">&lt;&lt;</span> <span class="token number">8</span> <span class="token operator">|</span> ucCRCLo <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></li><li><p>CRC16_MODBUS 运算法：</p><p>运算分析及计算，可看文章 <span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQyOTkyMDg0L2FydGljbGUvZGV0YWlscy8xMTY0NjYwMjk=">常用校验算法</span> - CRC 章节</p></li></ul><h1 id="实例应用"><a class="anchor" href="#实例应用">#</a> 实例应用</h1><p>测试应用可看以前的文章：</p><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQyOTkyMDg0L2FydGljbGUvZGV0YWlscy8xMDc1OTA4MDM=">Nano130 之 FreeModbus 移植</span></p>]]></content>
      
      
      <categories>
          
          <category> modbus </category>
          
      </categories>
      
      
        <tags>
            
            <tag> history </tag>
            
            <tag> modbus </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RT-Thread 应用总结</title>
      <link href="/docs/RTOS/RT-Thread%20%E5%BA%94%E7%94%A8%E6%80%BB%E7%BB%93/"/>
      <url>/docs/RTOS/RT-Thread%20%E5%BA%94%E7%94%A8%E6%80%BB%E7%BB%93/</url>
      
        <content type="html"><![CDATA[<p>官方文档介绍：<span class="exturl" data-url="aHR0cHM6Ly93d3cucnQtdGhyZWFkLm9yZy9kb2N1bWVudC9zaXRlLyMvcnQtdGhyZWFkLXZlcnNpb24vcnQtdGhyZWFkLXN0YW5kYXJkL1JFQURNRQ==">RT-Thread 文档中心</span></p><h1 id="各模块-api接口"><a class="anchor" href="#各模块-api接口">#</a> 各模块 API 接口</h1><p>由于 RT-Thread 实时操作系统跟各大类 RTOS 应用原理大致相同，因此不再详述各模块功能的作用了（各模块功能的详细信息可参考以前的 《<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQyOTkyMDg0L2NhdGVnb3J5Xzk2ODQyNTQuaHRtbA==">FreeRTOS 专栏</span>》），只总结各类功能接口的 API 调用函数。</p><p>官方 API 参考手册：<span class="exturl" data-url="aHR0cHM6Ly93d3cucnQtdGhyZWFkLm9yZy9kb2N1bWVudC9hcGkvaW5kZXguaHRtbA==">RT-Thread API 参考手册</span></p><p><img data-src="04thread_sta.png" alt="" /></p><h2 id="线程管理"><a class="anchor" href="#线程管理">#</a> 线程管理</h2><h3 id="a-线程使用"><a class="anchor" href="#a-线程使用">#</a> A、线程使用</h3><p><img data-src="04thread_ops.png" alt="线程相关操作" /></p><table><thead><tr><th>函数功能</th><th>API 接口</th><th>函数描述</th><th>与 FreeRTOS 相匹配的函数</th></tr></thead><tbody><tr><td>创建线程</td><td>rt_thread_t rt_thread_create(const char *name, void (*entry)(void *parameter), void *parameter, rt_uint32_t stack_size, rt_uint8_t priority, rt_uint32_t tick);</td><td>该函数将<strong>从动态堆内存中</strong>创建一个线程对象并分配线程对象内存和堆栈。</td><td>xTaskCreate()</td></tr><tr><td>删除线程</td><td>rt_err_t rt_thread_delete(rt_thread_t thread);</td><td>调用该函数后，线程对象将会被移出线程队列并且从内核对象管理器中删除，线程占用的堆栈空间也会被释放，收回的空间将重新用于其他的内存分配。</td><td>vTaskDelete()</td></tr><tr><td></td><td></td><td></td><td></td></tr><tr><td>初始线程</td><td>rt_err_t rt_thread_init(struct rt_thread *thread, const char *name, void (*entry)(void *parameter),  void *parameter, void *stack_start,  rt_uint32_t stack_size, rt_uint8_t priority,  rt_uint32_t tick);</td><td>使用该函数创建的线程，线程句柄 (或者说线程控制块指针) 、线程栈所占用的内存空间，均通过全局变量的方式进行分配，内核不负责动态分配内存空间（即由用户提供，<strong>属于静态分配</strong>，在编译时就被确定、被分配处理）。</td><td>xTaskCreateStatic()</td></tr><tr><td>脱离线程</td><td>rt_err_t rt_thread_detach (rt_thread_t thread);</td><td>与 rt_thread_delete () 函数相对应，使线程对象在线程队列和内核对象管理器中被脱离。注：线程本身不应调用这个接口脱离线程本身</td><td>vTaskDelete()</td></tr><tr><td></td><td></td><td></td><td></td></tr><tr><td>启动线程</td><td>rt_err_t rt_thread_startup(rt_thread_t thread);</td><td>当调用这个函数时，将把线程的状态更改为就绪状态，并放到相应优先级队列中等待调度。</td><td></td></tr><tr><td></td><td></td><td></td><td></td></tr><tr><td>线程睡眠</td><td>rt_err_t rt_thread_sleep(rt_tick_t tick); rt_err_t rt_thread_delay(rt_tick_t tick); rt_err_t rt_thread_mdelay(rt_int32_t ms);</td><td>这三个函数接口的作用相同，调用它们可以使当前线程挂起一段指定的时间，当这个时间过后，线程会被唤醒并再次进入就绪状态。</td><td>vTaskDelay()</td></tr></tbody></table><p>对比：<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQyOTkyMDg0L2FydGljbGUvZGV0YWlscy8xMDQzNjA5NjI=">FreeRTOS 篇章之任务管理</span></p><h3 id="b-挂起和恢复"><a class="anchor" href="#b-挂起和恢复">#</a> B、挂起和恢复</h3><ul class="task-list"><li><p><strong>线程挂起的函数接口：</strong></p><p><code>rt_err_t rt_thread_suspend (rt_thread_t thread);</code></p><p>线程挂起接口 rt_thread_suspend () 的参数和返回值见下表：</p><table><thead><tr><th><strong>参数</strong></th><th><strong>描述</strong></th></tr></thead><tbody><tr><td>thread</td><td>线程句柄</td></tr><tr><td><strong>返回</strong></td><td>——</td></tr><tr><td>RT_EOK</td><td>线程挂起成功</td></tr><tr><td>RT_ERROR</td><td>线程挂起失败，因为该线程的状态并不是就绪状态</td></tr></tbody></table></li><li class="task-list-item"><p><input type="checkbox" id="cbx_0" disabled="true" /><label for="cbx_0"> 注：RT-Thread 对此此函数有严格的使用限制，该函数只能使用来挂起当前线程（即自己挂起自己），不可以在线程 A 中尝试挂起线程 B，而且在挂起线程自己后，需要立刻调用  <code>rt_schedule()</code>  函数进行手动的线程上下文切换。用户只需要了解该接口的作用即可，强烈不建议在程序中使用该接口，该接口可以视为是内部接口。这是因为 A 线程在尝试挂起 B 线程时，A 线程并不清楚 B 线程正在运行什么程序，一旦 B 线程正在使用例如互斥量、信号量等影响、阻塞其他线程的内核对象，那么 A 线程尝试挂起 B 线程的操作将会引发连锁反应，严重危及系统的实时性（有些地方会将其描述为死锁，实际上这种现象不是死锁，但是也不比死锁好到哪去）。</label></p></li><li><p><strong>线程恢复的函数接口：</strong></p><p><code>rt_err_t rt_thread_resume (rt_thread_t thread);</code></p><p>线程恢复接口 rt_thread_resume () 的参数和返回值见下表：</p><table><thead><tr><th><strong>参数</strong></th><th><strong>描述</strong></th></tr></thead><tbody><tr><td>thread</td><td>线程句柄</td></tr><tr><td><strong>返回</strong></td><td>——</td></tr><tr><td>RT_EOK</td><td>线程恢复成功</td></tr><tr><td>RT_ERROR</td><td>线程恢复失败，因为该个线程的状态并不是 RT_THREAD_SUSPEND 状态</td></tr></tbody></table></li></ul><p>以上这两个函数类似于 <span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQyOTkyMDg0L2FydGljbGUvZGV0YWlscy8xMDQ0OTg1NTg=">FreeRTOS 篇章之临界区与调度器</span> 里面的调度器中的操作，但其要求并不一样。</p><h2 id="信号量"><a class="anchor" href="#信号量">#</a> 信号量</h2><p><img data-src="06sem_ops.png" alt="信号量相关接口" /></p><table><thead><tr><th>函数功能</th><th>API 接口</th><th>函数描述</th><th>与 FreeRTOS 相匹配的函数</th></tr></thead><tbody><tr><td>创建信号量</td><td>rt_sem_t rt_sem_create(const char *name, rt_uint32_t value, rt_uint8_t flag);</td><td>系统<strong>动态分配</strong>一个 semaphore 对象，并初始化这个对象，然后初始化父类 IPC 对象以及与 semaphore 相关的部分。</td><td>xSemaphoreCreateBinary()</td></tr><tr><td>删除信号量</td><td>rt_err_t rt_sem_delete(rt_sem_t sem);</td><td>通过删除信号量以释放系统资源，适用于动态创建的信号量。</td><td>vSemaphoreDelete()</td></tr><tr><td></td><td></td><td></td><td></td></tr><tr><td>初始信号量</td><td>rt_err_t rt_sem_init(rt_sem_t sem, const char *name, rt_uint32_t value, rt_uint8_t flag);</td><td><strong>属于静态分配</strong>，它的内存空间在编译时期就被编译器分配出来，放在读写数据段或未初始化数据段上。</td><td>xSemaphoreCreateBinaryStatic()</td></tr><tr><td>脱离信号量</td><td>rt_err_t rt_sem_detach(rt_sem_t sem);</td><td>让信号量对象从内核对象管理器中脱离，适用于静态初始化的信号量。</td><td>vSemaphoreDelete()</td></tr><tr><td></td><td></td><td></td><td></td></tr><tr><td>获取信号量</td><td>rt_err_t rt_sem_take (rt_sem_t sem, rt_int32_t time);</td><td>通过获取信号量来获得信号量资源实例，当信号量值大于零时，线程将获得信号量，并且相应的信号量值会减 1。</td><td>xSemaphoreTake() / xSemaphoreTakeFromISR()</td></tr><tr><td>无等待获取信号量</td><td>rt_err_t rt_sem_trytake(rt_sem_t sem);</td><td>与  <code>rt_sem_take(sem, RT_WAITING_NO)</code>  的作用相同，即当线程申请的信号量资源实例不可用的时候，它不会等待在该信号量上，而是直接返回 -  <code>RT_ETIMEOUT</code> 。</td><td></td></tr><tr><td></td><td></td><td></td><td></td></tr><tr><td>释放信号量</td><td>rt_err_t rt_sem_release(rt_sem_t sem);</td><td>释放之前所获得的信号量资源实例。</td><td>xSemaphoreGive() / xSemaphoreGiveFromISR()</td></tr></tbody></table><p>对比：<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQyOTkyMDg0L2FydGljbGUvZGV0YWlscy8xMDQ0MTI2NTk=">FreeRTOS 篇章之二值信号量</span></p><h2 id="互斥量"><a class="anchor" href="#互斥量">#</a> 互斥量</h2><p><img data-src="06mutex_ops.png" alt="互斥量相关接口" /></p><table><thead><tr><th>函数功能</th><th>API 接口</th><th>函数描述</th><th>与 FreeRTOS 相匹配的函数</th></tr></thead><tbody><tr><td>创建互斥量</td><td>rt_mutex_t rt_mutex_create (const char *name, rt_uint8_t flag);</td><td>系统将先从对象管理器中<strong>动态分配</strong>一个 mutex 对象，并初始化这个对象，然后初始化父类 IPC 对象以及与 mutex 相关的部分。</td><td>xSemaphoreCreateMutex()</td></tr><tr><td>删除互斥量</td><td>rt_err_t rt_mutex_delete (rt_mutex_t mutex);</td><td>通过删除互斥量以释放系统资源，适用于动态创建的互斥量。</td><td>vSemaphoreDelete()</td></tr><tr><td></td><td></td><td></td><td></td></tr><tr><td>初始互斥量</td><td>rt_err_t rt_mutex_init (rt_mutex_t mutex, const char *name, rt_uint8_t flag);</td><td><strong>属于静态分配</strong>，它的内存空间在编译时期就被编译器分配出来，放在读写数据段或未初始化数据段上。</td><td>xSemaphoreCreateMutexStatic()</td></tr><tr><td>脱离互斥量</td><td>rt_err_t rt_mutex_detach (rt_mutex_t mutex);</td><td>把互斥量对象从内核对象管理器中脱离，适用于静态初始化的互斥量。</td><td>vSemaphoreDelete()</td></tr><tr><td></td><td></td><td></td><td></td></tr><tr><td>获取互斥量</td><td>rt_err_t rt_mutex_take (rt_mutex_t mutex, rt_int32_t time);</td><td>当线程获取了互斥量，那么线程就有了对该互斥量的所有权，即某一个时刻一个互斥量只能被一个线程持有。</td><td>xSemaphoreTake()</td></tr><tr><td>无等待获取互斥量</td><td>rt_err_t rt_mutex_trytake(rt_mutex_t mutex);</td><td>与  <code>rt_mutex_take(mutex, RT_WAITING_NO)</code>  的作用相同，即当线程申请的互斥量资源实例不可用的时候，它不会等待在该互斥量上，而是直接返回 -  <code>RT_ETIMEOUT</code> 。</td><td></td></tr><tr><td></td><td></td><td></td><td></td></tr><tr><td>释放互斥量</td><td>rt_err_t rt_mutex_release(rt_mutex_t mutex);</td><td>使用该函数接口时，只有已经拥有互斥量控制权的线程才能释放它，每释放一次该互斥量，它的持有计数就减 1。</td><td>xSemaphoreGive()</td></tr></tbody></table><p>对比：<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQyOTkyMDg0L2FydGljbGUvZGV0YWlscy8xMDQ0NzkwNjk=">FreeRTOS 篇章之互斥量</span></p><h2 id="事件集"><a class="anchor" href="#事件集">#</a> 事件集</h2><p><img data-src="06event_ops.png" alt="事件相关接口" /></p><table><thead><tr><th>函数功能</th><th>API 接口</th><th>函数描述</th><th>与 FreeRTOS 相匹配的函数</th></tr></thead><tbody><tr><td>创建事件集</td><td>rt_event_t rt_event_create(const char *name, rt_uint8_t flag);</td><td>系统从对象管理器中<strong>动态分配</strong>事件集对象，并初始化这个对象，然后初始化父类 IPC 对象。</td><td>xEventGroupCreate()</td></tr><tr><td>删除事件集</td><td>rt_err_t rt_event_delete(rt_event_t event);</td><td>通过删除事件集对象控制块来释放系统资源，适用于动态创建的事件集。</td><td>vEventGroupDelete()</td></tr><tr><td></td><td></td><td></td><td></td></tr><tr><td>初始事件集</td><td>rt_err_t rt_event_init(rt_event_t event, const char *name, rt_uint8_t flag);</td><td><strong>属于静态分配</strong>，它的内存空间在编译时期就被编译器分配出来，放在读写数据段或未初始化数据段上。</td><td>xEventGroupCreateStatic()</td></tr><tr><td>脱离事件集</td><td>rt_err_t rt_event_detach(rt_event_t event);</td><td>将该事件集从内核对象管理器中脱离，适用于静态初始化的事件集。</td><td>vEventGroupDelete()</td></tr><tr><td></td><td></td><td></td><td></td></tr><tr><td>发送事件</td><td>rt_err_t rt_event_send(rt_event_t event, rt_uint32_t set);</td><td>通过参数 set 指定的事件标志来设定 event 事件集对象的事件标志值，然后遍历等待在 event 事件集对象上的等待线程链表，判断是否有线程的事件激活要求与当前 event 对象事件标志值匹配，如果有，则唤醒该线程。</td><td>xEventGroupSetBits() / xEventGroupSetBitsFromISR()</td></tr><tr><td></td><td></td><td></td><td></td></tr><tr><td>接收事件</td><td>rt_err_t rt_event_recv(rt_event_t event, rt_uint32_t set, rt_uint8_t option, rt_int32_t timeout, rt_uint32_t *recved);</td><td>系统首先根据 set 参数和接收选项 option 来判断它要接收的事件是否发生，如果已经发生，则根据参数 option 上是否设置有  <code>RT_EVENT_FLAG_CLEAR</code>  来决定是否重置事件的相应标志位，然后返回（其中 recved 参数返回接收到的事件）；如果没有发生，则把等待的 set 和 option 参数填入线程本身的结构中，然后把线程挂起在此事件上，直到其等待的事件满足条件或等待时间超过指定的超时时间。如果超时时间设置为零，则表示当线程要接受的事件没有满足其要求时就不等待，而直接返回 -  <code>RT_ETIMEOUT</code> 。</td><td>xEventGroupWaitBits()</td></tr></tbody></table><p>对比：<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQyOTkyMDg0L2FydGljbGUvZGV0YWlscy8xMDQ2MDIyNzQ=">FreeRTOS 篇章之事件位和事件组</span></p><h2 id="邮箱"><a class="anchor" href="#邮箱">#</a> 邮箱</h2><p><img data-src="07mb_ops.png" alt="邮箱相关接口" /></p><table><thead><tr><th>函数功能</th><th>API 接口</th><th>函数描述</th><th>与 FreeRTOS 相匹配的函数</th></tr></thead><tbody><tr><td>创建邮箱</td><td>rt_mailbox_t rt_mb_create (const char *name, rt_size_t size, rt_uint8_t flag);</td><td>创建邮箱对象时会先从对象管理器中分配一个邮箱对象，然后给邮箱<strong>动态分配一块内存空间</strong>用来存放邮件，这块内存的大小等于邮件大小（4 字节）与邮箱容量的乘积，接着初始化接收邮件数目和发送邮件在邮箱中的偏移量。</td><td>xQueueCreate()</td></tr><tr><td>删除邮箱</td><td>rt_err_t rt_mb_delete (rt_mailbox_t mb);</td><td>释放相应的系统资源，当操作一旦完成，邮箱将被永久性的删除。</td><td>vQueueDelete()</td></tr><tr><td></td><td></td><td></td><td></td></tr><tr><td>初始邮箱</td><td>rt_err_t rt_mb_init(rt_mailbox_t mb, const char *name, void *msgpool, rt_size_t size, rt_uint8_t flag);</td><td><strong>属于静态分配</strong>，与创建邮箱不同的是，静态邮箱对象的内存是在系统编译时由编译器分配的，一般放于读写数据段或未初始化数据段中，其余的初始化工作与创建邮箱时相同。</td><td>xQueueCreateStatic()</td></tr><tr><td>脱离邮箱</td><td>rt_err_t rt_mb_detach(rt_mailbox_t mb);</td><td>把静态初始化的邮箱对象从内核对象管理器中脱离。</td><td>vQueueDelete()</td></tr><tr><td></td><td></td><td></td><td></td></tr><tr><td>发送邮件</td><td>rt_err_t rt_mb_send (rt_mailbox_t mb, rt_uint32_t value);</td><td>发送的邮件可以是 32 位任意格式的数据，一个整型值或者一个指向缓冲区的指针；当邮箱中的邮件已经满时，发送邮件的线程或者中断程序会收到 - <code>RT_EFULL</code>  的返回值。</td><td>xQueueOverwrite() / xQueueOverwriteFromISR()</td></tr><tr><td>等待方式发送邮件</td><td>rt_err_t rt_mb_send_wait (rt_mailbox_t mb, rt_uint32_t value, rt_int32_t timeout);</td><td>与 rt_mb_send () 的区别在于有等待时间，如果邮箱已经满了，那么发送线程将根据设定的 timeout 参数等待邮箱中因为收取邮件而空出空间；如果设置的超时时间到达依然没有空出空间，这时发送线程将被唤醒并返回错误码。</td><td></td></tr><tr><td>发送紧急邮件</td><td>rt_err_t rt_mb_urgent (rt_mailbox_t mb, rt_ubase_t value);</td><td>与发送邮件几乎一样，唯一的不同是，当发送紧急邮件时，邮件被<strong>直接插队放入了邮件队首</strong>，这样，接收者就能够优先接收到紧急邮件，从而及时进行处理。</td><td></td></tr><tr><td></td><td></td><td></td><td></td></tr><tr><td>接收邮件</td><td>rt_err_t rt_mb_recv (rt_mailbox_t mb, rt_uint32_t *value, rt_int32_t timeout);</td><td>只有当接收者接收的邮箱中有邮件时，接收者才能立即取到邮件并返回  <code>RT_EOK</code>  的返回值，否则接收线程会根据超时时间设置，或挂起在邮箱的等待线程队列上，或直接返回。</td><td>xQueueReceive() / xQueueReceiveFromISR()</td></tr></tbody></table><p>对比：<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQyOTkyMDg0L2FydGljbGUvZGV0YWlscy8xMDQzOTk1MzE=">FreeRTOS 篇章之队列管理</span> 中的消息数目为 1 的队列</p><p>注：由于 FreeRTOS 中并没有邮箱这一概念（邮箱这概念在 uCOS 中有），但是其原理类似于利用队列发送单一数目的信息，由于在 32 系统上 4 字节（32 bit）的内容恰好可以放置一个指针，因此该信息通常为<strong>数据指针</strong>。</p><h2 id="消息队列"><a class="anchor" href="#消息队列">#</a> 消息队列</h2><p><img data-src="07msg_ops.png" alt="消息队列相关接口" /></p><table><thead><tr><th>函数功能</th><th>API 接口</th><th>函数描述</th><th>与 FreeRTOS 相匹配的函数</th></tr></thead><tbody><tr><td>创建队列</td><td>rt_mq_t rt_mq_create(const char *name, rt_size_t msg_size, rt_size_t max_msgs, rt_uint8_t flag);</td><td>从对象管理器中<strong>动态分配</strong>一个消息队列对象，然后给消息队列对象分配一块内存空间，组织成空闲消息链表，这块 <code>内存的大小 = [消息大小 + 消息头（用于链表连接）的大小] x 消息队列最大个数</code> ，接着再初始化消息队列，此时消息队列为空。</td><td>xQueueCreate()</td></tr><tr><td>删除队列</td><td>rt_err_t rt_mq_delete(rt_mq_t mq);</td><td>删除它以释放系统资源，一旦操作完成，消息队列将被永久性地删除。</td><td>vQueueDelete()</td></tr><tr><td></td><td></td><td></td><td></td></tr><tr><td>初始队列</td><td>rt_err_t rt_mq_init(rt_mq_t mq, const char *name, void *msgpool, rt_size_t msg_size, rt_size_t pool_size, rt_uint8_t flag);</td><td><strong>属于静态分配</strong>，跟创建消息队列对象类似，只是静态消息队列对象的内存是在系统编译时由编译器分配的，一般放于读数据段或未初始化数据段中。</td><td>xQueueCreateStatic()</td></tr><tr><td>脱离队列</td><td>rt_err_t rt_mq_detach(rt_mq_t mq);</td><td>将使消息队列对象被从内核对象管理器中脱离。</td><td>vQueueDelete()</td></tr><tr><td></td><td></td><td></td><td></td></tr><tr><td>发送信息</td><td>rt_err_t rt_mq_send (rt_mq_t mq, void *buffer, rt_size_t size);</td><td>线程或者中断服务程序都可以给消息队列发送消息。当发送消息时，消息队列对象先从空闲消息链表上取下一个空闲消息块，把线程或者中断服务程序发送的消息内容复制到消息块上，然后把该消息块挂到消息队列的尾部。当且仅当空闲消息链表上有可用的空闲消息块时，发送者才能成功发送消息；当空闲消息链表上无可用消息块，说明消息队列已满，此时，发送消息的的线程或者中断程序会收到一个错误码（- <code>RT_EFULL</code> ）。</td><td>xQueueSend() / xQueueSendFromISR() xQueueSendToFront() / xQueueSendToFrontFromISR()</td></tr><tr><td>等待方式发送信息</td><td>rt_err_t rt_mq_send_wait(rt_mq_t     mq, const void *buffer, rt_size_t size, rt_int32_t  timeout);</td><td>与 rt_mq_send () 的区别在于有等待时间，如果消息队列已经满了，那么发送线程将根据设定的 timeout 参数进行等待。如果设置的超时时间到达依然没有空出空间，这时发送线程将被唤醒并返回错误码。</td><td></td></tr><tr><td>发送紧急信息</td><td>rt_err_t rt_mq_urgent(rt_mq_t mq, void *buffer, rt_size_t size);</td><td>与发送消息几乎一样，唯一的不同是，当发送紧急消息时，从空闲消息链表上取下来的消息块不是挂到消息队列的队尾，而是挂到队首，这样，接收者就能够优先接收到紧急消息，从而及时进行消息处理。</td><td></td></tr><tr><td></td><td></td><td></td><td></td></tr><tr><td>接收信息</td><td>rt_err_t rt_mq_recv (rt_mq_t mq, void *buffer, rt_size_t size, rt_int32_t timeout);</td><td>当消息队列中有消息时，接收者才能接收消息，否则接收者会根据超时时间设置，或挂起在消息队列的等待线程队列上，或直接返回。</td><td>xQueueReceive() / xQueueReceiveFromISR()</td></tr></tbody></table><p>对比：<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQyOTkyMDg0L2FydGljbGUvZGV0YWlscy8xMDQzOTk1MzE=">FreeRTOS 篇章之队列管理</span></p><h1 id="中断管理"><a class="anchor" href="#中断管理">#</a> 中断管理</h1><p><img data-src="09interrupt_ops.png" alt="中断相关接口" /></p><p>对于上图，通常用的较多的是：</p><h2 id="全局中断开关"><a class="anchor" href="#全局中断开关">#</a> 全局中断开关</h2><p><strong>全局中断开关也称为</strong>中断锁，是禁止多线程访问临界区最简单的一种方式，即通过关闭中断的方式，来保证当前线程不会被其他事件打断（因为整个系统已经不再响应那些可以触发线程重新调度的外部事件），也就是当前线程不会被抢占，除非这个线程主动放弃了处理器控制权。</p><table><thead><tr><th>函数功能</th><th>API 接口</th><th>函数描述</th><th>与 FreeRTOS 相匹配的函数</th></tr></thead><tbody><tr><td>关闭整个系统的中断</td><td>rt_base_t rt_hw_interrupt_disable(void);</td><td>关闭整个系统的中断</td><td>taskENTER_CRITICAL() / taskENTER_CRITICAL_FROM_ISR()</td></tr><tr><td>恢复整个系统的中断</td><td>void rt_hw_interrupt_enable(rt_base_t level);</td><td>恢复系统的上一个中断状态</td><td>taskEXIT_CRITICAL() / taskEXIT_CRITICAL_FROM_ISR( x )</td></tr></tbody></table><p><strong>（1）rt_hw_interrupt_disable () API 函数</strong></p><p>原型： <code>rt_base_t rt_hw_interrupt_disable(void);</code></p><p>返回参数：</p><ul><li>rt_hw_interrupt_disable 函数运行前的中断状态</li></ul><p><strong>（2）rt_hw_interrupt_enable () API 函数</strong></p><p>原型： <code>void rt_hw_interrupt_enable(rt_base_t level);</code></p><p>输入参数：</p><ul><li>前一次 rt_hw_interrupt_disable 返回的中断状态</li></ul><p>注：在这里就相当于 <span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQyOTkyMDg0L2FydGljbGUvZGV0YWlscy8xMDQ0OTg1NTg=">FreeRTOS 篇章之临界区与调度器</span> 里面的临界段中的操作。</p><h2 id="中断通知"><a class="anchor" href="#中断通知">#</a> 中断通知</h2><p>当整个系统被中断打断，进入中断处理函数时，需要通知内核当前已经进入到中断状态。</p><p>针对这种情况，RT-Thread 提供如下两个接口：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">rt_interrupt_enter</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 用于通知内核，当前已经进入了中断状态，并增加中断嵌套深度（执行 rt_interrupt_nest++）</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span> <span class="token function">rt_interrupt_leave</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 用于通知内核，当前已经离开了中断状态，并减少中断嵌套深度（执行 rt_interrupt_nest--）</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>注：不要在应用程序中调用这两个接口函数。</pre></td></tr></table></figure><p>其实这两个函数等同于 FreeRTOS 中带 FromISR 后缀的函数说明。</p><h1 id="rt-thread-studio上手"><a class="anchor" href="#rt-thread-studio上手">#</a> RT-Thread Studio 上手</h1><p>安装及环境搭建过程可以直接参看官方的指导文档：<span class="exturl" data-url="aHR0cHM6Ly93d3cucnQtdGhyZWFkLm9yZy9kb2N1bWVudC9zaXRlLyMvZGV2ZWxvcG1lbnQtdG9vbHMvcnR0aHJlYWQtc3R1ZGlvL3VtL3N0dWRpby11c2VyLWJlZ2lu">RT-Thread Studio 使用文档</span></p><p><strong>以下只是简单记录部分关键点：</strong></p><h2 id="控制台调试口修改"><a class="anchor" href="#控制台调试口修改">#</a> 控制台调试口修改</h2><p>在新建项目过程中，可从 GUI 窗口中选择配置，如下图：</p><p><img data-src="TIM%E6%88%AA%E5%9B%BE20220226114622.png" alt="TIM截图20220226114622" /></p><p>当后期需要重新分配时，则需要在代码和 RT-Thread setting 中修改了，（以修改为  <code>UART 3</code>  为例）修改内容如下：</p><p><img data-src="TIM%E6%88%AA%E5%9B%BE20220226120341.png" alt="TIM截图20220226120341" /></p><h2 id="串口终端集成显示"><a class="anchor" href="#串口终端集成显示">#</a> 串口终端集成显示</h2><p>在 RT-Thread Studio 上，是可以通过点击工具栏  <code>终端</code>  按钮，来打开对应的终端功能窗口查看输出信息的，并且同样支持与 RT-Thread 特有的  <code>finsh</code>  命令进行交互，串口终端显示操作如下：</p><p><img data-src="TIM%E6%88%AA%E5%9B%BE20220226141345.png" alt="TIM截图20220226141345" /></p><p><img data-src="TIM%E6%88%AA%E5%9B%BE20220226142044.png" alt="TIM截图20220226142044" /></p><h2 id="与-cubemx联合编程"><a class="anchor" href="#与-cubemx联合编程">#</a> 与 CubeMX 联合编程</h2><p>此操作的前提条件是已经安装了 STM32CubeMX</p><h3 id="a-启动-cubemx-settings配置"><a class="anchor" href="#a-启动-cubemx-settings配置">#</a> A、启动 CubeMX settings 配置</h3><p>新建的工程，都是优先使用内部时钟源（如下图），但实际情况下，大部分是使用外部时钟的，因为其稳定性比较好；因此，以修改外部时钟为例。</p><p><img data-src="TIM%E6%88%AA%E5%9B%BE20220226115723.png" alt="TIM截图20220226115723" /></p><p>由于 RT-Thread Studio 支持与 CubeMX 联合编程，所以我们只需在项目资源管理器中启动  <code>CubeMX settings</code>  进行配置就好（如下图），进入界面后，其操作实际等同于操作 STM32CubeMX。</p><p><img data-src="image-20220226210308862.png" alt="image-20220226210308862" /></p><h3 id="b-cubemx-settings配置生成注意点"><a class="anchor" href="#b-cubemx-settings配置生成注意点">#</a> B、CubeMX settings 配置生成注意点</h3><ul><li><p>尽量生成 GCC 工程，因为 RT-Thread Studio 用的是 gcc 编译器<br /><img data-src="image-20220226233830986.png" alt="image-20220226233830986" /></p></li><li><p>选择生成独立的 .c .h 文件<br /><img data-src="313583-20201110104753899-295524523.png" alt="img" /></p></li><li><p>生成完成后返回界面，会提示替换了  <code>stm32xxx_hal_conf.h</code>  文件，因此，我们需要把原来的配置，同步过去，该哪些配置需要打开的，都一一打开。</p></li></ul><h3 id="c-添加编译规则"><a class="anchor" href="#c-添加编译规则">#</a> C、添加编译规则</h3><p>在生成 CubeMX 产生的工程后，打开  <code>drv_clk.c</code>  文件，你会发现  <code>clk_init()</code>  函数里面被自动更改了（如下图）；这也就意味着什么呢？记得备份啦，或者上 git /svn 进行版本管理啦。</p><p><img data-src="TIM%E6%88%AA%E5%9B%BE20220226143627.png" alt="TIM截图20220226143627" /></p><p>于是乎，对工程进行编译时，发现一堆报错，不禁怀疑 RT-Thread Studio 是否支持与 CubeMX 联合编程的。。。</p><p>在这里就需要对编译做相关操作了：</p><p>（1）在生成的 cubemx 文件夹里，先检查 cubemx 文件夹下有没有  <code>SConscript</code>  文件，如果有就跳过创建环节，检查内容。</p><p>（2）核查并更改  <code>SConscript</code>  文件里面的内容。</p><p>（3）有时候在生成 CubeMX 产生的工程后，RT-Thread Studio 会帮你生成一个  <code>SConscript</code>  文件，并写好了规则，如果是已有的，那么可以尝试先编译一下是否有新增的源码进行编译，如果没有，那么可以仿照如下的代码进行修改：</p><p><img data-src="TIM%E6%88%AA%E5%9B%BE20220226150650.png" alt="TIM截图20220226150650" /></p><p>其中，上面规则里的  <code>src</code>  部分，需要根据实际内容增删需要编译的源文件（如下）：</p><figure class="highlight markdown"><figcaption data-lang="markdown"></figcaption><table><tr><td data-num="1"></td><td><pre>src = Split('''</pre></td></tr><tr><td data-num="2"></td><td><pre>Src/stm32g4xx_hal_msp.c</pre></td></tr><tr><td data-num="3"></td><td><pre>Src/main.c</pre></td></tr><tr><td data-num="4"></td><td><pre>Src/dma.c</pre></td></tr><tr><td data-num="5"></td><td><pre>Src/gpio.c</pre></td></tr><tr><td data-num="6"></td><td><pre>Src/usart.c</pre></td></tr><tr><td data-num="7"></td><td><pre>''')</pre></td></tr></table></figure><p>当然，为了一劳永逸，你也可以把它修改成这样子：</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 引入 building 模块中所有的东西</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">from</span> building <span class="token keyword">import</span> <span class="token operator">*</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 获取当前路径。</span></pre></td></tr><tr><td data-num="5"></td><td><pre>cwd <span class="token operator">=</span> GetCurrentDir<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 使能选择</span></pre></td></tr><tr><td data-num="8"></td><td><pre>search_EN <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># add cubemx drivers</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># search_EN 为 0 时，手动选择添加需要编译的源文件</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># search_EN 为 1 时，自动搜寻与 SrcRemove 匹配以外的源文件</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> search_EN<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>src <span class="token operator">=</span> Split<span class="token punctuation">(</span><span class="token triple-quoted-string string">'''</pre></td></tr><tr><td data-num="15"></td><td><pre>Src/stm32f4xx_hal_msp.c</pre></td></tr><tr><td data-num="16"></td><td><pre>Src/main.c</pre></td></tr><tr><td data-num="17"></td><td><pre>'''</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>src <span class="token operator">=</span> Glob<span class="token punctuation">(</span><span class="token string">'Src/*.c'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>SrcRemove<span class="token punctuation">(</span>src<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'Src/stm32f4xx_it.c'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>SrcRemove<span class="token punctuation">(</span>src<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'Src/system_stm32f4xx.c'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment"># 创建头文件路径列表，并保存至 path 中</span></pre></td></tr><tr><td data-num="24"></td><td><pre>path <span class="token operator">=</span> <span class="token punctuation">[</span>cwd <span class="token operator">+</span> <span class="token string">'/Inc'</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment"># 这是 RT-Thread 基于 SCons 扩展的一个方法（函数）。</span></pre></td></tr><tr><td data-num="27"></td><td><pre>group <span class="token operator">=</span> DefineGroup<span class="token punctuation">(</span><span class="token string">'cubemx'</span><span class="token punctuation">,</span> src<span class="token punctuation">,</span> depend <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">''</span><span class="token punctuation">]</span><span class="token punctuation">,</span> CPPPATH <span class="token operator">=</span> path<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>Return<span class="token punctuation">(</span><span class="token string">'group'</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>通过上面，你可能发现，为什么文件中的  <code>stm32f4xx_it.c</code>  和  <code>system_stm32f4xx.c</code>  不加入构建；其实你可以尝试一下加入编译一下，你就会发现玄机了。</p><p>更多的关于 SCons 工具的使用可以观看如下链接：</p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cucnQtdGhyZWFkLm9yZy9kb2N1bWVudC9zaXRlLyMvZGV2ZWxvcG1lbnQtdG9vbHMvc2NvbnMvc2NvbnM/aWQ9c2NvbnMtJUU3JUFFJTgwJUU0JUJCJThC">https://www.rt-thread.org/document/site/#/development-tools/scons/scons?id=scons-%e7%ae%80%e4%bb%8b</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9zY29ucy5vcmcvZG9jL3Byb2R1Y3Rpb24vSFRNTC9zY29ucy11c2VyL2luZGV4Lmh0bWw=">https://scons.org/doc/production/HTML/scons-user/index.html</span></p><p>最后记得更新 Sconscripts（在项目资源管理器选择目标工程 -&gt; 右键 -&gt; 更新  <code>Sconscripts</code> ）：</p><p><img data-src="image-20220226231733878.png" alt="image-20220226231733878" /></p><h3 id="d-迁移-cubemx产生的代码"><a class="anchor" href="#d-迁移-cubemx产生的代码">#</a> D、迁移 CubeMX 产生的代码</h3><p>当完成上面操作后，再次构建工程，或多或少还会出现错误，大概率是函数重复定义导致，比如  <code>multiple definition of main</code> 。这时候可以如下操作：</p><p><img data-src="20220226173146.png" alt="20220226173146" /></p><p>嘛，或许有时候在 CubeMX 初次生成的 main () 函数上自带了  <code>__WEAK</code>  弱处理关键字，但后期在多次更改 CubeMX settings 配置后，会有出现去掉  <code>__WEAK</code>  的情况，所以为了安全，还是把  <code>__WEAK</code>  添加到上述的保护区域位置去吧。</p><p>除了以上情况，在 CubeMX settings 配置更多外设时，需要把 cubemx/Src 里的 main.c 文件里的配置函数，手动移加到 RT-Thread 工程的 main.c 主文件函数中（一些 RTT 配置里面有的，就不用添加过去了，避免功能出错，例如 ETH 的配置）。如下图：</p><p><img data-src="20220226172930.png" alt="20220226172930" /></p>]]></content>
      
      
      
        <tags>
            
            <tag> history </tag>
            
            <tag> RTOS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Modbus家族之开篇</title>
      <link href="/docs/%E9%80%9A%E8%AE%AF%E5%8D%8F%E8%AE%AE/Modbus%E5%AE%B6%E6%97%8F%E4%B9%8B%E5%BC%80%E7%AF%87/"/>
      <url>/docs/%E9%80%9A%E8%AE%AF%E5%8D%8F%E8%AE%AE/Modbus%E5%AE%B6%E6%97%8F%E4%B9%8B%E5%BC%80%E7%AF%87/</url>
      
        <content type="html"><![CDATA[<h1 id="历史溯源"><a class="anchor" href="#历史溯源">#</a> 历史溯源</h1><p>Modbus 是由 Modicon 公司（现在的施耐德电气 Schneider Electric）在 1979 年开发的一种消息传递结构，为使用可编程逻辑控制器（PLC）通信而发表，用于在智能设备之间建立客户端 - 服务器通信；这是一个划时代、里程碑式的网络协议，因此为工业网络拉开了序幕。Modbus 已经成为工业领域通信协议事实上的业界标准，并且现在是工业电子设备之间常用的连接方式。</p><p>Modbus 在工业环境下很流行，因为它是公开发表并且无著作权要求的。它是为工业应用开发的，与其他标准相比，它相对易于部署和维护，除了要传输的数据格式的大小外，几乎没有其他限制。Modbus 通常使用 <strong>RS485</strong> 作为其物理层。</p><h2 id="发展史"><a class="anchor" href="#发展史">#</a> 发展史</h2><p>Modicon，即今天的施耐德电气，于 1979 年向市场推出了 Modbus 原始协议（Modbus ASCII 和 Modbus RTU）；随着通信领域的迅速发展以及传输速度的提高，扩展版本 Modbus Plus（Modbus + 或者 MB+）紧接着出现，不过此协议是 Modicon 专有的，<strong>和 Modbus 并不相同</strong>；直到以太网技术的标准化和商品化，以太网成为了企业系统的业界标准，同时也成为了工业网络的业界标准；为了将 Modbus 带入 21 世纪，一个开放的 Modbus TCP/IP 规范于 1999 年修订发行；到了 2004 年 4 月，Modbus 协议从施耐德电气转移到 Modbus 组织，这标志着对开放的承诺（<strong>该规范可免费下载，并且</strong>使用 Modbus 或 Modbus TCP/IP 协议无需后续许可费用）；至此，在 Modbus TCP/IP 因为它的开放性、简单、低成本的开发以及支持它所需的最少硬件等特点，存在多个 Modbus TCP 变种，而 Modbus ASCII 和 Modbus RTU 在小型的嵌入式设备当中得到广泛应用。</p><p>&lt;br/&gt;</p><h1 id="协议版本"><a class="anchor" href="#协议版本">#</a> 协议版本</h1><p>Modbus 协议目前存在用于<strong>串口</strong>、<strong>以太网</strong>以及其他支持<strong>互联网协议</strong>的网络的版本。</p><p>Modbus 是一种请求 / 回复协议，提供由功能代码指定的服务。Modbus 功能代码是 Modbus Request (请求) / Response (响应)  PDU 的元素。</p><p>串行端口和以太网存在多种版本的 Modbus 协议，最常见的是：</p><ul><li>Modbus RTU</li><li>Modbus ASCII</li><li>Modbus TCP</li><li>Modbus Plus</li></ul><p><img data-src="Modbus-Different-Types.jpg" alt="" /></p><h2 id="modbus-rtu"><a class="anchor" href="#modbus-rtu">#</a> Modbus RTU</h2><p><code>Modbus RTU</code>  是一种紧凑的，采用二进制表示数据的方式；因为使用二进制编码和 CRC 错误检查的结合使得 Modbus RTU 适用于工业应用，因为它比 ASCII 字符的替代方案更有效地传输。在 Modbus RTU 与 ASCII 之间进行选择时，如果考虑性能，则 RTU 是首选。</p><h2 id="modbus-ascii"><a class="anchor" href="#modbus-ascii">#</a> Modbus ASCII</h2><p><code>Modbus ASCII</code>  是当设备设置为使用  <code>ASCII</code>  （<strong>美国信息交换标准代码</strong>）模式时，在  <code>MODBUS</code>  串行线上把通信消息中的每个 8 位字节将作为两个 ASCII 4 位字符发送。当物理通信链路或设备的功能不允许符合 RTU 计时器管理要求时，使用此模式。所以此模式的效率不如 RTU，因为每个字节需要两个字符。示例：字节 0x7D 编码为两个字符：  <code>0x35</code>  和  <code>0x42</code> （在  <code>ASCII</code>  表中为  <code>0x37</code>  =  <code>'7'</code> ，而  <code>0x44</code>  =  <code>'D'</code> ）。</p><h2 id="modbus-tcp"><a class="anchor" href="#modbus-tcp">#</a> Modbus TCP</h2><p><code>Modbus TCP</code>  是在  <code>TCP/IP</code>  网络上运行的 Modbus 的实现，旨在允许 Modbus ASCII / RTU 协议在基于 TCP / IP 的网络上传输。Modbus / TCP 将 Modbus 消息嵌入 TCP / IP 帧内。尽管实现起来非常简单，但是与网络相关的特性增加了一些挑战。例如，由于 Modbus 主机期望并要求在一定时间范围内对其轮询做出响应，因此必须考虑 TCP / IP 网络的不确定性（和其他方面）。Modbus ASCII 和 Modbus TCP 之间的主要区别在于，Modbus ASCII 所需的 LRC 错误检查由 IP 层执行。</p><blockquote><p>对于以上  <code>TCP</code> /  <code>RTU</code> /  <code>ASCII</code>  的这三种通信协议在数据模型和功能调用上都是相同的，只有封装方式是不同的。</p></blockquote><h2 id="modbus-plus"><a class="anchor" href="#modbus-plus">#</a> Modbus Plus</h2><p><code>Modbus Plus</code>  （Modbus + 或者 MB+）属于 Modbus 的一个扩展版本，不过此协议是 Modicon 专有的，和 Modbus 不同。它需要一个专门的协处理器来处理类似 HDLC 的高速令牌旋转。它使用 1Mbit/s 的双绞线，并且每个节点都有转换隔离设备，是一种采用转换／边缘触发而不是电压／水平触发的设备。连接 Modbus Plus 到计算机需要特别的接口，通常是支持 ISA（SA85），PCI 或者 PCMCIA 总线的板卡。</p><h1 id="通信和设备"><a class="anchor" href="#通信和设备">#</a> 通信和设备</h1><p>Modbus 有下列三种通信方式：</p><p>（1）以太网：对应的通信模式是 <strong>Modbus TCP/IP</strong></p><p>（2）异步串行传输（各种介质如有线 RS-232/422/485/、光纤、无线等）：对应的通信模式是 <strong>Modbus RTU</strong> 或 <strong>Modbus ASCII</strong></p><p>（3）高速令牌传递网络：对应的通信模式是 <strong>Modbus PLUS</strong></p><p>Modbus 通过多种类型的物理介质进行通信，例如：</p><ul><li>串行 RS-232</li><li>串行 RS-485</li><li>串行 RS-422</li><li>以太网</li></ul><p>Modbus RTU 和 Modbus ASCII 协议应用于串口链接（RS232、RS485、RS422），Modbus TCP/IP 协议应用于以太网链接。</p><p><img data-src="Modbus-Communication-Physical-Media.gif" alt="img" /></p><h1 id="消息结构"><a class="anchor" href="#消息结构">#</a> 消息结构</h1><p>Modbus 的主要消息结构是点对点，能够在点对点和多点网络上运行。</p><p><img data-src="image-20220208222537825.png" alt="image-20220208222537825" /></p><p>Modbus 协议遵循 ** 主 / 从（客户端 / 服务器）** 架构，主（客户端）向从（服务器）发送请求并等待响应。注意！目前 Modbus 中使用的术语 “主” 和 “从” 已被术语 “客户端” 和 “服务器” 所取代了。</p><p><img data-src="image-20220209165731722.png" alt="image-20220209165731722" /></p><h1 id="常见-modbus开源库"><a class="anchor" href="#常见-modbus开源库">#</a> 常见 Modbus 开源库</h1><h2 id="freemodbus"><a class="anchor" href="#freemodbus">#</a> <span class="exturl" data-url="aHR0cHM6Ly93d3cuZW1iZWRkZWQtZXhwZXJ0cy5hdC9lbi9mcmVlbW9kYnVzLw==">FreeModbus</span></h2><p>FreeMODBUS 是流行的 Modbus 协议的免费实现，专门针对嵌入式系统。FreeMODBUS 提供了 <em>Modbus 应用协议 v1.1a</em> 的实现，并支持 <em>Modbus over serial line 规范 1.0</em> 中定义的 <strong>RTU/ASCII</strong> 传输模式 ；自 0.7 版以来，FreeModbus 还支持 <strong>Modbus/TCP</strong>；0.9 版添加了第一个 Modbus/TCP 端口嵌入式使用 LWIP TCP/IP 堆栈的系统。唯一可惜的是，该 FreeMODBUS 只对从机开放了源码，主机部分并未实现开源。</p><p>以下是该 FreeMODBUS 的下载链接：</p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuZW1iZWRkZWQtZXhwZXJ0cy5hdC9lbi9mcmVlbW9kYnVzLWRvd25sb2Fkcy8=">https://www.embedded-experts.at/en/freemodbus-downloads/</span></p><h2 id="libmodbus"><a class="anchor" href="#libmodbus">#</a> <span class="exturl" data-url="aHR0cHM6Ly9saWJtb2RidXMub3JnLw==">libmodbus</span></h2><p>libmodbus 是一个多平台的 Modbus 源库，适用于 Linux、Mac OS X、FreeBSD、QNX 和 Win32 等操作系统；可以根据 Modbus 协议发送和接收数据。支持 RTU（串行）和 TCP（以太网）通信。</p><p>以下是该 libmodbus 的下载链接：</p><p><span class="exturl" data-url="aHR0cHM6Ly9saWJtb2RidXMub3JnL2Rvd25sb2FkLw==">https://libmodbus.org/download/</span></p><h1 id="参考"><a class="anchor" href="#参考">#</a> 参考</h1><p><span class="exturl" data-url="aHR0cHM6Ly9tb2RidXMub3JnLw==">Modbus 主页</span></p><p><span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvTW9kYnVz">Modbus</span> - wiki</p><p><span class="exturl" data-url="aHR0cHM6Ly9yZWFscGFycy5jb20vbW9kYnVzLw==">WHAT IS MODBUS?</span></p><p>《<span class="exturl" data-url="aHR0cHM6Ly9wcm9jZXNzLmhvbmV5d2VsbC5jb20vdXMvZW4vc3VwcG9ydC9wcm9kdWN0LWRvY3VtZW50cy1kb3dubG9hZHM/c2VhcmNoPW1vZGJ1cyUyMGNvbW11bmljYXRpb24lMjBtYW51YWw=">modbus communication manual</span>》</p><p>《<span class="exturl" data-url="aHR0cHM6Ly9tb2RidXMub3JnL2RvY3MvTW9kYnVzX0FwcGxpY2F0aW9uX1Byb3RvY29sX1YxXzFiLnBkZg==">MODBUS APPLICATION PROTOCOL SPECIFICATION V1.1b</span>》</p><p>《<span class="exturl" data-url="aHR0cHM6Ly93d3cuZ2VuZXJhdGlvbnJvYm90cy5jb20vbWVkaWEvcm9ib3RlcS9tb2RidXMtbWFudWFsLnBkZg==">Modbus Fieldbus Networking</span>》</p><p>《<span class="exturl" data-url="aHR0cHM6Ly93d3cubS1zeXN0ZW0uY28uanAvbXNzZW5nbGlzaC9zZXJ2aWNlL2VtbW9kYnVzLnBkZg==">Modbus Protocol Reference Guide</span>》</p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cudmlydHVhbC1zZXJpYWwtcG9ydC5vcmcvY24vYXJ0aWNsZXMvbW9kYnVzLXJ0dS1ndWlkZS8=">Modbus RTU 通信指南</span></p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cudmlydHVhbC1zZXJpYWwtcG9ydC5vcmcvY24vYXJ0aWNsZXMvbW9kYnVzLWFzY2lpLWd1aWRlLw==">高级 Modbus ASCII 教程</span></p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cubW9kYnVzdG9vbHMuY29tL21vZGJ1cy5odG1s">modbus tools</span></p>]]></content>
      
      
      <categories>
          
          <category> modbus </category>
          
      </categories>
      
      
        <tags>
            
            <tag> history </tag>
            
            <tag> modbus </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>步进电机及丝杆</title>
      <link href="/docs/Essay/%E6%AD%A5%E8%BF%9B%E7%94%B5%E6%9C%BA%E5%8F%8A%E4%B8%9D%E6%9D%86/"/>
      <url>/docs/Essay/%E6%AD%A5%E8%BF%9B%E7%94%B5%E6%9C%BA%E5%8F%8A%E4%B8%9D%E6%9D%86/</url>
      
        <content type="html"><![CDATA[<h1 id="步进电机"><a class="anchor" href="#步进电机">#</a> 步进电机</h1><h2 id="介绍"><a class="anchor" href="#介绍">#</a> 介绍</h2><p>步进电机（英语：Stepper motor、Step motor）是直流无刷电机的一种，为具有如齿轮状突起（小齿）相锲合的定子和转子，可借由切换流向定子线圈中的电流，以一定角度逐步转动的电动机，能将电脉冲信号转换成相应角位移或线位移。</p><h3 id="a-构造上"><a class="anchor" href="#a-构造上">#</a> A、构造上</h3><p>步进电机在构造上有三种主要类型：反应式（Variable Reluctance, VR）、永磁式（Permanent Magnet, PM）和混合式（Hybrid Stepping, HS）</p><p><img data-src="15350977719637sn7os61sp.jpg" alt="" /></p><ul><li><p>反应式：也叫感应式、磁滞式或磁阻式步进电机。定子上有绕组、转子由软磁材料组成；定、转子周边均匀分布小齿和槽，通电后利用磁导的变化产生转矩。结构简单、成本低、步距角小，可达 1.2°、但动态性能差、效率低、发热大，可靠性难保证。</p><p><img data-src="2_10.png" alt="" /></p></li><li><p>永磁式：永磁式步进电机的转子用永磁材料制成，转子的极数与定子的极数相同。其特点是动态性能好、输出力矩大，但这种电机精度差，步矩角大（一般为 7.5° 或 15°）。</p><p><img data-src="3_11.png" alt="" /></p></li><li><p>混合式：也叫永磁反应式、永磁感应式步进电机，综合了反应式和永磁式的优点。其定子上有多相绕组、转子上采用永磁材料，转子和定子上均有多个小齿以提高步矩精度。其特点是输出力矩大、动态性能好，步距角小，但结构复杂、成本相对较高。</p><p><img data-src="4_10.png" alt="" /></p></li></ul><p>结构区别：</p><p><img data-src="step%20motor.jpg" alt="" /></p><h3 id="b-相数上"><a class="anchor" href="#b-相数上">#</a> B、相数上</h3><p>从定子上绕组来分类，共有二相、三相和五相等系列。目前最受欢迎的是两相混合式步进电机，约占 97% 以上的市场份额，其原因是性价比高，配上细分驱动器后效果良好。</p><p><img data-src="1535097802673o0o22s1864.jpg" alt="" /></p><ul><li><p>两相：</p><p><img data-src="5_6%20-%20%E5%89%AF%E6%9C%AC.png" alt="" /></p></li><li><p>三相：</p><p><img data-src="5_6.png" alt="" /></p></li></ul><h3 id="c-极数上"><a class="anchor" href="#c-极数上">#</a> C、极数上</h3><p>按照接线方式的不同，步进电机又可以分为单极步进电机（Unipolar Stepper Motor），和双极步进电机（Bipolar Stepper Motor）。</p><p><img data-src="153509774969411451pn716%20-%20%E5%89%AF%E6%9C%AC.jpg" alt="" /></p><ul><li><p>单极型：采用电流在一个绕组中始终沿固定方向流动的驱动方式（单极驱动）。虽然步进电机的结构较为复杂，但是由于仅需要电流 ON /OFF 的控制，因此步进电机的驱动电路较简单。</p><p><img data-src="MT1-30_f02.gif" alt="" /></p></li><li><p>双极型：采用电流在一个绕组中双向流动的驱动方式（双极驱动）。这种方式电机的结构比较简单，端子数也较少，但由于必须控制一个端子的极性，因此驱动电路较为复杂。</p><p><img data-src="MT1-30_f01.gif" alt="" /></p></li></ul><p>单极跟双极比较：</p><p>・双极连接<br />－采用电流在一个绕组中双向流动的驱动方式（双极驱动）。<br />－结构简单，但步进电机的驱动电路复杂。<br />－绕组利用率好，且可以进行精细的控制，因此步进电机能够获得很高的输出转矩。<br />－可以减小在线圈中产生的反电动势，因此可以使用耐压低的电机驱动器。</p><p>・单极连接<br />－具有中心抽头，采用电流在一个绕组中始终沿固定方向流动的驱动方式（单极驱动）。<br />－结构复杂，但步进电机的驱动电路简单。<br />－绕组利用率差，与双极连接相比，步进电机只能获得约一半的输出转矩。<br />－由于会在线圈中产生较高的反电动势，因此需要使用高耐压的电机驱动器。</p><h2 id="步进模式"><a class="anchor" href="#步进模式">#</a> 步进模式</h2><p>主要有 3 种步进模式 ：</p><ul><li>整步</li><li>半步</li><li>微步</li></ul><h3 id="a-整步"><a class="anchor" href="#a-整步">#</a> A、整步</h3><p><img data-src="full-step-mode-stepper-motor.png" alt="" /></p><p>顾名思义，就是每走一步都是取整的意思。而在整步控制上，也可分成<strong>单相通电驱动</strong>和<strong>双相通电驱动</strong>：</p><p><img data-src="11_2.png" alt="" /></p><p><img data-src="full_step_driving_1.png" alt="" /></p><p>它们之间最大的区别在于，双相通电驱动下，由于电机中流动的电流更多，产生的磁场也更强，因此扭矩也更大。</p><h3 id="b-半步"><a class="anchor" href="#b-半步">#</a> B、半步</h3><p><img data-src="half-step-operation-of-stepper-motor.png" alt="" /></p><p>半步模式属于单相通电驱动和双相通电驱动的组合，这种模式可以将步距减小一倍（旋转 45°，而不是 90°）。其唯一的缺点是电机产生的扭矩不是恒定的，当两相都通电时扭矩较高，只有一相通电时扭矩较小。</p><p><img data-src="half_step_driving.png" alt="" /></p><h3 id="c-微步"><a class="anchor" href="#c-微步">#</a> C、微步</h3><p><img data-src="modes-of-excitation-of-stepper-motor-stepper-microstepping.png" alt="" /></p><p>在微步模式下，可以看作是半步模式的增强版，因为它可以进一步减小步距，并且具有恒定的扭矩输出。这是通过控制每相流过的电流强度来实现的。最多可将电机步距角细分 256 倍，提高了低速光滑度和低速谐振效果。</p><p><img data-src="microstepping.png" alt="" /></p><h2 id="运作方式"><a class="anchor" href="#运作方式">#</a> 运作方式</h2><p>步进电机的运行一般分为三个部分：</p><ul><li>控制器</li><li>驱动器</li><li>电机马达</li></ul><p><img data-src="TIM%E6%88%AA%E5%9B%BE20211031144528.png" alt="" /></p><h3 id="a-控制器"><a class="anchor" href="#a-控制器">#</a> A、控制器</h3><p>控制器类似于人的大脑，指引着电机转动的方向以及操控着电机运转的快慢；当配合着一些控制策略，如：PID 控制、自适应控制等等，会使得其运作效果相当出色；而对于常见的控制方式有：传统方式的步进电机控制系统、基于 PLC 的步进电机控制系统、基于 DSP 的步进电机控制系统、基于 ARM 的步进电机控制系统等。</p><h3 id="b-驱动器"><a class="anchor" href="#b-驱动器">#</a> B、驱动器</h3><p>驱动器一般作两个功能：电机的精度控制和驱动运转控制。可分为恒流驱动与恒压驱动两种；恒压驱动方式因其电路构造简单，在高速领域时不易获得转矩的特性，现今已经很少使用；然而恒流驱动方式则是现在广为使用的驱动方式，在高速领域中能掌 握优良的转矩特性。</p><p>常见的驱动电路有：</p><ul><li><p>单极步进电机驱动电路</p><p><img data-src="9_5.png" alt="" /></p></li><li><p>双极步进电机驱动电路</p><p><img data-src="10_4.png" alt="" /></p></li></ul><h3 id="c-电机马达"><a class="anchor" href="#c-电机马达">#</a> C、电机马达</h3><p><img data-src="Image_506.png" alt="" /></p><p>略</p><p>&lt;br&gt;</p><h1 id="滚珠丝杆"><a class="anchor" href="#滚珠丝杆">#</a> 滚珠丝杆</h1><h2 id="种类"><a class="anchor" href="#种类">#</a> 种类</h2><p><img data-src="TIM%E6%88%AA%E5%9B%BE20211101201524.png" alt="" /></p><p><img data-src="TIM%E6%88%AA%E5%9B%BE20211101201817.png" alt="" /></p><h2 id="型号"><a class="anchor" href="#型号">#</a> 型号</h2><p><img data-src="image-20211101202146111.png" alt="image-20211101202146111" /></p><p><img data-src="image-20211101202211688.png" alt="image-20211101202211688" /></p><p><img data-src="image-20211101202236464.png" alt="image-20211101202236464" /></p><p><img data-src="image-20211101202300243.png" alt="image-20211101202300243" /></p><p><img data-src="image-20211101202323044.png" alt="image-20211101202323044" /></p><p><img data-src="image-20211101202343698.png" alt="image-20211101202343698" /></p><p><img data-src="image-20211101202416290.png" alt="image-20211101202416290" /></p><p><img data-src="image-20211101202437316.png" alt="image-20211101202437316" /></p><p><img data-src="image-20211101202459745.png" alt="image-20211101202459745" /></p><p><img data-src="image-20211101202522600.png" alt="image-20211101202522600" /></p><h1 id="传动装置"><a class="anchor" href="#传动装置">#</a> 传动装置</h1><h2 id="通电自锁"><a class="anchor" href="#通电自锁">#</a> 通电自锁</h2><p>绕组通电时步进电机具有全部的保持力矩。这就意味着步进电机可以在不使用机械刹车的情况下保持在停止位置。</p><p><img data-src="stop_position_self_hold.jpg" alt="" /></p><h2 id="刹车抱闸"><a class="anchor" href="#刹车抱闸">#</a> 刹车抱闸</h2><p>一旦电源被切断，电机自身的保持力矩丢失，电机不能在垂直操作中或施加外力作用下保持在停止位置。在提升和其它相似应用中需要使用带电磁刹车的电机。</p><p><img data-src="electromagnetic_brake_motor.jpg" alt="" /></p><p>&lt;br&gt;</p><h1 id="常用知识归纳"><a class="anchor" href="#常用知识归纳">#</a> 常用知识归纳</h1><h2 id="细分与步进数"><a class="anchor" href="#细分与步进数">#</a> 细分与步进数</h2><h3 id="a-定义"><a class="anchor" href="#a-定义">#</a> A、定义</h3><ul><li><p><strong>什么是步进数</strong></p><p>步进数，也叫脉冲数，是指步进电机转动一圈或是前进一段距离，需要电机需要接受的信号个数，单位为步。 因为电机的转动最终还是转化为直线运动，所以通常步进数指的是电机推动、拉动主轴，龙门等配件前进 1 毫米所需要的步数。</p><p>当步进数不对的后果：</p><p>例如当一台雕刻机的电机步进数不对，直接影响雕刻出来的结果大小不对。比如步进为 100 的机器，雕刻 1 毫米的直线，电机需要的信号是 100，如果设置步进数为 200，那就多走了一倍的距离，实际雕刻出来的线条就为 2 毫米了。</p></li><li><p><strong>什么是细分</strong></p><p>细分是步进电机驱动器的功能。步进电机的精度有限，一般的步进电机为 200 步走一圈，走一步转动的角度是 1.8 度。当我们需要电机走 0.9 度时，电机就没有办法了。好在步进电机驱动器，可以帮助步进电机把精度提高，把精度提高一倍，叫做半步细分，也叫 1/2 细分，此时电机一个信号脉冲就可以转动 0.9 度。再把精度提高一倍，叫 1/4 细分，走一步，相当于 0.45 度。细分都是一倍倍上去的，有 1/2, 1/4, 1/8, 1/16, 1/32 等，最大可达 256 细分。</p></li></ul><h3 id="b-应用"><a class="anchor" href="#b-应用">#</a> B、应用</h3><ul><li><p><strong>步进数计算三要素</strong></p><p>一个是电机转动一圈所需的脉冲数（原始步数）。这个一般为 200，对应的步进角为 1.8 度；当然也有其他的，像一些小电机只有 15 度，那么转一圈只需 24 个脉冲。</p><p>二是所采用的传动结构。如果用丝杆，要知道丝杆的导程，就是说丝杆转一圈时，前进的毫米数（这个稍后说）。如果是皮带轮，就要知道齿数和齿距，两个相乘得到皮带轮转一圈，皮带前进的毫米数。</p><p>三是步进电机驱动器的细分数。计算的公式是： <strong>原始脉冲数</strong> 除于 <strong>毫米数</strong> 再乘于 <strong>细分数</strong>。</p></li><li><p><strong>合理的步进数</strong></p><p>步进数越大，理论上来说精度越高；然在实际应用中，精度是由很多因素决定的，比如说齿轮可能有间隙，皮带有弹性，机架会抖动等。因此小于 0.01 精度的步进数是大部分是没有意义的。</p></li><li><p><strong>如何纠正步进参数</strong></p><p>有些不是我们自己购买的机器，我们可能不知道具体的电机，传动参数，那么还有一种调整的办法。 先随便设置一个步进数，如 200，然后在软件上控制电机走 100 毫米，如果设置对，实际走的距离就是 100 毫米，如果不对，那么有偏差，比如实际它只走了 80 毫米。那么可以用以下方式计算正确的步进数。</p><p>原理： 正确的步进数跟正确的距离之比 = 错误的步进数跟错误的距离之比</p><p>公式：正确的步进数 = 正确的距离 乘于 错误的步进数 除于 错误的距离 = 100 * 200 / 80= 250 设置步进数为 250 后，你会发现，走 100mm，就是 100mm，校对成功。</p></li></ul><h2 id="丝杆脉冲计算"><a class="anchor" href="#丝杆脉冲计算">#</a> 丝杆脉冲计算</h2><ol><li>首先认识丝杆的导程，一般来说常见的有 1205、1210、1605、1610 等这些说法，然后前两位是直径，后两位表示导程，导程 05 的丝杆就是每两个丝的间距为 5（单位：mm）。</li><li>以常规的步进电机 1.8 度 200 步进，那么走一圈就是 200 * 1.8 = 360 度</li><li>假设驱动器是 8 细分，那就是把 1.8 度再分成 8 份；所以经过驱动器的电机每一步进就是 1.8 度 / 8 = 0.225 度；最终在 8 细分下每转一圈就是 200 * 8 = 1600 步进。</li><li>当导程为 5 的丝杠，则每转一圈走 5 毫米，每一步进就是 5 / 1600 = 0.003125 毫米，这就是<strong>电机参数</strong>。如果是导程为 3 的参数，那就是 0.001875 毫米，以次类推。</li><li>用 1 除以电机参数就是<strong>脉冲当量</strong>，例如: 1 / 0.003125 = 320 步进，就是每走 1 毫米需要多少步进。</li></ol><h2 id="常规公式"><a class="anchor" href="#常规公式">#</a> 常规公式</h2><p>$ 步进电机运行步数 = 运行位移 / 导程 * 360 / 步距角 * 细分数 $</p><p>这是用步进电机接丝杆做驱动时用的，就是计算步进数的式子：各个变量如下：</p><ol><li>步进电机运行步进数 —— 这是你要计算的（也可以说是脉冲的数量），</li><li>运行位移 / 导程 —— 这是位移和导程的关系，这个除出来，就是移动这一段距离螺杆需要转几圈。</li><li>360 / 步距角 —— 因为正常步进电机是一个脉冲转一个步距角，这个算出来就是多少步电机转一圈。例如：步距角 = 7.5 度，这样算出来是 48，这就是 48 步就走一圈。</li><li>细分数 —— 一般情况这个数值是 1，但是采用了细分的方式驱动，可以控制电机一步只转半个步距角，这时细分数就为 2。合在上面式子里就会算出 96 步转一圈。</li><li>最后将 2、3、4 相乘。</li></ol><h1 id="参考"><a class="anchor" href="#参考">#</a> 参考：</h1><p><span class="exturl" data-url="aHR0cDovL25ld3MuZWV3b3JsZC5jb20uY24vbXAvVE9TSElCQS9hMjIyMTIuanNweA==">步进电机驱动器简介（上）—— 步进电机的特点、分类和工作原理</span></p><p><span class="exturl" data-url="aHR0cDovL25ld3MuZWV3b3JsZC5jb20uY24vbXAvVE9TSElCQS9hMjIzNDIuanNweA==">步进电机驱动器简介（下）—— 步进电机的控制驱动和安全技术</span></p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cubW9ub2xpdGhpY3Bvd2VyLmNuL2NuL3N0ZXBwZXItbW90b3JzLWJhc2ljcy10eXBlcy11c2Vz">步进电机基础知识：类型、用途和工作原理</span></p>]]></content>
      
      
      
        <tags>
            
            <tag> history </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kicad应用总结</title>
      <link href="/docs/EDA/Kicad%E5%BA%94%E7%94%A8%E6%80%BB%E7%BB%93/"/>
      <url>/docs/EDA/Kicad%E5%BA%94%E7%94%A8%E6%80%BB%E7%BB%93/</url>
      
        <content type="html"><![CDATA[<blockquote><p>在当前这个时代，对于 PCB 设计，有太多的 EDA 设计软件了，如：Cadence、PADS、Altium 等，但绝大多数是要授权的，而且如今人们版权意识正在提高；这对电子爱好者来说，要想 DIY 一个好东西，免不了依赖于这些设计软件，但如果有开源的、顺手的软件，那么我们更倾于应用这些软件，毕竟从版权意识上看以及投向开源社区来讲都是好的。</p></blockquote><h2 id="简介"><a class="anchor" href="#简介">#</a> 简介</h2><p>KiCad 是一个开源软件工具，用于设计电子原理图和 PCB 图形。</p><p>其官网地址：<span class="exturl" data-url="aHR0cHM6Ly93d3cua2ljYWQub3JnLw==">https://www.kicad.org/</span></p><p>各操作文档说明：<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmtpY2FkLm9yZy8=">https://docs.kicad.org/</span></p><p>由于 KiCad 是一个开源软件，所以我们可以获取到它的源码：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0tpQ2FkL2tpY2FkLXNvdXJjZS1taXJyb3I=">https://github.com/KiCad/kicad-source-mirror</span></p><p>当然，基于开源，它实现了跨平台：</p><p><img data-src="image-20210814170409099.png" alt="image-20210814170409099" /></p><p>然后在正式开篇之前，以下这些说明都是基于 V5.1.9 版本（最新版为 V5.1.10，修正了部分 Bug）；该死 V6.0 版本居然还没发布，对于想要了解 V6.0 版本的一些升级功能的，可以移到 <span class="exturl" data-url="aHR0cHM6Ly90ZWNoZXhwbG9yYXRpb25zLmNvbS9ibG9nL2tpY2FkL2tpY2FkLTYtcmV2aWV3LW5ldy1hbmQtaW1wcm92ZWQtZmVhdHVyZXMvI3QtMTYxMTAzMTU5OTI0MA==">KiCad 6 is coming!</span></p><p>&lt;br/&gt;</p><h2 id="入门"><a class="anchor" href="#入门">#</a> 入门</h2><h3 id="工作流程"><a class="anchor" href="#工作流程">#</a> 工作流程</h3><p>Kicad 有着其独特的工作流程：</p><p><img data-src="kicad_flowchart.png" alt="kicad_flowchart" /></p><p>设计一个 PCB 板，主要由两个任务来完成：绘制原理图和布置电路板。</p><h3 id="文件说明"><a class="anchor" href="#文件说明">#</a> 文件说明</h3><p>KiCad 在创建并使用时具有以下特定扩展名文件和文件夹，其主要用于原理图和电路板编辑。</p><ol><li><p>项目管理文件</p><table><thead><tr><th>文件扩展名</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td>*.pro</td><td style="text-align:left">Small file containing a few parameters for the current project, including the component library list.</td></tr></tbody></table></li><li><p>原理图编辑器文件</p><table><thead><tr><th>文件扩展名</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td>*.sch</td><td style="text-align:left">Schematic files, which do not contain the components themselves.</td></tr><tr><td>*.lib</td><td style="text-align:left">Schematic component library files, containing the component descriptions: graphic shape, pins, fields.</td></tr><tr><td>*.dcm</td><td style="text-align:left">Schematic component library documentation, containing some component descriptions: comments, keywords, reference to data sheets.</td></tr><tr><td>*_cache.lib</td><td style="text-align:left">Schematic component library cache file, containing a copy of the components used in the schematic project.</td></tr><tr><td>sym-lib-table</td><td style="text-align:left">Symbol library list (symbol library table): list of symbol libraries available in the schematic editor.</td></tr></tbody></table></li><li><p>制板编辑文件和文件夹</p><table><thead><tr><th>文件扩展名</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td>*.kicad_pcb</td><td style="text-align:left">Board file containing all info but the page layout.</td></tr><tr><td>*.pretty</td><td style="text-align:left">Footprint library folders. The folder itself is the library.</td></tr><tr><td>*.kicad_mod</td><td style="text-align:left">Footprint files, containing one footprint description each.</td></tr><tr><td>*.brd</td><td style="text-align:left">Board file in the legacy format. Can be read, but not written, by the current board editor.</td></tr><tr><td>*.mod</td><td style="text-align:left">Footprint library in the legacy format. Can be read by the footprint or the board editor, but not written.</td></tr><tr><td>fp-lib-table</td><td style="text-align:left">Footprint library list (footprint library table): list of footprint libraries (various formats) which are loaded by the board or the footprint editor or CvPcb.</td></tr></tbody></table></li><li><p>通用文件</p><table><thead><tr><th>文件扩展名</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td>*.kicad_wks</td><td style="text-align:left">Page layout description files, for people who want a worksheet with a custom look.</td></tr><tr><td>*.net</td><td style="text-align:left">Netlist file created by the schematic, and read by the board editor. This file is associated to the .cmp file, for users who prefer a separate file for the component/footprint association.</td></tr></tbody></table></li><li><p>特殊文件</p><table><thead><tr><th>文件扩展名</th><th>描述</th></tr></thead><tbody><tr><td>*.cmp</td><td>Association between components used in the schematic and their footprints. It can be created by Pcbnew and imported by Eeschema. Its purpose is to import changes from Pcbnew to Eeschema, for users who change footprints inside Pcbnew (for instance using Exchange Footprints command) and want to import these changes in schematic.</td></tr></tbody></table></li><li><p>其他文件</p><p>主要是生产生成文件</p><table><thead><tr><th>文件扩展名</th><th>描述</th></tr></thead><tbody><tr><td>*.gbr</td><td>Gerber files, for fabrication.</td></tr><tr><td>*.drl</td><td>Drill files (Excellon format), for fabrication.</td></tr><tr><td>*.pos</td><td>Position files (ASCII format), for automatic insertion machines.</td></tr><tr><td>*.rpt</td><td>Report files (ASCII format), for documentation.</td></tr><tr><td>*.ps</td><td>Plot files (Postscript), for documentation.</td></tr><tr><td>*.pdf</td><td>Plot files (PDF format), for documentation.</td></tr><tr><td>*.svg</td><td>Plot files (SVG format), for documentation.</td></tr><tr><td>*.dxf</td><td>Plot files (DXF format), for documentation.</td></tr><tr><td>*.plt</td><td>Plot files (HPGL format), for documentation.</td></tr></tbody></table></li></ol><p>&lt;br/&gt;</p><h2 id="常用快捷键"><a class="anchor" href="#常用快捷键">#</a> 常用快捷键</h2><p>首先说明一下，热键（即单个按键）直接用字母表示；组合键（是指先按住第一个键不放，然后按下第二个键，再放开这两个键。）则用 “+” 表示；多次按键（是指先按下第一个键并放开，然后按下第二个键并放开，以此类推。）则用 “ - ” 表示。</p><h3 id="常规"><a class="anchor" href="#常规">#</a> 常规</h3><table><thead><tr><th>快捷键</th><th>功能</th></tr></thead><tbody><tr><td>Ctrl + N</td><td>新建</td></tr><tr><td>Ctrl + O</td><td>打开</td></tr><tr><td>Ctrl + S</td><td>保存</td></tr><tr><td>Ctrl + Shift + S</td><td>另存为</td></tr><tr><td>Ctrl + Z</td><td>撤销</td></tr><tr><td>Ctrl + Y</td><td>重做</td></tr><tr><td>Ctrl + X</td><td>剪切</td></tr><tr><td>Ctrl + C</td><td>复制</td></tr><tr><td>Ctrl + V</td><td>粘贴</td></tr><tr><td>Ctrl + F</td><td>查找</td></tr><tr><td>F1</td><td>放大</td></tr><tr><td>F2</td><td>缩小</td></tr><tr><td>F3</td><td>缩放重绘</td></tr><tr><td>F4</td><td>缩放中心</td></tr><tr><td>Home</td><td>适合屏幕</td></tr><tr><td>E</td><td>编辑</td></tr></tbody></table><h3 id="原理图"><a class="anchor" href="#原理图">#</a> 原理图</h3><table><thead><tr><th>快捷键</th><th>功能</th></tr></thead><tbody><tr><td>C</td><td>重复的器件符号或标签</td></tr><tr><td>R</td><td>旋转</td></tr><tr><td>M</td><td>移动</td></tr><tr><td>A</td><td>添加器件符号</td></tr><tr><td>P</td><td>添加电源符号</td></tr><tr><td>X</td><td>X 轴镜像</td></tr><tr><td>Y</td><td>Y 轴镜像</td></tr><tr><td>W</td><td>画线</td></tr><tr><td>B</td><td>放置总线</td></tr><tr><td>L</td><td>添加标签</td></tr><tr><td>H</td><td>添加分层标签</td></tr><tr><td>Ctrl + L</td><td>添加全局标签</td></tr><tr><td>J</td><td>添加连接点</td></tr><tr><td>Q</td><td>添加禁止连接标志</td></tr><tr><td>F8</td><td>更新到 PCB</td></tr></tbody></table><h3 id="pcb"><a class="anchor" href="#pcb">#</a> PCB</h3><table><thead><tr><th>快捷键</th><th>功能</th></tr></thead><tbody><tr><td>O</td><td>放置封装</td></tr><tr><td>D</td><td>保持角度拖动布线</td></tr><tr><td>X</td><td>布线</td></tr><tr><td>Q</td><td>编辑线宽 / 过孔尺寸</td></tr><tr><td>L</td><td>锁定 / 解锁封装</td></tr><tr><td>V</td><td>常规状态下，切换层；布线状态下，放置过孔并切换层</td></tr><tr><td>N / Shift + N</td><td>切换网格大小</td></tr><tr><td>Ctrl + H</td><td>板层高对比模式（单层显示）</td></tr><tr><td>W / Shift + W</td><td>切换线宽</td></tr><tr><td>Ctrl</td><td>保持角度</td></tr><tr><td>/</td><td>布线轨迹切换</td></tr><tr><td>B</td><td>填充所有铜层区域</td></tr><tr><td>Ctrl + Shift + M</td><td>测量</td></tr><tr><td>Alt + 6</td><td>差分布线</td></tr><tr><td>G</td><td>调整铜层区域</td></tr></tbody></table><h3 id="库封装"><a class="anchor" href="#库封装">#</a> 库封装</h3><table><thead><tr><th>快捷键</th><th>功能</th></tr></thead><tbody><tr><td>M</td><td>移动</td></tr><tr><td>X</td><td>X 轴镜像</td></tr><tr><td>Y</td><td>Y 轴镜像</td></tr><tr><td>Instert</td><td>重复引脚</td></tr></tbody></table><p>&lt;br/&gt;</p><h2 id="常用插件"><a class="anchor" href="#常用插件">#</a> 常用插件</h2><h3 id="主题配色"><a class="anchor" href="#主题配色">#</a> 主题配色</h3><p>地址链接：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3BvaW50aGkva2ljYWQtY29sb3Itc2NoZW1lcw==">https://github.com/pointhi/kicad-color-schemes</span></p><p>例如笔者当前的主题配色为（<strong>behave-dark</strong>）：</p><p><img data-src="eeschema.png" alt="eeschema" /></p><p><img data-src="pcbnew.png" alt="pcbnew" /></p><h3 id="动态-bom"><a class="anchor" href="#动态-bom">#</a> 动态 BOM</h3><p>吾称之为最硬合交互式 BOM 操作：</p><p><img data-src="capture.gif" alt="Interactive HTML BOM" /></p><p>地址链接：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL29wZW5zY29wZXByb2plY3QvSW50ZXJhY3RpdmVIdG1sQm9t">https://github.com/openscopeproject/InteractiveHtmlBom</span></p><h3 id="泪滴生成"><a class="anchor" href="#泪滴生成">#</a> 泪滴生成</h3><p>地址链接：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL05pbHVqZVBlcmNodXQva2ljYWRfc2NyaXB0cw==">https://github.com/NilujePerchut/kicad_scripts</span></p><p>泪滴的作用，这里就不说啦，以前有讲过，然后演示：</p><p>焊盘：</p><p><img data-src="image-20210814210020179.png" alt="image-20210814210020179" /></p><p>通孔：</p><p><img data-src="image-20210814211109805.png" alt="image-20210814211109805" /></p><p>&lt;br/&gt;</p><h2 id="pcbnew中各层用途说明"><a class="anchor" href="#pcbnew中各层用途说明">#</a> Pcbnew 中各层用途说明</h2><h3 id="所支持的板层"><a class="anchor" href="#所支持的板层">#</a> 所支持的板层</h3><p>KiCAD 在 Pcbnew 中总计提供了 32 个铜层供导线走线（可覆铜），12 个固定技术层（按照正反面分为 6 对），2 个独立技术层，4 个辅助层。</p><p>在 KiCad 里 Pcbnew 的层描述中：</p><ul><li><p>F. 代表电路板上层（Front），B. 代表电路板的下层（Back）；</p></li><li><p>6 对固定技术层：Adhesive、Solder Paste、Silk Screen、Solder Mask、Courtyard、Fabrication；</p></li><li><p>2 个独立技术层：Edge Cuts、Margin；</p></li><li><p>4 个辅助层：Comments、E.C.O. 1、E.C.O. 2、Drawings；</p></li></ul><p><img data-src="image-20210814212055614.png" alt="image-20210814212055614" /></p><h3 id="层的使用说明"><a class="anchor" href="#层的使用说明">#</a> 层的使用说明</h3><h4 id="固定技术层"><a class="anchor" href="#固定技术层">#</a> 固定技术层</h4><p>KiCad 中 12 个技术层分为 6 对：上层一个，下层一个。可以通过 F. 或者 B. 来区分它们的位置。</p><table><thead><tr><th>技术层名称</th><th>功能描述</th></tr></thead><tbody><tr><td>Adhesive (F.Adhes and B.Adhes) 粘合层</td><td>用于在波峰焊前将 SMD 元件的粘合剂粘贴到电路板上的粘合层。</td></tr><tr><td>Solder Paste (F.Paste and B.Paste) 焊膏层</td><td>用于在回流焊接之前生产掩模以允许焊膏放置在 SMD 元件的焊盘上；通常这些层只有表面安装元件的焊盘。</td></tr><tr><td>Silk Screen (F.SilkS and B.SilkS) 丝印层</td><td>主要用于放置印制信息，如元件的轮廓和标注，各种注释字符等。</td></tr><tr><td>Solder Mask (F.Mask and B.Mask) 阻焊层</td><td>这两个层定义了焊接的掩模，即不过绿油的区域；所有焊盘都要出现在这两个层的其中一个层（SMD 元件）或者所有两个层（通孔元件）以防止焊盘被过油，影响导电。</td></tr><tr><td>Courtyard (F.CrtYd and B.CrtYd) 空间层</td><td>用于显示元件在 PCB 上实际占用的空间大小。</td></tr><tr><td>Fabrication (F.Fab and B.Fab) 制造层</td><td>用于辅助元件贴装；主要用于记录目的，以将信息传达给例如 PCB 制造商或组装厂。</td></tr></tbody></table><h4 id="独立技术层"><a class="anchor" href="#独立技术层">#</a> 独立技术层</h4><table><thead><tr><th>技术层名称</th><th>功能描述</th></tr></thead><tbody><tr><td>Edge.Cuts 边界层</td><td>用于绘制电路板轮廓。一般用于设置电路板的外形尺寸，数据标记，对齐标记，装配说明以及其它的机械信息。所以请仅使用此图层绘制 PCB 的轮廓。</td></tr><tr><td>Margin 电气边界层</td><td>用于定义在电路板上能够有效放置元件和布线的区域。</td></tr></tbody></table><h4 id="辅助层"><a class="anchor" href="#辅助层">#</a> 辅助层</h4><table><thead><tr><th>技术层名称</th><th>功能描述</th></tr></thead><tbody><tr><td>E.C.O. 1/2 用户自定层</td><td>2 层，用于拓展</td></tr><tr><td>Comments 注释层</td><td>描述性注释</td></tr><tr><td>Drawings 图层</td><td>图形说明</td></tr></tbody></table><p>这些层可以任意使用，它们可以是组装或布线等的说明文本，也可以是组装或加工的构造图，嘛，一般没啥用。</p><h4 id="铜层"><a class="anchor" href="#铜层">#</a> 铜层</h4><p>该层在 Kicad 中最多可拓展 32 层。</p><p>在 Pcbnew 中任何铜层的名字都是可以编辑的，我们一般使用默认的名称。当电路板是 2 层板时，只有 F.Cu 层和 B.Cu 层。当增加相应的层级数时，在 F.Cu 层和 B.Cu 层之间，将插入从上层到下层的顺序依次为 <span class="exturl" data-url="aHR0cDovL0luMS5DdQ==">In1.Cu</span>，<span class="exturl" data-url="aHR0cDovL0luMi5DdQ==">In2.Cu</span>，In3.Cu 和 In4.Cu 等的名称板层。</p><ol><li><p>通常，电路板是 2 层时，采用如下结构：</p><table><thead><tr><th>层编号</th><th>层名称</th><th>用途描述</th></tr></thead><tbody><tr><td>1</td><td><span class="exturl" data-url="aHR0cDovL0YuQ3U=">F.Cu</span></td><td>Signal</td></tr><tr><td>2</td><td><span class="exturl" data-url="aHR0cDovL0IuQ3U=">B.Cu</span></td><td>GND Plane</td></tr></tbody></table></li><li><p>通常，电路板是 4 层时，采用如下结构：</p><table><thead><tr><th>层编号</th><th>层名称</th><th>用途描述</th></tr></thead><tbody><tr><td>1</td><td><span class="exturl" data-url="aHR0cDovL0YuQ3U=">F.Cu</span></td><td>Signal</td></tr><tr><td>2</td><td><span class="exturl" data-url="aHR0cDovL0luMS5DdQ==">In1.Cu</span></td><td>GND Plane</td></tr><tr><td>3</td><td><span class="exturl" data-url="aHR0cDovL0luMi5DdQ==">In2.Cu</span></td><td>VCC Plane</td></tr><tr><td>4</td><td><span class="exturl" data-url="aHR0cDovL0IuQ3U=">B.Cu</span></td><td>Signal</td></tr></tbody></table></li><li><p>通常，电路板是 6 层时，采用如下结构：</p><table><thead><tr><th>层编号</th><th>层名称</th><th>用途描述</th></tr></thead><tbody><tr><td>1</td><td><span class="exturl" data-url="aHR0cDovL0YuQ3U=">F.Cu</span></td><td>Signal</td></tr><tr><td>2</td><td><span class="exturl" data-url="aHR0cDovL0luMS5DdQ==">In1.Cu</span></td><td>GND Plane</td></tr><tr><td>3</td><td><span class="exturl" data-url="aHR0cDovL0luMi5DdQ==">In2.Cu</span></td><td>Signal</td></tr><tr><td>4</td><td><span class="exturl" data-url="aHR0cDovL0luMy5DdQ==">In3.Cu</span></td><td>Signal</td></tr><tr><td>5</td><td><span class="exturl" data-url="aHR0cDovL0luNC5DdQ==">In4.Cu</span></td><td>VCC Plane</td></tr><tr><td>6</td><td><span class="exturl" data-url="aHR0cDovL0IuQ3U=">B.Cu</span></td><td>Signal</td></tr></tbody></table></li><li><p>通常，电路板是 8 层时，采用如下结构：</p><table><thead><tr><th>层编号</th><th>层名称</th><th>用途描述</th></tr></thead><tbody><tr><td>1</td><td><span class="exturl" data-url="aHR0cDovL0YuQ3U=">F.Cu</span></td><td>Signal</td></tr><tr><td>2</td><td><span class="exturl" data-url="aHR0cDovL0luMS5DdQ==">In1.Cu</span></td><td>GND Plane</td></tr><tr><td>3</td><td><span class="exturl" data-url="aHR0cDovL0luMi5DdQ==">In2.Cu</span></td><td>Signal</td></tr><tr><td>4</td><td><span class="exturl" data-url="aHR0cDovL0luMy5DdQ==">In3.Cu</span></td><td>VCC Plane</td></tr><tr><td>5</td><td><span class="exturl" data-url="aHR0cDovL0luNC5DdQ==">In4.Cu</span></td><td>GND Plane</td></tr><tr><td>6</td><td><span class="exturl" data-url="aHR0cDovL0luNS5DdQ==">In5.Cu</span></td><td>Signal</td></tr><tr><td>7</td><td><span class="exturl" data-url="aHR0cDovL0luNi5DdQ==">In6.Cu</span></td><td>VCC Plane</td></tr><tr><td>8</td><td><span class="exturl" data-url="aHR0cDovL0IuQ3U=">B.Cu</span></td><td>Signal</td></tr></tbody></table></li><li><p>通常，电路板是 10 层时，采用如下结构：</p><table><thead><tr><th>层编号</th><th>层名称</th><th>用途描述</th></tr></thead><tbody><tr><td>1</td><td><span class="exturl" data-url="aHR0cDovL0YuQ3U=">F.Cu</span></td><td>Signal</td></tr><tr><td>2</td><td><span class="exturl" data-url="aHR0cDovL0luMS5DdQ==">In1.Cu</span></td><td>GND Plane</td></tr><tr><td>3</td><td><span class="exturl" data-url="aHR0cDovL0luMi5DdQ==">In2.Cu</span></td><td>Signal</td></tr><tr><td>4</td><td><span class="exturl" data-url="aHR0cDovL0luMy5DdQ==">In3.Cu</span></td><td>Signal</td></tr><tr><td>5</td><td><span class="exturl" data-url="aHR0cDovL0luNC5DdQ==">In4.Cu</span></td><td>VCC Plane</td></tr><tr><td>6</td><td><span class="exturl" data-url="aHR0cDovL0luNS5DdQ==">In5.Cu</span></td><td>GND Plane</td></tr><tr><td>7</td><td><span class="exturl" data-url="aHR0cDovL0luNi5DdQ==">In6.Cu</span></td><td>Signal</td></tr><tr><td>8</td><td><span class="exturl" data-url="aHR0cDovL0luNy5DdQ==">In7.Cu</span></td><td>Signal</td></tr><tr><td>9</td><td><span class="exturl" data-url="aHR0cDovL0luOC5DdQ==">In8.Cu</span></td><td>VCC Plane</td></tr><tr><td>10</td><td><span class="exturl" data-url="aHR0cDovL0IuQ3U=">B.Cu</span></td><td>Signal</td></tr></tbody></table></li></ol><p>&lt;br/&gt;</p><h2 id="生产制造"><a class="anchor" href="#生产制造">#</a> 生产制造</h2><p>在使用本操作时，假定您已经在 KiCad 中完成了 PCB 的设计。</p><h3 id="设置-pcb原点坐标"><a class="anchor" href="#设置-pcb原点坐标">#</a> 设置 PCB 原点坐标</h3><p>选择 “菜单栏”，放置 -&gt; 钻孔和位置偏移（或者在右边菜单栏直接选择），将原点放置到 PCB 板框左下角位置，再放置【层对齐标记】到刚刚放置的原点位置。</p><p><img data-src="image-20210814222049491.png" alt="image-20210814222049491" /></p><h3 id="gerber导出"><a class="anchor" href="#gerber导出">#</a> Gerber 导出</h3><p>从菜单栏中点击绘制按键：</p><p><img data-src="image-20210814220901206.png" alt="image-20210814220901206" /></p><p>绘制 Gerber，并输出到相应文件夹：</p><p><img data-src="image-20210814221059310.png" alt="image-20210814221059310" /></p><p>绘制完后，点击旁边的 “生成钻孔文件” 进入设置生成：</p><p><img data-src="image-20210814222350241.png" alt="image-20210814222350241" /></p><p>生成文件放置到同样的文件夹，同时需要注意一下钻孔单位一般要对应 Pcbnew 中所使用的单位。</p><h3 id="bom输出"><a class="anchor" href="#bom输出">#</a> BOM 输出</h3><ol><li><p>从原理图输出</p><p>点击生成 BOM：</p><p><img data-src="image-20210814230416366.png" alt="image-20210814230416366" /></p><p>选择生成插件：</p><p><img data-src="image-20210814230521885.png" alt="image-20210814230521885" /></p><p>值得注意的是，在箭头处需要添加后缀 “<strong>.csv</strong>&quot;</p></li><li><p>从 PCB 中输出</p><p><img data-src="image-20210814231010230.png" alt="image-20210814231010230" /></p></li></ol>]]></content>
      
      
      
        <tags>
            
            <tag> EDA </tag>
            
            <tag> history </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Cortex-M3/M4/M7 故障异常分析</title>
      <link href="/docs/Essay/Cortex-M3M4M7%20%E6%95%85%E9%9A%9C%E5%BC%82%E5%B8%B8%E5%88%86%E6%9E%90/"/>
      <url>/docs/Essay/Cortex-M3M4M7%20%E6%95%85%E9%9A%9C%E5%BC%82%E5%B8%B8%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<blockquote><p>在程序开发阶段，少不了 Debug 调试，除去编程架构搭建不稳定所造成的错误外，大部分会出现或多或少的故障异常，而这些异常有可能是粗心或者对编程了解不到位所导致的 ‘ 堆栈溢出 ’ 、‘ 数组下标越界 ’ 、‘ 数学运算异常 ’ 等等；而本篇则主要以常见的进入 Hardfault 中断来进行分析错误来源。</p></blockquote><h1 id="arm-cortex-m核心"><a class="anchor" href="#arm-cortex-m核心">#</a> ARM Cortex-M 核心</h1><p><strong>ARM</strong> 架构，过去称作<strong>高级精简指令集机器</strong>（英语：Advanced RISC Machine，更早称作艾康精简指令集机器，Acorn RISC Machine），是一个精简指令集（RISC）处理器架构家族，其广泛地使用在许多嵌入式系统设计。</p><p>而对于 <strong>ARM Cortex-M</strong> 是 ARM 架构处理器核心中，低阶系列的统称，由安谋控股所授权。这组核心的特点为低成本以及高能源效率的微处理器而优化设计，已有上千万个消费性设备中有此系列的微处理器。此系列核心包括 Cortex-M0、Cortex-M0+、Cortex-M1、Cortex-M3、Cortex-M4、Cortex-M7、Cortex-M23、Cortex-M33、Cortex-M35P 和 Cortex-M55。其中 Cortex-M4 / M7 / M33 / M35P / M55 核心有浮点运算器的选项，若有浮点运算器的选项，会在型号后面说明，例如 Cortex-Mx with FPU 或 Cortex-MxF，其中 x 是核心编号。</p><p>如标题所述，其中 Cortex-M3/M4/M7 同属 <strong>ARMv7-M</strong> 架构，再细分一点，Cortex-M3 实现的是 <strong>ARMv7-M</strong> 架构，Cortex-M4 /Cortex-M7 实现的是 <strong>ARMv7E-M</strong> 架构。</p><h1 id="armv7-m和-armv7e-m架构区别"><a class="anchor" href="#armv7-m和-armv7e-m架构区别">#</a> ARMv7-M 和 ARMv7E-M 架构区别</h1><p>如果有玩过过 Cortex-M3 系列的芯片跟 Cortex-M4/M7 的芯片，或多或少都知道 Cortex-M4/M7 比 Cortex-M3 多了 <strong>DSP</strong> 跟<strong>硬件浮点运算</strong>，以下是 ARMv7E-M 架构的拓展功能介绍：</p><p><img data-src="image-20210717125804779.png" alt="image-20210717125804779" /></p><p>由于 ARMv7E-M 是 ARMv7-M 的一个拓展子集，所以以下统称 <strong>ARMv7-M</strong> 为 “ARMv7-M” 和 “ ARMv7E-M ” 的集合。</p><h1 id="arm-寄存器"><a class="anchor" href="#arm-寄存器">#</a> ARM 寄存器</h1><p><img data-src="image-20210717153032356.png" alt="image-20210717153032356" /></p><h2 id="通用寄存器r0-r12"><a class="anchor" href="#通用寄存器r0-r12">#</a> 通用寄存器（R0 - R12）</h2><p>R0-R7 被称为低组寄存器。所有指令都能访问它们。它们的字长全是 32 位，复位后的初始值是不可预料的。</p><p>R8-R12 被称为高组寄存器。这是因为只有很少的 16 位 Thumb 指令能访问它们，32 位的 thumb-2 指令则不受限制。它们也是 32 位字长，且复位后的初始值是不可预料的。</p><h2 id="堆栈指针寄存器sp"><a class="anchor" href="#堆栈指针寄存器sp">#</a> 堆栈指针寄存器（SP）</h2><p>在 ARMv7-M 架构中，共有两个堆栈指针  <code>SP_main</code>  和  <code>SP_process</code> ，有时候也会把这个堆栈指针寄存器称为 <strong>R13</strong>。</p><ul><li>主堆栈指针（MSP），或写作  <code>SP_main</code> 。这是缺省的堆栈指针，它由 OS 内核、异常服务例程以及所有需要特权访问的应用程序代码来使用。</li><li>进程堆栈指针（PSP），或写作  <code>SP_process</code> 。用于常规的应用程序代码（不处于异常服用例程中时）。</li></ul><h2 id="链接寄存器lr"><a class="anchor" href="#链接寄存器lr">#</a> 链接寄存器（LR）</h2><p>链接寄存器（LR） 主要用于在调用子程序时存储返回地址；有时候也会把这个链接寄存器称为 <strong>R14</strong>。</p><h2 id="程序计数器pc"><a class="anchor" href="#程序计数器pc">#</a> 程序计数器（PC）</h2><p>程序计数器作为 PC（或称为 R15）访问，它根据所执行指令的大小（在 ARM 状态下始终为 4 个字节）递增；并通过分支指令将目标地址加载到 PC 中。 您还可以使用数据处理指令直接加载 PC。</p><p><strong>Note：</strong> 寄存器 R0-R12、SP、LR 和 PC 被称为 Arm 核心寄存器。这些寄存器可以描述为 R0-R15。更详细的说明可以看《ARMv7-M Architecture Reference Manual》B1.4 章 Registers 部分</p><h1 id="异常定义"><a class="anchor" href="#异常定义">#</a> 异常定义</h1><h2 id="异常类型"><a class="anchor" href="#异常类型">#</a> 异常类型</h2><p><img data-src="image-20210717132436090.png" alt="image-20210717132436090" /></p><h2 id="异常更新"><a class="anchor" href="#异常更新">#</a> 异常更新</h2><p>在入栈和取向量操作完成之后，执行服务例程之前，需要更新一系列的寄存器：</p><ul><li>SP：在入栈后会把堆栈指针（PSP 或 MSP）更新到新的位置。在执行服务例程时，将由 MSP 负责对堆栈的访问。</li><li>PSR：更新 IPSR 位段（地处 PSR 的最低部分）的值为新响应的异常编号。</li><li>PC：在取向量完成后，PC 将指向服务例程的入口地址，</li><li>LR：在出入 ISR 的时候，LR 的值将得到重新的诠释，这种特殊的值称为 “EXC_RETURN”，在异常进入时由系统计算并赋给 LR，并在异常返回时使用它。EXC_RETURN 的二进制值除了最低 4 位外全为 1，而其最低 4 位则有另外的含义。</li></ul><p>以上是在响应异常时核心寄存器的变化。另一方面，在 NVIC 中，也会更新若干个相关有寄存器。例如，新响应异常的悬起位将被清除，同时其活动位将被置位。</p><h2 id="异常返回值"><a class="anchor" href="#异常返回值">#</a> 异常返回值</h2><p>在进入异常服务程序后，将自动更新 LR 的值为特殊的 EXC_RETURN。这是一个高 28 位全为 1 的值，只有 [3:0] 的值有特殊含义，如下图所示。当异常服务例程把这个值送往 PC 时，就会启动处理器的中断返回序列。因为 LR 的值是由内核自动设置的，所以只要没有特殊需求，就不要改动它。</p><p><img data-src="image-20210717203515783.png" alt="image-20210717203515783" /></p><p><img data-src="image-20210717203628501.png" alt="image-20210717203628501" /></p><h1 id="异常入口的堆栈对齐"><a class="anchor" href="#异常入口的堆栈对齐">#</a> 异常入口的堆栈对齐</h1><p>Armv7-M 架构保证堆栈指针值至少是 4 字节对齐的。 但是，某些软件标准要求堆栈指针按 8 字节对齐，并且体系结构可以强制执行这种对齐。 在配置和控制寄存器的 CCR. STKALIGN 位指示中作为异常入口的一部分，决定着处理器是将 SP 对齐到 4 个字节还是 8 个字节。 该位是由编译器决定是否为：<br />・RW，在这种情况下，它的复位值是由编译器决定的。<br />・RO，在这种情况下它是 RAO，表示 8 字节 SP 对齐。<br /><strong>Arm 不赞成实现或使用 4 字节 SP 对齐。</strong></p><p>Register --- CCR. STKALIGN bit：</p><p><img data-src="image-20210717172228588.png" alt="image-20210717172228588" /></p><p>下图显示了在异常发生时进入堆栈的信息框架，以及处理器如何在堆栈上保留一个额外的字（如果需要的话），以获得 8 字节堆栈对齐。（这里就是我们要分析地方）</p><p><img data-src="image-20210717172649123.png" alt="image-20210717172649123" /></p><h1 id="hardfault异常分析处理"><a class="anchor" href="#hardfault异常分析处理">#</a> HardFault 异常分析处理</h1><p>HardFault 是一种通用故障，它适用于所有不能被任何其他异常机制处理的故障类。通常，HardFault 用于不可恢复的系统故障，尽管这不是必需的，而且 HardFault 的某些用途可能是可恢复的。HardFault 永久启用，优先级固定为 -1。</p><h2 id="方法一先来个简单的使用第三方组件-cm_backtrace"><a class="anchor" href="#方法一先来个简单的使用第三方组件-cm_backtrace">#</a> 方法一：先来个简单的，使用第三方组件 “cm_backtrace”</h2><p>项目地址：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FybWluay9DbUJhY2t0cmFjZQ==">https://github.com/armink/CmBacktrace</span></p><p>怎么用这里就不说了，毕竟官方已经写得很清楚了，而且还有相应的 Demo 例程。</p><p>使用该方法的特点是不需要过多的关注更底层的东西，只需移植好后配置相应的功能就好了，而且它可以离线（脱离仿真器）来寻找错误点；但是前提是你的串口正常，而且还需要预留部分内存供其执行。</p><h2 id="方法二仿真情况下的-bug寻找"><a class="anchor" href="#方法二仿真情况下的-bug寻找">#</a> 方法二：仿真情况下的 bug 寻找</h2><p>如果是平常的 while 循环执行，导致挂掉了无法切换任务，那么我们可以轻松通过上下文切换寻找问题；但是在 HardFault 异常中它并不给你显示执行错误的所在地方，而是直接跳到 HardFault 中断中，这往往让我们头大。</p><p>Keil 平台的可以看：</p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cua2VpbC5jb20vYXBwbm90ZXMvZmlsZXMvYXBudDIwOS5wZGY=">https://www.keil.com/appnotes/files/apnt209.pdf</span></p><p>IAR 平台的可以看：</p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuaWFyLmNvbS9rbm93bGVkZ2Uvc3VwcG9ydC90ZWNobmljYWwtbm90ZXMvZGVidWdnZXIvZGVidWdnaW5nLWEtaGFyZGZhdWx0LW9uLWNvcnRleC1tLw==">https://www.iar.com/knowledge/support/technical-notes/debugger/debugging-a-hardfault-on-cortex-m/</span></p><p>GCC 平台的可以看：</p><p>方法三。。。</p><h2 id="方法三通过-arm-寄存器逆向推导"><a class="anchor" href="#方法三通过-arm-寄存器逆向推导">#</a> 方法三：通过 ARM 寄存器逆向推导</h2><p>使用该方法的前提是获取到第五个大点最后一张图展示的核心寄存器（R0-R3、R12、LR、PC、xPSR 以及原 SP）的数值。</p><p><strong>1、常见的核心寄存器数据获取</strong></p><p>一般地，我们会使用以下代码嵌入到 HardFault 中断中，使其在入口处打印服务异常时各核心寄存器的值：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* Exception frame without floating-point storage</pre></td></tr><tr><td data-num="2"></td><td><pre>* hard fault handler in C,</pre></td></tr><tr><td data-num="3"></td><td><pre>* with stack frame location as input parameter</pre></td></tr><tr><td data-num="4"></td><td><pre>*/</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">void</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token function">hard_fault_handler_c</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span> hardfault_args<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> stacked_r0<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> stacked_r1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> stacked_r2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> stacked_r3<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> stacked_r12<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> stacked_lr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> stacked_pc<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> stacked_psr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>   </pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment">//Exception stack frame</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    stacked_r0 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> hardfault_args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    stacked_r1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> hardfault_args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    stacked_r2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> hardfault_args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    stacked_r3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> hardfault_args<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>   </pre></td></tr><tr><td data-num="23"></td><td><pre>    stacked_r12 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> hardfault_args<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    stacked_lr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> hardfault_args<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    stacked_pc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> hardfault_args<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    stacked_psr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> hardfault_args<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>   </pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"[Hard fault handler]\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"R0 = %x\n"</span><span class="token punctuation">,</span> stacked_r0<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"R1 = %x\n"</span><span class="token punctuation">,</span> stacked_r1<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"R2 = %x\n"</span><span class="token punctuation">,</span> stacked_r2<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"R3 = %x\n"</span><span class="token punctuation">,</span> stacked_r3<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"R12 = %x\n"</span><span class="token punctuation">,</span> stacked_r12<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"LR = %x\n"</span><span class="token punctuation">,</span> stacked_lr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"PC = %x\n"</span><span class="token punctuation">,</span> stacked_pc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"PSR = %x\n"</span><span class="token punctuation">,</span> stacked_psr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">CW</span></span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"BFAR = %x\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xE000ED38</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"CFSR = %x\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xE000ED28</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"HFSR = %x\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xE000ED2C</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"DFSR = %x\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xE000ED30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"AFSR = %x\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xE000ED3C</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"BFAR = %x\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xE000ED38</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"CFSR = %x\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xE000ED28</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"HFSR = %x\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xE000ED2C</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"DFSR = %x\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xE000ED30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"AFSR = %x\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xE000ED3C</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token comment">/* The prototype shows it is a naked function - in effect this is just an</pre></td></tr><tr><td data-num="55"></td><td><pre>assembly function. */</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token keyword">void</span> <span class="token function">HardFault_Handler</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span> <span class="token keyword">__attribute__</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> naked <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre></pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token comment">/* The fault handler implementation calls a function called</pre></td></tr><tr><td data-num="59"></td><td><pre>prvGetRegistersFromStack(). */</span></pre></td></tr><tr><td data-num="60"></td><td><pre><span class="token keyword">void</span> <span class="token function">HardFault_Handler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>  <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CORTEX_M3_M4_M7</span></span></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token keyword">asm</span> <span class="token keyword">volatile</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="64"></td><td><pre>        <span class="token string">" tst lr, #4                        \n"</span> <span class="token comment">/* Check EXC_RETURN[2] */</span></pre></td></tr><tr><td data-num="65"></td><td><pre>        <span class="token string">" ite eq                            \n"</span></pre></td></tr><tr><td data-num="66"></td><td><pre>        <span class="token string">" mrseq r0, msp                     \n"</span></pre></td></tr><tr><td data-num="67"></td><td><pre>        <span class="token string">" mrsne r0, psp                     \n"</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token string">"b hard_fault_handler_c             \n"</span></pre></td></tr><tr><td data-num="69"></td><td><pre>        <span class="token operator">:</span> <span class="token comment">/* no output */</span></pre></td></tr><tr><td data-num="70"></td><td><pre>        <span class="token operator">:</span> <span class="token comment">/* no input */</span></pre></td></tr><tr><td data-num="71"></td><td><pre>        <span class="token operator">:</span> <span class="token string">"r0"</span> <span class="token comment">/* clobber */</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>  <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span></pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token keyword">asm</span> <span class="token keyword">volatile</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="75"></td><td><pre>        <span class="token string">"movs r0, #4                        \n"</span></pre></td></tr><tr><td data-num="76"></td><td><pre>        <span class="token string">"mov  r1, lr                        \n"</span></pre></td></tr><tr><td data-num="77"></td><td><pre>        <span class="token string">"tst  r0, r1                        \n"</span> <span class="token comment">/* Check EXC_RETURN[2] */</span></pre></td></tr><tr><td data-num="78"></td><td><pre>        <span class="token string">"beq 1f                             \n"</span></pre></td></tr><tr><td data-num="79"></td><td><pre>        <span class="token string">"mrs r0, psp                        \n"</span></pre></td></tr><tr><td data-num="80"></td><td><pre>        <span class="token string">"ldr r1,=hard_fault_handler_c       \n"</span></pre></td></tr><tr><td data-num="81"></td><td><pre>        <span class="token string">"bx r1                              \n"</span></pre></td></tr><tr><td data-num="82"></td><td><pre>        <span class="token string">"1:mrs r0,msp                       \n"</span></pre></td></tr><tr><td data-num="83"></td><td><pre>        <span class="token string">"ldr r1,=hard_fault_handler_c       \n"</span></pre></td></tr><tr><td data-num="84"></td><td><pre>        <span class="token operator">:</span> <span class="token comment">/* no output */</span></pre></td></tr><tr><td data-num="85"></td><td><pre>        <span class="token operator">:</span> <span class="token comment">/* no input */</span></pre></td></tr><tr><td data-num="86"></td><td><pre>        <span class="token operator">:</span> <span class="token string">"r0"</span> <span class="token comment">/* clobber */</span></pre></td></tr><tr><td data-num="87"></td><td><pre>    <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>  <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="89"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>Note：</p><ol><li><p>值得注意的是 void HardFault_Handler (void); 函数是相应的 HardFault 中断函数，不同的厂家会定义不同的名称。</p></li><li><p>对于不同的编译器，如：armcc、iar、gcc for arm 等，需要把相应的关键字替换掉（eg： <code>asm</code> 、 <code>naked</code> ）。</p><p><code>naked</code>  拓展：<span class="exturl" data-url="aHR0cHM6Ly93d3cua2VpbC5jb20vc3VwcG9ydC9tYW4vZG9jcy9hcm1jbGFuZ19yZWYvYXJtY2xhbmdfcmVmX2poZzE0NzY4OTM1NjQyOTguaHRt">https://www.keil.com/support/man/docs/armclang_ref/armclang_ref_jhg1476893564298.htm</span></p><p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8zMzkzMzg5MQ==">https://zhuanlan.zhihu.com/p/33933891</span></p></li></ol><p><strong>2、逆向定位入口</strong></p><p>如果有看过方法二的两个链接，那么就很容易理解以下的分析了：</p><ol><li>确保你能正常获取输出数据（包括但不限于仿真查看、串口打印、SWO 输出、SEGGER_RTT 输出等等）。</li><li>由于我们在第一点修改过代码，所以可以直接查看 LR 和 PC 两个的值；因为这两个的值是关键。</li><li>使用 addr2line 软件定位故障代码位置（使用方法：<span class="exturl" data-url="aHR0cHM6Ly9zb3VyY2V3YXJlLm9yZy9iaW51dGlscy9kb2NzLTIuMjcvYmludXRpbHMvYWRkcjJsaW5lLmh0bWwjYWRkcjJsaW5lJUVGJUJDJTg5">https://sourceware.org/binutils/docs-2.27/binutils/addr2line.html#addr2line）</span>addr2line 属于 GNU Binutils 组件之一，获取可以从方法一里面的 tools 文件夹里获取，也可以从  <code>安装路径\GNU Tools ARM Embedded\5.4 2016q3\bin\arm-none-eabi-addr2line.exe</code>  提取出来。</li></ol><p><strong>3、使用演示</strong></p><p>先制造一个 HardFault：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">fault_test_by_div0</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">volatile</span> <span class="token keyword">int</span> <span class="token operator">*</span> SCB_CCR <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">volatile</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token number">0xE000ED14</span><span class="token punctuation">;</span> <span class="token comment">// SCB->CCR</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">int</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token operator">*</span>SCB_CCR <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* bit4: DIV_0_TRP. */</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    x <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    z <span class="token operator">=</span> x <span class="token operator">/</span> y<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"z:%d\n"</span><span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">/************************************************</pre></td></tr><tr><td data-num="14"></td><td><pre>函数名称 ： main</pre></td></tr><tr><td data-num="15"></td><td><pre>功    能 ： 主函数入口</pre></td></tr><tr><td data-num="16"></td><td><pre>参    数 ： 无</pre></td></tr><tr><td data-num="17"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num="18"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">DEBUG</span></span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>    BaseType_t xReturn <span class="token operator">=</span> pdPASS<span class="token punctuation">;</span> <span class="token comment">/* 定义一个创建信息返回值，默认为 pdPASS */</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token function">prvSetupHardware</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token function">fault_test_by_div0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token comment">/* Start the tasks defined within this file/specific to this demo. */</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    xReturn <span class="token operator">=</span> <span class="token function">xTaskCreate</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>TaskFunction_t<span class="token punctuation">)</span>prvUser_Task<span class="token punctuation">,</span><span class="token comment">/* 任务入口函数 */</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                           <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"prvUser_Task"</span><span class="token punctuation">,</span><span class="token comment">/* 任务名字 */</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                           <span class="token punctuation">(</span><span class="token class-name">uint16_t</span><span class="token punctuation">)</span>configMINIMAL_STACK_SIZE<span class="token punctuation">,</span><span class="token comment">/* 任务栈大小 */</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                           <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token comment">/* 任务入口函数参数 */</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                           <span class="token punctuation">(</span>UBaseType_t<span class="token punctuation">)</span>mainCREATOR_TASK_PRIORITY<span class="token punctuation">,</span><span class="token comment">/* 任务的优先级 */</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                           <span class="token punctuation">(</span>TaskHandle_t <span class="token operator">*</span><span class="token punctuation">)</span>UserTaskCreate_Handle <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* 任务控制块指针 */</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>pdPASS <span class="token operator">==</span> xReturn<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token comment">/* Start the scheduler. */</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token function">vTaskStartScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token comment">/* Will only get here if there was not enough heap space to create the</pre></td></tr><tr><td data-num="45"></td><td><pre>    idle task. */</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token comment">/*----------------------------- End -----------------------------*/</span></pre></td></tr></table></figure><p>接着可以观察到程序已经跑到 HardFault_Handler 里并输出相应信息了：</p><p><img data-src="image-20210718160907873.png" alt="image-20210718160907873" /></p><p>然后利用 addr2line，执行命令  <code>arm-none-eabi-addr2line.exe -e &quot;可执行映像&quot; -a -f &quot;相应的值&quot;</code>  （注：实际命令并不需要双引号  <code>“ ”</code> ，应用可看下图）：</p><ul><li><code>-e</code>  ：指定可执行映像名称</li><li><code>-a</code>  ：显示函数地址</li><li><code>-f</code>  ：显示函数名称</li></ul><p><img data-src="image-20210718160622030.png" alt="image-20210718160622030" /></p><p>然后，对于不同的编译器，可执行映像并不一样（像 Keil 是  <code>.axf</code> 、IAR 是  <code>.out</code> ）；最后，如果细心的可以看到命令后面的两个值只有 PC 的值是对应上，第二个值并不是 LR 的值，而是其减去 4 的结果；若果你直接使用 LR 值，你会发现定位出来的下一条指令要执行的地方，至于为什么要减掉 4，是因为在 ARM 下执行指令的大小始终为 4 个字节递增，所以可以通过减掉 4，使其指向上一条内容。</p><p><img data-src="image-20210718163058462.png" alt="image-20210718163058462" /></p><p><img data-src="image-20210718163412930.png" alt="image-20210718163412930" /></p><h2 id="方法四透过最底层进行分析"><a class="anchor" href="#方法四透过最底层进行分析">#</a> 方法四：透过最底层进行分析</h2><p>这种方法不需要修改什么，在进入 HardFault_Handler 后直接分析核心寄存器。</p><p>同样的，还是先制造一个 HardFault，沿用方法三的 fault_test_by_div0 (); 函数代码，然后直到进入 HardFault_Handler 后，（注意，这里的 HardFault_Handler 中断函数并没有像方法三那样区嵌入代码，而是保持其原始的样子）：</p><p><img data-src="image-20210718204135298.png" alt="image-20210718204135298" /></p><p>接着跟上面的一样，获取各核心寄存器的值（ps：这里用的仿真查看）：</p><p><img data-src="image-20210718204626787.png" alt="image-20210718204626787" /></p><p>在这里就不是像方法三那样直接拿 LR 和 PC 这两个值来用了，必须进行层层分析：</p><ol><li><p>查看 LR 值是对应下图的哪个：</p><p><img data-src="image-20210718205017651.png" alt="image-20210718205017651" /></p><p>通过转换，-7 为 0xFFFFFFF9，然后在第四大点的第三小点有讲过 LR=0xFFFF_FFF9 时是使用 MSP，而 LR=0xFFFF_FFFD 时则使用 PSP；所以我们可以确定该返回值是被压入到主堆栈指针（MSP）中。</p></li><li><p>找到 MSP 指示的值：</p><p><img data-src="image-20210718205953987.png" alt="image-20210718205953987" /></p><p>得到该值为 0x2002ffc8。</p></li><li><p>查看该值所对应的内存块：</p><p><img data-src="image-20210718210515637.png" alt="image-20210718210515637" /></p><p>得到紫色框里的两个数据（嘿嘿，是不是很神奇，居然跟方法三的 LR、PC 值一样），可能你会疑惑，为什么是提取该地址往后第六、七个数（4 字节递增），而不是其他呢？这就看第五个大点了，它的入栈顺序以及地址位置都是有规律的，可以归纳为下图：</p><p><img data-src="image-20210718211434499.png" alt="image-20210718211434499" /></p><p>按箭头方向，顺数第六、七是不是就是 LR、PC 值啊，而这里就是旧的内容信息；所以跟方法三比较一下，其实方法三的那段嵌入代码，就是让其改变各个核心寄存器的信息内容，使其不要存储跳转到 HardFault_Handler，而是存储跳转前的数据信息。</p></li><li><p>到了这步，就是使用 addr2line 来定位，这里就不说了，方法三里面有写。</p></li></ol><h1 id="参考"><a class="anchor" href="#参考">#</a> 参考：</h1><p><span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvQVJNJUU2JTlFJUI2JUU2JUE3JThC">ARM 架构</span></p><p><span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvQVJNX0NvcnRleC1N">ARM Cortex-M</span></p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuc3QuY29tL2NvbnRlbnQvc3RfY29tL3poL2FybS0zMi1iaXQtbWljcm9jb250cm9sbGVycy9hcm0tY29ydGV4LW00Lmh0bWw=">Arm® Cortex®-M4 in a nutshell</span></p><p>&lt;&lt;ARM Cortex-M3 权威指南&gt;&gt;</p><p><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYXJtLmNvbS9kb2N1bWVudGF0aW9uL2RkaTA0MDMvZWUvP2xhbmc9ZW4=">ARMv7-M Architecture Reference Manual</span></p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cua2VpbC5jb20vc3VwcG9ydC9tYW4vZG9jcy9hcm1hc20vYXJtYXNtX2RvbTEzNTk3MzExMjQ4NDAuaHRt">Overview of the ARM Architecture</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9jb21tdW5pdHkuYXJtLmNvbS9kZXZlbG9wZXIvaXAtcHJvZHVjdHMvc3lzdGVtL2YvZW1iZWRkZWQtZm9ydW0vNDc0OS9lcnJvci1oYXJkLWZhdWx0LWhhbmRsZXI=">error: Hard Fault Handler</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9pbnRlcnJ1cHQubWVtZmF1bHQuY29tL2Jsb2cvY29ydGV4LW0tZmF1bHQtZGVidWc=">How to debug a HardFault on an ARM Cortex-M MCU</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9mb3J1bXMuZnJlZXJ0b3Mub3JnL3QvZGVidWdnaW5nLWEtYXJtLWNvcnRleC1tLWhhcmQtZmF1bHQvOTg3Mw==">Debugging a ARM Cortex-M Hard Fault</span></p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuc2VnZ2VyLmNvbS9kb3dubG9hZHMvYXBwbGljYXRpb24tbm90ZXMvQU4wMDAxNg==">Analyzing HardFaults on Cortex-M CPU</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9naXN0LmdpdGh1Yi5jb20vaG9zc2Jvc3MvZTFkMGU1MWZkYjk5YmMxMjVhYWRhYzY0ZjVkNjdmMDQ=">ARM Cortex M3: Recovering from a Hard Fault</span></p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuc2lsYWJzLmNvbS9jb21tdW5pdHkvbWN1LzMyLWJpdC9rbm93bGVkZ2UtYmFzZS5lbnRyeS5odG1sLzIwMTQvMDUvMjYvZGVidWdfYV9oYXJkZmF1bHQtNzhnYw==">Debug a HardFault</span></p>]]></content>
      
      
      
        <tags>
            
            <tag> history </tag>
            
            <tag> MCU </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>USART、I2C、SPI通信方式扫盲</title>
      <link href="/docs/%E9%80%9A%E8%AE%AF%E5%8D%8F%E8%AE%AE/USART%E3%80%81I2C%E3%80%81SPI%E9%80%9A%E4%BF%A1%E6%96%B9%E5%BC%8F%E6%89%AB%E7%9B%B2/"/>
      <url>/docs/%E9%80%9A%E8%AE%AF%E5%8D%8F%E8%AE%AE/USART%E3%80%81I2C%E3%80%81SPI%E9%80%9A%E4%BF%A1%E6%96%B9%E5%BC%8F%E6%89%AB%E7%9B%B2/</url>
      
        <content type="html"><![CDATA[<h1 id="uart-usart"><a class="anchor" href="#uart-usart">#</a> UART / USART</h1><h2 id="基本方式"><a class="anchor" href="#基本方式">#</a> 基本方式</h2><p>基本方式分并行通讯和串行通讯</p><h3 id="并行通讯"><a class="anchor" href="#并行通讯">#</a> 并行通讯</h3><p>并行通讯是指数据的每一位同时在多根数据线上发送或者接收。</p><p><img data-src="2019033119162475.png" alt="在这里插入图片描述" /></p><p>其特点是各数据位同时传送，速度快、效率高，有多少数据位就需要多少根数据线，传送成本高。在集成电路芯片的内部、同一硬件板上各部件之间等的数据传送采用并行的方式，并行通讯传送的距离通常小于 30m。</p><h3 id="串行通讯"><a class="anchor" href="#串行通讯">#</a> 串行通讯</h3><p>串行通讯指数据的每一位在同一根数据线上按照顺序逐位发生或者接收。</p><p><img data-src="2019033119171560.png" alt="在这里插入图片描述" /></p><p>其特点是数据按位顺序进行，最少只需要一根传输线即可完成，成本低，速度慢。计算机与远程终端、远程终端之间数据的传输同常都是串行的。</p><h3 id="串行通讯与并行通讯对比"><a class="anchor" href="#串行通讯与并行通讯对比">#</a> 串行通讯与并行通讯对比</h3><p>串行通讯的显著特点为：传输距离较长，可以从几米到几千米，串行通讯的通讯时钟频率较容易提高，抗干扰能力强，其信号间互相干扰可以完全忽略，但是串行通讯比并行通讯慢得多。串行通讯在数据采集和控制系统中得到了广泛的应用。</p><p><img data-src="20190331192104312.png" alt="在这里插入图片描述" /></p><h2 id="工作模式"><a class="anchor" href="#工作模式">#</a> 工作模式</h2><p>串行通讯的基础是单线传输，数据通常是在两个站点之间进行传输，按照数据流的方向分为 3 种传输模式：</p><h3 id="单工模式simplex"><a class="anchor" href="#单工模式simplex">#</a> 单工模式 (Simplex)</h3><p>单工模式的数据是单向的，通讯双方一方为发送端，另一方则固定为接收端。信息只能沿一个方向传输，使用一根数据线。</p><p><img data-src="20190331192134882.png" alt="在这里插入图片描述" /></p><p>例如收音机，只能接收发射塔给它的数据，并不能给发射塔发数据。</p><h3 id="半双工模式half-duplex"><a class="anchor" href="#半双工模式half-duplex">#</a> 半双工模式 (Half duplex)</h3><p>半双工模式是指通讯双方都具有发送器和接收器，双方既可以发射也可以接收，但是接收和发射不能同时进行。</p><p><img data-src="20190331192214823.png" alt="在这里插入图片描述" /></p><p>半双工一般用数据能在两个方向传输的场合，例如对讲机。</p><h3 id="全双工模式full-duplex"><a class="anchor" href="#全双工模式full-duplex">#</a> 全双工模式 (Full duplex)</h3><p>全双工数据通讯分别由两根可以在两个不同的站点同时发送和接收的传输线进行传输数据，通讯双方能在同一时刻进行发送和接收操作。</p><p><img data-src="20190331192246981.png" alt="在这里插入图片描述" /></p><p>全双工模式下，每一端都有发送器和接收器，有两条传输线可以在交互式应用场合中使用，信息传输效率高，例如手机。</p><h2 id="同步方式"><a class="anchor" href="#同步方式">#</a> 同步方式</h2><p>根据通讯的数据同步方式，可分为同步和异步两种，根据通讯过程中是否使用到时钟信号进行区分。</p><ul><li>在同步通讯中，收发设备上方会使用一根信号线传输信号，在时钟信号的驱动下双方进行协调，同步数据。例如，通讯中通常双方会统一规定在时钟信号的上升沿或者下降沿对数据线进行采样。</li></ul><p><img data-src="20190331192347304.png" alt="在这里插入图片描述" /></p><ul><li>在异步通讯中不使用时钟信号进行数据同步，它们直接在数据信号中穿插一些用于同步的信号位，或者将主题数据进行打包，以数据帧的格式传输数据。通讯中还需要双方规约好数据的传输速率等，以便更好地同步。</li></ul><p><img data-src="20190331192433851.png" alt="在这里插入图片描述" /></p><p><em>在同步通讯中，数据信号所传输的内容绝大部分是有效数据，而异步通讯中会则会包含数据帧的各种标识符，所以同步通讯效率高，但是同步通讯双方的时钟允许误差小，稍稍时钟出错就可能导致数据错乱，异步通讯双方的时钟允许误差较大。</em></p><h1 id="i2c"><a class="anchor" href="#i2c">#</a> I2C</h1><p>I2C 总线是 PHLIPS 公司在 20 世纪 80 年代推出的一种串行总线。具有引脚少，硬件实现简单，可扩展性强的优点。I2C 总线的另一优点是支持多主控，总线上任何能够进行发送 / 接收数据的设备都可以占领总线。当然，任意时间点上只能存在一个主控。</p><p>I2C 即是一种总线，也是一种通讯协议。在嵌入式开发中，通讯协议可分为两层：物理层和协议层。物理层是数据在物理媒介传输的保障；协议层主要是规定通讯逻辑，同一收发双方的数据打包、解包标准。打个比方，物理层相当于现实中的公路，而协议层则是交通规则，汽车可以在路上行驶，但是需要交通规则对行驶规则进行约束，不然将出现危险，也就是数据传输紊乱、丢包。</p><p>特性：</p><ul><li>2 条双向串行线，一条数据线 SDA，一条时钟线 SCL。<br />SDA 传输数据是大端传输，每次传输 8bit，即一字节。</li><li>支持多主控 (multimastering)，任何时间点只能有一个主控。</li><li>总线上每个设备都有自己的一个 addr，共 7 个 bit，广播地址全 0.</li><li>系统中可能有多个同种芯片，为此 addr 分为固定部分和可编程部份，细节视芯片而定，看 datasheet</li></ul><h2 id="物理层"><a class="anchor" href="#物理层">#</a> 物理层</h2><p>I2C 通讯系统接线图如下：<br /><img data-src="20190331192910123.png" alt="在这里插入图片描述" /><br /> (1) 在 I2C 通讯总线上，可连接多个 I2C 通讯设备，支持多个通讯主机和多个通讯从机</p><p>(2) I2C 通讯只需要两条双向总线：串行数据线 (SDA)，串行时钟线 (SCL)。数据线用于传输数据，时钟线用于同步数据收发</p><p>(3) 每个连接到总线的设备都有一个独立的地址，主机正是利用该地址对设备进行访问</p><p>(4) SDA 和 SCL 总线都需要接上上拉电阻，当总线空闲时，两根线均为高电平。连接到总线上的任意器件输出低电平都会将总线信号拉低。即各器件的 SDA 和 SCL 都是线与的关系</p><p>(5) 多个主机同时使用总线时，需要用仲裁方式决定哪个设备占用总线，不然数据将会产生冲突</p><p>(6) 串行的 8 位双向数据传输位速率在标准模式下可达 100kbps，快速模式下可达 400kbps，高速模式下可达 3.4Mbps (目前大多数 I2C 设备还不支持高速)</p><h2 id="协议层"><a class="anchor" href="#协议层">#</a> 协议层</h2><p>协议层规约了通讯的起始、停止信号，数据有效性、响应、冲裁同步、地址广播等。</p><h2 id="i2c位传输"><a class="anchor" href="#i2c位传输">#</a> I2C 位传输</h2><p>数据传输：SCL 为高电平时，SDA 线若保持稳定，那么 SDA 上是在传输数据 bit。</p><p>数据改变：SCL 为低电平时，SDA 线才能改变传输的 bit。</p><p>若 SDA 发生跳变，则用来表示一个会话的开始或结束（后面讲）</p><p><img data-src="20190331193049333.png" alt="在这里插入图片描述" /></p><h3 id="i2c开始和结束信号"><a class="anchor" href="#i2c开始和结束信号">#</a> I2C 开始和结束信号</h3><p>开始信号：SCL 为高电平时，SDA 由高电平向低电平跳变，开始传送数据。</p><p>结束信号：SCL 为高电平时，SDA 由低电平向高电平跳变，结束传送数据。</p><p><img data-src="20190331193137616.png" alt="在这里插入图片描述" /></p><h3 id="i2c应答信号"><a class="anchor" href="#i2c应答信号">#</a> I2C 应答信号</h3><p>Master 每发送完 8bit 数据后等待 Slave 的 ACK。</p><p>即在第 9 个 clock，若从 IC 发 ACK，SDA 会被拉低。</p><p>若没有 ACK，SDA 会被置高，这会引起 Master 发生 RESTART 或 STOP 流程，如下所示：</p><p><img data-src="20190331193412844.png" alt="在这里插入图片描述" /></p><h2 id="i2c写流程"><a class="anchor" href="#i2c写流程">#</a> I2C 写流程</h2><p>写寄存器的标准流程为：</p><ol><li>Master 发起 START</li><li>Master 发送 I2C addr（7bit）和 w 操作 0（1bit），等待 ACK</li><li>Slave 发送 ACK</li><li>Master 发送 reg addr（8bit），等待 ACK</li><li>Slave 发送 ACK</li><li>Master 发送 data（8bit），即要写入寄存器中的数据，等待 ACK</li><li>Slave 发送 ACK</li><li>第 6 步和第 7 步可以重复多次，即顺序写多个寄存器</li><li>Master 发起 STOP</li></ol><p><strong>写一个寄存器：</strong></p><p><img data-src="20190331193524947.png" alt="在这里插入图片描述" /></p><p><strong>写多个寄存器：</strong></p><p><img data-src="20190331193545788.png" alt="在这里插入图片描述" /></p><h2 id="i2c读流程"><a class="anchor" href="#i2c读流程">#</a> I2C 读流程</h2><p>读寄存器的标准流程为：</p><ol><li>Master 发起 START</li><li>Master 发送 I2C addr（7bit）和 W 操作 0（1bit），等待 ACK</li><li>Slave 发送 ACK</li><li>Master 发送 reg addr（8bit），等待 ACK</li><li>Slave 发送 ACK</li><li>Master 发起 START</li><li>Master 发送 I2C addr（7bit）和 R 操作 1（1bit），等待 ACK</li><li>Slave 发送 ACK</li><li>Slave 发送 data（8bit），即寄存器里的值</li><li>Master 发送 ACK</li><li>第 9 步和第 10 步可以重复多次，即顺序读多个寄存器</li><li>Master 发起 STOP</li></ol><p><strong>读一个寄存器：</strong></p><p><img data-src="20190331193648639.png" alt="在这里插入图片描述" /></p><p><strong>读多个寄存器：</strong></p><p><img data-src="20190331193700612.png" alt="在这里插入图片描述" /></p><h1 id="spi"><a class="anchor" href="#spi">#</a> SPI</h1><p>SPI（serial peripheral interface，串行外围设备接口）总线技术是 Motorola 公司推出的一种同步串行接口。它用于 CPU 与各种外围器件进行全双工、同步串行通讯。它只需四条线就可以完成 MCU 与各种外围器件的通讯，这四条线是：串行时钟线（SCK）、主机输入 / 从机输出数据线（MISO）、主机输出 / 从机输入数据线（MOSI）、低电平有效从机选择线 CS。</p><p>当 SPI 工作时，在移位寄存器中的数据逐位从输出引脚（MOSI）输出（高位在前），同时从输入引脚（MISO）接收的数据逐位移到移位寄存器（高位在前）。发送一个字节后，从另一个外围器件接收的字节数据进入移位寄存器中。即完成一个字节数据传输的实质是两个器件寄存器内容的交换。主 SPI 的时钟信号（SCK）使传输同步。其典型系统框图如下图所示。</p><p><img data-src="20190331194140132.png" alt="在这里插入图片描述" /></p><h2 id="通信原理"><a class="anchor" href="#通信原理">#</a> 通信原理</h2><p>标准的 SPI 是 4 根线，分别是 SSEL（ 片选，也写作 SCS）、 SCLK（ 时钟，也写作 SCK）、 MOSI（ 主机输出从机输入 Master Output/Slave Input） 和 MISO（ 主机输入从机输出 Master Input/Slave Output）。</p><ul><li>MOSI（SDO）：主器件数据输出，从器件数据输入。</li><li>MISO（SDI）：主器件数据输入，从器件数据输出。</li><li>SCLK ：时钟信号，由主器件产生。</li><li>CS：从器件使能信号，由主器件控制。(CS 控制芯片是否被选中，只有片选信号为实现约定的使能信号时（高电位或地电位），对此芯片的操作才有效，这也就允许同一总线上连接多个 SPI 设备。)</li></ul><p>SPI 串行传输，数据一位一位从 MSB 到 LSB 开始传输，产生相应的脉冲沿时，MOSI，MISO 才进行数据传输。</p><h2 id="工作方式"><a class="anchor" href="#工作方式">#</a> 工作方式</h2><p>SPI 有四种工作模式，取决于两个参数：（这两个参数其实就是控制了 CLK 这一根线，SPI 通信不像 UART 或 IIC 那样有专门的通信周期，有专门的通信起始信号和结束信号。所以 SPI 协议能够通过控制时钟信号线在没有数据交流的时候保持的状态，要么是高电平，要么是低电平）</p><p>1、 CPOL，clock polarity，译作时钟极性。</p><p>2、 CPHA，clock phase，译作时钟相位。</p><ul><li>CPOL 具体说明：<br />CPOL 用于定义时钟信号在空闲状态下处于高电平还是低电平，为 1 代表高电平，0 为低电平。</li><li>CPHA 具体说明：<br />首先，在同步接口中，肯定存在一个接口时钟，用来同步采样接口上数据的。CPHA 就是用来定义数据采样在第几个边沿的，数据的采样时刻。为 1 代表第二个边沿采样，为 0 代表第一个边沿采样。</li></ul><p>以上两个参数，总共有四种组合：</p><p>(1) CPOL=0，CPHA=0：此时空闲态时，SCLK 处于低电平，数据采样是在第 1 个边沿，也就是 SCLK 由<mark>低电平到高电平</mark>的跳变，所以数据采样是在上升沿，数据发送是在下降沿。</p><p>(2) CPOL=0，CPHA=1：此时空闲态时，SCLK 处于低电平，数据发送是在第 2 个边沿，也就是 SCLK 由<mark>高电平到低电平</mark>的跳变，所以数据采样是在下降沿，数据发送是在上升沿。</p><p>(3) CPOL=1，CPHA=0：此时空闲态时，SCLK 处于高电平，数据采集是在第 1 个边沿，也就是 SCLK 由<mark>高电平到低电平</mark>的跳变，所以数据采集是在下降沿，数据发送是在上升沿。</p><p>(4) CPOL=1，CPHA=1：此时空闲态时，SCLK 处于高电平，数据发送是在第 2 个边沿，也就是 SCLK 由<mark>低电平到高电平</mark>的跳变，所以数据采集是在上升沿，数据发送是在下降沿。</p><p><img data-src="20190331194425848.png" alt="在这里插入图片描述" /></p><p><em>由于 SPI 没有一个统一的规范，所以在时序上描述存在一定的差异，具体以 datasheet 为准。</em></p>]]></content>
      
      
      
        <tags>
            
            <tag> history </tag>
            
            <tag> MCU </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>常用校验算法</title>
      <link href="/docs/%E7%AE%97%E6%B3%95/%E5%B8%B8%E7%94%A8%E6%A0%A1%E9%AA%8C%E7%AE%97%E6%B3%95/"/>
      <url>/docs/%E7%AE%97%E6%B3%95/%E5%B8%B8%E7%94%A8%E6%A0%A1%E9%AA%8C%E7%AE%97%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<h1 id="奇偶校验"><a class="anchor" href="#奇偶校验">#</a> 奇偶校验</h1><h2 id="介绍"><a class="anchor" href="#介绍">#</a> 介绍</h2><p><strong>奇偶校验位</strong>（英语：<strong>parity bit</strong>）或<strong>校验比特</strong>（英语：<strong>check bit</strong>）是一个表示给定位数的二进制数中 1 的个数是奇数还是偶数的二进制数。奇偶校验位是最简单的错误检测码。</p><h2 id="原理"><a class="anchor" href="#原理">#</a> 原理</h2><p>奇偶校验常见于串口数据收发，如其名，可分为奇校验和偶校验：</p><ul><li><p><strong>奇校验：原始码流 + 校验位，其 “1” 的个数为奇数，则校验位为 “0”；若为偶数，则校验位为 “1”。</strong></p></li><li><p><strong>偶校验：原始码流 + 校验位，其 “1” 的个数为奇数，则校验位为 “1”；若为偶数，则校验位为 “0”。</strong></p></li></ul><p>奇校验是在每个字节后增加一个附加位，使得 “1” 的总数为奇数；而偶校验是在每个字节后增加一个附加位，使得 “1” 的总数为偶数。</p><p>eg：</p><p>以<strong>偶校验位</strong>来说，如果一组给定数据位中 1 的个数是奇数，补一个 bit 为 1，使得总的 1 的个数是偶数。例：0000001, 补一个 bit 为 1, 0000001<strong>1</strong>。</p><p>以<strong>奇校验位</strong>来说，如果给定一组数据位中 1 的个数是奇数，补一个 bit 为 0，使得总的 1 的个数是奇数。例：0000001, 补一个 bit 为 0, 0000001<strong>0</strong>。</p><p>其原理是：假如采用奇校验，发送端发送的一个字符编码（含校验位）中，“1” 的个数一定为奇数个，在接收端对接收字符二进制位中的 “1” 的个数进行统计，若统计出 “1” 的个数为偶数个，则意味着传输过程中有 1 位（或奇数位）发生差错。</p><h2 id="应用场景"><a class="anchor" href="#应用场景">#</a> 应用场景</h2><p>奇校验通常用于同步传输；偶校验常用于异步传输或低速传输。</p><h2 id="总结"><a class="anchor" href="#总结">#</a> 总结</h2><p>虽然这个校验应该算是校验算法中最简单的，可是它却有不足之处：</p><p>如果数据传输过程只有奇数个码位变化，那么不管变化在哪我们都可以直接判断数据传输是错误的，但是一旦有偶数位发生了变化，或者出现移位情况，我们就无法检测到错误，该方法的校错率是 50%。</p><p>eg：</p><p>奇校验 正确码流  <code>11000001</code></p><p><strong>错 1 位</strong>  <code>11000011</code>  变成了偶数个 1，能检测出错误</p><p>错 2 位  <code>11001011</code>  变成了奇数个 1，检测不出错误</p><p>出现移位  <code>11000010</code>  变成了奇数个 1，检测不出错误</p><h1 id="校验和"><a class="anchor" href="#校验和">#</a> 校验和</h1><h2 id="介绍-2"><a class="anchor" href="#介绍-2">#</a> 介绍</h2><p><strong>校验和</strong>（英语：Checksum）是冗余校验的一种形式。 它是通过错误检测方法，对经过空间（如通信）或时间（如计算机存储）所传送数据的完整性进行检查的一种简单方法。</p><h2 id="原理-2"><a class="anchor" href="#原理-2">#</a> 原理</h2><p>所谓校验和，就是将被校验数据进行 “累加”，并省略 “累加” 溢出的位，最终得到的 1 个或多个字节的结果。这个 “累加”，可以是简单的整数加法校验，又或者是反码加法校验等等。</p><p>一般常用的有：</p><p><strong>A、整数加法校验和（Integer Addition Checksum）</strong></p><p>其操作如加法运算一样，把数据值累加，最后省略高位。</p><p><img data-src="image-20210506204818892.png" alt="image-20210506204818892" /></p><p>在熟知其操作后，我们来看下误码率；假设传输数据以两个 bit 为单位，进行传输两个两位数  <code>00b</code>  和  <code>00b</code>  ，则该校验和为：00+00=00，那么在传输过程中其出现错码的数据有以下，那么来简单分析下本次校验出错的概率有多少：</p><table><thead><tr><th></th><th>00b</th><th>01b</th><th>10b</th><th>11b</th></tr></thead><tbody><tr><td><strong>00b</strong></td><td>00b</td><td>01b</td><td>10b</td><td>11b</td></tr><tr><td><strong>01b</strong></td><td>01b</td><td>10b</td><td>11b</td><td>00b</td></tr><tr><td><strong>10b</strong></td><td>10b</td><td>11b</td><td>00b</td><td>01b</td></tr><tr><td><strong>11b</strong></td><td>11b</td><td>00b</td><td>01b</td><td>00b</td></tr></tbody></table><p>如上表所示，在传输两个两位数  <code>00b</code>  和  <code>00b</code>  时，会有其余三种组合相加校验和也是 00，所以有 3/16 的概率会校验出错的，约为 1/4；但当数据的位宽越大，校验出错概率越低。</p><p><strong>B、反码加法校验和（One’s Complement Addition Checksum）</strong></p><p>反码加法校验，实际就是先进行整数加法运算，然后将进位加回来。</p><p><img data-src="image-20210506205712724.png" alt="image-20210506205712724" /></p><p>该处理相对于上一个的整数加法校验，由于需要加上进位操作，所以校验出错概率比它低一点。</p><h2 id="补充"><a class="anchor" href="#补充">#</a> 补充</h2><p>由于有讲到  <code>One’s Complement</code> ，所以在这里稍微说一下：one's-complement 和 two's-complement 以及 one's complement sum 和 two's complement sum。</p><ul><li><p><strong>one's-complement 和 two's-complement</strong></p><p>前者表示：反码，高位为符号位；后者表示：补码，高位为符号位。</p><p><img data-src="image-20210506210446251.png" alt="image-20210506210446251" /></p><p>参考：<span class="exturl" data-url="aHR0cHM6Ly90dXRvcmlhbHNwb2ludC5kZXYvY29tcHV0ZXItc2NpZW5jZS9jb21wdXRlci1vcmdhbml6YXRpb24tYW5kLWFyY2hpdGVjdHVyZS93aGF0cy1kaWZmZXJlbmNlLWJldHdlZW4tMXMtY29tcGxlbWVudC1hbmQtMnMtY29tcGxlbWVudA==">https://tutorialspoint.dev/computer-science/computer-organization-and-architecture/whats-difference-between-1s-complement-and-2s-complement</span></p></li><li><p><strong>one's complement sum 和 two's complement sum</strong></p><p>前者表示：反码加法，需要加上进位；</p><p><img data-src="image-20210506210955942.png" alt="image-20210506210955942" /></p><p>后者表示：补码加法，舍弃进位。</p><p><img data-src="image-20210506210936345.png" alt="image-20210506210936345" /></p><p>参考：《Short description of the Internet checksum》</p></li></ul><h1 id="纵向冗余校验lrc"><a class="anchor" href="#纵向冗余校验lrc">#</a> 纵向冗余校验（LRC）</h1><h2 id="介绍-3"><a class="anchor" href="#介绍-3">#</a> 介绍</h2><p>纵向冗余校验（LRC）是一种从纵向通道上的特定比特串产生校验比特的错误检测方法；而最常用的是 <strong>LRC-8</strong> 错误检验，除此之外，还有 <strong>LRC-16</strong>、 <strong>LRC-32</strong>，它们是逐字节的奇偶校验计算，通过将数据字的所有字节异或在一起，生成一个对应字节的校验数。下面以 LRC-8 为说明。</p><h2 id="原理-3"><a class="anchor" href="#原理-3">#</a> 原理</h2><p>通过对数据拆分为单字节，并利用纵向排列，把对应的字节位异或计算，最终得到一个单字节校验数：</p><p><img data-src="image-20220327112126895.png" alt="image-20220327112126895" /></p><h2 id="应用处理"><a class="anchor" href="#应用处理">#</a> 应用处理</h2><p><img data-src="image-20220327113147917.png" alt="image-20220327113147917" /></p><p>然后，它有什么特点呢：</p><ul><li>可以检测垂直切片分析中所有奇数的比特错误</li><li>无法检测垂直切片分析中偶数个比特的错误</li><li>可以检测所有 1 位错误或检测单个字节内的所有错误</li><li>可以检测多个 2 位错误，但并不是所有的 2 位错误类型都可检测到</li></ul><p>所以，最终得到的是：在检测同一垂直切片分析中的任何 2 位（bit）出现错误都是不可检测的。</p><p>最后附一张到目前介绍为止的检测概率图：</p><p><img data-src="image-20220327114446012.png" alt="image-20220327114446012" /></p><h1 id="循环冗余校验crc"><a class="anchor" href="#循环冗余校验crc">#</a> 循环冗余校验（CRC）</h1><h2 id="介绍-4"><a class="anchor" href="#介绍-4">#</a> 介绍</h2><p><strong>循环冗余校验</strong>（英语：<strong>Cyclic redundancy check</strong>，通称 “<strong>CRC</strong>”）是一种根据网络数据包或电脑文件等数据产生简短固定位数校验码的一种散列函数，主要用来检测或校验数据传输或者保存后可能出现的错误。生成的数字在传输或者存储之前计算出来并且附加到数据后面，然后接收方进行检验确定数据是否发生变化。由于本函数易于用二进制的电脑硬件使用、容易进行数学分析并且尤其善于检测传输通道干扰引起的错误，因此获得广泛应用。</p><h2 id="crc多项式"><a class="anchor" href="#crc多项式">#</a> CRC 多项式</h2><p>多项式的选择是 CRC 算法实现中最重要的部分，所选择的多项式必须有最大的错误检测能力，同时保证总体的碰撞概率最小。多项式最重要的属性是它的长度，也就是最高非零系数的数值，因为它直接影响着计算的校验和的长度。</p><p>最常用的多项式长度有</p><ul><li>9 位（CRC-8）</li><li>17 位（CRC-16）</li><li>33 位（CRC-32）</li><li>65 位（CRC-64）</li></ul><p>在构建一个新的 CRC 多项式或者改进现有的 CRC 时，一个通用的数学原则是使用满足所有模运算不可分解多项式约束条件的多项式。</p><ul><li>这种情况下的不可分解是指多项式除了 1 与它自身之外不能被任何其它的多项式整除。</li></ul><p>生成多项式的特性可以从算法的定义中推导出来：</p><ul><li>如果 CRC 有多于一个的非零系数，那么 CRC 能够检查出输入消息中的所有单数据位错误。</li><li>CRC 可以用于检测短于 2k 的输入消息中的所有双位错误，其中 k 是多项式的最长的不可分解部分的长度。</li><li>如果多项式可以被 x+1 整除，那么不存在可以被它整除的有奇数个非零系数的多项式。因此，它可以用来检测输入消息中的奇数个错误，就像奇偶校验函数那样。</li></ul><h2 id="多项式与二进制数码"><a class="anchor" href="#多项式与二进制数码">#</a> 多项式与二进制数码</h2><p>假设一个多项式为  <code>G(x)=x^4+x^3+x+1</code> ， 可转换为二进制数码  <code>11011b</code> 。</p><p>等式  <code>G(X)=x^4+x^3+x+1</code> ，可以写成  <code>G(X) = 1*(X^4) + 1*(X^3) + 0*(X^2) + 1*(X^1) + 1*(X^0)</code></p><p>总结：有幂次就为 1，没有幂次就为 0，首尾一定要是 1， 所以  <code>G(x)=x^4+x^3+x+1</code>  为  <code>11011b</code> 。</p><h2 id="crc校验核心"><a class="anchor" href="#crc校验核心">#</a> CRC 校验核心</h2><p>从上面可以看出，CRC 校验中有两个关键点：</p><ul><li>一是要预先确定一个发送端和接收端都用来作为除数的二进制比特串（或多项式）；</li><li>二是把原始帧与上面选定的除进行二进制除法运算，计算出 FCS。</li></ul><p>前者可以随机选择，也可按国际上通行的标准选择，但<strong>最高位和最低位必须均为 “1”</strong>，如在 IBM 的 SDLC（同步数据链路控制）规程中使用的 CRC-16（也就是这个除数一共是 17 位）生成多项式  <code>G（x）= x^16 + x^15 + x^2 +1</code> （对应二进制比特串为： <code>11000000000000101b</code> ）；而在 ISO HDLC（高级数据链路控制）规程、ITU 的 SDLC、X.25、V.34、V.41、V.42 等中使用 CCITT-16 生成多项式  <code>G（x）= x^16 + x^15 + x^5 +1</code> （对应二进制比特串为： <code>11000000000100001b</code> ）。</p><h2 id="校验原理"><a class="anchor" href="#校验原理">#</a> 校验原理</h2><p>CRC 算法的是以 GF (2)(2 元素伽罗瓦域) 多项式算术为数学基础的，原理看起来比较复杂、好难懂，但实际上它的主要特点和运算规则是很好理解的。</p><p>在 CRC 算法中，其运算法制使用 “模 2 算术” 运算。</p><p><strong>A、模 2 加减法运算</strong></p><ul><li><p>模 2 加法运算：1+1=0，0+1=1，0+0=0，无进位，也无借位</p></li><li><p>模 2 减法运算：1-1=0，0-1=1，1-0=1，0-0=0，无进位，也无借位</p><p>显然，加和减是一样的效果 (故在 GF (2) 多项式中一般不出现 &quot;-&quot; 号)，相当于二进制中的逻辑异或运算；也就是相互比较后，两者对应位相同则结果为 “0”，不同则结果为 “1”。</p></li></ul><p>eg：</p><p>多项式： <code>P1 = x^3 + x^2 + 1，P2 = x^3 + x^1 + 1，P1 + P2 = </code></p><pre><code>      x^3 + x^2       + 1  +   x^3       + x^1 + 1  ------------------------------            x^2 + x^1</code></pre><p>二进制： <code>P1 = 1101，P2 = 1011，P1 + P2 = </code></p><pre><code>      1 1 0 1  +   1 0 1 1  --------------        1 1 0</code></pre><p><strong>B、模 2 乘法运算</strong></p><p>GF (2) 多项式乘法和一般多项式乘法基本一样，只是在各项相加的时候按模 2 算术进行，同样的，无进位，也无借位。</p><p>eg：<br />多项式： <code>P1 = x^3 + x^2 + 1，P2 = x^3 + x^1 + 1，P1 x P2 = </code></p><pre><code>  (x^3 + x^2 + 1) (x^3 + x^1 + 1)    = (x^6 + x^4 + x^3    + x^5 + x^3 + x^2    + x^3 + x + 1)  = x^6 + x^5 + x^4 + x^3 + x^2 + x + 1</code></pre><p>二进制： <code>P1 = 1101，P2 = 1011，P1 x P2 = </code></p><pre><code>          1 1 0 1 x        1 0 1 1 --------------------      1 1 0 1    1 1 0 1  0 0 0 0 +  1 1 0 1      --------------------    1 1 1 1 1 1 1</code></pre><p><strong>C、模 2 除法运算</strong></p><p>多项式： <code>P1 = x^5 + x^2 + 1，P2 = x^3 + x^2 + x^1，P1 / P2 = </code></p><pre><code>                                      x^2   x^1                   ---------------------------------- x^3 + x^2 + x^1  ) x^5             + x^2       + 1                    x^5 + x^4 + x^3                   ----------------------------------                          x^4 + x^3 + x^2                          x^4 + x^3 + x^2                   ----------------------------------                                                  1                          </code></pre><p>二进制： <code>P1 = 100101，P2 = 1110，P1 x P2 = </code></p><pre><code>                          1 1                   ---------------          1 1 1 0 ) 1 0 0 1 0 1                    1 1 1 0                   ---------------                      1 1 1 0                      1 1 1 0                   ---------------                              1         </code></pre><p>具体来说，CRC 校验原理就是以下几个步骤：</p><p>（1）先选择（可以随机选择，也可按标准选择，具体在后面介绍）一个用于在接收端进行校验时，对接收的帧进行除法运算的除数（是二进制比较特串，通常是以多项方式表示，所以 CRC 又称多项式编码方法，这个多项式也称之为 “生成多项式”）。</p><p>（2）看所选定的除数二进制位数（假设为 k 位），然后在要发送的数据帧（假设为 m 位）后面加上 k-1 位 “0”，然后以这个加了 k-1 个 “0“的新帧（一共是 m+k-1 位）以 “模 2 除法” 方式除以上面这个除数，所得到的余数（也是二进制的比特串）就是该帧的 CRC 校验码，也称之为 FCS（帧校验序列）。但要注意的是，余数的位数一定要是比除数位数只能少一位，哪怕前面位是 0，甚至是全为 0（附带好整除时）也都不能省略。</p><p>（3）再把这个校验码附加在原数据帧（就是 m 位的帧，注意不是在后面形成的 m+k-1 位的帧）后面，构建一个新帧发送到接收端，最后在接收端再把这个新帧以 “模 2 除法” 方式除以前面选择的除数，如果没有余数，则表明该帧在传输过程中没出错，否则出现了差错。</p><p><img data-src="image-20210523204223295.png" alt="image-20210523204223295" /></p><h2 id="计算步骤"><a class="anchor" href="#计算步骤">#</a> 计算步骤</h2><p>假设以最常用的 CRC-16_MODBUS 为例：</p><p>（1）、预置 1 个 16 位的寄存器值 0xFFFF，称此寄存器为 CRC 寄存器；</p><p>（2）、把第一个 8 位二进制数据（既通讯信息帧的第一个字节）与 16 位的 CRC 寄存器的低 8 位相异或，把结果放于 CRC 寄存器，高八位数据不变；</p><p>（3）、把 CRC 寄存器的内容右移一位（朝高位）用 0 填补最高位，并检查右移后的移出位；</p><p>（4）、如果移出位为 0 则重复第 3 步（再次右移一位）；如果移出位为 1，那么将 CRC 寄存器与一多项式（A001）进行异或；</p><p>（5）、重复步骤 3 和 4，直到右移 8 次，这样整个 8 位数据全部进行了处理；</p><p>（6）、重复步骤 2 到步骤 5，进行通讯信息帧下一个字节的处理；</p><p>（7）、将该通讯信息帧所有字节按上述步骤计算完成后，得到的 16 位 CRC 寄存器的高、低字节进行交换；</p><p>（8）、最后得到的 CRC 寄存器内容即为：CRC 码。</p><p>以上计算步骤中的多项式 A001 是 8005 按位颠倒后的结果。</p><h2 id="crc-16实现代码"><a class="anchor" href="#crc-16实现代码">#</a> CRC-16 实现代码</h2><p>常用 CRC-16 码表：</p><table><thead><tr><th>Algorithm</th><th>Poly</th><th>Init</th><th>RefIn</th><th>RefOut</th><th>XorOut</th></tr></thead><tbody><tr><td>CRC16_CCITT</td><td>0x1021</td><td>0x0000</td><td>true</td><td>true</td><td>0x0000</td></tr><tr><td>CRC16_CCITT_FALSE</td><td>0x1021</td><td>0xFFFF</td><td>false</td><td>false</td><td>0x0000</td></tr><tr><td>CRC16_XMODEM</td><td>0x1021</td><td>0x0000</td><td>false</td><td>false</td><td>0x0000</td></tr><tr><td>CRC16_X25</td><td>0x1021</td><td>0xFFFF</td><td>true</td><td>true</td><td>0xFFFF</td></tr><tr><td>CRC16_MODBUS</td><td>0x8005</td><td>0xFFFF</td><td>true</td><td>true</td><td>0x0000</td></tr><tr><td>CRC16_IBM</td><td>0x8005</td><td>0x0000</td><td>true</td><td>true</td><td>0x0000</td></tr><tr><td>CRC16_MAXIM</td><td>0x8005</td><td>0x0000</td><td>true</td><td>true</td><td>0xFFFF</td></tr><tr><td>CRC16_USB</td><td>0x8005</td><td>0xFFFF</td><td>true</td><td>true</td><td>0xFFFF</td></tr></tbody></table><p>这里只演示常用的 CRC-16 的部分程序：</p><p><img data-src="image-20210506233502474.png" alt="image-20210506233502474" /></p>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> history </tag>
            
            <tag> 算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>常用设备接口类型</title>
      <link href="/docs/Essay/%E5%B8%B8%E7%94%A8%E8%AE%BE%E5%A4%87%E6%8E%A5%E5%8F%A3%E7%B1%BB%E5%9E%8B/"/>
      <url>/docs/Essay/%E5%B8%B8%E7%94%A8%E8%AE%BE%E5%A4%87%E6%8E%A5%E5%8F%A3%E7%B1%BB%E5%9E%8B/</url>
      
        <content type="html"><![CDATA[<h1 id="8p8crj45"><a class="anchor" href="#8p8crj45">#</a> 8P8C（RJ45）</h1><p><strong>8P8C</strong>，常被误称为 <strong>RJ45</strong>，嘛，现在已经被叫成 RJ45 了，是以太网使用双绞线连接时常用的一种连接器插头。</p><p>8P8C（8 position 8 contact）的意思是 8 个位置（Position，指 8 个凹槽）、8 个触点（Contact，指 8 个金属接点）。</p><h2 id="tiaeia-568"><a class="anchor" href="#tiaeia-568">#</a> TIA/EIA-568</h2><p><strong>1、接口</strong></p><p><img data-src="49657238ec115.png" alt="" /></p><p><strong>2、接线</strong></p><ol><li><p>在 <span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvVDU2OEE=">T568A</span> 中，与之相连的 8 根线分别定义为：白绿、绿；白橙、蓝；白蓝、橙；白棕、棕。</p><p>T568A 可以跟早期的 USOC 向下兼容。</p></li></ol><p><img data-src="image-20210412211638963.png" alt="image-20210412211638963" /></p><p><img data-src="772331-20200825113857619-227066782.png" alt="" /></p><ol start="2"><li>在 <span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvVDU2OEI=">T568B</span> 中，与之相连的 8 根线分别定义为：白橙、橙；白绿、蓝；白蓝、绿；白棕、棕。其中橙白色和橙色组成一对<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQyOTkyMDg0L2FydGljbGUvZGV0YWlscy8xMTQzMzc0MTk=">差分传输线</span>，绿白色和绿色组成一对差分传输线，蓝白色和蓝色组成一对差分传输线，棕白色和棕色组成一对差分传输线。</li></ol><p><img data-src="image-20210412211836739.png" alt="image-20210412211836739" /></p><p><img data-src="772331-20200825113935318-2084011331.png" alt="" /></p><h2 id="参考"><a class="anchor" href="#参考">#</a> 参考</h2><p><span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvOFA4Qw==">https://zh.wikipedia.org/wiki/8P8C</span></p><p><span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvVElBL0VJQS01Njg=">https://zh.wikipedia.org/wiki/TIA/EIA-568</span></p><h1 id="d-sub"><a class="anchor" href="#d-sub">#</a> D-Sub</h1><p><strong>D-sub</strong>（全名：D-subminiature）是常见的<span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU3JTk0JUI1JUU1JUFEJTkwJUU4JUJGJTlFJUU2JThFJUE1JUU1JTk5JUE4">电子连接器</span>，因其接头处 D 型的金属屏蔽层而得名，以往常用于电脑的电子连接器上。在刚开始发展使用 D-sub 时，D-sub 是电脑系统中最小型的连接器之一，所以称作 D-subminiature。</p><p>按照接口数量细分为 A 型（15 针），B 型（25 针），C 型（37 针），D 型（50 针），E 型（9 针）。因此常见的计算机并口即为 DB25 针的连接器。而串口则为 DE9 针连接器。</p><p><img data-src="v2-1927cce92db750c4763425cba2f8eb26_720w.png" alt="" /></p><h2 id="de-9rs232eia232"><a class="anchor" href="#de-9rs232eia232">#</a> DE-9（RS232/EIA232）</h2><p><strong>1、接口</strong></p><p><img data-src="v2-c3ce6da08a0efeacd0a473995858593e_r.jpg" alt="" /></p><p><strong>2、接线</strong></p><p><img data-src="08114701_96952.jpg" alt="" /></p><h2 id="db-25rs530eia530"><a class="anchor" href="#db-25rs530eia530">#</a> DB-25（RS530/EIA530）</h2><p><strong>1、接口</strong></p><p><img data-src="db25_connector_pins.png" alt="" /></p><p><strong>2、接线</strong></p><p><img data-src="image-20210412230409150.png" alt="image-20210412230409150" /></p><p><img data-src="image-20210412230342219.png" alt="image-20210412230342219" /></p><h2 id="dc-37rs422eia422"><a class="anchor" href="#dc-37rs422eia422">#</a> DC-37（RS422/EIA422）</h2><p><strong>1、接口</strong></p><p><img data-src="image-20210413210022102.png" alt="image-20210413210022102" /></p><p><strong>2、接线</strong></p><p><img data-src="rs422.jpg" alt="" /></p><h2 id="参考-2"><a class="anchor" href="#参考-2">#</a> 参考</h2><p><span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvRC1zdWJtaW5pYXR1cmU=">https://en.wikipedia.org/wiki/D-subminiature</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvRC1zdWJtaW5pYXR1cmVfKHByb2Zlc3Npb25hbF9hdWRpbyk=">https://en.wikipedia.org/wiki/D-subminiature_(professional_audio)</span></p><p><span class="exturl" data-url="aHR0cHM6Ly93aWtpLnNvdW5kNC5iaXovaW5kZXgucGhwL1JTMjMyX2FuZF9HUElPX0Nvbm5lY3Rvcg==">https://wiki.sound4.biz/index.php/RS232_and_GPIO_Connector</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvTnVsbF9tb2RlbQ==">https://en.wikipedia.org/wiki/Null_modem</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9lZGFjLm5ldC9wcm9kdWN0cy9kYjI1LWNvbm5lY3Rvci8xNjk=">https://edac.net/products/db25-connector/169</span></p><p><span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU1JUI5JUI2JUU4JUExJThDJUU3JUFCJUFGJUU1JThGJUEz">https://zh.wikipedia.org/wiki/ 并行端口</span></p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuYWN0aXZleHBlcnRzLmNvbS9zZXJpYWwtcG9ydC1jb21wb25lbnQvdHV0b3JpYWxzL3Bpbm91dDQyMy8=">https://www.activexperts.com/serial-port-component/tutorials/pinout423/</span></p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuY2FtaXJlc2VhcmNoLmNvbS9EYXRhX0NvbV9CYXNpY3MvUlMyMzJfc3RhbmRhcmQuaHRtbA==">https://www.camiresearch.com/Data_Com_Basics/RS232_standard.html</span></p><h1 id="usb"><a class="anchor" href="#usb">#</a> USB</h1><p><strong>通用串行总线</strong>（英语：<strong>U</strong>niversal <strong>S</strong>erial <strong>B</strong>us，缩写：<strong>USB</strong>）是连接计算机系统与外部设备的一种串口总线标准，也是一种输入输出接口的技术规范，被广泛地应用于个人电脑和移动设备等信息通讯产品，并扩展至摄影器材、数字电视（机顶盒）、游戏机等其它相关领域。</p><p>最新一代的 USB 是 USB4，传输速度为 40Gbit/s。物理接头 USB Type-A、Type-B 接头分正反面，新型 USB Type-C 接头不分正反。</p><p><img data-src="image-20210413211810297.png" alt="image-20210413211810297" /></p><p><img data-src="usb%E6%8E%A5%E5%A4%B4.png" alt="" /></p><p><img data-src="image-20210413212814207.png" alt="image-20210413212814207" /></p><h2 id="mini-usbmicro-usb"><a class="anchor" href="#mini-usbmicro-usb">#</a> Mini USB/Micro USB</h2><p><strong>1、Mini USB 接线</strong></p><p><img data-src="image-20210413214649606.png" alt="image-20210413214649606" /></p><p><strong>2、Micro USB 接线</strong></p><p><img data-src="image-20210413214724363.png" alt="image-20210413214724363" /></p><h2 id="usb-type-ausb-type-b"><a class="anchor" href="#usb-type-ausb-type-b">#</a> USB Type-A/USB Type-B</h2><p><img data-src="image-20210413215241947.png" alt="image-20210413215241947" /></p><h2 id="usb-type-c"><a class="anchor" href="#usb-type-c">#</a> USB Type-C</h2><p><strong>1、Male Connector 接线</strong></p><p><img data-src="USB_Type-C_plug_pinout.png" alt="" /></p><p><strong>2、Female Connector 接线</strong></p><p><img data-src="USB_Type-C_Receptacle_Pinout.png" alt="" /></p><h2 id="参考-3"><a class="anchor" href="#参考-3">#</a> 参考</h2><p><span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvVVNC">https://zh.wikipedia.org/wiki/USB</span></p><p><span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvVVNCX1R5cGUtQw==">https://zh.wikipedia.org/wiki/USB_Type-C</span></p><p><span class="exturl" data-url="aHR0cHM6Ly93ZWIuYXJjaGl2ZS5vcmcvd2ViLzIwMTYxMjIwMTAyOTI0L2h0dHA6Ly93d3cudXNiLm9yZy9kZXZlbG9wZXJzL3ByZXNlbnRhdGlvbnMvVVNCX0RldkRheXNfSG9uZ19Lb25nXzIwMTZfLV9VU0JfVHlwZS1DLnBkZg==">https://web.archive.org/web/20161220102924/http://www.usb.org/developers/presentations/USB_DevDays_Hong_Kong_2016_-_USB_Type-C.pdf</span></p><h1 id="更多接口类型"><a class="anchor" href="#更多接口类型">#</a> 更多接口类型</h1><p>地址：<span class="exturl" data-url="aHR0cHM6Ly9waW5vdXRzLnJ1L2Nvbm4v">https://pinouts.ru/conn/</span></p>]]></content>
      
      
      
        <tags>
            
            <tag> history </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>差分传输及其应用</title>
      <link href="/docs/Essay/%E5%B7%AE%E5%88%86%E4%BC%A0%E8%BE%93%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/"/>
      <url>/docs/Essay/%E5%B7%AE%E5%88%86%E4%BC%A0%E8%BE%93%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h1 id="差分信号跟单端信号"><a class="anchor" href="#差分信号跟单端信号">#</a> 差分信号跟单端信号</h1><p>**1、差分信号：** 指在两根线上都传输信号，这两个信号的大小相等，极性相反，这两根线上传输的信号就是差分信号（差模信号），简单的说就是在同一时间段内，通过比较这两个电压的差值来判断逻辑状态 “0” 还是 “1” 。</p><p><img data-src="aIBZja.png" alt="" /></p><p>**2、单端信号：** 也叫单端走线；即平常所看到的单一数据线进行传输，从物理角度来讲，其实并不是只有一条线，它是有参考点的，其参考点是地平面；实际是指用一根信号线和一根地线来传输信号。</p><p><img data-src="fMBNFr.png" alt="" /></p><p><strong>3、比较</strong>：</p><p>差分信号与传统的一根信号线一根地线（即单端信号传输）走线的做法相比，其优缺点分别是：</p><p>优点：</p><ol><li>抗干扰能力强。干扰噪声一般会等值、同时的被加载到两根信号线上，而其差值为 0，即，噪声对信号的逻辑意义不产生影响。</li><li>能有效抑制电磁干扰（EMI）。由于两根线靠得很近且信号幅值相等，这两根线与地线之间的耦合电磁场的幅值也相等，同时他们的信号极性相反，其电磁场将相互抵消。因此对外界的电磁干扰也小。</li><li>时序定位准确。差分信号的接收端是两根线上的信号幅值之差发生正负跳变的点，作为判断逻辑 0/1 跳变的点的。而普通单端信号以阈值电压作为信号逻辑 0/1 的跳变点，受阈值电压与信号幅值电压之比的影响较大，不适合低幅度的信号。</li></ol><p>缺点：</p><ol><li>若电路板的面积非常吃紧，单端信号可以只有一根信号线，地线走地平面，而差分信号一定要走两根等长、等宽、紧密靠近、且在同一层面的线。这样的情况常常发生在芯片的管脚间距很小，以至于只能穿过一根走线的情况下。</li></ol><p>总结：</p><table><thead><tr><th style="text-align:center"></th><th style="text-align:center">差分信号传输</th><th style="text-align:center">单端信号传输</th></tr></thead><tbody><tr><td style="text-align:center">优点</td><td style="text-align:center">抗干扰能力强</td><td style="text-align:center">简单方便</td></tr><tr><td style="text-align:center">缺点</td><td style="text-align:center">传输复杂</td><td style="text-align:center">抗干扰能力差</td></tr></tbody></table><p>&lt;br/&gt;</p><h1 id="应用场景"><a class="anchor" href="#应用场景">#</a> 应用场景</h1><p>在电路板上，差分走线必须是等长、等宽、紧密靠近、且在同一层面的两根线。与之相关的还有一个蛇形走线，蛇形线是 Layout 中经常使用的一类走线方式；其主要目的就是为了调节延时，满足系统时序设计要求。</p><p>那么，差分线，一般应用在哪里呢？</p><p>答：一般在 USB 、以太网、PCI-E、SATA、RS485、RS422、HDMI、LVDS、CAN 这些会出现。</p><p><strong>常用对表示方法有：+/- 、PM/PN 、TXN/TXP</strong></p><h2 id="1-usb总线"><a class="anchor" href="#1-usb总线">#</a> 1、USB 总线</h2><p>USB 协议定义由两根差分信号线（D+、D-）传输数字信号，若要 USB 设备工作稳定差分信号线就必须严格按照差分信号的规则来布局布线。</p><p><img data-src="IC3J8E@T%7B4CDBT72%5DJOWK7.png" alt="img" /></p><h2 id="2-ethernet以太网"><a class="anchor" href="#2-ethernet以太网">#</a> 2、Ethernet（以太网）</h2><p><img data-src="image-20210303202439474.png" alt="image-20210303202439474" /></p><p>早期的以太网，其传输速率只有几兆；像 ”1BASE5“ ─ ─ 也称为星型局域网，速率是 1Mbit/s，在商业上很失败，但同时也是双绞线的第一次使用。而一般用到双绞线的链路，基本上都是差分信号传输。</p><h2 id="3-rs485和-rs422"><a class="anchor" href="#3-rs485和-rs422">#</a> 3、RS485 和 RS422</h2><p>RS485 和 RS422 同属 UART（通用异步收发传输器）类属性，它们只是接口不同。</p><p>RS485 和 RS422 可以从以前的 <span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQyOTkyMDg0L2FydGljbGUvZGV0YWlscy8xMDAxMDc1NzA=">常用逻辑电平标准总结</span> 这篇可以了解到，它们的逻辑数据表示方式是以 AB 两线间的电压差来决定其某一时间的逻辑状态</p><h2 id="4-can-bus"><a class="anchor" href="#4-can-bus">#</a> 4、CAN Bus</h2><p>CAN 总线传输介质可以是双绞线，同轴电缆。CAN 总线适用于大数据量短距离通信或者长距离小数据量，实时性要求比较高，多主多从或者各个节点平等的现场中使用；其通信距离最远可达 10KM (速率低于 5Kbps) 速率可达到 1Mbps（通信距离小于 40M）。</p><p>可以通过之前的 <span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQyOTkyMDg0L2FydGljbGUvZGV0YWlscy8xMDY1NzkyNTI=">CAN 总线（Controller Area Network bus）协议（一）</span> 文章去了解其拓扑和设计，就知道为什么使用双绞线差分传输了。</p><h2 id="5-pci-e"><a class="anchor" href="#5-pci-e">#</a> 5、PCI-E</h2><p>这个我们在电脑上见的多了，<strong>PCI Express</strong>，简称 <strong>PCI-E</strong>，官方简称 <strong>PCIe</strong>，是计算机总线的一个重要分支，它沿用现有的 PCI 编程概念及信号标准，并且构建了更加高速的串行通信系统标准；PCIe 拥有更快的速率，所以几乎取代了以往所有的内部总线（包括 [AGP 和 PCI）。</p><p>要说为什么是差分信号传输呢，这是由于它需要那超高速的传输速率：</p><p><img data-src="image-20210303210309134.png" alt="image-20210303210309134" /></p><p>那么，我们可以想象，为什么它接口引线设计像下图这样：</p><p><img data-src="a4c259bceca04e789633c7ea964a02e6.jpeg" alt="" /></p><p>而不是像以下这样节省面积呢？</p><p><img data-src="50-pair-telephone-cable-500x500.jpg" alt="" /></p><p>嘛，这就是前面说的，差分信号一定要两根等长、等宽、紧密靠近，而且它还这么多对。。。</p><p><img data-src="image-20210303211303300.png" alt="" /></p><h2 id="6-sata"><a class="anchor" href="#6-sata">#</a> 6、SATA</h2><p>跟上面的 PCI-E 差不多，常见于计算机中，是一种电脑总线，负责主板和大容量存储装置（如 [硬盘及光驱）之间的數據传输。</p><p><img data-src="image-20210303212437783.png" alt="image-20210303212437783" /></p><h2 id="7-hdmi"><a class="anchor" href="#7-hdmi">#</a> 7、HDMI</h2><p><strong>HDMI</strong> 是一种全数字化影像和声音发送接口，可以发送未压缩的音频及视频信号。目前是被设计来取代较旧的模拟信号影音发送接口如 SCART 或 RCA 等端子的。</p><p><img data-src="image-20210303213420508.png" alt="image-20210303213420508" /></p><p>同样的也是高速率传输，而且从引脚定义上看：</p><p><img data-src="image-20210303213538865.png" alt="image-20210303213538865" /></p><p>嗯嗯，差分传输少不了了。</p><h2 id="8-lvds"><a class="anchor" href="#8-lvds">#</a> 8、LVDS</h2><p><strong>LVDS</strong> 全称 Low-Voltage Differential Signaling，即：低电压差分信号；如其名字，必是差分信号传输。</p><p>它是一种电子信号系统，可满足现今对高性能资料传输应用的需求，同时系统供电电压减低到 2 伏特，适用于分辨率高于 SVGA 的 TFT LCD 显示设备，目前已得到了广泛的应用，甚至可以嵌入到 FPGA、ASIC 或其他组件身上。也可以从 <span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQyOTkyMDg0L2FydGljbGUvZGV0YWlscy8xMDAxMDc1NzA=">常用逻辑电平标准总结</span> 这里了解其产生的原因及 PCB 常规要求。</p>]]></content>
      
      
      
        <tags>
            
            <tag> history </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>cJSON库 API解析（下）</title>
      <link href="/docs/Library/cJSON%E5%BA%93%20API%E8%A7%A3%E6%9E%90%EF%BC%88%E4%B8%8B%EF%BC%89/"/>
      <url>/docs/Library/cJSON%E5%BA%93%20API%E8%A7%A3%E6%9E%90%EF%BC%88%E4%B8%8B%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<blockquote><p>继上一篇 <a href="">cJSON 库 API 解析（上）</a>，本篇为下篇，以解析 JSON 数据包为主</p></blockquote><h1 id="json数据解析"><a class="anchor" href="#json数据解析">#</a> JSON 数据解析</h1><p>在 cJSON 里，解析 JSON 数据包，其实就是通过搜寻对应的配对关键符号或者关键字，然后一个一个剥离成为链表节点 (键值对) 的过程。</p><p>其所支持的解析函数有以下几个：</p><ul><li><p><code>CJSON_PUBLIC(cJSON *) cJSON_Parse(const char *value);</code></p></li><li><p><code>CJSON_PUBLIC(cJSON *) cJSON_ParseWithLength(const char *value, size_t buffer_length);</code></p></li><li><p><code>CJSON_PUBLIC(cJSON *) cJSON_ParseWithOpts(const char *value, const char **return_parse_end, cJSON_bool require_null_terminated);</code></p></li><li><p><code>CJSON_PUBLIC(cJSON *) cJSON_ParseWithLengthOpts(const char *value, size_t buffer_length, const char **return_parse_end, cJSON_bool require_null_terminated);</code></p></li></ul><p>但一般来说，平常我们只需要用到 cJSON_Parse (); 函数来解析。同样的，在调用了 parse 函数后，使用完毕需要调用 cJSON_Delete (); 及时释放；</p><p>整个解析过程，其核心操作函数为：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* Parser core - when encountering text, process appropriately. */</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">static</span> cJSON_bool <span class="token function">parse_value</span><span class="token punctuation">(</span>cJSON <span class="token operator">*</span> <span class="token keyword">const</span> item<span class="token punctuation">,</span> parse_buffer <span class="token operator">*</span> <span class="token keyword">const</span> input_buffer<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>input_buffer <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>input_buffer<span class="token operator">-></span>content <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">return</span> false<span class="token punctuation">;</span> <span class="token comment">/* no input */</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">/* parse the different types of values */</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">/* null */</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">can_read</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">buffer_at_offset</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"null"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        item<span class="token operator">-></span>type <span class="token operator">=</span> cJSON_NULL<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        input_buffer<span class="token operator">-></span>offset <span class="token operator">+=</span> <span class="token number">4</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">return</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment">/* false */</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">can_read</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">buffer_at_offset</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"false"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        item<span class="token operator">-></span>type <span class="token operator">=</span> cJSON_False<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        input_buffer<span class="token operator">-></span>offset <span class="token operator">+=</span> <span class="token number">5</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token keyword">return</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token comment">/* true */</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">can_read</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">buffer_at_offset</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        item<span class="token operator">-></span>type <span class="token operator">=</span> cJSON_True<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        item<span class="token operator">-></span>valueint <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        input_buffer<span class="token operator">-></span>offset <span class="token operator">+=</span> <span class="token number">4</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token keyword">return</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token comment">/* string */</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">can_access_at_index</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">buffer_at_offset</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'\"'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">parse_string</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> input_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token comment">/* number */</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">can_access_at_index</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">buffer_at_offset</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'-'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">buffer_at_offset</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">>=</span> <span class="token char">'0'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">buffer_at_offset</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token char">'9'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">parse_number</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> input_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token comment">/* array */</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">can_access_at_index</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">buffer_at_offset</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'['</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">parse_array</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> input_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token comment">/* object */</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">can_access_at_index</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">buffer_at_offset</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'&#123;'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">parse_object</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> input_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>就像前面说的，通过搜寻对应的配对关键符号或者关键字去调用不同的处理函数，然后配对校验，并把相应的数据插入到根结点，形成一个个相连的子节点链表。</p><h1 id="json数据获取"><a class="anchor" href="#json数据获取">#</a> JSON 数据获取</h1><p>当调用完上面的解析函数后，返回的是根结点指针，通过这个 cJSON 的结构指针，我们就可以利用其解析后每个节点所对应的类型，快速寻找同类型的数据，再根据提供的键（名称）来获取数据。</p><p>下面就来认识一下常用的 API 函数：</p><p><strong>1、类型校验：</strong></p><ul><li><p>False： <code>CJSON_PUBLIC(cJSON_bool) cJSON_IsFalse(const cJSON * const item);</code></p></li><li><p>True： <code>CJSON_PUBLIC(cJSON_bool) cJSON_IsTrue(const cJSON * const item);</code></p></li><li><p>布尔值： <code>CJSON_PUBLIC(cJSON_bool) cJSON_IsBool(const cJSON * const item);</code></p></li><li><p>null： <code>CJSON_PUBLIC(cJSON_bool) cJSON_IsNull(const cJSON * const item);</code></p></li><li><p>数值： <code>CJSON_PUBLIC(cJSON_bool) cJSON_IsNumber(const cJSON * const item);</code></p></li><li><p>字符串： <code>CJSON_PUBLIC(cJSON_bool) cJSON_IsString(const cJSON * const item);</code></p></li><li><p>数组： <code>CJSON_PUBLIC(cJSON_bool) cJSON_IsArray(const cJSON * const item);</code></p></li><li><p>对象： <code>CJSON_PUBLIC(cJSON_bool) cJSON_IsObject(const cJSON * const item);</code></p></li></ul><p>不难发现，这些函数都是用于判断参数的类型的，因此返回值只有 true（真）和 false（假）；用的比较多的是 cJSON_IsFalse (); 和 cJSON_IsTrue ();，直接判断 JSON 数据包里的布尔变量。</p><p><strong>2、信息提取：</strong></p><ul><li><p>数组： <code>CJSON_PUBLIC(cJSON *) cJSON_GetArrayItem(const cJSON *array, int index);</code></p></li><li><p>对象： <code>CJSON_PUBLIC(cJSON *) cJSON_GetObjectItem(const cJSON * const object, const char * const string);</code></p></li><li><p>对象（名称区分大小写）： <code>CJSON_PUBLIC(cJSON *) cJSON_GetObjectItemCaseSensitive(const cJSON * const object, const char * const string);</code></p></li></ul><p><strong>3、校验类型并返回值：</strong></p><ul><li><p>字符串： <code>CJSON_PUBLIC(char *) cJSON_GetStringValue(const cJSON * const item);</code></p></li><li><p>数值： <code>CJSON_PUBLIC(double) cJSON_GetNumberValue(const cJSON * const item);</code></p></li></ul><p><strong>4、获取项目数：</strong></p><ul><li><code>CJSON_PUBLIC(int) cJSON_GetArraySize(const cJSON *array);</code></li></ul><p><strong>5、错误分析：</strong></p><ul><li><code>CJSON_PUBLIC(const char *) cJSON_GetErrorPtr(void);</code></li></ul><h1 id="示例"><a class="anchor" href="#示例">#</a> 示例</h1><p>以上篇打印的封装的数据信息为例；</p><p>原封装的 JSON 数据包：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"cJSON"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"v1.7.14"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token property">"file"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"cJSON.c"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">75.8</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token property">"unit"</span><span class="token operator">:</span> <span class="token string">"KB"</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token property">"released"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token number">2020</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token string">"Sep"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token number">3</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token property">"latest"</span><span class="token operator">:</span> <span class="token boolean">true</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>随后解析打印出来的信息：</p><figure class="highlight tex"><figcaption data-lang="TeX"></figcaption><table><tr><td data-num="1"></td><td><pre>name:cJSON</pre></td></tr><tr><td data-num="2"></td><td><pre>version:v1.7.14</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>file:cJSON.c</pre></td></tr><tr><td data-num="5"></td><td><pre>size:75.800000</pre></td></tr><tr><td data-num="6"></td><td><pre>unit:KB</pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>released date:2020 Sep 3</pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>Is it necessary to update?</pre></td></tr><tr><td data-num="11"></td><td><pre>not update</pre></td></tr></table></figure><p>代码执行（沿用上篇的封装代码）：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"cJSON.h"</span></span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    cJSON <span class="token operator">*</span>jtest <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    cJSON <span class="token operator">*</span>jfile <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    cJSON <span class="token operator">*</span>jissue <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    cJSON <span class="token operator">*</span>jyear <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    cJSON <span class="token operator">*</span>jmonth <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    cJSON <span class="token operator">*</span>jday <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment">/* 创建一个 JSON 格式的主对象 (主链表头结点) */</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    jtest <span class="token operator">=</span> <span class="token function">cJSON_CreateObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">/* 追加字符串类型的 JSON 数据到主对象中 (添加一个链表节点) */</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token function">cJSON_AddStringToObject</span><span class="token punctuation">(</span>jtest<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"cJSON"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token function">cJSON_AddStringToObject</span><span class="token punctuation">(</span>jtest<span class="token punctuation">,</span> <span class="token string">"version"</span><span class="token punctuation">,</span> <span class="token string">"v1.7.14"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token comment">/* 追加一个对象到主对象中 (添加一个链表节点) */</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    jfile <span class="token operator">=</span> <span class="token function">cJSON_AddObjectToObject</span><span class="token punctuation">(</span>jtest<span class="token punctuation">,</span> <span class="token string">"file"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token comment">/* 往追加的对象添加对应的值 */</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token function">cJSON_AddStringToObject</span><span class="token punctuation">(</span>jfile<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"cJSON.c"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token function">cJSON_AddNumberToObject</span><span class="token punctuation">(</span>jfile<span class="token punctuation">,</span> <span class="token string">"size"</span><span class="token punctuation">,</span> <span class="token number">75.8</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token function">cJSON_AddStringToObject</span><span class="token punctuation">(</span>jfile<span class="token punctuation">,</span> <span class="token string">"unit"</span><span class="token punctuation">,</span> <span class="token string">"KB"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token comment">/* 创建一个 JSON 格式的数组 (另一个链表头结点) */</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    jissue <span class="token operator">=</span> <span class="token function">cJSON_CreateArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token comment">/* 创建相应的值并把这些值添加到数组里 */</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    jyear <span class="token operator">=</span> <span class="token function">cJSON_CreateNumber</span><span class="token punctuation">(</span><span class="token number">2020</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token function">cJSON_AddItemToArray</span><span class="token punctuation">(</span>jissue<span class="token punctuation">,</span> jyear<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    jmonth <span class="token operator">=</span> <span class="token function">cJSON_CreateString</span><span class="token punctuation">(</span><span class="token string">"Sep"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token function">cJSON_AddItemToArray</span><span class="token punctuation">(</span>jissue<span class="token punctuation">,</span> jmonth<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    jday <span class="token operator">=</span> <span class="token function">cJSON_CreateNumber</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token function">cJSON_AddItemToArray</span><span class="token punctuation">(</span>jissue<span class="token punctuation">,</span> jday<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token comment">/* 把已经填好的数据的数组插入到主对象中 */</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token function">cJSON_AddItemToObject</span><span class="token punctuation">(</span>jtest<span class="token punctuation">,</span> <span class="token string">"released"</span><span class="token punctuation">,</span> jissue<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token comment">/* 追加一个值为 True 的布尔类型的 JSON 数据到主对象中 (添加一个链表节点) */</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token function">cJSON_AddTrueToObject</span><span class="token punctuation">(</span>jtest<span class="token punctuation">,</span> <span class="token string">"latest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token comment">/* 打印 JSON 对象 (整条链表) 的所有数据 */</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    str <span class="token operator">=</span> <span class="token function">cJSON_Print</span><span class="token punctuation">(</span>jtest<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n\n"</span><span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    </pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token comment">/* 释放整条链表的内存数据 */</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token function">cJSON_Delete</span><span class="token punctuation">(</span>jtest<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token comment">/* ------------------------- 以上为上篇的封装代码 ------------------------- */</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token comment">/* ------------------------- 数据保留并初始化变量 ------------------------- */</span>    </pre></td></tr><tr><td data-num="57"></td><td><pre>    jtest <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    jfile <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    jissue <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    jyear <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    jmonth <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    jday <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    cJSON <span class="token operator">*</span>jtemp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    </pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token comment">/* ------------------------- 以下为本篇的解析代码 ------------------------- */</span></pre></td></tr><tr><td data-num="66"></td><td><pre></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token comment">/* 解析整段 JSON 数据 */</span></pre></td></tr><tr><td data-num="68"></td><td><pre>    jtest <span class="token operator">=</span> <span class="token function">cJSON_Parse</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>jtest <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parse fail.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="74"></td><td><pre></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token comment">/* 依次根据名称提取 JSON 数据（键值对） */</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    jtemp <span class="token operator">=</span> <span class="token function">cJSON_GetObjectItem</span><span class="token punctuation">(</span>jtest<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"name:%s\n"</span><span class="token punctuation">,</span> jtemp<span class="token operator">-></span>valuestring<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    jtemp <span class="token operator">=</span> <span class="token function">cJSON_GetObjectItem</span><span class="token punctuation">(</span>jtest<span class="token punctuation">,</span> <span class="token string">"version"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"version:%s\n\n"</span><span class="token punctuation">,</span> jtemp<span class="token operator">-></span>valuestring<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre></pre></td></tr><tr><td data-num="81"></td><td><pre>    <span class="token comment">/* 解析嵌套的 JSON 对象 */</span></pre></td></tr><tr><td data-num="82"></td><td><pre>    jfile <span class="token operator">=</span> <span class="token function">cJSON_GetObjectItem</span><span class="token punctuation">(</span>jtest<span class="token punctuation">,</span> <span class="token string">"file"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>    jtemp <span class="token operator">=</span> <span class="token function">cJSON_GetObjectItem</span><span class="token punctuation">(</span>jfile<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"file:%s\n"</span><span class="token punctuation">,</span> jtemp<span class="token operator">-></span>valuestring<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>    jtemp <span class="token operator">=</span> <span class="token function">cJSON_GetObjectItem</span><span class="token punctuation">(</span>jfile<span class="token punctuation">,</span> <span class="token string">"size"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"size:%f\n"</span><span class="token punctuation">,</span> jtemp<span class="token operator">-></span>valuedouble<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>    jtemp <span class="token operator">=</span> <span class="token function">cJSON_GetObjectItem</span><span class="token punctuation">(</span>jfile<span class="token punctuation">,</span> <span class="token string">"unit"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"unit:%s\n\n"</span><span class="token punctuation">,</span> jtemp<span class="token operator">-></span>valuestring<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre></pre></td></tr><tr><td data-num="90"></td><td><pre>    <span class="token comment">/* 解析嵌套的 JSON 数组 */</span></pre></td></tr><tr><td data-num="91"></td><td><pre>    jissue <span class="token operator">=</span> <span class="token function">cJSON_GetObjectItem</span><span class="token punctuation">(</span>jtest<span class="token punctuation">,</span> <span class="token string">"released"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>    jyear <span class="token operator">=</span> <span class="token function">cJSON_GetArrayItem</span><span class="token punctuation">(</span>jissue<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>    jmonth <span class="token operator">=</span> <span class="token function">cJSON_GetArrayItem</span><span class="token punctuation">(</span>jissue<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>    jday <span class="token operator">=</span> <span class="token function">cJSON_GetArrayItem</span><span class="token punctuation">(</span>jissue<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"released date:%d "</span><span class="token punctuation">,</span> jyear<span class="token operator">-></span>valueint<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s "</span><span class="token punctuation">,</span> jmonth<span class="token operator">-></span>valuestring<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n\n"</span><span class="token punctuation">,</span> jday<span class="token operator">-></span>valueint<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="98"></td><td><pre></pre></td></tr><tr><td data-num="99"></td><td><pre>    <span class="token comment">/* 解析布尔型数据 */</span></pre></td></tr><tr><td data-num="100"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Is it necessary to update?\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>    jtemp <span class="token operator">=</span> <span class="token function">cJSON_GetObjectItem</span><span class="token punctuation">(</span>jtest<span class="token punctuation">,</span> <span class="token string">"latest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="102"></td><td><pre>    <span class="token function">cJSON_IsTrue</span><span class="token punctuation">(</span>jtemp<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"not update"</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"update"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="103"></td><td><pre>    <span class="token comment">/* 等同于 cJSON_IsFalse (jtemp) ? printf ("update") : printf ("not update"); */</span></pre></td></tr><tr><td data-num="104"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n\r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="105"></td><td><pre></pre></td></tr><tr><td data-num="106"></td><td><pre>    <span class="token function">cJSON_Delete</span><span class="token punctuation">(</span>jtest<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="107"></td><td><pre>    </pre></td></tr><tr><td data-num="108"></td><td><pre>    <span class="token function">cJSON_free</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="109"></td><td><pre></pre></td></tr><tr><td data-num="110"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="111"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>实例：</p><p><img data-src="image-20210131224342050.png" alt="image-20210131224342050" /></p><h1 id="内存管理"><a class="anchor" href="#内存管理">#</a> 内存管理</h1><p><strong>1、cJSON_Delete (); 函数</strong></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* Delete a cJSON structure. */</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">CJSON_PUBLIC</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token function">cJSON_Delete</span><span class="token punctuation">(</span>cJSON <span class="token operator">*</span>item<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    cJSON <span class="token operator">*</span>next <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span>item <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        next <span class="token operator">=</span> item<span class="token operator">-></span>next<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>item<span class="token operator">-></span>type <span class="token operator">&amp;</span> cJSON_IsReference<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>item<span class="token operator">-></span>child <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token function">cJSON_Delete</span><span class="token punctuation">(</span>item<span class="token operator">-></span>child<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>item<span class="token operator">-></span>type <span class="token operator">&amp;</span> cJSON_IsReference<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>item<span class="token operator">-></span>valuestring <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            global_hooks<span class="token punctuation">.</span><span class="token function">deallocate</span><span class="token punctuation">(</span>item<span class="token operator">-></span>valuestring<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>item<span class="token operator">-></span>type <span class="token operator">&amp;</span> cJSON_StringIsConst<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>item<span class="token operator">-></span>string <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            global_hooks<span class="token punctuation">.</span><span class="token function">deallocate</span><span class="token punctuation">(</span>item<span class="token operator">-></span>string<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        global_hooks<span class="token punctuation">.</span><span class="token function">deallocate</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        item <span class="token operator">=</span> next<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>通过上面的代码可以了解到，当调用 cJSON_Delete (); 函数后，会通过 while 循环一直从当前节点删除释放其后面的节点，直至到尾部结点 null 节点为止；因此，在应用中，一般都是传入主链表的头结点来释放整个 JSON 数据包。</p><p><strong>2、cJSON_Hooks 里的钩子函数</strong></p><p>在 cJSON 项目里面，是留有 cJSON_InitHooks (); 外部引用内存管理函数的 API 接口的，其原型：</p><p><code>CJSON_PUBLIC(void) cJSON_InitHooks(cJSON_Hooks* hooks);</code></p><p>通过结构体 struct cJSON_Hooks 跟内部调用的内存分配挂钩，其 Hooks 原型：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">cJSON_Hooks</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>      <span class="token comment">/* malloc/free are CDECL on Windows regardless of the default calling convention of the compiler, so ensure the hooks allow passing those functions directly. */</span></pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span>CJSON_CDECL <span class="token operator">*</span>malloc_fn<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token keyword">void</span> <span class="token punctuation">(</span>CJSON_CDECL <span class="token operator">*</span>free_fn<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span> cJSON_Hooks<span class="token punctuation">;</span></pre></td></tr></table></figure><p>一般情况是默认不调用 cJSON_InitHooks (); 函数的，因此，其内存分配管理处于默认状态，使用的是以下标准内存分配函数：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>_MSC_VER<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">/* work around MSVC error C2322: '...' address of dllimport '...' is not static */</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span> CJSON_CDECL <span class="token function">internal_malloc</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> size<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">return</span> <span class="token function">malloc</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> CJSON_CDECL <span class="token function">internal_free</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>pointer<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token function">free</span><span class="token punctuation">(</span>pointer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span> CJSON_CDECL <span class="token function">internal_realloc</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>pointer<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">return</span> <span class="token function">realloc</span><span class="token punctuation">(</span>pointer<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">internal_malloc</span> <span class="token expression">malloc</span></span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">internal_free</span> <span class="token expression">free</span></span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">internal_realloc</span> <span class="token expression">realloc</span></span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr></table></figure><p>如此一来，假设我们在系统上跑了 FreeRTOS（或者其他 RTOS），那么，在默认情况下，如果使用其标准内存分配函数，这样，对于多线程来讲是不安全的，所以，可以利用该函数重新把内存分配函数定义调用；例如在 FreeRTOS 中：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>cJSON_Hooks cJSON_mem<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>cJSON_mem<span class="token punctuation">.</span>malloc_fn <span class="token operator">=</span> pvPortMalloc<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>cJSON_mem<span class="token punctuation">.</span>free_fn <span class="token operator">=</span> vPortFree<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token function">cJSON_InitHooks</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cJSON_mem<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>通过该钩子函数，把 cJSON 内部调用的内存分配处理，更换为线程安全的 pvPortMalloc (); 和 vPortFree (); 函数。</p><p><strong>3、cJSON_malloc (); 和 cJSON_free ();</strong></p><p>其原型分别为：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">CJSON_PUBLIC</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">cJSON_malloc</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">CJSON_PUBLIC</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token function">cJSON_free</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>一般来说，cJSON_malloc (); 很少用，因为 cJSON 的数据处理 API 函数都默认会自动分配内存；而 cJSON_free (); 则更多的是用来 free cJSON 格式化出来的数据（即调用 print 类的 API 接口）。</p>]]></content>
      
      
      <categories>
          
          <category> middleware </category>
          
      </categories>
      
      
        <tags>
            
            <tag> history </tag>
            
            <tag> JSON </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>cJSON库 API解析（上）</title>
      <link href="/docs/Library/cJSON%E5%BA%93%20API%E8%A7%A3%E6%9E%90%EF%BC%88%E4%B8%8A%EF%BC%89/"/>
      <url>/docs/Library/cJSON%E5%BA%93%20API%E8%A7%A3%E6%9E%90%EF%BC%88%E4%B8%8A%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<blockquote><p>cJSON 项目可以说是一个很适合学习及应用 C 语言中的链表的项目，刨析它的源码，你会惊叹它设计之巧妙，其代码为之简洁；同时，在嵌入式应用场景中也经常发现它的身影。</p><p>本系列分为上下两篇，其中上篇以应用分析其 JSON 数据封装为主。</p></blockquote><h1 id="介绍"><a class="anchor" href="#介绍">#</a> 介绍</h1><p>在认识 cJSON 之前，先来认识一下 JSON：</p><p><strong>JSON</strong>（<strong>J</strong>ava<strong>S</strong>cript <strong>O</strong>bject <strong>N</strong>otation，JavaScript 对象表示法，读作 /ˈdʒeɪsən/）是一种由道格拉斯・克罗克福特构想和设计、轻量级的资料交换语言，该语言以易于让人阅读的文字为基础，用来传输由属性值或者序列性的值组成的数据对象。JSON 采用完全独立于语言的文本格式，但是也使用了类似于 C 语言家族的习惯（包括 C, C++, C#, Java, JavaScript, Perl, Python 等）。 这些特性使 JSON 成为理想的数据交换语言。</p><p>其官网：<span class="exturl" data-url="aHR0cHM6Ly93d3cuanNvbi5vcmcvanNvbi1lbi5odG1s">https://www.json.org/json-en.html</span></p><p>而 cJSON，顾名思义就是一个使用 C 语言编写的 JSON 数据解析器，目前 cJSON 项目托管在 Github 上，仓库地址如下：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0RhdmVHYW1ibGUvY0pTT04lRUYlQkMlOUIlRTQlQkIlQTUlRTUlODklOEQlRTclOUElODQlRTYlOTclQTclRTclODklODglRTYlOUMlQUMlRTUlODglOTklRTYlOTglQUYlRTUlQUQlOTglRTYlOTQlQkUlRTUlOUMlQTglRUYlQkMlOUFodHRwczovL3NvdXJjZWZvcmdlLm5ldC9wcm9qZWN0cy9janNvbi9maWxlcy8lRTQlQjglOEElRTklOUQlQTIlRUYlQkMlOEMlRTQlQkQlODYlRTclOEUlQjAlRTUlQjclQjIlRTUlODElOUMlRTYlQUQlQTIlRTYlOUIlQjQlRTYlOTYlQjAlRUYlQkMlOEMlRTclQkIlQTclRTglODAlOEMlRTglQkQlQUMlRTUlODglQjA=">https://github.com/DaveGamble/cJSON；以前的旧版本则是存放在：https://sourceforge.net/projects/cjson/files/ 上面，但现已停止更新，继而转到</span> Github 上了。</p><h1 id="json语法"><a class="anchor" href="#json语法">#</a> JSON 语法</h1><p>JSON 的基本数据类型：</p><ol><li><p>对象（<em>object</em>）：若干无序的 “键值对” (key-value pairs)，其中键是数值或字符串，以花括号  <code>&#123;</code>  开始，并以  <code>&#125;</code>  结束。</p></li><li><p>数组 / 值的有序列表（array）：有序的零个或者多个值，使用方括号  <code>[ ]</code>  括起来。</p></li><li><p>字符串（<em>string</em>）：以双引号  <code>&quot; &quot;</code>  括起来的零个或多个 Unicode 码位。支持反斜杠开始的转义字符序列。</p></li><li><p>数值（<em>number</em>）：不区分整数与浮点数。JavaScript 用双精度浮点数 double 表示所有数值。</p></li><li><p>布尔值（<em>boolean</em>）：表示为  <code>true</code>  或者  <code>false</code>  。</p></li><li><p>null 类型：值写为  <code>null</code></p></li></ol><p>1、JSON 对象是一个若干无序的 &quot;名称 / 值&quot; 键值对的集合：</p><ul><li>以 &quot; <code>&#123;</code> &quot;开始，以&quot; <code>&#125;</code> &quot; 结束，允许嵌套使用；</li><li>每个名称和值成对出现，名称和值之间使用 &quot; <code>:</code> &quot; 分隔；</li><li>键值对之间用 &quot; <code>,</code> &quot; 分隔</li><li>在这些字符前后允许存在无意义的空白符；</li></ul><p>2、JSON 数组是一个有序的零个或者多个值的序列表：</p><ul><li>以 &quot; <code>[</code> &quot;开始，以&quot; <code>]</code> &quot; 结束，允许嵌套使用；</li><li>每个值可以为任意类型，可以是双引号括起来的字符串（<em>string</em>）、数值（<em>number</em>）、 <code>true</code> 、 <code>false</code> 、  <code>null</code> 、对象（<em>object</em>）或者数组（<em>array</em>）；</li><li>元素之间用 &quot; <code>,</code> &quot; 分隔</li><li>在这些元素前后允许存在无意义的空白符；</li></ul><h1 id="cjson结构"><a class="anchor" href="#cjson结构">#</a> cJSON 结构</h1><p>在下载的 cJSON 源码中，实际用到的文件只有两个（cJSON.c 和 cJSON.h），因此 cJSON 具有超轻便，可移植，单文件的特点。</p><p>对于 cJSON 文件，整个的数据结构就主要用到以下结构体：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* The cJSON structure: */</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">cJSON</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">/* next/prev allow you to walk array/object chains. Alternatively, use GetArraySize/GetArrayItem/GetObjectItem */</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">cJSON</span> <span class="token operator">*</span>next<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">cJSON</span> <span class="token operator">*</span>prev<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">/* An array or object item will have a child pointer pointing to a chain of the items in the array/object. */</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">cJSON</span> <span class="token operator">*</span>child<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">/* The type of the item, as above. */</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">int</span> type<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">/* The item's string, if type==cJSON_String  and type == cJSON_Raw */</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">char</span> <span class="token operator">*</span>valuestring<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">/* writing to valueint is DEPRECATED, use cJSON_SetNumberValue instead */</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">int</span> valueint<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment">/* The item's number, if type==cJSON_Number */</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">double</span> valuedouble<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">/* The item's name string, if this item is the child of, or is in the list of subitems of an object. */</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">char</span> <span class="token operator">*</span>string<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span> cJSON<span class="token punctuation">;</span></pre></td></tr></table></figure><p>从上面的代码可以看出，cJSON 的设计思想是 --- 链表。</p><p>然后我们分析一下各部分的成员信息：</p><ul><li><code>type</code> ：用于表示该键值对中值的类型；</li><li><code>valuestring</code> ：如果键值类型 (type) 是字符串，则将该指针指向键值；</li><li><code>valueint</code> ：如果键值类型 (type) 是整数，则将该指针指向键值；</li><li><code>valuedouble</code> ：如果键值类型 (type) 是浮点数，则将该指针指向键值；</li><li><code>String</code> ：用于表示当前键值对的名称；</li></ul><p>还有两个 cJSON 格式的结构体指针：</p><ul><li><code>next</code> ：指向下一个键值对</li><li><code>prev</code> ：指向上一个键值对</li></ul><p>最后一个 cJSON 格式的结构体指针：</p><ul><li><code>child</code> ：该子指针指向当前数组 / 对象中的节点</li></ul><p>如果是想要分析 cJSON 它的代码设计，除开那两个承接上下节点的  <code>next</code>  和  <code>prev</code>  结构体指针，那么你还要重点关注上面说到  <code>type</code>  成员，它支持以下定义：</p><blockquote><p>The type can be one of the following:</p><ul><li><code>cJSON_Invalid</code>  (check with  <code>cJSON_IsInvalid</code> ): Represents an invalid item that doesn't contain any value. You automatically have this type if you set the item to all zero bytes.</li><li><code>cJSON_False</code>  (check with  <code>cJSON_IsFalse</code> ): Represents a  <code>false</code>  boolean value. You can also check for boolean values in general with  <code>cJSON_IsBool</code> .</li><li><code>cJSON_True</code>  (check with  <code>cJSON_IsTrue</code> ): Represents a  <code>true</code>  boolean value. You can also check for boolean values in general with  <code>cJSON_IsBool</code> .</li><li><code>cJSON_NULL</code>  (check with  <code>cJSON_IsNull</code> ): Represents a  <code>null</code>  value.</li><li><code>cJSON_Number</code>  (check with  <code>cJSON_IsNumber</code> ): Represents a number value. The value is stored as a double in  <code>valuedouble</code>  and also in  <code>valueint</code> . If the number is outside of the range of an integer,  <code>INT_MAX</code>  or  <code>INT_MIN</code>  are used for  <code>valueint</code> .</li><li><code>cJSON_String</code>  (check with  <code>cJSON_IsString</code> ): Represents a string value. It is stored in the form of a zero terminated string in  <code>valuestring</code> .</li><li><code>cJSON_Array</code>  (check with  <code>cJSON_IsArray</code> ): Represent an array value. This is implemented by pointing  <code>child</code>  to a linked list of  <code>cJSON</code>  items that represent the values in the array. The elements are linked together using  <code>next</code>  and  <code>prev</code> , where the first element has  <code>prev.next == NULL</code>  and the last element  <code>next == NULL</code> .</li><li><code>cJSON_Object</code>  (check with  <code>cJSON_IsObject</code> ): Represents an object value. Objects are stored same way as an array, the only difference is that the items in the object store their keys in  <code>string</code> .</li><li><code>cJSON_Raw</code>  (check with  <code>cJSON_IsRaw</code> ): Represents any kind of JSON that is stored as a zero terminated array of characters in  <code>valuestring</code> . This can be used, for example, to avoid printing the same static JSON over and over again to save performance. cJSON will never create this type when parsing. Also note that cJSON doesn't check if it is valid JSON.</li></ul><p>Additionally there are the following two flags:</p><ul><li><code>cJSON_IsReference</code> : Specifies that the item that  <code>child</code>  points to and/or  <code>valuestring</code>  is not owned by this item, it is only a reference. So  <code>cJSON_Delete</code>  and other functions will only deallocate this item, not its  <code>child</code> / <code>valuestring</code> .</li><li><code>cJSON_StringIsConst</code> : This means that  <code>string</code>  points to a constant string. This means that  <code>cJSON_Delete</code>  and other functions will not try to deallocate  <code>string</code> .</li></ul></blockquote><p>&lt;br/&gt;</p><h1 id="json数据封装"><a class="anchor" href="#json数据封装">#</a> JSON 数据封装</h1><p>封装一个 JSON 格式的数据包，其实就是创建链表和向链表中添加节点的过程。</p><p>在 cJSON 源码里面是存放着很多 API 接口的，但是，一般来说我们并不是全部用到，而且有些函数是辅助函数，例如：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>cJSON <span class="token operator">*</span>Info<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>Info <span class="token operator">=</span> <span class="token function">cJSON_CreateObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">cJSON_AddStringToObject</span><span class="token punctuation">(</span>Info<span class="token punctuation">,</span> <span class="token string">"Nationality"</span><span class="token punctuation">,</span> <span class="token string">"China"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">/* 等价于 */</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>cJSON <span class="token operator">*</span>Info<span class="token punctuation">,</span> <span class="token operator">*</span>jtext<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>Info <span class="token operator">=</span> <span class="token function">cJSON_CreateObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>jtext <span class="token operator">=</span> <span class="token function">cJSON_CreateString</span><span class="token punctuation">(</span><span class="token string">"China"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token function">cJSON_AddItemToObject</span><span class="token punctuation">(</span>Info<span class="token punctuation">,</span> <span class="token string">"Nationality"</span><span class="token punctuation">,</span> jtext<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>然后下面就分析一些常用的 API 函数：</p><p><strong>1、创建原始框架：</strong></p><ul><li>数组（等于创建了一个空的  <code>[ ]</code> ）： <code>CJSON_PUBLIC(cJSON *) cJSON_CreateArray(void);</code></li><li>对象（等于创建了一个空的  <code>&#123; &#125;</code> ）： <code>CJSON_PUBLIC(cJSON *) cJSON_CreateObject(void);</code></li></ul><p><strong>2、追加类型值：</strong></p><ul><li><p>数组： <code>CJSON_PUBLIC(cJSON_bool) cJSON_AddItemToArray(cJSON *array, cJSON *item);</code></p></li><li><p>对象： <code>CJSON_PUBLIC(cJSON_bool) cJSON_AddItemToObject(cJSON *object, const char *string, cJSON *item);</code></p></li></ul><p><strong>3、追加对应的值到对象中：</strong></p><ul><li>null： <code>CJSON_PUBLIC(cJSON*) cJSON_AddNullToObject(cJSON * const object, const char * const name);</code></li><li>True： <code>CJSON_PUBLIC(cJSON*) cJSON_AddTrueToObject(cJSON * const object, const char * const name);</code></li><li>False： <code>CJSON_PUBLIC(cJSON*) cJSON_AddFalseToObject(cJSON * const object, const char * const name);</code></li><li>布尔值（实际为 True 和 False 合并）： <code>CJSON_PUBLIC(cJSON*) cJSON_AddBoolToObject(cJSON * const object, const char * const name, const cJSON_bool boolean);</code></li><li>数值： <code>CJSON_PUBLIC(cJSON*) cJSON_AddNumberToObject(cJSON * const object, const char * const name, const double number);</code></li><li>字符串： <code>CJSON_PUBLIC(cJSON*) cJSON_AddStringToObject(cJSON * const object, const char * const name, const char * const string);</code></li><li>对象： <code>CJSON_PUBLIC(cJSON*) cJSON_AddObjectToObject(cJSON * const object, const char * const name);</code></li><li>数组： <code>CJSON_PUBLIC(cJSON*) cJSON_AddArrayToObject(cJSON * const object, const char * const name);</code></li></ul><p><strong>4、创建同一类型的值到数组中：</strong></p><ul><li>整形： <code>CJSON_PUBLIC(cJSON *) cJSON_CreateIntArray(const int *numbers, int count);</code></li><li>单精度： <code>CJSON_PUBLIC(cJSON *) cJSON_CreateFloatArray(const float *numbers, int count);</code></li><li>双精度： <code>CJSON_PUBLIC(cJSON *) cJSON_CreateDoubleArray(const double *numbers, int count);</code></li><li>字符串： <code>CJSON_PUBLIC(cJSON *) cJSON_CreateStringArray(const char *const *strings, int count);</code></li></ul><p><strong>5、创建对应类型的值</strong></p><ul><li>null： <code>CJSON_PUBLIC(cJSON *) cJSON_CreateNull(void);</code></li><li>True： <code>CJSON_PUBLIC(cJSON *) cJSON_CreateTrue(void);</code></li><li>False： <code>CJSON_PUBLIC(cJSON *) cJSON_CreateFalse(void);</code></li><li>布尔值： <code>CJSON_PUBLIC(cJSON *) cJSON_CreateBool(cJSON_bool boolean);</code></li><li>数值： <code>CJSON_PUBLIC(cJSON *) cJSON_CreateNumber(double num);</code></li><li>字符串： <code>CJSON_PUBLIC(cJSON *) cJSON_CreateString(const char *string);</code></li></ul><h1 id="示例"><a class="anchor" href="#示例">#</a> 示例</h1><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"cJSON"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"v1.7.14"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token property">"file"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"cJSON.c"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">75.8</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token property">"unit"</span><span class="token operator">:</span> <span class="token string">"KB"</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token property">"released"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token number">2020</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token string">"Sep"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token number">3</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token property">"latest"</span><span class="token operator">:</span> <span class="token boolean">true</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>以打印输出上面为例，建立以下代码：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"cJSON.h"</span></span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span> <span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    cJSON <span class="token operator">*</span>jtest <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    cJSON <span class="token operator">*</span>jfile <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    cJSON <span class="token operator">*</span>jissue <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    cJSON <span class="token operator">*</span>jyear <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    cJSON <span class="token operator">*</span>jmonth <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    cJSON <span class="token operator">*</span>jday <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">char</span><span class="token operator">*</span> str <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">/* 创建一个 JSON 格式的主对象 (主链表头结点) */</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    jtest <span class="token operator">=</span> <span class="token function">cJSON_CreateObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment">/* 追加字符串类型的 JSON 数据到主对象中 (添加一个链表节点) */</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token function">cJSON_AddStringToObject</span><span class="token punctuation">(</span>jtest<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"cJSON"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token function">cJSON_AddStringToObject</span><span class="token punctuation">(</span>jtest<span class="token punctuation">,</span> <span class="token string">"version"</span><span class="token punctuation">,</span> <span class="token string">"v1.7.14"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token comment">/* 追加一个对象到主对象中 (添加一个链表节点) */</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    jfile <span class="token operator">=</span> <span class="token function">cJSON_AddObjectToObject</span><span class="token punctuation">(</span>jtest<span class="token punctuation">,</span> <span class="token string">"file"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token comment">/* 往追加的对象添加对应的值 */</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token function">cJSON_AddStringToObject</span><span class="token punctuation">(</span>jfile<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"cJSON.c"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token function">cJSON_AddNumberToObject</span><span class="token punctuation">(</span>jfile<span class="token punctuation">,</span> <span class="token string">"size"</span><span class="token punctuation">,</span> <span class="token number">75.8</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token function">cJSON_AddStringToObject</span><span class="token punctuation">(</span>jfile<span class="token punctuation">,</span> <span class="token string">"unit"</span><span class="token punctuation">,</span> <span class="token string">"KB"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    </pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token comment">/* 创建一个 JSON 格式的数组 (另一个链表头结点) */</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    jissue <span class="token operator">=</span> <span class="token function">cJSON_CreateArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token comment">/* 创建相应的值并把这些值添加到数组里 */</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    jyear <span class="token operator">=</span> <span class="token function">cJSON_CreateNumber</span><span class="token punctuation">(</span><span class="token number">2020</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token function">cJSON_AddItemToArray</span><span class="token punctuation">(</span>jissue<span class="token punctuation">,</span> jyear<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    jmonth <span class="token operator">=</span> <span class="token function">cJSON_CreateString</span><span class="token punctuation">(</span><span class="token string">"Sep"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token function">cJSON_AddItemToArray</span><span class="token punctuation">(</span>jissue<span class="token punctuation">,</span> jmonth<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    jday <span class="token operator">=</span> <span class="token function">cJSON_CreateNumber</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token function">cJSON_AddItemToArray</span><span class="token punctuation">(</span>jissue<span class="token punctuation">,</span> jday<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token comment">/* 把已经填好的数据的数组插入到主对象中 */</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token function">cJSON_AddItemToObject</span><span class="token punctuation">(</span>jtest<span class="token punctuation">,</span> <span class="token string">"released"</span><span class="token punctuation">,</span> jissue<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token comment">/* 追加一个值为 True 的布尔类型的 JSON 数据到主对象中 (添加一个链表节点) */</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token function">cJSON_AddTrueToObject</span><span class="token punctuation">(</span>jtest<span class="token punctuation">,</span> <span class="token string">"latest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token comment">/* 打印 JSON 对象 (整条链表) 的所有数据 */</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    str <span class="token operator">=</span> <span class="token function">cJSON_Print</span><span class="token punctuation">(</span>jtest<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token function">cJSON_free</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token function">cJSON_Delete</span><span class="token punctuation">(</span>jtest<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>实例：</p><p><img data-src="image-20210130174615600.png" alt="image-20210130174615600" /></p><h1 id="注意事项"><a class="anchor" href="#注意事项">#</a> 注意事项</h1><p>1、在调用了 create 接口的数据，并且用完一个完整的 JSON 格式包后，必须要使用 cJSON_Delete (); 释放内存，且不说不释放会造成泄露数据，在嵌入式中，内存容量可是很少的，很容易就耗完内存。</p><p>2、cJSON_Delete (); 函数，并不是每调用一个 create 接口，等用完都要一一对应释放，而是要释放主链表，简单的来说要处理的是头一个创建的数据类型，对于后期往其追加的数据，cJSON_Delete (); 函数会自动把插入进来的节点删除掉，这个在下篇再详细分析。</p><p>3、cJSON 里面的 Print 接口格式化出来返回的数据，需要调用 cJSON_free (); 释放。cJSON 的内存申请涉及到初始化钩子函数 cJSON_InitHooks (); 那里，这个也是下篇分析。</p>]]></content>
      
      
      <categories>
          
          <category> middleware </category>
          
      </categories>
      
      
        <tags>
            
            <tag> history </tag>
            
            <tag> JSON </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FreeRTOS 篇章之任务通知</title>
      <link href="/docs/RTOS/FreeRTOS%20%E7%AF%87%E7%AB%A0%E4%B9%8B%E4%BB%BB%E5%8A%A1%E9%80%9A%E7%9F%A5/"/>
      <url>/docs/RTOS/FreeRTOS%20%E7%AF%87%E7%AB%A0%E4%B9%8B%E4%BB%BB%E5%8A%A1%E9%80%9A%E7%9F%A5/</url>
      
        <content type="html"><![CDATA[<h1 id="任务通知的特性"><a class="anchor" href="#任务通知的特性">#</a> 任务通知的特性</h1><p>通过任务通知，无需单独的通信对象，任务就可以与其他任务进行交互，以及与 ISR 同步。通过使用任务通知，任务或 ISR 可以直接向接收任务发送事件。</p><p>任务通知可以通过以下几种方式更新接收任务的通知值：</p><ul><li>直接设置而不用覆写接收任务的通知值。</li><li>覆写接收任务的通知值。</li><li>设置接收任务通知值的一个或多个 bit 位。</li><li>增加接收任务的通知值。</li></ul><p>相对于使用中介对象发送到任务（这样的例子对象是队列，信号量，互斥对象和事件组）如下图：</p><p><img data-src="20210124204637565.png" alt="img" /></p><p>任务通知是一种将事件直接发送到任务的方法，而无需这样做中介对象：</p><p><img data-src="20210124204803426.png" alt="img" /></p><p>任务通知功能是可选的，要包含任务通知功能，请在  <code>FreeRTOSConfig.h</code>  中将  <code>configUSE_TASK_NOTIFICATIONS</code>  设置为  <code>1</code>  。</p><p>当  <code>configUSE_TASK_NOTIFICATIONS</code>  设置为  <code>1</code>  时，每个任务都有一个通知状态（待处理或未在等待处理）和一个通知值（一个 32 位无符号整数）。当任务收到通知时，其通知状态将设置为待处理。当任务读取其通知值时，其通知状态将设置为未在等待处理。如果出于节省空间的考虑（每个任务可以节省 4 个字节），可以设置  <code>configUSE_TASK_NOTIFICATIONS</code>  为  <code>0</code>  来禁用。<br />任务可在 “被阻止” 状态中等待其通知状态变为待处理，还可以选择指定超时。</p><h1 id="存在的限制"><a class="anchor" href="#存在的限制">#</a> 存在的限制</h1><p>在以下情形中不能使用任务通知：</p><ul><li><p>向 ISR 发送事件或数据。</p><p>通信对象可供 ISR 和任务相互发送事件和数据。</p><p>任务通知可用于从 ISR 向任务发送事件和数据，但不能用于从任务向 ISR 发送事件或数据。</p></li><li><p>启用多个接收任务。</p><p>通信对象可由任何知其句柄（可能是队列句柄、信号灯句柄或事件组句柄）的任务或 ISR 访问。任意数量的任务和 ISR 可处理发送到任何给定通信对象的事件或数据。</p><p>任务通知直接发送给接收任务，因此只能由接收通知的任务来处理。这在多数情况下并不是限制，因为尽管通常有多个任务和 ISR 向相同的通信对象发送事件或数据，但是很少有多个任务和 ISR 接收来自同一通信对象的事件或数据。</p></li><li><p>缓冲多个数据项。</p><p>队列是一次可保存多个数据项的通信对象。已发送到队列但尚未从队列中接收的数据将在队列对象中缓冲。</p><p>任务通知通过更新接收任务的通知值向任务发送数据。任务的通知值一次只能保存一个值。</p></li><li><p>广播到多个任务。</p><p>事件组是可用于一次向多个任务发送事件的通信对象。</p><p>任务通知直接发送给接收任务，因此只能由接收任务来处理。</p></li><li><p>在 “被阻止” 状态中等待发送完成。</p><p>如果通信对象暂时处于无法向其中写入更多数据或事件的状态（例如，当队列已满、无法向该队列发送更多数据时），尝试向该对象写入内容的任务可以选择进入 “被阻止” 状态，以等待其写入操作完成。</p><p>如果一个任务尝试向已有待处理通知的另一个任务发送任务通知，则发送任务无法在 “被阻止” 状态中等待接收任务重置其通知状态。在大多数使用任务通知的情况下，这极少成为限制。</p></li></ul><h1 id="api函数"><a class="anchor" href="#api函数">#</a> API 函数</h1><p>任务通知使用 API 函数  <code>xTaskNotify() </code> 或  <code>xTaskNotifyGive()</code>  来发送，这个通知将一直挂起直到接收任务使用 API 函数  <code>xTaskNotifyWait() </code> 或  <code>ulTaskNotifyTake() </code> 来接收通知。如果接收任务在通知到来时已经被阻塞，则会从阻塞态恢复，同时通知被清除。</p><table><thead><tr><th style="text-align:left">功能</th><th style="text-align:left">API 接口</th><th style="text-align:left">实际执行函数</th><th style="text-align:left">其它</th></tr></thead><tbody><tr><td style="text-align:left">发送通知</td><td style="text-align:left">xTaskNotifyGive()</td><td style="text-align:left">xTaskGenericNotify()</td><td style="text-align:left">没有通知值 （信号量类型）</td></tr><tr><td style="text-align:left">发送通知（用于中断中）</td><td style="text-align:left">vTaskNotifyGiveFromISR()</td><td style="text-align:left"></td><td style="text-align:left"></td></tr><tr><td style="text-align:left">接收通知</td><td style="text-align:left">ulTaskNotifyTake()</td><td style="text-align:left"></td><td style="text-align:left">单独对应 xTaskNotifyGive ()</td></tr><tr><td style="text-align:left">发送通知</td><td style="text-align:left">xTaskNotify()</td><td style="text-align:left">xTaskGenericNotify()</td><td style="text-align:left">带通知值</td></tr><tr><td style="text-align:left">发送通知（用于中断中）</td><td style="text-align:left">xTaskNotifyFromISR()</td><td style="text-align:left">xTaskGenericNotifyFromISR()</td><td style="text-align:left"></td></tr><tr><td style="text-align:left">发送通知</td><td style="text-align:left">xTaskNotifyAndQuery()</td><td style="text-align:left">xTaskGenericNotify()</td><td style="text-align:left">带通知值，并且返回原通知值</td></tr><tr><td style="text-align:left">发送通知（用于中断中）</td><td style="text-align:left">xTaskNotifyAndQueryFromISR()</td><td style="text-align:left"></td><td style="text-align:left"></td></tr><tr><td style="text-align:left">接收通知</td><td style="text-align:left">xTaskNotifyWait()</td><td style="text-align:left"></td><td style="text-align:left"></td></tr><tr><td style="text-align:left">清除通知</td><td style="text-align:left">xTaskNotifyStateClear()</td><td style="text-align:left"></td><td style="text-align:left"></td></tr></tbody></table><p>在大多数情况下，并不需要  <code>xTaskNotify()</code>  和  <code>xTaskNotifyWait()</code>  API 函数提供的灵活性。更简单的函数就足够了。 <code>xTaskNotifyGive()</code>  API 函数可替代  <code>xTaskNotify()</code>  ，它更简单、但灵活性稍差。 <code>ulTaskNotifyTake()</code>  API 函数可替代  <code>xTaskNotifyWait()</code> ，它更简单、但灵活性稍差。</p><p><strong>1、xTaskNotifyGive () 和 vTaskNotifyGiveFromISR () API 函数</strong></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>BaseType_t  <span class="token function">xTaskNotifyGive</span><span class="token punctuation">(</span> TaskHandle_t  xTaskToNotify <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">vTaskNotifyGiveFromISR</span><span class="token punctuation">(</span> TaskHandle_t  xTaskToNotify<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="2"></td><td><pre>                             BaseType_t    <span class="token operator">*</span>pxHigherPriorityTaskWoken <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>传入参数：</p><ul><li><strong>xTaskToNotify</strong>：需要通知的任务句柄。这个句柄即是调用  <code>xTaskCreate()</code>  创建任务时传递的句柄。</li><li><strong>pxHigherPriorityTaskWoken</strong>：如果调用  <code>vTaskNotifyGiveFromISR()</code>  发送通知导致被发送通知的任务离开阻塞状态，并且这个任务的优先级高于当前任务（也就是被中断的任务），那么  <code>xSemaphoreGiveFromISR()</code>  会在函数内部将  <code>*pxHigherPriorityTaskWoken</code>  设为  <code>pdTRUE</code>  。如果  <code>vTaskNotifyGiveFromISR()</code>  将此值设为  <code>pdTRUE</code>  ，则在中断退出前应当进行一次上下文切换。</li></ul><p>返回参数（始终返回 pdPASS）：</p><ul><li><strong>pdPASS</strong>：发送成功。</li></ul><p><strong>2、ulTaskNotifyTake () API 函数</strong></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">uint32_t</span>  <span class="token function">ulTaskNotifyTake</span><span class="token punctuation">(</span> BaseType_t  xClearCountOnExit<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="2"></td><td><pre>                            TickType_t  xTicksToWait <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>传入参数：</p><ul><li><strong>xClearCountOnExit</strong>：当设置为  <code>pdFALSE</code>  ，则在函数退出时任务的通知值递减，这样，通知值就像一个计数信号量；如果是  <code>pdTRUE</code>  ，那么当函数退出时，任务的通知值将被清除为零，这样，通知值就像一个二进制信号量。</li><li><strong>xTicksToWait</strong>：阻塞超时时间。任务进入阻塞态以等待任务通知有效的最长时间。如果  <code>xTicksToWait</code>  为  <code>0</code>  ，则  <code>ulTaskNotifyTake()</code>  在通知无效时会立即返回；如果把  <code>xTicksToWait</code>  设置为  <code>portMAX_DELAY</code>  ，那么阻塞等待将没有超时限制。</li></ul><p>返回参数：</p><ul><li><strong>uint32_t</strong>：在任务的通知计数清空为零或递减之前的任务通知值。</li></ul><p><strong>3、xTaskNotify () 和 xTaskNotifyFromISR () API 函数</strong></p><p>BaseType_t  xTaskNotify( TaskHandle_t  xTaskToNotify,<br />uint32_t      ulValue,<br />eNotifyAction  eAction );</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>BaseType_t  <span class="token function">xTaskNotifyFromISR</span><span class="token punctuation">(</span> TaskHandle_t   xTaskToNotify<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="2"></td><td><pre>                                <span class="token class-name">uint32_t</span>       ulValue<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="3"></td><td><pre>                                eNotifyAction  eAction<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="4"></td><td><pre>                                BaseType_t     <span class="token operator">*</span>pxHigherPriorityTaskWoken <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>传入参数：</p><ul><li><strong>xTaskToNotify</strong>：需要通知的任务句柄。这个句柄即是调用  <code>xTaskCreate()</code>  创建任务时传递的句柄。</li><li><strong>ulValue</strong>：与通知一起发送的数据，如何使用  <code>ulValue</code>  取决于  <code>eNotifyAction</code>  值。</li><li><strong>eAction</strong>：枚举类型，用于指定如何更新接收任务的通知值。</li></ul><table><thead><tr><th style="text-align:left">枚举成员</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:left">eNoAction</td><td style="text-align:left">通知任务，而不更新其通知值；参数 ulValue 未使用。可用作更快速的二进制信号量轻型替代方案。始终返回 pdPASS。</td></tr><tr><td style="text-align:left">eSetBits</td><td style="text-align:left">对被通知任务的通知值按位执行或运算。可用作更快速的事件组轻型替代方案。始终返回 pdPASS。</td></tr><tr><td style="text-align:left">eIncrement</td><td style="text-align:left">接收任务的通知值将递增。可用作更快速的计数信号量轻型替代方案。始终返回 pdPASS。</td></tr><tr><td style="text-align:left">eSetValueWithOverwrite</td><td style="text-align:left">即使任务尚未读取前一个值，也将任务的通知值设置为 ulValue 参数中传递的值。始终返回 pdPASS。</td></tr><tr><td style="text-align:left">eSetValueWithoutOverwrite</td><td style="text-align:left">如果任务当前没有通知值，则设置任务的通知值并返回 pdPASS；如果任务没有取出前一个通知值，则不执行任何操作，将返回 pdFAIL。</td></tr></tbody></table><ul><li><strong>pxHigherPriorityTaskWoken</strong>：如果调用  <code>xTaskNotifyFromISR()</code>  发送通知导致被发送通知的任务离开阻塞状态，并且这个任务的优先级高于当前任务 (也就是被中断的任务)，那么  <code>xTaskNotifyFromISR()</code>  会在函数内部将  <code>*pxHigherPriorityTaskWoken</code>  设为  <code>pdTRUE</code>  。如果  <code>xTaskNotifyFromISR()</code>  将此值设为  <code>pdTRUE</code>  ，则在中断退出前应当进行一次上下文切换。</li></ul><p>返回参数：</p><ul><li><strong>BaseType_t</strong>：取决于  <code>eAction</code>  的值。</li></ul><p><strong>4、xTaskNotifyWait () API 函数</strong></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>BaseType_t  <span class="token function">xTaskNotifyWait</span><span class="token punctuation">(</span> <span class="token class-name">uint32_t</span>    ulBitsToClearOnEntry<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="2"></td><td><pre>                             <span class="token class-name">uint32_t</span>    ulBitsToClearOnExit<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="3"></td><td><pre>                             <span class="token class-name">uint32_t</span>    <span class="token operator">*</span>pulNotificationValue<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="4"></td><td><pre>                             TickType_t  xTicksToWait <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>传入参数：</p><ul><li><strong>ulBitsToClearOnEntry</strong>：在使用通知之前，先将任务的通知值与参数  <code>ulBitsToClearOnEntry</code>  的按位取反值按位与操作。设置参数  <code>ulBitsToClearOnEntry</code>  为  <code>0xFFFFFFFF(ULONG_MAX)</code>  ，表示清零任务通知值。</li><li><strong>ulBitsToClearOnExit</strong>：在退出函数之前，将任务的通知值与参数  <code>ulBitsToClearOnExit</code>  的按位取反值按位与操作。设置参数  <code>ulBitsToClearOnExit</code>  为  <code>0xFFFFFFFF(ULONG_MAX)</code>  ，表示清零任务通知值。</li><li><strong>pulNotificationValue</strong>：用于向外回传任务的通知值。这个通知值在参数  <code>ulBitsToClearOnExit</code>  起作用前将通知值拷贝到  <code>*pulNotificationValue</code>  中。可选参数，如果不需要，可将其设置为 NULL。</li><li><strong>xTicksToWait</strong>：阻塞超时时间。任务进入阻塞态以等待任务通知有效的最长时间。如果  <code>xTicksToWait</code>  为  <code>0</code>  ，则  <code>xTaskNotifyWait()</code>  在通知无效时会立即返回；如果把  <code>xTicksToWait</code>  设置为  <code>portMAX_DELAY</code>  ，那么阻塞等待将没有超时限制。</li></ul><p>返回参数：</p><ul><li><strong>pdPASS</strong>：接收成功。</li><li><strong>pdFAIL</strong>：接收失败（超时）。</li></ul><h1 id="应用"><a class="anchor" href="#应用">#</a> 应用</h1><p><strong>1、替代二值信号量 (binary semaphore)</strong></p><p>任务通知比二值信号量快 45% 并且内存占用更小</p><ul><li>发送处理：<strong> <code>xTaskNotifyGive() </code> </strong> 和 <strong> <code>vTaskNotifyGiveFromISR()</code> </strong> 用来代替 <strong> <code>xSemaphoreGive()</code> </strong> 和 <strong> <code>xSemaphoreGiveFromISR()</code> </strong> 。</li><li>接收处理：<strong> <code>ulTaskNotifyTake()</code> </strong> 用来替代 <strong> <code>xSemaphoreTake()</code> </strong> （ps： <code>ulTaskNotifyTake()</code>  的第一个参数  <code>xClearCountOnExit</code>  应设置为  <code>pdTRUE</code>  ）。</li></ul><p><strong>2、替代计数信号量 (counting semaphore)</strong></p><p>与替代二值信号量类似，当使用任务通知来代替计数信号量的时候，接收任务的通知值被用来代替计数信号量的计数值</p><ul><li>发送处理：<strong> <code>xTaskNotifyGive()</code> </strong> 和 <strong> <code>vTaskNotifyGiveFromISR()</code> </strong> 用来代替 <strong> <code>xSemaphoreGive() </code> </strong> 和 <strong> <code>xSemaphoreGiveFromISR()</code> </strong> 。</li><li>接收处理：<strong> <code>ulTaskNotifyTake()</code> </strong> 用来替代 <strong> <code>xSemaphoreTake()</code> </strong> （ps： <code>ulTaskNotifyTake()</code>  的第一个参数  <code>xClearCountOnExit</code>  应设置为  <code>pdFALSE</code>  ）。</li></ul><p><strong>3、替代事件组 (event group)</strong></p><p>当任务通知用来代替时间组的时候，通知值被用来代替事件组的任务值，通知值的每一位被用来代表某个标志</p><ul><li>发送处理：<strong> <code>xTaskNotify()</code> </strong> 和 <strong> <code>xTaskNotifyFromISR()</code> </strong> 用来代替 <strong> <code>xEventGroupSetBits()</code> </strong> 和 <strong> <code>xEventGroupSetBitsFromISR()</code> </strong> 。</li><li>接收处理：<strong> <code>xTaskNotifyWait()</code> </strong> 用来代替 <strong> <code>xEventGroupWaitBits()</code> </strong> 。</li></ul><p><strong>4、替代邮箱队列 (mailbox)</strong></p><p>RTOS 任务通知只能用来发送数据到一个任务中，相比用队列实现，有一些限制：</p><ol><li>只能发送 32-bit 数据。</li><li>保存的是接收任务的值，同一个时刻只能存在一个接收任务。</li></ol><p>因此，使用 “轻量邮箱” 这个短语代替 “轻量队列”。任务的通知值就是邮箱值</p><ul><li>发送处理：使用 <strong> <code>xTaskNotify()</code> </strong> 和 <strong> <code>xTaskNotifyFromISR()</code> </strong> 发送至任务，可以用来替换 <strong> <code>xQueueOverwtite()</code> </strong> 和 <strong> <code>xQueueOverwtiteFromISR()</code> </strong> 。</li><li>接收处理：使用 <strong> <code>xTaskNotifyWait()</code> </strong> 来获取通知值，可以用来代替 <strong> <code>xQueueReceive()</code> </strong> 和 <strong> <code>xQueuePeek()</code> </strong> 。</li></ul>]]></content>
      
      
      <categories>
          
          <category> FreeRTOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> history </tag>
            
            <tag> RTOS </tag>
            
            <tag> FreeRTOS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>逻辑门、锁存器和触发器</title>
      <link href="/docs/Electronic/%E9%80%BB%E8%BE%91%E9%97%A8%E3%80%81%E9%94%81%E5%AD%98%E5%99%A8%E5%92%8C%E8%A7%A6%E5%8F%91%E5%99%A8/"/>
      <url>/docs/Electronic/%E9%80%BB%E8%BE%91%E9%97%A8%E3%80%81%E9%94%81%E5%AD%98%E5%99%A8%E5%92%8C%E8%A7%A6%E5%8F%91%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<blockquote><p>好久没写硬件的笔记了，写这篇笔记是因为在网上或者在现有的书上查阅相关知识点的时候，发现大多数东西都是一略带过、不全面，而且内容讲的有点沉闷，容易让人呼呼入睡（ps：这里绝对没有瞧不起作者的意思哈，可能风格有点不适应），所以想着以后可能也会用到，还是自己总结一篇吧。</p><p>本篇主要分析半导体存储电路（其中包括时序图跟真值表），但由于涉及到逻辑门电路，所以就一并放在一起总结了。嘛，原本的标题是想写 “半导体存储电路分析” 的。。。</p></blockquote><h1 id="逻辑门电路"><a class="anchor" href="#逻辑门电路">#</a> 逻辑门电路</h1><h2 id="与-或-非"><a class="anchor" href="#与-或-非">#</a> 与、或、非</h2><ul><li><p>与门</p><p><img data-src="AND.jpg" alt="AND" /></p><p>特点：所有输入为高电平时（逻辑 1），才会有高电平（逻辑 1）输出；其中一个输入为低电平（逻辑 0）则出低电平（逻辑 0）。</p><p><strong>真值表：</strong></p><table><thead><tr><th style="text-align:center"><strong>输入</strong></th><th style="text-align:center"><strong>输入</strong></th><th style="text-align:center"><strong>输出</strong></th></tr></thead><tbody><tr><td style="text-align:center">A</td><td style="text-align:center">B</td><td style="text-align:center">A  and  B</td></tr><tr><td style="text-align:center">0</td><td style="text-align:center">0</td><td style="text-align:center">0</td></tr><tr><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">0</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">0</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">1</td></tr></tbody></table><p><mark>总结：遇 0 为 0。</mark></p></li><li><p>或门</p><p><img data-src="OR.jpg" alt="OR" /></p><p>特点：其中一个输入为高电平时（逻辑 1），输出为高电平（逻辑 1）；只有当所有输入为低电平（逻辑 0）才出低电平（逻辑 0）。</p><p><strong>真值表：</strong></p><table><thead><tr><th style="text-align:center"><strong>输入</strong></th><th style="text-align:center"><strong>输入</strong></th><th style="text-align:center"><strong>输出</strong></th></tr></thead><tbody><tr><td style="text-align:center">A</td><td style="text-align:center">B</td><td style="text-align:center">A  or  B</td></tr><tr><td style="text-align:center">0</td><td style="text-align:center">0</td><td style="text-align:center">0</td></tr><tr><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">1</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">1</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">1</td></tr></tbody></table><p><mark>总结：遇 1 为 1。</mark></p></li><li><p>非门</p><p><img data-src="NOT.jpg" alt="NOT" /></p><p>特点：输出的电平与输入的电平（逻辑）相反。</p><p><strong>真值表：</strong></p><table><thead><tr><th style="text-align:center"><strong>输入</strong></th><th style="text-align:center"><strong>输出</strong></th></tr></thead><tbody><tr><td style="text-align:center">A</td><td style="text-align:center">not  A</td></tr><tr><td style="text-align:center">0</td><td style="text-align:center">1</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">0</td></tr></tbody></table><p><mark>总结：状态取反。</mark></p></li></ul><h2 id="异或和同或"><a class="anchor" href="#异或和同或">#</a> 异或和同或</h2><ul><li><p>异或</p><p><img data-src="XOR.jpg" alt="XOR" /></p><p>特点：输入的电平相同时，输出为低电平（逻辑 0）；若输入的电平不同，则输出高电平（逻辑 1）。</p><p><strong>真值表：</strong></p><table><thead><tr><th style="text-align:center"><strong>输入</strong></th><th style="text-align:center"><strong>输入</strong></th><th style="text-align:center"><strong>输出</strong></th></tr></thead><tbody><tr><td style="text-align:center">A</td><td style="text-align:center">B</td><td style="text-align:center">A  xor  B</td></tr><tr><td style="text-align:center">0</td><td style="text-align:center">0</td><td style="text-align:center">0</td></tr><tr><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">1</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">1</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">0</td></tr></tbody></table><p><mark>总结：相同为 0，不同为 1。</mark></p></li><li><p>同或</p><p><img data-src="XNOR.jpg" alt="XNOR" /></p><p>特点：只有当输入的电平相同时，输出才为高电平（逻辑 1）；而输入的电平不同时，输出低电平（逻辑 0）。</p><p><strong>真值表：</strong></p><table><thead><tr><th style="text-align:center"><strong>输入</strong></th><th style="text-align:center"><strong>输入</strong></th><th style="text-align:center"><strong>输出</strong></th></tr></thead><tbody><tr><td style="text-align:center">A</td><td style="text-align:center">B</td><td style="text-align:center">A  xnor  B</td></tr><tr><td style="text-align:center">0</td><td style="text-align:center">0</td><td style="text-align:center">1</td></tr><tr><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">0</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">0</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">1</td></tr></tbody></table><p><mark>总结：不同为 0，相同为 1。</mark></p></li></ul><h2 id="与非和或非"><a class="anchor" href="#与非和或非">#</a> 与非和或非</h2><p>与非和或非，其实相当于与门和或门输出取反：</p><p><img data-src="X.jpg" alt="X" /></p><p>真值表这里就不放了，其实就是把与门和或门的输出状态取反。。。</p><h2 id="逻辑门电路实现"><a class="anchor" href="#逻辑门电路实现">#</a> 逻辑门电路实现</h2><p>逻辑门电路的实现，可由三极管或者 CMOS 管构建而成，可以看以前的文章：<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQyOTkyMDg0L2FydGljbGUvZGV0YWlscy85ODc4NDk2Mw==">三极管 --- 初识 (图文并茂)</span></p><h1 id="存储电路"><a class="anchor" href="#存储电路">#</a> 存储电路</h1><p><strong>基本概念：</strong></p><ul><li><strong>存储单元</strong>：存储一位数据的电路。可分为<strong>静态存储单元</strong>和<strong>动态存储单元</strong>两大类。静态存储单元由门电路连接而成，其中包括各种电路结构形式的<strong>锁存器</strong>和<strong>触发器</strong>，只要保持通电，静态存储单元的状态会一直保持下去。动态存储单元则是利用<strong>电容</strong>的电荷存储效应来存储数据的，由于电容存储的电荷会随着时间的推移逐渐泄露，必须定期地进行 “刷新”，才能保证数据不会丢失。</li><li><strong>寄存器</strong>：存储一组数据的电路。由 N 个触发器构成的寄存器可以存储一组 N 位的二值数据。</li><li><strong>存储器</strong>：存储大量数据的电路。存储器种类虽然很多，但它们的基本结构形式都是由<strong>存储矩阵</strong>和<strong>读 / 写控制电路</strong>两部分组成的。从存储功能上讲，可分为<strong>随机存储器</strong>（Random Access  Memory，简称 RAM）和<strong>只读存储器</strong>（Read Only Memory ，简称 ROM）两大类。随机存储器又分成<strong>静态随机存储器</strong>（SRAM）和<strong>动态随机存储器</strong>（DRAM）两类；而只读存储器又有<strong>掩模 ROM</strong>、<strong>可编程 ROM</strong>（PRAM）和<strong>可擦除可编程 ROM</strong>（EPRAM）几种不同类型。</li></ul><h1 id="锁存器和触发器"><a class="anchor" href="#锁存器和触发器">#</a> 锁存器和触发器</h1><p>下面主要分析硬件电路中经常接触的<strong>静态存储单元</strong>，那么就先来了解一下<strong>锁存器</strong>和<strong>触发器</strong>之间的关系：</p><p>触发器的线路图由逻辑门组合而成，其结构均由 SR 锁存器派生而来（广义的触发器包括锁存器）；</p><p><strong>触发器</strong>除了自身的输入信号外，还带有 CLK 时钟信号线，通过时钟信号的变化，使得触发器的次态仅仅取决于 CLK 信号下降沿（或上升沿）到达时刻输入信号的状态，以此来增强靠干扰能力，因此，触发器也叫边沿触发器；</p><p>而<strong>锁存器</strong>并没有 CLK 时钟信号线作为辅助，只有自身的输入信号，但是，通过改进（增加一条使能信号线）可以产生新的门控锁存器，此时锁存器上多了一条使能信号线，如果在使能信号线上给予一定频率的脉冲信号，那么门控锁存器就相当于触发器了。</p><p>知识补充：<span class="exturl" data-url="aHR0cHM6Ly9jaXJjdWl0Z2xvYmUuY29tL2RpZmZlcmVuY2UtYmV0d2Vlbi1sYXRjaC1hbmQtZmxpcC1mbG9wLmh0bWw=">https://circuitglobe.com/difference-between-latch-and-flip-flop.html</span></p><h1 id="锁存器"><a class="anchor" href="#锁存器">#</a> 锁存器</h1><p>锁存器的类型有很多种：S-R、J-K、T and D latches。这里只介绍比较常用的 S-R latch and Gated D latch。</p><h2 id="sr锁存器"><a class="anchor" href="#sr锁存器">#</a> SR 锁存器</h2><p><img data-src="R-S_mk2.gif" alt="R-S_mk2" /></p><p>SR 锁存器（Set-Reset Latch）是静态存储单元当中最基本、也是电路结构最简单的一种。通常它由两个<strong>或非门</strong>或者<strong>与非门</strong>组成。</p><p><strong>Ⅰ、电路组成：</strong></p><ul><li><p>由<strong>或非门</strong>构成</p><p><img data-src="Logic_Design_NOR_Latches.jpg" alt="Logic_Design_NOR_Latches" /></p></li><li><p>由<strong>与非门</strong>构成</p><p><img data-src="Logic_Design_NAND_Latches.jpg" alt="Logic_Design_NAND_Latches" /></p></li></ul><p><strong>Ⅱ、状态分析：</strong></p><p>从上面的两种构成进行比较，根据它们对应的状态表可以看出，当 S、R 信号为高电平（逻辑 1）【对应的，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>S</mi><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{S}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8833300000000001em;vertical-align:0em;"></span><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8833300000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span><span style="top:-3.80333em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span></span></span></span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>R</mi><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{R}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8833300000000001em;vertical-align:0em;"></span><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8833300000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span><span style="top:-3.80333em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span></span></span></span></span></span></span> 信号（由于符号表示的是非的关系）就为低电平（逻辑 0）】，就相当于这两个状态表高亮部分，所以无论是由哪个逻辑门构成，其输出状态都是一样的；因此，找其中一个表对照着理解就好了，那么就来稍微分析一下吧：</p><ul class="task-list"><li class="task-list-item"><p><input type="checkbox" id="cbx_0" disabled="true" /><label for="cbx_0"> 当输入的 S = 0、R = 1（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>S</mi><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{S}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8833300000000001em;vertical-align:0em;"></span><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8833300000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span><span style="top:-3.80333em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span></span></span></span></span></span></span> = 1、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>R</mi><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{R}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8833300000000001em;vertical-align:0em;"></span><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8833300000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span><span style="top:-3.80333em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span></span></span></span></span></span></span> = 0），输出 Q = 0 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>Q</mi><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{Q}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0777700000000001em;vertical-align:-0.19444em;"></span><span class="mord overline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8833300000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">Q</span></span></span><span style="top:-3.80333em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span></span></span></span> = 1（定义为 0 状态）；</label></p></li><li class="task-list-item"><p><input type="checkbox" id="cbx_1" disabled="true" /><label for="cbx_1"> 当输入的 S = 1、R = 0（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>S</mi><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{S}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8833300000000001em;vertical-align:0em;"></span><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8833300000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span><span style="top:-3.80333em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span></span></span></span></span></span></span> = 0、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>R</mi><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{R}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8833300000000001em;vertical-align:0em;"></span><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8833300000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span><span style="top:-3.80333em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span></span></span></span></span></span></span> = 1），输出 Q = 1 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>Q</mi><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{Q}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0777700000000001em;vertical-align:-0.19444em;"></span><span class="mord overline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8833300000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">Q</span></span></span><span style="top:-3.80333em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span></span></span></span> = 0（定义为 1 状态）；</label></p></li><li class="task-list-item"><p><input type="checkbox" id="cbx_2" disabled="true" /><label for="cbx_2"> 当输入的 S = R = 0（ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>S</mi><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{S}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8833300000000001em;vertical-align:0em;"></span><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8833300000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span><span style="top:-3.80333em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span></span></span></span></span></span></span> = <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>R</mi><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{R}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8833300000000001em;vertical-align:0em;"></span><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8833300000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span><span style="top:-3.80333em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span></span></span></span></span></span></span> = 1）；输出将会保持；</label></p></li><li class="task-list-item"><p><input type="checkbox" id="cbx_3" disabled="true" /><label for="cbx_3"> 当输入的 S = 1、R = 1（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>S</mi><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{S}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8833300000000001em;vertical-align:0em;"></span><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8833300000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span><span style="top:-3.80333em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span></span></span></span></span></span></span> = 0、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>R</mi><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{R}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8833300000000001em;vertical-align:0em;"></span><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8833300000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span><span style="top:-3.80333em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span></span></span></span></span></span></span> = 0），输出 Q 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>Q</mi><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{Q}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0777700000000001em;vertical-align:-0.19444em;"></span><span class="mord overline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8833300000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">Q</span></span></span><span style="top:-3.80333em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span></span></span></span> 其状态是不确定的；因此，在 SR 锁存器里，有一条约束条件：S・R = 0（即不应该出现 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>S</mi><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{S}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8833300000000001em;vertical-align:0em;"></span><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8833300000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span><span style="top:-3.80333em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span></span></span></span></span></span></span> = <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>R</mi><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{R}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8833300000000001em;vertical-align:0em;"></span><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8833300000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span><span style="top:-3.80333em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span></span></span></span></span></span></span> = 0，这种情况）。</label></p></li></ul><p><strong>Ⅲ、时序分析：</strong></p><p>以<strong>与非门</strong>构成电路为例：</p><p><img data-src="SR%20latch.png" alt="SR latch" /></p><p>在上图可以看到， t3 ~ t4 时刻，输入端出现了 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>S</mi><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{S}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8833300000000001em;vertical-align:0em;"></span><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8833300000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span><span style="top:-3.80333em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span></span></span></span></span></span></span> = <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>R</mi><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{R}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8833300000000001em;vertical-align:0em;"></span><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8833300000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span><span style="top:-3.80333em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span></span></span></span></span></span></span> = 0 的状态，但由于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>S</mi><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{S}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8833300000000001em;vertical-align:0em;"></span><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8833300000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span><span style="top:-3.80333em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span></span></span></span></span></span></span> 首先回到了高电平，所以 SR 锁存器的次态仍是可以确定的；可能你会觉得，上面不是说了无法确定状态吗？这是由于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>S</mi><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{S}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8833300000000001em;vertical-align:0em;"></span><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8833300000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span><span style="top:-3.80333em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span></span></span></span></span></span></span> = <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>R</mi><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{R}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8833300000000001em;vertical-align:0em;"></span><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8833300000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span><span style="top:-3.80333em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span></span></span></span></span></span></span> = 0 时会出现非定义的 Q =  <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>Q</mi><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{Q}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0777700000000001em;vertical-align:-0.19444em;"></span><span class="mord overline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8833300000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">Q</span></span></span><span style="top:-3.80333em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span></span></span></span> = 1 的非法状态（要知道我们只定义了 0 和 1 的状态），而且当 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>S</mi><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{S}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8833300000000001em;vertical-align:0em;"></span><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8833300000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span><span style="top:-3.80333em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>R</mi><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{R}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8833300000000001em;vertical-align:0em;"></span><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8833300000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span><span style="top:-3.80333em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span></span></span></span></span></span></span> 同时回到高电平以后锁存器的状态难以确定，因此一般情况下还是避免这种 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>S</mi><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{S}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8833300000000001em;vertical-align:0em;"></span><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8833300000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span><span style="top:-3.80333em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span></span></span></span></span></span></span> = <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>R</mi><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{R}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8833300000000001em;vertical-align:0em;"></span><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8833300000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span><span style="top:-3.80333em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span></span></span></span></span></span></span> = 0 的状态；同时，由于这个缺陷，<strong>JK 触发器</strong>产生了，下面会讲。</p><p><strong>Ⅳ、电路改进：</strong></p><p>从上面可以得知，由<strong>与非门</strong>构成的 SR 触发器，输入的电平（逻辑）是反向的输入（即为  <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>S</mi><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{S}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8833300000000001em;vertical-align:0em;"></span><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8833300000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span><span style="top:-3.80333em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span></span></span></span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>R</mi><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{R}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8833300000000001em;vertical-align:0em;"></span><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8833300000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span><span style="top:-3.80333em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span></span></span></span></span></span></span> ），因此，人们在电路的前端输入部分添加了转换功能，并且引入了使能控制信号，如下图：</p><p><img data-src="Logic_Design_gated_SR_latch.jpg" alt="Logic_Design_gated_SR_latch" /></p><p>于是乎，把上面的电路称之为：<strong>门控 SR 锁存器</strong></p><p>门控使能信号（一般表示为 E 或者 C）的作用：</p><table><thead><tr><th style="text-align:center">E/C</th><th style="text-align:center">Action</th></tr></thead><tbody><tr><td style="text-align:center">0</td><td style="text-align:center">No action (keep state)</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">The same as non-clocked SR latch</td></tr></tbody></table><h2 id="门控-d锁存器"><a class="anchor" href="#门控-d锁存器">#</a> 门控 D 锁存器</h2><p>在上面已经见识到了 <strong>门控 SR 锁存器</strong>，那么稍微修改一下就会得到 <strong>门控 D 锁存器</strong>，由于是从 SR 锁存器上进行的修改，所以也存在着由<strong>或非门</strong>或者<strong>与非门</strong>所组成电路。</p><p><strong>Ⅰ、电路组成：</strong></p><ul><li><p>基于 SR NAND 锁存器的门控 D 锁存器</p><p><img data-src="676px-D-Type_Transparent_Latch.svg.png" alt="676px-D-Type_Transparent_Latch.svg" /></p></li><li><p>基于 SR NOR 锁存器的门控 D 锁存器</p><p><img data-src="676px-D-type_Transparent_Latch_(NOR).svg.png" alt="676px-D-type_Transparent_Latch_(NOR).svg" /></p></li></ul><p>对应上面两个门控 D 锁存器，其真值表都是一样的：</p><table><thead><tr><th style="text-align:center">E</th><th style="text-align:center">D</th><th style="text-align:center">Q</th><th style="text-align:center" Q="">\overline</th><th style="text-align:center">Comment</th></tr></thead><tbody><tr><td style="text-align:center">0</td><td style="text-align:center"><strong>X</strong></td><td style="text-align:center">Qprev</td><td style="text-align:center"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>Q</mi><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{Q}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0777700000000001em;vertical-align:-0.19444em;"></span><span class="mord overline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8833300000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">Q</span></span></span><span style="top:-3.80333em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span></span></span></span>prev</td><td style="text-align:center">No change</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">Reset</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">Set</td></tr></tbody></table><p>从真值表上看，可以知道，在使能信号输入为高电平（逻辑 1）时，D 锁存器才起作用，否则，输出信号将保持原状态；并且，当 D 锁存器起作用时，输出的信号 Q 状态跟 D 输入状态一致，因此，D 锁存器也叫 D 跟随。</p><p><strong>Ⅱ、时序分析</strong></p><p><img data-src="Gated%20D%20latch.png" alt="Gated D latch" /></p><p>锁存器部分相关链接：<span class="exturl" data-url="aHR0cHM6Ly9sZWFybi5jaXJjdWl0dmVyc2Uub3JnL2RvY3MvTGF0Y2hlcw==">https://learn.circuitverse.org/docs/Latches</span></p><h1 id="触发器"><a class="anchor" href="#触发器">#</a> 触发器</h1><p>触发器的类型同样也有很多种：S-R、J-K、T and D Flip flops。这里也只是分析常见的 J-K、T and D Flip flops。</p><p>根据时钟信号触发的不同，可以分为两种情况（上升沿触发和下降沿触发）：</p><p><img data-src="Logic_Design_SR_flip_flop_symbol.jpg" alt="Logic_Design_SR_flip_flop_symbol" /></p><p>从上图可以看到，上升沿触发和下降沿触发根本区别在于时钟信号输入端是否多了个非门。</p><h2 id="jk触发器"><a class="anchor" href="#jk触发器">#</a> JK 触发器</h2><p>根据边沿触发的不同，有以下两种逻辑符号：</p><p><img data-src="Logic_Design_JK_flip_flop_symbol.jpg" alt="Logic_Design_JK_flip_flop_symbol" /></p><p><strong>以上升沿为例，其电路组成如下：</strong></p><p><img data-src="jk%20flip%20flop.png" alt="jk flip flop" /></p><p><strong>对应的真值表：</strong></p><table><thead><tr><th style="text-align:center">触发</th><th style="text-align:center">J</th><th style="text-align:center">K</th><th style="text-align:center">Q</th><th style="text-align:center">Qnext</th><th style="text-align:center">Comment</th></tr></thead><tbody><tr><td style="text-align:center"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>↘</mo></mrow><annotation encoding="application/x-tex">\searrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mrel">↘</span></span></span></span></td><td style="text-align:center"><strong>X</strong></td><td style="text-align:center"><strong>X</strong></td><td style="text-align:center">Qprev</td><td style="text-align:center">Q</td><td style="text-align:center">No change</td></tr><tr><td style="text-align:center"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>↗</mo></mrow><annotation encoding="application/x-tex">\nearrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mrel">↗</span></span></span></span></td><td style="text-align:center">0</td><td style="text-align:center">0</td><td style="text-align:center">0</td><td style="text-align:center">0</td><td style="text-align:center">Hold state</td></tr><tr><td style="text-align:center"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>↗</mo></mrow><annotation encoding="application/x-tex">\nearrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mrel">↗</span></span></span></span></td><td style="text-align:center">0</td><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">Hold state</td></tr><tr><td style="text-align:center"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>↗</mo></mrow><annotation encoding="application/x-tex">\nearrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mrel">↗</span></span></span></span></td><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">0</td><td style="text-align:center">Reset</td></tr><tr><td style="text-align:center"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>↗</mo></mrow><annotation encoding="application/x-tex">\nearrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mrel">↗</span></span></span></span></td><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">Reset</td></tr><tr><td style="text-align:center"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>↗</mo></mrow><annotation encoding="application/x-tex">\nearrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mrel">↗</span></span></span></span></td><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">Set</td></tr><tr><td style="text-align:center"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>↗</mo></mrow><annotation encoding="application/x-tex">\nearrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mrel">↗</span></span></span></span></td><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">Set</td></tr><tr><td style="text-align:center"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>↗</mo></mrow><annotation encoding="application/x-tex">\nearrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mrel">↗</span></span></span></span></td><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">Toggle</td></tr><tr><td style="text-align:center"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>↗</mo></mrow><annotation encoding="application/x-tex">\nearrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mrel">↗</span></span></span></span></td><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">Toggle</td></tr></tbody></table><p><strong>时序分析：</strong></p><p><img data-src="JK%20Flip-Flop.png" alt="JK Flip-Flop" /></p><p><strong>特征方程式：</strong></p><p><img data-src="JK.png" alt="JK" /></p><h2 id="t触发器"><a class="anchor" href="#t触发器">#</a> T 触发器</h2><p>根据边沿触发的不同，有以下两种逻辑符号：</p><p><img data-src="Logic_Design_T_flip_flop_symbol.jpg" alt="Logic_Design_T_flip_flop_symbol" /></p><p><strong>以上升沿为例，其电路组成如下：</strong></p><p><img data-src="T%20flip%20flop.png" alt="T flip flop" /></p><p><strong>对应的真值表：</strong></p><table><thead><tr><th style="text-align:center">触发</th><th style="text-align:center">T</th><th style="text-align:center">Q</th><th style="text-align:center">Qnext</th><th style="text-align:center">Comment</th></tr></thead><tbody><tr><td style="text-align:center"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>↘</mo></mrow><annotation encoding="application/x-tex">\searrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mrel">↘</span></span></span></span></td><td style="text-align:center"><strong>X</strong></td><td style="text-align:center">Qprev</td><td style="text-align:center">Q</td><td style="text-align:center">No change</td></tr><tr><td style="text-align:center"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>↗</mo></mrow><annotation encoding="application/x-tex">\nearrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mrel">↗</span></span></span></span></td><td style="text-align:center">0</td><td style="text-align:center">0</td><td style="text-align:center">0</td><td style="text-align:center">Hold state</td></tr><tr><td style="text-align:center"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>↗</mo></mrow><annotation encoding="application/x-tex">\nearrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mrel">↗</span></span></span></span></td><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">Hold state</td></tr><tr><td style="text-align:center"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>↗</mo></mrow><annotation encoding="application/x-tex">\nearrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mrel">↗</span></span></span></span></td><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">Toggle</td></tr><tr><td style="text-align:center"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>↗</mo></mrow><annotation encoding="application/x-tex">\nearrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mrel">↗</span></span></span></span></td><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">Toggle</td></tr></tbody></table><p><strong>时序分析：</strong></p><p><img data-src="T%20Filp-Flop.png" alt="T Filp-Flop" /></p><p><strong>特征方程式：</strong></p><p><img data-src="T.png" alt="T" /></p><h2 id="d触发器"><a class="anchor" href="#d触发器">#</a> D 触发器</h2><p>根据边沿触发的不同，有以下两种逻辑符号：</p><p><img data-src="Logic_Design_D_flip_flop_symbols.jpg" alt="Logic_Design_D_flip_flop_symbols" /></p><p><strong>以上升沿为例，其电路组成如下：</strong></p><p><img data-src="D%20flip%20flop.png" alt="D flip flop" /></p><p><strong>对应的真值表：</strong></p><table><thead><tr><th style="text-align:center">触发</th><th style="text-align:center">D</th><th style="text-align:center">Q</th><th style="text-align:center">Qnext</th><th style="text-align:center">Comment</th></tr></thead><tbody><tr><td style="text-align:center"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>↘</mo></mrow><annotation encoding="application/x-tex">\searrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mrel">↘</span></span></span></span></td><td style="text-align:center"><strong>X</strong></td><td style="text-align:center">Qprev</td><td style="text-align:center">Q</td><td style="text-align:center">No change</td></tr><tr><td style="text-align:center"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>↗</mo></mrow><annotation encoding="application/x-tex">\nearrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mrel">↗</span></span></span></span></td><td style="text-align:center">0</td><td style="text-align:center">0</td><td style="text-align:center">0</td><td style="text-align:center">Reset</td></tr><tr><td style="text-align:center"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>↗</mo></mrow><annotation encoding="application/x-tex">\nearrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mrel">↗</span></span></span></span></td><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">Reset</td></tr><tr><td style="text-align:center"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>↗</mo></mrow><annotation encoding="application/x-tex">\nearrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mrel">↗</span></span></span></span></td><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">Set</td></tr><tr><td style="text-align:center"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>↗</mo></mrow><annotation encoding="application/x-tex">\nearrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mrel">↗</span></span></span></span></td><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">Set</td></tr></tbody></table><p><strong>时序分析：</strong></p><p><img data-src="D%20Filp-Flop.png" alt="D Filp-Flop" /></p><p><strong>特征方程式：</strong></p><p><img data-src="D.png" alt="D" /></p><p>触发器部分相关链接：<span class="exturl" data-url="aHR0cHM6Ly9sZWFybi5jaXJjdWl0dmVyc2Uub3JnL2RvY3MvZmxpcGZsb3A=">https://learn.circuitverse.org/docs/flipflop</span></p><h1 id="相关资料"><a class="anchor" href="#相关资料">#</a> 相关资料</h1><p><span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvRmxpcC1mbG9wXyhlbGVjdHJvbmljcyk=">https://en.wikipedia.org/wiki/Flip-flop_(electronics)</span></p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cueW91dHViZS5jb20vd2F0Y2g/dj0tYVFIMHliTWQzVSZhbXA7bGlzdD1SRENNVUNTWDNNUjBnbktEeHlYQXlsald6bTBRJmFtcDtzdGFydF9yYWRpbz0x">https://www.youtube.com/watch?v=-aQH0ybMd3U&amp;list=RDCMUCSX3MR0gnKDxyXAyljWzm0Q&amp;start_radio=1</span></p><p><span class="exturl" data-url="aHR0cDovL3loaHVhbmcxOTY2LmJsb2dzcG90LmNvbS8yMDE5LzA2L2xhdGNoLWZsaXAtZmxvcC5odG1s">http://yhhuang1966.blogspot.com/2019/06/latch-flip-flop.html</span></p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuZWxlY3Ryb25pY3MtdHV0b3JpYWxzLndzL3NlcXVlbnRpYWwvc2VxXzEuaHRtbA==">https://www.electronics-tutorials.ws/sequential/seq_1.html</span></p>]]></content>
      
      
      
        <tags>
            
            <tag> history </tag>
            
            <tag> 电子 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SDCC编译器 + VSCode开发 8位微控制器</title>
      <link href="/docs/IDE/SDCC%E7%BC%96%E8%AF%91%E5%99%A8%20+%20VSCode%E5%BC%80%E5%8F%91%208%E4%BD%8D%E5%BE%AE%E6%8E%A7%E5%88%B6%E5%99%A8/"/>
      <url>/docs/IDE/SDCC%E7%BC%96%E8%AF%91%E5%99%A8%20+%20VSCode%E5%BC%80%E5%8F%91%208%E4%BD%8D%E5%BE%AE%E6%8E%A7%E5%88%B6%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<blockquote><p>SDCC 是一个小型设备的 C 语言编译器，该编译器支持标准 C 语言；相对于 GCC 编译器来说可能知名度不是很高，但它跟 GCC 一样，是跨平台，并且遵循 GPL 开源协议。本次实验是使用 nuvoton 的 MS51 系列单片机来操作（基于 8051 内核）</p></blockquote><p>sdcc 官方网址：<span class="exturl" data-url="aHR0cDovL3NkY2Muc291cmNlZm9yZ2UubmV0Lw==">http://sdcc.sourceforge.net/</span></p><p>Wiki 主页：<span class="exturl" data-url="aHR0cHM6Ly9zb3VyY2Vmb3JnZS5uZXQvcC9zZGNjL3dpa2kvSG9tZS8=">https://sourceforge.net/p/sdcc/wiki/Home/</span></p><h1 id="关于-sdcc"><a class="anchor" href="#关于-sdcc">#</a> 关于 SDCC</h1><p>SDCC 是可重定目标的、优化的标准 C（ANSI C89，ISO C99，ISO C11）编译器套件，针对的是基于 Intel MCS51 的微处理器（8031、8032、8051、8052 等），Maxim（以前为达拉斯）DS80C390 变体，飞思卡尔（ 基于 HC08（hc08，s08），基于 Zilog Z80 的 MCU（z80，z180，gbz80，Rabbit 2000/3000，Rabbit 3000A，TLCS-90），Padauk（pdk14，pdk15）和 STMicroelectronics STM8。</p><p>在安装了 SDCC 后，通过指令查看版本号可以看到它所支持的设备类型：</p><p><img data-src="image-20201027210643106.png" alt="image-20201027210643106" /></p><p>然后，这里有个帖子有讨论 SDCC 的一些相关东西，而且好像（我也不确定）SDCC 的开发者也在里面，感兴趣的可以看一下：<span class="exturl" data-url="aHR0cHM6Ly93YXAubmV3c210aC5uZXQvYXJ0aWNsZS85MDVlYjI3ZGRkZjgyOWYxNWM4MTA3NzIxNWQ2NjI4ND90aXRsZT0lRTclOTQlQjUlRTglQjclQUYlRTglQUUlQkUlRTglQUUlQTElRTQlQjglOEUlRTglQjAlODMlRTglQUYlOTUmYW1wO2Zyb209c2VhcmNo">https://wap.newsmth.net/article/905eb27dddf829f15c81077215d66284?title = 电路设计与调试 &amp; from=search</span></p><p>SDCC 较于 Keil 来说，它对 C 语法的严谨度是很高的，更像一个标准的 C 语言编译器，并不会像 Keil 那样把一些 warning 去除掉，自动帮你优化；前面说了， SDCC 是一个好的编译器，可优化方面稍微有点不够完美，以至于代码生成的体积还是比 Keil C51 大一些（是不是我还有些优化指令没 get 到呢？）。</p><h1 id="安装及环境配置"><a class="anchor" href="#安装及环境配置">#</a> 安装及环境配置</h1><p><strong>1、 SDCC</strong></p><p>软件的下载路径在上面的 sdcc 主页上有对应的接口，只需要下载相关的平台程序包安装就好了，安装完成后添加系统环境变量这个就不用多说了，最后就  <code>sdcc -v</code>  测试检验。就这么简单。。。</p><p><strong>2、 MinGW-w64</strong></p><p>下载地址：<span class="exturl" data-url="aHR0cHM6Ly9zb3VyY2Vmb3JnZS5uZXQvcHJvamVjdHMvbWluZ3ctdzY0L2ZpbGVzL21pbmd3LXc2NC9taW5ndy13NjQtcmVsZWFzZS8=">https://sourceforge.net/projects/mingw-w64/files/mingw-w64/mingw-w64-release/</span></p><p>安装完成后需要添加系统环境变量，可以利用 cmd 命令： <code>gcc -v</code>  测试。</p><p><strong>3、</strong> <strong>MSYS2</strong> 或者 <strong>Git</strong>（只要支持 shell 命令的终端控制台就行）</p><p><span class="exturl" data-url="aHR0cDovL3d3dy5tc3lzMi5vcmcv">msys2 下载 &lt;-- 自戳</span></p><p>Git 自行搜索下载。</p><p><strong>2、 VSCode</strong></p><p>VSCode 环境部署可以看之前的 <span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQyOTkyMDg0L2FydGljbGUvZGV0YWlscy8xMDg4OTIxNjk=">STM32 开发之 VS Code + gcc 环境编译</span> 的第三节，然后如果你懂得配置 VSCode 的配置项的话，那么你可以跳过下面的配置操作自己写。</p><ul><li><p>c_cpp_properties.json</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token property">"configurations"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>            <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"C51"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            <span class="token property">"includePath"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token comment">// 你的工程中存放 include 的文件夹路径</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                <span class="token string">"$&#123;workspaceFolder&#125;/**"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                <span class="token string">"$&#123;workspaceFolder&#125;/App"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                <span class="token string">"$&#123;workspaceFolder&#125;/Libraries/Device/Include"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                <span class="token string">"$&#123;workspaceFolder&#125;/Libraries/StdDriver/inc"</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token property">"defines"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                <span class="token string">"_DEBUG"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                <span class="token string">"UNICODE"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                <span class="token string">"_UNICODE"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token property">"compilerPath"</span><span class="token operator">:</span> <span class="token string">"C:\\Program Files\\SDCC\\bin\\sdcc.exe"</span><span class="token punctuation">,</span><span class="token comment">//sdcc bin 路径</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token property">"cStandard"</span><span class="token operator">:</span> <span class="token string">"gnu18"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token property">"cppStandard"</span><span class="token operator">:</span> <span class="token string">"gnu++14"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token property">"intelliSenseMode"</span><span class="token operator">:</span> <span class="token string">"gcc-x64"</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token property">"version"</span><span class="token operator">:</span> <span class="token number">4</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></li><li><p>tasks.json</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">// See https://go.microsoft.com/fwlink/?LinkId=733558</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// for the documentation about the tasks.json format</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"2.0.0"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token property">"tasks"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token property">"label"</span><span class="token operator">:</span> <span class="token string">"Build"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"shell"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token property">"command"</span><span class="token operator">:</span> <span class="token string">"make"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token property">"args"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                <span class="token string">"target=$&#123;fileBasenameNoExtension&#125;"</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token property">"group"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"build"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                <span class="token property">"isDefault"</span><span class="token operator">:</span> <span class="token boolean">true</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></li><li><p>settings.json</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token property">"files.encoding"</span><span class="token operator">:</span> <span class="token string">"gb2312"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token property">"files.autoGuessEncoding"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token property">"C_Cpp.errorSquiggles"</span><span class="token operator">:</span> <span class="token string">"Enabled"</span><span class="token punctuation">,</span>     <span class="token comment">// 语法错误</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token property">"files.associations"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token property">"main.h"</span><span class="token operator">:</span> <span class="token string">"c"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    </pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">/* 终端在 Windows 上使用的 shell 的路径 */</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token property">"terminal.integrated.shell.windows"</span><span class="token operator">:</span> <span class="token string">"C:\\Program Files\\Git\\bin\\bash.exe"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></li></ul><h1 id="sdcc规则仅对于-mcs51说明"><a class="anchor" href="#sdcc规则仅对于-mcs51说明">#</a> SDCC 规则（仅对于 MCS51 说明）</h1><p><strong>1、支持的数据类型</strong></p><p><img data-src="image-20201027235219085.png" alt="image-20201027235219085" /></p><p><strong>2、存储类型</strong></p><p><img data-src="image-20201027235506151.png" alt="image-20201027235506151" /></p><p>相对于 Keil，其存储类型关键字加上了前缀 ’ __ ' 双下划线，这也是 SDCC 的特色风格。</p><p><code>__data</code>  ：这是小内存模式的默认 (通用) 地址空间，声明的变量将被放在 8051 内核的直接寻址 RAM 中。</p><p><code>__idata</code>  ：这个地址空间中的变量将被分配到 8051 的内部 RAM 的间接可寻址部分。</p><p><code>__pdata</code>  ：存储类型 pdata 用于访问分页的外部数据存储器。</p><p><code>__xdata</code>  ：这个地址空间中的变量将被放在外部 RAM 中。</p><p><code>__code</code>  ：存放程序代码的内存地址空间。</p><p><strong>3、存储器模式</strong></p><p>SDCC 支持四种存储器模式：(small, medium, large, huge)</p><p>采用 SDCC 编译时，默认为小模式。如果要强制 SDCC 使用特定的存储器模式，可使用以下命令行参数（在手册的 P3.3.6 章节可以查询得到）：</p><p><img data-src="image-20201029212546249.png" alt="image-20201029212546249" /></p><p>类似于 Keil 的这个选项（只不过 Keil 是 GUI 操作，SDCC 是命令操作）：</p><p><img data-src="image-20201029212824145.png" alt="image-20201029212824145" /></p><p>关于不同模式下变量的存储位置不一样，可以查阅手册 P3.13 章节；总的来说，对于中（medium）、大（large）、巨大（huge）存储模式来说，所有未指定内部命名地址空间而声明的变量都将分配到外部 RAM 中，这包括所有参数和局部变量（用于不可重入函数），中型模式使用 pdata，大型模式使用 xdata；而小内存模式（small）则默认存放在 data。</p><p><strong>4、bit 和 sbit 关键字</strong></p><p>bit 和 int、char 之类的差不多，只不过 char = 8 位，bit = 1 位；</p><p>sbit 是对应可位寻址空间的一个位。</p><p>同样的，在 SDCC 这里加上了前缀 ’ __ ’  双下划线，变成  <code>__bit</code> 、 <code>__sbit</code></p><p><strong>5、SFR（特殊功能寄存器）</strong></p><p>与 bit 关键字类似，表示命名地址空间，用于描述 8051 的特殊函数寄存器和特殊位变量。</p><p>eg：</p><p>    __sfr __at (0x80) P0;/* special function register P0 at location 0x80 */</p><p><strong>6、绝对寻址</strong></p><p>SDCC 支持采用  <code>__at</code>  关键字表示绝对寻址。</p><p><strong>7、内嵌汇编</strong></p><p>SDCC 完全支持内嵌汇编。使用该功能时，汇编代码应嵌在  <code>__asm</code>  和  <code>__endasm</code>  标识符之间。</p><p><strong>8、编译生成文件</strong></p><ul><li>xxx.asm：程序的汇编文件。</li><li>xxx.lst：程序的列表文件。</li><li>xxx.rst：被链接器更新的列表文件。</li><li>xxx.sym：由链接器生成的符号清单。</li><li>xxx.rel：由汇编器生成的对象文件，提供给链接器使用。</li><li>xxx.map：被链接器更新的最终存储器映射。</li><li>xxx.mem：内存的使用情况摘要。</li><li>xxx.ihx：Intel 十六进制格式的加载模块。该文件必须被下载到微控制器中。</li></ul><h1 id="sdcc头文件处理"><a class="anchor" href="#sdcc头文件处理">#</a> SDCC 头文件处理</h1><p>前面说了，sdcc 的非标关键字是带 ‘ __ ' 双下滑线的，但是 MS51 的官方 SDK 包中，寄存器寻址的关键字全是 keil 格式的，这就需要转换过来；如果是一些成熟的 8051 内核单片机，那么你可以在 sdcc 的安装路径 ...\SDCC\include\mcs51 下找到对应的芯片头文件，若是没有，那么就要自己进行格式转换了。sdcc 格式转换，你可以去上网搜一下，这里给一个链接：<span class="exturl" data-url="aHR0cHM6Ly93d3cuYW1vYmJzLmNvbS90aHJlYWQtNTYyNTA0MC0xLTEuaHRtbCVFRiVCQyU4QyVFOSU4NyU4QyVFOSU5RCVBMiVFNiU5QyU4OSVFNiU4RiU5MCVFNCVCRSU5QiVFNCVCOCU4MCVFNCVCOCVBQSVFOCVCRCVBQyVFNiU4RCVBMiVFNSVCNyVBNSVFNSU4NSVCNyVFRiVCQyU4QyVFNSVCRCU5MyVFNyU4NCVCNiVFNCVCRCVBMCVFNCVCOSU5RiVFNSU4RiVBRiVFNCVCQiVBNSVFOCU4NyVBQSVFNSVCNyVCMSVFNSU4RSVCQiVFNSU4NiU5OSVFNCVCOCU4MCVFNCVCOCVBQSVFNyVBOCU4QiVFNSVCQSU4RiVFMyU4MCU4Mg==">https://www.amobbs.com/thread-5625040-1-1.html，里面有提供一个转换工具，当然你也可以自己去写一个程序。</span></p><p><img data-src="MS51%20include.png" alt="MS51 include" /></p><h1 id="工程构建"><a class="anchor" href="#工程构建">#</a> 工程构建</h1><p>因为是用 VSCode 做编辑开发，只要有 .vscode 文件夹的配置项就可以了，剩下的编译过程就交给 sdcc 编译，所以工程的构建比较简单，文件夹创建以及移植 SDK 库都方便，以下是我的工程文件分布（看起来还是比较容易理解的）：</p><p><img data-src="image-20201028213341368.png" alt="image-20201028213341368" /></p><p>这里 Libraries 文件夹的内容是直接移植 SDK 库的，其余的看文件名就知道用途了。</p><p>另外就是，App 文件夹里，除了 lint.h（用来语法解析 mcs51 特定代码）和添加了 main.h 头文件（往常 main 主文件是不带头文件）；然后为什么要这两个呢，是为了避免 VSCode 的语法错误的，当然你也可以一劳永逸，直接关了 VSCode 的语法提示（这个可以看上面的 settings.json 配置文件），至于 lint.h 是从 sdcc 的安装路径 ...\SDCC\include\mcs51 提取出来的，原滋原味。</p><h1 id="vscode语法修饰"><a class="anchor" href="#vscode语法修饰">#</a> VSCode 语法修饰</h1><p>上面也讲了，sdcc 使用了部分非 ASCII C 关键字，所以 VSCode 会在程序中凸显语法错误；那么，我们就来解决这个问题（当然，不是用关闭语法检查这种粗暴形式）：</p><p>1、首先要了解的是，在使用 sdcc 进行编译的时候，是会自动在进行编译前预定义  <code>__SDCC</code>  宏的，这样就好办，利用条件编译，区别智能提示运行环境和 SDCC 实际编译环境，用空的 define 去取代这些关键字，寄存器也都用宏代替，然后在 SDCC 实际编译时调用原来 C51 语法的寄存器定义。</p><p>2、根据上面第一点，然后结合上面的提到的 lint.h（默认是留了 sdcc 关键字的空 define），得到这样的一个例子：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__SDCC</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    __sfr <span class="token function">__at</span> <span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">)</span> P0<span class="token punctuation">;</span>    <span class="token comment">// 实际有效的寄存器定义</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">/* 关键字部分 */</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__sfr</span>                    <span class="token comment">// 空的关键字宏，消除关键字不兼容 (在 lint.h 上可以获取到相关的关键字)</span></span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">/* 寄存器部分 */</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P0</span>    <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">// 无实际意义，用于兼容（欺骗）标准 C 语法的寄存器符号</span></span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr></table></figure><p>通过以上条件编译，就可以把代码区分到智能提示和实际编译两个环境：</p><ul><li>在实际编译时，SDCC 编译器会预定义  <code>__SDCC</code>  宏，因此实际编译时使用实际有效的寄存器定义；</li><li>而在智能提示环境，用空的宏取代所有关键字，消除关键字的不兼容，然后用一个宏定义寄存器，保证寄存器名智能提示依然可以使用。这里将寄存器定义为 char* 指针解引用的左值表达式，目的是为迎合语法上对寄存器赋值是合法的，括号里的值可以是任意值，意义不大，当然如果使用寄存器本来的值更合适，但处理起来比较麻烦。</li></ul><p>3、对上面的 1、2 点总结起来，就可以得到：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__MAIN_H__</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__MAIN_H__</span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__SDCC</span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"MS51_16K.h"</span></span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdbool.h></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lint.h"</span></span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"SFR_Macro_MS51_16K.h"</span></span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">/******************************************************************************/</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">/*                      Macro define  header files                            */</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">/******************************************************************************/</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P0</span>          <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0x80;</span></span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SP</span>          <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0x81;</span></span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DPL</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0x82;</span></span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DPH</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0x83;</span></span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RCTRIM0</span>     <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0x84;</span></span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RCTRIM1</span>     <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0x85;  </span></span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RWK</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0x86;</span></span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PCON</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0x87;</span></span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TCON</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0x88;</span></span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TMOD</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0x89;</span></span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TL0</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0x8A;</span></span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TL1</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0x8B;</span></span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TH0</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0x8C;</span></span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TH1</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0x8D;</span></span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CKCON</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0x8E;</span></span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">WKCON</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0x8F;</span></span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P1</span>          <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0x90;</span></span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SFRS</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0x91; //TA Protection</span></span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CAPCON0</span>     <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0x92;</span></span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CAPCON1</span>     <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0x93;</span></span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CAPCON2</span>     <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0x94;</span></span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CKDIV</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0x95;</span></span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CKSWT</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0x96; //TA Protection</span></span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CKEN</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0x97; //TA Protection</span></span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCON</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0x98;</span></span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SBUF</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0x99;</span></span></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SBUF_1</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0x9A;</span></span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EIE</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0x9B;</span></span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EIE1</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0x9C;</span></span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CHPCON</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0x9F; //TA Protection</span></span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P2</span>          <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xA0;</span></span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AUXR1</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xA2;</span></span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BODCON0</span>     <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xA3; //TA Protection</span></span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IAPTRG</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xA4; //TA Protection</span></span></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IAPUEN</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xA5;  //TA Protection</span></span></pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IAPAL</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xA6;</span></span></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IAPAH</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xA7;</span></span></pre></td></tr><tr><td data-num="60"></td><td><pre></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IE</span>          <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xA8;</span></span></pre></td></tr><tr><td data-num="62"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SADDR</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xA9;</span></span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">WDCON</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xAA; //TA Protection</span></span></pre></td></tr><tr><td data-num="64"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BODCON1</span>     <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xAB; //TA Protection</span></span></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P3M1</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xAC;</span></span></pre></td></tr><tr><td data-num="66"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P3S</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xAC; //Page1</span></span></pre></td></tr><tr><td data-num="67"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P3M2</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xAD;</span></span></pre></td></tr><tr><td data-num="68"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P3SR</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xAD; //Page1</span></span></pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IAPFD</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xAE;</span></span></pre></td></tr><tr><td data-num="70"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IAPCN</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xAF;</span></span></pre></td></tr><tr><td data-num="71"></td><td><pre></pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P3</span>          <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xB0;</span></span></pre></td></tr><tr><td data-num="73"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P0M1</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xB1;</span></span></pre></td></tr><tr><td data-num="74"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P0S</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xB1; //Page1</span></span></pre></td></tr><tr><td data-num="75"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P0M2</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xB2;</span></span></pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P0SR</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xB2; //Page1</span></span></pre></td></tr><tr><td data-num="77"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P1M1</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xB3;</span></span></pre></td></tr><tr><td data-num="78"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P1S</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xB3; //Page1</span></span></pre></td></tr><tr><td data-num="79"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P1M2</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xB4;</span></span></pre></td></tr><tr><td data-num="80"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P1SR</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xB4; //Page1</span></span></pre></td></tr><tr><td data-num="81"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P2S</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xB5; </span></span></pre></td></tr><tr><td data-num="82"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IPH</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xB7;</span></span></pre></td></tr><tr><td data-num="83"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PWMINTC</span>     <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xB7;  //Page1</span></span></pre></td></tr><tr><td data-num="84"></td><td><pre></pre></td></tr><tr><td data-num="85"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IP</span>          <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xB8;</span></span></pre></td></tr><tr><td data-num="86"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SADEN</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xB9;</span></span></pre></td></tr><tr><td data-num="87"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SADEN_1</span>     <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xBA;</span></span></pre></td></tr><tr><td data-num="88"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SADDR_1</span>     <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xBB;</span></span></pre></td></tr><tr><td data-num="89"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2DAT</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xBC;</span></span></pre></td></tr><tr><td data-num="90"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2STAT</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xBD;</span></span></pre></td></tr><tr><td data-num="91"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2CLK</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xBE;</span></span></pre></td></tr><tr><td data-num="92"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2TOC</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xBF;</span></span></pre></td></tr><tr><td data-num="93"></td><td><pre></pre></td></tr><tr><td data-num="94"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2CON</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xC0;</span></span></pre></td></tr><tr><td data-num="95"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2ADDR</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xC1;</span></span></pre></td></tr><tr><td data-num="96"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ADCRL</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xC2;</span></span></pre></td></tr><tr><td data-num="97"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ADCRH</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xC3;</span></span></pre></td></tr><tr><td data-num="98"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">T3CON</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xC4;</span></span></pre></td></tr><tr><td data-num="99"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PWM4H</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xC4; //Page1</span></span></pre></td></tr><tr><td data-num="100"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RL3</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xC5;</span></span></pre></td></tr><tr><td data-num="101"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PWM5H</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xC5;  //Page1</span></span></pre></td></tr><tr><td data-num="102"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RH3</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xC6;</span></span></pre></td></tr><tr><td data-num="103"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PIOCON1</span>     <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xC6; //Page1</span></span></pre></td></tr><tr><td data-num="104"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TA</span>          <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xC7;</span></span></pre></td></tr><tr><td data-num="105"></td><td><pre></pre></td></tr><tr><td data-num="106"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">T2CON</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xC8;</span></span></pre></td></tr><tr><td data-num="107"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">T2MOD</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xC9;</span></span></pre></td></tr><tr><td data-num="108"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RCMP2L</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xCA;</span></span></pre></td></tr><tr><td data-num="109"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RCMP2H</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xCB;</span></span></pre></td></tr><tr><td data-num="110"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TL2</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xCC; </span></span></pre></td></tr><tr><td data-num="111"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PWM4L</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xCC; //Page1</span></span></pre></td></tr><tr><td data-num="112"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TH2</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xCD;</span></span></pre></td></tr><tr><td data-num="113"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PWM5L</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xCD; //Page1</span></span></pre></td></tr><tr><td data-num="114"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ADCMPL</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xCE;</span></span></pre></td></tr><tr><td data-num="115"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ADCMPH</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xCF;</span></span></pre></td></tr><tr><td data-num="116"></td><td><pre></pre></td></tr><tr><td data-num="117"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PSW</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xD0;</span></span></pre></td></tr><tr><td data-num="118"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PWMPH</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xD1;</span></span></pre></td></tr><tr><td data-num="119"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PWM0H</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xD2;</span></span></pre></td></tr><tr><td data-num="120"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PWM1H</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xD3;</span></span></pre></td></tr><tr><td data-num="121"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PWM2H</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xD4;</span></span></pre></td></tr><tr><td data-num="122"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PWM3H</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xD5;</span></span></pre></td></tr><tr><td data-num="123"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PNP</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xD6;</span></span></pre></td></tr><tr><td data-num="124"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FBD</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xD7;</span></span></pre></td></tr><tr><td data-num="125"></td><td><pre></pre></td></tr><tr><td data-num="126"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PWMCON0</span>     <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xD8;</span></span></pre></td></tr><tr><td data-num="127"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PWMPL</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xD9;</span></span></pre></td></tr><tr><td data-num="128"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PWM0L</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xDA;</span></span></pre></td></tr><tr><td data-num="129"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PWM1L</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xDB;</span></span></pre></td></tr><tr><td data-num="130"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PWM2L</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xDC;</span></span></pre></td></tr><tr><td data-num="131"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PWM3L</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xDD;</span></span></pre></td></tr><tr><td data-num="132"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PIOCON0</span>     <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xDE;</span></span></pre></td></tr><tr><td data-num="133"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PWMCON1</span>     <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xDF;</span></span></pre></td></tr><tr><td data-num="134"></td><td><pre></pre></td></tr><tr><td data-num="135"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ACC</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xE0;</span></span></pre></td></tr><tr><td data-num="136"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ADCCON1</span>     <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xE1;</span></span></pre></td></tr><tr><td data-num="137"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ADCCON2</span>     <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xE2;</span></span></pre></td></tr><tr><td data-num="138"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ADCDLY</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xE3;</span></span></pre></td></tr><tr><td data-num="139"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">C0L</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xE4;</span></span></pre></td></tr><tr><td data-num="140"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">C0H</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xE5;</span></span></pre></td></tr><tr><td data-num="141"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">C1L</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xE6;</span></span></pre></td></tr><tr><td data-num="142"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">C1H</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xE7;</span></span></pre></td></tr><tr><td data-num="143"></td><td><pre></pre></td></tr><tr><td data-num="144"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ADCCON0</span>     <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xE8;</span></span></pre></td></tr><tr><td data-num="145"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PICON</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xE9;</span></span></pre></td></tr><tr><td data-num="146"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PINEN</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xEA;</span></span></pre></td></tr><tr><td data-num="147"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PIPEN</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xEB;</span></span></pre></td></tr><tr><td data-num="148"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PIF</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xEC;</span></span></pre></td></tr><tr><td data-num="149"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">C2L</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xED;</span></span></pre></td></tr><tr><td data-num="150"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">C2H</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xEE;</span></span></pre></td></tr><tr><td data-num="151"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EIP</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xEF;</span></span></pre></td></tr><tr><td data-num="152"></td><td><pre></pre></td></tr><tr><td data-num="153"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">B</span>           <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xF0;</span></span></pre></td></tr><tr><td data-num="154"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CAPCON3</span>     <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xF1;</span></span></pre></td></tr><tr><td data-num="155"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CAPCON4</span>     <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xF2;</span></span></pre></td></tr><tr><td data-num="156"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SPCR</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xF3;</span></span></pre></td></tr><tr><td data-num="157"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SPCR2</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xF3; //Page1</span></span></pre></td></tr><tr><td data-num="158"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SPSR</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xF4;</span></span></pre></td></tr><tr><td data-num="159"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SPDR</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xF5;</span></span></pre></td></tr><tr><td data-num="160"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AINDIDS</span>     <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xF6;</span></span></pre></td></tr><tr><td data-num="161"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EIPH</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xF7;</span></span></pre></td></tr><tr><td data-num="162"></td><td><pre></pre></td></tr><tr><td data-num="163"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCON_1</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xF8;</span></span></pre></td></tr><tr><td data-num="164"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PDTEN</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xF9; //TA Protection</span></span></pre></td></tr><tr><td data-num="165"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PDTCNT</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xFA; //TA Protection</span></span></pre></td></tr><tr><td data-num="166"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PMEN</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xFB;</span></span></pre></td></tr><tr><td data-num="167"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PMD</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xFC;</span></span></pre></td></tr><tr><td data-num="168"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EIP1</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xFE;</span></span></pre></td></tr><tr><td data-num="169"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EIPH1</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= 0xFF;</span></span></pre></td></tr><tr><td data-num="170"></td><td><pre></pre></td></tr><tr><td data-num="171"></td><td><pre><span class="token comment">/*  BIT Registers  */</span></pre></td></tr><tr><td data-num="172"></td><td><pre><span class="token comment">/*  SCON_1  */</span></pre></td></tr><tr><td data-num="173"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SM0_1</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= SCON_1^7;</span></span></pre></td></tr><tr><td data-num="174"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FE_1</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= SCON_1^7; </span></span></pre></td></tr><tr><td data-num="175"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SM1_1</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= SCON_1^6; </span></span></pre></td></tr><tr><td data-num="176"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SM2_1</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= SCON_1^5; </span></span></pre></td></tr><tr><td data-num="177"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">REN_1</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= SCON_1^4; </span></span></pre></td></tr><tr><td data-num="178"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TB8_1</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= SCON_1^3; </span></span></pre></td></tr><tr><td data-num="179"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RB8_1</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= SCON_1^2; </span></span></pre></td></tr><tr><td data-num="180"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TI_1</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= SCON_1^1; </span></span></pre></td></tr><tr><td data-num="181"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RI_1</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= SCON_1^0; </span></span></pre></td></tr><tr><td data-num="182"></td><td><pre></pre></td></tr><tr><td data-num="183"></td><td><pre><span class="token comment">/*  ADCCON0  */</span></pre></td></tr><tr><td data-num="184"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ADCF</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= ADCCON0^7;</span></span></pre></td></tr><tr><td data-num="185"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ADCS</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= ADCCON0^6;</span></span></pre></td></tr><tr><td data-num="186"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ETGSEL1</span>    <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= ADCCON0^5;</span></span></pre></td></tr><tr><td data-num="187"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ETGSEL0</span>    <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= ADCCON0^4;</span></span></pre></td></tr><tr><td data-num="188"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ADCHS3</span>     <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= ADCCON0^3;</span></span></pre></td></tr><tr><td data-num="189"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ADCHS2</span>     <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= ADCCON0^2;</span></span></pre></td></tr><tr><td data-num="190"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ADCHS1</span>     <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= ADCCON0^1;</span></span></pre></td></tr><tr><td data-num="191"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ADCHS0</span>     <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= ADCCON0^0;</span></span></pre></td></tr><tr><td data-num="192"></td><td><pre></pre></td></tr><tr><td data-num="193"></td><td><pre><span class="token comment">/*  PWMCON0  */</span></pre></td></tr><tr><td data-num="194"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PWMRUN</span>     <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= PWMCON0^7;</span></span></pre></td></tr><tr><td data-num="195"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LOAD</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= PWMCON0^6;</span></span></pre></td></tr><tr><td data-num="196"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PWMF</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= PWMCON0^5;</span></span></pre></td></tr><tr><td data-num="197"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CLRPWM</span>     <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= PWMCON0^4;</span></span></pre></td></tr><tr><td data-num="198"></td><td><pre></pre></td></tr><tr><td data-num="199"></td><td><pre></pre></td></tr><tr><td data-num="200"></td><td><pre><span class="token comment">/*  PSW */</span></pre></td></tr><tr><td data-num="201"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CY</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= PSW^7;</span></span></pre></td></tr><tr><td data-num="202"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AC</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= PSW^6;</span></span></pre></td></tr><tr><td data-num="203"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">F0</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= PSW^5;</span></span></pre></td></tr><tr><td data-num="204"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RS1</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= PSW^4;</span></span></pre></td></tr><tr><td data-num="205"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RS0</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= PSW^3;</span></span></pre></td></tr><tr><td data-num="206"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OV</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= PSW^2;</span></span></pre></td></tr><tr><td data-num="207"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P</span>          <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= PSW^0;</span></span></pre></td></tr><tr><td data-num="208"></td><td><pre></pre></td></tr><tr><td data-num="209"></td><td><pre><span class="token comment">/*  T2CON  */</span></pre></td></tr><tr><td data-num="210"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TF2</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= T2CON^7;</span></span></pre></td></tr><tr><td data-num="211"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TR2</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= T2CON^2;</span></span></pre></td></tr><tr><td data-num="212"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CM_RL2</span>     <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= T2CON^0;</span></span></pre></td></tr><tr><td data-num="213"></td><td><pre> </pre></td></tr><tr><td data-num="214"></td><td><pre><span class="token comment">/*  I2CON  */</span></pre></td></tr><tr><td data-num="215"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2CEN</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= I2CON^6;</span></span></pre></td></tr><tr><td data-num="216"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">STA</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= I2CON^5;</span></span></pre></td></tr><tr><td data-num="217"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">STO</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= I2CON^4;</span></span></pre></td></tr><tr><td data-num="218"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SI</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= I2CON^3;</span></span></pre></td></tr><tr><td data-num="219"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AA</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= I2CON^2;</span></span></pre></td></tr><tr><td data-num="220"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2CPX</span>  <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= I2CON^0;</span></span></pre></td></tr><tr><td data-num="221"></td><td><pre></pre></td></tr><tr><td data-num="222"></td><td><pre><span class="token comment">/*  IP  */</span>  </pre></td></tr><tr><td data-num="223"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PADC</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= IP^6;</span></span></pre></td></tr><tr><td data-num="224"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PBOD</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= IP^5;</span></span></pre></td></tr><tr><td data-num="225"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PS</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= IP^4;</span></span></pre></td></tr><tr><td data-num="226"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PT1</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= IP^3;</span></span></pre></td></tr><tr><td data-num="227"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PX1</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= IP^2;</span></span></pre></td></tr><tr><td data-num="228"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PT0</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= IP^1;</span></span></pre></td></tr><tr><td data-num="229"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PX0</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= IP^0;</span></span></pre></td></tr><tr><td data-num="230"></td><td><pre></pre></td></tr><tr><td data-num="231"></td><td><pre><span class="token comment">/*  P3  */</span>  </pre></td></tr><tr><td data-num="232"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P30</span>    <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= P3^0;</span></span></pre></td></tr><tr><td data-num="233"></td><td><pre></pre></td></tr><tr><td data-num="234"></td><td><pre></pre></td></tr><tr><td data-num="235"></td><td><pre><span class="token comment">/*  IE  */</span></pre></td></tr><tr><td data-num="236"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EA</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= IE^7;</span></span></pre></td></tr><tr><td data-num="237"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EADC</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= IE^6;</span></span></pre></td></tr><tr><td data-num="238"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EBOD</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= IE^5;</span></span></pre></td></tr><tr><td data-num="239"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ES</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= IE^4;</span></span></pre></td></tr><tr><td data-num="240"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ET1</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= IE^3;</span></span></pre></td></tr><tr><td data-num="241"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EX1</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= IE^2;</span></span></pre></td></tr><tr><td data-num="242"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ET0</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= IE^1;</span></span></pre></td></tr><tr><td data-num="243"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EX0</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= IE^0;</span></span></pre></td></tr><tr><td data-num="244"></td><td><pre></pre></td></tr><tr><td data-num="245"></td><td><pre><span class="token comment">/*  P2  */</span> </pre></td></tr><tr><td data-num="246"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P20</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= P2^0;</span></span></pre></td></tr><tr><td data-num="247"></td><td><pre></pre></td></tr><tr><td data-num="248"></td><td><pre><span class="token comment">/*  SCON  */</span></pre></td></tr><tr><td data-num="249"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SM0</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= SCON^7;</span></span></pre></td></tr><tr><td data-num="250"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FE</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= SCON^7; </span></span></pre></td></tr><tr><td data-num="251"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SM1</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= SCON^6; </span></span></pre></td></tr><tr><td data-num="252"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SM2</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= SCON^5; </span></span></pre></td></tr><tr><td data-num="253"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">REN</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= SCON^4; </span></span></pre></td></tr><tr><td data-num="254"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TB8</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= SCON^3; </span></span></pre></td></tr><tr><td data-num="255"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RB8</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= SCON^2; </span></span></pre></td></tr><tr><td data-num="256"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TI</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= SCON^1; </span></span></pre></td></tr><tr><td data-num="257"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RI</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= SCON^0; </span></span></pre></td></tr><tr><td data-num="258"></td><td><pre></pre></td></tr><tr><td data-num="259"></td><td><pre><span class="token comment">/*  P1  */</span>     </pre></td></tr><tr><td data-num="260"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P17</span>  <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= P1^7;</span></span></pre></td></tr><tr><td data-num="261"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P16</span>  <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= P1^6;</span></span></pre></td></tr><tr><td data-num="262"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TXD_1</span>  <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= P1^6; </span></span></pre></td></tr><tr><td data-num="263"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P15</span>  <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= P1^5;</span></span></pre></td></tr><tr><td data-num="264"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P14</span>  <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= P1^4;</span></span></pre></td></tr><tr><td data-num="265"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDA</span>  <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= P1^4;    </span></span></pre></td></tr><tr><td data-num="266"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P13</span>  <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= P1^3;</span></span></pre></td></tr><tr><td data-num="267"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCL</span>  <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= P1^3;  </span></span></pre></td></tr><tr><td data-num="268"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P12</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= P1^2; </span></span></pre></td></tr><tr><td data-num="269"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P11</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= P1^1;</span></span></pre></td></tr><tr><td data-num="270"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P10</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= P1^0;</span></span></pre></td></tr><tr><td data-num="271"></td><td><pre></pre></td></tr><tr><td data-num="272"></td><td><pre><span class="token comment">/*  TCON  */</span></pre></td></tr><tr><td data-num="273"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TF1</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= TCON^7;</span></span></pre></td></tr><tr><td data-num="274"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TR1</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= TCON^6;</span></span></pre></td></tr><tr><td data-num="275"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TF0</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= TCON^5;</span></span></pre></td></tr><tr><td data-num="276"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TR0</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= TCON^4;</span></span></pre></td></tr><tr><td data-num="277"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IE1</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= TCON^3;</span></span></pre></td></tr><tr><td data-num="278"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IT1</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= TCON^2;</span></span></pre></td></tr><tr><td data-num="279"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IE0</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= TCON^1;</span></span></pre></td></tr><tr><td data-num="280"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IT0</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= TCON^0;</span></span></pre></td></tr><tr><td data-num="281"></td><td><pre></pre></td></tr><tr><td data-num="282"></td><td><pre><span class="token comment">/*  P0  */</span>  </pre></td></tr><tr><td data-num="283"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P07</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= P0^7;</span></span></pre></td></tr><tr><td data-num="284"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RXD</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= P0^7;</span></span></pre></td></tr><tr><td data-num="285"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P06</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= P0^6;</span></span></pre></td></tr><tr><td data-num="286"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TXD</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= P0^6;</span></span></pre></td></tr><tr><td data-num="287"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P05</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= P0^5;</span></span></pre></td></tr><tr><td data-num="288"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P04</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= P0^4;</span></span></pre></td></tr><tr><td data-num="289"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">STADC</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= P0^4;</span></span></pre></td></tr><tr><td data-num="290"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P03</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= P0^3;</span></span></pre></td></tr><tr><td data-num="291"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P02</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= P0^2;</span></span></pre></td></tr><tr><td data-num="292"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RXD_1</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= P0^2;</span></span></pre></td></tr><tr><td data-num="293"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P01</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= P0^1;</span></span></pre></td></tr><tr><td data-num="294"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MISO</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= P0^1;</span></span></pre></td></tr><tr><td data-num="295"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P00</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= P0^0;</span></span></pre></td></tr><tr><td data-num="296"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MOSI</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//= P0^0;</span></span></pre></td></tr><tr><td data-num="297"></td><td><pre></pre></td></tr><tr><td data-num="298"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __SDCC */</span></span></pre></td></tr><tr><td data-num="299"></td><td><pre></pre></td></tr><tr><td data-num="300"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __MAIN_H__ */</span></span></pre></td></tr></table></figure><p>对于寄存器定义处理，可以直接 copy 原来的 include 文件内容，然后直接把  <code>sfr</code> 、 <code>sbit</code>  替换成  <code>#define</code>  ，再把  <code>=</code>  替换成  <code>(*(char *) (0)) //=</code>  这样就好，是不是很 nice。</p><h1 id="makefile程序化管理"><a class="anchor" href="#makefile程序化管理">#</a> Makefile 程序化管理</h1><p>SDCC 并不支持同时编译多个源代码文件，所以多文件项目的编译需要分步进行。假如你的项目包含  <code>foo1.c</code>   <code>foo2.c</code>   <code>main.c</code>  三个文件，那么编译过程如下：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>sdcc <span class="token parameter variable">-c</span> foo1.c</pre></td></tr><tr><td data-num="2"></td><td><pre>sdcc <span class="token parameter variable">-c</span> foo2.c</pre></td></tr><tr><td data-num="3"></td><td><pre>sdcc main.c foo1.rel foo2.rel</pre></td></tr></table></figure><p>还可以使用以下方式编译:</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>sdcc <span class="token parameter variable">-c</span> main.c</pre></td></tr><tr><td data-num="2"></td><td><pre>sdcc main.rel foo1.rel foo2.rel</pre></td></tr></table></figure><p>值得一提的是，sdcc 与 gcc 的命令支持还是有点出入的，但大部分都兼容，因此具体支持哪些命令，需要去翻看 sdcc 的手册。</p><p>对于多文件项目最好是写一个 Makefile 文件来维护或者写一个 bat 批处理文件。这里就直接给出我所用的 Makefile 文件吧，分析什么的，可以看以前的链接：<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQyOTkyMDg0L2FydGljbGUvZGV0YWlscy85NTg5MzI4MyVFRiVCQyU5QiVFNSVBNiU4MiVFNiU5RSU5QyVFNCVCRCVBMCVFNiU5OCVBRg==">https://blog.csdn.net/qq_42992084/article/details/95893283；如果你是</span> Linux 用户，应该很清楚这些命令，若果诸位大佬有懂得多的，还请在评论区不吝赐教：</p><figure class="highlight makefile"><figcaption data-lang="makefile"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">######################################</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># target path</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">######################################</span></pre></td></tr><tr><td data-num="4"></td><td><pre>TARGET <span class="token operator">=</span> MS51FB</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">#######################################</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># Build path</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">#######################################</span></pre></td></tr><tr><td data-num="9"></td><td><pre>BUILD_DIR <span class="token operator">=</span> build</pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">######################################</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># source</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">######################################</span></pre></td></tr><tr><td data-num="14"></td><td><pre>SRCDIR <span class="token operator">=</span> App</pre></td></tr><tr><td data-num="15"></td><td><pre>LIB_SRC <span class="token operator">=</span> <span class="token comment">#Libraries/StdDriver/src</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>USER_SRC <span class="token operator">=</span> source<span class="token comment">#/bsp.c \</pre></td></tr><tr><td data-num="18"></td><td><pre>source/bsp_time.c \</pre></td></tr><tr><td data-num="19"></td><td><pre>source/bsp_uart.c</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment"># C sources</span></pre></td></tr><tr><td data-num="22"></td><td><pre>C_SOURCES <span class="token operator">:=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">wildcard</span> <span class="token variable">$</span><span class="token punctuation">(</span>SRCDIR<span class="token punctuation">)</span>/*.c <span class="token variable">$</span><span class="token punctuation">(</span>LIB_SRC<span class="token punctuation">)</span>/*.c<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>C_SOURCES <span class="token operator">+=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">wildcard</span> <span class="token variable">$</span><span class="token punctuation">(</span>USER_SRC<span class="token punctuation">)</span>/*.c<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>ASM_SOURCES <span class="token operator">=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">wildcard</span> <span class="token variable">$</span><span class="token punctuation">(</span>SRCDIR<span class="token punctuation">)</span>/*.asm<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>C_SRC_FILE <span class="token operator">=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">notdir</span> <span class="token variable">$</span><span class="token punctuation">(</span>C_SOURCES<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre>C_OBJ_FILE <span class="token operator">=</span> <span class="token variable">$</span><span class="token punctuation">(</span>C_SRC_FILE<span class="token punctuation">:</span>%.c<span class="token operator">=</span>%.c.rel<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>ASM_SRC_FILE <span class="token operator">=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">notdir</span> <span class="token variable">$</span><span class="token punctuation">(</span>ASM_SOURCES<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>ASM_OBJ_FILE <span class="token operator">=</span> <span class="token variable">$</span><span class="token punctuation">(</span>ASM_SRC_FILE<span class="token punctuation">:</span>%.asm<span class="token operator">=</span>%.asm.rel<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token comment">######################################</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token comment"># building variables</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token comment">######################################</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token comment"># debug build?</span></pre></td></tr><tr><td data-num="36"></td><td><pre>DEBUG <span class="token operator">=</span> 1</pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token comment"># optimization</span></pre></td></tr><tr><td data-num="38"></td><td><pre>OPT <span class="token operator">=</span> </pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token comment">#######################################</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token comment"># cross compile</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token comment">#######################################</span></pre></td></tr><tr><td data-num="43"></td><td><pre>PREFIX <span class="token operator">=</span> </pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>CC <span class="token operator">=</span> <span class="token variable">$</span><span class="token punctuation">(</span>PREFIX<span class="token punctuation">)</span>sdcc </pre></td></tr><tr><td data-num="46"></td><td><pre>AS <span class="token operator">=</span> <span class="token variable">$</span><span class="token punctuation">(</span>PREFIX<span class="token punctuation">)</span>sdas8051</pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre>MCU_MODEL <span class="token operator">=</span> -mmcs51</pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>RM <span class="token operator">=</span> -rm -rf </pre></td></tr><tr><td data-num="51"></td><td><pre>MAKE <span class="token operator">=</span> make </pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token comment"># ------------------------------------------------------</span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token comment"># Usually SDCC's small memory model is the best choice.  If</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token comment"># you run out of internal RAM, you will need to declare</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token comment"># variables as "xdata", or switch to larger model</span></pre></td></tr><tr><td data-num="57"></td><td><pre></pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token comment"># Memory Model (small, medium, large, huge)</span></pre></td></tr><tr><td data-num="59"></td><td><pre>MODEL  <span class="token operator">=</span> --model-small</pre></td></tr><tr><td data-num="60"></td><td><pre><span class="token comment"># ------------------------------------------------------</span></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token comment"># Memory Layout</span></pre></td></tr><tr><td data-num="62"></td><td><pre><span class="token comment"># PRG Size = 4K Bytes</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token comment">#CODE_SIZE = --code-loc 0x0000 --code-size 18432</span></pre></td></tr><tr><td data-num="64"></td><td><pre>CODE_SIZE <span class="token operator">=</span> --code-size 18432</pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token comment"># INT-MEM Size = 256 Bytes</span></pre></td></tr><tr><td data-num="66"></td><td><pre><span class="token comment">#IRAM_SIZE = --idata-loc 0x0000  --iram-size 256</span></pre></td></tr><tr><td data-num="67"></td><td><pre>IRAM_SIZE <span class="token operator">=</span> --iram-size 256</pre></td></tr><tr><td data-num="68"></td><td><pre><span class="token comment"># EXT-MEM Size = 4K Bytes</span></pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token comment">#XRAM_SIZE = --xram-loc 0x0000 --xram-size 768</span></pre></td></tr><tr><td data-num="70"></td><td><pre>XRAM_SIZE <span class="token operator">=</span> --xram-size 768</pre></td></tr><tr><td data-num="71"></td><td><pre></pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token comment"># ------------------------------------------------------</span></pre></td></tr><tr><td data-num="73"></td><td><pre></pre></td></tr><tr><td data-num="74"></td><td><pre><span class="token comment">#######################################</span></pre></td></tr><tr><td data-num="75"></td><td><pre><span class="token comment"># FLAGS</span></pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token comment">#######################################</span></pre></td></tr><tr><td data-num="77"></td><td><pre><span class="token comment"># macros for gcc</span></pre></td></tr><tr><td data-num="78"></td><td><pre><span class="token comment"># AS defines</span></pre></td></tr><tr><td data-num="79"></td><td><pre>AS_DEFS <span class="token operator">=</span> </pre></td></tr><tr><td data-num="80"></td><td><pre></pre></td></tr><tr><td data-num="81"></td><td><pre><span class="token comment"># C defines</span></pre></td></tr><tr><td data-num="82"></td><td><pre>C_DEFS <span class="token operator">=</span> </pre></td></tr><tr><td data-num="83"></td><td><pre></pre></td></tr><tr><td data-num="84"></td><td><pre></pre></td></tr><tr><td data-num="85"></td><td><pre><span class="token comment"># AS includes</span></pre></td></tr><tr><td data-num="86"></td><td><pre>AS_INCLUDES <span class="token operator">=</span> </pre></td></tr><tr><td data-num="87"></td><td><pre></pre></td></tr><tr><td data-num="88"></td><td><pre><span class="token comment"># C includes</span></pre></td></tr><tr><td data-num="89"></td><td><pre>C_INCLUDES <span class="token operator">=</span>  \</pre></td></tr><tr><td data-num="90"></td><td><pre>-IApp \</pre></td></tr><tr><td data-num="91"></td><td><pre>-ILibraries/Device/Include \</pre></td></tr><tr><td data-num="92"></td><td><pre>-ILibraries/StdDriver/inc \</pre></td></tr><tr><td data-num="93"></td><td><pre>-Iinclude</pre></td></tr><tr><td data-num="94"></td><td><pre></pre></td></tr><tr><td data-num="95"></td><td><pre><span class="token comment"># libraries</span></pre></td></tr><tr><td data-num="96"></td><td><pre>LIBS <span class="token operator">=</span> </pre></td></tr><tr><td data-num="97"></td><td><pre>LIBDIR <span class="token operator">=</span> </pre></td></tr><tr><td data-num="98"></td><td><pre></pre></td></tr><tr><td data-num="99"></td><td><pre><span class="token comment"># compile gcc flags</span></pre></td></tr><tr><td data-num="100"></td><td><pre>ASFLAGS <span class="token operator">=</span> -l -s</pre></td></tr><tr><td data-num="101"></td><td><pre></pre></td></tr><tr><td data-num="102"></td><td><pre>CFLAGS <span class="token operator">=</span> <span class="token variable">$</span><span class="token punctuation">(</span>MCU_MODEL<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>C_DEFS<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>C_INCLUDES<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>MODEL<span class="token punctuation">)</span> --out-fmt-ihx --no-xinit-opt --peep-file tools/peep.def</pre></td></tr><tr><td data-num="103"></td><td><pre></pre></td></tr><tr><td data-num="104"></td><td><pre><span class="token keyword">ifeq</span> <span class="token punctuation">(</span><span class="token variable">$</span><span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span>, 1<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="105"></td><td><pre>CFLAGS <span class="token operator">+=</span> </pre></td></tr><tr><td data-num="106"></td><td><pre><span class="token keyword">else</span></pre></td></tr><tr><td data-num="107"></td><td><pre>CFLAGS <span class="token operator">+=</span> <span class="token variable">$</span><span class="token punctuation">(</span>OPT<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="108"></td><td><pre><span class="token keyword">endif</span></pre></td></tr><tr><td data-num="109"></td><td><pre></pre></td></tr><tr><td data-num="110"></td><td><pre></pre></td></tr><tr><td data-num="111"></td><td><pre><span class="token comment">#######################################</span></pre></td></tr><tr><td data-num="112"></td><td><pre><span class="token comment"># LDFLAGS</span></pre></td></tr><tr><td data-num="113"></td><td><pre><span class="token comment">#######################################</span></pre></td></tr><tr><td data-num="114"></td><td><pre>LDFLAGS <span class="token operator">=</span> <span class="token variable">$</span><span class="token punctuation">(</span>LIBDIR<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>LIBS<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>MCU_MODEL<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>MODEL<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>CODE_SIZE<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>IRAM_SIZE<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>XRAM_SIZE<span class="token punctuation">)</span> --out-fmt-ihx</pre></td></tr><tr><td data-num="115"></td><td><pre></pre></td></tr><tr><td data-num="116"></td><td><pre><span class="token comment"># default action: build all</span></pre></td></tr><tr><td data-num="117"></td><td><pre><span class="token builtin-target builtin">.PHONY</span><span class="token punctuation">:</span> all</pre></td></tr><tr><td data-num="118"></td><td><pre><span class="token target symbol">all</span><span class="token punctuation">:</span> <span class="token variable">$</span><span class="token punctuation">(</span>BUILD_DIR<span class="token punctuation">)</span>/<span class="token variable">$</span><span class="token punctuation">(</span>TARGET<span class="token punctuation">)</span>.hex</pre></td></tr><tr><td data-num="119"></td><td><pre></pre></td></tr><tr><td data-num="120"></td><td><pre><span class="token comment">#######################################</span></pre></td></tr><tr><td data-num="121"></td><td><pre><span class="token comment"># build the application</span></pre></td></tr><tr><td data-num="122"></td><td><pre><span class="token comment">#######################################</span></pre></td></tr><tr><td data-num="123"></td><td><pre><span class="token comment"># list of objects</span></pre></td></tr><tr><td data-num="124"></td><td><pre>OBJECTS <span class="token operator">=</span> <span class="token variable">$</span><span class="token punctuation">(</span>addprefix <span class="token variable">$</span><span class="token punctuation">(</span>BUILD_DIR<span class="token punctuation">)</span>/,<span class="token variable">$</span><span class="token punctuation">(</span>C_OBJ_FILE<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="125"></td><td><pre><span class="token comment"># list of ASM program objects</span></pre></td></tr><tr><td data-num="126"></td><td><pre>OBJECTS <span class="token operator">+=</span> <span class="token variable">$</span><span class="token punctuation">(</span>addprefix <span class="token variable">$</span><span class="token punctuation">(</span>BUILD_DIR<span class="token punctuation">)</span>/,<span class="token variable">$</span><span class="token punctuation">(</span>ASM_OBJ_FILE<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="127"></td><td><pre></pre></td></tr><tr><td data-num="128"></td><td><pre><span class="token target symbol"><span class="token variable">$</span>(BUILD_DIR)/%.c.rel</span><span class="token punctuation">:</span> <span class="token variable">$</span><span class="token punctuation">(</span>USER_SRC<span class="token punctuation">)</span>/%.c</pre></td></tr><tr><td data-num="129"></td><td><pre><span class="token variable">$</span><span class="token punctuation">(</span>CC<span class="token punctuation">)</span> -o <span class="token variable">$@</span> <span class="token variable">$</span><span class="token punctuation">(</span>CFLAGS<span class="token punctuation">)</span> -c <span class="token variable">$^</span></pre></td></tr><tr><td data-num="130"></td><td><pre></pre></td></tr><tr><td data-num="131"></td><td><pre><span class="token target symbol"><span class="token variable">$</span>(BUILD_DIR)/%.c.rel</span><span class="token punctuation">:</span> <span class="token variable">$</span><span class="token punctuation">(</span>LIB_SRC<span class="token punctuation">)</span>/%.c</pre></td></tr><tr><td data-num="132"></td><td><pre><span class="token variable">$</span><span class="token punctuation">(</span>CC<span class="token punctuation">)</span> -o <span class="token variable">$@</span> <span class="token variable">$</span><span class="token punctuation">(</span>CFLAGS<span class="token punctuation">)</span> -c <span class="token variable">$^</span></pre></td></tr><tr><td data-num="133"></td><td><pre></pre></td></tr><tr><td data-num="134"></td><td><pre><span class="token target symbol"><span class="token variable">$</span>(BUILD_DIR)/%.c.rel</span><span class="token punctuation">:</span> <span class="token variable">$</span><span class="token punctuation">(</span>SRCDIR<span class="token punctuation">)</span>/%.c</pre></td></tr><tr><td data-num="135"></td><td><pre><span class="token variable">$</span><span class="token punctuation">(</span>CC<span class="token punctuation">)</span> -o <span class="token variable">$@</span> <span class="token variable">$</span><span class="token punctuation">(</span>CFLAGS<span class="token punctuation">)</span> -c <span class="token variable">$^</span></pre></td></tr><tr><td data-num="136"></td><td><pre></pre></td></tr><tr><td data-num="137"></td><td><pre><span class="token target symbol"><span class="token variable">$</span>(BUILD_DIR)/%.asm.rel</span><span class="token punctuation">:</span> <span class="token variable">$</span><span class="token punctuation">(</span>SRCDIR<span class="token punctuation">)</span>/%.asm</pre></td></tr><tr><td data-num="138"></td><td><pre><span class="token variable">$</span><span class="token punctuation">(</span>AS<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>ASFLAGS<span class="token punctuation">)</span> -o <span class="token variable">$@</span> <span class="token variable">$^</span> </pre></td></tr><tr><td data-num="139"></td><td><pre></pre></td></tr><tr><td data-num="140"></td><td><pre><span class="token target symbol"><span class="token variable">$</span>(BUILD_DIR)/%.ihx</span><span class="token punctuation">:</span> <span class="token variable">$</span><span class="token punctuation">(</span>OBJECTS<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="141"></td><td><pre><span class="token variable">$</span><span class="token punctuation">(</span>CC<span class="token punctuation">)</span> -o <span class="token variable">$@</span> <span class="token variable">$</span><span class="token punctuation">(</span>LDFLAGS<span class="token punctuation">)</span> <span class="token variable">$^</span></pre></td></tr><tr><td data-num="142"></td><td><pre></pre></td></tr><tr><td data-num="143"></td><td><pre><span class="token target symbol"><span class="token variable">$</span>(BUILD_DIR)/%.hex</span><span class="token punctuation">:</span> <span class="token variable">$</span><span class="token punctuation">(</span>BUILD_DIR<span class="token punctuation">)</span>/%.ihx <span class="token operator">|</span> <span class="token variable">$</span><span class="token punctuation">(</span>BUILD_DIR<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="144"></td><td><pre>packihx <span class="token variable">$^</span> > <span class="token variable">$@</span></pre></td></tr><tr><td data-num="145"></td><td><pre></pre></td></tr><tr><td data-num="146"></td><td><pre><span class="token target symbol"><span class="token variable">$</span>(BUILD_DIR)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="147"></td><td><pre>mkdir <span class="token variable">$@</span></pre></td></tr><tr><td data-num="148"></td><td><pre></pre></td></tr><tr><td data-num="149"></td><td><pre></pre></td></tr><tr><td data-num="150"></td><td><pre><span class="token comment">#######################################</span></pre></td></tr><tr><td data-num="151"></td><td><pre><span class="token comment"># clean up</span></pre></td></tr><tr><td data-num="152"></td><td><pre><span class="token comment">#######################################</span></pre></td></tr><tr><td data-num="153"></td><td><pre><span class="token builtin-target builtin">.PHONY</span><span class="token punctuation">:</span> clean</pre></td></tr><tr><td data-num="154"></td><td><pre><span class="token target symbol">clean</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="155"></td><td><pre><span class="token variable">$</span><span class="token punctuation">(</span>RM<span class="token punctuation">)</span><span class="token variable">$</span><span class="token punctuation">(</span>BUILD_DIR<span class="token punctuation">)</span>/*</pre></td></tr><tr><td data-num="156"></td><td><pre></pre></td></tr><tr><td data-num="157"></td><td><pre><span class="token comment">#######################################</span></pre></td></tr><tr><td data-num="158"></td><td><pre><span class="token comment"># build asm</span></pre></td></tr><tr><td data-num="159"></td><td><pre><span class="token comment">#######################################</span></pre></td></tr><tr><td data-num="160"></td><td><pre>HEADER_FILE <span class="token operator">=</span> MS51_16K.h</pre></td></tr><tr><td data-num="161"></td><td><pre>HEADER_PATH <span class="token operator">=</span> App</pre></td></tr><tr><td data-num="162"></td><td><pre></pre></td></tr><tr><td data-num="163"></td><td><pre><span class="token target symbol">disasm</span><span class="token punctuation">:</span> <span class="token variable">$</span><span class="token punctuation">(</span>BUILD_DIR<span class="token punctuation">)</span>/<span class="token variable">$</span><span class="token punctuation">(</span>TARGET<span class="token punctuation">)</span>.hex</pre></td></tr><tr><td data-num="164"></td><td><pre>./tools/mcs51-disasm.pl -M <span class="token variable">$</span><span class="token punctuation">(</span>HEADER_FILE<span class="token punctuation">)</span> -I <span class="token variable">$</span><span class="token punctuation">(</span>HEADER_PATH<span class="token punctuation">)</span> -fl -rj -as <span class="token variable">$</span><span class="token punctuation">(</span>BUILD_DIR<span class="token punctuation">)</span>/<span class="token variable">$</span><span class="token punctuation">(</span>TARGET<span class="token punctuation">)</span>.hex > <span class="token variable">$</span><span class="token punctuation">(</span>BUILD_DIR<span class="token punctuation">)</span>/<span class="token variable">$</span><span class="token punctuation">(</span>TARGET<span class="token punctuation">)</span>.a51</pre></td></tr><tr><td data-num="165"></td><td><pre></pre></td></tr><tr><td data-num="166"></td><td><pre><span class="token comment"># *** EOF ***</span></pre></td></tr></table></figure><p>这里说一下，sdcc 特有的  <code>packihx</code>  命令是用来产生 Intel HEX 文件的； <code>mkdir</code>  命令在 sdcc 中是不支持，可以把他删掉，由于这一点，所以得保留着 build 文件夹存放编译文件，如果删除的话，执行会出错；执行  <code>disasm</code>  命令需要工具链 mcs51-disasm.pl 的支持，它的说明如下：</p><p><img data-src="image-20201028231938212.png" alt="image-20201028231938212" />；另外， <code>+=</code>  好像也不支持单文件添加，看 USER_SRC 处，只能通过  <code>wildcard</code>  扫描添加。。。不知为啥，望大佬解答一二。</p><h1 id="程序编译"><a class="anchor" href="#程序编译">#</a> 程序编译</h1><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"main.h"</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"bsp.h"</span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"bsp_uart.h"</span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"bsp_time.h"</span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"bsp_eeprom.h"</span></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"bsp_adc.h"</span></span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"bsp_pwm.h"</span></span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"bsp_wdt.h"</span></span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>__bit BIT_TMP<span class="token punctuation">;</span><span class="token comment">//EA 暂存（对应官方库）</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ENABLE_WDT</span><span class="token expression"><span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">/* ISR 中断函数原型声明（原因看手册 P3.8 章节） */</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">void</span> <span class="token function">UART0_ISR</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token function">__interrupt</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">void</span> <span class="token function">Timer3_ISR</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token function">__interrupt</span> <span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">/************************************************</pre></td></tr><tr><td data-num="21"></td><td><pre>函数名称 ： System_Start</pre></td></tr><tr><td data-num="22"></td><td><pre>功    能 ： 系统初始化</pre></td></tr><tr><td data-num="23"></td><td><pre>参    数 ： 无</pre></td></tr><tr><td data-num="24"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num="25"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token keyword">void</span> <span class="token function">System_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    clr_EA<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token function">Bsp_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token function">UART0_Timer1_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token function">Timer3_Init</span><span class="token punctuation">(</span>TIME_DIV16<span class="token punctuation">,</span> <span class="token number">15000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 10ms</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token comment">// Timer0_Init();</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token comment">// ADC_Config();</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token comment">// PWM0_Init();</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ENABLE_WDT</span></span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token function">WDT_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ENABLE_WDT */</span></span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>    set_EA<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token comment">/************************************************</pre></td></tr><tr><td data-num="45"></td><td><pre>函数名称 ： main</pre></td></tr><tr><td data-num="46"></td><td><pre>功    能 ： 主函数入口</pre></td></tr><tr><td data-num="47"></td><td><pre>参    数 ： 无</pre></td></tr><tr><td data-num="48"></td><td><pre>返 回 值 ： int</pre></td></tr><tr><td data-num="49"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token function">System_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre>P12_QUASI_MODE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    P12 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        P12 <span class="token operator">^=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token function">SoftwareDelay_ms</span><span class="token punctuation">(</span><span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ENABLE_WDT</span></span></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token function">WDT_EnableOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre></pre></td></tr><tr><td data-num="67"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span></pre></td></tr><tr><td data-num="68"></td><td><pre><span class="token function">WDT_DisableClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre></pre></td></tr><tr><td data-num="70"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ENABLE_WDT */</span></span></pre></td></tr><tr><td data-num="71"></td><td><pre></pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="74"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ENABLE_WDT</span></span></pre></td></tr><tr><td data-num="75"></td><td><pre>        <span class="token function">WDT_ReloadCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ENABLE_WDT */</span></span></pre></td></tr><tr><td data-num="77"></td><td><pre></pre></td></tr><tr><td data-num="78"></td><td><pre>        <span class="token function">printf_small</span><span class="token punctuation">(</span><span class="token string">"\n Hello world!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>        <span class="token function">SoftwareDelay_ms</span><span class="token punctuation">(</span><span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="81"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="82"></td><td><pre></pre></td></tr><tr><td data-num="83"></td><td><pre></pre></td></tr><tr><td data-num="84"></td><td><pre><span class="token comment">/*---------------------------- END OF FILE ----------------------------*/</span></pre></td></tr></table></figure><p>然后  <code>make</code>  编译，最终输出（方框处显示成功）：</p><p><img data-src="image-20201028233905135.png" alt="image-20201028233905135" /></p><p>下载进去，就可以看到 hello world 在不停的打印输出了。</p><p>在这里，需要注意以下几点：</p><p>1、中断函数必须在 main 函数文件中给出 ISR 原型，不然就无法进中断。详细请看手册的 P3.8 章节。以下摘自部分解释：</p><p><img data-src="image-20201028234927141.png" alt="image-20201028234927141" /></p><p>2、一般，我们在 C 程序中打印输出是调用  <code>printf</code>  语句进行输出的，但在 sdcc 上，比较建议使用  <code>printf_small</code>  输出，因为对于 8 位微控制起来说，资源是很紧缺的，使用  <code>printf_small</code>  已经可以满足一般输出需求了，当然以上仅限于输出整型以及字符型变量；对于浮点型变量，需要使用特殊的指令对程序进行编译才能得到输出效果，具体的介绍可以看手册的 P3.14.1 章节。</p><p>3、如果是使用 bin 文件烧写到芯片上，可以用 sdcc 自带的 makebin.exe 命令行工具进行转换（不过这个转换出来文件比较大），路径可以在 ...\SDCC\bin 下找到，通过以下命令： <code>makebin xxx.ihx &gt; xxx.bin</code></p><p>或者利用 hex2bin，下载地址：<span class="exturl" data-url="aHR0cHM6Ly9zb3VyY2Vmb3JnZS5uZXQvcHJvamVjdHMvaGV4MmJpbi9maWxlcy9sYXRlc3QvZG93bmxvYWQlRUYlQkMlOEMlRTglQkYlOTklRTQlQjglQUElRTclOUElODQlRTUlOTElQkQlRTQlQkIlQTQlRTUlODglOTklRTYlOTglQUYlRUYlQkMlOUE=">https://sourceforge.net/projects/hex2bin/files/latest/download，这个的命令则是：</span> <code>hex2bin xxx.hex &gt; xxx.bin</code></p><p>Makefile 下的 bin 文件生成命令：</p><p><img data-src="image-20201029233621896.png" alt="image-20201029233621896" /></p><p>两者相比之下，由于前者是做了剩余空间填充处理的，所以转换出来的文件比较大，个人更倾向于后者。</p><h1 id="总结"><a class="anchor" href="#总结">#</a> 总结</h1><p>1、不能使用 double 数据类型，否则报错。<br />2、make 编译只能根据法则编译对应文件夹的全部源文件，不能选择编译相应源文件。<br />3、中断函数这里是要在 main 函数所在文件处进行原型声明，否者是无法进入中断程序，原因不声明是并没用把中断函数的向量地址加载到执行文件中。<br />4、sdcc 使用的关键字是跟 keilC51 里面的关键字不同的；对于一些非 ANSI C 的关键字，SDCC 均采用双下滑线开头的方式定义，具体可看 sdcc 手册。<br />5、sdcc 支持的命令行命令，跟我们平常用的 gcc 命令行命令有所不同，具体翻看 sdcc 手册。<br />6、一般串口重定向后，是使用 printf 函数输出，但在 sdcc 编译器中要改用 printf_small 这个函数进行替代。</p><p>7、sdcc 在编译文件时，会把用不到的代码也编译进来，所以如果空间紧张，建议注释掉一些无关的代码，避免代码空间膨胀。</p><h1 id="相关链接"><a class="anchor" href="#相关链接">#</a> 相关链接</h1><p><span class="exturl" data-url="aHR0cDovL2ZpdmVkb3RzLmNvZS5wc3UuYWMudGgvfmNqL21hc2QvcmVzb3VyY2VzL3NkY2MtZG9jL1NEQ0NVZG9jLmh0bWwjdG9jMjg=">SDCC Compiler User Guide</span></p><p><span class="exturl" data-url="aHR0cDovL2Fib3V0LnV1c3BpZGVyLmNvbS8yMDE5LzAzLzA1L3NkY2MuaHRtbA==">8051 C Development Using SDCC(Small Device C Compiler)</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3drYXN0ZXIvTjc2RTAwMw==">Nuvoton N76E003 with SDCC</span></p><p><span class="exturl" data-url="aHR0cHM6Ly93aHljYW4uY29tL3RfMTI3NS5odG1s">新唐 N76E003 8051 1T 单片机入坑记录</span></p><p><span class="exturl" data-url="aHR0cHM6Ly93aGNoZW4ubmV0L2Jsb2cvc2RjYy1zaW1wbGUtdG8tdXNlLXR1dG9yaWFsLw==">SDCC 编译器简明使用教程</span></p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cubWF4aW1pbnRlZ3JhdGVkLmNvbS9jbi9kZXNpZ24vdGVjaG5pY2FsLWRvY3VtZW50cy9hcHAtbm90ZXMvMy8zNDc3Lmh0bWw=">使用免费的 SDCC C 编译器开发 DS89C430/450 系列微控制器固件</span></p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cud2ViYXVuLmNuL3Bhc3NhZ2VzLzcv">51 单片机之开发环境使用 VSCode 结合 SDCC 取代 Keil</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9teS5vc2NoaW5hLm5ldC9ldGJlcnppbi9ibG9nLzQ1NjEzOTE=">使用 Visual Studio Code + CMake + SDCC 进行 C51 开发的一次尝试</span></p><p><span class="exturl" data-url="aHR0cDovL3d3dy5mb3Jtb3Nhb3MudXJsLnR3Lw==">台湾同胞对 SDCC 的使用介绍</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9hZGFtc3EuZ2l0aHViLmlvL2Jsb2cvdGFncy8lRTUlQjUlOEMlRTUlODUlQTUlRTUlQkMlOEYv">sdcc man 阅读笔记</span></p><p><span class="exturl" data-url="aHR0cDovL2p5aHNoaW4zLmJsb2dzcG90LmNvbS8yMDA5LzA0L3NkY2MtcHJpbnRmLmh0bWw=">SDCC printf 函數介紹</span></p>]]></content>
      
      
      
        <tags>
            
            <tag> history </tag>
            
            <tag> IDE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>分区分配算法（Partitioning Placement Algorithm）</title>
      <link href="/docs/%E7%AE%97%E6%B3%95/%E5%88%86%E5%8C%BA%E5%88%86%E9%85%8D%E7%AE%97%E6%B3%95%EF%BC%88Partitioning%20Placement%20Algorithm%EF%BC%89/"/>
      <url>/docs/%E7%AE%97%E6%B3%95/%E5%88%86%E5%8C%BA%E5%88%86%E9%85%8D%E7%AE%97%E6%B3%95%EF%BC%88Partitioning%20Placement%20Algorithm%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h1 id="简述"><a class="anchor" href="#简述">#</a> 简述</h1><p><strong>首次适应算法（first-fit）</strong> ：从空闲分区表的第一个表目起查找该表，把最先能够满足要求的空闲区分配给作业，这种方法的目的在于减少查找时间。</p><p><strong>最佳适应算法（best-fit）</strong> ：从全部空闲区中找出能满足作业要求的，且大小最小的空闲分区，这种方法能使碎片尽量小。</p><p><strong>最差适应算法（worst-fit）</strong> ：它从全部空闲区中找出能满足作业要求的、且大小最大的空闲分区，从而使链表中的节点大小趋于均匀。</p><h1 id="例子"><a class="anchor" href="#例子">#</a> 例子</h1><h2 id="文字描述"><a class="anchor" href="#文字描述">#</a> 文字描述</h2><blockquote><p>下面先来看一个实例：</p><p><em><strong>Given five memory partitions of 100 KB, 500 KB, 200 KB, 300 KB, and 600 KB (in order), how would each of the first-fit, best-fit, and worst-fit algorithms place processes of 212 KB, 417 KB, 112 KB, and 426 KB (in order)? Which algorithm makes the most efficient use of memory?</strong></em></p></blockquote><p><strong>1、首次适应算法：</strong></p><ul><li>为 212k 分配空间：</li></ul><p>​    依次找寻，找到第一个大于 212k 的空闲区；</p><p>​    找到第二个空闲区 500k &gt; 212k，分配给 212k，剩余 288k 空闲区；</p><ul><li>为 417k 分配空间：</li></ul><p>​    依次找寻，找到第一个大于 417k 的空闲区；</p><p>​    找到第五个空闲区 600k &gt; 417k，分配给 417k，剩余 183k 空闲区</p><ul><li>为 112k 分配空间：</li></ul><p>​    依次找寻，找到第一个大于 112k 的空闲区；</p><p>​    找到第二个空闲区 288k &gt; 112k，分配给 112k，剩余 176k 空闲区</p><ul><li>为 426k 分配空间：</li></ul><p>​    依次找寻，找到第一个大于 426k 的空闲区；</p><p>​    未找到，此作业将等待释放空间</p><p><strong>2、最佳适应算法：</strong></p><ul><li>为 212k 分配空间：</li></ul><p>​    找到第一个跟 212k 大小最接近的空闲区</p><p>​    找到第四个空闲区 300k &gt; 212k，剩余 88k 空闲区</p><ul><li>为 417k 分配空间：</li></ul><p>​    找到第一个跟 417k 大小最接近的空闲区</p><p>​    找到第二个空闲区 500k &gt; 417k，剩余 83k 空闲区</p><ul><li>为 112k 分配空间：</li></ul><p>​    找到第一个跟 112k 大小最接近的空闲区</p><p>​    找到第三个空闲区 200k &gt; 112k，剩余 88k 空闲区</p><ul><li>为 426k 分配空间：</li></ul><p>​    找到第一个跟 426k 大小最接近的空闲区</p><p>​    找到第五个空闲区 600k &gt; 426k，剩余 174k 空闲区</p><p><strong>3、最差适应算法：</strong></p><ul><li>为 212k 分配空间：</li></ul><p>​    找到第一个大小最大的空闲区</p><p>​    找到第五个空闲区 600k &gt; 212k，剩余 388k 空闲区</p><ul><li>为 417k 分配空间：</li></ul><p>​    找到第一个大小最大的空闲区</p><p>​    找到第二个空闲区 500k &gt; 417k，剩余 83k 空闲区</p><ul><li>为 112k 分配空间：</li></ul><p>​    找到第一个大小最大的空闲区</p><p>​    找到第三个空闲区 388k &gt; 112k，剩余 276k 空闲区</p><ul><li>为 426k 分配空间：</li></ul><p>​    找到第一个大小最大的空闲区</p><p>​    达到大小最大的空闲区 300k &lt; 426k，所以不分配</p><p><strong>Answer</strong></p><table><thead><tr><th>Free partition</th><th>100</th><th>500</th><th>200</th><th>300</th><th>600</th><th>Not satisfied</th></tr></thead><tbody><tr><td>First-fit</td><td></td><td>212,112</td><td></td><td></td><td>417</td><td>426</td></tr><tr><td>Best-fit</td><td></td><td>417</td><td>112</td><td>212</td><td>426</td><td></td></tr><tr><td>Worst-fit</td><td></td><td>417</td><td></td><td></td><td>212,112</td><td>426</td></tr></tbody></table><h2 id="动图分析"><a class="anchor" href="#动图分析">#</a> 动图分析</h2><p>文字图表看不懂，那接着配合动图来了解：</p><p>这次我们考虑六个大小为 200 KB，400 KB，600 KB，500 KB，300 KB 和 250 KB 的内存分区；这些分区需要按此顺序分配给四个进程，大小分别为 357 KB，210 KB，468 KB 和 491 KB。</p><p><img data-src="2020051523471962.png" alt="img" /></p><p>依次执行：</p><ul><li>首次适应算法</li><li>最佳适应算法</li><li>最差适应算法</li></ul><p><strong>1、首次适应算法：</strong></p><p><img data-src="20200515235334677.gif" alt="img" /></p><ul><li>进程 P4 无法分配内存，这是因为没有大于或等于处理 P4 的大小的分区可用。</li></ul><p><strong>2、最佳适应算法：</strong></p><p><img data-src="20200516000153918.gif" alt="img" /></p><p><strong>3、最差适应算法：</strong></p><p><img data-src="20200516000532204.gif" alt="img" /></p><ul><li>无法为进程 P3 和进程 P4 分配内存，这是因为没有大于或等于处理 P3 和处理 P4 的大小的分区可用。</li></ul><h1 id="参考"><a class="anchor" href="#参考">#</a> 参考</h1><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTEwNzAxNjkvYXJ0aWNsZS9kZXRhaWxzLzUzMTc3OTg3">https://blog.csdn.net/u011070169/article/details/53177987</span></p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuZ2F0ZXZpZHlhbGF5LmNvbS9jb250aWd1b3VzLW1lbW9yeS1hbGxvY2F0aW9uLXByYWN0aWNlLXByb2JsZW1zLw==">https://www.gatevidyalay.com/contiguous-memory-allocation-practice-problems/</span></p>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> history </tag>
            
            <tag> 算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>三大无源器件之电感</title>
      <link href="/docs/Electronic/%E4%B8%89%E5%A4%A7%E6%97%A0%E6%BA%90%E5%99%A8%E4%BB%B6%E4%B9%8B%E7%94%B5%E6%84%9F/"/>
      <url>/docs/Electronic/%E4%B8%89%E5%A4%A7%E6%97%A0%E6%BA%90%E5%99%A8%E4%BB%B6%E4%B9%8B%E7%94%B5%E6%84%9F/</url>
      
        <content type="html"><![CDATA[<blockquote><p>下面用三个篇章解释</p></blockquote><h1 id="视频篇"><a class="anchor" href="#视频篇">#</a> 视频篇</h1><p><iframe width="560" height="315" src="//player.bilibili.com/player.html?aid=99004423&bvid=BV1U741127Vd&cid=168998616&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" controls="controls" allowfullscreen="true"> </iframe></p><h1 id="漫画篇"><a class="anchor" href="#漫画篇">#</a> 漫画篇</h1><p><img data-src="clip_image002.jpg" alt="img" /></p><p><img data-src="clip_image004.jpg" alt="img" /></p><p><img data-src="clip_image006.jpg" alt="img" /></p><p><img data-src="clip_image008.jpg" alt="img" /></p><p>图片提取自 <span class="exturl" data-url="aHR0cHM6Ly93d3cuanAudGRrLmNvbS9jb3JwL3poL2luZGV4Lmh0bQ==">TDK 株式会社</span></p><h1 id="文字篇"><a class="anchor" href="#文字篇">#</a> 文字篇</h1><p><strong>1、电感器与电感</strong></p><p><strong>电感器</strong>（inductor）是一种电路元件；电感器一词在口语上也会被简称为电感，但如需严谨表达为实体物件的情况，仍宜称为电感器</p><p><strong>电感</strong>（Inductance）是闭合回路的一种属性，即当通过闭合回路的电流改变时，会出现电动势来抵抗电流的改变</p><p><strong>2、自感和互感</strong></p><p>・自感：当电感这种属性现象出现在自身回路中，那么这种电感称为<strong>自感</strong>（self-inductance），是闭合回路自己本身的属性</p><p>通常自感是以字母 “L” 标记，这可能是为了纪念物理学家海因里希・楞次的贡献</p><p>・互感：假设一个闭合回路的电流改变，由于感应作用在另外一个闭合回路中产生电动势，这种电感称为<strong>互感</strong>（mutual inductance）</p><p>互感是以字母 “M” 标记，是其英文（Mutual Inductance）的第一个字母</p><p><strong>3、表达式</strong></p><p><img data-src="clip_image010.png" alt="img" /></p><p>其中：</p><p>ε 是电动势</p><p>L 是电感</p><p>i 是电流</p><p>t 是时间</p><p><strong>4、电感单位和转换</strong></p><p>采用国际单位制，电感的单位是亨利（henry），标记为 “H”，是因美国科学家约瑟・亨利命名。1 H = 1 Wb /A</p><p>常用单位有：亨 (H)、毫亨 (mH)、微亨 (μH)、纳亨（nH）</p><p>单位转换：1H = 1000mH = 10^6μH = 10^9nH</p><p><strong>5、电感的串联和并联</strong></p><ul><li>并联电路中的电感元件每个都有相同的电势差。其总的等效电感（<em>L</em>eq）：</li></ul><p><img data-src="clip_image012.png" alt="img" /></p><p><img data-src="clip_image014.png" alt="img" /></p><ul><li>通过串联电感的电流保持不变，但每个电感元件上的电压可不同。其电压之和等于总电压。总电感：</li></ul><p><img data-src="clip_image016.png" alt="img" /></p><p><img data-src="clip_image018.png" alt="img" /></p><p>这种简单的关系只有在没有磁场互耦（mutual coupling）的条件下才成立</p><p><strong>6、电感的应用</strong></p><p>・功率电感：主要用于电压转换，常用的 DCDC 电路都要使用功率电感</p><p>・去耦电感：主要用于滤除电源线或信号线上的噪声</p><p>・高频电感：主要用于射频电路，实现偏置、匹配、滤波等电路</p><p>电感在射频电路中用途最多</p><p><strong>7、感性负载电压电流的超前滞后</strong></p><p>首先要提醒，相位的概念是针对正弦信号而言的，直流信号、非周期变化信号等都没有相位的概念</p><p>由于 Sin [ωt] 在求导或积分后会出现 Sin [ωt ± 90°]，所以对于接上了正弦波的感性负载，通过接上理想的直流电压表、直流电流表，可以观察到波形超前滞后的现象</p><p><img data-src="clip_image020.png" alt="img" /></p><p>如果还表现的还不够生动，可以用动态图演示，其用红色表示电压，蓝色表示电流：</p><p><img data-src="clip_image021.gif" alt="img" /></p><p>电压的变化超前于电流，电流的变化滞后于电压，所以若电感器通入交流的信号，相角为 90 度，亦即电流滞后电压 90 度</p><p><img data-src="clip_image022.gif" alt="img" /></p><p>用不同的颜色描述电压的大小，蓝色 &gt; 黄色 &gt; 红色；用不同的粗细和箭头描述电流的大小和方向，电流最大时电感磁场能最大</p><p><strong>8、感抗</strong></p><p>因为电路中存在电感电路（如线圈），由此产生的变化的电磁场，会产生相应的阻碍电流变化的感生电动势。这个作用称为<strong>感抗</strong> 。电流变化越大，即电路频率越大，感抗越大；当频率变为 0，即成为直流电时，感抗也变为 0。感抗会引起电流与电压之间的相位差。感抗可由下面公式计算而来：</p><p><img data-src="clip_image024.png" alt="img" /></p><p>复数分析中：</p><p><img data-src="clip_image026.png" alt="img" /></p><p>其中</p><p>・j 是复数单位</p><p>・Xl 就是感抗，单位为欧姆</p><p>・ω = 2πf 是角速度，单位为 弧度 / 每秒</p><p>・f 是频率，单位为赫兹</p><p>・L 是线圈电感，单位为亨利</p><p><strong>9、电感的特性总结</strong></p><p>・通直流隔交流</p><p>・通低频阻高频</p><p>・电感两端的电流不能够突变，电压能突变</p><p><strong>10、电感选型主要参数</strong></p><p>・电感量（也称自感系数，是表示电感器产生自感应能力的一个物理量）</p><p>・允许误差（电感器上标称的电感量与实际电感的允许误差值）</p><p>・品质因数 Q（指电感器处于某一特定频率时，它的电感电抗和电阻之间的比例）</p><p>・额定电流（电感器在允许的工作环境下能承受的最大电流值）</p><p><strong>11、品质因数</strong> <strong>Q</strong></p><p>一个理想的电感元件是不会因流经线圈的电流的大小而改变其敏感度。但是于实际环境下，线圈内的金属线会令电感元件带有绕组电阻；由于绕组电阻是以串联著电感元件的电阻形式出现，所以亦被称为串联电阻。由于串联电阻的存在，实际电感元件的特性会不同于理想电感，可以用品质因数表示电感和电阻之的比例</p><p>电感元件的品质因数 Q 能由以下方程式可得，R 是电感元件的内部电抗：</p><p><img data-src="clip_image028.png" alt="img" /></p><p>相同条件下内阻越大，品质因数越小。品质因数可以看做是衡量电感元件好坏的标准之一，品质因数越高通常意味着电感的质量越好；电感器品质因数的高低与线圈导线的直流电阻、线圈骨架的介质损耗及铁心、屏蔽罩等引起的损耗等有关</p>]]></content>
      
      
      
        <tags>
            
            <tag> history </tag>
            
            <tag> 电子 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>三大无源器件之电容</title>
      <link href="/docs/Electronic/%E4%B8%89%E5%A4%A7%E6%97%A0%E6%BA%90%E5%99%A8%E4%BB%B6%E4%B9%8B%E7%94%B5%E5%AE%B9/"/>
      <url>/docs/Electronic/%E4%B8%89%E5%A4%A7%E6%97%A0%E6%BA%90%E5%99%A8%E4%BB%B6%E4%B9%8B%E7%94%B5%E5%AE%B9/</url>
      
        <content type="html"><![CDATA[<blockquote><p>下面用三个篇章解释</p></blockquote><h1 id="视频篇"><a class="anchor" href="#视频篇">#</a> 视频篇</h1><p><iframe width="560" height="315" src="//player.bilibili.com/player.html?aid=99000126&bvid=BV11741127TT&cid=168986778&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe></p><h1 id="漫画篇"><a class="anchor" href="#漫画篇">#</a> 漫画篇</h1><p><img data-src="clip_image002.jpg" alt="img" /></p><p><img data-src="clip_image004.jpg" alt="img" /></p><p><img data-src="clip_image006.jpg" alt="img" /></p><p>图片提取自 <span class="exturl" data-url="aHR0cHM6Ly93d3cuanAudGRrLmNvbS9jb3JwL3poL2luZGV4Lmh0bQ==">TDK 株式会社</span></p><h1 id="文字篇"><a class="anchor" href="#文字篇">#</a> 文字篇</h1><p><strong>1、电容器与电容</strong></p><p><strong>电容器</strong>（英文：<strong>capacitor</strong>，又称为<strong> condenser</strong>）是将电能储存在电场中的被动电子元件。电容器的储能特性可以用电容表示。在电路中邻近的导体之间即存在电容，而电容器是为了增加电路中的电容量而加入的电子元件</p><p>电容器包括二个电极，二个电极储存的电荷大小相等，符号相反。电极本身是导体，二个电极之间由称为介电质的绝缘体隔开。电极的金属片通常用的是铝片或是铝箔，若用氧化铝来做介质的就是电解电容器。电荷会储存在电极表面，靠近介电质的部分。由于二个电极储存的电荷大小相等，符号相反，因此电容器中始终保持为电中性</p><p><strong>2、原理</strong></p><p>电容器的电容（<em>C</em>）是测量当电容器两端的电势差或电压（<em>V</em>）为单位值时，储存在电容器电极的电荷量（<em>Q</em>）：</p><p><img data-src="clip_image008.png" alt="img" /></p><p>上式的意义是，在一个具有 C 法拉的电容两端跨接 V 伏的电压时，该电容的一个极板上就有 Q 库仑的电荷存储，而另一个极板上也有 -Q 库仑的电荷存储；其电荷量的单位为 -- 库仑（C），则此电容器的电容量单位为 -- 法拉（F）</p><p><strong>3、电容的定义式</strong></p><p>由于电容器的总电场，在电容器两端会出现电压。电压 V 和电容器一端的绝对电荷量 Q 成正比，而 Q 是流过电容器的电流对时间的积分。其数学式如下：</p><p><img data-src="clip_image010.png" alt="img" /></p><p>其中：</p><p><em>I</em> 是流过电容器的电流，单位为<span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU1JUFFJTg5JUU1JTlGJUI5">安培</span>。</p><p>dV /dt 是电压对时间的微分，单位是<span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU0JUJDJThGJUU3JTg5JUI5">伏特</span> / 秒。</p><p><em>C</em> 是电容器件的电容值，单位是<span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU2JUIzJTk1JUU2JThCJTg5">法拉</span>。</p><p><strong>4、电容单位和转换</strong></p><p>电容的单位是法拉，简称 “法”，单位符号为 “F”，是国际单位制导出单位。一般来说，1 法拉算是很大的电容，大多数用于电子电路的电容器，其电容会小于法拉几个数量级</p><p>常用的单位有：微法拉（microfarad，μF）、纳法拉（nanofarad，nF）、皮法拉（picofarad，pF）</p><p>单位转换：</p><p><img data-src="clip_image012.png" alt="img" /></p><p><strong>5、电容种类</strong></p><p>・瓷片电容（可以耐高压，通常用作安规电容）</p><p>・积层陶瓷电容（其标准化封装，尺寸小，适用于自动化高密度贴片生产）</p><p>・铝电解电容（优点：电容量大、额定电压高、便宜；缺点：寿命较短、温度特性不好、ESR 和 ESL 较大）</p><p>・钽电容（频率特性及温度特比比铝电解电容要好，但介电吸收及漏电流都较大）</p><p>一般地，陶瓷与聚酯薄膜类用于大多数不太重要的电路中；钽电容用于需要较大电容量的场合，而电解质电容则用于电源滤波的场合</p><p><strong>6、电容的串联与并联</strong></p><p>·     <span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU0JUI4JUE2JUU4JTgxJUFG">并联</span>的数个电容有相同的电压。其总电容（<em>Ceq</em>）如下：</p><p><img data-src="clip_image014.png" alt="img" /></p><p><img data-src="clip_image016.png" alt="img" /></p><p>​       一般而言，电容并联的目的是增加储存的总能量。电容储存的能量如下：</p><p><img data-src="clip_image018.png" alt="img" /></p><p>·     <span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU0JUI4JUIyJUU4JTgxJUFG">串联</span>的数个电容会流过相同电流，但各个电容的电势差（电压）可能不同，而电容的电压的和会等于总电压，电容串联后的电容值如下：</p><p><img data-src="clip_image020.png" alt="img" /></p><p><img data-src="clip_image022.png" alt="img" /></p><p>・在电容并联时，电容电极的有效面积变大，因此电容值增加；而在电容串联时，相当于电容电极的距离变大，因此电容值减小</p><p>・电容串联后，电容减小了，但是耐压能力提高了，所以要承受较高的电压，可以把电容串联起来；电容并联后，电容增大了，耐压能力并没有提高，所以在需要大电容时，可以把电容并联起来</p><p><strong>7、电容的代换注意</strong></p><p>・电容并联时，每个电容所承受的工作电压相等，并等于总电压；因此，如果工作电压不同的几只电容并联，必须把其中最低的工作电压作为并联后的工作电压</p><p>・电容串联后，电容的工作电压在电容量相等的条件下，等于每个电容的工作电压之和；故串联后的电容工作电压升高</p><p><strong>8、电容选型主要参数</strong></p><p>・电容值</p><p>・允许误差</p><p>・额定电压（一般要求比输入电压高 20%）</p><p><strong>9、容性负载电压电流的超前滞后</strong></p><p>首先要提醒，相位的概念是针对正弦信号而言的，直流信号、非周期变化信号等都没有相位的概念</p><p>由于 Sin [ωt] 在求导或积分后会出现 Sin [ωt ± 90°]，所以对于接上了正弦波的容性负载，通过接上理想的直流电压表、直流电流表，可以观察到波形超前滞后的现象</p><p><img data-src="clip_image024.png" alt="img" /></p><p>如果还表现的还不够生动，可以用动态图演示，其用红色表示电压，蓝色表示电流：</p><p><img data-src="clip_image025.gif" alt="img" /></p><p>电压的变化滞后于电流，电流的变化超前于电压，所以若电容器通入交流的信号，相角为 90 度，亦即电流领先电压 90 度。电压的大小和电流成正比，和频率和电容量 C 的乘积成反比</p><p><img data-src="clip_image026.gif" alt="img" /></p><p>用不同的颜色描述电压的大小，蓝色 &gt; 黄色 &gt; 红色；用不同的粗细和箭头描述电流的大小和方向，电流最大时电容电场能最小</p><p><strong>10、容抗</strong></p><p><strong>容抗</strong>的概念反映了交流电可以通过电容器这一特性，交流电频率越高，容抗越小，即电容的阻碍作用越小。容抗同样会引起电流与电容两端电压的相位差；当频率等于零，容抗无限大，即直流电不能流过电容器。</p><p>容抗可由下面公式计算而来：</p><p><img data-src="clip_image028.png" alt="img" /></p><p>在交流电的复数分析中，容抗表示为：</p><p><img data-src="clip_image030.png" alt="img" /></p><p>其中</p><p>・j 是复数单位</p><p>・Xc 是容抗，单位为欧姆</p><p>・ω = 2πf 是角速度，单位为 弧度 / 每秒</p><p>・f 是频率，单位为赫兹</p><p>・C 是电容，单位为法拉</p><p><strong>11、电容和频率的关系</strong></p><p>・电容值越大，频率点就越低</p><p>・频率点和电容的材质有关系</p><p>・频率点和温度有关系</p><p>所以，通常我们说：电容 “通高阻低”，不能一概而论，要根据实际应用，和电容相关手册</p><p><strong>12、电容的 &quot;通交阻直&quot; 分析</strong></p><p>・电容器接在交流电路中，由于交流电电压的大小和方向随时间不断变化，致使电容器进行反复充放电，电路中相应不断出现交流电流，使得自由电子通过电路在电容器的两个极板上来回运动，自由电子的相对运动形成电流，因此，交流电流能通过电容器，即通交流；这里所指的交流电流是电容器反复充放电所形成的电流，并非电荷直接通过电容器中的介质。</p><p>・电容器接通直流电源时，仅仅在刚接通的短暂时间内发生充电过程，只在这一短暂过程电流流过电容器；此后由于直流电源电压恒定不变，电容器两端电压也恒定不变，电容器与电源负极相连的极板上负电荷占多数，并马上达到电路中各个点的电势都相等，没有电位差，因此电容器中不会有电流流过，相当于电容器把直流电流隔断，所以电容器可以起到隔直流的作用。</p><p>根据电容的电抗特性，电容可近似地看成一个依赖频率的电阻元件，因此，所谓的 “通交阻直” 其实更多的是反应频率的效果</p><p><strong>13、电容的特性总结</strong></p><p>・隔直流通交流，通高频阻低频</p><p>・电容两端的电压不能够突变，电流能突变</p><p>・大容值电容滤低频噪声，小容值电容滤高频噪声</p><p>・电容在充放电过程中并不消耗能量</p><p><strong>14、电容器的主要用途</strong></p><p>・电源滤波（几乎所有的电源电路中都用到，通过电容以滤除直流电源中不需要的交流成分，使直流电变平滑）</p><p>・去耦和旁路（基于的是电容的阻抗随频率升高而降低的原理）拓展一下：去耦电容和旁路电容都是起到抗干扰的作用。对于同一电路来说，旁路电容是把输入信号中的高频噪声作为滤除对象，把前级携带的高频杂波滤除；而去耦电容也称退耦电容，是把输出信号的干扰作为滤除对象。去耦电容用在放大电路中不需要交流的地方，用来消除自激，使放大器稳定工作</p><p>・滤波器（低通滤波器、高通滤波器）</p><p>・LC 谐振电路（带通滤波、陷波滤波）</p><p>・微分电路和积分电路</p><p>・电路耦合</p><p><strong>15、RC 无源滤波器</strong></p><p>・低通滤波器</p><p><img data-src="clip_image032.jpg" alt="img" /></p><p>容许低频信号通过，但减弱（或减少）频率高于截止频率信号通过的滤波器。对于不同滤波器而言，每个频率的信号的减弱程度不同</p><p>・高通滤波器</p><p><img data-src="clip_image034.jpg" alt="img" /></p><p>容许高频信号通过、但减弱（或减少）频率低于截止频率信号通过的滤波器。对于不同滤波器而言，每个频率的信号的减弱程度不同</p><p>高通、低通滤波器利用电容在频率响应上的特点，将一个电容或电感与一个电阻相配合，产生一个分压器，以将不需要的分量衰减掉，而容许所需的分量通过</p>]]></content>
      
      
      
        <tags>
            
            <tag> history </tag>
            
            <tag> 电子 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>三大无源器件之电阻</title>
      <link href="/docs/Electronic/%E4%B8%89%E5%A4%A7%E6%97%A0%E6%BA%90%E5%99%A8%E4%BB%B6%E4%B9%8B%E7%94%B5%E9%98%BB/"/>
      <url>/docs/Electronic/%E4%B8%89%E5%A4%A7%E6%97%A0%E6%BA%90%E5%99%A8%E4%BB%B6%E4%B9%8B%E7%94%B5%E9%98%BB/</url>
      
        <content type="html"><![CDATA[<blockquote><p>下面用三个篇章解释</p></blockquote><h1 id="视频篇"><a class="anchor" href="#视频篇">#</a> 视频篇</h1><p><iframe width="560" height="315" src="//player.bilibili.com/player.html?aid=99019699&bvid=BV1r741127C1&cid=169028314&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe></p><h1 id="漫画篇"><a class="anchor" href="#漫画篇">#</a> 漫画篇</h1><p><img data-src="clip_image002.jpg" alt="img" /></p><p>图片取自网络</p><h1 id="文字篇"><a class="anchor" href="#文字篇">#</a> 文字篇</h1><p><strong>电阻，作为最基础的无源器件之一，在电子电路中的应用十分广泛。</strong></p><p><strong>1、电阻器与欧姆定律</strong></p><p><strong>电阻器</strong>（Resistor），泛指所有用以产生电阻的电子或电机配件。电阻器的运作跟随<strong>欧姆定律</strong>，其电阻值定义为其电压与电流相除所得的比值。</p><p><img data-src="clip_image004.png" alt="img" /></p><p>其中</p><p>・I 是流过导体的电流，单位是<span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU1JUFFJTg5JUU1JTlGJUI5">安培</span>（A）。</p><p>・V 是导体两端的电位差，单位是<span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU0JUJDJThGJUU3JTg5JUI5">伏特</span>（V）。</p><p>・R 是导体的电阻，单位是<span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU2JUFEJTkwJUU1JUE3JTg2">欧姆</span>（Ω）。</p><p><strong>2、电阻单位和转换</strong></p><p>采用国际单位制，电阻的单位为欧姆（Ω，Ohm）。电阻的倒数为电导 G，单位为西门子（S）。</p><p>其还有其他转换单位：千欧 (KΩ) 、兆欧 (MΩ)</p><p>单位转换：1 兆欧 (MΩ) = 1000 千欧 (KΩ) = 1000000 欧姆 (Ω)</p><p><strong>3、电阻器的电路标志</strong></p><p><img data-src="clip_image006.png" alt="img" /></p><p><img data-src="clip_image008.png" alt="img" /></p><p><strong>4、电阻器的主要用途</strong></p><p>・在放大器中，他被用做有源器件的负载、偏置电路或反馈元件；</p><p>・它与电容结合使用即可形成时间常数，并作为滤波器使用；</p><p>・它也可由于设置工作电流与信号电平；</p><p>・在电源电路中用于损耗功率，以减少相应电压；</p><p>・也用于测量电流以及在电源撤去后使电容放电；</p><p>・还用于在精准电路中建立电流，提供准确的电压比，以及设置准确的增益值；</p><p>・在逻辑电路中，作为总线和线路终端以及 “上拉” 与 “下拉” 电阻；</p><p>・在高压电路中，用于测量电压与均衡串接中的二极管或电容的泄漏电流；</p><p>・在射频电路中，甚至可以用来作为线圈，取代电感。</p><p><strong>5、电阻的串联与并联</strong></p><p>・以下是一列<span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU0JUI4JUIyJUU4JTgxJUFG">串联</span>起来的电阻器：</p><p><img data-src="clip_image010.png" alt="img" /></p><p>​       电路两端的总电阻值为各电阻器的电阻之和，即</p><p><img data-src="clip_image012.png" alt="img" /></p><p>因此，利用电阻的串联，总可以得到一个阻值较大的电阻。</p><p>・以下是一组<span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU0JUI4JUE2JUU4JTgxJUFG">并联</span>的电阻器：</p><p><img data-src="clip_image014.png" alt="img" /></p><p>由于所有电阻的电压相同，根据欧姆定律，它们的电流与电阻成反比，故</p><p><img data-src="clip_image016.png" alt="img" /></p><p>因此，利用电阻的并联，总可以得到一个阻值较小的电阻。</p><p>・在对电子电路进行分析时，我们往往更喜欢利用对电路的直觉与简化来分析问题，而不是习惯于复杂的代数公式</p><p>当简要分析电路是，对于串并联的分析，我们可以简化成：一个较大的电阻与一个较小的电阻串联（或并联）后其阻值接近于较大的（或较小）的电阻</p><p>而为了培养我们的直觉，我们也使用 电导 G = 1 /R 一词来理解记忆，一个较小的电阻反而是一个较大的电导，在所加的电压作用下可通过较大的电流</p><p><strong>6、电阻色环阻值</strong></p><p><img data-src="clip_image017.jpg" alt="img" /></p><p><strong>7、电阻种类</strong></p><p>・碳膜电阻（主要是在陶瓷棒上形成一层碳混合物膜）</p><p>・金属膜电阻（主要是利用真空沉积技术在陶瓷棒上形成一层镍铬合金镀膜）</p><p>・金属氧化膜电阻（主要是在陶瓷棒形成一层锡氧化物膜）</p><p>・绕线电阻（是将镍铬合金导线绕在氧化铝陶瓷基底上，一圈一圈控制电阻大小）</p><p>・可变电阻（可经由滑动而改变滑动端与两个固定端间电阻值的电子零件）</p><p>・压敏电阻（电阻值会随外部电压而改变）</p><p>・光敏电阻（利用光电导效应的一种特殊的电阻，与入射光的强弱有直接关系）</p><p>・热敏电阻（其阻值随温度的变化有极为显著的变化）</p><p><strong>8、电阻参数</strong></p><p>・标称阻值：电阻器上面所标示的阻值</p><p>・允许误差：标称阻值与实际阻值的差值跟标称阻值之比的百分数称阻值偏差，它表示电阻器的精度</p><p>・额定功率：在正常的大气压力 90-106.6KPa 及环境贴片电阻参数温度为－55℃～＋70℃的条件下，电阻器长期工作所允许耗散的较大功率</p><p>・额定电压：由阻值和额定功率换算贴片电阻参数出的电压</p><p>・温度系数：温度每变化 1℃所引起的电阻值的相对变化，温度系数越小，电阻的稳定性越好，阻值随温度升高而增大的为正温度系数，反之为负温度系数</p><p>・老化系数：电阻器在额定功率长期负荷下，阻值相对变化的百分数，贴片电阻，贴片电阻参数它是表示电阻器寿命长短的参数</p><p>・电压系数：在规定的电压范围内，电压每变化 1 伏，电阻器的相对变化量</p><p>・噪声：产生于电阻器中的一种不规则的电压起伏，包括热噪声贴片电阻，贴片电阻参数和电流噪声两部分，热噪声是由于导体内部不规则的电子自由运动，使导体任意两点的电压不规则变化</p><p>平常我们一般只关注阻值、精度、额度功率，这三个指标合适即可。在数字电路中，我们无需关注太多的细节，毕竟只有 1 和 0 的数字里面，不必计较其微乎其微的影响；但是在模拟电路中，当我们使用精准的电压源，或者对信号进行模数转换，又或者放大一个微弱的信号时，阻值的小小变动都会带来很大的影响了</p><p><strong>9、0 欧电阻</strong></p><p>・可以做跳线调试用</p><p>・在高频信号下，充当电感或电容用</p><p>・单点接地（模拟地和数字地单点接地）</p><p>・熔丝作用</p><p>・配置电路（eg：STM32 的 BOOT）</p><p>・布线时作跨线处理（1206 封装的电阻）</p><p><strong>10、上拉电阻和下拉电阻</strong></p><p>・上拉就是将不确定的信号通过一个电阻嵌位在高电平，电阻同时起限流作用！下拉同理</p><p>・上拉是对器件注入电流，下拉是输出电流</p><p>・上拉电阻是用来解决总线驱动能力不足时提供电流的，一般说法是拉电流；下拉电阻是用来吸收电流的，也就是我们通常所说的灌电流</p><p>・弱强只是上拉电阻的阻值不同，没有什么严格区分</p><p><strong>11、纯阻性负载电压电流的超前滞后</strong></p><p>首先要提醒，相位的概念是针对正弦信号而言的，直流信号、非周期变化信号等都没有相位的概念</p><p>对于接上了正弦波的阻性负载，通过接上理想的直流电压表、直流电流表，可以观察到波形超前滞后的现象</p><p><img data-src="clip_image018.gif" alt="说明: 在这里插入图片描述" /></p><p>如果还表现的还不够生动，可以用动态图演示，其用红色表示电压，蓝色表示电流：</p><p><img data-src="clip_image019.gif" alt="说明: 在这里插入图片描述" /></p><p>纯阻性负载其超前角是 0 度，这个时候功率因数为 1</p><h1 id="附录"><a class="anchor" href="#附录">#</a> 附录：</h1><p><img data-src="E_96.jpg" alt="E-96 阻值表" /></p><p><img data-src="E_24.png" alt="E-24 阻值表" /></p>]]></content>
      
      
      
        <tags>
            
            <tag> history </tag>
            
            <tag> 电子 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FreeRTOS 篇章之事件位和事件组</title>
      <link href="/docs/RTOS/FreeRTOS%20%E7%AF%87%E7%AB%A0%E4%B9%8B%E4%BA%8B%E4%BB%B6%E4%BD%8D%E5%92%8C%E4%BA%8B%E4%BB%B6%E7%BB%84/"/>
      <url>/docs/RTOS/FreeRTOS%20%E7%AF%87%E7%AB%A0%E4%B9%8B%E4%BA%8B%E4%BB%B6%E4%BD%8D%E5%92%8C%E4%BA%8B%E4%BB%B6%E7%BB%84/</url>
      
        <content type="html"><![CDATA[<h1 id="事件位或标志与事件组"><a class="anchor" href="#事件位或标志与事件组">#</a> 事件位（或标志）与事件组</h1><p>事件位：用于指示事件是否发生；事件位通常称为事件标志。</p><p>事件组：是一组事件位；事件组中的各个事件位由位号引用（即每一 bit 代表某个事件）</p><h1 id="事件组和事件位数据类型"><a class="anchor" href="#事件组和事件位数据类型">#</a> 事件组和事件位数据类型</h1><p>事件组由  <code>EventGroupHandle_t</code>  类型的变量引用</p><p>如果  <code>configUSE_16_BIT_TICKS</code>  设置为  <code>1</code>  ，则事件组中存储的位数（或标志）为 8；如果  <code>configUSE_16_BIT_TICKS</code>  设置为  <code>0</code>  ，则为 24；对  <code>configUSE_16_BIT_TICKS</code>  的依赖性是由于在内部实现中用于线程本地存储的数据类型任务。</p><p><code>configUSE_16_BIT_TICKS</code>  的具体的描述可以看 <a href="https://arachnid.cc/docs/RTOS/FreeRTOS%20%E7%AF%87%E7%AB%A0%E4%B9%8B%20FreeRTOSConfig.h%E5%88%86%E6%9E%90/">FreeRTOS 篇章之 FreeRTOSConfig.h 分析</a> 。</p><p>事件组中的所有事件位都存储在  <code>EventBits_t</code>  类型的单个无符号变量中。事件位 0 存储在位位置 0，事件位 1 存储在位位置 1，依此类推。</p><p>下图显示了一个 24 位事件组，该组使用三个位来保存已描述的三个示例事件。在图像中，仅事件位 2 被设置。</p><p><img data-src="20200302151607721.png" alt="" /></p><h1 id="使用事件组必须克服的问题"><a class="anchor" href="#使用事件组必须克服的问题">#</a> 使用事件组必须克服的问题</h1><p>实施事件组时，RTOS 必须克服的两个主要挑战是：</p><p>1、避免在用户的应用程序中创建竞争条件：</p><p>在以下情况下，事件组的实现将会在应用程序中创建竞争条件：</p><ul><li>目前尚不清楚谁负责清除单个位（或标志）。</li><li>尚不清楚何时清除一点。</li><li>尚不清楚在任务退出测试该位值的 API 函数时是否设置了位或清除了位（这可能是因为另一个任务或中断已更改了位的状态）。</li></ul><p>FreeRTOS 事件组的实现通过智能的建立来确保设置、测试和清除位的原子性，从而消除了竞争条件的可能性。线程本地存储和谨慎使用 API 函数返回值使这成为可能。</p><p>2、避免不确定性：</p><p>事件组的概念隐含了不确定性行为，因为它不知道事件组上有多少个任务被阻止，因此，当设置了事件位时，也不知道需要测试多少条件或解除多少任务阻塞。</p><p>FreeRTOS 质量标准不允许不确定的行为在中断禁用或者中断服务中发生。为确保在设置事件位时不会违反这些严格的质量标准，需要以下两点：</p><ul><li>RTOS 调度器的锁定机制用于确保从 RTOS 任务设置事件位时，中断保持启用状态。</li><li>中央延迟中断机制用于在试图从中断服务例程设置事件位时，将设置位的动作延迟到任务。</li></ul><h1 id="事件组的-rtos-api-函数"><a class="anchor" href="#事件组的-rtos-api-函数">#</a> 事件组的 RTOS API 函数</h1><p>事件组的 API 函数允许任务或者其他事项来设置事件组中的一个或多个事件位，清除事件组中的 一个或多个事件位，并暂挂（进入 “阻止” 状态，因此任务不会占用任何处理时间）以等待一个或多个事件位在事件组中被置位。</p><p>事件组还可用于同步任务，创建通常称为任务 “会合” 的任务。任务同步点是应用程序代码中的一个位置，在这个位置上，任务将处于阻塞状态 (不消耗任何 CPU 时间) 等待，直到参与同步的所有其他任务也到达它们的同步点。</p><p>需要  <code>#include &quot;event_groups.h&quot;</code></p><table><thead><tr><th style="text-align:left">功能</th><th style="text-align:left">API 接口</th><th style="text-align:left">实际执行函数</th><th style="text-align:left">其它</th></tr></thead><tbody><tr><td style="text-align:left">事件组创建（动态）</td><td style="text-align:left">xEventGroupCreate()</td><td style="text-align:left"></td><td style="text-align:left"></td></tr><tr><td style="text-align:left">事件组响应等待</td><td style="text-align:left">xEventGroupWaitBits()</td><td style="text-align:left"></td><td style="text-align:left"></td></tr><tr><td style="text-align:left">事件组位清除</td><td style="text-align:left">xEventGroupClearBits()</td><td style="text-align:left"></td><td style="text-align:left"></td></tr><tr><td style="text-align:left">事件组位清除（用于中断中）</td><td style="text-align:left">xEventGroupClearBitsFromISR()</td><td style="text-align:left">xTimerPendFunctionCallFromISR()</td><td style="text-align:left">实际执行函数由宏决定</td></tr><tr><td style="text-align:left">事件组置位</td><td style="text-align:left">xEventGroupSetBits()</td><td style="text-align:left"></td><td style="text-align:left"></td></tr><tr><td style="text-align:left">事件组置位（用于中断中）</td><td style="text-align:left">xEventGroupSetBitsFromISR()</td><td style="text-align:left">xTimerPendFunctionCallFromISR()</td><td style="text-align:left">实际执行函数由宏决定</td></tr><tr><td style="text-align:left">事件组位获取</td><td style="text-align:left">xEventGroupGetBits()</td><td style="text-align:left">xEventGroupClearBits()</td><td style="text-align:left"></td></tr><tr><td style="text-align:left">事件组位获取（用于中断中）</td><td style="text-align:left">xEventGroupGetBitsFromISR()</td><td style="text-align:left"></td><td style="text-align:left"></td></tr><tr><td style="text-align:left">事件组释放删除</td><td style="text-align:left">vEventGroupDelete()</td><td style="text-align:left"></td><td style="text-align:left"></td></tr><tr><td style="text-align:left">事件组创建（静态）</td><td style="text-align:left">xEventGroupCreateStatic()</td><td style="text-align:left"></td><td style="text-align:left"></td></tr></tbody></table><p><strong>1、xEventGroupCreate () API 函数</strong></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>EventGroupHandle_t  <span class="token function">xEventGroupCreate</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>返回参数（此返回值应当保存下来，以作为操作此队列的句柄）：</p><ul><li><strong>NULL</strong>：表示事件组创建失败。原因是内存堆空间不足导致 FreeRTOS 无法为互斥量分配结构数据空间。</li><li><strong>非 NULL</strong>：值表示事件组创建成功。返回值应当保存起来作为该事件组的句柄。</li></ul><p><strong>2、xEventGroupWaitBits () API 函数</strong></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>EventBits_t  <span class="token function">xEventGroupWaitBits</span><span class="token punctuation">(</span> EventGroupHandle_t  xEventGroup<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="2"></td><td><pre>                                  <span class="token keyword">const</span> EventBits_t   uxBitsToWaitFor<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                                  <span class="token keyword">const</span> BaseType_t    xClearOnExit<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                                  <span class="token keyword">const</span> BaseType_t    xWaitForAllBits<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                                  <span class="token keyword">const</span> TickType_t    xTicksToWait <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>传入参数：</p><ul><li><strong>xEventGroup</strong>：事件组的目标句柄。这个句柄即是调用  <code>xEventGroupCreate()</code>  创建该事件组时的返回值。</li><li><strong>uxBitsToWaitFor</strong>：一个按位的值，表示在事件组中可设置的事件位（或标志）。</li><li><strong>xClearOnExit</strong>：如果设置为  <code>pdTRUE</code>  ，那么如果满足了等待条件 (如果函数返回的原因不是超时)，则在事件组中设置的  <code>uxBitsToWaitFor</code>  中的任何位都将在  <code>xEventGroupWaitBits()</code>  返回之前被清除；否则，如果设置为  <code>pdFALSE</code>  ，那么当调用  <code>xEventGroupWaitBits()</code>  返回时，事件组中设置的位不会改变。</li><li><strong>xWaitForAllBits</strong>：如果设置为  <code>pdTRUE</code>  ，那么当  <code>uxBitsToWaitFor</code>  中的所有位被设置或者指定的块时间过期时， <code>xEventGroupWaitBits()</code>  将返回；否则，如果设置为  <code>pdFALSE</code>  ，那么当  <code>uxBitsToWaitFor</code>  中设置的任何一个位或者指定的块时间过期时， <code>xEventGroupWaitBits()</code>  将返回。</li><li><strong>xTicksToWait</strong>：阻塞超时时间。</li></ul><p>返回参数：</p><ul><li>事件组中事件位的设置情况。如果  <code>xEventGroupWaitBits()</code>  因为超时而返回，则不会设置所有正在等待的事件位；在  <code>xClearOnExit</code>  参数被设置为  <code>pdTRUE</code>  的情况下，如果  <code>xEventGroupWaitBits()</code>  是因为它正在等待的位被设置而返回，那么返回的值就是在任何位被自动清除之前的事件组值。</li></ul><p><strong>3、xEventGroupClearBits () API 函数</strong></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>EventBits_t  <span class="token function">xEventGroupClearBits</span><span class="token punctuation">(</span> EventGroupHandle_t  xEventGroup<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="2"></td><td><pre>                                   <span class="token keyword">const</span> EventBits_t   uxBitsToClear <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>传入参数：</p><ul><li><strong>xEventGroup</strong>：要清除其中位的事件组。</li><li><strong>uxBitsToClear</strong> ：位值。表示在事件组中要清除的事件位（或标志）。</li></ul><p>返回参数：</p><ul><li>清除指定位之前的事件组的值</li></ul><p><strong>4、xEventGroupClearBitsFromISR () API 函数</strong></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>BaseType_t  <span class="token function">xEventGroupClearBitsFromISR</span><span class="token punctuation">(</span> EventGroupHandle_t  xEventGroup<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="2"></td><td><pre>                                         <span class="token keyword">const</span> EventBits_t   uxBitsToClear <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>传入参数：</p><ul><li><strong>xEventGroup</strong>：要清除其中位的事件组。</li><li><strong>uxBitsToClear</strong> ：位值。表示在事件组中要清除的事件位（或标志）。</li></ul><p>返回参数（有两个可能的返回值）：</p><ul><li><strong>pdPASS</strong>：成功发送请求。</li><li><strong>pdFALSE</strong>：发送请求失败。计时器服务队列已满。</li></ul><p><strong>5、xEventGroupSetBits () API 函数</strong></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>EventBits_t  <span class="token function">xEventGroupSetBits</span><span class="token punctuation">(</span> EventGroupHandle_t  xEventGroup<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="2"></td><td><pre>                                 <span class="token keyword">const</span> EventBits_t   uxBitsToSet <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>传入参数：</p><ul><li><strong>xEventGroup</strong>：要在其中位设置的事件组。</li><li><strong>uxBitsToSet</strong> ：一个按位的值，表示要设置的事件位（或标志）。</li></ul><p>返回参数：</p><ul><li>事件组在调用  <code>xEventGroupSetBits()</code>  时的值。</li></ul><p>注意：用户通过参数  <code>uxBitsToSet</code>  设置的标志位并不一定会保留到此函数的返回值中，返回的值可能清除有以下两种情况：<br />　a. 调用此函数的过程中，其它高优先级的任务就绪了，并且也修改了事件标志，此函数返回的事件标志位会发生变化。<br />　b. 调用此函数的任务是一个低优先级任务，通过此函数设置了事件标志后，让一个等待此事件标志的高优先级任务就绪了，会立即切换到高优先级任务去执行，相应的事件标志位会被函数  <code>xEventGroupWaitBits</code>  清除掉，等从高优先级任务返回到低优先级任务后，函数  <code>xEventGroupSetBits</code>  的返回值已经被修改。</p><p><strong>6、xEventGroupSetBitsFromISR () API 函数</strong></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>BaseType_t  <span class="token function">xEventGroupSetBitsFromISR</span><span class="token punctuation">(</span> EventGroupHandle_t  xEventGroup<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="2"></td><td><pre>                                       <span class="token keyword">const</span> EventBits_t   uxBitsToSet<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                                       BaseType_t          <span class="token operator">*</span>pxHigherPriorityTaskWoken <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>传入参数：</p><ul><li><strong>xEventGroup</strong>：要在其中位设置的事件组。</li><li><strong>uxBitsToSet</strong> ：一个按位的值，表示要设置的事件位（或标志）。</li><li><strong>pxHigherPriorityTaskWoken</strong>：用于保存是否有高优先级任务准备就绪。如果函数执行完毕后，此参数的数值是  <code>pdTRUE</code>  ，说明有高优先级任务要执行，否则没有；必须将  <code>xHigherPriorityTaskWoken</code>  初始化为  <code>pdFALSE</code>  。</li></ul><p>返回参数（有两个可能的返回值）：</p><ul><li><strong>pdPASS</strong>：成功发送请求。</li><li><strong>pdFALSE</strong>：发送请求失败。计时器服务队列已满。</li></ul><p><strong>7、xEventGroupGetBits () API 函数</strong></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>EventBits_t  <span class="token function">xEventGroupGetBits</span><span class="token punctuation">(</span> EventGroupHandle_t  xEventGroup <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>传入参数：</p><ul><li><strong>xEventGroup</strong>：需要查询的事件组。</li></ul><p>返回参数：</p><ul><li>调用  <code>xEventGroupGetBits()</code>  时的事件组位。</li></ul><p><strong>8、xEventGroupGetBitsFromISR () API 函数</strong></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>EventBits_t  <span class="token function">xEventGroupGetBitsFromISR</span><span class="token punctuation">(</span> EventGroupHandle_t  xEventGroup <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>传入参数：</p><ul><li><strong>xEventGroup</strong>：需要查询的事件组。</li></ul><p>返回参数：</p><ul><li>调用  <code>xEventGroupGetBitsFromISR()</code>  时的事件组位。</li></ul><p><strong>9、xEventGroupDelete () API 函数</strong></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">xEventGroupDelete</span><span class="token punctuation">(</span> EventGroupHandle_t  xEventGroup <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>传入参数：</p><ul><li><strong>xEventGroup</strong>：需要删除的事件组。</li></ul><p><strong>10、xEventGroupCreateStatic () API 函数</strong></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>EventGroupHandle_t  <span class="token function">xEventGroupCreateStatic</span><span class="token punctuation">(</span> EventGroupHandle_t  <span class="token operator">*</span>pxEventGroupBuffer <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>该函数是用于在静态的时候，利用该函数创建一个事件组，具体可以去看他的注释，这里就不说了。</p><h1 id="实例代码"><a class="anchor" href="#实例代码">#</a> 实例代码</h1><p>相关的实例代码及文档，参看保存在官方文件路径  <code>FreeRTOS/Demo/Common/Minimal</code>  下的  <code>EventGroupsDemo.c</code>  文件</p>]]></content>
      
      
      <categories>
          
          <category> FreeRTOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> history </tag>
            
            <tag> RTOS </tag>
            
            <tag> FreeRTOS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FreeRTOS 篇章之临界区与调度器</title>
      <link href="/docs/RTOS/FreeRTOS%20%E7%AF%87%E7%AB%A0%E4%B9%8B%E4%B8%B4%E7%95%8C%E5%8C%BA%E4%B8%8E%E8%B0%83%E5%BA%A6%E5%99%A8/"/>
      <url>/docs/RTOS/FreeRTOS%20%E7%AF%87%E7%AB%A0%E4%B9%8B%E4%B8%B4%E7%95%8C%E5%8C%BA%E4%B8%8E%E8%B0%83%E5%BA%A6%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<h1 id="临界区简述"><a class="anchor" href="#临界区简述">#</a> 临界区简述</h1><p><strong>临界区</strong>指的是一个访问共用资源（例如：共用设备或是共用存储器）的程序片段，而这些共用资源又无法同时被多个线程访问的特性；当有线程进入临界区时，其他线程或是进程必须等待。总的概括来说就是在执行该程序片段区间，不允许其他东西干扰到。</p><p>像我们在 MCU 上面跑实时操作系统，一般都是单核单进程的，而一个进程可以拥有多个线程；FreeRTOS 是主要以抢占式任务调度为主（通过 PendSV 中断），以时间片轮转调度任务为辅（通过 SysTick 系统节拍器中断）的实时操作系统，并且可支持同等优先级切换，具体配置可以看 <a href="https://arachnid.cc/docs/RTOS/FreeRTOS%20%E7%AF%87%E7%AB%A0%E4%B9%8B%20FreeRTOSConfig.h%E5%88%86%E6%9E%90/">FreeRTOS 篇章之 FreeRTOSConfig.h 分析</a> ；而刚讲的线程其实就相当于我们用 xTaskCreate 函数创建的各种任务。在这里，我们要实现临界区操作，那么就相当于要保证当前所处在的需要保护的代码片段不要受其他任务（线程）的干扰（例如同等优先级的切换、中断的触发）。</p><p>在 FreeRTOS 中，实现临界区操作有临界段操作和调度器操作两种，一般常用临界段来实现实现临界区操作。</p><hr /><h1 id="临界段的特性"><a class="anchor" href="#临界段的特性">#</a> 临界段的特性</h1><p>临界段是提供互斥功能的一种非常原始的实现方法。临界段的工作仅仅是简单地把任务切换和在  <code>configKERNEL_INTERRUPT_PRIORITY</code>  至  <code>configMAX_SYSCAL_INTERRUPT_PRIORITY</code>  之间的中断关掉 —— 依赖于具体使用的 FreeRTOS 移植。</p><p>临界段的使用必须只具有很短的时间，否则会反过来影响中断响应时间；在每次调用  <code>taskENTER_CRITICAL()</code>  之后，必须尽快地配套调用一个  <code>taskEXIT_CRITICAL()</code>  。</p><p>临界段嵌套是安全的，因为内核有维护一个嵌套深度计数。临界段只会在嵌套深度为 0 时才会真正退出 —— 即在为每个之前调用的  <code>taskENTER_CRITICAL()</code>  都配套调用了  <code>taskEXIT_CRITICAL()</code>  之后。</p><h1 id="与临界段相关的-api-函数"><a class="anchor" href="#与临界段相关的-api-函数">#</a> 与临界段相关的 API 函数</h1><table><thead><tr><th style="text-align:left">功能</th><th style="text-align:left">API 函数</th><th style="text-align:left">其它</th></tr></thead><tbody><tr><td style="text-align:left">进入临界段</td><td style="text-align:left">taskENTER_CRITICAL()</td><td style="text-align:left"></td></tr><tr><td style="text-align:left">taskENTER_CRITICAL_FROM_ISR()</td><td style="text-align:left">用于中断中</td><td style="text-align:left"></td></tr><tr><td style="text-align:left">退出临界段</td><td style="text-align:left">taskEXIT_CRITICAL()</td><td style="text-align:left"></td></tr><tr><td style="text-align:left">taskEXIT_CRITICAL_FROM_ISR( x )</td><td style="text-align:left">用于中断中</td><td style="text-align:left"></td></tr></tbody></table><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="2"></td><td><pre> * task. h</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * Macro to mark the start of a critical code region.  Preemptive context</pre></td></tr><tr><td data-num="5"></td><td><pre> * switches cannot occur when in a critical region.</pre></td></tr><tr><td data-num="6"></td><td><pre> *</pre></td></tr><tr><td data-num="7"></td><td><pre> * NOTE: This may alter the stack (depending on the portable implementation)</pre></td></tr><tr><td data-num="8"></td><td><pre> * so must be used with care!</pre></td></tr><tr><td data-num="9"></td><td><pre> *</pre></td></tr><tr><td data-num="10"></td><td><pre> * \defgroup taskENTER_CRITICAL taskENTER_CRITICAL</pre></td></tr><tr><td data-num="11"></td><td><pre> * \ingroup SchedulerControl</pre></td></tr><tr><td data-num="12"></td><td><pre> */</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">taskENTER_CRITICAL</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">portENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">taskENTER_CRITICAL_FROM_ISR</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">portSET_INTERRUPT_MASK_FROM_ISR</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="17"></td><td><pre> * task. h</pre></td></tr><tr><td data-num="18"></td><td><pre> *</pre></td></tr><tr><td data-num="19"></td><td><pre> * Macro to mark the end of a critical code region.  Preemptive context</pre></td></tr><tr><td data-num="20"></td><td><pre> * switches cannot occur when in a critical region.</pre></td></tr><tr><td data-num="21"></td><td><pre> *</pre></td></tr><tr><td data-num="22"></td><td><pre> * NOTE: This may alter the stack (depending on the portable implementation)</pre></td></tr><tr><td data-num="23"></td><td><pre> * so must be used with care!</pre></td></tr><tr><td data-num="24"></td><td><pre> *</pre></td></tr><tr><td data-num="25"></td><td><pre> * \defgroup taskEXIT_CRITICAL taskEXIT_CRITICAL</pre></td></tr><tr><td data-num="26"></td><td><pre> * \ingroup SchedulerControl</pre></td></tr><tr><td data-num="27"></td><td><pre> */</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">taskEXIT_CRITICAL</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">portEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">taskEXIT_CRITICAL_FROM_ISR</span><span class="token expression"><span class="token punctuation">(</span> x <span class="token punctuation">)</span> <span class="token function">portCLEAR_INTERRUPT_MASK_FROM_ISR</span><span class="token punctuation">(</span> x <span class="token punctuation">)</span></span></span></pre></td></tr></table></figure><hr /><h1 id="临界段的使用"><a class="anchor" href="#临界段的使用">#</a> 临界段的使用</h1><p>在 FreeRTOS 中，临界段一般是指宏  <code>taskENTER_CRITICAL()</code>  与  <code>taskEXIT_CRITICAL()</code>  之间的代码区间，而在中断中则是  <code>taskENTER_CRITICAL_FROM_ISR()</code>  和  <code>taskEXIT_CRITICAL_FROM_ISR()</code>  之间。</p><p>例如，在 <a href="https://arachnid.cc/docs/RTOS/FreeRTOS%20%E7%AF%87%E7%AB%A0%E4%B9%8B%E4%BA%8C%E5%80%BC%E4%BF%A1%E5%8F%B7%E9%87%8F/">FreeRTOS 篇章之二值信号量</a> 中的  <code>USART1_IRQHandler(void)</code>  中断函数中，我们可以加入临界区操作，变成：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/************************************************************************/</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">/*            STM32F10x USART Interrupt Handlers                        */</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/************************************************************************/</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="6"></td><td><pre>  * @brief  This function handles USART1 global interrupt request.</pre></td></tr><tr><td data-num="7"></td><td><pre>  * @param  None</pre></td></tr><tr><td data-num="8"></td><td><pre>  * @retval None</pre></td></tr><tr><td data-num="9"></td><td><pre>  */</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">void</span> <span class="token function">USART1_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token class-name">uint32_t</span> ulReturn<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    BaseType_t xHigherPriorityTaskWoken <span class="token operator">=</span> pdFALSE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">/* 为了保证在对 DMA 数据进行处理不被打断，将此操作放入临界区 */</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    ulReturn <span class="token operator">=</span> <span class="token function">taskENTER_CRITICAL_FROM_ISR</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 进入临界段，可以嵌套</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment">/* 在 taskENTER_CRITICAL_FROM_ISR () 与 taskEXIT_CRITICAL_FROM_ISR () 之间或</pre></td></tr><tr><td data-num="20"></td><td><pre>       在 taskENTER_CRITICAL () 与 taskEXIT_CRITICAL () 之间并不会切换到其它任务，</pre></td></tr><tr><td data-num="21"></td><td><pre>       同时，在 configKERNEL_INTERRUPT_PRIORITY 至 configMAX_SYSCAL_INTERRUPT_PRIORITY 之间</pre></td></tr><tr><td data-num="22"></td><td><pre>       的中断将会被关掉，但对于优先级高于 configMAX_SYSCALL_INTERRUPT_PRIORITY 的中断</pre></td></tr><tr><td data-num="23"></td><td><pre>       并没有关掉，而且这些中断不允许访问 FreeRTOS API 函数. */</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">USART_GetITStatus</span><span class="token punctuation">(</span>EVAL_COM1<span class="token punctuation">,</span> USART_IT_IDLE<span class="token punctuation">)</span><span class="token operator">!=</span>RESET<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token function">DMA_Cmd</span><span class="token punctuation">(</span>USART1_RX_DMA_CHANNEL<span class="token punctuation">,</span> DISABLE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token function">DMA_ClearFlag</span><span class="token punctuation">(</span>DMA1_FLAG_TC5<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        Usart1<span class="token punctuation">.</span>RxCounter <span class="token operator">=</span> RxBUFFER_SIZE <span class="token operator">-</span> <span class="token function">DMA_GetCurrDataCounter</span><span class="token punctuation">(</span>USART1_RX_DMA_CHANNEL<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        USART1_RX_DMA_CHANNEL<span class="token operator">-></span>CNDTR <span class="token operator">=</span> RxBUFFER_SIZE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token function">DMA_Cmd</span><span class="token punctuation">(</span>USART1_RX_DMA_CHANNEL<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token function">xSemaphoreGiveFromISR</span><span class="token punctuation">(</span>xBinarySemaphore<span class="token punctuation">,</span> <span class="token operator">&amp;</span>xHigherPriorityTaskWoken<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token function">portEND_SWITCHING_ISR</span><span class="token punctuation">(</span>xHigherPriorityTaskWoken<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token function">USART_ReceiveData</span><span class="token punctuation">(</span>EVAL_COM1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Clear IDLE interrupt flag bit</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>  </pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token comment">/* 退出临界段 */</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token function">taskEXIT_CRITICAL_FROM_ISR</span><span class="token punctuation">(</span> ulReturn <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token comment">//  if(USART_GetITStatus(EVAL_COM1, USART_IT_TXE) != RESET)</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token comment">//  &#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token comment">//    /* Write one byte to the transmit data register */</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token comment">//    USART_SendData(EVAL_COM1, TxBuffer[TxCounter++]);</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token comment">//    if(TxCounter == RxBUFFER_SIZE)</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token comment">//    &#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token comment">//      /* Disable the EVAL_COM1 Transmit interrupt */</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token comment">//      USART_ITConfig(EVAL_COM1, USART_IT_TXE, DISABLE);</span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token comment">//    &#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token comment">//  &#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h1 id="用挂起调度器来创建临界区"><a class="anchor" href="#用挂起调度器来创建临界区">#</a> 用挂起调度器来创建临界区</h1><p>调度器总是在所有处于就绪态的任务中选择具有最高优先级的任务来执行的（这就是 FreeRTOS 的优先级调度算法）。</p><p>因此创建临界区也可以通过挂起调度器来实现；挂起调度器有些时候也被称为锁定调度器。</p><p>临界段保护一段代码区间不被其它任务或中断打断（此处的中断是指归 FreeRTOS 管理的中断）。通过挂起调度器实现的临界区只可以保护一段代码区间不被其它任务打断，因为这种方式下，中断是使能的（此处的中断是指所有的中断，包含归 FreeRTOS 管理的中断）。<br />如果一个临界区太长而不适合简单地关中断来实现，可以考虑采用挂起调度器的方式；但是唤醒（resuming, or un-suspending）调度器却是一个相对较长的操作，所以评估哪种是最佳方式需要结合实际情况。</p><p>利用  <code>vTaskSuspendAll();</code>  把调度器挂起，这样可以停止上下文切换而没有关中断；如果某个中断在调度器挂起过程中要求进行上下文切换，则个这请求也会被挂起，直到调度器被唤醒后才会得到执行（即调用  <code>xTaskResumeAll();</code>  恢复调度器）。</p><p>注意：在调度器处于挂起状态时（即  <code>vTaskSuspendAll();</code>  至  <code>xTaskResumeAll();</code>  之间），不能调用 FreeRTOS API 函数。</p><p><strong>1、vTaskSuspend () API 函数</strong></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">vTaskSuspend</span><span class="token punctuation">(</span> TaskHandle_t  xTaskToSuspend <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>输入参数：</p><ul><li>需要挂起的某个任务的句柄，这个句柄是创建任务时所引用出来的；当传递空值句柄时，将导致当前调用任务暂停；当任务暂停时，将永远无法获得任何微控制器的处理时间，无论其优先级如何。</li></ul><p><strong>2、vTaskResume () API 函数</strong></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">vTaskResume</span><span class="token punctuation">(</span> TaskHandle_t  xTaskToResume <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>输入参数：</p><ul><li>需要恢复成就绪状态的任务的句柄</li></ul><p><strong>3、xTaskResumeFromISR () API 函数</strong></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>BaseType_t  <span class="token function">xTaskResumeFromISR</span><span class="token punctuation">(</span> TaskHandle_t  xTaskToResume <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>输入参数：</p><ul><li>需要恢复成就绪状态的任务的句柄。</li></ul><p>返回参数：</p><ul><li>如果恢复任务，则为  <code>pdTRUE</code>  ，否则为  <code>pdFALSE</code>  。ISR 使用它来确定是否需要在 ISR 之后进行上下文切换。</li></ul><p><strong>4、vTaskSuspendAll () API 函数</strong></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">vTaskSuspendAll</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>说明：挂起调度器而不禁用中断。当调度器挂起时，上下文切换将不会发生。在调用  <code>vTaskSuspendAll()</code>  之后，调用任务将继续执行；在调用  <code>xTaskResumeAll()</code>  之前，不会有被切换出去的风险，直到对  <code>xTaskResumeAll()</code>  的调用完成。当调度器被挂起时，不能调用可能导致上下文切换的 API 函数（例如，  <code>vTaskDelayUntil()</code>  、  <code>xQueueSend()</code>  等）。</p><p><strong>5、xTaskResumeAll () API 函数</strong></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>BaseType_t  <span class="token function">xTaskResumeAll</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>返回参数：</p><ul><li>在调度器挂起过程中，上下文切换请求也会被挂起，直到调度器被唤醒后才会得到执行。如果一个挂起的上下文切换请求在  <code>xTaskResumeAll()</code>  返回前得到执行，则函数返回  <code>pdTRUE</code>  。在其它情况下， <code>xTaskResumeAll()</code>  返回  <code>pdFALSE</code>  。</li></ul><p>说明：在调用  <code>vTaskSuspendAll()</code>  挂起调度程序活动后，恢复该活动。 <code>xTaskResumeAll()</code>  只恢复调度程序。它不会解除先前通过调用  <code>vTaskSuspend()</code>  挂起的任务。</p><p>嵌套调用  <code>vTaskSuspendAll()</code>  和  <code>xTaskResumeAll()</code>  是安全的，因为内核有维护一个嵌套深度计数。调度器只会在嵌套深度计数为 0 时才会被唤醒 —— 即在为每个之前调用的  <code>vTaskSuspendAll()</code>  都配套调用了  <code>xTaskResumAll()</code>  之后</p><h1 id="与调度器相关的-api"><a class="anchor" href="#与调度器相关的-api">#</a> 与调度器相关的 API</h1><table><thead><tr><th style="text-align:left">功能</th><th style="text-align:left">API 函数</th></tr></thead><tbody><tr><td style="text-align:left">启动调度器</td><td style="text-align:left">vTaskStartScheduler()</td></tr><tr><td style="text-align:left">停止调度器</td><td style="text-align:left">vTaskEndScheduler()</td></tr><tr><td style="text-align:left">挂起某个任务</td><td style="text-align:left">vTaskSuspend()</td></tr><tr><td style="text-align:left">恢复某个任务</td><td style="text-align:left">vTaskResume()</td></tr><tr><td style="text-align:left">恢复某个任务（用于中断）</td><td style="text-align:left">xTaskResumeFromISR()</td></tr><tr><td style="text-align:left">挂起所有调度器</td><td style="text-align:left">vTaskSuspendAll()</td></tr><tr><td style="text-align:left">恢复所有调度器</td><td style="text-align:left">xTaskResumeAll()</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> FreeRTOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> history </tag>
            
            <tag> RTOS </tag>
            
            <tag> FreeRTOS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FreeRTOS 篇章之互斥量</title>
      <link href="/docs/RTOS/FreeRTOS%20%E7%AF%87%E7%AB%A0%E4%B9%8B%E4%BA%92%E6%96%A5%E9%87%8F/"/>
      <url>/docs/RTOS/FreeRTOS%20%E7%AF%87%E7%AB%A0%E4%B9%8B%E4%BA%92%E6%96%A5%E9%87%8F/</url>
      
        <content type="html"><![CDATA[<h1 id="与二值量区别及应用"><a class="anchor" href="#与二值量区别及应用">#</a> 与二值量区别及应用</h1><p>互斥量是一种特殊的二值信号量，用于控制在两个或多个任务间访问共享资源。</p><p>访问一个被多任务共享，或是被任务与中断共享的资源时，需要采用 “互斥” 技术以保证数据在任何时候都保持一致性。这样做的目的是要确保任务从开始访问资源就具有排它性，直至这个资源又恢复到完整状态。</p><p>在用于互斥的场合，互斥量从概念上可看作是与共享资源关联的令牌。一个任务想要合法地访问资源，其必须先成功地得到（Take）该资源对应的令牌（成为令牌持有者）。当令牌持有者完成资源使用，其最好马上归还（Give）令牌，因为只有归还了令牌，其它任务才可能成功持有，也才可能安全地访问该共享资源。一个任务除非持有了令牌，否则不允许访问共享资源。</p><p>它的特性场景：</p><p><img data-src="2020022418230370.gif" alt="img" /></p><p>这种机制纯粹是工作于应用程序作者制定的规则之下。任务不是在任何时候都可以访问资源是不需要理由的，因为这是所有任务达成的一致，除非它们能成为互斥量的持有者。</p><p>可以对比一下上一篇 <a href="https://arachnid.cc/docs/RTOS/FreeRTOS%20%E7%AF%87%E7%AB%A0%E4%B9%8B%E4%BA%8C%E5%80%BC%E4%BF%A1%E5%8F%B7%E9%87%8F/">FreeRTOS 篇章之二值信号量</a> 的特性图。</p><p>虽然互斥量与二值信号量之间具有很多相同的特性，但两者间最大的区别在于信号量在被获得之后所发生的事情：</p><ul><li>用于互斥的信号量需要归还。</li><li>用于同步的信号量通常是完成同步之后便丢弃，不用归还。</li></ul><p>值得注意的是，互斥量不能在中断中使用：</p><ul><li>互斥量的优先级继承属性意味着只能在任务间使用</li><li>中断在等待一个互斥量保护的资源的时候，不能阻塞</li></ul><h1 id="优先级反转"><a class="anchor" href="#优先级反转">#</a> 优先级反转</h1><p>假设我们创建了两个任务，任务一跟任务二，任务二的优先级高于任务一的优先级，同时还创建了一个互斥量；当运行的时候，任务一获取了这个互斥量（成为令牌持有者），紧接着任务二也需要这个互斥量来共享资源（此时任务一并没有执行完成，释放互斥量），对于正常情况向下，高优先级任务的可以打断低优先任务，但是，由于互斥量的特性（只有归还了令牌，其它任务才可能成功持有，否则不允许访问共享资源，进入阻塞等待令牌归还），高优先级的任务二竟然必须等待低优先级的任务一放弃对互斥量的持有权。因此，高优先级任务被低优先级任务阻塞推迟的行为被称为 “优先级反转” 。</p><p>如果把这种行为再进一步放大，当高优先级任务正等待信号量的时候，一个介于两个任务优先之间的中等优先级任务开始执行 —— 这就会导致一个高优先级任务在等待一个低优先级任务，而低优先级任务却无法执行！</p><p>如下图：</p><p><img data-src="20200225112317242.png" alt="img" /></p><h1 id="优先级继承"><a class="anchor" href="#优先级继承">#</a> 优先级继承</h1><p>FreeRTOS 中互斥量与二值信号量十分相似 —— 唯一的区别就是互斥量自动提供了一个基本的 ” 优先级继承” 机制。</p><p>优先级继承是最小化优先级反转负面影响的一种方案 —— 其并不能修正优先级反转带来的问题，仅仅是减小优先级反转的影响。优先级继承使得系统行为的数学分析更为复杂，所以如果可以避免的话，并不建议系统实现对优先级继承有所依赖。</p><p>优先级继承暂时地将互斥量持有者的优先级提升至所有等待此互斥量的任务所具有的最高优先级；持有互斥量的低优先级任务 “继承” 了等待互斥量的任务的优先级；互斥量持有者在归还互斥量时，优先级会自动设置为其原来的优先级。</p><p>优先级继承最小化优先级反转的影响：</p><p><img data-src="20200225112349522.png" alt="img" /></p><h1 id="死锁"><a class="anchor" href="#死锁">#</a> 死锁</h1><p>死锁是利用互斥量提供互斥功能的另一个潜在缺陷。Deadlock 有时候会被更戏剧性地称为 “deadly embrace（抱死）”。</p><p>当两个任务都在等待被对方持有的资源时，两个任务都无法再继续执行，这种情况就被称为死锁。考虑如下情形，任务 A 与任务 B 都需要获得互斥量 X 与互斥量 Y 以完成各自的工作：</p><ol><li>任务 A 执行，并成功获得了互斥量 X。</li><li>任务 A 被任务 B 抢占。</li><li>任务 B 成功获得了互斥量 Y，之后又试图获取互斥量 X —— 但互斥量 X 已经被任务 A 持有，所以对任务 B 无效。任务 B 选择进入阻塞态以等待互斥量 X 被释放。</li><li>任务 A 得以继续执行。其试图获取互斥量 Y —— 但互斥量 Y 已经被任务 B 持有而对任务 A 无效。任务 A 也选择进入阻塞态以等待互斥量 Y 被释放。</li></ol><p>这种情形的最终结局是，任务 A 在等待一个被任务 B 持有的互斥量，而任务 B 也在等待一个被任务 A 持有的互斥量。死锁于是发生，因为两个任务都不可能再执行下去了。</p><p>和优先级反转一样，避免死锁的最好方法就是在设计阶段就考虑到这种潜在风险，这样设计出来的系统就不应该会出现死锁的情况。于实践经验而言，对于一个小型嵌入式系统，死锁并不是一个大问题，因为系统设计者对整个应用程序都非常清楚，所以能够找出发生死锁的代码区域，并消除死锁问题。</p><h1 id="api函数"><a class="anchor" href="#api函数">#</a> API 函数</h1><p>需要  <code>#include &quot;semphr.h&quot;</code></p><table><thead><tr><th style="text-align:left">功能</th><th style="text-align:left">API 接口</th><th style="text-align:left">实际执行函数</th><th style="text-align:left">其它</th></tr></thead><tbody><tr><td style="text-align:left">互斥量创建（动态）</td><td style="text-align:left">xSemaphoreCreateMutex()</td><td style="text-align:left">xQueueCreateMutex()</td><td style="text-align:left"></td></tr><tr><td style="text-align:left">互斥量获取</td><td style="text-align:left">xSemaphoreTake()</td><td style="text-align:left">xQueueGenericReceive()</td><td style="text-align:left"></td></tr><tr><td style="text-align:left">互斥量释放</td><td style="text-align:left">xSemaphoreGive()</td><td style="text-align:left">xQueueGenericSend()</td><td style="text-align:left"></td></tr><tr><td style="text-align:left">互斥量创建（静态）</td><td style="text-align:left">xSemaphoreCreateMutexStatic()</td><td style="text-align:left">xQueueCreateMutexStatic()</td><td style="text-align:left"></td></tr></tbody></table><p><strong>1、xSemaphoreCreateMutex () API 函数</strong></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>SemaphoreHandle_t  <span class="token function">xSemaphoreCreateMutex</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>返回参数：</p><ul><li><strong>NULL</strong>：表示互斥量创建失败。原因是内存堆空间不足导致 FreeRTOS 无法为互斥量分配结构数据空间。</li><li><strong>非 NULL</strong>：值表示互斥量创建成功。返回值应当保存起来作为该互斥量的句柄。</li></ul><p><strong>2、xSemaphoreTake () API 函数</strong></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>BaseType_t  <span class="token function">xSemaphoreTake</span><span class="token punctuation">(</span> SemaphoreHandle_t  xSemaphore<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="2"></td><td><pre>                            TickType_t         xBlockTime <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>传入参数：</p><ul><li><strong>xSemaphore</strong>：获取得到的信号量。信号量由定义为 xSemaphoreHandle 类型的变量引用；信号量在使用前必须先创建</li><li><strong>xTicksToWait</strong>：阻塞超时时间。任务进入阻塞态以等待信号量有效的最长时间。如果  <code>xTicksToWait</code>  为  <code>0</code>  ，则  <code>xSemaphoreTake()</code>  在信号量无效时会立即返回；如果把  <code>xTicksToWait</code>  设置为  <code>portMAX_DELAY</code>  ，那么阻塞等待将没有超时限制。</li></ul><p>返回参数（有两个可能的返回值）：</p><ul><li><strong>pdTRUE</strong>：成功获得信号量。</li><li><strong>pdFALSE</strong>：未能获得信号量。</li></ul><p><strong>3、xSemaphoreGive () API 函数</strong></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>BaseType_t  <span class="token function">xSemaphoreGive</span><span class="token punctuation">(</span> SemaphoreHandle_t  xSemaphore <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>传入参数：</p><ul><li><strong>xSemaphore</strong>：给出的信号量。信号量由定义为  <code>xSemaphoreHandle</code>  类型的变量引用；信号量在使用前必须先创建。</li></ul><p>返回参数（有两个可能的返回值）：</p><ul><li><strong>pdTRUE</strong>：信号量被释放。</li><li><strong>pdFALSE</strong>：信号量已经有效，无法给出。</li></ul><p><strong>4、xSemaphoreCreateMutexStatic () API 函数</strong></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>SemaphoreHandle_t  <span class="token function">xSemaphoreCreateMutexStatic</span><span class="token punctuation">(</span> StaticSemaphore_t  <span class="token operator">*</span>pxMutexBuffer <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>该函数是用于在静态的时候，利用该函数创建一个互斥量的，具体可以去看他的注释，这里就不说了。</p><p>值得注意的是：当用  <code>xSemaphoreCreateMutexStatic</code>  创建一个静态互斥量后，该互斥量量是默认 “Give” 给出去了的，所以在  <code>xSemaphoreCreateMutexStatic</code>  创建后没有立即调用  <code>xSemaphoreTake</code>  ，那么，它将通过你的第一次阻塞处理。</p><h1 id="其他"><a class="anchor" href="#其他">#</a> 其他</h1><p>这里就不放整个例程了，跟 <a href="https://arachnid.cc/docs/RTOS/FreeRTOS%20%E7%AF%87%E7%AB%A0%E4%B9%8B%E9%98%9F%E5%88%97%E7%AE%A1%E7%90%86/">FreeRTOS 篇章之队列管理</a> 中差不多，只不过用互斥量来处理；像我们常用的多线程 printf 输出会出现乱码现象，可以如以下处理：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">extern</span> SemaphoreHandle_t MuxSem_UartPrintf<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">USER_DEBUG</span><span class="token expression"><span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">DEBUG_PRINTF</span><span class="token expression"><span class="token punctuation">(</span>fmt<span class="token punctuation">,</span>arg<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token keyword">do</span><span class="token punctuation">&#123;</span></span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token expression"><span class="token keyword">if</span><span class="token punctuation">(</span>USER_DEBUG<span class="token punctuation">)</span></span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token expression"><span class="token function">xSemaphoreTake</span><span class="token punctuation">(</span>MuxSem_UartPrintf<span class="token punctuation">,</span> portMAX_DELAY<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token expression"><span class="token function">printf</span><span class="token punctuation">(</span></span><span class="token string">"&lt;&lt;-DEBUG INFO->> %s > "</span><span class="token expression">fmt</span><span class="token string">""</span><span class="token expression"><span class="token punctuation">,</span>__FUNCTION__<span class="token punctuation">,</span> </span><span class="token punctuation">##</span><span class="token expression">arg<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token expression"><span class="token function">xSemaphoreGive</span><span class="token punctuation">(</span>MuxSem_UartPrintf<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token expression"><span class="token punctuation">&#125;</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span></pre></td></tr></table></figure><p>然后，我们只需要在硬件初始化化的创建好互斥量，后面就可以用  <code>DEBUG_PRINTF</code>  宏来打印无乱码现象的数据输出了，而且还可以通过 USER_DEBUG 宏来选择时候显示调试信息。</p><p>前面也都说了，为了避免在 RTOS 中多个任务同时访问公用数据共享资源（或者同一硬件），因此，当有一个任务在访问处理共享资源时，其他的任务要停止对共享资源的访问，以避免出现数据访问（或处理）出错，所以可以用互斥量来处理这些问题；当然在使用互斥量的时候要注意上面所说的那一些缺陷。</p><p>最后，说一下递归互斥量：</p><p>递归互斥量（  <code>Recursive Mutexes</code>  ）是互斥量的一个特例，与互斥量基本相同；除了：递归互斥量可以由拥有者多次获取，但是也要求拥有者释放相同次数。比如，一个递归互斥量被获取了 5 次，那么同样需要释放 5 次。</p>]]></content>
      
      
      <categories>
          
          <category> FreeRTOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> history </tag>
            
            <tag> RTOS </tag>
            
            <tag> FreeRTOS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FreeRTOS 篇章之二值信号量</title>
      <link href="/docs/RTOS/FreeRTOS%20%E7%AF%87%E7%AB%A0%E4%B9%8B%E4%BA%8C%E5%80%BC%E4%BF%A1%E5%8F%B7%E9%87%8F/"/>
      <url>/docs/RTOS/FreeRTOS%20%E7%AF%87%E7%AB%A0%E4%B9%8B%E4%BA%8C%E5%80%BC%E4%BF%A1%E5%8F%B7%E9%87%8F/</url>
      
        <content type="html"><![CDATA[<h1 id="采用二值信号量同步"><a class="anchor" href="#采用二值信号量同步">#</a> 采用二值信号量同步</h1><p>二值信号量可以在某个特殊的中断发生时，让任务解除阻塞，相当于让任务与中断同步。这样就可以让中断事件处理量大的工作在同步任务中完成，中断服务例程 (ISR) 中只是快速处理少部份工作。</p><p>如果某个中断处理要求特别紧急，其延迟处理任务的优先级可以设为最高，以保证延迟处理任务随时都抢占系统中的其它任务。</p><p>在这种中断同步的情形下，信号量可以看作是一个深度为 1 的队列。这个队列由于最多只能保存一个数据单元，所以其非空则满（所谓 “二值” 即二进制，只有 0 / 1）。延迟处理任务调用  <code>xSemaphoreTake()</code>  时，等效于带阻塞时间地读取队列，如果队列为空的话任务则进入阻塞态。当事件发生后，ISR 简单地通过调用  <code>xSemaphoreGiveFromISR()</code>  放置一个令牌（信号量）到队列中，使得队列成为满状态。这也使得延迟处理任务切出阻塞态，并移除令牌，使得队列再次成为空。</p><p>其演示过程：</p><p><img data-src="20200220173730247.gif" alt="img" /></p><h1 id="api-函数"><a class="anchor" href="#api-函数">#</a> API 函数</h1><p>要想调用以下函数，需要  <code>#include &quot;semphr.h&quot;</code></p><table><thead><tr><th style="text-align:left">功能</th><th style="text-align:left">API 接口</th><th style="text-align:left">实际执行函数</th><th style="text-align:left">其它</th></tr></thead><tbody><tr><td style="text-align:left">二值信号量创建（动态）</td><td style="text-align:left">vSemaphoreCreateBinary()</td><td style="text-align:left"></td><td style="text-align:left">弃用</td></tr><tr><td style="text-align:left">二值信号量创建（动态）</td><td style="text-align:left">xSemaphoreCreateBinary()</td><td style="text-align:left">xQueueGenericCreate()</td><td style="text-align:left"></td></tr><tr><td style="text-align:left">二值信号量获取</td><td style="text-align:left">xSemaphoreTake()</td><td style="text-align:left">xQueueGenericReceive()</td><td style="text-align:left"></td></tr><tr><td style="text-align:left">二值信号量释放</td><td style="text-align:left">xSemaphoreGive()</td><td style="text-align:left">xQueueGenericSend()</td><td style="text-align:left"></td></tr><tr><td style="text-align:left">二值信号量获取（用于中断中）</td><td style="text-align:left">xSemaphoreTakeFromISR()</td><td style="text-align:left">xQueueReceiveFromISR()</td><td style="text-align:left"></td></tr><tr><td style="text-align:left">二值信号量释放（用于中断中）</td><td style="text-align:left">xSemaphoreGiveFromISR()</td><td style="text-align:left">xQueueGiveFromISR()</td><td style="text-align:left"></td></tr><tr><td style="text-align:left">二值信号量创建（静态）</td><td style="text-align:left">xSemaphoreCreateBinaryStatic()</td><td style="text-align:left">xQueueGenericCreateStatic()</td><td style="text-align:left"></td></tr></tbody></table><p><strong>1、vSemaphoreCreateBinary () API 函数（弃用）</strong></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">vSemaphoreCreateBinary</span><span class="token punctuation">(</span> xSemaphore <span class="token punctuation">)</span></pre></td></tr></table></figure><p>传入参数：</p><ul><li><strong>xSemaphore</strong>：创建的二值信号量</li></ul><p>需要说明的是  <code>vSemaphoreCreateBinary()</code>  在实现上是一个宏，所以信号量变量应当直接传入，而不是传址。</p><p>注意：在新的版本中一般是通过  <code>xSemaphoreCreateBinary(void)</code>  函数返回一个  <code>SemaphoreHandle_t</code>  值，并以此创建一个二值信号量。</p><p><strong>2、SemaphoreHandle_t xSemaphoreCreateBinary () API 函数</strong></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">xSemaphoreCreateBinary</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token function">xQueueGenericCreate</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">,</span> semSEMAPHORE_QUEUE_ITEM_LENGTH<span class="token punctuation">,</span> queueQUEUE_TYPE_BINARY_SEMAPHORE <span class="token punctuation">)</span></span></span></pre></td></tr></table></figure><p>返回参数：</p><ul><li><strong>SemaphoreHandle_t</strong>：创建的二值信号量</li></ul><p>为什么放弃  <code>vSemaphoreCreateBinary()</code>  函数以及它们之间的区别我们可以看一下它的注释：</p><pre><code>/*   This old vSemaphoreCreateBinary() macro is now deprecated in favour of   the xSemaphoreCreateBinary() function. Note that binary semaphores created using   the vSemaphoreCreateBinary() macro are created in a state such   that the first call to 'take' the semaphore would pass,   whereas binary semaphores created using xSemaphoreCreateBinary() are created   in a state such that the the semaphore must first be 'given' before it can be 'taken'.*/</code></pre><p><strong>3、xSemaphoreTake () API 函数</strong></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>BaseType_t  <span class="token function">xSemaphoreTake</span><span class="token punctuation">(</span> SemaphoreHandle_t  xSemaphore<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="2"></td><td><pre>                            TickType_t         xBlockTime <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>传入参数：</p><ul><li><strong>xSemaphore</strong>：获取得到的信号量。信号量由定义为  <code>xSemaphoreHandle</code>  类型的变量引用；信号量在使用前必须先创建。</li><li><strong>xTicksToWait</strong>：阻塞超时时间。任务进入阻塞态以等待信号量有效的最长时间。如果  <code>xTicksToWait</code>  为  <code>0</code>  ，则  <code>xSemaphoreTake()</code>  在信号量无效时会立即返回；如果把  <code>xTicksToWait</code>  设置为  <code>portMAX_DELAY</code>  ，那么阻塞等待将没有超时限制。</li></ul><p>返回参数（有两个可能的返回值）：</p><ul><li><strong>pdTRUE</strong>：成功获得信号量。</li><li><strong>pdFALSE</strong>：未能获得信号量。</li></ul><p><strong>4、xSemaphoreGive () API 函数</strong></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>BaseType_t  <span class="token function">xSemaphoreGive</span><span class="token punctuation">(</span> SemaphoreHandle_t  xSemaphore <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>传入参数：</p><ul><li><strong>xSemaphore</strong>：给出的信号量。信号量由定义为  <code>xSemaphoreHandle</code>  类型的变量引用；信号量在使用前必须先创建。</li></ul><p>返回参数（有两个可能的返回值）：</p><ul><li><strong>pdTRUE</strong>：信号量被释放。</li><li><strong>pdFALSE</strong>：信号量已经有效，无法给出。</li></ul><p><strong>5、xSemaphoreTakeFromISR () API 函数</strong></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>BaseType_t  <span class="token function">xSemaphoreTakeFromISR</span><span class="token punctuation">(</span> SemaphoreHandle_t  xSemaphore<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="2"></td><td><pre>                                   BaseType_t         <span class="token operator">*</span>pxHigherPriorityTaskWoken <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>传入参数：</p><ul><li><strong>xSemaphore</strong>：给出的信号量。信号量由定义为  <code>xSemaphoreHandle</code>  类型的变量引用；信号量在使用前必须先创建。</li><li><strong>pxHigherPriorityTaskWoken</strong>：如果获取该信号量导致一个任务解除阻塞，并且被解除阻塞的任务的优先级高于当前运行的任务，那么  <code>xSemaphoreTakeFromISR()</code>  将把  <code>*pxHigherPriorityTaskWoken</code>  设置为  <code>pdTRUE</code>  。如果  <code>xSemaphoreTakeFromISR()</code>  将该值设置为  <code>pdTRUE</code>  ，则应该在退出中断之前请求上下文切换。</li></ul><p>返回参数（有两个可能的返回值）：</p><ul><li><strong>pdTRUE</strong>：  <code>xSemaphoreTakeFromISR()</code>  调用成功。</li><li><strong>pdFALSE</strong>：信号量释放失败。</li></ul><p><strong>6、xSemaphoreGiveFromISR () API 函数</strong></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>BaseType_t  <span class="token function">xSemaphoreGiveFromISR</span><span class="token punctuation">(</span> SemaphoreHandle_t  xSemaphore<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="2"></td><td><pre>                                   BaseType_t         <span class="token operator">*</span>pxHigherPriorityTaskWoken <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>传入参数：</p><ul><li><strong>xSemaphore</strong>：给出的信号量。信号量由定义为  <code>xSemaphoreHandle</code>  类型的变量引用；信号量在使用前必须先创建。</li><li><strong>pxHigherPriorityTaskWoken</strong>：如果调用  <code>xSemaphoreGiveFromISR()</code>  使得一个任务解除阻塞，并且这个任务的优先级高于当前任务（也就是被中断的任务），那么  <code>xSemaphoreGiveFromISR()</code>  会在函数内部将  <code>*pxHigherPriorityTaskWoken</code>  设为  <code>pdTRUE</code>  。如果  <code>xSemaphoreGiveFromISR()</code>  将此值设为  <code>pdTRUE</code>  ，则在中断退出前应当进行一次上下文切换。</li></ul><p>返回参数（有两个可能的返回值）：</p><ul><li><strong>pdTRUE</strong>：  <code>xSemaphoreGiveFromISR()</code>  调用成功。</li><li><strong>errQUEUE_FULL</strong>：信号量已经有效，无法给出。</li></ul><p><strong>7、xSemaphoreCreateBinaryStatic () API 函数</strong></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>SemaphoreHandle_t  <span class="token function">xSemaphoreCreateBinaryStatic</span><span class="token punctuation">(</span> StaticSemaphore_t  <span class="token operator">*</span>pxSemaphoreBuffer <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>该函数是用于在静态的时候，利用该函数创建一个二值信号量的，具体可以去看他的注释，这里就不说了。</p><h1 id="演示例程"><a class="anchor" href="#演示例程">#</a> 演示例程</h1><p>二值信号量多用于 1v1 这种情况，因为它只有两个值（0 / 1），非空则满，有点类似于在非 RTOS 中定义的标志位；由于可以在任务与中断同步，并且存在超时机制，那本次例程就可以把它应用到串口 DMA 接收中。</p><figure class="highlight c"><figcaption data-lang="c"><span>main.c</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/*</pre></td></tr><tr><td data-num="2"></td><td><pre>    FreeRTOS V9.0.0 - Copyright (C) 2016 Real Time Engineers Ltd.</pre></td></tr><tr><td data-num="3"></td><td><pre>    All rights reserved</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    VISIT http://www.FreeRTOS.org TO ENSURE YOU ARE USING THE LATEST VERSION.</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    This file is part of the FreeRTOS distribution.</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    FreeRTOS is free software; you can redistribute it and/or modify it under</pre></td></tr><tr><td data-num="10"></td><td><pre>    the terms of the GNU General Public License (version 2) as published by the</pre></td></tr><tr><td data-num="11"></td><td><pre>    Free Software Foundation >>>> AND MODIFIED BY &lt;&lt;&lt;&lt; the FreeRTOS exception.</pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    ***************************************************************************</pre></td></tr><tr><td data-num="14"></td><td><pre>    >>!   NOTE: The modification to the GPL is included to allow you to     !&lt;&lt;</pre></td></tr><tr><td data-num="15"></td><td><pre>    >>!   distribute a combined work that includes FreeRTOS without being   !&lt;&lt;</pre></td></tr><tr><td data-num="16"></td><td><pre>    >>!   obliged to provide the source code for proprietary components     !&lt;&lt;</pre></td></tr><tr><td data-num="17"></td><td><pre>    >>!   outside of the FreeRTOS kernel.                                   !&lt;&lt;</pre></td></tr><tr><td data-num="18"></td><td><pre>    ***************************************************************************</pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    FreeRTOS is distributed in the hope that it will be useful, but WITHOUT ANY</pre></td></tr><tr><td data-num="21"></td><td><pre>    WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</pre></td></tr><tr><td data-num="22"></td><td><pre>    FOR A PARTICULAR PURPOSE.  Full license text is available on the following</pre></td></tr><tr><td data-num="23"></td><td><pre>    link: http://www.freertos.org/a00114.html</pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>    ***************************************************************************</pre></td></tr><tr><td data-num="26"></td><td><pre>     *                                                                       *</pre></td></tr><tr><td data-num="27"></td><td><pre>     *    FreeRTOS provides completely free yet professionally developed,    *</pre></td></tr><tr><td data-num="28"></td><td><pre>     *    robust, strictly quality controlled, supported, and cross          *</pre></td></tr><tr><td data-num="29"></td><td><pre>     *    platform software that is more than just the market leader, it     *</pre></td></tr><tr><td data-num="30"></td><td><pre>     *    is the industry's de facto standard.                               *</pre></td></tr><tr><td data-num="31"></td><td><pre>     *                                                                       *</pre></td></tr><tr><td data-num="32"></td><td><pre>     *    Help yourself get started quickly while simultaneously helping     *</pre></td></tr><tr><td data-num="33"></td><td><pre>     *    to support the FreeRTOS project by purchasing a FreeRTOS           *</pre></td></tr><tr><td data-num="34"></td><td><pre>     *    tutorial book, reference manual, or both:                          *</pre></td></tr><tr><td data-num="35"></td><td><pre>     *    http://www.FreeRTOS.org/Documentation                              *</pre></td></tr><tr><td data-num="36"></td><td><pre>     *                                                                       *</pre></td></tr><tr><td data-num="37"></td><td><pre>    ***************************************************************************</pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>    http://www.FreeRTOS.org/FAQHelp.html - Having a problem?  Start by reading</pre></td></tr><tr><td data-num="40"></td><td><pre>    the FAQ page "My application does not run, what could be wrong?".  Have you</pre></td></tr><tr><td data-num="41"></td><td><pre>    defined configASSERT()?</pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>    http://www.FreeRTOS.org/support - In return for receiving this top quality</pre></td></tr><tr><td data-num="44"></td><td><pre>    embedded software for free we request you assist our global community by</pre></td></tr><tr><td data-num="45"></td><td><pre>    participating in the support forum.</pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>    http://www.FreeRTOS.org/training - Investing in training allows your team to</pre></td></tr><tr><td data-num="48"></td><td><pre>    be as productive as possible as early as possible.  Now you can receive</pre></td></tr><tr><td data-num="49"></td><td><pre>    FreeRTOS training directly from Richard Barry, CEO of Real Time Engineers</pre></td></tr><tr><td data-num="50"></td><td><pre>    Ltd, and the world's leading authority on the world's leading RTOS.</pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre>    http://www.FreeRTOS.org/plus - A selection of FreeRTOS ecosystem products,</pre></td></tr><tr><td data-num="53"></td><td><pre>    including FreeRTOS+Trace - an indispensable productivity tool, a DOS</pre></td></tr><tr><td data-num="54"></td><td><pre>    compatible FAT file system, and our tiny thread aware UDP/IP stack.</pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre>    http://www.FreeRTOS.org/labs - Where new FreeRTOS products go to incubate.</pre></td></tr><tr><td data-num="57"></td><td><pre>    Come and try FreeRTOS+TCP, our new open source TCP/IP stack for FreeRTOS.</pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre>    http://www.OpenRTOS.com - Real Time Engineers ltd. license FreeRTOS to High</pre></td></tr><tr><td data-num="60"></td><td><pre>    Integrity Systems ltd. to sell under the OpenRTOS brand.  Low cost OpenRTOS</pre></td></tr><tr><td data-num="61"></td><td><pre>    licenses offer ticketed support, indemnification and commercial middleware.</pre></td></tr><tr><td data-num="62"></td><td><pre></pre></td></tr><tr><td data-num="63"></td><td><pre>    http://www.SafeRTOS.com - High Integrity Systems also provide a safety</pre></td></tr><tr><td data-num="64"></td><td><pre>    engineered and independently SIL3 certified version for use in safety and</pre></td></tr><tr><td data-num="65"></td><td><pre>    mission critical applications that require provable dependability.</pre></td></tr><tr><td data-num="66"></td><td><pre></pre></td></tr><tr><td data-num="67"></td><td><pre>    1 tab == 4 spaces!</pre></td></tr><tr><td data-num="68"></td><td><pre>*/</span></pre></td></tr><tr><td data-num="69"></td><td><pre></pre></td></tr><tr><td data-num="70"></td><td><pre></pre></td></tr><tr><td data-num="71"></td><td><pre><span class="token comment">/* Standard includes. */</span></pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="73"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span></pre></td></tr><tr><td data-num="74"></td><td><pre></pre></td></tr><tr><td data-num="75"></td><td><pre><span class="token comment">/* Scheduler includes. */</span></pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"FreeRTOS.h"</span></span></pre></td></tr><tr><td data-num="77"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"task.h"</span></span></pre></td></tr><tr><td data-num="78"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"queue.h"</span></span></pre></td></tr><tr><td data-num="79"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"semphr.h"</span>        <span class="token comment">// 信号量相关的头文件</span></span></pre></td></tr><tr><td data-num="80"></td><td><pre></pre></td></tr><tr><td data-num="81"></td><td><pre><span class="token comment">/* Library includes. */</span></pre></td></tr><tr><td data-num="82"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x_it.h"</span></span></pre></td></tr><tr><td data-num="83"></td><td><pre></pre></td></tr><tr><td data-num="84"></td><td><pre><span class="token comment">/* Private app includes. */</span></pre></td></tr><tr><td data-num="85"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"bsp_uart.h"</span></span></pre></td></tr><tr><td data-num="86"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"bsp_gpio.h"</span></span></pre></td></tr><tr><td data-num="87"></td><td><pre></pre></td></tr><tr><td data-num="88"></td><td><pre></pre></td></tr><tr><td data-num="89"></td><td><pre><span class="token comment">/* Task priorities. */</span></pre></td></tr><tr><td data-num="90"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">mainCREATOR_TASK_PRIORITY</span>           <span class="token expression"><span class="token punctuation">(</span> tskIDLE_PRIORITY <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="91"></td><td><pre></pre></td></tr><tr><td data-num="92"></td><td><pre><span class="token comment">/*----------------------------- End -----------------------------*/</span></pre></td></tr><tr><td data-num="93"></td><td><pre></pre></td></tr><tr><td data-num="94"></td><td><pre><span class="token comment">/*</pre></td></tr><tr><td data-num="95"></td><td><pre> * User Private Task.</pre></td></tr><tr><td data-num="96"></td><td><pre> */</span></pre></td></tr><tr><td data-num="97"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prvUser_Task</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span>pvParameters <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="98"></td><td><pre></pre></td></tr><tr><td data-num="99"></td><td><pre><span class="token comment">/*</pre></td></tr><tr><td data-num="100"></td><td><pre> * Configure the clocks, GPIO and other peripherals as required by the demo.</pre></td></tr><tr><td data-num="101"></td><td><pre> */</span></pre></td></tr><tr><td data-num="102"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prvSetupHardware</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="103"></td><td><pre></pre></td></tr><tr><td data-num="104"></td><td><pre><span class="token comment">/*----------------------------- End -----------------------------*/</span></pre></td></tr><tr><td data-num="105"></td><td><pre></pre></td></tr><tr><td data-num="106"></td><td><pre></pre></td></tr><tr><td data-num="107"></td><td><pre><span class="token comment">/************************************************</pre></td></tr><tr><td data-num="108"></td><td><pre>函数名称 ： main</pre></td></tr><tr><td data-num="109"></td><td><pre>功    能 ： 主函数入口</pre></td></tr><tr><td data-num="110"></td><td><pre>参    数 ： 无</pre></td></tr><tr><td data-num="111"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num="112"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num="113"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="114"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="115"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">DEBUG</span></span></pre></td></tr><tr><td data-num="116"></td><td><pre>  <span class="token function">debug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="117"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="118"></td><td><pre></pre></td></tr><tr><td data-num="119"></td><td><pre><span class="token function">prvSetupHardware</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="120"></td><td><pre></pre></td></tr><tr><td data-num="121"></td><td><pre><span class="token comment">/* Start the tasks defined within this file/specific to this demo. */</span></pre></td></tr><tr><td data-num="122"></td><td><pre><span class="token function">xTaskCreate</span><span class="token punctuation">(</span> prvUser_Task<span class="token punctuation">,</span> <span class="token string">"prvUser_Task"</span><span class="token punctuation">,</span> configMINIMAL_STACK_SIZE<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> mainCREATOR_TASK_PRIORITY<span class="token punctuation">,</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="123"></td><td><pre></pre></td></tr><tr><td data-num="124"></td><td><pre><span class="token comment">/* Start the scheduler. */</span></pre></td></tr><tr><td data-num="125"></td><td><pre><span class="token function">vTaskStartScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="126"></td><td><pre></pre></td></tr><tr><td data-num="127"></td><td><pre><span class="token comment">/* Will only get here if there was not enough heap space to create the</pre></td></tr><tr><td data-num="128"></td><td><pre>idle task. */</span></pre></td></tr><tr><td data-num="129"></td><td><pre><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="130"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="131"></td><td><pre><span class="token comment">/*----------------------------- End -----------------------------*/</span></pre></td></tr><tr><td data-num="132"></td><td><pre></pre></td></tr><tr><td data-num="133"></td><td><pre><span class="token comment">/************************************************</pre></td></tr><tr><td data-num="134"></td><td><pre>函数名称 ： prvSetupHardware</pre></td></tr><tr><td data-num="135"></td><td><pre>功    能 ： 为了方便管理，所有的用户任务都放在该函数里面</pre></td></tr><tr><td data-num="136"></td><td><pre>参    数 ： 无</pre></td></tr><tr><td data-num="137"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num="138"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num="139"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prvUser_Task</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span>pvParameters <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="140"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="141"></td><td><pre><span class="token comment">/* User-defined private tasks */</span></pre></td></tr><tr><td data-num="142"></td><td><pre></pre></td></tr><tr><td data-num="143"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">">>>>> delete user task\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="144"></td><td><pre><span class="token function">vTaskDelete</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 删除自己</span></pre></td></tr><tr><td data-num="145"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="146"></td><td><pre></pre></td></tr><tr><td data-num="147"></td><td><pre><span class="token comment">/************************************************</pre></td></tr><tr><td data-num="148"></td><td><pre>函数名称 ： prvSetupHardware</pre></td></tr><tr><td data-num="149"></td><td><pre>功    能 ： 硬件接口初始化配置</pre></td></tr><tr><td data-num="150"></td><td><pre>参    数 ： 无</pre></td></tr><tr><td data-num="151"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num="152"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num="153"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prvSetupHardware</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="154"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="155"></td><td><pre><span class="token comment">/* Start with the clocks in their expected state. */</span></pre></td></tr><tr><td data-num="156"></td><td><pre><span class="token function">RCC_DeInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="157"></td><td><pre></pre></td></tr><tr><td data-num="158"></td><td><pre><span class="token comment">/* Enable HSE (high speed external clock). */</span></pre></td></tr><tr><td data-num="159"></td><td><pre><span class="token function">RCC_HSEConfig</span><span class="token punctuation">(</span> RCC_HSE_ON <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="160"></td><td><pre></pre></td></tr><tr><td data-num="161"></td><td><pre><span class="token comment">/* Wait till HSE is ready. */</span></pre></td></tr><tr><td data-num="162"></td><td><pre><span class="token keyword">while</span><span class="token punctuation">(</span> <span class="token function">RCC_GetFlagStatus</span><span class="token punctuation">(</span> RCC_FLAG_HSERDY <span class="token punctuation">)</span> <span class="token operator">==</span> RESET <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="163"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="164"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="165"></td><td><pre></pre></td></tr><tr><td data-num="166"></td><td><pre><span class="token comment">/* 2 wait states required on the flash. */</span></pre></td></tr><tr><td data-num="167"></td><td><pre><span class="token operator">*</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token number">0x40022000</span> <span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0x02</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="168"></td><td><pre></pre></td></tr><tr><td data-num="169"></td><td><pre><span class="token comment">/* HCLK = SYSCLK */</span></pre></td></tr><tr><td data-num="170"></td><td><pre><span class="token function">RCC_HCLKConfig</span><span class="token punctuation">(</span> RCC_SYSCLK_Div1 <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="171"></td><td><pre></pre></td></tr><tr><td data-num="172"></td><td><pre><span class="token comment">/* PCLK2 = HCLK */</span></pre></td></tr><tr><td data-num="173"></td><td><pre><span class="token function">RCC_PCLK2Config</span><span class="token punctuation">(</span> RCC_HCLK_Div1 <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="174"></td><td><pre></pre></td></tr><tr><td data-num="175"></td><td><pre><span class="token comment">/* PCLK1 = HCLK/2 */</span></pre></td></tr><tr><td data-num="176"></td><td><pre><span class="token function">RCC_PCLK1Config</span><span class="token punctuation">(</span> RCC_HCLK_Div2 <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="177"></td><td><pre></pre></td></tr><tr><td data-num="178"></td><td><pre><span class="token comment">/* PLLCLK = 8MHz * 9 = 72 MHz. */</span></pre></td></tr><tr><td data-num="179"></td><td><pre><span class="token function">RCC_PLLConfig</span><span class="token punctuation">(</span> RCC_PLLSource_HSE_Div1<span class="token punctuation">,</span> RCC_PLLMul_9 <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="180"></td><td><pre></pre></td></tr><tr><td data-num="181"></td><td><pre><span class="token comment">/* Enable PLL. */</span></pre></td></tr><tr><td data-num="182"></td><td><pre><span class="token function">RCC_PLLCmd</span><span class="token punctuation">(</span> ENABLE <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="183"></td><td><pre></pre></td></tr><tr><td data-num="184"></td><td><pre><span class="token comment">/* Wait till PLL is ready. */</span></pre></td></tr><tr><td data-num="185"></td><td><pre><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">RCC_GetFlagStatus</span><span class="token punctuation">(</span>RCC_FLAG_PLLRDY<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="186"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="187"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="188"></td><td><pre></pre></td></tr><tr><td data-num="189"></td><td><pre><span class="token comment">/* Select PLL as system clock source. */</span></pre></td></tr><tr><td data-num="190"></td><td><pre><span class="token function">RCC_SYSCLKConfig</span><span class="token punctuation">(</span> RCC_SYSCLKSource_PLLCLK <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="191"></td><td><pre></pre></td></tr><tr><td data-num="192"></td><td><pre><span class="token comment">/* Wait till PLL is used as system clock source. */</span></pre></td></tr><tr><td data-num="193"></td><td><pre><span class="token keyword">while</span><span class="token punctuation">(</span> <span class="token function">RCC_GetSYSCLKSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0x08</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="194"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="195"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="196"></td><td><pre></pre></td></tr><tr><td data-num="197"></td><td><pre><span class="token comment">/* Configure HCLK clock as SysTick clock source. */</span></pre></td></tr><tr><td data-num="198"></td><td><pre><span class="token function">SysTick_CLKSourceConfig</span><span class="token punctuation">(</span> SysTick_CLKSource_HCLK <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="199"></td><td><pre></pre></td></tr><tr><td data-num="200"></td><td><pre><span class="token comment">/*</pre></td></tr><tr><td data-num="201"></td><td><pre> * STM32 中断优先级分组为 4，即 4bit 都用来表示抢占优先级，范围为：0~15</pre></td></tr><tr><td data-num="202"></td><td><pre> * 优先级分组只需要分组一次即可，以后如果有其他的任务需要用到中断，</pre></td></tr><tr><td data-num="203"></td><td><pre> * 都统一用这个优先级分组，千万不要再分组，切忌。</pre></td></tr><tr><td data-num="204"></td><td><pre> */</span></pre></td></tr><tr><td data-num="205"></td><td><pre><span class="token function">NVIC_PriorityGroupConfig</span><span class="token punctuation">(</span> NVIC_PriorityGroup_4 <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="206"></td><td><pre></pre></td></tr><tr><td data-num="207"></td><td><pre><span class="token comment">/* Other peripheral configuration */</span></pre></td></tr><tr><td data-num="208"></td><td><pre><span class="token comment">//vSetupTimer();</span></pre></td></tr><tr><td data-num="209"></td><td><pre><span class="token function">vSetupUSART</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="210"></td><td><pre><span class="token function">vSetupParPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="211"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="212"></td><td><pre><span class="token comment">/*----------------------------- End -----------------------------*/</span></pre></td></tr></table></figure><p>主程序没什么好解释的，初始化硬件的配置，建立所需的任务；真正实现的任务在下面的源文件中，主要是方便分类，规范一点便于管理。</p><figure class="highlight c"><figcaption data-lang="c"><span>bsp_uart.c</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"bsp_uart.h"</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">/* Scheduler includes. */</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"FreeRTOS.h"</span></span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"task.h"</span></span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"queue.h"</span></span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"semphr.h"</span></span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BAUDRATE_1</span><span class="token expression"><span class="token number">115200</span><span class="token punctuation">;</span></span><span class="token comment">// 波特率设置支持的波特率：115200,19200,9600,38400,57600,1200,2400,4800</span></span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BAUDRATE_2</span><span class="token expression"><span class="token number">115200</span><span class="token punctuation">;</span></span><span class="token comment">// 波特率设置支持的波特率：115200,19200,9600,38400,57600,1200,2400,4800</span></span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>UartRx_Buff_TypeDef Usart1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>QueueHandle_t xQueueUartTx<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>QueueHandle_t xQueueUart1_Rx<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>SemaphoreHandle_t xBinarySemaphore <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>      <span class="token comment">// 定义一个二值信号量</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Uart_DMA_RxConfig</span><span class="token punctuation">(</span> DMA_Channel_TypeDef<span class="token operator">*</span>DMA_CHx<span class="token punctuation">,</span><span class="token class-name">uint32_t</span> PeripheralBaseAddr<span class="token punctuation">,</span><span class="token class-name">uint32_t</span> MemoryBaseAddr<span class="token punctuation">,</span><span class="token class-name">uint16_t</span> Bufsize<span class="token punctuation">,</span><span class="token class-name">uint32_t</span> Priority<span class="token punctuation">,</span><span class="token class-name">uint32_t</span> Mode <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prvUart1_Rx_Task</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span>pvParameters <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token function">xSemaphoreTake</span><span class="token punctuation">(</span>xBinarySemaphore<span class="token punctuation">,</span> portMAX_DELAY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 无超时阻塞，等待成功获取信号量；此处也没有必要检测返回值</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span>Usart1<span class="token punctuation">.</span>RxCounter <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"len=%d 收到数据:%s\n"</span><span class="token punctuation">,</span>Usart1<span class="token punctuation">.</span>RxCounter<span class="token punctuation">,</span>Usart1<span class="token punctuation">.</span>RxBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token function">memset</span><span class="token punctuation">(</span>Usart1<span class="token punctuation">.</span>RxBuffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> RxBUFFER_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token comment">/************************************************</pre></td></tr><tr><td data-num="40"></td><td><pre>函数名称 ： vSetupUSART</pre></td></tr><tr><td data-num="41"></td><td><pre>功    能 ： UART 初始化接口</pre></td></tr><tr><td data-num="42"></td><td><pre>参    数 ： 无</pre></td></tr><tr><td data-num="43"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num="44"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token keyword">void</span> <span class="token function">vSetupUSART</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token function">UART1_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token comment">//UART2_Config();</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token comment">//vSemaphoreCreateBinary(xBinarySemaphore);            </span></pre></td></tr><tr><td data-num="51"></td><td><pre>xBinarySemaphore <span class="token operator">=</span> <span class="token function">xSemaphoreCreateBinary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 创建二值信号量</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token function">memset</span><span class="token punctuation">(</span>Usart1<span class="token punctuation">.</span>RxBuffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> RxBUFFER_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token function">xTaskCreate</span><span class="token punctuation">(</span> prvUart1_Rx_Task<span class="token punctuation">,</span> <span class="token string">"prvUart1_Rx_Task"</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> tskIDLE_PRIORITY <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token comment">/************************************************</pre></td></tr><tr><td data-num="58"></td><td><pre>函数名称 ： UART1_Config</pre></td></tr><tr><td data-num="59"></td><td><pre>功    能 ： UART1 端口配置</pre></td></tr><tr><td data-num="60"></td><td><pre>参    数 ： 无</pre></td></tr><tr><td data-num="61"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num="62"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token keyword">void</span> <span class="token function">UART1_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="64"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    NVIC_InitTypeDef NVIC_InitStructure<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    USART_InitTypeDef USART_InitStructure<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token comment">/* config GPIOA clock */</span></pre></td></tr><tr><td data-num="70"></td><td><pre><span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB2Periph_GPIOA<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre></pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token comment">/* config USART1 clock */</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB2Periph_USART1<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token comment">/* USART1 GPIO config */</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token comment">/* Configure USART1 Tx (PA.09) as alternate function push-pull */</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_9<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_AF_PP<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre></pre></td></tr><tr><td data-num="82"></td><td><pre>    <span class="token comment">/* Configure USART1 Rx (PA.10) as input floating */</span></pre></td></tr><tr><td data-num="83"></td><td><pre>    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_10<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_IN_FLOATING<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre></pre></td></tr><tr><td data-num="87"></td><td><pre>    <span class="token comment">/* Enable the USART1 Interrupt */</span></pre></td></tr><tr><td data-num="88"></td><td><pre>    NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannel <span class="token operator">=</span> USART1_IRQn<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelPreemptionPriority <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>    NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelSubPriority <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>    NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelCmd <span class="token operator">=</span> ENABLE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>    <span class="token function">NVIC_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>NVIC_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="93"></td><td><pre></pre></td></tr><tr><td data-num="94"></td><td><pre>    <span class="token comment">/* USART1 mode config */</span></pre></td></tr><tr><td data-num="95"></td><td><pre>    USART_InitStructure<span class="token punctuation">.</span>USART_BaudRate <span class="token operator">=</span> BAUDRATE_1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>    USART_InitStructure<span class="token punctuation">.</span>USART_WordLength <span class="token operator">=</span> USART_WordLength_8b<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>    USART_InitStructure<span class="token punctuation">.</span>USART_StopBits <span class="token operator">=</span> USART_StopBits_1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>    USART_InitStructure<span class="token punctuation">.</span>USART_Parity <span class="token operator">=</span> USART_Parity_No <span class="token punctuation">;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>    USART_InitStructure<span class="token punctuation">.</span>USART_HardwareFlowControl <span class="token operator">=</span> USART_HardwareFlowControl_None<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>    USART_InitStructure<span class="token punctuation">.</span>USART_Mode <span class="token operator">=</span> USART_Mode_Rx <span class="token operator">|</span> USART_Mode_Tx<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>    <span class="token function">USART_Init</span><span class="token punctuation">(</span>EVAL_COM1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>USART_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="102"></td><td><pre></pre></td></tr><tr><td data-num="103"></td><td><pre><span class="token comment">/* DMA config */</span></pre></td></tr><tr><td data-num="104"></td><td><pre><span class="token function">Uart_DMA_RxConfig</span><span class="token punctuation">(</span>USART1_RX_DMA_CHANNEL<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="105"></td><td><pre><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>USART1<span class="token operator">-></span>DR<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="106"></td><td><pre><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>Usart1<span class="token punctuation">.</span>RxBuffer<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="107"></td><td><pre>RxBUFFER_SIZE<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="108"></td><td><pre>DMA_Priority_Medium<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="109"></td><td><pre>DMA_Mode_Circular<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="110"></td><td><pre></pre></td></tr><tr><td data-num="111"></td><td><pre><span class="token function">USART_ITConfig</span><span class="token punctuation">(</span>EVAL_COM1<span class="token punctuation">,</span> USART_IT_IDLE<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// 这里使能的是空闲中断</span></pre></td></tr><tr><td data-num="112"></td><td><pre><span class="token function">USART_DMACmd</span><span class="token punctuation">(</span>EVAL_COM1<span class="token punctuation">,</span> USART_DMAReq_Rx<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="113"></td><td><pre>    <span class="token function">USART_Cmd</span><span class="token punctuation">(</span>EVAL_COM1<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="114"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="115"></td><td><pre></pre></td></tr><tr><td data-num="116"></td><td><pre><span class="token comment">/************************************************</pre></td></tr><tr><td data-num="117"></td><td><pre>函数名称 ： Uart_DMA_RxConfig</pre></td></tr><tr><td data-num="118"></td><td><pre>功    能 ： 串口 DMA 接收配置（限串口 1/2/3）</pre></td></tr><tr><td data-num="119"></td><td><pre>参    数 ： DMA_CHx ---- </pre></td></tr><tr><td data-num="120"></td><td><pre>PeripheralBaseAddr ---- Specifies the peripheral base address for DMAy Channelx</pre></td></tr><tr><td data-num="121"></td><td><pre>MemoryBaseAddr ---- Specifies the memory base address for DMAy Channelx</pre></td></tr><tr><td data-num="122"></td><td><pre>Bufsize ---- Specifies the buffer size, in data unit, of the specified Channel</pre></td></tr><tr><td data-num="123"></td><td><pre>Priority ---- @ref DMA_priority_level</pre></td></tr><tr><td data-num="124"></td><td><pre>Mode ---- @ref DMA_circular_normal_mode</pre></td></tr><tr><td data-num="125"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num="126"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num="127"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Uart_DMA_RxConfig</span><span class="token punctuation">(</span> DMA_Channel_TypeDef<span class="token operator">*</span> DMA_CHx<span class="token punctuation">,</span>\</pre></td></tr><tr><td data-num="128"></td><td><pre> <span class="token class-name">uint32_t</span> PeripheralBaseAddr<span class="token punctuation">,</span>\</pre></td></tr><tr><td data-num="129"></td><td><pre> <span class="token class-name">uint32_t</span> MemoryBaseAddr<span class="token punctuation">,</span>\</pre></td></tr><tr><td data-num="130"></td><td><pre> <span class="token class-name">uint16_t</span> Bufsize<span class="token punctuation">,</span>\</pre></td></tr><tr><td data-num="131"></td><td><pre> <span class="token class-name">uint32_t</span> Priority<span class="token punctuation">,</span>\</pre></td></tr><tr><td data-num="132"></td><td><pre> <span class="token class-name">uint32_t</span> Mode <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="133"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="134"></td><td><pre>DMA_InitTypeDef DMA_InitStructure<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="135"></td><td><pre></pre></td></tr><tr><td data-num="136"></td><td><pre><span class="token comment">/* USARTx RX DMA1 Channel (triggered by USARTx Rx event) Config */</span></pre></td></tr><tr><td data-num="137"></td><td><pre> <span class="token function">RCC_AHBPeriphClockCmd</span><span class="token punctuation">(</span>RCC_AHBPeriph_DMA1<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="138"></td><td><pre></pre></td></tr><tr><td data-num="139"></td><td><pre>    <span class="token function">DMA_DeInit</span><span class="token punctuation">(</span>DMA_CHx<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="140"></td><td><pre>   DMA_InitStructure<span class="token punctuation">.</span>DMA_PeripheralBaseAddr <span class="token operator">=</span> PeripheralBaseAddr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="141"></td><td><pre>DMA_InitStructure<span class="token punctuation">.</span>DMA_MemoryBaseAddr <span class="token operator">=</span> MemoryBaseAddr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="142"></td><td><pre>DMA_InitStructure<span class="token punctuation">.</span>DMA_DIR <span class="token operator">=</span> DMA_DIR_PeripheralSRC<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="143"></td><td><pre>DMA_InitStructure<span class="token punctuation">.</span>DMA_BufferSize <span class="token operator">=</span> Bufsize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="144"></td><td><pre>DMA_InitStructure<span class="token punctuation">.</span>DMA_PeripheralInc <span class="token operator">=</span> DMA_PeripheralInc_Disable<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="145"></td><td><pre>DMA_InitStructure<span class="token punctuation">.</span>DMA_MemoryInc <span class="token operator">=</span> DMA_MemoryInc_Enable<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="146"></td><td><pre>DMA_InitStructure<span class="token punctuation">.</span>DMA_PeripheralDataSize <span class="token operator">=</span> DMA_PeripheralDataSize_Byte<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="147"></td><td><pre>DMA_InitStructure<span class="token punctuation">.</span>DMA_MemoryDataSize <span class="token operator">=</span> DMA_MemoryDataSize_Byte<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="148"></td><td><pre>DMA_InitStructure<span class="token punctuation">.</span>DMA_Mode <span class="token operator">=</span> Mode<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="149"></td><td><pre>DMA_InitStructure<span class="token punctuation">.</span>DMA_Priority <span class="token operator">=</span> Priority<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="150"></td><td><pre>DMA_InitStructure<span class="token punctuation">.</span>DMA_M2M <span class="token operator">=</span> DMA_M2M_Disable<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="151"></td><td><pre><span class="token function">DMA_Init</span><span class="token punctuation">(</span>DMA_CHx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>DMA_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="152"></td><td><pre></pre></td></tr><tr><td data-num="153"></td><td><pre><span class="token function">DMA_ClearFlag</span><span class="token punctuation">(</span>DMA1_FLAG_GL3 <span class="token operator">|</span> DMA1_FLAG_GL5 <span class="token operator">|</span> DMA1_FLAG_GL6<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="154"></td><td><pre><span class="token function">DMA_ITConfig</span><span class="token punctuation">(</span>DMA_CHx<span class="token punctuation">,</span> DMA_IT_TE<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="155"></td><td><pre><span class="token function">DMA_Cmd</span> <span class="token punctuation">(</span>DMA_CHx<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="156"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="157"></td><td><pre></pre></td></tr><tr><td data-num="158"></td><td><pre><span class="token comment">/************************************************</pre></td></tr><tr><td data-num="159"></td><td><pre>函数名称 ： USART_SendByte</pre></td></tr><tr><td data-num="160"></td><td><pre>功    能 ： 串口字符发送</pre></td></tr><tr><td data-num="161"></td><td><pre>参    数 ： c ---- 发送的数据</pre></td></tr><tr><td data-num="162"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num="163"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num="164"></td><td><pre><span class="token keyword">void</span> <span class="token function">USART_SendByte</span><span class="token punctuation">(</span> USART_TypeDef<span class="token operator">*</span> USARTx<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> c <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="165"></td><td><pre><span class="token punctuation">&#123;</span>     </pre></td></tr><tr><td data-num="166"></td><td><pre><span class="token function">USART_SendData</span><span class="token punctuation">(</span>USARTx<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="167"></td><td><pre></pre></td></tr><tr><td data-num="168"></td><td><pre><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">USART_GetFlagStatus</span><span class="token punctuation">(</span>USARTx<span class="token punctuation">,</span> USART_FLAG_TXE<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="169"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="170"></td><td><pre></pre></td></tr><tr><td data-num="171"></td><td><pre><span class="token comment">/************************************************</pre></td></tr><tr><td data-num="172"></td><td><pre>函数名称 ： USART_SendString</pre></td></tr><tr><td data-num="173"></td><td><pre>功    能 ： 串口字符串发送</pre></td></tr><tr><td data-num="174"></td><td><pre>参    数 ： USARTx ---- 串口</pre></td></tr><tr><td data-num="175"></td><td><pre>pData ---- 字符串</pre></td></tr><tr><td data-num="176"></td><td><pre>Length ---- 长度</pre></td></tr><tr><td data-num="177"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num="178"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num="179"></td><td><pre><span class="token keyword">void</span> <span class="token function">USART_SendString</span><span class="token punctuation">(</span> USART_TypeDef<span class="token operator">*</span> USARTx<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>pData<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> Length <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="180"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="181"></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span>Length<span class="token operator">--</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="182"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="183"></td><td><pre>        <span class="token function">USART_SendByte</span><span class="token punctuation">(</span>USARTx<span class="token punctuation">,</span> <span class="token operator">*</span>pData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="184"></td><td><pre>        pData<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="185"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="186"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="187"></td><td><pre></pre></td></tr><tr><td data-num="188"></td><td><pre><span class="token comment">/************************************************</pre></td></tr><tr><td data-num="189"></td><td><pre>函数名称 ： USART_Printf</pre></td></tr><tr><td data-num="190"></td><td><pre>功    能 ： 串口打印输出</pre></td></tr><tr><td data-num="191"></td><td><pre>参    数 ： USARTx ---- 串口</pre></td></tr><tr><td data-num="192"></td><td><pre>String---- 字符串</pre></td></tr><tr><td data-num="193"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num="194"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num="195"></td><td><pre><span class="token keyword">void</span> <span class="token function">USART_Printf</span><span class="token punctuation">(</span> USART_TypeDef<span class="token operator">*</span> USARTx<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>String <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="196"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="197"></td><td><pre>    <span class="token keyword">do</span></pre></td></tr><tr><td data-num="198"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="199"></td><td><pre>        <span class="token function">USART_SendByte</span><span class="token punctuation">(</span>USARTx<span class="token punctuation">,</span> <span class="token operator">*</span>String<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="200"></td><td><pre>        String<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="201"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>String<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token char">'\0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="202"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="203"></td><td><pre></pre></td></tr><tr><td data-num="204"></td><td><pre></pre></td></tr><tr><td data-num="205"></td><td><pre><span class="token comment">/************************************************</pre></td></tr><tr><td data-num="206"></td><td><pre>函数名称 ： fputc</pre></td></tr><tr><td data-num="207"></td><td><pre>功    能 ： 重定向 c 库函数 printf 到 DEBUG_UART</pre></td></tr><tr><td data-num="208"></td><td><pre>参    数 ： ch</pre></td></tr><tr><td data-num="209"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num="210"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num="211"></td><td><pre><span class="token keyword">int</span> <span class="token function">fputc</span><span class="token punctuation">(</span><span class="token keyword">int</span> ch<span class="token punctuation">,</span> FILE <span class="token operator">*</span>f<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="212"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="213"></td><td><pre>    <span class="token comment">/* 发送一个字节数据到 DEBUG_UART */</span></pre></td></tr><tr><td data-num="214"></td><td><pre>    <span class="token function">USART_SendData</span><span class="token punctuation">(</span>DEBUG_UART<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span> ch<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="215"></td><td><pre></pre></td></tr><tr><td data-num="216"></td><td><pre>    <span class="token comment">/* 等待发送完毕 */</span></pre></td></tr><tr><td data-num="217"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">USART_GetFlagStatus</span><span class="token punctuation">(</span>DEBUG_UART<span class="token punctuation">,</span> USART_FLAG_TXE<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="218"></td><td><pre></pre></td></tr><tr><td data-num="219"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="220"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="221"></td><td><pre></pre></td></tr><tr><td data-num="222"></td><td><pre><span class="token comment">/************************************************</pre></td></tr><tr><td data-num="223"></td><td><pre>函数名称 ： fgetc</pre></td></tr><tr><td data-num="224"></td><td><pre>功    能 ： 重定向 c 库函数 scanf 到 DEBUG_UART</pre></td></tr><tr><td data-num="225"></td><td><pre>参    数 ： f ---- 文件</pre></td></tr><tr><td data-num="226"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num="227"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num="228"></td><td><pre><span class="token keyword">int</span> <span class="token function">fgetc</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>f<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="229"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="230"></td><td><pre>    <span class="token comment">/* 等待 DEBUG_UART 输入数据 */</span></pre></td></tr><tr><td data-num="231"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">USART_GetFlagStatus</span><span class="token punctuation">(</span>DEBUG_UART<span class="token punctuation">,</span> USART_FLAG_RXNE<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="232"></td><td><pre></pre></td></tr><tr><td data-num="233"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">USART_ReceiveData</span><span class="token punctuation">(</span>DEBUG_UART<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="234"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="235"></td><td><pre></pre></td></tr><tr><td data-num="236"></td><td><pre></pre></td></tr><tr><td data-num="237"></td><td><pre><span class="token comment">/************************************************************************/</span></pre></td></tr><tr><td data-num="238"></td><td><pre><span class="token comment">/*            STM32F10x USART Interrupt Handlers                        */</span></pre></td></tr><tr><td data-num="239"></td><td><pre><span class="token comment">/************************************************************************/</span></pre></td></tr><tr><td data-num="240"></td><td><pre></pre></td></tr><tr><td data-num="241"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="242"></td><td><pre>  * @brief  This function handles USART1 global interrupt request.</pre></td></tr><tr><td data-num="243"></td><td><pre>  * @param  None</pre></td></tr><tr><td data-num="244"></td><td><pre>  * @retval None</pre></td></tr><tr><td data-num="245"></td><td><pre>  */</span></pre></td></tr><tr><td data-num="246"></td><td><pre><span class="token keyword">void</span> <span class="token function">USART1_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="247"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="248"></td><td><pre>BaseType_t xHigherPriorityTaskWoken <span class="token operator">=</span> pdFALSE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="249"></td><td><pre></pre></td></tr><tr><td data-num="250"></td><td><pre></pre></td></tr><tr><td data-num="251"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">USART_GetITStatus</span><span class="token punctuation">(</span>EVAL_COM1<span class="token punctuation">,</span> USART_IT_IDLE<span class="token punctuation">)</span><span class="token operator">!=</span>RESET<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="252"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="253"></td><td><pre><span class="token function">DMA_Cmd</span><span class="token punctuation">(</span>USART1_RX_DMA_CHANNEL<span class="token punctuation">,</span> DISABLE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="254"></td><td><pre><span class="token function">DMA_ClearFlag</span><span class="token punctuation">(</span>DMA1_FLAG_TC5<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="255"></td><td><pre>Usart1<span class="token punctuation">.</span>RxCounter <span class="token operator">=</span> RxBUFFER_SIZE <span class="token operator">-</span> <span class="token function">DMA_GetCurrDataCounter</span><span class="token punctuation">(</span>USART1_RX_DMA_CHANNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 获取接收长度</span></pre></td></tr><tr><td data-num="256"></td><td><pre>USART1_RX_DMA_CHANNEL<span class="token operator">-></span>CNDTR <span class="token operator">=</span> RxBUFFER_SIZE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="257"></td><td><pre><span class="token function">DMA_Cmd</span><span class="token punctuation">(</span>USART1_RX_DMA_CHANNEL<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="258"></td><td><pre></pre></td></tr><tr><td data-num="259"></td><td><pre><span class="token function">xSemaphoreGiveFromISR</span><span class="token punctuation">(</span>xBinarySemaphore<span class="token punctuation">,</span> <span class="token operator">&amp;</span>xHigherPriorityTaskWoken<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 'Give' the semaphore to unblock the task</span></pre></td></tr><tr><td data-num="260"></td><td><pre><span class="token function">portEND_SWITCHING_ISR</span><span class="token punctuation">(</span>xHigherPriorityTaskWoken<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 上下切换</span></pre></td></tr><tr><td data-num="261"></td><td><pre><span class="token function">USART_ReceiveData</span><span class="token punctuation">(</span>EVAL_COM1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Clear IDLE interrupt flag bit</span></pre></td></tr><tr><td data-num="262"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="263"></td><td><pre></pre></td></tr><tr><td data-num="264"></td><td><pre></pre></td></tr><tr><td data-num="265"></td><td><pre><span class="token comment">//  if(USART_GetITStatus(EVAL_COM1, USART_IT_TXE) != RESET)</span></pre></td></tr><tr><td data-num="266"></td><td><pre><span class="token comment">//  &#123;</span></pre></td></tr><tr><td data-num="267"></td><td><pre><span class="token comment">//    /* Write one byte to the transmit data register */</span></pre></td></tr><tr><td data-num="268"></td><td><pre><span class="token comment">//    USART_SendData(EVAL_COM1, TxBuffer[TxCounter++]);</span></pre></td></tr><tr><td data-num="269"></td><td><pre></pre></td></tr><tr><td data-num="270"></td><td><pre><span class="token comment">//    if(TxCounter == RxBUFFER_SIZE)</span></pre></td></tr><tr><td data-num="271"></td><td><pre><span class="token comment">//    &#123;</span></pre></td></tr><tr><td data-num="272"></td><td><pre><span class="token comment">//      /* Disable the EVAL_COM1 Transmit interrupt */</span></pre></td></tr><tr><td data-num="273"></td><td><pre><span class="token comment">//      USART_ITConfig(EVAL_COM1, USART_IT_TXE, DISABLE);</span></pre></td></tr><tr><td data-num="274"></td><td><pre><span class="token comment">//    &#125;</span></pre></td></tr><tr><td data-num="275"></td><td><pre><span class="token comment">//  &#125;</span></pre></td></tr><tr><td data-num="276"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="277"></td><td><pre></pre></td></tr><tr><td data-num="278"></td><td><pre></pre></td></tr><tr><td data-num="279"></td><td><pre><span class="token comment">/*---------------------------- END OF FILE ----------------------------*/</span></pre></td></tr></table></figure><p>这里跟往常中的配置不一样，是使用了 DMA + IDLE 来进行串口接收处理，因为 DMA 并不占用 CPU，DMA 只需在传输完成的时候产生一个中断，告诉 CPU 我已经完成了，然后 CPU 知道了就去处理数据，这样子提高了 CPU 的利用率，可以更好的让出硬件资源；若是像在 <span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQyOTkyMDg0L2FydGljbGUvZGV0YWlscy8xMDQwOTg1MzE=">STM32 笔记之 USART（串口）</span> 中那样直接用接收中断来接收，那样的话，每接收一个数据就要进入中断，这样频繁的进出中断，打断程序的执行，只会让跑起来的程序变得不那么实时性；而且，既然 ST 有这个 DMA 资源可以使用，并且是不占 CPU 的，那我们没必要不使用啊，使用操作系统，无非就是为了提高实时性，榨干 CPU 的资源，又怎会让这串口接收而使得效率降低呢？</p><p>1、串口 DMA 接收的流程：</p><p>串口 DMA 接收在初始化的时候就处于开启状态，一直等待数据的到来，在软件上无需做任何事情，只要在初始化配置的时候设置好配置就可以了。</p><p>2、数据接收完成后处理：</p><p>这里主要通过串口空闲中断来判断接收完成（主要是为了实现串口 DMA 不定长数据的接收），即当串口数据流停止后，就会产生 IDLE 中断。</p><p>然后我们只需要在中断中做以下操作：</p><ul><li>关闭串口接收 DMA 通道（防止数据未处理又接收到数据；为 DMA 重新赋值）。</li><li>清除 DMA 所有标志位。</li><li>从 DMA 寄存器中获取接收到的数据字节数。</li><li>重新设置 DMA 下次要接收的数据字节数（这里是给 DMA 寄存器重新设置接收的计数值，这个数量只能大于或者等于可能接收的字节数，否则当 DMA 接收计数器递减到 0 的时候，就会重载这个计数值，重新循环递减计数，造成接收缓冲区的数据被覆盖丢失。）注意：对 DMA 的相关寄存器配置写入，必须要在关闭 DMA 的条件进行，否则操作无效。</li><li>开启 DMA 通道，等待下一次的数据接收。</li></ul><p>说明一下，STM32 的 IDLE 的中断在串口无数据接收的情况下，并不会一直产生的，产生的条件是：当清除 IDLE 标志位后，必须有接收到至少一个数据后，才开始触发；当一段时间没有接收到数据，便产生 IDLE 中断。</p><figure class="highlight c"><figcaption data-lang="c"><span>bsp_uart.h</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__BSP_UART_H</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__BSP_UART_H</span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEBUG_UART</span><span class="token expression">USART1</span></span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EVAL_COM1</span><span class="token expression">USART1</span></span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EVAL_COM2</span><span class="token expression">USART2</span></span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">USART1_RX_DMA_CHANNEL</span><span class="token expression">DMA1_Channel5</span></span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">USART2_RX_DMA_CHANNEL</span><span class="token expression">DMA1_Channel6</span></span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TxBUFFER_SIZE</span>   <span class="token expression"><span class="token number">100</span></span></span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RxBUFFER_SIZE</span>   <span class="token expression"><span class="token number">100</span></span></span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">UART_QUEUE_RX_LENGTH</span><span class="token expression"><span class="token number">2</span></span></span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">UART_QUEUE_TX_LENGTH</span><span class="token expression"><span class="token number">2</span></span></span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token class-name">uint8_t</span> Receiving_Time<span class="token punctuation">;</span><span class="token comment">// 接收时间</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token class-name">uint8_t</span> Frame_flag<span class="token punctuation">;</span><span class="token comment">// 一帧完成标志</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">&#125;</span>EVAL_COMx_TypeDef<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token class-name">uint8_t</span> RxBuffer<span class="token punctuation">[</span>RxBUFFER_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 接收暂存缓冲区</span></pre></td></tr><tr><td data-num="31"></td><td><pre>__IO <span class="token class-name">uint8_t</span> RxCounter<span class="token punctuation">;</span><span class="token comment">// 接收数据个数</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">&#125;</span>UartRx_Buff_TypeDef<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token keyword">extern</span> UartRx_Buff_TypeDef Usart1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token class-name">uint8_t</span> TxBuffer<span class="token punctuation">[</span>TxBUFFER_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 发送暂存缓冲区</span></pre></td></tr><tr><td data-num="38"></td><td><pre>__IO <span class="token class-name">uint8_t</span> TxCounter<span class="token punctuation">;</span><span class="token comment">// 发送数据个数</span></pre></td></tr><tr><td data-num="39"></td><td><pre>USART_TypeDef<span class="token operator">*</span> COMx<span class="token punctuation">;</span><span class="token comment">// 串口号</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token punctuation">&#125;</span>UartTx_Buff_TypeDef<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token keyword">void</span> <span class="token function">vSetupUSART</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token keyword">void</span> <span class="token function">UART1_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token keyword">void</span> <span class="token function">UART2_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token keyword">void</span> <span class="token function">USART_SendByte</span><span class="token punctuation">(</span> USART_TypeDef<span class="token operator">*</span> USARTx<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> c <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token keyword">void</span> <span class="token function">USART_SendString</span><span class="token punctuation">(</span> USART_TypeDef<span class="token operator">*</span> USARTx<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>pData<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> Length <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token keyword">void</span> <span class="token function">USART_Printf</span><span class="token punctuation">(</span> USART_TypeDef<span class="token operator">*</span> USARTx<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>String <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span><span class="token comment">/* __BSP_UART_H */</span></span></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token comment">/*---------------------------- END OF FILE ----------------------------*/</span></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> FreeRTOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> history </tag>
            
            <tag> RTOS </tag>
            
            <tag> FreeRTOS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FreeRTOS 篇章之队列管理</title>
      <link href="/docs/RTOS/FreeRTOS%20%E7%AF%87%E7%AB%A0%E4%B9%8B%E9%98%9F%E5%88%97%E7%AE%A1%E7%90%86/"/>
      <url>/docs/RTOS/FreeRTOS%20%E7%AF%87%E7%AB%A0%E4%B9%8B%E9%98%9F%E5%88%97%E7%AE%A1%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h1 id="队列特性"><a class="anchor" href="#队列特性">#</a> 队列特性</h1><p>队列可以保存有限个具有确定长度的数据单元。队列可以保存的最大单元数目被称为队列的 “深度” ；在队列创建时需要设定其深度和每个单元的大小。</p><p>通常情况下，队列被作为 FIFO（先进先出）使用，即数据由队列尾写入，从队列首读出；当然，由队列首写入也是可能的。</p><p>然后我们看一下队列的处理过程：</p><p><img data-src="20200219230912853.gif" alt="img" /></p><h1 id="队列的-api-函数"><a class="anchor" href="#队列的-api-函数">#</a> 队列的 API 函数</h1><p>要想调用以下函数，需要  <code>#include &quot;queue.h&quot;</code></p><p><strong>1、队列创建</strong></p><table><thead><tr><th style="text-align:left">属性</th><th style="text-align:left">API 接口</th><th style="text-align:left">实际执行函数</th></tr></thead><tbody><tr><td style="text-align:left">动态</td><td style="text-align:left">xQueueCreate()</td><td style="text-align:left">xQueueGenericCreate()</td></tr><tr><td style="text-align:left">静态</td><td style="text-align:left">xQueueCreateStatic()</td><td style="text-align:left">xQueueGenericCreateStatic()</td></tr></tbody></table><p><strong>2、队列发送</strong></p><table><thead><tr><th>入队方式</th><th>API 接口</th><th>实际执行函数</th><th style="text-align:left">其他</th></tr></thead><tbody><tr><td>从队列尾部入队</td><td>xQueueSend()</td><td>xQueueGenericSend()</td><td style="text-align:left"></td></tr><tr><td>同上</td><td>xQueueSendToBack()</td><td>同上</td><td style="text-align:left"></td></tr><tr><td>同上</td><td>xQueueOverwrite()</td><td>同上</td><td style="text-align:left">仅用于消息数目为 1 的队列</td></tr><tr><td>从队列首部入队</td><td>xQueueSendToFront()</td><td>同上</td><td style="text-align:left"></td></tr><tr><td></td><td></td><td></td><td style="text-align:left"></td></tr><tr><td>从队列尾部入队 &lt;br/&gt; （用于中断中）</td><td>xQueueSendFromISR()</td><td>xQueueGenericSendFromISR()</td><td style="text-align:left"></td></tr><tr><td>同上</td><td>xQueueSendToBackFromISR()</td><td>同上</td><td style="text-align:left"></td></tr><tr><td>同上</td><td>xQueueOverwriteFromISR()</td><td>同上</td><td style="text-align:left">仅用于消息数目为 1 的队列</td></tr><tr><td>从队列首部入队 &lt;br/&gt; （用于中断中）</td><td>xQueueSendToFrontFromISR()</td><td>同上</td><td style="text-align:left"></td></tr></tbody></table><p><strong>3、队列接收</strong></p><table><thead><tr><th style="text-align:left">出队方式</th><th style="text-align:left">API 接口</th><th style="text-align:left">实际执行函数</th></tr></thead><tbody><tr><td style="text-align:left">出队并删除</td><td style="text-align:left">xQueueReceive()</td><td style="text-align:left">xQueueGenericReceive()</td></tr><tr><td style="text-align:left">出队不删除</td><td style="text-align:left">xQueuePeek()</td><td style="text-align:left">同上</td></tr><tr><td style="text-align:left"></td><td style="text-align:left"></td><td style="text-align:left"></td></tr><tr><td style="text-align:left">出队并删除 &lt;br/&gt; （用于中断中）</td><td style="text-align:left">xQueueReceiveFromISR()</td><td style="text-align:left">xQueueReceiveFromISR()</td></tr><tr><td style="text-align:left">出队不删除 &lt;br/&gt; （用于中断中）</td><td style="text-align:left">xQueuePeekFromISR()</td><td style="text-align:left">xQueuePeekFromISR()</td></tr></tbody></table><p><strong>4、队列复位及删除</strong></p><table><thead><tr><th style="text-align:left">功能</th><th style="text-align:left">API 接口</th><th style="text-align:left">实际执行函数</th></tr></thead><tbody><tr><td style="text-align:left">复位清空内存</td><td style="text-align:left">xQueueReset()</td><td style="text-align:left">xQueueGenericReset()</td></tr><tr><td style="text-align:left">删除释放内存</td><td style="text-align:left">vQueueDelete()</td><td style="text-align:left">vQueueDelete()</td></tr></tbody></table><h1 id="常用队列函数分析"><a class="anchor" href="#常用队列函数分析">#</a> 常用队列函数分析</h1><p><strong>1、xQueueCreate () API 函数</strong></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>QueueHandle_t  <span class="token function">xQueueCreate</span><span class="token punctuation">(</span> UBaseType_t  uxQueueLength<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="2"></td><td><pre>                             UBaseType_t  uxItemSize <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>传入参数：</p><ul><li><strong>uxQueueLength</strong>：队列项长度；即队列能够存储的最大消息数目，也称为队列深度。</li><li><strong>uxItemSize</strong>：信息大小；即队列中每个消息数目的数据大小，以字节为单位。</li></ul><p>返回参数（此返回值应当保存下来，以作为操作此队列的句柄）：</p><ul><li><strong>NULL</strong>：表示没有足够的堆空间分配给队列而导致创建失败。</li><li><strong>非 NULL</strong>：表示队列创建成功。</li></ul><p><strong>2、xQueueSendToBack () 与 xQueueSendToFront () API 函数</strong></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>BaseType_t  <span class="token function">xQueueSendToBack</span><span class="token punctuation">(</span> QueueHandle_t  xQueue<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="2"></td><td><pre>                              <span class="token keyword">const</span> <span class="token keyword">void</span>     <span class="token operator">*</span>pvItemToQueue<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                              TickType_t     xTicksToWait <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>BaseType_t  <span class="token function">xQueueSendToFront</span><span class="token punctuation">(</span> QueueHandle_t  xQueue<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="2"></td><td><pre>                               <span class="token keyword">const</span> <span class="token keyword">void</span>     <span class="token operator">*</span>pvItemToQueue<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                               TickType_t     xTicksToWait <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><code>xQueueSendToFront()</code>  与  <code>xQueueSendToBack()</code>  函数参数及返回值。</p><p>传入参数：</p><ul><li><strong>xQueue</strong>：目标队列的句柄。这个句柄即是调用  <code>xQueueCreate()</code>  创建该队列时的返回值。</li><li><strong>pvItemToQueue</strong>：发送数据的指针。其指向将要复制到目标队列中的数据单元。</li><li><strong>xTicksToWait</strong>：阻塞超时时间。如果在发送时队列已满，这个时间即是任务处于阻塞态等待队列空间有效的最长等待时间；如果  <code>xTicksToWait</code>  设为  <code>0</code>  ， 则  <code>xQueueSendToFront()</code>  与  <code>xQueueSendToBack()</code>  均会立即返回；如果把  <code>xTicksToWait</code>  设置为  <code>portMAX_DELAY</code> ，那么阻塞等待将没有超时限制。</li></ul><p>返回参数（有两个可能的返回值）：</p><ul><li><strong>pdTRUE</strong>：数据被成功发送到队列中。</li><li><strong>errQUEUE_FULL</strong>：由于队列已满而无法将数据写入。</li></ul><p><strong>3、xQueueReceive () 与 xQueuePeek () API 函数</strong></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>BaseType_t  <span class="token function">xQueueReceive</span><span class="token punctuation">(</span> QueueHandle_t  xQueue<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="2"></td><td><pre>                           <span class="token keyword">void</span>           <span class="token operator">*</span>pvBuffer<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                           TickType_t     xTicksToWait <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>BaseType_t  <span class="token function">xQueuePeek</span><span class="token punctuation">(</span> QueueHandle_t  xQueue<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="2"></td><td><pre>                        <span class="token keyword">void</span>           <span class="token operator">*</span>pvBuffer<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                        TickType_t     xTicksToWait <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><code>xQueueReceive()</code>  与  <code>xQueuePeek()</code>  函数参数与返回值。</p><p>传入参数：</p><ul><li><strong>xQueue</strong>：被读队列的句柄。这个句柄即是调用  <code>xQueueCreate()</code>  创建该队列时的返回值</li><li><strong>pvBuffer</strong>：接收缓存指针。其指向一段内存区域，用于接收从队列中拷贝来的数据</li><li><strong>xTicksToWait</strong>：阻塞超时时间。如果在接收时队列为空，则这个时间是任务处于阻塞状态以等待队列数据有效的最长等待时间；如果  <code>xTicksToWait</code>  设为  <code>0</code>  ， 则  <code>xQueueRecieve()</code>  与  <code>xQueuePeek()</code>  均会立即返回；如果把  <code>xTicksToWait</code>  设置为  <code>portMAX_DELAY</code>  ，那么阻塞等待将没有超时限制。</li></ul><p>返回参数（有两个可能的返回值）：</p><ul><li><strong>pdTRUE</strong>：成功地从队列中读到数据。</li><li><strong>pdFALSE</strong>：在读取时由于队列已空而没有读到任何数据。</li></ul><h1 id="大型数据单元处理"><a class="anchor" href="#大型数据单元处理">#</a> 大型数据单元处理</h1><p>如果队列存储的数据单元尺寸较大，那最好是利用队列来传递数据的指针而不是对数据本身在队列上一字节一字节地拷贝进或拷贝出。传递指针无论是在处理速度上还是内存空间利用上都更有效；但是，当你利用队列传递指针时，一定要十分小心地做到以下两点：</p><p><strong>1、指针指向的内存空间的所有权必须明确</strong></p><p>当任务间通过指针共享内存时，应该从根本上保证所不会有任意两个任务同时修改共享内存中的数据，或是以其它行为方式使得共享内存数据无效或产生一致性问题。原则上，共享内存在其指针发送到队列之前，其内容只允许被发送任务访问；共享内存指针从队列中被读出之后，其内容亦只允许被接收任务访问。</p><p><strong>2、指针指向的内存空间必须有效</strong></p><p>如果指针指向的内存空间是动态分配的，只应该有一个任务负责对其进行内存释放。当这段内存空间被释放之后，就不应该有任何一个任务再访问这段空间。</p><p>切忌用指针访问任务栈上分配的空间。因为当栈帧发生改变后，栈上的数据将不再有效。</p><h1 id="例程测试"><a class="anchor" href="#例程测试">#</a> 例程测试</h1><figure class="highlight c"><figcaption data-lang="c"><span>main.c</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* Standard includes. */</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">/* Scheduler includes. */</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"FreeRTOS.h"</span></span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"task.h"</span></span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"queue.h"</span></span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">/* Library includes. */</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x_it.h"</span></span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">/* Private app includes. */</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"bsp_time.h"</span></span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"bsp_uart.h"</span></span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"bsp_gpio.h"</span></span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment">/* Task priorities. */</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">mainCREATOR_TASK_PRIORITY</span>           <span class="token expression"><span class="token punctuation">(</span> tskIDLE_PRIORITY <span class="token operator">+</span> <span class="token number">3</span> <span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment">/*----------------------------- End -----------------------------*/</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment">/*</pre></td></tr><tr><td data-num="25"></td><td><pre> * User Private Task.</pre></td></tr><tr><td data-num="26"></td><td><pre> */</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prvUser_Task</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span>pvParameters <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token comment">/*</pre></td></tr><tr><td data-num="30"></td><td><pre> * Configure the clocks, GPIO and other peripherals as required by the demo.</pre></td></tr><tr><td data-num="31"></td><td><pre> */</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prvSetupHardware</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token comment">/*----------------------------- End -----------------------------*/</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token comment">/************************************************</pre></td></tr><tr><td data-num="38"></td><td><pre>函数名称 ： main</pre></td></tr><tr><td data-num="39"></td><td><pre>功    能 ： 主函数入口</pre></td></tr><tr><td data-num="40"></td><td><pre>参    数 ： 无</pre></td></tr><tr><td data-num="41"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num="42"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">DEBUG</span></span></pre></td></tr><tr><td data-num="46"></td><td><pre>  <span class="token function">debug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token function">prvSetupHardware</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token comment">/* Start the tasks defined within this file/specific to this demo. */</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token function">xTaskCreate</span><span class="token punctuation">(</span> prvUser_Task<span class="token punctuation">,</span> <span class="token string">"prvUser_Task"</span><span class="token punctuation">,</span> configMINIMAL_STACK_SIZE<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> mainCREATOR_TASK_PRIORITY<span class="token punctuation">,</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token comment">/* Start the scheduler. */</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token function">vTaskStartScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token comment">/* Will only get here if there was not enough heap space to create the</pre></td></tr><tr><td data-num="58"></td><td><pre>idle task. */</span></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token comment">/*----------------------------- End -----------------------------*/</span></pre></td></tr><tr><td data-num="62"></td><td><pre></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token keyword">extern</span> QueueHandle_t xQueueUartTx<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre><span class="token keyword">void</span> <span class="token function">vSender1_Task</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span>pvParameters <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>UartTx_Buff_TypeDef uart_data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre></pre></td></tr><tr><td data-num="68"></td><td><pre><span class="token function">strcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>uart_data<span class="token punctuation">.</span>TxBuffer<span class="token punctuation">,</span><span class="token string">"TaskA Running\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre></pre></td></tr><tr><td data-num="70"></td><td><pre>uart_data<span class="token punctuation">.</span>TxCounter <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token string">"TaskA running\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Task A was created successfully....\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>uart_data<span class="token punctuation">.</span>COMx <span class="token operator">=</span> EVAL_COM1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre></pre></td></tr><tr><td data-num="74"></td><td><pre><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="75"></td><td><pre><span class="token comment">/* 延时 800 个 tick */</span></pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token function">vTaskDelay</span><span class="token punctuation">(</span><span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre><span class="token function">xQueueSend</span><span class="token punctuation">(</span>xQueueUartTx<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>uart_data<span class="token punctuation">,</span> portMAX_DELAY<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="79"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="80"></td><td><pre></pre></td></tr><tr><td data-num="81"></td><td><pre><span class="token keyword">void</span> <span class="token function">vSender2_Task</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span>pvParameters <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="82"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>UartTx_Buff_TypeDef uart_data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre></pre></td></tr><tr><td data-num="85"></td><td><pre><span class="token function">strcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>uart_data<span class="token punctuation">.</span>TxBuffer<span class="token punctuation">,</span><span class="token string">"TaskB Running\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre></pre></td></tr><tr><td data-num="87"></td><td><pre>uart_data<span class="token punctuation">.</span>TxCounter <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token string">"TaskB running\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Task B was created successfully....\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>uart_data<span class="token punctuation">.</span>COMx <span class="token operator">=</span> EVAL_COM1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre></pre></td></tr><tr><td data-num="91"></td><td><pre><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="92"></td><td><pre><span class="token comment">/* 延时 800 个 tick */</span></pre></td></tr><tr><td data-num="93"></td><td><pre><span class="token function">vTaskDelay</span><span class="token punctuation">(</span><span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre><span class="token function">xQueueSend</span><span class="token punctuation">(</span>xQueueUartTx<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>uart_data<span class="token punctuation">,</span> portMAX_DELAY<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="96"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="97"></td><td><pre></pre></td></tr><tr><td data-num="98"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prvUser_Task</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span>pvParameters <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="99"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="100"></td><td><pre><span class="token comment">/* User-defined private tasks */</span></pre></td></tr><tr><td data-num="101"></td><td><pre><span class="token function">xTaskCreate</span><span class="token punctuation">(</span> vSender1_Task<span class="token punctuation">,</span> <span class="token string">"vSender1_Task"</span><span class="token punctuation">,</span> configMINIMAL_STACK_SIZE <span class="token operator">+</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> tskIDLE_PRIORITY<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="102"></td><td><pre><span class="token function">xTaskCreate</span><span class="token punctuation">(</span> vSender2_Task<span class="token punctuation">,</span> <span class="token string">"vSender2_Task"</span><span class="token punctuation">,</span> configMINIMAL_STACK_SIZE <span class="token operator">+</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> tskIDLE_PRIORITY<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="103"></td><td><pre></pre></td></tr><tr><td data-num="104"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"delete user task\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="105"></td><td><pre><span class="token function">vTaskDelete</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 删除自己</span></pre></td></tr><tr><td data-num="106"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="107"></td><td><pre></pre></td></tr><tr><td data-num="108"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prvSetupHardware</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="109"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="110"></td><td><pre><span class="token comment">/* Start with the clocks in their expected state. */</span></pre></td></tr><tr><td data-num="111"></td><td><pre><span class="token function">RCC_DeInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="112"></td><td><pre></pre></td></tr><tr><td data-num="113"></td><td><pre><span class="token comment">/* Enable HSE (high speed external clock). */</span></pre></td></tr><tr><td data-num="114"></td><td><pre><span class="token function">RCC_HSEConfig</span><span class="token punctuation">(</span> RCC_HSE_ON <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="115"></td><td><pre></pre></td></tr><tr><td data-num="116"></td><td><pre><span class="token comment">/* Wait till HSE is ready. */</span></pre></td></tr><tr><td data-num="117"></td><td><pre><span class="token keyword">while</span><span class="token punctuation">(</span> <span class="token function">RCC_GetFlagStatus</span><span class="token punctuation">(</span> RCC_FLAG_HSERDY <span class="token punctuation">)</span> <span class="token operator">==</span> RESET <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="118"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="119"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="120"></td><td><pre></pre></td></tr><tr><td data-num="121"></td><td><pre><span class="token comment">/* 2 wait states required on the flash. */</span></pre></td></tr><tr><td data-num="122"></td><td><pre><span class="token operator">*</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token number">0x40022000</span> <span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0x02</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="123"></td><td><pre></pre></td></tr><tr><td data-num="124"></td><td><pre><span class="token comment">/* HCLK = SYSCLK */</span></pre></td></tr><tr><td data-num="125"></td><td><pre><span class="token function">RCC_HCLKConfig</span><span class="token punctuation">(</span> RCC_SYSCLK_Div1 <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="126"></td><td><pre></pre></td></tr><tr><td data-num="127"></td><td><pre><span class="token comment">/* PCLK2 = HCLK */</span></pre></td></tr><tr><td data-num="128"></td><td><pre><span class="token function">RCC_PCLK2Config</span><span class="token punctuation">(</span> RCC_HCLK_Div1 <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="129"></td><td><pre></pre></td></tr><tr><td data-num="130"></td><td><pre><span class="token comment">/* PCLK1 = HCLK/2 */</span></pre></td></tr><tr><td data-num="131"></td><td><pre><span class="token function">RCC_PCLK1Config</span><span class="token punctuation">(</span> RCC_HCLK_Div2 <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="132"></td><td><pre></pre></td></tr><tr><td data-num="133"></td><td><pre><span class="token comment">/* PLLCLK = 8MHz * 9 = 72 MHz. */</span></pre></td></tr><tr><td data-num="134"></td><td><pre><span class="token function">RCC_PLLConfig</span><span class="token punctuation">(</span> RCC_PLLSource_HSE_Div1<span class="token punctuation">,</span> RCC_PLLMul_9 <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="135"></td><td><pre></pre></td></tr><tr><td data-num="136"></td><td><pre><span class="token comment">/* Enable PLL. */</span></pre></td></tr><tr><td data-num="137"></td><td><pre><span class="token function">RCC_PLLCmd</span><span class="token punctuation">(</span> ENABLE <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="138"></td><td><pre></pre></td></tr><tr><td data-num="139"></td><td><pre><span class="token comment">/* Wait till PLL is ready. */</span></pre></td></tr><tr><td data-num="140"></td><td><pre><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">RCC_GetFlagStatus</span><span class="token punctuation">(</span>RCC_FLAG_PLLRDY<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="141"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="142"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="143"></td><td><pre></pre></td></tr><tr><td data-num="144"></td><td><pre><span class="token comment">/* Select PLL as system clock source. */</span></pre></td></tr><tr><td data-num="145"></td><td><pre><span class="token function">RCC_SYSCLKConfig</span><span class="token punctuation">(</span> RCC_SYSCLKSource_PLLCLK <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="146"></td><td><pre></pre></td></tr><tr><td data-num="147"></td><td><pre><span class="token comment">/* Wait till PLL is used as system clock source. */</span></pre></td></tr><tr><td data-num="148"></td><td><pre><span class="token keyword">while</span><span class="token punctuation">(</span> <span class="token function">RCC_GetSYSCLKSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0x08</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="149"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="150"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="151"></td><td><pre></pre></td></tr><tr><td data-num="152"></td><td><pre><span class="token comment">/* Configure HCLK clock as SysTick clock source. */</span></pre></td></tr><tr><td data-num="153"></td><td><pre><span class="token function">SysTick_CLKSourceConfig</span><span class="token punctuation">(</span> SysTick_CLKSource_HCLK <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="154"></td><td><pre></pre></td></tr><tr><td data-num="155"></td><td><pre><span class="token comment">/*</pre></td></tr><tr><td data-num="156"></td><td><pre> * STM32 中断优先级分组为 4，即 4bit 都用来表示抢占优先级，范围为：0~15</pre></td></tr><tr><td data-num="157"></td><td><pre> * 优先级分组只需要分组一次即可，以后如果有其他的任务需要用到中断，</pre></td></tr><tr><td data-num="158"></td><td><pre> * 都统一用这个优先级分组，千万不要再分组，切忌。</pre></td></tr><tr><td data-num="159"></td><td><pre> */</span></pre></td></tr><tr><td data-num="160"></td><td><pre><span class="token function">NVIC_PriorityGroupConfig</span><span class="token punctuation">(</span> NVIC_PriorityGroup_4 <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="161"></td><td><pre></pre></td></tr><tr><td data-num="162"></td><td><pre><span class="token comment">/* Other peripheral configuration */</span></pre></td></tr><tr><td data-num="163"></td><td><pre><span class="token comment">//vSetupTimer();</span></pre></td></tr><tr><td data-num="164"></td><td><pre><span class="token function">vSetupUSART</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="165"></td><td><pre><span class="token function">vSetupParPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="166"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="167"></td><td><pre></pre></td></tr><tr><td data-num="168"></td><td><pre><span class="token comment">/*----------------------------- End -----------------------------*/</span></pre></td></tr></table></figure><p>由总工程上看到，我们主要创建了两个 task 作为队列的发送；为什么要多此一举用队列来传输打印数据，而不直接调用  <code>printf</code>  函数输出呢？在 RTOS 应用中，我们知道每个任务都相当于是独立的，这样就会出现一种情况就是，Task A 在打印输出数据，而刚好 Task B 也要打印数据，那么在同一时间，输出的数据就可能出现叠加或者丢包乱码了；为了试验一下，所以在代码中把 Task A 和 Task B 的运行例子设计成一样，包括优先级；另外添加像我们以前没用 RTOS 一样直接打印数据，看会有什么情况，然后再贴上队列接收的任务：</p><figure class="highlight c"><figcaption data-lang="c"><span>bsp_uart.c</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"bsp_uart.h"</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/* Scheduler includes. */</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"FreeRTOS.h"</span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"task.h"</span></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"queue.h"</span></span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BAUDRATE_1</span><span class="token expression"><span class="token number">115200</span><span class="token punctuation">;</span></span><span class="token comment">// 波特率设置支持的波特率：115200,19200,9600,38400,57600,1200,2400,4800</span></span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BAUDRATE_2</span><span class="token expression"><span class="token number">115200</span><span class="token punctuation">;</span></span><span class="token comment">// 波特率设置支持的波特率：115200,19200,9600,38400,57600,1200,2400,4800</span></span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>QueueHandle_t xQueueUartTx<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prvUartTx_Task</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span>pvParameters <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>UartTx_Buff_TypeDef uart_data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">xQueueReceive</span><span class="token punctuation">(</span>xQueueUartTx<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>uart_data<span class="token punctuation">,</span> portMAX_DELAY<span class="token punctuation">)</span> <span class="token operator">==</span> pdPASS<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span>uart_data<span class="token punctuation">.</span>TxBuffer <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"len = %d\n"</span><span class="token punctuation">,</span>uart_data<span class="token punctuation">.</span>TxCounter<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token function">USART_SendString</span><span class="token punctuation">(</span>uart_data<span class="token punctuation">.</span>COMx<span class="token punctuation">,</span> uart_data<span class="token punctuation">.</span>TxBuffer<span class="token punctuation">,</span> uart_data<span class="token punctuation">.</span>TxCounter<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token comment">/************************************************</pre></td></tr><tr><td data-num="31"></td><td><pre>函数名称 ： vSetupUSART</pre></td></tr><tr><td data-num="32"></td><td><pre>功    能 ： UART 初始化接口</pre></td></tr><tr><td data-num="33"></td><td><pre>参    数 ： 无</pre></td></tr><tr><td data-num="34"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num="35"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token keyword">void</span> <span class="token function">vSetupUSART</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token function">UART1_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token comment">//UART2_Config();</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token comment">/* Create the queue used by the Usart task. */</span></pre></td></tr><tr><td data-num="42"></td><td><pre>xQueueUartTx <span class="token operator">=</span> <span class="token function">xQueueCreate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> portBASE_TYPE<span class="token punctuation">)</span>UART_QUEUE_TX_LENGTH<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>UartTx_Buff_TypeDef<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 目标队列的句柄</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token comment">//xQueueUart1_Rx = xQueueCreate ((unsigned portBASE_TYPE) UART_QUEUE_RX_LENGTH, sizeof (UartRx_Buff_TypeDef));// 目标队列的句柄</span></pre></td></tr><tr><td data-num="44"></td><td><pre>xQueueUart1_Rx <span class="token operator">=</span> <span class="token function">xQueueCreate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> portBASE_TYPE<span class="token punctuation">)</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 目标队列的句柄</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token function">xTaskCreate</span><span class="token punctuation">(</span> prvUartTx_Task<span class="token punctuation">,</span> <span class="token string">"prvUartTx_Task"</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> tskIDLE_PRIORITY <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token function">xTaskCreate</span><span class="token punctuation">(</span> prvUart1_Rx_Task<span class="token punctuation">,</span> <span class="token string">"prvUart1_Rx_Task"</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> tskIDLE_PRIORITY <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token comment">/************************************************</pre></td></tr><tr><td data-num="51"></td><td><pre>函数名称 ： UART1_Config</pre></td></tr><tr><td data-num="52"></td><td><pre>功    能 ： UART1 端口配置</pre></td></tr><tr><td data-num="53"></td><td><pre>参    数 ： 无</pre></td></tr><tr><td data-num="54"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num="55"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token keyword">void</span> <span class="token function">UART1_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    NVIC_InitTypeDef NVIC_InitStructure<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    USART_InitTypeDef USART_InitStructure<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token comment">/* config GPIOA clock */</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB2Periph_GPIOA<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token comment">/* config USART1 clock */</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB2Periph_USART1<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token comment">/* USART1 GPIO config */</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token comment">/* Configure USART1 Tx (PA.09) as alternate function push-pull */</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_9<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_AF_PP<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token comment">/* Configure USART1 Rx (PA.10) as input floating */</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_10<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_IN_FLOATING<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre></pre></td></tr><tr><td data-num="80"></td><td><pre>    <span class="token comment">/* Enable the USART1 Interrupt */</span></pre></td></tr><tr><td data-num="81"></td><td><pre>    NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannel <span class="token operator">=</span> USART1_IRQn<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelPreemptionPriority <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>    NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelSubPriority <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>    NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelCmd <span class="token operator">=</span> ENABLE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>    <span class="token function">NVIC_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>NVIC_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre></pre></td></tr><tr><td data-num="87"></td><td><pre>    <span class="token comment">/* USART1 mode config */</span></pre></td></tr><tr><td data-num="88"></td><td><pre>    USART_InitStructure<span class="token punctuation">.</span>USART_BaudRate <span class="token operator">=</span> BAUDRATE_1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>    USART_InitStructure<span class="token punctuation">.</span>USART_WordLength <span class="token operator">=</span> USART_WordLength_8b<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>    USART_InitStructure<span class="token punctuation">.</span>USART_StopBits <span class="token operator">=</span> USART_StopBits_1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>    USART_InitStructure<span class="token punctuation">.</span>USART_Parity <span class="token operator">=</span> USART_Parity_No <span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>    USART_InitStructure<span class="token punctuation">.</span>USART_HardwareFlowControl <span class="token operator">=</span> USART_HardwareFlowControl_None<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>    USART_InitStructure<span class="token punctuation">.</span>USART_Mode <span class="token operator">=</span> USART_Mode_Rx <span class="token operator">|</span> USART_Mode_Tx<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>    <span class="token function">USART_Init</span><span class="token punctuation">(</span>EVAL_COM1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>USART_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre></pre></td></tr><tr><td data-num="96"></td><td><pre><span class="token function">USART_ITConfig</span><span class="token punctuation">(</span>EVAL_COM1<span class="token punctuation">,</span> USART_IT_RXNE<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>    <span class="token function">USART_Cmd</span><span class="token punctuation">(</span>EVAL_COM1<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="98"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="99"></td><td><pre></pre></td></tr><tr><td data-num="100"></td><td><pre><span class="token comment">/************************************************</pre></td></tr><tr><td data-num="101"></td><td><pre>函数名称 ： USART_SendByte</pre></td></tr><tr><td data-num="102"></td><td><pre>功    能 ： 串口字符发送</pre></td></tr><tr><td data-num="103"></td><td><pre>参    数 ： c ---- 发送的数据</pre></td></tr><tr><td data-num="104"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num="105"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num="106"></td><td><pre><span class="token keyword">void</span> <span class="token function">USART_SendByte</span><span class="token punctuation">(</span> USART_TypeDef<span class="token operator">*</span> USARTx<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> c <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="107"></td><td><pre><span class="token punctuation">&#123;</span>     </pre></td></tr><tr><td data-num="108"></td><td><pre><span class="token function">USART_SendData</span><span class="token punctuation">(</span>USARTx<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="109"></td><td><pre></pre></td></tr><tr><td data-num="110"></td><td><pre><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">USART_GetFlagStatus</span><span class="token punctuation">(</span>USARTx<span class="token punctuation">,</span> USART_FLAG_TXE<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="111"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="112"></td><td><pre></pre></td></tr><tr><td data-num="113"></td><td><pre><span class="token comment">/************************************************</pre></td></tr><tr><td data-num="114"></td><td><pre>函数名称 ： USART_SendString</pre></td></tr><tr><td data-num="115"></td><td><pre>功    能 ： 串口字符串发送</pre></td></tr><tr><td data-num="116"></td><td><pre>参    数 ： USARTx ---- 串口</pre></td></tr><tr><td data-num="117"></td><td><pre>pData ---- 字符串</pre></td></tr><tr><td data-num="118"></td><td><pre>Length ---- 长度</pre></td></tr><tr><td data-num="119"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num="120"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num="121"></td><td><pre><span class="token keyword">void</span> <span class="token function">USART_SendString</span><span class="token punctuation">(</span> USART_TypeDef<span class="token operator">*</span> USARTx<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>pData<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> Length <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="122"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="123"></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span>Length<span class="token operator">--</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="124"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="125"></td><td><pre>        <span class="token function">USART_SendByte</span><span class="token punctuation">(</span>USARTx<span class="token punctuation">,</span> <span class="token operator">*</span>pData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="126"></td><td><pre>        pData<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="127"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="128"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="129"></td><td><pre></pre></td></tr><tr><td data-num="130"></td><td><pre><span class="token comment">/************************************************</pre></td></tr><tr><td data-num="131"></td><td><pre>函数名称 ： USART_Printf</pre></td></tr><tr><td data-num="132"></td><td><pre>功    能 ： 串口打印输出</pre></td></tr><tr><td data-num="133"></td><td><pre>参    数 ： USARTx ---- 串口</pre></td></tr><tr><td data-num="134"></td><td><pre>String---- 字符串</pre></td></tr><tr><td data-num="135"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num="136"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num="137"></td><td><pre><span class="token keyword">void</span> <span class="token function">USART_Printf</span><span class="token punctuation">(</span> USART_TypeDef<span class="token operator">*</span> USARTx<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>String <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="138"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="139"></td><td><pre>    <span class="token keyword">do</span></pre></td></tr><tr><td data-num="140"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="141"></td><td><pre>        <span class="token function">USART_SendByte</span><span class="token punctuation">(</span>USARTx<span class="token punctuation">,</span> <span class="token operator">*</span>String<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="142"></td><td><pre>        String<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="143"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>String<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token char">'\0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="144"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="145"></td><td><pre></pre></td></tr><tr><td data-num="146"></td><td><pre><span class="token comment">/************************************************</pre></td></tr><tr><td data-num="147"></td><td><pre>函数名称 ： fputc</pre></td></tr><tr><td data-num="148"></td><td><pre>功    能 ： 重定向 c 库函数 printf 到 DEBUG_UART</pre></td></tr><tr><td data-num="149"></td><td><pre>参    数 ： ch</pre></td></tr><tr><td data-num="150"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num="151"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num="152"></td><td><pre><span class="token keyword">int</span> <span class="token function">fputc</span><span class="token punctuation">(</span><span class="token keyword">int</span> ch<span class="token punctuation">,</span> FILE <span class="token operator">*</span>f<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="153"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="154"></td><td><pre>    <span class="token comment">/* 发送一个字节数据到 DEBUG_UART */</span></pre></td></tr><tr><td data-num="155"></td><td><pre>    <span class="token function">USART_SendData</span><span class="token punctuation">(</span>DEBUG_UART<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span> ch<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="156"></td><td><pre></pre></td></tr><tr><td data-num="157"></td><td><pre>    <span class="token comment">/* 等待发送完毕 */</span></pre></td></tr><tr><td data-num="158"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">USART_GetFlagStatus</span><span class="token punctuation">(</span>DEBUG_UART<span class="token punctuation">,</span> USART_FLAG_TXE<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="159"></td><td><pre></pre></td></tr><tr><td data-num="160"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="161"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="162"></td><td><pre></pre></td></tr><tr><td data-num="163"></td><td><pre><span class="token comment">/************************************************</pre></td></tr><tr><td data-num="164"></td><td><pre>函数名称 ： fgetc</pre></td></tr><tr><td data-num="165"></td><td><pre>功    能 ： 重定向 c 库函数 scanf 到 DEBUG_UART</pre></td></tr><tr><td data-num="166"></td><td><pre>参    数 ： f ---- 文件</pre></td></tr><tr><td data-num="167"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num="168"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num="169"></td><td><pre><span class="token keyword">int</span> <span class="token function">fgetc</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>f<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="170"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="171"></td><td><pre>    <span class="token comment">/* 等待 DEBUG_UART 输入数据 */</span></pre></td></tr><tr><td data-num="172"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">USART_GetFlagStatus</span><span class="token punctuation">(</span>DEBUG_UART<span class="token punctuation">,</span> USART_FLAG_RXNE<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="173"></td><td><pre></pre></td></tr><tr><td data-num="174"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">USART_ReceiveData</span><span class="token punctuation">(</span>DEBUG_UART<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="175"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="176"></td><td><pre></pre></td></tr><tr><td data-num="177"></td><td><pre></pre></td></tr><tr><td data-num="178"></td><td><pre><span class="token comment">/*---------------------------- END OF FILE ----------------------------*/</span></pre></td></tr></table></figure><figure class="highlight c"><figcaption data-lang="c"><span>bsp_uart.h</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__BSP_UART_H</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__BSP_UART_H</span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEBUG_UART</span><span class="token expression">USART1</span></span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EVAL_COM1</span><span class="token expression">USART1</span></span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EVAL_COM2</span><span class="token expression">USART2</span></span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">USART1_RX_DMA_CHANNEL</span><span class="token expression">DMA1_Channel5</span></span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">USART2_RX_DMA_CHANNEL</span><span class="token expression">DMA1_Channel6</span></span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TxBUFFER_SIZE</span>   <span class="token expression"><span class="token number">100</span></span></span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RxBUFFER_SIZE</span>   <span class="token expression"><span class="token number">100</span></span></span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">UART_QUEUE_RX_LENGTH</span><span class="token expression"><span class="token number">2</span></span></span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">UART_QUEUE_TX_LENGTH</span><span class="token expression"><span class="token number">2</span></span></span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token class-name">uint8_t</span> Receiving_Time<span class="token punctuation">;</span><span class="token comment">// 接收时间</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token class-name">uint8_t</span> Frame_flag<span class="token punctuation">;</span><span class="token comment">// 一帧完成标志</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">&#125;</span>EVAL_COMx_TypeDef<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token class-name">uint8_t</span> RxBuffer<span class="token punctuation">[</span>RxBUFFER_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 接收暂存缓冲区</span></pre></td></tr><tr><td data-num="31"></td><td><pre>__IO <span class="token class-name">uint8_t</span> RxCounter<span class="token punctuation">;</span><span class="token comment">// 接收数据个数</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">&#125;</span>UartRx_Buff_TypeDef<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token class-name">uint8_t</span> TxBuffer<span class="token punctuation">[</span>TxBUFFER_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 发送暂存缓冲区</span></pre></td></tr><tr><td data-num="37"></td><td><pre>__IO <span class="token class-name">uint8_t</span> TxCounter<span class="token punctuation">;</span><span class="token comment">// 发送数据个数</span></pre></td></tr><tr><td data-num="38"></td><td><pre>USART_TypeDef<span class="token operator">*</span> COMx<span class="token punctuation">;</span><span class="token comment">// 串口号</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token punctuation">&#125;</span>UartTx_Buff_TypeDef<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token keyword">void</span> <span class="token function">vSetupUSART</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token keyword">void</span> <span class="token function">UART1_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token keyword">void</span> <span class="token function">UART2_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token keyword">void</span> <span class="token function">USART_SendByte</span><span class="token punctuation">(</span> USART_TypeDef<span class="token operator">*</span> USARTx<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> c <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token keyword">void</span> <span class="token function">USART_SendString</span><span class="token punctuation">(</span> USART_TypeDef<span class="token operator">*</span> USARTx<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>pData<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> Length <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token keyword">void</span> <span class="token function">USART_Printf</span><span class="token punctuation">(</span> USART_TypeDef<span class="token operator">*</span> USARTx<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>String <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span><span class="token comment">/* __BSP_UART_H */</span></span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token comment">/*---------------------------- END OF FILE ----------------------------*/</span></pre></td></tr></table></figure><p>其实对照之前的 <span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQyOTkyMDg0L2FydGljbGUvZGV0YWlscy8xMDQwOTg1MzE=">STM32 笔记之 USART（串口）</span> 改动并不大，只是分开处理一下，并且以任务的形式封装起来。</p><p>最后我们可以看一下他的测试结果：</p><p><img data-src="2020022014051323.png" alt="img" /></p><p>从结果中可以看到，若是直接用 printf 输出，因为两个相同优先级的任务在同一时间输出数据，结果出现了数据叠加（这并不是我们想要的结果），而后面以队列的形式进行输出，数据是可以按照正常打印的（哪怕他们的任务优先级一样，并且运行的流程一样，他都分布好数据位置一并打印；后面测了一下，任务优先级相同，发现会按着任务创建的顺序来处理的；还有其他一些小测试，也会有很多不同的结果，具体可以自己试着探究），这里主要想说的是：为了避免在 RTOS 中多个任务同时访问公用数据（或者同一硬件），最好用队列或者利用后面要说的互斥量等来处理数据（根据实际需求用哪个）。</p><p>多任务系统中存在一种潜在的风险。当一个任务在使用某个资源的过程中，即还没有完全结束对资源的访问时，便被切出运行态，使得资源处于非一致，不完整的状态。如果这个时候有另一个任务或者中断来访问这个资源，则会导致数据损坏或是其它相似的错误，也就是像上面的一开始打印出错那样。</p>]]></content>
      
      
      <categories>
          
          <category> FreeRTOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> history </tag>
            
            <tag> RTOS </tag>
            
            <tag> FreeRTOS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FreeRTOS 篇章之任务管理</title>
      <link href="/docs/RTOS/FreeRTOS%20%E7%AF%87%E7%AB%A0%E4%B9%8B%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86/"/>
      <url>/docs/RTOS/FreeRTOS%20%E7%AF%87%E7%AB%A0%E4%B9%8B%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h1 id="任务状态"><a class="anchor" href="#任务状态">#</a> 任务状态</h1><p>任务目前存在四种状态，分为：运行、就绪、阻塞、挂起；</p><ol><li><strong>Running — 运行态</strong><br />这是任务在执行的时候的状态，处在运行态意味着任务获得 CPU 的使用权，对于单核 CPU，此时不存在其他运行态的任务。</li><li><strong>Ready — 就绪态</strong><br />处在就绪态意味着这个任务是可以执行的，比如某个事件发生、队列数据到来、所请求的资源有效等；但是，因为此时有一个相同优先级或者更高优先级的任务正在运行，此时任务无法执行而处于就绪态。</li><li><strong>Blocked — 阻塞态</strong><br />如果一个任务正在等待一个时间到来或者外部的事件到来，比如一个调用  <code>vTaskDelay()</code>  函数的任务，在延时时间到来之前，任务将处在阻塞状态。当然，任务在等待队列、信号量、事件组、通知、信号量事件时都会处在阻塞态。通常，这些等待都会设置一个超时 timeout 时间，当等待超时是将任务从阻塞态退出，防止任务被无限挂起。处在阻塞态的任务不占用任何 CPU 时间。</li><li><strong>Suspended — 挂起态</strong><br />挂起态无法进入运行态，同时不像阻塞态有超时时间，挂起态无超时时间，除非调用  <code>vTaskResume()</code>  推出挂起态。相应的调用  <code>vTaskSuspend()</code>  将一个任务挂起。挂起态可以描述成 “冻结”；除非 “解冻”，否则无法再有机会被执行到。</li></ol><p>它们的状态关系图：</p><p><img data-src="20200228151607721.png" alt="img" /></p><h1 id="任务优先级"><a class="anchor" href="#任务优先级">#</a> 任务优先级</h1><p>每个任务在创建的时候都要指定一个从  <code>0</code>  到  <code>configMAX_PRIORITIES - 1</code>  的优先级，与其他 RTOS 不同之处在于，优先级数值越大，优先级越低。 <code>configMAX_PRIORITIES</code>  定义在  <code>freeRTOSConfig.h</code>  头文件中。</p><p><code>configMAX_PRIORITIES</code>  的值可以是任意值，也就是说 FreeRTOS 的任务数量不受限制。事实上，因为 FreeRTOS 允许任务共享同一个优先级， <code>configMAX_PRIORITIES</code>  的大小不会限制到任务数量。但是对于实际应用来说，因为 FreeRTOS 中即使未用到的优先级，任然会占用一定的内存，因此优先级的最大数值，应与实际应用贴近。</p><p>在  <code>freeRTOSConfig.h</code>  头文件中，定义了  <code>configUSE_PORT_OPTIMISED_TASK_SELECTION</code>  ，拥有某些存在任务选择优化机制的架构，此时最大优先级不能超过 32。</p><p>FreeRTOS 中的空闲任务 IDEL Task 总是最低优先级，因此它的优先级为 0。</p><p>FreeRTOS 的调度器总是确保当前得到 CPU 时间的任务的优先级是最高的，换句话说，就绪态中高优先级的任务，总是会优先进入运行态。</p><p>对于共用同一优先级的任务，如果  <code>configUSE_TIME_SLICING</code>  未定义或者定义为  <code>1</code>  , 则 FreeRTOS 将使用时间片轮询的机制去调度这些任务。</p><p>跟多具体的配置信息可以去看 <a href="https://arachnid.cc/docs/RTOS/FreeRTOS%20%E7%AF%87%E7%AB%A0%E4%B9%8B%20FreeRTOSConfig.h%E5%88%86%E6%9E%90/">FreeRTOS 篇章之 FreeRTOSConfig.h 分析</a> 。</p><h1 id="任务创建-xtaskcreate"><a class="anchor" href="#任务创建-xtaskcreate">#</a> 任务创建 - xTaskCreate ()</h1><p>xTaskCreate () API 函数原型实现：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span><span class="token expression"><span class="token punctuation">(</span> configSUPPORT_DYNAMIC_ALLOCATION <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>BaseType_t <span class="token function">xTaskCreate</span><span class="token punctuation">(</span>TaskFunction_t pxTaskCode<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> <span class="token keyword">const</span> pcName<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">const</span> <span class="token keyword">uint16_t</span> usStackDepth<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">void</span> <span class="token operator">*</span> <span class="token keyword">const</span> pvParameters<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>UBaseType_t uxPriority<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>TaskHandle_t <span class="token operator">*</span> <span class="token keyword">const</span> pxCreatedTask <span class="token punctuation">)</span> <span class="token comment">/*lint !e971 Unqualified char types are allowed for strings and single characters only. */</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>TCB_t <span class="token operator">*</span>pxNewTCB<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>BaseType_t xReturn<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">/* If the stack grows down then allocate the stack then the TCB so the stack</pre></td></tr><tr><td data-num="14"></td><td><pre>does not grow into the TCB.  Likewise if the stack grows up then allocate</pre></td></tr><tr><td data-num="15"></td><td><pre>the TCB then the stack. */</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span><span class="token expression"><span class="token punctuation">(</span> portSTACK_GROWTH <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">/* Allocate space for the TCB.  Where the memory comes from depends on</pre></td></tr><tr><td data-num="19"></td><td><pre>the implementation of the port malloc function and whether or not static</pre></td></tr><tr><td data-num="20"></td><td><pre>allocation is being used. */</span></pre></td></tr><tr><td data-num="21"></td><td><pre>pxNewTCB <span class="token operator">=</span> <span class="token punctuation">(</span> TCB_t <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token function">pvPortMalloc</span><span class="token punctuation">(</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span> TCB_t <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> pxNewTCB <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment">/* Allocate space for the stack used by the task being created.</pre></td></tr><tr><td data-num="26"></td><td><pre>The base of the stack memory stored in the TCB so the task can</pre></td></tr><tr><td data-num="27"></td><td><pre>be deleted later if required. */</span></pre></td></tr><tr><td data-num="28"></td><td><pre>pxNewTCB<span class="token operator">-></span>pxStack <span class="token operator">=</span> <span class="token punctuation">(</span> StackType_t <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token function">pvPortMalloc</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> size_t <span class="token punctuation">)</span> usStackDepth <span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span> StackType_t <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/*lint !e961 MISRA exception as the casts are only redundant for some ports. */</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> pxNewTCB<span class="token operator">-></span>pxStack <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token comment">/* Could not allocate the stack.  Delete the allocated TCB. */</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token function">vPortFree</span><span class="token punctuation">(</span> pxNewTCB <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>pxNewTCB <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span> <span class="token comment">/* portSTACK_GROWTH */</span></span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>StackType_t <span class="token operator">*</span>pxStack<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token comment">/* Allocate space for the stack used by the task being created. */</span></pre></td></tr><tr><td data-num="43"></td><td><pre>pxStack <span class="token operator">=</span> <span class="token punctuation">(</span> StackType_t <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token function">pvPortMalloc</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> size_t <span class="token punctuation">)</span> usStackDepth <span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span> StackType_t <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/*lint !e961 MISRA exception as the casts are only redundant for some ports. */</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> pxStack <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token comment">/* Allocate space for the TCB. */</span></pre></td></tr><tr><td data-num="48"></td><td><pre>pxNewTCB <span class="token operator">=</span> <span class="token punctuation">(</span> TCB_t <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token function">pvPortMalloc</span><span class="token punctuation">(</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span> TCB_t <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/*lint !e961 MISRA exception as the casts are only redundant for some paths. */</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> pxNewTCB <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token comment">/* Store the stack location in the TCB. */</span></pre></td></tr><tr><td data-num="53"></td><td><pre>pxNewTCB<span class="token operator">-></span>pxStack <span class="token operator">=</span> pxStack<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token keyword">else</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token comment">/* The stack cannot be used as the TCB was not created.  Free</pre></td></tr><tr><td data-num="58"></td><td><pre>it again. */</span></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token function">vPortFree</span><span class="token punctuation">(</span> pxStack <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="62"></td><td><pre><span class="token keyword">else</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>pxNewTCB <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="66"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="67"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* portSTACK_GROWTH */</span></span></pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> pxNewTCB <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="70"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="71"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span><span class="token expression"><span class="token punctuation">(</span> tskSTATIC_AND_DYNAMIC_ALLOCATION_POSSIBLE <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="73"></td><td><pre><span class="token comment">/* Tasks can be created statically or dynamically, so note this</pre></td></tr><tr><td data-num="74"></td><td><pre>task was created dynamically in case it is later deleted. */</span></pre></td></tr><tr><td data-num="75"></td><td><pre>pxNewTCB<span class="token operator">-></span>ucStaticallyAllocated <span class="token operator">=</span> tskDYNAMICALLY_ALLOCATED_STACK_AND_TCB<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="77"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* configSUPPORT_STATIC_ALLOCATION */</span></span></pre></td></tr><tr><td data-num="78"></td><td><pre></pre></td></tr><tr><td data-num="79"></td><td><pre><span class="token function">prvInitialiseNewTask</span><span class="token punctuation">(</span> pxTaskCode<span class="token punctuation">,</span> pcName<span class="token punctuation">,</span> <span class="token punctuation">(</span> <span class="token keyword">uint32_t</span> <span class="token punctuation">)</span> usStackDepth<span class="token punctuation">,</span> pvParameters<span class="token punctuation">,</span> uxPriority<span class="token punctuation">,</span> pxCreatedTask<span class="token punctuation">,</span> pxNewTCB<span class="token punctuation">,</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre><span class="token function">prvAddNewTaskToReadyList</span><span class="token punctuation">(</span> pxNewTCB <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>xReturn <span class="token operator">=</span> pdPASS<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="83"></td><td><pre><span class="token keyword">else</span></pre></td></tr><tr><td data-num="84"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>xReturn <span class="token operator">=</span> errCOULD_NOT_ALLOCATE_REQUIRED_MEMORY<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="87"></td><td><pre></pre></td></tr><tr><td data-num="88"></td><td><pre><span class="token keyword">return</span> xReturn<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="90"></td><td><pre></pre></td></tr><tr><td data-num="91"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* configSUPPORT_DYNAMIC_ALLOCATION */</span></span></pre></td></tr></table></figure><p>可以看到，该函数是受宏  <code>configSUPPORT_DYNAMIC_ALLOCATION</code>  控制的，该宏位于  <code>FreeRTOSConfig.h</code>  文件中。</p><p>传入参数：</p><ul><li><strong>pvTaskCode</strong>：指向任务函数入口的指针，是一个永不退出的 C 函数，实现常通常是一个死循环。</li><li><strong>pcName</strong>：具有描述性的任务名。这个参数不会被 FreeRTOS 使用，其只是单纯地用于辅助调试；通过定义常量  <code>config_MAX_TASK_NAME_LEN</code>  来定义任务名的最大长度（包括  <code>\0</code>  结束符），该宏位于  <code>FreeRTOSConfig.h</code>  文件中。</li><li><strong>usStackDepth</strong>：当任务创建时，用于告诉内核为它分配多大的栈空间，这个值指定的是栈空间可以保存多少个字（word），而不是多少个字节（byte）。</li><li><strong>pvParameters</strong>：任务函数接受一个指向 void 的指针（void *），即是传递到任务中的值。</li><li><strong>uxPriority</strong>：用于指定任务执行的优先级。优先级的取值范围可以从最低优先级 (  <code>0</code>  ) 到最高优先级 (  <code>configMAX_PRIORITIES – 1</code>  )； <code>configMAX_PRIORITIES</code>  是一个由用户定义的常量，该宏位于  <code>FreeRTOSConfig.h</code>  文件中。</li><li><strong>pxCreatedTask</strong>：用于传出任务的句柄。这个句柄将在 API 调用中对该创建出来的任务进行引用，比如改变任务优先级，或者删除任务；如果应用程序中不会用到这个任务的句柄，则  <code>pxCreatedTask</code>  可以被设为 NULL。</li></ul><p>返回参数（有两个可能的返回值）：</p><ul><li><strong>pdTRUE</strong>：表明任务创建成功。</li><li><strong>errCOULD_NOT_ALLOCATE_REQUIRED_MEMORY</strong>：由于内存堆空间不足，FreeRTOS 无法分配足够的空间来保存任务结构数据和任务栈，而无法创建任务。</li></ul><h1 id="任务删除-vtaskdelete"><a class="anchor" href="#任务删除-vtaskdelete">#</a> 任务删除 - vTaskDelete ()</h1><p>vTaskDelete () API 函数原型实现：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span> INCLUDE_vTaskDelete <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">void</span> <span class="token function">vTaskDelete</span><span class="token punctuation">(</span> TaskHandle_t xTaskToDelete <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>TCB_t <span class="token operator">*</span>pxTCB<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token function">taskENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">/* If null is passed in here then it is the calling task that is</pre></td></tr><tr><td data-num="10"></td><td><pre>being deleted. */</span></pre></td></tr><tr><td data-num="11"></td><td><pre>pxTCB <span class="token operator">=</span> <span class="token function">prvGetTCBFromHandle</span><span class="token punctuation">(</span> xTaskToDelete <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">/* Remove task from the ready list. */</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">uxListRemove</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxTCB<span class="token operator">-></span>xStateListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">0</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token function">taskRESET_READY_PRIORITY</span><span class="token punctuation">(</span> pxTCB<span class="token operator">-></span>uxPriority <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">else</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment">/* Is the task waiting on an event also? */</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">listLIST_ITEM_CONTAINER</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxTCB<span class="token operator">-></span>xEventListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span> <span class="token function">uxListRemove</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxTCB<span class="token operator">-></span>xEventListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token keyword">else</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token comment">/* Increment the uxTaskNumber also so kernel aware debuggers can</pre></td></tr><tr><td data-num="34"></td><td><pre>detect that the task lists need re-generating.  This is done before</pre></td></tr><tr><td data-num="35"></td><td><pre>portPRE_TASK_DELETE_HOOK() as in the Windows port that macro will</pre></td></tr><tr><td data-num="36"></td><td><pre>not return. */</span></pre></td></tr><tr><td data-num="37"></td><td><pre>uxTaskNumber<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> pxTCB <span class="token operator">==</span> pxCurrentTCB <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token comment">/* A task is deleting itself.  This cannot complete within the</pre></td></tr><tr><td data-num="42"></td><td><pre>task itself, as a context switch to another task is required.</pre></td></tr><tr><td data-num="43"></td><td><pre>Place the task in the termination list.  The idle task will</pre></td></tr><tr><td data-num="44"></td><td><pre>check the termination list and free up any memory allocated by</pre></td></tr><tr><td data-num="45"></td><td><pre>the scheduler for the TCB and stack of the deleted task. */</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token function">vListInsertEnd</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>xTasksWaitingTermination<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxTCB<span class="token operator">-></span>xStateListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token comment">/* Increment the ucTasksDeleted variable so the idle task knows</pre></td></tr><tr><td data-num="49"></td><td><pre>there is a task that has been deleted and that it should therefore</pre></td></tr><tr><td data-num="50"></td><td><pre>check the xTasksWaitingTermination list. */</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token operator">++</span>uxDeletedTasksWaitingCleanUp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token comment">/* The pre-delete hook is primarily for the Windows simulator,</pre></td></tr><tr><td data-num="54"></td><td><pre>in which Windows specific clean up operations are performed,</pre></td></tr><tr><td data-num="55"></td><td><pre>after which it is not possible to yield away from this task -</pre></td></tr><tr><td data-num="56"></td><td><pre>hence xYieldPending is used to latch that a context switch is</pre></td></tr><tr><td data-num="57"></td><td><pre>required. */</span></pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token function">portPRE_TASK_DELETE_HOOK</span><span class="token punctuation">(</span> pxTCB<span class="token punctuation">,</span> <span class="token operator">&amp;</span>xYieldPending <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="60"></td><td><pre><span class="token keyword">else</span></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="62"></td><td><pre><span class="token operator">--</span>uxCurrentNumberOfTasks<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token function">prvDeleteTCB</span><span class="token punctuation">(</span> pxTCB <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token comment">/* Reset the next expected unblock time in case it referred to</pre></td></tr><tr><td data-num="66"></td><td><pre>the task that has just been deleted. */</span></pre></td></tr><tr><td data-num="67"></td><td><pre><span class="token function">prvResetNextTaskUnblockTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="69"></td><td><pre></pre></td></tr><tr><td data-num="70"></td><td><pre><span class="token function">traceTASK_DELETE</span><span class="token punctuation">(</span> pxTCB <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre></pre></td></tr><tr><td data-num="74"></td><td><pre><span class="token comment">/* Force a reschedule if it is the currently running task that has just</pre></td></tr><tr><td data-num="75"></td><td><pre>been deleted. */</span></pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> xSchedulerRunning <span class="token operator">!=</span> pdFALSE <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="77"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="78"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> pxTCB <span class="token operator">==</span> pxCurrentTCB <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="79"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="80"></td><td><pre><span class="token function">configASSERT</span><span class="token punctuation">(</span> uxSchedulerSuspended <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre><span class="token function">portYIELD_WITHIN_API</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="83"></td><td><pre><span class="token keyword">else</span></pre></td></tr><tr><td data-num="84"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="85"></td><td><pre><span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="87"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="88"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="89"></td><td><pre></pre></td></tr><tr><td data-num="90"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* INCLUDE_vTaskDelete */</span></span></pre></td></tr></table></figure><p>同样的，该函数则是受宏  <code>INCLUDE_vTaskDelete</code>  控制的，该宏位于  <code>FreeRTOSConfig.h</code>  文件中。</p><p>传入参数：</p><ul><li><strong>pxTaskToDelete</strong>：被删除任务的句柄（目标任务）。若传入 NULL，则是删除当前执行的任务（即删除自己）。</li></ul><h1 id="代码搭建"><a class="anchor" href="#代码搭建">#</a> 代码搭建</h1><p>任务（task）是在 FreeRTOS 中执行的基本单位，每个 task 都是由一个 C 函数所组成，意思是你需要先定义一個 C 的函数，然後再用  <code>xTaskCreate()</code>  这个 API 來建立一個 task，這個 C 函数有几个特点，它的返回值必須是 void，其中通常是存于无限循环中（while、for），所有关于这个 task 的工作都会在这个无限循环中进行，而且这个函数不会有 return，FreeRTOS 不允許 task 自行结束（使用 return 或执行到函数的最后一行）；task 被建立出來后，它会配置有自己的堆栈空间和 stack variable （就是 function 中定义的变量）。</p><figure class="highlight c"><figcaption data-lang="c"><span>main.c</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/*</pre></td></tr><tr><td data-num="2"></td><td><pre>    FreeRTOS V9.0.0 - Copyright (C) 2016 Real Time Engineers Ltd.</pre></td></tr><tr><td data-num="3"></td><td><pre>    All rights reserved</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    VISIT http://www.FreeRTOS.org TO ENSURE YOU ARE USING THE LATEST VERSION.</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    This file is part of the FreeRTOS distribution.</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    FreeRTOS is free software; you can redistribute it and/or modify it under</pre></td></tr><tr><td data-num="10"></td><td><pre>    the terms of the GNU General Public License (version 2) as published by the</pre></td></tr><tr><td data-num="11"></td><td><pre>    Free Software Foundation >>>> AND MODIFIED BY &lt;&lt;&lt;&lt; the FreeRTOS exception.</pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    ***************************************************************************</pre></td></tr><tr><td data-num="14"></td><td><pre>    >>!   NOTE: The modification to the GPL is included to allow you to     !&lt;&lt;</pre></td></tr><tr><td data-num="15"></td><td><pre>    >>!   distribute a combined work that includes FreeRTOS without being   !&lt;&lt;</pre></td></tr><tr><td data-num="16"></td><td><pre>    >>!   obliged to provide the source code for proprietary components     !&lt;&lt;</pre></td></tr><tr><td data-num="17"></td><td><pre>    >>!   outside of the FreeRTOS kernel.                                   !&lt;&lt;</pre></td></tr><tr><td data-num="18"></td><td><pre>    ***************************************************************************</pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    FreeRTOS is distributed in the hope that it will be useful, but WITHOUT ANY</pre></td></tr><tr><td data-num="21"></td><td><pre>    WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</pre></td></tr><tr><td data-num="22"></td><td><pre>    FOR A PARTICULAR PURPOSE.  Full license text is available on the following</pre></td></tr><tr><td data-num="23"></td><td><pre>    link: http://www.freertos.org/a00114.html</pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>    ***************************************************************************</pre></td></tr><tr><td data-num="26"></td><td><pre>     *                                                                       *</pre></td></tr><tr><td data-num="27"></td><td><pre>     *    FreeRTOS provides completely free yet professionally developed,    *</pre></td></tr><tr><td data-num="28"></td><td><pre>     *    robust, strictly quality controlled, supported, and cross          *</pre></td></tr><tr><td data-num="29"></td><td><pre>     *    platform software that is more than just the market leader, it     *</pre></td></tr><tr><td data-num="30"></td><td><pre>     *    is the industry's de facto standard.                               *</pre></td></tr><tr><td data-num="31"></td><td><pre>     *                                                                       *</pre></td></tr><tr><td data-num="32"></td><td><pre>     *    Help yourself get started quickly while simultaneously helping     *</pre></td></tr><tr><td data-num="33"></td><td><pre>     *    to support the FreeRTOS project by purchasing a FreeRTOS           *</pre></td></tr><tr><td data-num="34"></td><td><pre>     *    tutorial book, reference manual, or both:                          *</pre></td></tr><tr><td data-num="35"></td><td><pre>     *    http://www.FreeRTOS.org/Documentation                              *</pre></td></tr><tr><td data-num="36"></td><td><pre>     *                                                                       *</pre></td></tr><tr><td data-num="37"></td><td><pre>    ***************************************************************************</pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>    http://www.FreeRTOS.org/FAQHelp.html - Having a problem?  Start by reading</pre></td></tr><tr><td data-num="40"></td><td><pre>    the FAQ page "My application does not run, what could be wrong?".  Have you</pre></td></tr><tr><td data-num="41"></td><td><pre>    defined configASSERT()?</pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>    http://www.FreeRTOS.org/support - In return for receiving this top quality</pre></td></tr><tr><td data-num="44"></td><td><pre>    embedded software for free we request you assist our global community by</pre></td></tr><tr><td data-num="45"></td><td><pre>    participating in the support forum.</pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>    http://www.FreeRTOS.org/training - Investing in training allows your team to</pre></td></tr><tr><td data-num="48"></td><td><pre>    be as productive as possible as early as possible.  Now you can receive</pre></td></tr><tr><td data-num="49"></td><td><pre>    FreeRTOS training directly from Richard Barry, CEO of Real Time Engineers</pre></td></tr><tr><td data-num="50"></td><td><pre>    Ltd, and the world's leading authority on the world's leading RTOS.</pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre>    http://www.FreeRTOS.org/plus - A selection of FreeRTOS ecosystem products,</pre></td></tr><tr><td data-num="53"></td><td><pre>    including FreeRTOS+Trace - an indispensable productivity tool, a DOS</pre></td></tr><tr><td data-num="54"></td><td><pre>    compatible FAT file system, and our tiny thread aware UDP/IP stack.</pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre>    http://www.FreeRTOS.org/labs - Where new FreeRTOS products go to incubate.</pre></td></tr><tr><td data-num="57"></td><td><pre>    Come and try FreeRTOS+TCP, our new open source TCP/IP stack for FreeRTOS.</pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre>    http://www.OpenRTOS.com - Real Time Engineers ltd. license FreeRTOS to High</pre></td></tr><tr><td data-num="60"></td><td><pre>    Integrity Systems ltd. to sell under the OpenRTOS brand.  Low cost OpenRTOS</pre></td></tr><tr><td data-num="61"></td><td><pre>    licenses offer ticketed support, indemnification and commercial middleware.</pre></td></tr><tr><td data-num="62"></td><td><pre></pre></td></tr><tr><td data-num="63"></td><td><pre>    http://www.SafeRTOS.com - High Integrity Systems also provide a safety</pre></td></tr><tr><td data-num="64"></td><td><pre>    engineered and independently SIL3 certified version for use in safety and</pre></td></tr><tr><td data-num="65"></td><td><pre>    mission critical applications that require provable dependability.</pre></td></tr><tr><td data-num="66"></td><td><pre></pre></td></tr><tr><td data-num="67"></td><td><pre>    1 tab == 4 spaces!</pre></td></tr><tr><td data-num="68"></td><td><pre>*/</span></pre></td></tr><tr><td data-num="69"></td><td><pre></pre></td></tr><tr><td data-num="70"></td><td><pre></pre></td></tr><tr><td data-num="71"></td><td><pre><span class="token comment">/* Standard includes. */</span></pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="73"></td><td><pre></pre></td></tr><tr><td data-num="74"></td><td><pre><span class="token comment">/* Scheduler includes. */</span></pre></td></tr><tr><td data-num="75"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"FreeRTOS.h"</span></span></pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"task.h"</span></span></pre></td></tr><tr><td data-num="77"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"queue.h"</span></span></pre></td></tr><tr><td data-num="78"></td><td><pre></pre></td></tr><tr><td data-num="79"></td><td><pre><span class="token comment">/* Library includes. */</span></pre></td></tr><tr><td data-num="80"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x_it.h"</span></span></pre></td></tr><tr><td data-num="81"></td><td><pre></pre></td></tr><tr><td data-num="82"></td><td><pre><span class="token comment">/* Private app includes. */</span></pre></td></tr><tr><td data-num="83"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"bsp_uart.h"</span></span></pre></td></tr><tr><td data-num="84"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"bsp_time.h"</span></span></pre></td></tr><tr><td data-num="85"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"bsp_gpio.h"</span></span></pre></td></tr><tr><td data-num="86"></td><td><pre></pre></td></tr><tr><td data-num="87"></td><td><pre></pre></td></tr><tr><td data-num="88"></td><td><pre><span class="token comment">/*----------------------------- End -----------------------------*/</span></pre></td></tr><tr><td data-num="89"></td><td><pre></pre></td></tr><tr><td data-num="90"></td><td><pre><span class="token comment">/*</pre></td></tr><tr><td data-num="91"></td><td><pre> * User Private Task.</pre></td></tr><tr><td data-num="92"></td><td><pre> */</span></pre></td></tr><tr><td data-num="93"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prvUser_Task</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span>pvParameters <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre></pre></td></tr><tr><td data-num="95"></td><td><pre><span class="token comment">/*</pre></td></tr><tr><td data-num="96"></td><td><pre> * Configure the clocks, GPIO and other peripherals as required by the demo.</pre></td></tr><tr><td data-num="97"></td><td><pre> */</span></pre></td></tr><tr><td data-num="98"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prvSetupHardware</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="99"></td><td><pre></pre></td></tr><tr><td data-num="100"></td><td><pre><span class="token comment">/*----------------------------- End -----------------------------*/</span></pre></td></tr><tr><td data-num="101"></td><td><pre></pre></td></tr><tr><td data-num="102"></td><td><pre></pre></td></tr><tr><td data-num="103"></td><td><pre><span class="token comment">/************************************************</pre></td></tr><tr><td data-num="104"></td><td><pre>函数名称 ： main</pre></td></tr><tr><td data-num="105"></td><td><pre>功    能 ： 主函数入口</pre></td></tr><tr><td data-num="106"></td><td><pre>参    数 ： 无</pre></td></tr><tr><td data-num="107"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num="108"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num="109"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="110"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="111"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">DEBUG</span></span></pre></td></tr><tr><td data-num="112"></td><td><pre>  <span class="token function">debug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="113"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="114"></td><td><pre></pre></td></tr><tr><td data-num="115"></td><td><pre><span class="token function">prvSetupHardware</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="116"></td><td><pre></pre></td></tr><tr><td data-num="117"></td><td><pre><span class="token comment">/* Start the tasks defined within this file/specific to this demo. */</span></pre></td></tr><tr><td data-num="118"></td><td><pre><span class="token function">xTaskCreate</span><span class="token punctuation">(</span> prvUser_Task<span class="token punctuation">,</span> <span class="token string">"prvUser_Task"</span><span class="token punctuation">,</span> configMINIMAL_STACK_SIZE<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> tskIDLE_PRIORITY<span class="token punctuation">,</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="119"></td><td><pre></pre></td></tr><tr><td data-num="120"></td><td><pre><span class="token comment">/* Start the scheduler. */</span></pre></td></tr><tr><td data-num="121"></td><td><pre><span class="token function">vTaskStartScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="122"></td><td><pre></pre></td></tr><tr><td data-num="123"></td><td><pre><span class="token comment">/* Will only get here if there was not enough heap space to create the</pre></td></tr><tr><td data-num="124"></td><td><pre>idle task. */</span></pre></td></tr><tr><td data-num="125"></td><td><pre><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="126"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="127"></td><td><pre><span class="token comment">/*----------------------------- End -----------------------------*/</span></pre></td></tr><tr><td data-num="128"></td><td><pre></pre></td></tr><tr><td data-num="129"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prvUser_Task</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span>pvParameters <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="130"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="131"></td><td><pre>    <span class="token comment">/* User-defined private tasks */</span></pre></td></tr><tr><td data-num="132"></td><td><pre></pre></td></tr><tr><td data-num="133"></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="134"></td><td><pre>        <span class="token comment">/* do something here */</span></pre></td></tr><tr><td data-num="135"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="136"></td><td><pre></pre></td></tr><tr><td data-num="137"></td><td><pre>    <span class="token comment">/* </pre></td></tr><tr><td data-num="138"></td><td><pre>    * 如果你的 task 就是需要离开 loop 并结束</pre></td></tr><tr><td data-num="139"></td><td><pre>    * 需要用 vTaskDelete 來刪除自己而非使用 return 或自然结束 (执行到最后一行)</pre></td></tr><tr><td data-num="140"></td><td><pre>    * 这个参数的 NULL 值是表示自己 </pre></td></tr><tr><td data-num="141"></td><td><pre>    */</span></pre></td></tr><tr><td data-num="142"></td><td><pre>    <span class="token function">vTaskDelete</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 删除自己</span></pre></td></tr><tr><td data-num="143"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="144"></td><td><pre></pre></td></tr><tr><td data-num="145"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prvSetupHardware</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="146"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="147"></td><td><pre><span class="token comment">/* Start with the clocks in their expected state. */</span></pre></td></tr><tr><td data-num="148"></td><td><pre><span class="token function">RCC_DeInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="149"></td><td><pre></pre></td></tr><tr><td data-num="150"></td><td><pre><span class="token comment">/* Enable HSE (high speed external clock). */</span></pre></td></tr><tr><td data-num="151"></td><td><pre><span class="token function">RCC_HSEConfig</span><span class="token punctuation">(</span> RCC_HSE_ON <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="152"></td><td><pre></pre></td></tr><tr><td data-num="153"></td><td><pre><span class="token comment">/* Wait till HSE is ready. */</span></pre></td></tr><tr><td data-num="154"></td><td><pre><span class="token keyword">while</span><span class="token punctuation">(</span> <span class="token function">RCC_GetFlagStatus</span><span class="token punctuation">(</span> RCC_FLAG_HSERDY <span class="token punctuation">)</span> <span class="token operator">==</span> RESET <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="155"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="156"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="157"></td><td><pre></pre></td></tr><tr><td data-num="158"></td><td><pre><span class="token comment">/* 2 wait states required on the flash. */</span></pre></td></tr><tr><td data-num="159"></td><td><pre><span class="token operator">*</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token number">0x40022000</span> <span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0x02</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="160"></td><td><pre></pre></td></tr><tr><td data-num="161"></td><td><pre><span class="token comment">/* HCLK = SYSCLK */</span></pre></td></tr><tr><td data-num="162"></td><td><pre><span class="token function">RCC_HCLKConfig</span><span class="token punctuation">(</span> RCC_SYSCLK_Div1 <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="163"></td><td><pre></pre></td></tr><tr><td data-num="164"></td><td><pre><span class="token comment">/* PCLK2 = HCLK */</span></pre></td></tr><tr><td data-num="165"></td><td><pre><span class="token function">RCC_PCLK2Config</span><span class="token punctuation">(</span> RCC_HCLK_Div1 <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="166"></td><td><pre></pre></td></tr><tr><td data-num="167"></td><td><pre><span class="token comment">/* PCLK1 = HCLK/2 */</span></pre></td></tr><tr><td data-num="168"></td><td><pre><span class="token function">RCC_PCLK1Config</span><span class="token punctuation">(</span> RCC_HCLK_Div2 <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="169"></td><td><pre></pre></td></tr><tr><td data-num="170"></td><td><pre><span class="token comment">/* PLLCLK = 8MHz * 9 = 72 MHz. */</span></pre></td></tr><tr><td data-num="171"></td><td><pre><span class="token function">RCC_PLLConfig</span><span class="token punctuation">(</span> RCC_PLLSource_HSE_Div1<span class="token punctuation">,</span> RCC_PLLMul_9 <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="172"></td><td><pre></pre></td></tr><tr><td data-num="173"></td><td><pre><span class="token comment">/* Enable PLL. */</span></pre></td></tr><tr><td data-num="174"></td><td><pre><span class="token function">RCC_PLLCmd</span><span class="token punctuation">(</span> ENABLE <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="175"></td><td><pre></pre></td></tr><tr><td data-num="176"></td><td><pre><span class="token comment">/* Wait till PLL is ready. */</span></pre></td></tr><tr><td data-num="177"></td><td><pre><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">RCC_GetFlagStatus</span><span class="token punctuation">(</span>RCC_FLAG_PLLRDY<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="178"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="179"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="180"></td><td><pre></pre></td></tr><tr><td data-num="181"></td><td><pre><span class="token comment">/* Select PLL as system clock source. */</span></pre></td></tr><tr><td data-num="182"></td><td><pre><span class="token function">RCC_SYSCLKConfig</span><span class="token punctuation">(</span> RCC_SYSCLKSource_PLLCLK <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="183"></td><td><pre></pre></td></tr><tr><td data-num="184"></td><td><pre><span class="token comment">/* Wait till PLL is used as system clock source. */</span></pre></td></tr><tr><td data-num="185"></td><td><pre><span class="token keyword">while</span><span class="token punctuation">(</span> <span class="token function">RCC_GetSYSCLKSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0x08</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="186"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="187"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="188"></td><td><pre></pre></td></tr><tr><td data-num="189"></td><td><pre><span class="token comment">/* Configure HCLK clock as SysTick clock source. */</span></pre></td></tr><tr><td data-num="190"></td><td><pre><span class="token function">SysTick_CLKSourceConfig</span><span class="token punctuation">(</span> SysTick_CLKSource_HCLK <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="191"></td><td><pre></pre></td></tr><tr><td data-num="192"></td><td><pre><span class="token comment">/*</pre></td></tr><tr><td data-num="193"></td><td><pre> * STM32 中断优先级分组为 4，即 4bit 都用来表示抢占优先级，范围为：0~15</pre></td></tr><tr><td data-num="194"></td><td><pre> * 优先级分组只需要分组一次即可，以后如果有其他的任务需要用到中断，</pre></td></tr><tr><td data-num="195"></td><td><pre> * 都统一用这个优先级分组，千万不要再分组，切忌。</pre></td></tr><tr><td data-num="196"></td><td><pre> */</span></pre></td></tr><tr><td data-num="197"></td><td><pre><span class="token function">NVIC_PriorityGroupConfig</span><span class="token punctuation">(</span> NVIC_PriorityGroup_4 <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="198"></td><td><pre></pre></td></tr><tr><td data-num="199"></td><td><pre><span class="token comment">/* Other peripheral configuration */</span></pre></td></tr><tr><td data-num="200"></td><td><pre><span class="token function">vSetupTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="201"></td><td><pre><span class="token function">vSetupUSART</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="202"></td><td><pre><span class="token function">vSetupParPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="203"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="204"></td><td><pre><span class="token comment">/*----------------------------- End -----------------------------*/</span></pre></td></tr><tr><td data-num="205"></td><td><pre></pre></td></tr><tr><td data-num="206"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span>  <span class="token expression">DEBUG</span></span></pre></td></tr><tr><td data-num="207"></td><td><pre><span class="token comment">/* Keep the linker happy. */</span></pre></td></tr><tr><td data-num="208"></td><td><pre><span class="token keyword">void</span> <span class="token function">assert_failed</span><span class="token punctuation">(</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> pcFile<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> ulLine <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="209"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="210"></td><td><pre><span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="211"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="212"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="213"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="214"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="215"></td><td><pre></pre></td></tr><tr><td data-num="216"></td><td><pre></pre></td></tr><tr><td data-num="217"></td><td><pre><span class="token comment">/*---------------------------- END OF FILE ----------------------------*/</span></pre></td></tr></table></figure><p>首先， <code>prvSetupHardware()</code>  函数是配置时钟，并且初始化硬件配置（即  <code>vSetupTimer();</code>    <code>vSetupUSART();</code>    <code>vSetupParPort();</code>  的实现，其实就是封装了一下之前 <a href="https://arachnid.cc/categories/STM32">stm32 笔记中</a> 的 time、uart、gpio 初始化配置）。</p><figure class="highlight c"><figcaption data-lang="c"><span>[Other peripheral configuration]</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/************************************************</pre></td></tr><tr><td data-num="2"></td><td><pre>函数名称 ： vSetupTimer</pre></td></tr><tr><td data-num="3"></td><td><pre>功    能 ： Timer 初始化接口</pre></td></tr><tr><td data-num="4"></td><td><pre>参    数 ： 无</pre></td></tr><tr><td data-num="5"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num="6"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">void</span> <span class="token function">vSetupTimer</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token function">Timer2_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">/************************************************</pre></td></tr><tr><td data-num="13"></td><td><pre>函数名称 ： vSetupUSART</pre></td></tr><tr><td data-num="14"></td><td><pre>功    能 ： UART 初始化接口</pre></td></tr><tr><td data-num="15"></td><td><pre>参    数 ： 无</pre></td></tr><tr><td data-num="16"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num="17"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">void</span> <span class="token function">vSetupUSART</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token function">UART1_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment">//UART2_Config();</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment">/************************************************</pre></td></tr><tr><td data-num="25"></td><td><pre>函数名称 ： vSetupParPort</pre></td></tr><tr><td data-num="26"></td><td><pre>功    能 ： 基础 IO 初始化接口</pre></td></tr><tr><td data-num="27"></td><td><pre>参    数 ： 无</pre></td></tr><tr><td data-num="28"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num="29"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token keyword">void</span> <span class="token function">vSetupParPort</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token function">LED_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token function">Key_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>然后到后面的  <code>main</code>  函数的实现调用，调用  <code>prvSetupHardware()</code>  初始化所有跟硬件相关的配置，创建一个  <code>prvUser_Task</code>  任务，用于管理所有后面创建的任务（其实就是为了方便管理），因为这里面没有创建其他函数，所以放了个 while 循环在里面，最后再调用  <code>vTaskDelete(NULL);</code>  把自己删除；</p><p>这里可能有个疑问，明明有个  <code>while</code>  死循环，执行不到  <code>vTaskDelete()</code>  函数，没什么意义啊，虽然道理是这样，但是最好在每个任务的结尾放上  <code>vTaskDelete()</code>  函数，以确保安全（特殊情况除外）；还有就是，因为在  <code>prvUser_Task</code>  任务中有个死循环，那在  <code>while</code>  之后的程序应该都执行不了啊，包括  <code>prvUser_Task</code>  任务后面的  <code>vTaskStartScheduler();</code>  ，如果是按正常的思维是这样的；但是，这里是在使用 RTOS，调用  <code>xTaskCreate()</code>  创建任务并不表示就已经执行了，只是告诉内核，我创建了这么一个任务，真正使系统开始执行是在调用了  <code>vTaskStartScheduler();</code>  启动调度器之后。</p>]]></content>
      
      
      <categories>
          
          <category> FreeRTOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> history </tag>
            
            <tag> RTOS </tag>
            
            <tag> FreeRTOS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FreeRTOS 篇章之 FreeRTOSConfig.h分析</title>
      <link href="/docs/RTOS/FreeRTOS%20%E7%AF%87%E7%AB%A0%E4%B9%8B%20FreeRTOSConfig.h%E5%88%86%E6%9E%90/"/>
      <url>/docs/RTOS/FreeRTOS%20%E7%AF%87%E7%AB%A0%E4%B9%8B%20FreeRTOSConfig.h%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1 id="移植修改"><a class="anchor" href="#移植修改">#</a> 移植修改</h1><p>在 <a href="https://arachnid.cc/docs/RTOS/FreeRTOS%20%E7%AF%87%E7%AB%A0%E4%B9%8B%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D/">FreeRTOS 篇章之系统移植</a> 中，我们有把  <code>FreeRTOSv9.0.0\FreeRTOS\Demo\CORTEX_STM32F103_Keil</code>  路径下的  <code>FreeRTOSConfig.h</code>  文件复制到我们用户可修改的  <code>App</code>  文件夹下，并且导入了工程，但是，该  <code>FreeRTOSConfig.h</code>  文件的内容并不是我们真正想要了内容，需要我们进行更改，而源文件内容就只有下面这么点内容</p><p><img data-src="20200216134014732.png" alt="img" /></p><p>虽然能满足 FreeRTOS 跑起来，但是往往随着功能的添加，我们需要 FreeRTOS 的更多支持，而这里也只是展示了个别裁剪功能；为了物尽其用，避免以后还要继续添加，所以我们直接就导入 FreeRTOS 所提供的功能选择，修改成如下内容：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">FREERTOS_CONFIG_H</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FREERTOS_CONFIG_H</span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">/* Here is a good place to include header files that are required across</pre></td></tr><tr><td data-num="5"></td><td><pre>your application. */</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"something.h"</span></span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configUSE_PREEMPTION</span>                    <span class="token expression"><span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configUSE_PORT_OPTIMISED_TASK_SELECTION</span> <span class="token expression"><span class="token number">0</span></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configUSE_TICKLESS_IDLE</span>                 <span class="token expression"><span class="token number">0</span></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configCPU_CLOCK_HZ</span>                      <span class="token expression"><span class="token number">60000000</span></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configTICK_RATE_HZ</span>                      <span class="token expression"><span class="token number">250</span></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configMAX_PRIORITIES</span>                    <span class="token expression"><span class="token number">5</span></span></span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configMINIMAL_STACK_SIZE</span>                <span class="token expression"><span class="token number">128</span></span></span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configMAX_TASK_NAME_LEN</span>                 <span class="token expression"><span class="token number">16</span></span></span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configUSE_16_BIT_TICKS</span>                  <span class="token expression"><span class="token number">0</span></span></span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configIDLE_SHOULD_YIELD</span>                 <span class="token expression"><span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configUSE_TASK_NOTIFICATIONS</span>            <span class="token expression"><span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configUSE_MUTEXES</span>                       <span class="token expression"><span class="token number">0</span></span></span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configUSE_RECURSIVE_MUTEXES</span>             <span class="token expression"><span class="token number">0</span></span></span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configUSE_COUNTING_SEMAPHORES</span>           <span class="token expression"><span class="token number">0</span></span></span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configUSE_ALTERNATIVE_API</span>               <span class="token expression"><span class="token number">0</span> </span><span class="token comment">/* Deprecated! */</span></span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configQUEUE_REGISTRY_SIZE</span>               <span class="token expression"><span class="token number">10</span></span></span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configUSE_QUEUE_SETS</span>                    <span class="token expression"><span class="token number">0</span></span></span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configUSE_TIME_SLICING</span>                  <span class="token expression"><span class="token number">0</span></span></span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configUSE_NEWLIB_REENTRANT</span>              <span class="token expression"><span class="token number">0</span></span></span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configENABLE_BACKWARD_COMPATIBILITY</span>     <span class="token expression"><span class="token number">0</span></span></span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configNUM_THREAD_LOCAL_STORAGE_POINTERS</span> <span class="token expression"><span class="token number">5</span></span></span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configSTACK_DEPTH_TYPE</span>                  <span class="token expression"><span class="token keyword">uint16_t</span></span></span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configMESSAGE_BUFFER_LENGTH_TYPE</span>        <span class="token expression">size_t</span></span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token comment">/* Memory allocation related definitions. */</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configSUPPORT_STATIC_ALLOCATION</span>         <span class="token expression"><span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configSUPPORT_DYNAMIC_ALLOCATION</span>        <span class="token expression"><span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configTOTAL_HEAP_SIZE</span>                   <span class="token expression"><span class="token number">10240</span></span></span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configAPPLICATION_ALLOCATED_HEAP</span>        <span class="token expression"><span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token comment">/* Hook function related definitions. */</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configUSE_IDLE_HOOK</span>                     <span class="token expression"><span class="token number">0</span></span></span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configUSE_TICK_HOOK</span>                     <span class="token expression"><span class="token number">0</span></span></span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configCHECK_FOR_STACK_OVERFLOW</span>          <span class="token expression"><span class="token number">0</span></span></span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configUSE_MALLOC_FAILED_HOOK</span>            <span class="token expression"><span class="token number">0</span></span></span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configUSE_DAEMON_TASK_STARTUP_HOOK</span>      <span class="token expression"><span class="token number">0</span></span></span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token comment">/* Run time and task stats gathering related definitions. */</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configGENERATE_RUN_TIME_STATS</span>           <span class="token expression"><span class="token number">0</span></span></span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configUSE_TRACE_FACILITY</span>                <span class="token expression"><span class="token number">0</span></span></span></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configUSE_STATS_FORMATTING_FUNCTIONS</span>    <span class="token expression"><span class="token number">0</span></span></span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token comment">/* Co-routine related definitions. */</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configUSE_CO_ROUTINES</span>                   <span class="token expression"><span class="token number">0</span></span></span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configMAX_CO_ROUTINE_PRIORITIES</span>         <span class="token expression"><span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="53"></td><td><pre></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token comment">/* Software timer related definitions. */</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configUSE_TIMERS</span>                        <span class="token expression"><span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configTIMER_TASK_PRIORITY</span>               <span class="token expression"><span class="token number">3</span></span></span></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configTIMER_QUEUE_LENGTH</span>                <span class="token expression"><span class="token number">10</span></span></span></pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configTIMER_TASK_STACK_DEPTH</span>            <span class="token expression">configMINIMAL_STACK_SIZE</span></span></pre></td></tr><tr><td data-num="59"></td><td><pre></pre></td></tr><tr><td data-num="60"></td><td><pre><span class="token comment">/* Interrupt nesting behaviour configuration. */</span></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configKERNEL_INTERRUPT_PRIORITY</span>         <span class="token expression"><span class="token punctuation">[</span>dependent of processor<span class="token punctuation">]</span></span></span></pre></td></tr><tr><td data-num="62"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configMAX_SYSCALL_INTERRUPT_PRIORITY</span>    <span class="token expression"><span class="token punctuation">[</span>dependent on processor <span class="token operator">and</span> application<span class="token punctuation">]</span></span></span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configMAX_API_CALL_INTERRUPT_PRIORITY</span>   <span class="token expression"><span class="token punctuation">[</span>dependent on processor <span class="token operator">and</span> application<span class="token punctuation">]</span></span></span></pre></td></tr><tr><td data-num="64"></td><td><pre></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token comment">/* Define to trap errors during development. */</span></pre></td></tr><tr><td data-num="66"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">configASSERT</span><span class="token expression"><span class="token punctuation">(</span> <span class="token punctuation">(</span> x <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> x <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token function">vAssertCalled</span><span class="token punctuation">(</span> <span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span> <span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="67"></td><td><pre></pre></td></tr><tr><td data-num="68"></td><td><pre><span class="token comment">/* FreeRTOS MPU specific definitions. */</span></pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configINCLUDE_APPLICATION_DEFINED_PRIVILEGED_FUNCTIONS</span> <span class="token expression"><span class="token number">0</span></span></span></pre></td></tr><tr><td data-num="70"></td><td><pre></pre></td></tr><tr><td data-num="71"></td><td><pre><span class="token comment">/* Optional functions - most linkers will remove unused functions anyway. */</span></pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INCLUDE_vTaskPrioritySet</span>                <span class="token expression"><span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="73"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INCLUDE_uxTaskPriorityGet</span>               <span class="token expression"><span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="74"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INCLUDE_vTaskDelete</span>                     <span class="token expression"><span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="75"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INCLUDE_vTaskSuspend</span>                    <span class="token expression"><span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INCLUDE_xResumeFromISR</span>                  <span class="token expression"><span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="77"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INCLUDE_vTaskDelayUntil</span>                 <span class="token expression"><span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="78"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INCLUDE_vTaskDelay</span>                      <span class="token expression"><span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="79"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INCLUDE_xTaskGetSchedulerState</span>          <span class="token expression"><span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="80"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INCLUDE_xTaskGetCurrentTaskHandle</span>       <span class="token expression"><span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="81"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INCLUDE_uxTaskGetStackHighWaterMark</span>     <span class="token expression"><span class="token number">0</span></span></span></pre></td></tr><tr><td data-num="82"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INCLUDE_xTaskGetIdleTaskHandle</span>          <span class="token expression"><span class="token number">0</span></span></span></pre></td></tr><tr><td data-num="83"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INCLUDE_eTaskGetState</span>                   <span class="token expression"><span class="token number">0</span></span></span></pre></td></tr><tr><td data-num="84"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INCLUDE_xEventGroupSetBitFromISR</span>        <span class="token expression"><span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="85"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INCLUDE_xTimerPendFunctionCall</span>          <span class="token expression"><span class="token number">0</span></span></span></pre></td></tr><tr><td data-num="86"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INCLUDE_xTaskAbortDelay</span>                 <span class="token expression"><span class="token number">0</span></span></span></pre></td></tr><tr><td data-num="87"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INCLUDE_xTaskGetHandle</span>                  <span class="token expression"><span class="token number">0</span></span></span></pre></td></tr><tr><td data-num="88"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INCLUDE_xTaskResumeFromISR</span>              <span class="token expression"><span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="89"></td><td><pre></pre></td></tr><tr><td data-num="90"></td><td><pre><span class="token comment">/* A header file that defines trace macro can be included here. */</span></pre></td></tr><tr><td data-num="91"></td><td><pre></pre></td></tr><tr><td data-num="92"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* FREERTOS_CONFIG_H */</span></span></pre></td></tr></table></figure><p>当然，这只是官方提供的，较为完整的配置模版；具体实现什么功能还是要我们对相应的宏进行修改的。</p><h1 id="配置项详解"><a class="anchor" href="#配置项详解">#</a> 配置项详解</h1><p><strong>1、configUSE_PREEMPTION</strong></p><p>置  <code>1</code>  ：RTOS 使用抢占式调度器，即当进程位于内核空间时，有一个更高优先级的任务出现时，如果当前内核允许抢占，则可以将当前任务挂起，执行优先级更高的进程；</p><p>置  <code>0</code>  ：RTOS 使用协作式调度器（时间片），协作式操作系统是任务主动释放 CPU 后，切换到下一个任务，任务切换的时机完全取决于正在运行的任务，因此，高优先级的进程不能中止正在内核中运行的低优先级的进程而抢占 CPU 运行。</p><p><strong>2、configUSE_PORT_OPTIMISED_TASK_SELECTION</strong></p><p>一些 FreeRTOS 硬件端口在选择下一个要执行的任务，具有两种的方法：通用方法和特定于该硬件端口的方法。</p><p>通用方法：</p><ul><li>在  <code>configUSE_PORT_OPTIMISED_TASK_SELECTION</code>  设置为  <code>0</code>  （显式）或未实现特定于硬件端口的方法（隐式）时使用。</li><li>可以与所有 FreeRTOS 硬件端口一起使用。</li><li>完全用 C 编写，使其效率低于使用特定硬件端口的方法。</li><li>不限制可用优先级的最大数量。</li></ul><p>特定于硬件端口的方法：</p><ul><li>不适用于所有硬件端口。</li><li>在  <code>configUSE_PORT_OPTIMISED_TASK_SELECTION</code>  设置为  <code>1</code>  时使用。</li><li>依赖于一个或多个特定于体系结构的汇编指令（通常为计数前导零 [CLZ] 或等效指令），因此只能与专门为其编写的体系结构一起使用。</li><li>比通用方法更有效。</li><li>通常，最大可用优先级数限制为 32。</li></ul><p><strong>3、configUSE_TICKLESS_IDLE</strong></p><p>置  <code>1</code>  ：使能低功耗 tickless 模式；</p><p>置  <code>0</code>  ：保持系统节拍（tick）中断一直运行。</p><p>在低功耗 tickless 模式，通常使用空闲钩子函数设置 CPU 进入低功耗模式来达到省电的目的。</p><p><strong>4、configUSE_IDLE_HOOK</strong></p><p>置  <code>1</code>  ：使用空闲钩子（Idle Hook 类似于回调函数）；</p><p>置  <code>0</code>  ：忽略空闲钩子。</p><p>空闲任务钩子是一个函数，这个函数由用户来实现，FreeRTOS 规定了函数的名字和参数：  <code>void vApplicationIdleHook(void)</code>  ，这个函数在每个空闲任务周期都会被调用。</p><p><strong>5、configUSE_MALLOC_FAILED_HOOK</strong></p><p>每次创建任务，队列或信号量时，内核都会使用对  <code>pvPortMalloc()</code>  的调用从堆中分配内存。FreeRTOS 的官方下载包中包含五个堆内存分配方案；这些方案分别在  <code>heap_1.c</code>  ， <code>heap_2.c</code>  ， <code>heap_3.c</code>  ， <code>heap_4.c</code>  和  <code>heap_5.c</code>  源文件中进行实现；  <code>configUSE_MALLOC_FAILED_HOOK</code>  仅在使用这五个堆内存分配方案之一时才有意义。</p><p>如果定义并正确配置  <code>malloc()</code>  申请失败的钩子函数，则这个函数会在  <code>pvPortMalloc()</code>  函数返回 NULL 时被调用；注意：仅当 FreeRTOS 在响应内存分配请求时发现堆内存不足时，才返回 NULL。</p><p>置  <code>1</code>  ：则应用程序必须定义一个  <code>malloc()</code>  申请失败的挂钩函数；</p><p>置  <code>0</code>  ：则忽略  <code>malloc()</code>  申请失败的挂钩函数，即使定义了这个挂钩函数。</p><p><code>malloc()</code>  申请失败的挂钩函数必须具有如下所示的名称和原型：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">vApplicationMallocFailedHook</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><strong>6、configUSE_DAEMON_TASK_STARTUP_HOOK</strong></p><p>置  <code>1</code>  ：则应用程序必须定义一个具有确切名称和原型的钩子函数；</p><p>置  <code>0</code>  ：则忽略该钩子函数。</p><p>其名称和原型如下所示：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">vApplicationDaemonTaskStartupHook</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>首次执行 RTOS 守护程序任务（也称为 <span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL1JUT1Mtc29mdHdhcmUtdGltZXItc2VydmljZS1kYWVtb24tdGFzay5odG1s">计时器服务任务</span> ）时，钩子函数将被精确调用一次 。任何需要运行 RTOS 的应用程序初始化代码都可以放在挂钩函数中。</p><p><strong>7、configUSE_TICK_HOOK</strong></p><p>置  <code>1</code>  ：使用时间片钩子（Tick Hook）；</p><p>置  <code>0</code>  ：忽略时间片钩子。</p><p>时间片钩子是一个函数，这个函数由用户来实现，FreeRTOS 规定了函数的名字和参数： <code>void vApplicationTickHook(void)</code> ，时间片中断可以周期性的调用。</p><p><strong>8、configCPU_CLOCK_HZ</strong></p><p>输入以 Hz 为单位的频率，该驱动频率将用于系统滴答中断的外设驱动的内部时钟，通常与驱动内部 CPU 时钟的时钟相同；配置此值是为了正确的配置系统节拍中断周期。</p><p><strong>9、configTICK_RATE_HZ</strong></p><p>配置 RTOS 滴答中断的频率；用于测量时间，即一秒中断的次数，每次中断 RTOS 都会进行任务调度。</p><p>更高的滴答频率意味着同一时间下可以测量到更高的分辨率；但是，较高的滴答频率也意味着 RTOS 内核将使用更多的 CPU 时间，因此使得效率降低。RTOS 演示例程均使用 1000Hz 的滴答频率，这是为了测试 RTOS 内核，因此比实际使用的高得多。（实际使用时不用这么高的系统节拍中断频率）</p><p>多个任务可以共享相同的优先级。通过在每个 RTOS 系统节拍中断到来时切换任务，RTOS 调度程序将在优先级相同的任务之间共享处理器时间；因此，较高的滴答频率会减少分配给每个任务的 “时间片” 。</p><p><strong>10、configMAX_PRIORITIES</strong></p><p>配置应用程序任务可用的优先级数；任何数量的任务都可以共享相同的优先级。协同例程的优先级是分开的，详情见  <code>configMAX_CO_ROUTINE_PRIORITIES</code>  。</p><p>每个可用的优先级都会消耗 RTOS 内核中的 RAM，因此该值不应设置为高于应用程序实际需要的值。</p><p>每一个任务都会被分配一个优先级，优先级值在 0 ~ (configMAX_PRIORITIES - 1) 之间。低优先级数表示低优先级任务，空闲任务的优先级为 0（tskIDLE_PRIORITY），因此它是最低优先级任务。</p><p><strong>11、configMINIMAL_STACK_SIZE</strong></p><p>空闲任务使用的堆栈大小。通常此值不应小于对应处理器演示例程文件  <code>FreeRTOSConfig.h</code>  中定义的数值</p><p>就像 <span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL2EwMDEyNS5odG1s">xTaskCreate()</span> 和 <span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL3hUYXNrQ3JlYXRlU3RhdGljLmh0bWw=">xTaskCreateStatic()</span> 函数的堆栈大小参数一样，堆栈大小以字为单位而不是字节；如果在 32 位处理器上，当堆栈大小为 100 则表示 400 字节的空间大小。</p><p><strong>12、configMAX_TASK_NAME_LEN</strong></p><p>创建任务时，描述任务信息的字符串的最大允许长度。长度包括  <code>\0</code>  字符串结束符。</p><p><strong>13、configUSE_TRACE_FACILITY</strong></p><p>置  <code>1</code>  ：表示启动可视化跟踪调试，会激活一些其他的结构成员和函数；</p><p>置  <code>0</code>  ：忽略。</p><p><strong>14、configUSE_STATS_FORMATTING_FUNCTIONS</strong></p><p>将  <code>configUSE_TRACE_FACILITY </code>  和  <code>configUSE_STATS_FORMATTING_FUNCTIONS</code>  都设置为  <code>1</code>  ，则再构建中包含编译  <code>vTaskList()</code>  和  <code>vTaskGetRunTimeStats()</code>  函数；</p><p>否则，其中一个宏为  <code>0</code>  ，就会从构建中省略这两个函数，不进行编译；通常只是在调试时才使用，用来观察各任务，跟 13 的宏连用。</p><p><strong>15、configUSE_16_BIT_TICKS</strong></p><p>时间是以 “ticks” 来衡量的，这是自 RTOS 内核启动以来滴答中断执行的次数；tick 计数保存在  <code>TickType_t</code>  类型的变量中。</p><p>置  <code>1</code>  ： <code>TickType_t</code>  被定义为无符号的 16 位类型；</p><p>置  <code>0</code>  ： <code>TickType_t</code>  被定义为无符号的 32 位类型。</p><p>使用 16 位类型将大大提高 8 位和 16 位处理器系统的性能，但会将最大的可指定时间段限制为 65535 个 “ticks” 。因此，假设滴答频率为 250Hz，则使用 16 位计数器时任务可以延迟或阻止的最长时间为 262 秒，而使用 32 位计数器时为 17179869 秒。</p><p><strong>16、configIDLE_SHOULD_YIELD</strong></p><p>此参数控制处于空闲优先级的任务的行为。它仅在以下情况下起作用：</p><ul><li>正在使用抢占式调度程序。</li><li>该应用程序创建以空闲优先级运行的任务。</li></ul><p>如果  <code>configUSE_TIME_SLICING</code>  被设置为  <code>1</code>  （或未定义），则具有相同优先级的任务将共享使用时间片。如果具有相同优先级的任务，它的优先级高于空闲优先级，并且没有一个任务被抢占，则可以假定这些具有相同优先级的任务，它们分配等量的处理时间；</p><p>但当任务共享空闲优先级时，情况会稍微有些不同。如果  <code>configIDLE_SHOULD_YIELD</code>  设置为  <code>1</code>  ，则任何跟空闲优先级相同的用户任务就绪时，空闲任务会立刻让出 CPU，使用户任务得以运行，这样确保了能最快响应用户任务。但是，此行为可能会产生不良影响（取决于您的应用程序的需求），如下所示：</p><p><img data-src="20200217156805236.png" alt="img" /></p><p>上图描述了四个处于空闲优先级的任务的执行模式。任务  <code>A</code>  ， <code>B</code>  和  <code>C</code>  是应用程序任务；任务  <code>I</code>  是空闲任务。在时间 T0，T1，…，T6 定期进行上下文切换；在空闲任务运行中，当任务  <code>A</code>  任务产生时，空闲任务立刻让出 CPU，开始执行任务  <code>A</code>  ，但此刻空闲任务  <code>I</code>  已经消耗了当前时间片的一些时间了，这样的结果就是空闲任务  <code>I</code>  和任务  <code>A</code>  共享同一时间片。因此，应用程序任务  <code>B</code>  和  <code>C</code>  比应用程序任务  <code>A</code>  获得更多的处理时间。</p><p>可以通过以下方式避免这种情况：</p><ul><li>如果合适，请使用空闲钩子函数代替空闲优先级的单独任务。</li><li>以高于空闲优先级的优先级创建所有应用程序任务。</li><li>将  <code>configIDLE_SHOULD_YIELD</code>  设置为  <code>0</code>  。</li></ul><p>将  <code>configIDLE_SHOULD_YIELD</code>  设置为  <code>0</code>  可以防止空闲任务产生处理时间，直到其时间片结束为止。这样可以确保为所有处于空闲优先级的任务分配相等的处理时间（如果没有一个任务被抢占），但代价是将更大比例的总处理时间分配给空闲任务。</p><p><strong>17、configUSE_TASK_NOTIFICATIONS</strong></p><p>置  <code>1</code>  （或未定义）：开启任务通知功能，有关的 API 函数会被包含编译；</p><p>置  <code>0</code>  ：直接从程序中关闭任务通知功能及其关联的 API。</p><p>该功能默认是开启的。开启后，每个任务多增加 8 字节 RAM。</p><p><strong>18、configUSE_MUTEXES</strong></p><p>置  <code>1</code>  ：使用互斥量；</p><p>置  <code>0</code>  ：不使用互斥量。</p><p>读者应该了解在 FreeRTOS 中互斥量和二值信号量的区别。</p><p><strong>19、configUSE_RECURSIVE_MUTEXES</strong></p><p>置  <code>1</code>  ：使用递归互斥量；</p><p>置  <code>0</code>  ：不使用递归互斥量。</p><p><strong>20、configUSE_COUNTING_SEMAPHORES</strong></p><p>置  <code>1</code>  ：使用计数信号量；</p><p>置  <code>0</code>  ：不使用计数信号量。</p><p><strong>21、configUSE_ALTERNATIVE_API</strong></p><p>置  <code>1</code>  ：使用 “alternative” 队列函数；</p><p>置  <code>0</code>  ：不使用 “alternative” 队列函数。</p><p>“alternative” API 队列函数在  <code>queue.h</code>  头文件中有详细描述；<strong>“alternative” API 已被弃用，在新的设计中请不要使用它！</strong></p><p><strong>22、configCHECK_FOR_STACK_OVERFLOW</strong></p><p>在 <span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL1N0YWNrcy1hbmQtc3RhY2stb3ZlcmZsb3ctY2hlY2tpbmcuaHRtbA==">Stack Usage and Stack Overflow Checking</span> 链接中有详细描述堆栈使用情况和堆栈溢出检查的方法，这里就不详细说了。</p><p><strong>23、configQUEUE_REGISTRY_SIZE</strong></p><p>通过此定义来设置可以注册的信号量和消息队列个数。</p><p>队列注册表具有两个目的，这两个目的都与 RTOS 内核调试相关联：</p><ul><li>它允许将文本名称与队列关联，以便在调试 GUI 中轻松识别队列。</li><li>它包含调试器查找每个已注册队列和信号量所需的信息。</li></ul><p>除了进行内核调试外，队列注册表没有其它任何目的；只有注册后的队列和信号量才可以使用 RTOS 内核调试器查看，有关更多信息，请参见 <span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL3ZRdWV1ZUFkZFRvUmVnaXN0cnkuaHRtbA==">vQueueAddToRegistry()</span> 和 <span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL3ZRdWV1ZVVucmVnaXN0ZXJRdWV1ZS5odG1s">vQueueUnregisterQueue()</span> 的 API 参考文档。</p><p><strong>24、configUSE_QUEUE_SETS</strong></p><p>置  <code>1</code>  ：使能队列集功能（可以阻塞、挂起到多个队列和信号量）；</p><p>置  <code>0</code>  ：忽略队列集功能。</p><p><strong>25、configUSE_TIME_SLICING</strong></p><p>置  <code>1</code>  （或未定义）：默认情况下，FreeRTOS 使用基于时间片的优先级抢占式调度器，这意味着 RTOS 调度器将始终运行处于最高优先级的 “就绪” 状态任务，并会在每个 RTOS 滴答中断时对在优先级相同的任务之间进行切换；</p><p>置  <code>0</code>  ：RTOS 调度程序仍将运行处于最高优先级的 “就绪” 状态任务，但不会由于发生了滴答中断而在优先级相同的任务之间切换。</p><p><strong>26、configUSE_NEWLIB_REENTRANT</strong></p><p>置  <code>1</code>  ：将为每个创建的任务分配一个 <span class="exturl" data-url="aHR0cDovL3NvdXJjZXdhcmUub3JnL25ld2xpYi8=">newlib</span>（一个嵌入式 C 库）进入结构；</p><p>置  <code>0</code>  ：不分配。</p><p>注意 Newlib 支持是已经包含在普遍需求中了，但 FreeRTOS 维护者本身并未使用。FreeRTOS 是不负责由此产生的 newlib 操作的，因此用户必须熟悉 newlib，并且必须提供必要存根的系统级实现。请注意，（在撰写本文时）当前的 newlib 设计实现了一个系统级的  <code>malloc()</code>  ，这个  <code>malloc()</code>  必须锁上。</p><p><strong>27、configENABLE_BACKWARD_COMPATIBILITY</strong></p><p><code>FreeRTOS.h</code>  头文件包含一组 #define 宏，这些宏将在 V8.0.0 之前的 FreeRTOS 版本中使用的数据类型的名称映射到在 FreeRTOS 的 V8.0.0 版本中使用的名称，这些宏可以确保 RTOS 内核升级到 V8.0.0 或以上版本时，不用对之前的应用代码做任何修改。</p><p>置  <code>1</code>  ：包含这些 #define 宏；</p><p>置  <code>0</code>  ：排除这些宏，从而允许进行验证，以确保未使用 V8.0.0 之前的版本。</p><p>各类型定义如下：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">configENABLE_BACKWARD_COMPATIBILITY <span class="token operator">==</span> <span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">eTaskStateGet</span> <span class="token expression">eTaskGetState</span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">portTickType</span> <span class="token expression">TickType_t</span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">xTaskHandle</span> <span class="token expression">TaskHandle_t</span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">xQueueHandle</span> <span class="token expression">QueueHandle_t</span></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">xSemaphoreHandle</span> <span class="token expression">SemaphoreHandle_t</span></span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">xQueueSetHandle</span> <span class="token expression">QueueSetHandle_t</span></span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">xQueueSetMemberHandle</span> <span class="token expression">QueueSetMemberHandle_t</span></span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">xTimeOutType</span> <span class="token expression">TimeOut_t</span></span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">xMemoryRegion</span> <span class="token expression">MemoryRegion_t</span></span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">xTaskParameters</span> <span class="token expression">TaskParameters_t</span></span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">xTaskStatusType</span><span class="token expression">TaskStatus_t</span></span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">xTimerHandle</span> <span class="token expression">TimerHandle_t</span></span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">xCoRoutineHandle</span> <span class="token expression">CoRoutineHandle_t</span></span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">pdTASK_HOOK_CODE</span> <span class="token expression">TaskHookFunction_t</span></span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">portTICK_RATE_MS</span> <span class="token expression">portTICK_PERIOD_MS</span></span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">pcTaskGetTaskName</span> <span class="token expression">pcTaskGetName</span></span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">pcTimerGetTimerName</span> <span class="token expression">pcTimerGetName</span></span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">pcQueueGetQueueName</span> <span class="token expression">pcQueueGetName</span></span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">vTaskGetTaskInfo</span> <span class="token expression">vTaskGetInfo</span></span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment">/* Backward compatibility within the scheduler code only - these definitions</pre></td></tr><tr><td data-num="23"></td><td><pre>are not really required but are included for completeness. */</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">tmrTIMER_CALLBACK</span> <span class="token expression">TimerCallbackFunction_t</span></span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">pdTASK_CODE</span> <span class="token expression">TaskFunction_t</span></span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">xListItem</span> <span class="token expression">ListItem_t</span></span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">xList</span> <span class="token expression">List_t</span></span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* configENABLE_BACKWARD_COMPATIBILITY */</span></span></pre></td></tr></table></figure><p><strong>28、configNUM_THREAD_LOCAL_STORAGE_POINTERS</strong></p><p>设置每个任务的线程本地存储指针数组大小；详情请看链接 <span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL3RocmVhZC1sb2NhbC1zdG9yYWdlLXBvaW50ZXJzLmh0bWw=">Thread Local Storage Pointers</span> 。</p><p><strong>29、configSTACK_DEPTH_TYPE</strong></p><p>设置用于在调用 <span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL2EwMDEyNS5odG1s">xTaskCreate()</span> 时指定堆栈深度的类型，并使用其他各种堆栈大小（例如，在返回 <span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL3V4VGFza0dldFN0YWNrSGlnaFdhdGVyTWFyay5odG1s">堆栈高位标记时</span> ）。</p><p>在较旧的版本中，FreeRTOS 使用  <code>UBaseType_t</code>  类型的变量来指定堆栈大小，但是发现这对 8 位微控制器的限制太大。因此， <code>configSTACK_DEPTH_TYPE</code>  允许应用程序开发人员指定要使用的类型，从而消除了这个限制。</p><p><strong>30、configMESSAGE_BUFFER_LENGTH_TYPE</strong></p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL1JUT1MtbWVzc2FnZS1idWZmZXItZXhhbXBsZS5odG1s">FreeRTOS 消息缓冲区</span> 使用  <code>configMESSAGE_BUFFER_LENGTH_TYPE</code>  类型的变量来存储每个消息的长度；如果未定义  <code>configMESSAGE_BUFFER_LENGTH_TYPE</code>  ，则默认为  <code>size_t</code>  。</p><p>如果存储在消息缓冲区中的消息永远不会大于 255 个字节，那么在 32 位微控制器上将  <code>configMESSAGE_BUFFER_LENGTH_TYPE</code>  定义为  <code>uint8_t</code>  将为每个消息节省 3 个字节；同样，如果存储在消息缓冲区中的消息永远不会大于 65535 字节，则在 32 位微控制器上将  <code>configMESSAGE_BUFFER_LENGTH_TYPE</code>  定义为  <code>uint16_t</code>  将为每条消息节省 2 个字节。</p><p><strong>31、configSUPPORT_STATIC_ALLOCATION</strong></p><p>置  <code>1</code>  ：可以使用应用程序编写者提供的 RAM 创建 RTOS 对象；</p><p>置  <code>0</code>  （或未定义）：只能使用从 FreeRTOS 堆分配的 RAM 创建 RTOS 对象。</p><p>如果将  <code>configSUPPORT_STATIC_ALLOCATION</code>  设置为  <code>1</code>  ，则应用程序编写者还必须提供两个回调函数： <code>vApplicationGetIdleTaskMemory()</code>  提供用于 RTOS 空闲任务的内存，以及（如果  <code>configUSE_TIMERS</code>  设置为  <code>1</code>  ） <code>vApplicationGetTimerTaskMemory()</code>  提供用于以下目的的内存： RTOS 守护程序 / 计时器服务任务。</p><p>下面官方提供了示例：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* configSUPPORT_STATIC_ALLOCATION is set to 1, so the application must provide an</pre></td></tr><tr><td data-num="2"></td><td><pre>implementation of vApplicationGetIdleTaskMemory() to provide the memory that is</pre></td></tr><tr><td data-num="3"></td><td><pre>used by the Idle task. */</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">void</span> <span class="token function">vApplicationGetIdleTaskMemory</span><span class="token punctuation">(</span> StaticTask_t <span class="token operator">*</span><span class="token operator">*</span>ppxIdleTaskTCBBuffer<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                                    StackType_t <span class="token operator">*</span><span class="token operator">*</span>ppxIdleTaskStackBuffer<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                                    <span class="token keyword">uint32_t</span> <span class="token operator">*</span>pulIdleTaskStackSize <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">/* If the buffers to be provided to the Idle task are declared inside this</pre></td></tr><tr><td data-num="9"></td><td><pre>function then they must be declared static – otherwise they will be allocated on</pre></td></tr><tr><td data-num="10"></td><td><pre>the stack and so not exists after this function exits. */</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">static</span> StaticTask_t xIdleTaskTCB<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">static</span> StackType_t uxIdleTaskStack<span class="token punctuation">[</span> configMINIMAL_STACK_SIZE <span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">/* Pass out a pointer to the StaticTask_t structure in which the Idle task’s</pre></td></tr><tr><td data-num="15"></td><td><pre>    state will be stored. */</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token operator">*</span>ppxIdleTaskTCBBuffer <span class="token operator">=</span> <span class="token operator">&amp;</span>xIdleTaskTCB<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token comment">/* Pass out the array that will be used as the Idle task’s stack. */</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token operator">*</span>ppxIdleTaskStackBuffer <span class="token operator">=</span> uxIdleTaskStack<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token comment">/* Pass out the size of the array pointed to by *ppxIdleTaskStackBuffer.</pre></td></tr><tr><td data-num="22"></td><td><pre>    Note that, as the array is necessarily of type StackType_t,</pre></td></tr><tr><td data-num="23"></td><td><pre>    configMINIMAL_STACK_SIZE is specified in words, not bytes. */</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token operator">*</span>pulIdleTaskStackSize <span class="token operator">=</span> configMINIMAL_STACK_SIZE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment">/*———————————————————–*/</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token comment">/* configSUPPORT_STATIC_ALLOCATION and configUSE_TIMERS are both set to 1, so the</pre></td></tr><tr><td data-num="29"></td><td><pre>application must provide an implementation of vApplicationGetTimerTaskMemory()</pre></td></tr><tr><td data-num="30"></td><td><pre>to provide the memory that is used by the Timer service task. */</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token keyword">void</span> <span class="token function">vApplicationGetTimerTaskMemory</span><span class="token punctuation">(</span> StaticTask_t <span class="token operator">*</span><span class="token operator">*</span>ppxTimerTaskTCBBuffer<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                                     StackType_t <span class="token operator">*</span><span class="token operator">*</span>ppxTimerTaskStackBuffer<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                                     <span class="token keyword">uint32_t</span> <span class="token operator">*</span>pulTimerTaskStackSize <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token comment">/* If the buffers to be provided to the Timer task are declared inside this</pre></td></tr><tr><td data-num="36"></td><td><pre>function then they must be declared static – otherwise they will be allocated on</pre></td></tr><tr><td data-num="37"></td><td><pre>the stack and so not exists after this function exits. */</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token keyword">static</span> StaticTask_t xTimerTaskTCB<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token keyword">static</span> StackType_t uxTimerTaskStack<span class="token punctuation">[</span> configTIMER_TASK_STACK_DEPTH <span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token comment">/* Pass out a pointer to the StaticTask_t structure in which the Timer</pre></td></tr><tr><td data-num="42"></td><td><pre>    task’s state will be stored. */</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token operator">*</span>ppxTimerTaskTCBBuffer <span class="token operator">=</span> <span class="token operator">&amp;</span>xTimerTaskTCB<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token comment">/* Pass out the array that will be used as the Timer task’s stack. */</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token operator">*</span>ppxTimerTaskStackBuffer <span class="token operator">=</span> uxTimerTaskStack<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token comment">/* Pass out the size of the array pointed to by *ppxTimerTaskStackBuffer.</pre></td></tr><tr><td data-num="49"></td><td><pre>    Note that, as the array is necessarily of type StackType_t,</pre></td></tr><tr><td data-num="50"></td><td><pre>    configTIMER_TASK_STACK_DEPTH is specified in words, not bytes. */</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token operator">*</span>pulTimerTaskStackSize <span class="token operator">=</span> configTIMER_TASK_STACK_DEPTH<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token comment">/*</pre></td></tr><tr><td data-num="55"></td><td><pre> * Examples of the callback functions that must be provided by the application to</pre></td></tr><tr><td data-num="56"></td><td><pre> * supply the RAM used by the Idle and Timer Service tasks if </pre></td></tr><tr><td data-num="57"></td><td><pre> * configSUPPORT_STATIC_ALLOCATION is set to 1.</pre></td></tr><tr><td data-num="58"></td><td><pre> */</span></pre></td></tr></table></figure><p>有关更多信息，请参见 <span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL1N0YXRpY19Wc19EeW5hbWljX01lbW9yeV9BbGxvY2F0aW9uLmh0bWw=">Static Vs Dynamic Memory Allocation</span> 页面。</p><p><strong>32、configSUPPORT_DYNAMIC_ALLOCATION</strong></p><p>置  <code>1</code>  （或未定义）：可以使用从 FreeRTOS 堆自动分配的 RAM 创建 RTOS 对象；</p><p>置  <code>0</code>  ：只能使用应用程序编写器提供的 RAM 创建 RTOS 对象。</p><p>有关更多信息，请参见 <span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL1N0YXRpY19Wc19EeW5hbWljX01lbW9yeV9BbGxvY2F0aW9uLmh0bWw=">Static Vs Dynamic Memory Allocation</span> 页面。</p><p><strong>33、configTOTAL_HEAP_SIZE</strong></p><p>FreeRTOS 堆中可用的 RAM 总量；仅当 <span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL2EwMDExMC5odG1sI2NvbmZpZ1NVUFBPUlRfRFlOQU1JQ19BTExPQ0FUSU9O">configSUPPORT_DYNAMIC_ALLOCATION</span> 设置为  <code>1</code>  且应用程序使用 FreeRTOS 源代码下载中的四个堆内存分配方案之一（  <code>heap_1.c</code>  、 <code>heap_2.c</code>  、 <code>heap_4.c</code>  或  <code>heap_5.c</code>  ）时，才使用此值。</p><p>注意，当使用  <code>heap_3</code>  时，该值的设置无效。</p><p>有关更多详细信息，请参见 <span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL2EwMDExMS5odG1s">内存配置</span> 部分。</p><p><strong>34、configAPPLICATION_ALLOCATED_HEAP</strong></p><p>默认情况下，<span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL2EwMDExMS5odG1s">FreeRTOS 堆</span> 由 FreeRTOS 声明，并由链接器放置在内存中；将  <code>configAPPLICATION_ALLOCATED_HEAP</code>  设置为  <code>1</code>  可以使堆改为由应用程序编写者声明，这允许应用程序编写者将堆放置在内存中任意位置。</p><p>如果使用  <code>heap_1.c</code>  、 <code>heap_2.c</code>  或  <code>heap_4.c</code>  ，并且  <code>configAPPLICATION_ALLOCATED_HEAP</code>  设置为  <code>1</code>  ，那么应用程序编写者必须提供一个  <code>uint8_t</code>  类型的数组，其名称和维数如下所示；该数组将用作 FreeRTOS 堆：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">uint8_t</span> ucHeap <span class="token punctuation">[</span>configTOTAL_HEAP_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>如何将数组放置在特定的内存位置取决于所使用的编译器，请参阅编译器的文档。</p><p><strong>35、configGENERATE_RUN_TIME_STATS</strong></p><p>该 <span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL3J0b3MtcnVuLXRpbWUtc3RhdHMuaHRtbA==">Run Time Stats</span> 页面描述了此参数的用法。</p><p><strong>36、configUSE_CO_ROUTINES</strong></p><p>置  <code>1</code>  ：使用协程；</p><p>置  <code>0</code>  ：不使用协程。</p><p>如果使用协程，必须在工程中包含  <code>croutine.c</code>  文件。</p><p>注意：协程（Co-routines）主要用于资源发非常受限的嵌入式系统（RAM 非常少），通常不会用于 32 位微处理器；<strong>在当前嵌入式硬件环境下，不建议使用协程，FreeRTOS 的开发者早已经停止开发协程</strong> 。</p><p><strong>37、configMAX_CO_ROUTINE_PRIORITIES</strong></p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL2NvLXJvdXRpbmUtcHJpb3JpdGllcy5odG1s">应用程序协程（Co-routines）的有效优先级数目</span> 。任意数量的协同例程可以共享相同的优先级，使用协程可以单独的分配给任务优先级，请参阅  <code>configMAX_PRIORITIES</code>  。</p><p><strong>38、configUSE_TIMERS</strong></p><p>置  <code>1</code>  ：使用软件定时器；</p><p>置  <code>0</code>  ：不使用软件定时器</p><p>有关完整说明，请参见 <span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL1JUT1Mtc29mdHdhcmUtdGltZXIuaHRtbA==">FreeRTOS software timers</span> 页面。</p><p><strong>39、configTIMER_TASK_PRIORITY</strong></p><p>设置软件计时器服务 / 守护程序任务的优先级。</p><p>有关完整说明，请参见 <span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL1JUT1Mtc29mdHdhcmUtdGltZXIuaHRtbA==">FreeRTOS software timers</span> 页面。</p><p><strong>40、configTIMER_QUEUE_LENGTH</strong></p><p>设置软件计时器命令队列的长度。</p><p>有关完整说明，请参见 <span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL1JUT1Mtc29mdHdhcmUtdGltZXIuaHRtbA==">FreeRTOS software timers</span> 页面。</p><p><strong>41、configTIMER_TASK_STACK_DEPTH</strong></p><p>设置分配给软件计时器服务 / 守护程序任务的堆栈深度。</p><p>有关完整说明，请参见 <span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL1JUT1Mtc29mdHdhcmUtdGltZXIuaHRtbA==">FreeRTOS software timers</span> 页面。</p><p><strong>42、configKERNEL_INTERRUPT_PRIORITY 、configMAX_SYSCALL_INTERRUPT_PRIORITY 和 configMAX_API_CALL_INTERRUPT_PRIORITY</strong></p><p>包含  <code>configKERNEL_INTERRUPT_PRIORITY</code>  设置的硬件端口有 ARM Cortex-M3，PIC24，dsPIC，PIC32，SuperH 和 RX600。</p><p>包含  <code>configMAX_SYSCALL_INTERRUPT_PRIORITY</code>  设置的硬件端口有 PIC32，RX600，ARM Cortex-A 和 ARM Cortex-M。</p><p><code>configMAX_API_CALL_INTERRUPT_PRIORITY</code>  是  <code>configMAX_SYSCALL_INTERRUPT_PRIORITY</code>  的新名称，仅由较新的端口使用，两者是等效的。</p><p><code>configKERNEL_INTERRUPT_PRIORITY</code>  应该设置为最低优先级。</p><p>请注意，在以下讨论中，只能从中断服务例程中调用以 “FromISR” 结尾的 API 函数。</p><p>对于仅支持  <code>configKERNEL_INTERRUPT_PRIORITY</code>  的硬件端口：<br /> <code>configKERNEL_INTERRUPT_PRIORITY</code>  设置 RTOS 内核本身使用的中断优先级。调用 API 函数的中断也必须以此优先级执行。不调用 API 函数的中断可以以更高的优先级执行，因此不会因 RTOS 内核活动（在硬件本身的限制内）而延迟执行。</p><p>对于同时支持  <code>configKERNEL_INTERRUPT_PRIORITY</code>  和  <code>configMAX_SYSCALL_INTERRUPT_PRIORITY</code>  的硬件端口：<br /> <code>configKERNEL_INTERRUPT_PRIORITY</code>  设置 RTOS 内核本身使用的中断优先级。 <code>configMAX_SYSCALL_INTERRUPT_PRIORITY</code>  设置最高的中断优先级，从中可以调用中断安全的 FreeRTOS API 函数。</p><p>通过设置  <code>configMAX_SYSCALL_INTERRUPT_PRIORITY</code>  的优先级级别高于  <code>configKERNEL_INTERRUPT_PRIORITY</code>  可以实现完整的中断嵌套模式；<strong>这意味着即使在关键部分内部，FreeRTOS 内核也不会完全禁用中断</strong> 。</p><p>此外，这对于分段内核架构的微处理器是有利的。但是请注意，当一个新的中断被接受时，某些微控制器体系结构（在硬件中）将禁用中断，这意味着在硬件接受中断和 FreeRTOS 代码重新启用中断之间的短时间内不可避免地禁用中断。</p><p>不调用 API 函数的中断可以以高于  <code>configMAX_SYSCALL_INTERRUPT_PRIORITY</code>  的优先级执行，因此不会因 RTOS 内核执行而延迟。</p><p>例如：假设一个微控制器有 8 个中断优先级别：0 表示最低优先级，7 表示最高优先级（Cortex-M3 和 Cortex-M4 内核优先数和优先级别正好与之相反，后续文章会专门介绍它们）下在图描述了如果将两个配置常量设置为 4 和 0，则在每个优先级上可以做什么和不能做什么，如下所示：</p><p><img data-src="20200217155104470.png" alt="img" /></p><p>这些配置参数允许非常灵活的中断处理：</p><ul><li>在系统中可以像其它任务一样为中断处理任务分配优先级。这些任务通过一个相应中断唤醒。中断服务程序（ISR）本身应写得尽可能短，仅用于更新数据然后唤醒高优先级任务；然后，ISR 退出后，直接运行被唤醒的任务，因此中断处理（根据中断获取的数据来进行的相应处理）在时间上是连续的，就像 ISR 在完成这些工作。这样做的好处是，在执行处理程序任务时，所有中断都保持启用状态。</li><li>支持  <code>configMAX_SYSCALL_INTERRUPT_PRIORITY</code>  的硬件端口将进一步扩展：允许使用完全嵌套的模型，其中 RTOS 内核中断优先级和  <code>configMAX_SYSCALL_INTERRUPT_PRIORITY</code>  之间的中断可以嵌套并允许调用 API 函数；而优先级高于 <code>configMAX_SYSCALL_INTERRUPT_PRIORITY</code>  的中断不会因 RTOS 内核活动而延迟。</li><li>在最高系统调用优先级之上运行的 ISR（大于  <code>configMAX_SYSCALL_INTERRUPT_PRIORITY</code>  的优先级中断）不会被 RTOS 内核本身掩盖，因此它们的响应能力不受 RTOS 内核功能的影响。对于要求非常高的时间精度的中断（例如，执行电机转向的中断）而言，这是理想的选择；但是，在这类中断的中断服务例程中绝不可以调用 FreeRTOS 的 API 函数。</li></ul><p>要使用此方案，您的应用程序设计必须遵守以下规则：<strong>使用 FreeRTOS API 的任何中断必须设置为与 RTOS 内核相同的优先级（由  <code>configKERNEL_INTERRUPT_PRIORITY</code>  宏配置）；或者对于包含支持  <code>configMAX_SYSCALL_INTERRUPT_PRIORITY</code>  功能的硬件端口，设置低于  <code>configMAX_SYSCALL_INTERRUPT_PRIORITY</code>  定义的优先级</strong></p><p>针对 ARM Cortex-M3 和 ARM Cortex-M4 用户的特别说明：请阅读 <span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL1JUT1MtQ29ydGV4LU0zLU00Lmh0bWw=">专门介绍 ARM Cortex-M 设备上的中断优先级设置的页面</span> 。至少要记住，ARM Cortex-M3 内核使用数字低优先级数字来表示高优先级中断，这看起来似乎违反直觉，而且很容易忘记！如果您希望为中断分配一个低优先级，请不要为其分配优先级 0（或其他低数值），因为这可能导致在系统中实际上是具有最高优先级中断的；因此，如果这个优先级高于  <code>configMAX_SYSCALL_INTERRUPT_PRIORITY</code>  ，将会导致系统崩溃。</p><p>实际上，ARM Cortex-M3 内核的最低优先级为 255，但是，不同的 ARM Cortex-M3 供应商实现了不同数量的优先级位，并提供了期望以不同方式指定优先级的库函数。例如，在 STM32 上，您可以在 ST 驱动程序库调用中，根据实际情况把最低优先级指定为 15，而最高优先级为 0。</p><p>总结一下就是，在 FreeRtos 中调用中断关闭和中断开启 API 函数（例如在临界区区域内），其控制只对  <code>configKERNEL_INTERRUPT_PRIORITY</code>  到  <code>configMAX_SYSCALL_INTERRUPT_PRIORITY</code>  之间的优先级有效，其余的中断不受影响</p><p><strong>43、configASSERT</strong></p><p><code>configASSERT()</code>  宏的语义与标准 C  <code>assert()</code>  宏相同。如果传递给  <code>configASSERT()</code>  的参数为零，则触发断言。</p><p>在整个 FreeRTOS 源文件中都会调用  <code>configASSERT()</code>  来检查应用程序是如何使用 FreeRTOS；因此强烈建议使用定义的  <code>configASSERT()</code>  开发 FreeRTOS 应用程序。</p><p>举一个例子，我们想把非法参数所在的文件名和代码行数打印出来，可以先定义一个函数  <code>vAssertCalled</code>  ，并传入触发  <code>configASSERT()</code>  调用的文件名和行号（__FILE__和 __LINE__是大多数编译器提供的标准宏）：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* Define configASSERT() to call vAssertCalled() if the assertion fails.  The assertion</pre></td></tr><tr><td data-num="2"></td><td><pre>has failed if the value of the parameter passed into configASSERT() equals zero. */</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">configASSERT</span><span class="token expression"><span class="token punctuation">(</span> <span class="token punctuation">(</span> x <span class="token punctuation">)</span> <span class="token punctuation">)</span>     <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> x <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token function">vAssertCalled</span><span class="token punctuation">(</span> <span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span> <span class="token punctuation">)</span></span></span></pre></td></tr></table></figure><p>这里只是为了演示，因为  <code>vAssertCalled()</code>  不是 FreeRTOS 里面的函数，可以将  <code>configASSERT()</code>  定义为采取应用程序编写者认为适当的任何操作。通常以这样的方式定义  <code>configASSERT()</code>  ，它可以防止应用程序进一步执行；这有两个原因：在断言停止的地方，应用程序编写者可以调试产生断言的原因；若继续执行触发断言之后的程序可能会导致系统崩溃。</p><p>请注意，定义  <code>configASSERT()</code>  会增加应用程序代码的大小和执行时间；当应用程序稳定后，只需注释掉  <code>FreeRTOSConfig.h</code>  中的  <code>configASSERT()</code>  定义，就可以消除额外的开销了。</p><p>如果在调试器的控制下运行 FreeRTOS，则可以把  <code>configASSERT()</code>  定义为禁用中断并处于循环中的状态，如下所示。这将导致在断言测试失败的行上停止代码的运行，应用程序编写者只需要暂停调试器，就会立即将您带到有问题的行，以便您查看失败的原因。</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* Define configASSERT() to disable interrupts and sit in a loop. */</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">configASSERT</span><span class="token expression"><span class="token punctuation">(</span> <span class="token punctuation">(</span> x <span class="token punctuation">)</span> <span class="token punctuation">)</span>     <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> x <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token function">taskDISABLE_INTERRUPTS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></span></span></pre></td></tr></table></figure><p><strong>44、configINCLUDE_APPLICATION_DEFINED_PRIVILEGED_FUNCTIONS</strong></p><p><code>configINCLUDE_APPLICATION_DEFINED_PRIVILEGED_FUNCTIONS</code>  仅由 FreeRTOS MPU 使用。</p><p>如果  <code>configINCLUDE_APPLICATION_DEFINED_PRIVILEGED_FUNCTIONS</code>  设置为  <code>1</code>  ，则应用程序编写者必须提供一个名为 “  <code>application_defined_privileged_functions.h</code>  ” 的头文件，可以在其之中实现应用程序编写者需要以特权模式执行的功能。请注意，尽管扩展名为  <code>.h</code>  ，但头文件应包含 C 函数的实现，而不仅仅是函数的原型。</p><p>在 “  <code>application_defined_privileged_functions.h</code>  ” 中实现的函数必须分别使用  <code>prvRaisePrivilege()</code>  函数和  <code>portRESET_PRIVILEGE()</code>  宏来保存和恢复处理器的特权状态.</p><p>例如，如果库提供的打印功能访问了应用程序编写者无法控制的 RAM，因此无法分配给受内存保护的用户模式任务，则可以使用以下代码将打印功能封装在特权功能中：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">MPU_debug_printf</span><span class="token punctuation">(</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pcMessage <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/* State the privilege level of the processor when the function was called. */</span></pre></td></tr><tr><td data-num="4"></td><td><pre>BaseType_t xRunningPrivileged <span class="token operator">=</span> <span class="token function">prvRaisePrivilege</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">/* Call the library function, which now has access to all RAM. */</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token function">debug_printf</span><span class="token punctuation">(</span> pcMessage <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">/* Reset the processor privilege level to its original value. */</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token function">portRESET_PRIVILEGE</span><span class="token punctuation">(</span> xRunningPrivileged <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>该技术只能在开发过程中使用，而不能在部署过程中使用，因为它会绕过内存保护。</p><h1 id="包含参数"><a class="anchor" href="#包含参数">#</a> 包含参数</h1><p>以 “INCLUDE” 开头的宏允许将实时内核中那些未被应用程序使用的组件从构建中排除，这样可以确保 RTOS 使用的 ROM 或 RAM 不会超出特定嵌入式应用程序所需的数量</p><p>每个宏采用以下形式：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre>INCLUDE_FunctionName</pre></td></tr></table></figure><p>其中 FunctionName 表示可以选择排除的 API 函数（或函数集）</p><p>置  <code>1</code>  ：使用该 API 函数；</p><p>置  <code>0</code>  ：不使用该 API 函数。</p><p>例如，包含  <code>vTaskDelete()</code>  API 函数，请使用：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INCLUDE_vTaskDelete</span>    <span class="token expression"><span class="token number">1</span></span></span></pre></td></tr></table></figure><p>要从构建中排除  <code>vTaskDelete()</code>  ，请使用：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INCLUDE_vTaskDelete</span>    <span class="token expression"><span class="token number">0</span></span></span></pre></td></tr></table></figure><h1 id="配置项裁剪"><a class="anchor" href="#配置项裁剪">#</a> 配置项裁剪</h1><p>在了解完上面的各项参数后，就可以配置了，具体如下：</p><pre><code class="language-Swift">/*    FreeRTOS V9.0.0 - Copyright (C) 2016 Real Time Engineers Ltd.    All rights reserved    VISIT http://www.FreeRTOS.org TO ENSURE YOU ARE USING THE LATEST VERSION.    This file is part of the FreeRTOS distribution.    FreeRTOS is free software; you can redistribute it and/or modify it under    the terms of the GNU General Public License (version 2) as published by the    Free Software Foundation &gt;&gt;&gt;&gt; AND MODIFIED BY &lt;&lt;&lt;&lt; the FreeRTOS exception.    ***************************************************************************    &gt;&gt;!   NOTE: The modification to the GPL is included to allow you to     !&lt;&lt;    &gt;&gt;!   distribute a combined work that includes FreeRTOS without being   !&lt;&lt;    &gt;&gt;!   obliged to provide the source code for proprietary components     !&lt;&lt;    &gt;&gt;!   outside of the FreeRTOS kernel.                                   !&lt;&lt;    ***************************************************************************    FreeRTOS is distributed in the hope that it will be useful, but WITHOUT ANY    WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS    FOR A PARTICULAR PURPOSE.  Full license text is available on the following    link: http://www.freertos.org/a00114.html    ***************************************************************************     *                                                                       *     *    FreeRTOS provides completely free yet professionally developed,    *     *    robust, strictly quality controlled, supported, and cross          *     *    platform software that is more than just the market leader, it     *     *    is the industry's de facto standard.                               *     *                                                                       *     *    Help yourself get started quickly while simultaneously helping     *     *    to support the FreeRTOS project by purchasing a FreeRTOS           *     *    tutorial book, reference manual, or both:                          *     *    http://www.FreeRTOS.org/Documentation                              *     *                                                                       *    ***************************************************************************    http://www.FreeRTOS.org/FAQHelp.html - Having a problem?  Start by reading    the FAQ page &quot;My application does not run, what could be wrong?&quot;.  Have you    defined configASSERT()?    http://www.FreeRTOS.org/support - In return for receiving this top quality    embedded software for free we request you assist our global community by    participating in the support forum.    http://www.FreeRTOS.org/training - Investing in training allows your team to    be as productive as possible as early as possible.  Now you can receive    FreeRTOS training directly from Richard Barry, CEO of Real Time Engineers    Ltd, and the world's leading authority on the world's leading RTOS.    http://www.FreeRTOS.org/plus - A selection of FreeRTOS ecosystem products,    including FreeRTOS+Trace - an indispensable productivity tool, a DOS    compatible FAT file system, and our tiny thread aware UDP/IP stack.    http://www.FreeRTOS.org/labs - Where new FreeRTOS products go to incubate.    Come and try FreeRTOS+TCP, our new open source TCP/IP stack for FreeRTOS.    http://www.OpenRTOS.com - Real Time Engineers ltd. license FreeRTOS to High    Integrity Systems ltd. to sell under the OpenRTOS brand.  Low cost OpenRTOS    licenses offer ticketed support, indemnification and commercial middleware.    http://www.SafeRTOS.com - High Integrity Systems also provide a safety    engineered and independently SIL3 certified version for use in safety and    mission critical applications that require provable dependability.    1 tab == 4 spaces!*/#ifndef FREERTOS_CONFIG_H#define FREERTOS_CONFIG_H/*----------------------------------------------------------- * Application specific definitions. * * These definitions should be adjusted for your particular hardware and * application requirements. * * THESE PARAMETERS ARE DESCRIBED WITHIN THE 'CONFIGURATION' SECTION OF THE * FreeRTOS API DOCUMENTATION AVAILABLE ON THE FreeRTOS.org WEB SITE.  * * See http://www.freertos.org/a00110.html. *----------------------------------------------------------*//* Here is a good place to include header files that are required acrossyour application. */// #include &quot;stm32f10x.h&quot;#if defined(__ICCARM__) || defined(__CC_ARM) || defined(__GNUC__)    /* Clock manager provides in this variable system core clock frequency */    #include &lt;stdint.h&gt;#include &lt;stdio.h&gt;    extern uint32_t SystemCoreClock;#endif#define configUSE_PREEMPTION                    1#define configUSE_PORT_OPTIMISED_TASK_SELECTION 1#define configUSE_TICKLESS_IDLE                 0#define configCPU_CLOCK_HZ                      ( ( unsigned long ) SystemCoreClock )#define configTICK_RATE_HZ                      ( ( TickType_t ) 1000 )#define configMAX_PRIORITIES                    ( 5 )#define configMINIMAL_STACK_SIZE                ( ( unsigned short ) 128 )#define configMAX_TASK_NAME_LEN                 ( 16 )#define configUSE_16_BIT_TICKS                  0#define configIDLE_SHOULD_YIELD                 1#define configUSE_TASK_NOTIFICATIONS            1#define configUSE_MUTEXES                       0#define configUSE_RECURSIVE_MUTEXES             0#define configUSE_COUNTING_SEMAPHORES           0#define configUSE_ALTERNATIVE_API               0 /* Deprecated! */#define configQUEUE_REGISTRY_SIZE               10#define configUSE_QUEUE_SETS                    0#define configUSE_TIME_SLICING                  1#define configUSE_NEWLIB_REENTRANT              0#define configENABLE_BACKWARD_COMPATIBILITY     0#define configNUM_THREAD_LOCAL_STORAGE_POINTERS 5#define configSTACK_DEPTH_TYPE                  uint16_t#define configMESSAGE_BUFFER_LENGTH_TYPE        size_t/* Memory allocation related definitions. */#define configSUPPORT_STATIC_ALLOCATION         0#define configSUPPORT_DYNAMIC_ALLOCATION        1#define configTOTAL_HEAP_SIZE                   ( ( size_t ) ( 17 * 1024 ) )#define configAPPLICATION_ALLOCATED_HEAP        0/* Hook function related definitions. */#define configUSE_IDLE_HOOK                     0#define configUSE_TICK_HOOK                     0#define configCHECK_FOR_STACK_OVERFLOW          0#define configUSE_MALLOC_FAILED_HOOK            0#define configUSE_DAEMON_TASK_STARTUP_HOOK      0/* Run time and task stats gathering related definitions. */#define configGENERATE_RUN_TIME_STATS           0#define configUSE_TRACE_FACILITY                0#define configUSE_STATS_FORMATTING_FUNCTIONS    1/* Co-routine related definitions. */#define configUSE_CO_ROUTINES                   0#define configMAX_CO_ROUTINE_PRIORITIES         ( 2 )/* Software timer related definitions. */#define configUSE_TIMERS                        0#define configTIMER_TASK_PRIORITY               (configMAX_PRIORITIES-1)#define configTIMER_QUEUE_LENGTH                10#define configTIMER_TASK_STACK_DEPTH            (configMINIMAL_STACK_SIZE*2)/* Interrupt nesting behaviour configuration. */#ifdef __NVIC_PRIO_BITS/* user add */#define configPRIO_BITS       __NVIC_PRIO_BITS#else#define configPRIO_BITS       4                  #endif /* __NVIC_PRIO_BITS *//* This is the value being used as per the ST library which permits 16priority values, 0 to 15.  This must correspond to theconfigKERNEL_INTERRUPT_PRIORITY setting.  Here 15 corresponds to the lowestNVIC value of 255. */#define configLIBRARY_KERNEL_INTERRUPT_PRIORITY15// user add#define configLIBRARY_MAX_SYSCALL_INTERRUPT_PRIORITY11// user add/* This is the raw value as per the Cortex-M3 NVIC.  Values can be 255(lowest) to 0 (1?) (highest). *//* equivalent to 0xf0, or NVIC 240. */#define configKERNEL_INTERRUPT_PRIORITY         (configLIBRARY_KERNEL_INTERRUPT_PRIORITY &lt;&lt; (8 - configPRIO_BITS))//[dependent of processor]/* !!!! configMAX_SYSCALL_INTERRUPT_PRIORITY must not be set to zero !!!! *//* equivalent to 0xb0, or priority 11. */#define configMAX_SYSCALL_INTERRUPT_PRIORITY    (configLIBRARY_MAX_SYSCALL_INTERRUPT_PRIORITY &lt;&lt; (8 - configPRIO_BITS))//[dependent on processor and application]#define configMAX_API_CALL_INTERRUPT_PRIORITY   //[dependent on processor and application]/* Define to trap errors during development. */#define vAssertCalled(char, int)printf(&quot;Error:%s,%d\r\n&quot;,char,int)// user add//#define configASSERT( ( x ) ) if( ( x ) == 0 )vAssertCalled( __FILE__, __LINE__ )#define configASSERT( x )  if( ( x ) == 0 ) vAssertCalled(__FILE__,__LINE__)// The user needs to modify/* FreeRTOS MPU specific definitions. */#define configINCLUDE_APPLICATION_DEFINED_PRIVILEGED_FUNCTIONS 0/* Optional functions - most linkers will remove unused functions anyway. */#define INCLUDE_vTaskPrioritySet                1#define INCLUDE_uxTaskPriorityGet               1#define INCLUDE_vTaskDelete                     1#define INCLUDE_vTaskSuspend                    1#define INCLUDE_xResumeFromISR                  1#define INCLUDE_vTaskDelayUntil                 1#define INCLUDE_vTaskDelay                      1#define INCLUDE_xTaskGetSchedulerState          1#define INCLUDE_xTaskGetCurrentTaskHandle       1#define INCLUDE_uxTaskGetStackHighWaterMark     0#define INCLUDE_xTaskGetIdleTaskHandle          0#define INCLUDE_eTaskGetState                   1#define INCLUDE_xEventGroupSetBitFromISR        1#define INCLUDE_xTimerPendFunctionCall          0#define INCLUDE_xTaskAbortDelay                 0#define INCLUDE_xTaskGetHandle                  0#define INCLUDE_xTaskResumeFromISR              1/* A header file that defines trace macro can be included here. */#define xPortPendSVHandler   PendSV_Handler#define xPortSysTickHandler SysTick_Handler#define vPortSVCHandler      SVC_Handler#endif /* FREERTOS_CONFIG_H */</code></pre><p>然后，值得注意的是，在 Cortex-M3 硬件端口下，FreeRTOS 使用 SysTick 作为系统节拍时钟，使用 SVC 和 PendSVC 进行上下文切换；异常中断服务代码位于 port.c 文件中，FreeRTOS 的作者已经为各种架构的 CPU 写好了这些代码，可以直接拿来用，因此我们只需要进行更改调用；这里有两种方法：</p><ul><li><strong>第一种是在 Cortex-M3 启动文件中进行替换，将这些异常中断入口地址挂接到启动代码中</strong></li></ul><p><img data-src="20200217153706659.png" alt="img" /></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre>DCD     SVC_Handler            换成：   DCD     vPortSVCHandler</pre></td></tr><tr><td data-num="2"></td><td><pre>DCD     PendSV_Handler         换成：   DCD     xPortPendSVHandler</pre></td></tr><tr><td data-num="3"></td><td><pre>DCD     SysTick_Handler        换成：   DCD     xPortSysTickHandler</pre></td></tr></table></figure><p>在方框中，按照上面的信息把向量地址名替换掉</p><ul><li><strong>第二种是利用宏重定义一下，并且要把 ST 官方预留的中断屏蔽掉，转而使用 FreeRTOS 中实现的函数功能</strong></li></ul><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">xPortPendSVHandler</span>   <span class="token expression">PendSV_Handler</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">xPortSysTickHandler</span> <span class="token expression">SysTick_Handler</span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">vPortSVCHandler</span>      <span class="token expression">SVC_Handler</span></span></pre></td></tr></table></figure><p>在  <code>FreeRTOSConfig.h</code>  头文件中添加以上宏，看上面给出的应用代码，然后再注释掉 ST 预留的中断函数：</p><p><img data-src="20200217154404470.png" alt="img" /></p><p>在这里是利用了宏  <code>_FreeRTOS</code>  来管理，当然你也可以直接注释，又或者设置成弱定义函数，随你喜欢，只要不出现重命名就好了。</p>]]></content>
      
      
      <categories>
          
          <category> FreeRTOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> history </tag>
            
            <tag> RTOS </tag>
            
            <tag> FreeRTOS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FreeRTOS 篇章之 heap堆内存分配分析</title>
      <link href="/docs/RTOS/FreeRTOS%20%E7%AF%87%E7%AB%A0%E4%B9%8B%20heap%E5%A0%86%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%88%86%E6%9E%90/"/>
      <url>/docs/RTOS/FreeRTOS%20%E7%AF%87%E7%AB%A0%E4%B9%8B%20heap%E5%A0%86%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1 id="freertos内存分配选择"><a class="anchor" href="#freertos内存分配选择">#</a> FreeRTOS 内存分配选择</h1><p>在 FreeRTOS 中，可以用静态（不使用 FreeRTOS 堆）或动态来分配 RTOS 的对象； 因此 FreeRTOS 中提供了 5 种堆管理方案，这些方案的复杂性和功能使得它的使用范围广泛，当然用户也可以自己实现堆管理；在官方的例程中，动静态的使用选择可以通过使能宏  <code>configSUPPORT_STATIC_ALLOCATION</code>  和宏  <code>configSUPPORT_DYNAMIC_ALLOCATION</code>  来进行决定（官方默认是使用动态内存进行分配的），当然，前提是使用 FreeRTOS 提供的 heap 堆分配的其中一个文件，而不是用自己实现的堆管理；甚至你还可以两种方法都在同一 RTOS 应用程序中使用。</p><h1 id="静态与动态内存分配"><a class="anchor" href="#静态与动态内存分配">#</a> 静态与动态内存分配</h1><p>V9.0.0 之前的 FreeRTOS 版本是从特殊的 FreeRTOS 堆中（也就是这几个  <code>heap</code>  文件）分配下面列出的 RTOS 对象使用的内存。而在 FreeRTOS V9.0.0 及更高版本中，人们可以自己实现堆管理提供内存，从而可以选择创建以下对象，而无需动态分配任何内存：</p><ul><li>任务</li><li>软件计时器</li><li>队列</li><li>事件</li><li>二值信号量</li><li>计数信号量</li><li>递归信号量</li><li>互斥量</li></ul><p><strong>1、使用动态分配的 RAM 创建 RTOS 对象</strong></p><p>动态创建 RTOS 对象的好处是可以更加简单、并有可能尽最大程度地减少应用程序的最大 RAM 使用量</p><p>如果  <code>configSUPPORT_DYNAMIC_ALLOCATION</code>  设置为 1 或未定义，以下 API 函数将使用动态分配的 RAM 创建 RTOS 对象：</p><ul><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL2EwMDEyNS5odG1s">xTaskCreate()</span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL2EwMDExNi5odG1s">xQueueCreate()</span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL0ZyZWVSVE9TLXRpbWVycy14VGltZXJDcmVhdGUuaHRtbA==">xTimerCreate()</span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL3hFdmVudEdyb3VwQ3JlYXRlLmh0bWw=">xEventGroupCreate()</span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL3hTZW1hcGhvcmVDcmVhdGVCaW5hcnkuaHRtbA==">xSemaphoreCreateBinary()</span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL0NyZWF0ZUNvdW50aW5nLmh0bWw=">xSemaphoreCreateCounting()</span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL0NyZWF0ZU11dGV4Lmh0bWw=">xSemaphoreCreateMutex()</span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL3hTZW1hcGhvcmVDcmVhdGVSZWN1cnNpdmVNdXRleC5odG1s">xSemaphoreCreateRecursiveMutex()</span></li></ul><p><strong>2、使用静态分配的 RAM 创建 RTOS 对象</strong></p><p>使用静态分配的 RAM 创建 RTOS 对象的好处是为应用程序编写者提供了更多控制权</p><p>下列 API 函数（如果  <code>configSUPPORT_STATIC_ALLOCATION</code>  设置为 1 时可用）允许使用应用程序编写者实现的堆管理创建 RTOS 对象。为了提供内存，应用程序编写者只需要声明一个适当对象类型的变量，然后将变量的地址传递给 RTOS API 函数即可。官方也提供了 <span class="exturl" data-url="aHR0cHM6Ly9zb3VyY2Vmb3JnZS5uZXQvcC9mcmVlcnRvcy9jb2RlL0hFQUQvdHJlZS90cnVuay9GcmVlUlRPUy9EZW1vL0NvbW1vbi9NaW5pbWFsL1N0YXRpY0FsbG9jYXRpb24uYw==">StaticAllocation.c</span> 标准的演示 / 测试任务来演示如何使用这些功能：</p><ul><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL3hUYXNrQ3JlYXRlU3RhdGljLmh0bWw=">xTaskCreateStatic()</span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL3hRdWV1ZUNyZWF0ZVN0YXRpYy5odG1s">xQueueCreateStatic()</span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL3hUaW1lckNyZWF0ZVN0YXRpYy5odG1s">xTimerCreateStatic()</span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL3hFdmVudEdyb3VwQ3JlYXRlU3RhdGljLmh0bWw=">xEventGroupCreateStatic()</span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL3hTZW1hcGhvcmVDcmVhdGVCaW5hcnlTdGF0aWMuaHRtbA==">xSemaphoreCreateBinaryStatic()</span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL3hTZW1hcGhvcmVDcmVhdGVDb3VudGluZ1N0YXRpYy5odG1s">xSemaphoreCreateCountingStatic()</span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL3hTZW1hcGhvcmVDcmVhdGVNdXRleFN0YXRpYy5odG1s">xSemaphoreCreateMutexStatic()</span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL3hTZW1hcGhvcmVDcmVhdGVSZWN1cnNpdmVNdXRleFN0YXRpYy5odG1s">xSemaphoreCreateRecursiveMutexStatic()</span></li></ul><h1 id="内存管理"><a class="anchor" href="#内存管理">#</a> 内存管理</h1><p>如果 RTOS 对象是动态创建的，则有时可以使用标准 C 库  <code>malloc()</code>  和  <code>free()</code>  函数来实现此目的，但是 …</p><ol><li>它们并不总是在嵌入式系统上可用；</li><li>他们占用了宝贵的代码空间；</li><li>它们不是线程安全的；</li><li>它们不是确定性的（执行函数所花费的时间因调用而异）。</li></ol><p>因此，通常需要另一种内存分配实现。</p><p>一个嵌入式 / 实时系统可能具有与另一个系统不同的 RAM 和时序要求；因此，单个 RAM 分配算法仅适用于部分应用程序。</p><p>为了解决这个问题，FreeRTOS 将内存分配 API 保留在其可移植层中；当 RTOS 内核需要 RAM 时，它不调用  <code>malloc()</code> ，而是调用  <code>pvPortMalloc()</code>  ；当释放 RAM 时，RTOS 内核将调用  <code>vPortFree()</code>  而不是调用  <code>free()</code>  。</p><p>在  <code>FreeRTOSv9.0.0\FreeRTOS\Source\portable\MemMang</code>  文档中，FreeRTOS 提供了五个内存分配实现：</p><ul><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL2EwMDExMS5odG1sI2hlYXBfMQ==">heap_1</span> – 最简单，不允许释放内存。</li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL2EwMDExMS5odG1sI2hlYXBfMg==">heap_2</span> – 允许释放内存，但不合并相邻的空闲块。</li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL2EwMDExMS5odG1sI2hlYXBfMw==">heap_3</span> – 简单包装标准  <code>malloc()</code>  和  <code>free()</code>  以确保线程安全。</li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL2EwMDExMS5odG1sI2hlYXBfNA==">heap_4</span> – 合并相邻的空闲块以避免碎片；包括绝对地址放置选项。</li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL2EwMDExMS5odG1sI2hlYXBfNQ==">heap_5</span> – 参照  <code>heap_4</code> ，能够跨多个不相邻的内存区域扩展堆。</li></ul><h2 id="heap_1c"><a class="anchor" href="#heap_1c">#</a> heap_1.c</h2><p>在这个文件中有这么一项注释： <strong>The simplest possible implementation of pvPortMalloc().  Note that this implementation does NOT allow allocated memory to be freed again.</strong> 也就是表明了  <code>heap_1.c</code>  这个文件的功能只能进行分配，不支持释放内存。</p><p>它的分配函数实现：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">pvPortMalloc</span><span class="token punctuation">(</span> size_t xWantedSize <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">void</span> <span class="token operator">*</span>pvReturn <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span>pucAlignedHeap <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">/* Ensure that blocks are always aligned to the required number of bytes. */</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span><span class="token expression"><span class="token punctuation">(</span> portBYTE_ALIGNMENT <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> xWantedSize <span class="token operator">&amp;</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">/* Byte alignment required. */</span></pre></td></tr><tr><td data-num="12"></td><td><pre>xWantedSize <span class="token operator">+=</span> <span class="token punctuation">(</span> portBYTE_ALIGNMENT <span class="token operator">-</span> <span class="token punctuation">(</span> xWantedSize <span class="token operator">&amp;</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token function">vTaskSuspendAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> pucAlignedHeap <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment">/* Ensure the heap starts on a correctly aligned boundary. */</span></pre></td></tr><tr><td data-num="22"></td><td><pre>pucAlignedHeap <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> portPOINTER_SIZE_TYPE <span class="token punctuation">)</span> <span class="token operator">&amp;</span>ucHeap<span class="token punctuation">[</span> portBYTE_ALIGNMENT <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span> <span class="token operator">~</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> portPOINTER_SIZE_TYPE <span class="token punctuation">)</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment">/* Check there is enough room left for the allocation. */</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> xNextFreeByte <span class="token operator">+</span> xWantedSize <span class="token punctuation">)</span> <span class="token operator">&lt;</span> configADJUSTED_HEAP_SIZE <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">(</span> <span class="token punctuation">(</span> xNextFreeByte <span class="token operator">+</span> xWantedSize <span class="token punctuation">)</span> <span class="token operator">></span> xNextFreeByte <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">/* Check for overflow. */</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token comment">/* Return the next free byte then increment the index past this</pre></td></tr><tr><td data-num="30"></td><td><pre>block. */</span></pre></td></tr><tr><td data-num="31"></td><td><pre>pvReturn <span class="token operator">=</span> pucAlignedHeap <span class="token operator">+</span> xNextFreeByte<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>xNextFreeByte <span class="token operator">+=</span> xWantedSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token function">traceMALLOC</span><span class="token punctuation">(</span> pvReturn<span class="token punctuation">,</span> xWantedSize <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span> <span class="token function">xTaskResumeAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span><span class="token expression"><span class="token punctuation">(</span> configUSE_MALLOC_FAILED_HOOK <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> pvReturn <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">vApplicationMallocFailedHook</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token function">vApplicationMallocFailedHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token keyword">return</span> pvReturn<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>既然这么简单，就稍微分析一下吧！</p><p>1、首先是对内存对齐的判断，这里，如果内存对齐有效，则执行；如果要分配的内存不是对齐字节 (通常是 8，根据  <code>portBYTE_ALIGNMENT</code>  来确定对齐字节) 的整数倍，则补齐，所以  <code>xWantedSize</code>  要加上要补齐的长度。</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* Ensure that blocks are always aligned to the required number of bytes. */</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span><span class="token expression"><span class="token punctuation">(</span> portBYTE_ALIGNMENT <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> xWantedSize <span class="token operator">&amp;</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">/* Byte alignment required. */</span></pre></td></tr><tr><td data-num="7"></td><td><pre>xWantedSize <span class="token operator">+=</span> <span class="token punctuation">(</span> portBYTE_ALIGNMENT <span class="token operator">-</span> <span class="token punctuation">(</span> xWantedSize <span class="token operator">&amp;</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr></table></figure><p>2、接着挂起所有的调度器，防止在分配内存的过程中被打断。</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">vTaskSuspendAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>3、判断是否为第一次分配，若是，则检查初分配的内存是否有对齐，这里  <code>uheap</code>  是一个静态数组（是 FreeRTOS 为我们申请的一个内存堆，大小由宏  <code>configTOTAL_HEAP_SIZE</code>  决定），首先要确保它是否对齐，因为  <code>uheap</code>  的首地址可能不是 8 的倍数，若是没有对齐，那么进行对齐处理，以确保实际开始分配的地址是对齐的，值得留意的是，这个对齐处理只做一次。</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> pucAlignedHeap <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/* Ensure the heap starts on a correctly aligned boundary. */</span></pre></td></tr><tr><td data-num="4"></td><td><pre>pucAlignedHeap <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> portPOINTER_SIZE_TYPE <span class="token punctuation">)</span> <span class="token operator">&amp;</span>ucHeap<span class="token punctuation">[</span> portBYTE_ALIGNMENT <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span> <span class="token operator">~</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> portPOINTER_SIZE_TYPE <span class="token punctuation">)</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>4、在正式分配前进行溢出检查，如果空间够用，则记录新分配空间的首地址到  <code>pvReturn</code>  ，并重新记录新的空闲空间的首地址到  <code>NextFreeByte</code>  。</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* Check there is enough room left for the allocation. */</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> xNextFreeByte <span class="token operator">+</span> xWantedSize <span class="token punctuation">)</span> <span class="token operator">&lt;</span> configADJUSTED_HEAP_SIZE <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">(</span> <span class="token punctuation">(</span> xNextFreeByte <span class="token operator">+</span> xWantedSize <span class="token punctuation">)</span> <span class="token operator">></span> xNextFreeByte <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">/* Check for overflow. */</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">/* Return the next free byte then increment the index past thisblock. */</span></pre></td></tr><tr><td data-num="6"></td><td><pre>pvReturn <span class="token operator">=</span> pucAlignedHeap <span class="token operator">+</span> xNextFreeByte<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>xNextFreeByte <span class="token operator">+=</span> xWantedSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>5、 <code>traceMALLOC( pvReturn, xWantedSize )</code>  是一个宏，用于输出内存分配的调试信息，这个宏定义在  <code>FreeRTOS.h</code>  中，默认为空，如果需要将这些调试信息输出到串口或其它东西，就可以修改这个宏将信息输出到所需要的地方。</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">traceMALLOC</span><span class="token punctuation">(</span> pvReturn<span class="token punctuation">,</span> xWantedSize <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><img data-src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动" /></p><p>6、最后，恢复之前挂起的调度器</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span> <span class="token function">xTaskResumeAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><img data-src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动" /></p><p>7、这个取决于宏  <code>configUSE_MALLOC_FAILED_HOOK</code>  是否使能，如果开启了分配失败  <code>hook</code>  函数，就调用该  <code>hook</code>  。</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span><span class="token expression"><span class="token punctuation">(</span> configUSE_MALLOC_FAILED_HOOK <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> pvReturn <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">vApplicationMallocFailedHook</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token function">vApplicationMallocFailedHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr></table></figure><p>适用环境以及功能简介：</p><ul><li>如果您的应用程序从不删除任务，队列，信号量，互斥锁等，则可以使用它（实际上涵盖了使用 FreeRTOS 的大多数应用程序）。</li><li>始终是确定性的（总是花费相同的时间来执行），并且不会导致内存碎片。</li><li>它是非常简单的，可以从静态分配的数组中分配内存，这意味着它通常适用于不允许真正的动态内存分配的应用程序。</li></ul><h2 id="heap_2c"><a class="anchor" href="#heap_2c">#</a> heap_2.c</h2><p>此方案使用了最佳适应算法（best fit algorithm），并且与<strong>方案 1</strong> 不同，它允许释放以前分配的块；它不会将相邻的空闲块合并成一个大块。</p><p>同样的，文件里的注释： <strong>A sample implementation of pvPortMalloc() and vPortFree() that permits allocated blocks to be freed, but does not combine adjacent free blocks into a single larger block (and so will fragment memory).</strong> 也就是说现在支持分配和释放内存，但对内存碎片不做处理。</p><p>1、在实现堆分配之前，有一个堆初始化的过程  <code>prvHeapInit()</code>  ，并且只调用一次（就是第一次进入该函数的时候）</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prvHeapInit</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>BlockLink_t <span class="token operator">*</span>pxFirstFreeBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">uint8_t</span> <span class="token operator">*</span>pucAlignedHeap<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">/* Ensure the heap starts on a correctly aligned boundary. */</span></pre></td></tr><tr><td data-num="7"></td><td><pre>pucAlignedHeap <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> portPOINTER_SIZE_TYPE <span class="token punctuation">)</span> <span class="token operator">&amp;</span>ucHeap<span class="token punctuation">[</span> portBYTE_ALIGNMENT <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span> <span class="token operator">~</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> portPOINTER_SIZE_TYPE <span class="token punctuation">)</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">/* xStart is used to hold a pointer to the first item in the list of free</pre></td></tr><tr><td data-num="10"></td><td><pre>blocks.  The void cast is used to prevent compiler warnings. */</span></pre></td></tr><tr><td data-num="11"></td><td><pre>xStart<span class="token punctuation">.</span>pxNextFreeBlock <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pucAlignedHeap<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>xStart<span class="token punctuation">.</span>xBlockSize <span class="token operator">=</span> <span class="token punctuation">(</span> size_t <span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">/* xEnd is used to mark the end of the list of free blocks. */</span></pre></td></tr><tr><td data-num="15"></td><td><pre>xEnd<span class="token punctuation">.</span>xBlockSize <span class="token operator">=</span> configADJUSTED_HEAP_SIZE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>xEnd<span class="token punctuation">.</span>pxNextFreeBlock <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">/* To start with there is a single free block that is sized to take up the</pre></td></tr><tr><td data-num="19"></td><td><pre>entire heap space. */</span></pre></td></tr><tr><td data-num="20"></td><td><pre>pxFirstFreeBlock <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pucAlignedHeap<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>pxFirstFreeBlock<span class="token operator">-></span>xBlockSize <span class="token operator">=</span> configADJUSTED_HEAP_SIZE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>pxFirstFreeBlock<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">=</span> <span class="token operator">&amp;</span>xEnd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这里用到了  <code>BlockLink_t</code>  结构体，这个结构有两个成员，第一个是节点 Next 指针  <code>pxNextFreeBlock</code>  ，第二个是空闲块大小。结构体成员如下：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* Define the linked list structure.  This is used to link free blocks in order</pre></td></tr><tr><td data-num="2"></td><td><pre>of their size. */</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">A_BLOCK_LINK</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">A_BLOCK_LINK</span> <span class="token operator">*</span>pxNextFreeBlock<span class="token punctuation">;</span><span class="token comment">/*&lt;&lt; The next free block in the list. */</span></pre></td></tr><tr><td data-num="6"></td><td><pre>size_t xBlockSize<span class="token punctuation">;</span><span class="token comment">/*&lt;&lt; The size of the free block. */</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span> BlockLink_t<span class="token punctuation">;</span></pre></td></tr></table></figure><p>首先，对开辟的堆进行地址对齐工作，对齐的原因的原理与  <code>heap_1</code>  一样，在获取堆的首地址后，对  <code>xStart</code>  链表头和  <code>xEnd</code>  链表尾进行初始化赋值；在  <code>heap_2</code>  中，与  <code>heap_1</code>  不同的是，由于 FreeRTOS 用空闲块对内存堆进行管理，于是用  <code>BlockLink_t</code>  这一个结构来形成一条空闲块链表对空闲块进行组织和管理。</p><p>2、好了，现在回到  <code>pvPortMalloc()</code>  函数中。</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">pvPortMalloc</span><span class="token punctuation">(</span> size_t xWantedSize <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>BlockLink_t <span class="token operator">*</span>pxBlock<span class="token punctuation">,</span> <span class="token operator">*</span>pxPreviousBlock<span class="token punctuation">,</span> <span class="token operator">*</span>pxNewBlockLink<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">static</span> BaseType_t xHeapHasBeenInitialised <span class="token operator">=</span> pdFALSE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">void</span> <span class="token operator">*</span>pvReturn <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token function">vTaskSuspendAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">/* If this is the first call to malloc then the heap will require</pre></td></tr><tr><td data-num="10"></td><td><pre>initialisation to setup the list of free blocks. */</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> xHeapHasBeenInitialised <span class="token operator">==</span> pdFALSE <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token function">prvHeapInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>xHeapHasBeenInitialised <span class="token operator">=</span> pdTRUE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">/* The wanted size is increased so it can contain a BlockLink_t</pre></td></tr><tr><td data-num="18"></td><td><pre>structure in addition to the requested amount of bytes. */</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> xWantedSize <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>xWantedSize <span class="token operator">+=</span> heapSTRUCT_SIZE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment">/* Ensure that blocks are always aligned to the required number of bytes. */</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> xWantedSize <span class="token operator">&amp;</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment">/* Byte alignment required. */</span></pre></td></tr><tr><td data-num="27"></td><td><pre>xWantedSize <span class="token operator">+=</span> <span class="token punctuation">(</span> portBYTE_ALIGNMENT <span class="token operator">-</span> <span class="token punctuation">(</span> xWantedSize <span class="token operator">&amp;</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> xWantedSize <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> xWantedSize <span class="token operator">&lt;</span> configADJUSTED_HEAP_SIZE <span class="token punctuation">)</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token comment">/* Blocks are stored in byte order - traverse the list from the start</pre></td></tr><tr><td data-num="34"></td><td><pre>(smallest) block until one of adequate size is found. */</span></pre></td></tr><tr><td data-num="35"></td><td><pre>pxPreviousBlock <span class="token operator">=</span> <span class="token operator">&amp;</span>xStart<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>pxBlock <span class="token operator">=</span> xStart<span class="token punctuation">.</span>pxNextFreeBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token keyword">while</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> pxBlock<span class="token operator">-></span>xBlockSize <span class="token operator">&lt;</span> xWantedSize <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> pxBlock<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>pxPreviousBlock <span class="token operator">=</span> pxBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>pxBlock <span class="token operator">=</span> pxBlock<span class="token operator">-></span>pxNextFreeBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token comment">/* If we found the end marker then a block of adequate size was not found. */</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> pxBlock <span class="token operator">!=</span> <span class="token operator">&amp;</span>xEnd <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token comment">/* Return the memory space - jumping over the BlockLink_t structure</pre></td></tr><tr><td data-num="47"></td><td><pre>at its start. */</span></pre></td></tr><tr><td data-num="48"></td><td><pre>pvReturn <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pxPreviousBlock<span class="token operator">-></span>pxNextFreeBlock <span class="token punctuation">)</span> <span class="token operator">+</span> heapSTRUCT_SIZE <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token comment">/* This block is being returned for use so must be taken out of the</pre></td></tr><tr><td data-num="51"></td><td><pre>list of free blocks. */</span></pre></td></tr><tr><td data-num="52"></td><td><pre>pxPreviousBlock<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">=</span> pxBlock<span class="token operator">-></span>pxNextFreeBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token comment">/* If the block is larger than required it can be split into two. */</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> pxBlock<span class="token operator">-></span>xBlockSize <span class="token operator">-</span> xWantedSize <span class="token punctuation">)</span> <span class="token operator">></span> heapMINIMUM_BLOCK_SIZE <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token comment">/* This block is to be split into two.  Create a new block</pre></td></tr><tr><td data-num="58"></td><td><pre>following the number of bytes requested. The void cast is</pre></td></tr><tr><td data-num="59"></td><td><pre>used to prevent byte alignment warnings from the compiler. */</span></pre></td></tr><tr><td data-num="60"></td><td><pre>pxNewBlockLink <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pxBlock <span class="token punctuation">)</span> <span class="token operator">+</span> xWantedSize <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre></pre></td></tr><tr><td data-num="62"></td><td><pre><span class="token comment">/* Calculate the sizes of two blocks split from the single</pre></td></tr><tr><td data-num="63"></td><td><pre>block. */</span></pre></td></tr><tr><td data-num="64"></td><td><pre>pxNewBlockLink<span class="token operator">-></span>xBlockSize <span class="token operator">=</span> pxBlock<span class="token operator">-></span>xBlockSize <span class="token operator">-</span> xWantedSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>pxBlock<span class="token operator">-></span>xBlockSize <span class="token operator">=</span> xWantedSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre></pre></td></tr><tr><td data-num="67"></td><td><pre><span class="token comment">/* Insert the new block into the list of free blocks. */</span></pre></td></tr><tr><td data-num="68"></td><td><pre><span class="token function">prvInsertBlockIntoFreeList</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> pxNewBlockLink <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="70"></td><td><pre></pre></td></tr><tr><td data-num="71"></td><td><pre>xFreeBytesRemaining <span class="token operator">-=</span> pxBlock<span class="token operator">-></span>xBlockSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="73"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="74"></td><td><pre></pre></td></tr><tr><td data-num="75"></td><td><pre><span class="token function">traceMALLOC</span><span class="token punctuation">(</span> pvReturn<span class="token punctuation">,</span> xWantedSize <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="77"></td><td><pre><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span> <span class="token function">xTaskResumeAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre></pre></td></tr><tr><td data-num="79"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span><span class="token expression"><span class="token punctuation">(</span> configUSE_MALLOC_FAILED_HOOK <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="80"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="81"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> pvReturn <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="82"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="83"></td><td><pre><span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">vApplicationMallocFailedHook</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre><span class="token function">vApplicationMallocFailedHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="86"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="87"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="88"></td><td><pre></pre></td></tr><tr><td data-num="89"></td><td><pre><span class="token keyword">return</span> pvReturn<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>同样的，在每次分配空间之前，先挂起调度器，这是没得说的，然后如果是第一次调用  <code>pvPortMalloc()</code>  ，则调用  <code>prvHeapInit()</code>  对内存堆和空闲块链表进行初始化；而下面这段 code：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* The wanted size is increased so it can contain a BlockLink_t</pre></td></tr><tr><td data-num="2"></td><td><pre>structure in addition to the requested amount of bytes. */</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> xWantedSize <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>xWantedSize <span class="token operator">+=</span> heapSTRUCT_SIZE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">/* Ensure that blocks are always aligned to the required number of bytes. */</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> xWantedSize <span class="token operator">&amp;</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">/* Byte alignment required. */</span></pre></td></tr><tr><td data-num="11"></td><td><pre>xWantedSize <span class="token operator">+=</span> <span class="token punctuation">(</span> portBYTE_ALIGNMENT <span class="token operator">-</span> <span class="token punctuation">(</span> xWantedSize <span class="token operator">&amp;</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在用户每申请一次内存，FreeRTOS 都会在申请的空间前加上空闲块头部  <code>BlockLink_t</code>  ，用于记录分配出去的空间的大小，因此，实际分配的内存空间大小就等于用户申请的内存空间大小加上空闲块头部的大小；最后再加上头部之后，还要对整个大小进行对齐。</p><p>下一个  <code>if</code>  判断：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> xWantedSize <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> xWantedSize <span class="token operator">&lt;</span> configADJUSTED_HEAP_SIZE <span class="token punctuation">)</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/* Blocks are stored in byte order - traverse the list from the start</pre></td></tr><tr><td data-num="4"></td><td><pre>(smallest) block until one of adequate size is found. */</span></pre></td></tr><tr><td data-num="5"></td><td><pre>pxPreviousBlock <span class="token operator">=</span> <span class="token operator">&amp;</span>xStart<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>pxBlock <span class="token operator">=</span> xStart<span class="token punctuation">.</span>pxNextFreeBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">while</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> pxBlock<span class="token operator">-></span>xBlockSize <span class="token operator">&lt;</span> xWantedSize <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> pxBlock<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>pxPreviousBlock <span class="token operator">=</span> pxBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>pxBlock <span class="token operator">=</span> pxBlock<span class="token operator">-></span>pxNextFreeBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">/* If we found the end marker then a block of adequate size was not found. */</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> pxBlock <span class="token operator">!=</span> <span class="token operator">&amp;</span>xEnd <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">/* Return the memory space - jumping over the BlockLink_t structure</pre></td></tr><tr><td data-num="17"></td><td><pre>at its start. */</span></pre></td></tr><tr><td data-num="18"></td><td><pre>pvReturn <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pxPreviousBlock<span class="token operator">-></span>pxNextFreeBlock <span class="token punctuation">)</span> <span class="token operator">+</span> heapSTRUCT_SIZE <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">/* This block is being returned for use so must be taken out of the</pre></td></tr><tr><td data-num="21"></td><td><pre>list of free blocks. */</span></pre></td></tr><tr><td data-num="22"></td><td><pre>pxPreviousBlock<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">=</span> pxBlock<span class="token operator">-></span>pxNextFreeBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment">/* If the block is larger than required it can be split into two. */</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> pxBlock<span class="token operator">-></span>xBlockSize <span class="token operator">-</span> xWantedSize <span class="token punctuation">)</span> <span class="token operator">></span> heapMINIMUM_BLOCK_SIZE <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token comment">/* This block is to be split into two.  Create a new block</pre></td></tr><tr><td data-num="28"></td><td><pre>following the number of bytes requested. The void cast is</pre></td></tr><tr><td data-num="29"></td><td><pre>used to prevent byte alignment warnings from the compiler. */</span></pre></td></tr><tr><td data-num="30"></td><td><pre>pxNewBlockLink <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pxBlock <span class="token punctuation">)</span> <span class="token operator">+</span> xWantedSize <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token comment">/* Calculate the sizes of two blocks split from the single</pre></td></tr><tr><td data-num="33"></td><td><pre>block. */</span></pre></td></tr><tr><td data-num="34"></td><td><pre>pxNewBlockLink<span class="token operator">-></span>xBlockSize <span class="token operator">=</span> pxBlock<span class="token operator">-></span>xBlockSize <span class="token operator">-</span> xWantedSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>pxBlock<span class="token operator">-></span>xBlockSize <span class="token operator">=</span> xWantedSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token comment">/* Insert the new block into the list of free blocks. */</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token function">prvInsertBlockIntoFreeList</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> pxNewBlockLink <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>xFreeBytesRemaining <span class="token operator">-=</span> pxBlock<span class="token operator">-></span>xBlockSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>先是判断用户申请的空间大小是否存在（不等于零）以及是否已经超过堆空间大小，若是不符合那就直接 pass 掉了；在这里，块的大小是按从小到大的顺序排列的，因此从一开始遍历列表 (最小的) 块，直到找到一个合适的大小，最后把位置记录下来。</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* If we found the end marker then a block of adequate size was not found. */</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> pxBlock <span class="token operator">!=</span> <span class="token operator">&amp;</span>xEnd <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">/* Return the memory space - jumping over the BlockLink_t structure</pre></td></tr><tr><td data-num="5"></td><td><pre>at its start. */</span></pre></td></tr><tr><td data-num="6"></td><td><pre>pvReturn <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pxPreviousBlock<span class="token operator">-></span>pxNextFreeBlock <span class="token punctuation">)</span> <span class="token operator">+</span> heapSTRUCT_SIZE <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">/* This block is being returned for use so must be taken out of the</pre></td></tr><tr><td data-num="9"></td><td><pre>list of free blocks. */</span></pre></td></tr><tr><td data-num="10"></td><td><pre>pxPreviousBlock<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">=</span> pxBlock<span class="token operator">-></span>pxNextFreeBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">/* If the block is larger than required it can be split into two. */</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> pxBlock<span class="token operator">-></span>xBlockSize <span class="token operator">-</span> xWantedSize <span class="token punctuation">)</span> <span class="token operator">></span> heapMINIMUM_BLOCK_SIZE <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">/* This block is to be split into two.  Create a new block</pre></td></tr><tr><td data-num="16"></td><td><pre>following the number of bytes requested. The void cast is</pre></td></tr><tr><td data-num="17"></td><td><pre>used to prevent byte alignment warnings from the compiler. */</span></pre></td></tr><tr><td data-num="18"></td><td><pre>pxNewBlockLink <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pxBlock <span class="token punctuation">)</span> <span class="token operator">+</span> xWantedSize <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">/* Calculate the sizes of two blocks split from the single</pre></td></tr><tr><td data-num="21"></td><td><pre>block. */</span></pre></td></tr><tr><td data-num="22"></td><td><pre>pxNewBlockLink<span class="token operator">-></span>xBlockSize <span class="token operator">=</span> pxBlock<span class="token operator">-></span>xBlockSize <span class="token operator">-</span> xWantedSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>pxBlock<span class="token operator">-></span>xBlockSize <span class="token operator">=</span> xWantedSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment">/* Insert the new block into the list of free blocks. */</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token function">prvInsertBlockIntoFreeList</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> pxNewBlockLink <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>xFreeBytesRemaining <span class="token operator">-=</span> pxBlock<span class="token operator">-></span>xBlockSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>紧接着，在上面的一段代码里，先是把返回的空间地址值修改（跳过  <code>BlockLink_t</code>  结构），然后把上一个的下一个的节点指向当前下一个的空闲块；后面，若果分配出去的空闲块的剩余空间是比两倍的空闲块头部结构体大小还要大，则将分配出去的这个空闲块分割剩余的空间出来，重新放到空闲块链表中。</p><p>值得注意的是  <code>prvInsertBlockIntoFreeList</code>  这个是个宏，具体实现如下：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/*</pre></td></tr><tr><td data-num="2"></td><td><pre> * Insert a block into the list of free blocks - which is ordered by size of</pre></td></tr><tr><td data-num="3"></td><td><pre> * the block.  Small blocks at the start of the list and large blocks at the end</pre></td></tr><tr><td data-num="4"></td><td><pre> * of the list.</pre></td></tr><tr><td data-num="5"></td><td><pre> */</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">prvInsertBlockIntoFreeList</span><span class="token expression"><span class="token punctuation">(</span> pxBlockToInsert <span class="token punctuation">)</span></span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token expression"><span class="token punctuation">&#123;</span></span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token expression">BlockLink_t <span class="token operator">*</span>pxIterator<span class="token punctuation">;</span></span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token expression">size_t xBlockSize<span class="token punctuation">;</span></span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token expression">xBlockSize <span class="token operator">=</span> pxBlockToInsert<span class="token operator">-></span>xBlockSize<span class="token punctuation">;</span></span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">/* Iterate through the list until a block is found that has a larger size */</span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">/* than the block we are inserting. */</span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token expression"><span class="token keyword">for</span><span class="token punctuation">(</span> pxIterator <span class="token operator">=</span> <span class="token operator">&amp;</span>xStart<span class="token punctuation">;</span> pxIterator<span class="token operator">-></span>pxNextFreeBlock<span class="token operator">-></span>xBlockSize <span class="token operator">&lt;</span> xBlockSize<span class="token punctuation">;</span> pxIterator <span class="token operator">=</span> pxIterator<span class="token operator">-></span>pxNextFreeBlock <span class="token punctuation">)</span></span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token expression"><span class="token punctuation">&#123;</span></span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">/* There is nothing to do here - just iterate to the correct position. */</span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token expression"><span class="token punctuation">&#125;</span></span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">/* Update the list to include the block being inserted in the correct */</span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment">/* position. */</span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token expression">pxBlockToInsert<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">=</span> pxIterator<span class="token operator">-></span>pxNextFreeBlock<span class="token punctuation">;</span></span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token expression">pxIterator<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">=</span> pxBlockToInsert<span class="token punctuation">;</span></span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token expression"><span class="token punctuation">&#125;</span></span></span></pre></td></tr></table></figure><p>这个宏的作用就是将新空闲块插入到合适的链表位置中。</p><p>后面的代码执行就跟  <code>heap_1</code>  一样了，修改剩余空闲块空闲大小  <code>xFreeBytesRemaining</code>  、恢复所有挂起的任务等等。</p><p>3、最后剩下的就是  <code>heap_1</code>  中不支持的  <code>vPortFree()</code>  释放函数了。</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">vPortFree</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span>pv <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">uint8_t</span> <span class="token operator">*</span>puc <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pv<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>BlockLink_t <span class="token operator">*</span>pxLink<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> pv <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">/* The memory being freed will have an BlockLink_t structure immediately</pre></td></tr><tr><td data-num="9"></td><td><pre>before it. */</span></pre></td></tr><tr><td data-num="10"></td><td><pre>puc <span class="token operator">-=</span> heapSTRUCT_SIZE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">/* This unexpected casting is to keep some compilers from issuing</pre></td></tr><tr><td data-num="13"></td><td><pre>byte alignment warnings. */</span></pre></td></tr><tr><td data-num="14"></td><td><pre>pxLink <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">)</span> puc<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token function">vTaskSuspendAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">/* Add this block to the list of free blocks. */</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token function">prvInsertBlockIntoFreeList</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> BlockLink_t <span class="token operator">*</span> <span class="token punctuation">)</span> pxLink <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>xFreeBytesRemaining <span class="token operator">+=</span> pxLink<span class="token operator">-></span>xBlockSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token function">traceFREE</span><span class="token punctuation">(</span> pv<span class="token punctuation">,</span> pxLink<span class="token operator">-></span>xBlockSize <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span> <span class="token function">xTaskResumeAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这一个函数炒鸡简单，而且非常短，首先判断要释放的内存是否为空；若是不为空，则获取这个内存空间真正的的空闲块（剔除头部的  <code>BlockLink_t</code>  结构），然后挂起所有任务，把释放的内存重新插入到空闲块链表中，最后调用调试信息宏，恢复挂起的任务就结束了。</p><p>特点：</p><p>即使应用程序反复删除任务，队列，信号量，互斥量等对象，也可以使用，有关内存碎片的警告如下：</p><ul><li>如果不是，如果被分配和释放内存使用是随机的大小。例如：<ul><li>如果应用程序以动态创建和删除任务，并且分配给正在创建的任务的堆栈大小始终相同，则在大多数情况下可以使用  <code>heap_2.c</code>  ；但是，如果分配给正在创建的任务的堆栈大小并不总是相同，则可用的空闲内存可能会分成许多小块，最终导致分配失败；在这种情况下， <code>heap_4.c</code>  会更好</li><li>如果应用程序以动态创建和删除队列，并且每种情况下队列存储区域都相同（队列存储区域指队列项数目乘以每个队列长度），则在大多数情况下都可以使用  <code>heap_2.c</code>  ；但是，如果队列存储区域在每种情况下都不相同，则可用的空闲内存可能会分成许多小块，最终导致分配失败；在这种情况下， <code>heap_4.c</code>  会更好</li><li>该应用程序直接调用  <code>pvPortMalloc()</code>  和  <code>vPortFree()</code> ，而不仅仅是通过其他 FreeRTOS API 函数间接调用。</li></ul></li><li>如果您的应用程序的队列，任务，信号量，互斥量等处于以不可预测的顺序，则可能会导致内存碎片问题；虽然这是小概率事件，但应牢记。</li><li>不确定型，但比大多数标准 C 库  <code>malloc</code>  实现要有效得多。</li></ul><h2 id="heap_3c"><a class="anchor" href="#heap_3c">#</a> heap_3.c</h2><p>heap_3.c 就更简单了，只是简单的包装一下标准函数  <code>malloc()</code>  和  <code>free()</code>  以确保线程安全，在大多数情况下，这些包装器将需要你的编译器提供，它们依赖于编译器自己的  <code>malloc()</code>  和  <code>free()</code>  实现；文件说明如下： <strong>Implementation of pvPortMalloc() and vPortFree() that relies on the compilers own malloc() and free() implementations.This file can only be used if the linker is configured to to generate a heap memory area.</strong></p><p>1、封装  <code>malloc()</code></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">pvPortMalloc</span><span class="token punctuation">(</span> size_t xWantedSize <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">void</span> <span class="token operator">*</span>pvReturn<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token function">vTaskSuspendAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>pvReturn <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span> xWantedSize <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token function">traceMALLOC</span><span class="token punctuation">(</span> pvReturn<span class="token punctuation">,</span> xWantedSize <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span> <span class="token function">xTaskResumeAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span><span class="token expression"><span class="token punctuation">(</span> configUSE_MALLOC_FAILED_HOOK <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> pvReturn <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">vApplicationMallocFailedHook</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token function">vApplicationMallocFailedHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token keyword">return</span> pvReturn<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>和  <code>heap_1</code>  、 <code>heap_2</code>  一样，用  <code>vTaskSuspendAll()</code>  挂起所有的任务，以确保分配内存的过程是线程安全的；随后才使用  <code>malloc()</code>  进行内存分配，记录内存地址；然后就是调用调试信息宏  <code>traceMALLOC()</code>  ，最后调用  <code>xTaskResumeAll()</code>  恢复所有被挂起的任务；如果在  <code>FreeRTOS.h</code>  中使能了勾子函数宏  <code>configUSE_MALLOC_FAILED_HOOK</code>  ，则在调用勾子函数  <code>vApplicationMallocFailedHook()</code>  之后再向用户返回分配内存的首地址。</p><p>2、封装  <code>free()</code></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">vPortFree</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span>pv <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> pv <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token function">vTaskSuspendAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token function">free</span><span class="token punctuation">(</span> pv <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token function">traceFREE</span><span class="token punctuation">(</span> pv<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span> <span class="token function">xTaskResumeAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>一样的，检查指针的有效性、挂起全部任务、调用  <code>free()</code>  接口将内存回收、调用调试信息宏、恢复挂起的任务，然后就没了。</p><p>此实现方法及特点：</p><ul><li>需要链接器设置堆，并且需要编译器库提供  <code>malloc()</code>  和  <code>free()</code>  实现。</li><li>具有不确定性。</li><li>可能会大大增加 RTOS 内核代码的大小。</li></ul><p>注意，当使用  <code>heap_3</code>  时， <code>FreeRTOSConfig.h</code>  中的宏  <code>configTOTAL_HEAP_SIZE</code>  设置无效。</p><h2 id="heap_4c"><a class="anchor" href="#heap_4c">#</a> heap_4.c</h2><p>跟<strong>方案 2</strong> 不一样的是，这个方案使用了首次适应算法（first fit algorithm）；它会将相邻的空闲内存块合并成一个更大的块（包含一个合并算法）。</p><p>具体是它们会在释放时合并相邻的内存块，从而限制内存碎片，文件中的注释也有说： <strong>A sample implementation of pvPortMalloc() and vPortFree() that combines (coalescences) adjacent memory blocks as they are freed, and in so doing limits memory fragmentation.</strong></p><p>其实，  <code>heap_4</code>  的代码基本跟  <code>heap_2</code>  的代码实现差不多，只不过增加了些功能（合并算法），而且你别看他代码太长，其实有很多东西都没用到的，就像这个函数  <code>mtCOVERAGE_TEST_MARKER()</code>  ，其实他是个宏，但是他并没有实现什么，根据他的命名可以认定为只是作者预留的一个调试输出窗口而已；还有  <code>configASSERT()</code>  这个也是一个宏，也只是用来调试输出而已，具体配置修改看下一篇。</p><p>1、没错，还是我们首要分析的初始化函数。</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prvHeapInit</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>BlockLink_t <span class="token operator">*</span>pxFirstFreeBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">uint8_t</span> <span class="token operator">*</span>pucAlignedHeap<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>size_t uxAddress<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>size_t xTotalHeapSize <span class="token operator">=</span> configTOTAL_HEAP_SIZE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">/* Ensure the heap starts on a correctly aligned boundary. */</span></pre></td></tr><tr><td data-num="9"></td><td><pre>uxAddress <span class="token operator">=</span> <span class="token punctuation">(</span> size_t <span class="token punctuation">)</span> ucHeap<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> uxAddress <span class="token operator">&amp;</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>uxAddress <span class="token operator">+=</span> <span class="token punctuation">(</span> portBYTE_ALIGNMENT <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>uxAddress <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> size_t <span class="token punctuation">)</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>xTotalHeapSize <span class="token operator">-=</span> uxAddress <span class="token operator">-</span> <span class="token punctuation">(</span> size_t <span class="token punctuation">)</span> ucHeap<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>pucAlignedHeap <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> uxAddress<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">/* xStart is used to hold a pointer to the first item in the list of free</pre></td></tr><tr><td data-num="21"></td><td><pre>blocks.  The void cast is used to prevent compiler warnings. */</span></pre></td></tr><tr><td data-num="22"></td><td><pre>xStart<span class="token punctuation">.</span>pxNextFreeBlock <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pucAlignedHeap<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>xStart<span class="token punctuation">.</span>xBlockSize <span class="token operator">=</span> <span class="token punctuation">(</span> size_t <span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment">/* pxEnd is used to mark the end of the list of free blocks and is inserted</pre></td></tr><tr><td data-num="26"></td><td><pre>at the end of the heap space. */</span></pre></td></tr><tr><td data-num="27"></td><td><pre>uxAddress <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> size_t <span class="token punctuation">)</span> pucAlignedHeap <span class="token punctuation">)</span> <span class="token operator">+</span> xTotalHeapSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>uxAddress <span class="token operator">-=</span> xHeapStructSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>uxAddress <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> size_t <span class="token punctuation">)</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>pxEnd <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">)</span> uxAddress<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>pxEnd<span class="token operator">-></span>xBlockSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>pxEnd<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token comment">/* To start with there is a single free block that is sized to take up the</pre></td></tr><tr><td data-num="35"></td><td><pre>entire heap space, minus the space taken by pxEnd. */</span></pre></td></tr><tr><td data-num="36"></td><td><pre>pxFirstFreeBlock <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pucAlignedHeap<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>pxFirstFreeBlock<span class="token operator">-></span>xBlockSize <span class="token operator">=</span> uxAddress <span class="token operator">-</span> <span class="token punctuation">(</span> size_t <span class="token punctuation">)</span> pxFirstFreeBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>pxFirstFreeBlock<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">=</span> pxEnd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token comment">/* Only one block exists - and it covers the entire usable heap space. */</span></pre></td></tr><tr><td data-num="41"></td><td><pre>xMinimumEverFreeBytesRemaining <span class="token operator">=</span> pxFirstFreeBlock<span class="token operator">-></span>xBlockSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>xFreeBytesRemaining <span class="token operator">=</span> pxFirstFreeBlock<span class="token operator">-></span>xBlockSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token comment">/* Work out the position of the top bit in a size_t variable. */</span></pre></td></tr><tr><td data-num="45"></td><td><pre>xBlockAllocatedBit <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> size_t <span class="token punctuation">)</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span> size_t <span class="token punctuation">)</span> <span class="token operator">*</span> heapBITS_PER_BYTE <span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="20200215165421587.png" alt="img" /></p><p>根据上图现在来对比一下  <code>head_2</code>  的，这里对起始地址做字节对齐处理是跟  <code>head_2</code>  有点不同，他不止对内存堆进行首地址对齐保存  <code>pucAlignedHeap</code>  ，并且还算出可用空间大小为  <code>xTotalHeapSize</code> ；</p><p>然后， <code>xStart</code>  的初始化是一样的，没什么好说的，注意  <code>xStart</code>  是  <code>BlockLink_t</code>  的一个实体变量，存储在静态存储区；</p><p>接着是  <code>pxEnd</code>  ，他是一个  <code>BlockLink_t</code>  的指针，存储在静态存储区中，却指向了内存堆的最后一个  <code>BlockLink_t</code>  大小的位置上。也就是说，内存堆最后的空间是存储着一个  <code>BlockLink_t</code>  ，用来指示空闲块链表的最后位置，这是和  <code>heap_2</code>  所不同的地方：</p><p><img data-src="20200215172529594.png" alt="img" /></p><p>因为  <code>pxEnd</code>  占用了一个  <code>BlockLink_t</code>  大小的空间，所以在整个堆空间，减去  <code>pxEnd</code>  占用的空间；</p><p>另外，为了安全， <code>heap_4</code>  增加一个位（  <code>BlockLink_t</code>  中  <code>xBlockSize</code>  的最高位）标记某个内存块是否处于空闲状态，因此在初始化的时候设置  <code>xBlockAllocatedBit</code>  的值。</p><p>2、在对比分析  <code>pvPortMalloc()</code>  内存分布的实现之前，我们先分析一下  <code>prvInsertBlockIntoFreeList()</code>  函数。</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prvInsertBlockIntoFreeList</span><span class="token punctuation">(</span> BlockLink_t <span class="token operator">*</span>pxBlockToInsert <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>BlockLink_t <span class="token operator">*</span>pxIterator<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">uint8_t</span> <span class="token operator">*</span>puc<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">/* Iterate through the list until a block is found that has a higher address</pre></td></tr><tr><td data-num="7"></td><td><pre>than the block being inserted. */</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">for</span><span class="token punctuation">(</span> pxIterator <span class="token operator">=</span> <span class="token operator">&amp;</span>xStart<span class="token punctuation">;</span> pxIterator<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">&lt;</span> pxBlockToInsert<span class="token punctuation">;</span> pxIterator <span class="token operator">=</span> pxIterator<span class="token operator">-></span>pxNextFreeBlock <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">/* Nothing to do here, just iterate to the right position. */</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">/* Do the block being inserted, and the block it is being inserted after</pre></td></tr><tr><td data-num="14"></td><td><pre>make a contiguous block of memory? */</span></pre></td></tr><tr><td data-num="15"></td><td><pre>puc <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pxIterator<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> puc <span class="token operator">+</span> pxIterator<span class="token operator">-></span>xBlockSize <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pxBlockToInsert <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>pxIterator<span class="token operator">-></span>xBlockSize <span class="token operator">+=</span> pxBlockToInsert<span class="token operator">-></span>xBlockSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>pxBlockToInsert <span class="token operator">=</span> pxIterator<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">else</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment">/* Do the block being inserted, and the block it is being inserted before</pre></td></tr><tr><td data-num="27"></td><td><pre>make a contiguous block of memory? */</span></pre></td></tr><tr><td data-num="28"></td><td><pre>puc <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pxBlockToInsert<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> puc <span class="token operator">+</span> pxBlockToInsert<span class="token operator">-></span>xBlockSize <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pxIterator<span class="token operator">-></span>pxNextFreeBlock <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> pxIterator<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">!=</span> pxEnd <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token comment">/* Form one big block from the two blocks. */</span></pre></td></tr><tr><td data-num="34"></td><td><pre>pxBlockToInsert<span class="token operator">-></span>xBlockSize <span class="token operator">+=</span> pxIterator<span class="token operator">-></span>pxNextFreeBlock<span class="token operator">-></span>xBlockSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>pxBlockToInsert<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">=</span> pxIterator<span class="token operator">-></span>pxNextFreeBlock<span class="token operator">-></span>pxNextFreeBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token keyword">else</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>pxBlockToInsert<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">=</span> pxEnd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token keyword">else</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>pxBlockToInsert<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">=</span> pxIterator<span class="token operator">-></span>pxNextFreeBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token comment">/* If the block being inserted plugged a gab, so was merged with the block</pre></td></tr><tr><td data-num="48"></td><td><pre>before and the block after, then it's pxNextFreeBlock pointer will have</pre></td></tr><tr><td data-num="49"></td><td><pre>already been set, and should not be set here as that would make it point</pre></td></tr><tr><td data-num="50"></td><td><pre>to itself. */</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> pxIterator <span class="token operator">!=</span> pxBlockToInsert <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>pxIterator<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">=</span> pxBlockToInsert<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token keyword">else</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这个函数就是合并实现的主要环节了；在  <code>heap_2</code>  中的链表插入是通过宏实现的，并且是按内存块大小进行插入；而  <code>heap_4</code>  的插入操作是写成了一个函数，该函数按内存块地址进行插入（低位前），实际上是将这个空闲块链表里的所有空闲块按地址顺序排列，这么做是为了实现内存块合并；前面也说了，相对于  <code>heap_2</code>  ， <code>heap_4</code>  会将相邻的空闲内存块合并成一个更大的块，若果不这么排列，那么就不能将相邻的空闲块进行合并了。</p><p>首先，通过一次链表的遍历，找出内存块插入点（把  <code>pxIterator</code>  找出来）；然后判断，正在插入的块（ <code>pxBlockToInsert</code> ）和内存块插入点（ <code>pxIterator</code> ）是否构成一个连续的内存块；其标准为  <code>pxIterator</code>  的首地址加上  <code>pxIterator</code>  的块大小之后等于  <code>pxBlockToInsert</code>  的首地址，相等就说明两个块是相邻的，把这个待插入的空闲块插到  <code>pxIterator</code>  的后面，否则就什么事都不做。</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* Iterate through the list until a block is found that has a higher address</pre></td></tr><tr><td data-num="2"></td><td><pre>than the block being inserted. */</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">for</span><span class="token punctuation">(</span> pxIterator <span class="token operator">=</span> <span class="token operator">&amp;</span>xStart<span class="token punctuation">;</span> pxIterator<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">&lt;</span> pxBlockToInsert<span class="token punctuation">;</span> pxIterator <span class="token operator">=</span> pxIterator<span class="token operator">-></span>pxNextFreeBlock <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">/* Nothing to do here, just iterate to the right position. */</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">/* Do the block being inserted, and the block it is being inserted after</pre></td></tr><tr><td data-num="9"></td><td><pre>make a contiguous block of memory? */</span></pre></td></tr><tr><td data-num="10"></td><td><pre>puc <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pxIterator<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> puc <span class="token operator">+</span> pxIterator<span class="token operator">-></span>xBlockSize <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pxBlockToInsert <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>pxIterator<span class="token operator">-></span>xBlockSize <span class="token operator">+=</span> pxBlockToInsert<span class="token operator">-></span>xBlockSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>pxBlockToInsert <span class="token operator">=</span> pxIterator<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">else</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>然后，再试着将  <code>pxBlockToInsert</code>  和  <code>pxIterator</code>  指向的下一个空闲块进行合并；这次用  <code>pxBlockToInsert</code>  的首地址加上  <code>pxBlockToInsert</code>  的块大小与  <code>pxIterator</code>  指向的下一个块地址比较，不符合，则要修改  <code>pxBlockToInsert</code>  的 Next 指针，指向 <code>pxIterator</code>  的下一个空闲块；如果符合条件，则再判断  <code>pxIterator</code>  指向的下一个块地址是否已经到了空闲块链表的最后位置了，如果已经到了空闲块链表的最后位置，那么就把  <code>pxIterator</code>  指向的下一个块地址更改为空闲块链表的最后位置的地址，否则就合并内存并且更新链表的数据。</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* Do the block being inserted, and the block it is being inserted before</pre></td></tr><tr><td data-num="2"></td><td><pre>make a contiguous block of memory? */</span></pre></td></tr><tr><td data-num="3"></td><td><pre>puc <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pxBlockToInsert<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> puc <span class="token operator">+</span> pxBlockToInsert<span class="token operator">-></span>xBlockSize <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pxIterator<span class="token operator">-></span>pxNextFreeBlock <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> pxIterator<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">!=</span> pxEnd <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">/* Form one big block from the two blocks. */</span></pre></td></tr><tr><td data-num="9"></td><td><pre>pxBlockToInsert<span class="token operator">-></span>xBlockSize <span class="token operator">+=</span> pxIterator<span class="token operator">-></span>pxNextFreeBlock<span class="token operator">-></span>xBlockSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>pxBlockToInsert<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">=</span> pxIterator<span class="token operator">-></span>pxNextFreeBlock<span class="token operator">-></span>pxNextFreeBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">else</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>pxBlockToInsert<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">=</span> pxEnd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">else</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>pxBlockToInsert<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">=</span> pxIterator<span class="token operator">-></span>pxNextFreeBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>最后，要是  <code>pxBlockToInsert</code>  没有和  <code>pxIterator</code>  合并，则还要修改  <code>pxIterator</code>  的 Next 指针。</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* If the block being inserted plugged a gab, so was merged with the block</pre></td></tr><tr><td data-num="2"></td><td><pre>before and the block after, then it's pxNextFreeBlock pointer will have</pre></td></tr><tr><td data-num="3"></td><td><pre>already been set, and should not be set here as that would make it point</pre></td></tr><tr><td data-num="4"></td><td><pre>to itself. */</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> pxIterator <span class="token operator">!=</span> pxBlockToInsert <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>pxIterator<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">=</span> pxBlockToInsert<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">else</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>3、讲了这么多，现在终于到分析  <code>pvPortMalloc()</code>  了。</p><p>先看总代码：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">pvPortMalloc</span><span class="token punctuation">(</span> size_t xWantedSize <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>BlockLink_t <span class="token operator">*</span>pxBlock<span class="token punctuation">,</span> <span class="token operator">*</span>pxPreviousBlock<span class="token punctuation">,</span> <span class="token operator">*</span>pxNewBlockLink<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">void</span> <span class="token operator">*</span>pvReturn <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token function">vTaskSuspendAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">/* If this is the first call to malloc then the heap will require</pre></td></tr><tr><td data-num="9"></td><td><pre>initialisation to setup the list of free blocks. */</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> pxEnd <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token function">prvHeapInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">else</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment">/* Check the requested block size is not so large that the top bit is</pre></td></tr><tr><td data-num="20"></td><td><pre>set.  The top bit of the block size member of the BlockLink_t structure</pre></td></tr><tr><td data-num="21"></td><td><pre>is used to determine who owns the block - the application or the</pre></td></tr><tr><td data-num="22"></td><td><pre>kernel, so it must be free. */</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> xWantedSize <span class="token operator">&amp;</span> xBlockAllocatedBit <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment">/* The wanted size is increased so it can contain a BlockLink_t</pre></td></tr><tr><td data-num="26"></td><td><pre>structure in addition to the requested amount of bytes. */</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> xWantedSize <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>xWantedSize <span class="token operator">+=</span> xHeapStructSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token comment">/* Ensure that blocks are always aligned to the required number</pre></td></tr><tr><td data-num="32"></td><td><pre>of bytes. */</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> xWantedSize <span class="token operator">&amp;</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0x00</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token comment">/* Byte alignment required. */</span></pre></td></tr><tr><td data-num="36"></td><td><pre>xWantedSize <span class="token operator">+=</span> <span class="token punctuation">(</span> portBYTE_ALIGNMENT <span class="token operator">-</span> <span class="token punctuation">(</span> xWantedSize <span class="token operator">&amp;</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token function">configASSERT</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> xWantedSize <span class="token operator">&amp;</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token keyword">else</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token keyword">else</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> xWantedSize <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> xWantedSize <span class="token operator">&lt;=</span> xFreeBytesRemaining <span class="token punctuation">)</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token comment">/* Traverse the list from the start(lowest address) block until</pre></td></tr><tr><td data-num="52"></td><td><pre>oneof adequate size is found. */</span></pre></td></tr><tr><td data-num="53"></td><td><pre>pxPreviousBlock <span class="token operator">=</span> <span class="token operator">&amp;</span>xStart<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>pxBlock <span class="token operator">=</span> xStart<span class="token punctuation">.</span>pxNextFreeBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token keyword">while</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> pxBlock<span class="token operator">-></span>xBlockSize <span class="token operator">&lt;</span> xWantedSize <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> pxBlock<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>pxPreviousBlock <span class="token operator">=</span> pxBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>pxBlock <span class="token operator">=</span> pxBlock<span class="token operator">-></span>pxNextFreeBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="60"></td><td><pre></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token comment">/* If the end marker was reached then a block of adequate size</pre></td></tr><tr><td data-num="62"></td><td><pre>wasnot found. */</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> pxBlock <span class="token operator">!=</span> pxEnd <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="64"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token comment">/* Return the memory space pointed to - jumping over the</pre></td></tr><tr><td data-num="66"></td><td><pre>BlockLink_t structure at its start. */</span></pre></td></tr><tr><td data-num="67"></td><td><pre>pvReturn <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pxPreviousBlock<span class="token operator">-></span>pxNextFreeBlock <span class="token punctuation">)</span> <span class="token operator">+</span> xHeapStructSize <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token comment">/* This block is being returned for use so must be taken out</pre></td></tr><tr><td data-num="70"></td><td><pre>of the list of free blocks. */</span></pre></td></tr><tr><td data-num="71"></td><td><pre>pxPreviousBlock<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">=</span> pxBlock<span class="token operator">-></span>pxNextFreeBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre></pre></td></tr><tr><td data-num="73"></td><td><pre><span class="token comment">/* If the block is larger than required it can be split into</pre></td></tr><tr><td data-num="74"></td><td><pre>two. */</span></pre></td></tr><tr><td data-num="75"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> pxBlock<span class="token operator">-></span>xBlockSize <span class="token operator">-</span> xWantedSize <span class="token punctuation">)</span> <span class="token operator">></span> heapMINIMUM_BLOCK_SIZE <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="77"></td><td><pre><span class="token comment">/* This block is to be split into two.  Create a new</pre></td></tr><tr><td data-num="78"></td><td><pre>block following the number of bytes requested. The void</pre></td></tr><tr><td data-num="79"></td><td><pre>cast is used to prevent byte alignment warnings from the</pre></td></tr><tr><td data-num="80"></td><td><pre>compiler. */</span></pre></td></tr><tr><td data-num="81"></td><td><pre>pxNewBlockLink <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pxBlock <span class="token punctuation">)</span> <span class="token operator">+</span> xWantedSize <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre><span class="token function">configASSERT</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> size_t <span class="token punctuation">)</span> pxNewBlockLink <span class="token punctuation">)</span> <span class="token operator">&amp;</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre></pre></td></tr><tr><td data-num="84"></td><td><pre><span class="token comment">/* Calculate the sizes of two blocks split from the</pre></td></tr><tr><td data-num="85"></td><td><pre>single block. */</span></pre></td></tr><tr><td data-num="86"></td><td><pre>pxNewBlockLink<span class="token operator">-></span>xBlockSize <span class="token operator">=</span> pxBlock<span class="token operator">-></span>xBlockSize <span class="token operator">-</span> xWantedSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>pxBlock<span class="token operator">-></span>xBlockSize <span class="token operator">=</span> xWantedSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre></pre></td></tr><tr><td data-num="89"></td><td><pre><span class="token comment">/* Insert the new block into the list of free blocks. */</span></pre></td></tr><tr><td data-num="90"></td><td><pre><span class="token function">prvInsertBlockIntoFreeList</span><span class="token punctuation">(</span> pxNewBlockLink <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="92"></td><td><pre><span class="token keyword">else</span></pre></td></tr><tr><td data-num="93"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="94"></td><td><pre><span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="96"></td><td><pre></pre></td></tr><tr><td data-num="97"></td><td><pre>xFreeBytesRemaining <span class="token operator">-=</span> pxBlock<span class="token operator">-></span>xBlockSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="98"></td><td><pre></pre></td></tr><tr><td data-num="99"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> xFreeBytesRemaining <span class="token operator">&lt;</span> xMinimumEverFreeBytesRemaining <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="100"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>xMinimumEverFreeBytesRemaining <span class="token operator">=</span> xFreeBytesRemaining<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="102"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="103"></td><td><pre><span class="token keyword">else</span></pre></td></tr><tr><td data-num="104"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="105"></td><td><pre><span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="106"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="107"></td><td><pre></pre></td></tr><tr><td data-num="108"></td><td><pre><span class="token comment">/* The block is being returned - it is allocated and owned</pre></td></tr><tr><td data-num="109"></td><td><pre>by the application and has no "next" block. */</span></pre></td></tr><tr><td data-num="110"></td><td><pre>pxBlock<span class="token operator">-></span>xBlockSize <span class="token operator">|=</span> xBlockAllocatedBit<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="111"></td><td><pre>pxBlock<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="112"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="113"></td><td><pre><span class="token keyword">else</span></pre></td></tr><tr><td data-num="114"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="115"></td><td><pre><span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="116"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="117"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="118"></td><td><pre><span class="token keyword">else</span></pre></td></tr><tr><td data-num="119"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="120"></td><td><pre><span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="121"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="122"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="123"></td><td><pre><span class="token keyword">else</span></pre></td></tr><tr><td data-num="124"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="125"></td><td><pre><span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="126"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="127"></td><td><pre></pre></td></tr><tr><td data-num="128"></td><td><pre><span class="token function">traceMALLOC</span><span class="token punctuation">(</span> pvReturn<span class="token punctuation">,</span> xWantedSize <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="129"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="130"></td><td><pre><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span> <span class="token function">xTaskResumeAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="131"></td><td><pre></pre></td></tr><tr><td data-num="132"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span><span class="token expression"><span class="token punctuation">(</span> configUSE_MALLOC_FAILED_HOOK <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="133"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="134"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> pvReturn <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="135"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="136"></td><td><pre><span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">vApplicationMallocFailedHook</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="137"></td><td><pre><span class="token function">vApplicationMallocFailedHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="138"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="139"></td><td><pre><span class="token keyword">else</span></pre></td></tr><tr><td data-num="140"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="141"></td><td><pre><span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="142"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="143"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="144"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="145"></td><td><pre></pre></td></tr><tr><td data-num="146"></td><td><pre><span class="token function">configASSERT</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> size_t <span class="token punctuation">)</span> pvReturn <span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span> size_t <span class="token punctuation">)</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="147"></td><td><pre><span class="token keyword">return</span> pvReturn<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="148"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>其实相对于  <code>heap_2</code>  的变动不大，可以看一下它们的对比图：</p><p><img data-src="20200215194716241.png" alt="img" /></p><p>同样的，只在第一次调用该函数的时候才初始化堆管理，看上图。</p><p><img data-src="2020021519500019.png" alt="img" /></p><p>接着在这里只是相对于  <code>heap_2</code>  多了个标志位  <code>xBlockAllocatedBit</code>  的判断来是否执行以下的操作，若是符合，则像  <code>heap_2</code>  一样进行块字节对齐，看上图。</p><p>而剩下的，主要的不同也就是因为多了个  <code>xBlockAllocatedBit</code>  操作，所以使用了  <code>xBlockSize</code>  的最高位做标记，因此就添加了相应的操作，如下图：</p><p><img data-src="2020021520080137.png" alt="img" /></p><p>至于其他差别不大，此处不做赘述。</p><p>4、 <code>vPortFree()</code>  实现</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">vPortFree</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span>pv <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">uint8_t</span> <span class="token operator">*</span>puc <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pv<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>BlockLink_t <span class="token operator">*</span>pxLink<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> pv <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">/* The memory being freed will have an BlockLink_t structure immediately</pre></td></tr><tr><td data-num="9"></td><td><pre>before it. */</span></pre></td></tr><tr><td data-num="10"></td><td><pre>puc <span class="token operator">-=</span> xHeapStructSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">/* This casting is to keep the compiler from issuing warnings. */</span></pre></td></tr><tr><td data-num="13"></td><td><pre>pxLink <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">)</span> puc<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">/* Check the block is actually allocated. */</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token function">configASSERT</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> pxLink<span class="token operator">-></span>xBlockSize <span class="token operator">&amp;</span> xBlockAllocatedBit <span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token function">configASSERT</span><span class="token punctuation">(</span> pxLink<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> pxLink<span class="token operator">-></span>xBlockSize <span class="token operator">&amp;</span> xBlockAllocatedBit <span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> pxLink<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment">/* The block is being returned to the heap - it is no longer</pre></td></tr><tr><td data-num="24"></td><td><pre>allocated. */</span></pre></td></tr><tr><td data-num="25"></td><td><pre>pxLink<span class="token operator">-></span>xBlockSize <span class="token operator">&amp;=</span> <span class="token operator">~</span>xBlockAllocatedBit<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token function">vTaskSuspendAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token comment">/* Add this block to the list of free blocks. */</span></pre></td></tr><tr><td data-num="30"></td><td><pre>xFreeBytesRemaining <span class="token operator">+=</span> pxLink<span class="token operator">-></span>xBlockSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token function">traceFREE</span><span class="token punctuation">(</span> pv<span class="token punctuation">,</span> pxLink<span class="token operator">-></span>xBlockSize <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token function">prvInsertBlockIntoFreeList</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> BlockLink_t <span class="token operator">*</span> <span class="token punctuation">)</span> pxLink <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span> <span class="token function">xTaskResumeAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token keyword">else</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token keyword">else</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>相比  <code>heap_2</code>  ， <code>heap_4</code>  只是多了一些检查，使之更加安全，看下图比较：</p><p><img data-src="20200215201418626.png" alt="img" /></p><p>应用场景及特点：</p><ul><li>即使应用程序反复删除任务，队列，信号量，互斥量等也可以使用。</li><li>与  <code>heap_2</code>  实现相比，即使将要分配和释放的内存具有随机大小，也很难将堆空间严重分割成多个小块。</li><li>不确定性，但比大多数标准 C 库  <code>malloc</code>  实现要有效得多。</li></ul><p>对于希望直接在应用程序代码中使用便携式层内存分配方案的应用程序， <code>heap_4.c</code>  尤其有用（而不是仅通过调用本身调用  <code>pvPortMalloc()</code>  和  <code>vPortFree()</code>  的 API 函数来间接使用）。</p><h2 id="heap_5c"><a class="anchor" href="#heap_5c">#</a> heap_5.c</h2><p>该方案使用与  <code>heap_4</code>  相同，使用首次适应算法和内存合并算法，并允许堆跨越多个不相邻（不连续）的内存区域。</p><p>这个就不说了，跟  <code>heap_4</code>  大同小异，有兴趣可以看看，就只发一下它的文件注释说明吧</p><pre><code>/* * A sample implementation of pvPortMalloc() that allows the heap to be defined * across multiple non-contigous blocks and combines (coalescences) adjacent * memory blocks as they are freed. * * See heap_1.c, heap_2.c, heap_3.c and heap_4.c for alternative * implementations, and the memory management pages of http://www.FreeRTOS.org * for more information. * * Usage notes: * * vPortDefineHeapRegions() ***must*** be called before pvPortMalloc(). * pvPortMalloc() will be called if any task objects (tasks, queues, event * groups, etc.) are created, therefore vPortDefineHeapRegions() ***must*** be * called before any other objects are defined. * * vPortDefineHeapRegions() takes a single parameter.  The parameter is an array * of HeapRegion_t structures.  HeapRegion_t is defined in portable.h as * * typedef struct HeapRegion * &#123; *uint8_t *pucStartAddress; &lt;&lt; Start address of a block of memory that will be part of the heap. *size_t xSizeInBytes;  &lt;&lt; Size of the block of memory. * &#125; HeapRegion_t; * * The array is terminated using a NULL zero sized region definition, and the * memory regions defined in the array ***must*** appear in address order from * low address to high address.  So the following is a valid example of how * to use the function. * * HeapRegion_t xHeapRegions[] = * &#123; * &#123; ( uint8_t * ) 0x80000000UL, 0x10000 &#125;, &lt;&lt; Defines a block of 0x10000 bytes starting at address 0x80000000 * &#123; ( uint8_t * ) 0x90000000UL, 0xa0000 &#125;, &lt;&lt; Defines a block of 0xa0000 bytes starting at address of 0x90000000 * &#123; NULL, 0 &#125;                &lt;&lt; Terminates the array. * &#125;; * * vPortDefineHeapRegions( xHeapRegions ); &lt;&lt; Pass the array into vPortDefineHeapRegions(). * * Note 0x80000000 is the lower address so appears in the array first. * */</code></pre><p>注意： <code>heap_5</code>  通过调用  <code>vPortDefineHeapRegions()</code>  函数实现初始化，只有在  <code>vPortDefineHeapRegions()</code>  执行后才允许使用内存分配和释放。创建 RTOS 对象（任务、队列、信号量等等）会隐含的调用  <code>pvPortMalloc()</code>  ，因此必须注意：使用  <code>heap_5</code>  创建任何对象前，要先执行  <code>vPortDefineHeapRegions()</code>  函数。</p><h1 id="其他"><a class="anchor" href="#其他">#</a> 其他</h1><p>必须吐槽一下，终于结束了。</p><p>官方的这个地址有详细说 <span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL2EwMDExMS5odG1s">heap 堆内存管理</span></p><p>然后想要了解 heap 所用到的算法可以查看 -&gt;<a href="https://arachnid.cc/docs/%E7%AE%97%E6%B3%95/%E5%88%86%E5%8C%BA%E5%88%86%E9%85%8D%E7%AE%97%E6%B3%95%EF%BC%88Partitioning%20Placement%20Algorithm%EF%BC%89"> 分区分配算法（Partitioning Placement Algorithm）</a></p>]]></content>
      
      
      <categories>
          
          <category> FreeRTOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> history </tag>
            
            <tag> RTOS </tag>
            
            <tag> FreeRTOS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FreeRTOS 篇章之系统移植</title>
      <link href="/docs/RTOS/FreeRTOS%20%E7%AF%87%E7%AB%A0%E4%B9%8B%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D/"/>
      <url>/docs/RTOS/FreeRTOS%20%E7%AF%87%E7%AB%A0%E4%B9%8B%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D/</url>
      
        <content type="html"><![CDATA[<blockquote><p>在移植之前，首先说明一下，该篇章，包括之后的文章都是建立在 CM-3 处理器上（用之前写 STM32 笔记的 STM32F103VET6），并且是用 FreeRTOS 的 V9.0.0 版本的核心文件进行移植，我们只需要把原有的 STM32 基础工程（<a href="https://arachnid.cc/categories/STM32">STM32 的教程链接 ☜</a>）二次添加我们所需的 FreeRTOS 核心文件就可以了</p></blockquote><p>1、开发环境：Keil uVision5 V5.21<br />2、ST 外设标准固件库： V3.5<br />3、FreeRTOS 版本库：V9.0.0<br />4、目标芯片：STM32F103VET6（Cotrex-M3）<br />5、下载调试工具：J-Link</p><h1 id="freertos-核心文件提取"><a class="anchor" href="#freertos-核心文件提取">#</a> FreeRTOS 核心文件提取</h1><p>在上一篇 <a href="https://arachnid.cc/docs/RTOS/FreeRTOS%20%E7%AF%87%E7%AB%A0%E4%B9%8B%E5%AE%98%E6%96%B9%E6%BA%90%E7%A0%81%E6%96%87%E6%A1%A3%E5%88%86%E6%9E%90/">FreeRTOS 篇章之官方源码文档分析</a> 已经分析出我们真正需要的文件是在 FreeRTOSv9.0.0/FreeRTOS 文件中，那么我们就去提取出需要的东西。</p><p>先在工程主目录上建立一个名为 FreeRTOS 的文档</p><p><img data-src="20200212223821860.png" alt="img" /></p><p>再在下载下来的  <code>FreeRTOSv9.0.0\FreeRTOS\Source</code>  文件夹中把下图的这几个文件放进到工程的文档中，而这些零散的源文件我们创一个  <code>src</code>  文档来对它们进行管理，具体看后面移植完的文件结构分布图：</p><p><img data-src="20200212224344457.png" alt="img" /></p><p>至于  <code>portable</code>  文档里面的内容，我们只需拿我们需要的接口就好了，全部拷贝文件太大了，不符合轻量级这个要求；所以进入  <code>FreeRTOSv9.0.0\FreeRTOS\Source\portable</code>  文件夹中，你可以发现有好多以编译器命名的文档，由于我们的开发环境是在  <code>Keil</code>  中的，所以我们要使用里面的  <code>Keil</code>  文档的内容，再让我们进去文档里面瞅瞅有些啥？进去你会发现只有一个  <code>See also the RVDS directory.txt</code>  文本，他叫我们查看  <code>RVDS</code>  这个目录，那我们就进去看看呗，看下图：</p><p><img data-src="20200212225436312.png" alt="img" /></p><p>这下可以了，有支持我们的运行的接口，那就把  <code>RVDS</code>  这个目录复制过去呗</p><p>其中，我们还需要把  <code>FreeRTOS/Source/portable/MemMang</code>  目录也要复制过去，因为我们需要一个对堆进行分配的处理文件，而官方已经为我们提供了几个堆分配方案了，就是里面的几个  <code>heap_x.c</code>  文件</p><p>最后移植完得到下图这样：</p><p><img data-src="2020021920042663.png" alt="img" /></p><p><img data-src="20200212230410570.png" alt="img" /></p><p>最最最后，还要再把  <code>FreeRTOSv9.0.0\FreeRTOS\Demo\CORTEX_STM32F103_Keil</code>  路径下（因为官方 demo 中就这个文档最符合我们当前的移植工程）的  <code>FreeRTOSConfig.h</code>  文件复制到我们用户可修改的  <code>App</code>  文件夹下。</p><h1 id="工程导入及属性修改"><a class="anchor" href="#工程导入及属性修改">#</a> 工程导入及属性修改</h1><p>保持之前的工程不变，二次修改并添加下图的文件进入工程：</p><p><img data-src="20200219200521981.png" alt="img" /></p><p><s>然后再改一下配置的属性为 ARMCM3，</s> 配置属性不用改，是哪款 M3 芯片就选哪个芯片，例如用的是 stm32f103zet6，那就选这个：</p><p><img data-src="20200213160202881.png" alt="img" /></p><p>好了，基本的工程移植就完成了，然后你可能会疑问为什么选  <code>heap_4</code>  这个堆分配方案的，这个在下一篇再进行解析</p>]]></content>
      
      
      <categories>
          
          <category> FreeRTOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> history </tag>
            
            <tag> RTOS </tag>
            
            <tag> FreeRTOS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FreeRTOS 篇章之官方源码文档分析</title>
      <link href="/docs/RTOS/FreeRTOS%20%E7%AF%87%E7%AB%A0%E4%B9%8B%E5%AE%98%E6%96%B9%E6%BA%90%E7%A0%81%E6%96%87%E6%A1%A3%E5%88%86%E6%9E%90/"/>
      <url>/docs/RTOS/FreeRTOS%20%E7%AF%87%E7%AB%A0%E4%B9%8B%E5%AE%98%E6%96%B9%E6%BA%90%E7%A0%81%E6%96%87%E6%A1%A3%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<blockquote><p>FreeRTOS 官网：<span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL2luZGV4Lmh0bWw=">https://www.freertos.org/index.html</span></p></blockquote><h1 id="v900源码版本获取"><a class="anchor" href="#v900源码版本获取">#</a> V9.0.0 源码版本获取</h1><p>1、官方托管在 SVN 的源代码链接：<span class="exturl" data-url="aHR0cHM6Ly9zb3VyY2Vmb3JnZS5uZXQvcHJvamVjdHMvZnJlZXJ0b3MvZmlsZXMvRnJlZVJUT1Mv">https://sourceforge.net/projects/freertos/files/FreeRTOS/</span></p><p><img data-src="20200212155522823.png" alt="img" /></p><p>2、官方托管在 GitHub 的源代码链接：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0ZyZWVSVE9TL0ZyZWVSVE9T">https://github.com/FreeRTOS/FreeRTOS</span></p><p><img data-src="20200212155628361.png" alt="img" /></p><p>这里使用 V9.0.0 版本，包括之后都是以 V9.0.0 版本为参考，不要问我为什么，哪个版本成熟稳定用那个。</p><h1 id="文件分类"><a class="anchor" href="#文件分类">#</a> 文件分类</h1><pre><code>FreeRTOSv9.0.0     │       ├─ New - Direct to Task Notifications     ├─ New - FreeRTOS+TCP     ├─ Quick_Start_Guide     ├─ Upgrading-to-FreeRTOS-9     │     ├─ FreeRTOS-Plus            // 包含 FreeRTOS+组件(TCP/CLI/IO/UDP)和演示项目     │        │     │        ├─ Demo     │        ├─ Source     │        └─ readme.txt      // 当前目录的一些文档说明     │     ├─ FreeRTOS                 // 包含 FreeRTOS实时内核源代码文件和演示项目(主要移植这个)     │      │     │      ├─ Demo              // 包含演示应用程序项目     │      ├─ License           // 许可说明     │      ├─ Source            // 包含实时内核源代码     │      ├─ links_to_doc_pages_for_the_demo_projects     │      └─ readme.txt        // 当前目录的一些文档说明     │     └─ readme.txt               // 主目录文档的大致说明</code></pre><p>因为之后的实验是以移植 FreeRTOS 这个文件为主，所以主要讲解这个文件里面的东西</p><p><strong>1、首先是 FreeRTOS/Source 文件</strong></p><pre><code>FreeRTOS    └─ Source                     // 核心 FreeRTOS内核文件           │           ├─ include             // 核心 FreeRTOS内核头文件           │           ├─ portable            // 与处理器相关的特定代码           │     │           │     ├─ Compiler x    // 编译器x 支持的所有端口           │     ├─ Compiler y    // 编译器y 支持的所有端口           │     ├─ MemMang       // 堆实现的示例           │     └─ readme.txt    // 当前目录的一些文档说明           │           └─ readme.txt          // 当前目录的一些文档说明</code></pre><p><img data-src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动" /></p><p><code>FreeRTOS/Source</code>  目录包含 FreeRTOS 源代码，并包含它自己的自述文件。</p><p><code>FreeRTOS/Source/Portable</code>  目录包含特定于特定微控制器和或编译器的文件。</p><p><code>FreeRTOS/Source/include</code>  目录包含实时内核头文件。</p><p>核心 RTOS 代码包含在三个文件中，他们分别是  <code>tasks.c</code> ，  <code>queue.c</code>  和  <code>list.c</code> ，这三个文件位于  <code>FreeRTOS/Source</code>  目录中；同一目录下还包含两个名为  <code>timers.c</code>  和  <code>croutine.c</code>  的可选文件，它们分别实现软件计时器和协同例程功能。</p><p>同样的，官方提供的几个堆的分配方案也位于可移植层中。各种样本  <code>heap_x.c</code>  文件位于  <code>FreeRTOS/Source/portable/MemMang</code>  目录中</p><p><strong>2、FreeRTOS/Demo 文件</strong></p><pre><code>FreeRTOS    └─ Demo                       // 演示应用程序项目        │        ├─ Common                 // 所有演示使用的演示应用程序文件        │        ├─ Dir x                  // 端口 x的演示应用程序构建文件        │        ├─ Dir y                  // 端口 y的演示应用程序构建文件        │        └─ readme.txt             // 当前目录的一些文档说明 </code></pre><p><code>FreeRTOS/Demo</code>  目录包含用于每种处理器体系结构和编译器端口的演示应用程序。演示应用程序的大部分代码对所有端口通用，并且包含在  <code>FreeRTOS/Demo/Common/Minimal</code>  目录中（位于  <code>FreeRTOS/Demo/Common/Full</code>  目录中的代码是旧代码，仅由 PC 端口使用） 。</p><p>其余的  <code>FreeRTOS/Demo</code>  子目录包含用于构建单个演示应用程序的预配置项目，目录被命名以指示它们所关联的端口；每个 RTOS 端口目录下包含着自己的  <code>readme</code>  文件，而且它们还具有其自己的网页，该<span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL2EwMDA5MC5odG1s">网页</span>详细说明了可在其中找到该端口的演示应用程序的目录。</p><h1 id="其他"><a class="anchor" href="#其他">#</a> 其他</h1><p>具体的关于官方文档解析的更多信息可以看当前目录下的  <code>readme</code>  文件以及在官方的这个链接查看：<span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL2EwMDAxNy5odG1s">https://www.freertos.org/a00017.html</span></p>]]></content>
      
      
      <categories>
          
          <category> FreeRTOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> history </tag>
            
            <tag> RTOS </tag>
            
            <tag> FreeRTOS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C 语言结构体大小及对齐问题</title>
      <link href="/docs/Essay/C%20%E8%AF%AD%E8%A8%80%E7%BB%93%E6%9E%84%E4%BD%93%E5%A4%A7%E5%B0%8F%E5%8F%8A%E5%AF%B9%E9%BD%90%E9%97%AE%E9%A2%98/"/>
      <url>/docs/Essay/C%20%E8%AF%AD%E8%A8%80%E7%BB%93%E6%9E%84%E4%BD%93%E5%A4%A7%E5%B0%8F%E5%8F%8A%E5%AF%B9%E9%BD%90%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<h1 id="内存大小问题"><a class="anchor" href="#内存大小问题">#</a> 内存大小问题</h1><p>有时候，我们在不同的编译环境，或者不同的机子上测试编译，会呈现不同的结果，于是我们会陷入疑问，内存的大小是谁分配的呢？</p><p>在系统中，系统对内存的识别是以 Byte（字节）为单位，每个字节由 8 位二进制数组成，即 8bit（比特，也称 “位” ）。按照计算机的二进制方式，1Byte = 8bit；1KB = 1024Byte；1MB = 1024KB；1GB = 1024MB；1TB = 1024GB。</p><p>我们都知道 Byte（字节）的大小是固定的，但是，我们目前接触的都是以 Word（字长）、HalfWord（半字），而他的解释是：在电脑领域，对于某种特定的计算机设计而言，<strong>字</strong>（英语：word）是用于表示其自然的数据单位的术语。在这个特定电脑中，字是其用来一次性处理事务的一个固定长度的位（bit）组。一个字的位数（即<strong>字长</strong>）是电脑系统结构中的一个重要特性。</p><p>来源：<span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU1JUFEJTk3XyglRTglQUUlQTElRTclQUUlOTclRTYlOUMlQkEp">字 (计算机) - 维基百科</span></p><h1 id="分配问题"><a class="anchor" href="#分配问题">#</a> 分配问题</h1><p>我们之所以有可能出现编译的数据内存大小不一样，是因为在不同的处理器和编译器中它所呈现的结果是不一样的，直白的说就是所对应的 Word（字长）不一样，其实字长并非一个十分严格的概念，要从汇编语言的角度理解，就是指令集里面的运算和内存操作时操作数的长度，具体还是看一下关于计算机底层的东西。</p><p>在 32 位处理器中 32 位指的就是 CPU GPRs（General-Purpose Registers，通用寄存器）的数据宽度，当然 64 位 CPU 的数据宽度为 64 位，所以 32 位 CPU 的数据宽度指的是 32 位了。</p><p>64 位指令集就是运行 64 位数据的指令，也就是说处理器一次可以运行 64Bit 数据。这样一来 32 位处理器一次最多只能处理 32 位，也就是 4 个字节的数据，而 64 位处理器一次就能处理 64 位，即 8 个字节的数据。</p><p>按照上面总的来说：各种类型的存储大小与系统位数有关。</p><p>而至于为什么又跟编译器有关呢？</p><p>假设我们在 64 位处理器上运行 32 位的编译器来写代码的，这样编译器就只会默认我们的程序是在 32 位系统下运行，因为这编译器最多只能处理 32 位，多了它处理不来啊 [哭笑]</p><p>所以，一般严格来说，在进行编译测试后，想要告诉别人结果，也应该把你当时所测试的操作系统以及编译系统告诉别人，同样的例子也有：就像我们在下载一个程序的时候，你可能会看到程序文件名后面带有 x32 或者 x64 等一些标志性文本，这就是要告诉别人它支持的操作环境。</p><p><img data-src="20200208120209731.png" alt="img" /></p><h1 id="结构体分配的空间"><a class="anchor" href="#结构体分配的空间">#</a> 结构体分配的空间</h1><p>在进行讨论之前先来看一下程序</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* </pre></td></tr><tr><td data-num="2"></td><td><pre> * 操作系统：基于 x64 的处理器</pre></td></tr><tr><td data-num="3"></td><td><pre> * 编译环境：Dev-C++ V5.11 </pre></td></tr><tr><td data-num="4"></td><td><pre> */</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span> </span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SIZE</span><span class="token expression"><span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">s</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">char</span> a<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">short</span> b<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">int</span> c<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">double</span> d<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">char</span><span class="token operator">*</span> e<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">char</span> f<span class="token punctuation">[</span>SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">//    double i;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">s</span> temp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">char</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"char:%d,short:%d,int:%d,double:%d\n\n"</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sizeof = %d\n"</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sizeof = %d\n\n"</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"temp addr = %p\n"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"a    addr = %p,%2d\n"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>temp<span class="token punctuation">.</span>a<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>temp<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"b    addr = %p,%2d\n"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>temp<span class="token punctuation">.</span>b<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>temp<span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"c    addr = %p,%2d\n"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>temp<span class="token punctuation">.</span>c<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>temp<span class="token punctuation">.</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"d    addr = %p,%2d\n"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>temp<span class="token punctuation">.</span>d<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>temp<span class="token punctuation">.</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"e    addr = %p,%2d\n"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>temp<span class="token punctuation">.</span>e<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>temp<span class="token punctuation">.</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nf    addr = %p\n"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>temp<span class="token punctuation">.</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"f    sizeof = %d\n"</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>temp<span class="token punctuation">.</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token comment">//printf("\ni addr = %p,%d\n",&amp;temp.i,sizeof(temp.i));</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动" /></p><p>我们定义了一个  <code>struct s</code>  的结构体，里面有不同数据类型的结构体成员  <code>.a /.b /.c /.e /.f</code> （成员  <code>i</code>  我们先屏蔽先，这个是关于后面对齐问题测试的）；成员  <code>f</code>  为数组，特殊点我们把地址跟大小分开打印；指针我们不知道他的大小，也打印出来；最后我们打印一下输出看下结果：</p><p><img data-src="20200208121340412.png" alt="img" /></p><p>先看第一行，我们打印出了  <code>char /short /int /double</code>  所对应的数据类型大小；</p><p>第二行我们是打印了指针的数据大小，大小为 8Byte（因为指针在实质上是一个内存地址，内存地址的长度跟 CPU 的寻址有关；在 32 位系统上， CPU 用 32 位表示一个内存地址，这样的系统上一个指针占据 4 个字节（32 / 8 = 4）；在 64 位系统上， CPU 用 64 位表示一个内存地址，这样的系统上一个指针占据 8 个字节（64 / 8 = 8））</p><p>第三行是打印出结构体总的大小为 32</p><p>再到后面的，当前的结构体地址对应着第一个结构体成员地址，这个没问题；后面每个结构体成员所对应的数据类型大小也没问题；但是，当我们一加起来 1 + 2 + 4 + 8 + 8 + 1 = 24 ？？？跟打印出来的总大小不一样啊，这就关系到数据对齐了。</p><h1 id="内存大小对齐原则"><a class="anchor" href="#内存大小对齐原则">#</a> 内存大小对齐原则</h1><ol><li>结构体变量的首地址能够被其最宽基本类型成员的大小所整除。</li><li>结构体每个成员相对于结构体首地址的偏移量（offset）都是成员大小的整数倍，如有需要编译器会在成员之间加上填充字节（internal adding）。即结构体成员的末地址减去结构体首地址（第一个结构体成员的首地址）得到的偏移量都要是对应成员大小的整数倍。</li><li>结构体的总大小为结构体最宽基本类型成员大小的整数倍，如有需要编译器会在成员末尾加上填充字节。</li></ol><p>看了以上的原则后，我们来继续分析一下上面的数据类型大小问题</p><p>实际上：结构体 s = a (1byte) + 空闲 (1byte) + b (2byte) + c (4byte) + d (8byte) + e (8byte) + f * SIZE (1byte *1) + 空闲 (7byte) = 32 (byte)。</p><p>解释一下：上面输出的结构体变量的首地址为 0x0407A20，对于第一个成员  <code>a</code>  的地址就是结构体的首地址，占用 1 个字节（符合第一个的原则）；因为成员  <code>a</code>  只用了 1 个字节，而成员  <code>b</code>  地址要 2 的倍数，中间隔着一个字节，那么就需要把这个一个字节填充进去，为后面的成员  <code>b</code>  的地址制造出 2 的倍数的地址数）；成员  <code>b</code>  自己的大小为 2byte，他所对的地址必须是 2 的倍数，那么在填充完那一个字节后，他的地址排下去就是 0x0407A22，对应上了 2 的倍数（即上面的第二点原则）；成员  <code>c</code>  大小为 4，同样的他所对的地址就得要 4 的倍数，算一下前面一共占用的地址数：a (1byte) + 空闲 (1byte) + b (2byte) = 4 (byte)，当前的地址就已经是 4 的倍数了，所以不需要填充；后面两个成员也一样；然后再到最后一个成员  <code>f</code>  的分析，因为这是最后一个成员了，这样就已经知道在整个结构体  <code>s</code>  中他的最宽基本类型成员大小是多小了，没错，是 8byte（double 类型或者指针的内存地址大小）；那么按照第三点的原则，我们先能加起来的先加起来，先不考虑最后一项成员需要填充多少个字节： a (1byte) + 空闲 (1byte) + b (2byte) + c (4byte) + d (8byte) + e (8byte) + f (1byte) = 25 (byte)；25byte 明显不是最宽基本类型成员大小 8byte 的倍数了，那么距离 25 最近的 8 的倍数有两个 24 和 32，若是选 24，内存明显不够放，所以只能取大进行填充 7byte，以便总大小成为 32byte。</p><p>因此简单总结一下（在 x64 位机，64 位编译器中）：</p><table><thead><tr><th>类型</th><th>对齐方式（变量存放的起始地址相对于结构的起始地址的偏移量）</th></tr></thead><tbody><tr><td>Char</td><td>偏移量必须为 sizeof (char) 即 1 的倍数</td></tr><tr><td>Short</td><td>偏移量必须为 sizeof (short) 即 2 的倍数</td></tr><tr><td>int</td><td>偏移量必须为 sizeof (int) 即 4 的倍数</td></tr><tr><td>float</td><td>偏移量必须为 sizeof (float) 即 4 的倍数</td></tr><tr><td>double</td><td>偏移量必须为 sizeof (double) 即 8 的倍数</td></tr></tbody></table><p>各成员变量在存放的时候根据在结构中出现的顺序依次申请空间，同时按照上面的对齐方式调整位置，空缺的字节会自动填充。同时为了确保结构的大小为结构的字节边界数（即该结构中占用最大空间的类型所占用的字节数）的倍数，所以在为最后一个成员变量申请空间后，还会根据需要自动填充空缺的字节。</p><h1 id="其他"><a class="anchor" href="#其他">#</a> 其他</h1><p>案例一（结构体中的成员数组不指定大小，只限于成员数组在结构体尾部）：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* </pre></td></tr><tr><td data-num="2"></td><td><pre> * 操作系统：基于 x64 的处理器</pre></td></tr><tr><td data-num="3"></td><td><pre> * 编译环境：Dev-C++ V5.11 </pre></td></tr><tr><td data-num="4"></td><td><pre> */</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span> </span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SIZE</span><span class="token expression"><span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">s</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">char</span> a<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">short</span> b<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">int</span> c<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">double</span> d<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">char</span><span class="token operator">*</span> e<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">char</span> f<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">//    double i;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">s</span> temp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">char</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"char:%d,short:%d,int:%d,double:%d\n\n"</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sizeof = %d\n"</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sizeof = %d\n\n"</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"temp addr = %p\n"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"a    addr = %p,%2d\n"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>temp<span class="token punctuation">.</span>a<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>temp<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"b    addr = %p,%2d\n"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>temp<span class="token punctuation">.</span>b<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>temp<span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"c    addr = %p,%2d\n"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>temp<span class="token punctuation">.</span>c<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>temp<span class="token punctuation">.</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"d    addr = %p,%2d\n"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>temp<span class="token punctuation">.</span>d<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>temp<span class="token punctuation">.</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"e    addr = %p,%2d\n"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>temp<span class="token punctuation">.</span>e<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>temp<span class="token punctuation">.</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nf    addr = %p\n"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>temp<span class="token punctuation">.</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token comment">//printf("f    sizeof = %d\n",sizeof(temp.f));</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token comment">//printf("\ni addr = %p,%d\n",&amp;temp.i,sizeof(temp.i));</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>运行结果：</p><p><img data-src="2020020814355773.png" alt="img" /></p><p>可以发现在程序中，由于没有为结构体成员数组  <code>f</code>  指定大小，将不为其分配空间</p><p>案例二（在案例一下，再追加一个结构体成员 i (double 类型) ）：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span> </span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SIZE</span><span class="token expression"><span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">s</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">char</span> a<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">short</span> b<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">int</span> c<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">double</span> d<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">char</span><span class="token operator">*</span> e<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">char</span> f<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">double</span> i<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">s</span> temp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">char</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"char:%d,short:%d,int:%d,double:%d\n\n"</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sizeof = %d\n"</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sizeof = %d\n\n"</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"temp addr = %p\n"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"a    addr = %p,%2d\n"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>temp<span class="token punctuation">.</span>a<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>temp<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"b    addr = %p,%2d\n"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>temp<span class="token punctuation">.</span>b<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>temp<span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"c    addr = %p,%2d\n"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>temp<span class="token punctuation">.</span>c<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>temp<span class="token punctuation">.</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"d    addr = %p,%2d\n"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>temp<span class="token punctuation">.</span>d<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>temp<span class="token punctuation">.</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"e    addr = %p,%2d\n"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>temp<span class="token punctuation">.</span>e<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>temp<span class="token punctuation">.</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nf    addr = %p\n"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>temp<span class="token punctuation">.</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token comment">//printf("f    sizeof = %d\n",sizeof(temp.f));</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\ni addr = %p,%d\n"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>temp<span class="token punctuation">.</span>i<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>temp<span class="token punctuation">.</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这下编译直接报错： [Error] flexible array member not at end of struct，因为成员数组  <code>f</code>  并不知道他的大小。</p>]]></content>
      
      
      
        <tags>
            
            <tag> history </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>对 C 指针的理解</title>
      <link href="/docs/Essay/%E5%AF%B9%20C%20%E6%8C%87%E9%92%88%E7%9A%84%E7%90%86%E8%A7%A3/"/>
      <url>/docs/Essay/%E5%AF%B9%20C%20%E6%8C%87%E9%92%88%E7%9A%84%E7%90%86%E8%A7%A3/</url>
      
        <content type="html"><![CDATA[<blockquote><p>前排声明一下，本篇是在学习 typedef 高级应用的时候发现对于指针的应用有很多不熟，然后查看了好多资料（参考链接在后面），于是又重新复习了一遍，并把它以自己通俗的语言整理出来，可能会有炒鸡多的不对，内容多来自书本和网络，希望各方大佬进行指正；同样的，在看这篇文章之前，不可全信，请务必持怀疑的态度去思考（我也不敢打保单一定是正确的，毕竟我也在学习中）</p></blockquote><p>指针这东西，讨人喜爱的同时也惹人烦恼，反正对我而言，谈起指针就脑壳疼，所以别在我面前谈它，不然出来打一架；哈哈哈，开玩笑的</p><h1 id="什么是指针"><a class="anchor" href="#什么是指针">#</a> 什么是指针？</h1><p>首先你要明白什么是指针，指针是<strong>一个值为内存地址的变量（或数据对象）</strong>，即，内存位置的直接地址；记住：<strong>指针变量的值并不是它所指向的内存位置所存储的值</strong> 。</p><h1 id="指针是用来干什么的"><a class="anchor" href="#指针是用来干什么的">#</a> 指针是用来干什么的？</h1><p>那么指针是用来干嘛的？简单的说，指针是用来操作内存的，因为内存中的每个位置都是由一个独一无二的地址标识，并且内存的每个位置都包含一个值，所以，我们常说的 “谁谁谁指向 xxx”，其实就是通过它的地址来找到所需的变量单元（也就是内存）然后再对它进行操作，注意，这个地址它不是固定的，它是由计算机随机安排的。</p><h1 id="指针变量的声明"><a class="anchor" href="#指针变量的声明">#</a> 指针变量的声明</h1><pre><code>type * var-name;</code></pre><p>在这里，<strong>type</strong> 是指针的基类型，它必须是一个有效的 C 数据类型（就是 int、char 那些），<strong>var-name</strong> 是指针变量的名称。用来声明指针的星号 ***** 与乘法中使用的星号是相同的（符号一样）。但是，<strong>在这个语句中，星号是用来指定一个变量是指针</strong> 。</p><p>例如：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">int</span> <span class="token operator">*</span>ip<span class="token punctuation">;</span> <span class="token comment">/* 一个整型的指针（int *） */</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">double</span> <span class="token operator">*</span>dp<span class="token punctuation">;</span> <span class="token comment">/* 一个 double 型的指针（double *） */</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">float</span> <span class="token operator">*</span>fp<span class="token punctuation">;</span> <span class="token comment">/* 一个浮点型的指针（float *） */</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">char</span> <span class="token operator">*</span>ch<span class="token punctuation">;</span> <span class="token comment">/* 一个字符型的指针（char *） */</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>……</pre></td></tr></table></figure><p>在声明一个指针变量，计算机并不会自动分配用来存储指针所指向的数据的内存，其缺省值是随机的，所以我们必须对指针进行初始化，否则可能会带来严重的危害。</p><h2 id="四-指针的初始化及赋值"><a class="anchor" href="#四-指针的初始化及赋值">#</a> 四、指针的初始化及赋值</h2><p>在进行初始化之前，首先我们需要了解  <code>&amp;</code>  、  <code>*</code>  这两个与指针相关的运算符，在 C 中，可以<strong>通过 &amp; 运算符访问地址，通过 * 运算符获得地址上的值</strong> 。</p><p>在写程序过程中，为每个指针变量初始化赋值是个良好的习惯，会有效的防止指针指向未知的内存（也是野指针的一种）；对指针进行初始化，要让它：①指向现有的内存、②配置成 NULL 指针、③或者给它分配动态内存</p><p>示例：</p><p>1、/* 指向现有内存 */</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">int</span> q <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">int</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token operator">&amp;</span>q<span class="token punctuation">;</span>    <span class="token comment">// 定义一个指针变量名为 ptr，并且 *ptr 是 int 类型的；同时，把 q 的地址赋给 ptr（就是我们常说的：把 ptr 指向 q）</span></pre></td></tr></table></figure><p>2、/* NULL 空指针 */</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">int</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>3、/* 分配所需的动态内存空间 */</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">int</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">calloc</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 在空闲内存池中分配连续内存 n * sizeof (int) 个字节的堆内存空间，并自动将这一块的内存之初始化为 0；</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/* 注意区分 ‘malloc’‘calloc’; 若是用 malloc 函数，则一般还要调用 memset 函数对内存进行初始化，</pre></td></tr><tr><td data-num="4"></td><td><pre>因为 memset 函数只是向计算机申请了一块内存空间，并没有对这些内存的值进行初始化，虽然说不调</pre></td></tr><tr><td data-num="5"></td><td><pre>用 memset 这个函数初始化也能通过编译，但是分配内存的值为一些垃圾数值，而且后面也有可能出错，</pre></td></tr><tr><td data-num="6"></td><td><pre>所以啊，用到指针就得给它初始化，否则别用，不然得不偿失 */</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">int</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">calloc</span><span class="token punctuation">(</span>n<span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token function">memset</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> n<span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>另外，稍微拓展一下：对于我们常见的利用 malloc 函数来为指针申请一段空间来存储数据，那么什么时候需要为指针申请空间，什么时候不需要呢？</p><p>要知道，C 库函数  <code>void *malloc(size_t size)</code>  是用来分配所需的内存空间，并返回一个指向它的指针；<strong>如果定义指针的时候，指针指向一个有空间的数据，这时就不需要分配空间；如果要给指针赋值，则需要分配内存空间</strong> 。</p><h1 id="指针和数组"><a class="anchor" href="#指针和数组">#</a> 指针和数组</h1><p>数组表示法其实是在变相地使用指针，<strong>数组名是数组首元素的地址</strong> 。</p><p>举个栗子：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* 我们定义一个数组，把它初始化一下 */</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">int</span> array<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">/* 那么下面的语句是成立的 */</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">// array == &amp;array[0];</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">// 你可以测试输出看一下它们的地址，你会发现是一样的</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">int</span> <span class="token operator">*</span>temp <span class="token operator">=</span> array<span class="token punctuation">;</span>       <span class="token comment">// 把数组的地址赋给指针</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"array = %x\n"</span><span class="token punctuation">,</span> temp<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"array[0] = %x\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>但是，<strong>指针和数组并不是相等的</strong>，虽然数组也可以像指针那样进行间接访问，但还是有很大差别的：</p><p><mark>声明一个数组时，编译器将根据声明所指定的元素数量为数组保留内存空间，然后再创建数组名，它的值是一个常量，指向这段空间的起始位置。声明一个指针变量时，编译器只为指针本身保留内存空间，它并不为任何整形值分配内存空间；而且，指针变量并未被初始化为指向任何现有的内存空间，如果它是一个自动变量，他甚至根本不会被初始化。</mark></p><p>同样的</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre>temp <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token operator">&amp;</span>array<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token comment">// 相同的地址</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token operator">*</span><span class="token punctuation">(</span>temp <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">==</span> array<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 相同的值</span></pre></td></tr></table></figure><p>顺带一提，不要混淆  <code>*(temp + 2)</code>  和  <code>*temp + 2</code>  ；间接运算符  <code>*</code>  的优先级是高于  <code>+</code>  的，所以  <code>*temp + 2</code>  相当于  <code>(*temp)+ 2</code>  。</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">*</span><span class="token punctuation">(</span>temp <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span>       <span class="token comment">//temp 第 3 个元素的值</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token operator">*</span>temp <span class="token operator">+</span> <span class="token number">2</span>         <span class="token comment">//temp 第 1 个元素的值加 2</span></pre></td></tr></table></figure><h1 id="指针与-const"><a class="anchor" href="#指针与-const">#</a> 指针与 const</h1><p>我们知道 const 关键字是用来声明常量的，用于限定一个变量为只读，所以在指针中，由于指针的特殊，有多种情况，这是因为要区分是限定指针本身为 const 还是限定指针指向的值为 const；在指针中，const 常见的用法是声明为函数形参的指针。</p><p>在分析之前，我们先来复习一下：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">int</span> <span class="token operator">*</span>pi<span class="token punctuation">;</span>   <span class="token comment">//pi 是一个普通的指向整形的指针</span></pre></td></tr></table></figure><p>然后，下面我们在此基础上，让指针跟 const 关键字结合来分析。</p><p>1、指向整形常量的指针  <code>(int const *pci / const int *pci)</code></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 注意其实 const int *p 跟 int const *p 效果一样的</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">void</span> <span class="token function">fun1</span><span class="token punctuation">(</span> <span class="token keyword">int</span> <span class="token keyword">const</span> <span class="token operator">*</span>p <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">int</span> temp <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   </pre></td></tr><tr><td data-num="7"></td><td><pre>    p <span class="token operator">=</span> <span class="token operator">&amp;</span>temp<span class="token punctuation">;</span>        <span class="token comment">// 正确</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>           <span class="token comment">// 错误</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在这种情况下，它的特点就是：<strong>你可以修改指针的值，但你不能修改它所指向的值</strong> 。</p><p>2、指向整形的常量指针  <code>(int *const cpi)</code></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">fun2</span><span class="token punctuation">(</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token keyword">const</span> p <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">int</span> temp <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   </pre></td></tr><tr><td data-num="5"></td><td><pre>    p <span class="token operator">=</span> <span class="token operator">&amp;</span>temp<span class="token punctuation">;</span>        <span class="token comment">// 错误</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>           <span class="token comment">// 正确</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>而现在这种情况：<strong>此时指针是常量，它的值无法修改，但你可以修改它所指向的整形的值</strong> 。</p><p>然后，用个例子验证一下</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">int</span> temp <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">void</span> <span class="token function">fun1</span><span class="token punctuation">(</span> <span class="token keyword">int</span> <span class="token keyword">const</span> <span class="token operator">*</span>p <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    p <span class="token operator">=</span> <span class="token operator">&amp;</span>temp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">//  *p = 8;           // 错误，编译器警报</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fun1 -> p = %x\n"</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fun1 -> *p = %d\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">void</span> <span class="token function">fun2</span><span class="token punctuation">(</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token keyword">const</span> p <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">//  p = &amp;temp;        // 错误，编译器警报</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fun2 -> p = %x\n"</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fun2 -> *p = %d\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">int</span> value <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"&amp;temp = %x\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"&amp;value = %x\n\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token function">fun1</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"value1 = %d\n"</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"value1 = %x\n\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>    value <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token function">fun2</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"value2 = %d\n"</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"value2 = %x\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>note：</strong> 既然，在指针和形参声明中使用 const 有以上这两种情况，那么怎么区分呢？</p><p>其实细心点可以发现，const 放在  <code>*</code>  左侧任意位置，限定了指针指向的数据不能改变；const 放在  <code>*</code>  的右侧，限定了指针本身不能改变。</p><p>3、指向整形常量的常量指针  <code>(int const *const cpci)</code></p><p>根据上面的，我们会想，在指针上能不能同时加 const 呢？可以，这就是第三种：指向整形常量的常量指针。</p><p>在这里，<strong>无论是指针本身还是它所指向的值都是常量，都不允许修改</strong> 。</p><p>你可能会问，上面的第一、二种不是常说的 “常量指针” 和 “指针常量” 吗？或许你说的是对的，但对于我目前找到的参考文献中，并没有找到对应出现的这两个词；正如文章开头所说的，请务必持怀疑的态度去思考，所以，我并不打算把上面的两个分点写上 “常量指针” 和 “指针常量”，毕竟，也有可能是大部分人为了叫的好听一点或者区分这个关系而命名的，但相对的，我想如果你理解了上面分点的那两个的特点及应用，比记 “常量指针” 和 “指针常量” 更好理解吧</p><h1 id="指向指针的指针"><a class="anchor" href="#指向指针的指针">#</a> 指向指针的指针</h1><p><code>int **p;</code>  --- 我们从右往左看，首先从 p 开始，先与  <code>*</code>  结合，说明 p 是一个指针  <code>*p</code>  ，然后再与  <code>*</code>  结合  <code>**p</code>  ，说明指针所指向的元素是指针；然后再与 int 结合，说明该指针所指向的元素是整型数据。由于二级指针以及更高级的指针极少用在复杂的类型中，所以在这里最多只考虑一级指针。</p><p>例子：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">int</span> <span class="token operator">*</span>n <span class="token operator">=</span> <span class="token operator">&amp;</span>a<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">int</span> <span class="token operator">*</span><span class="token operator">*</span>p <span class="token operator">=</span> <span class="token operator">&amp;</span>n<span class="token punctuation">;</span></pre></td></tr></table></figure><p>然后，我们来分析一下</p><table><thead><tr><th style="text-align:center">表达式</th><th style="text-align:center">与之相对应的表达式</th></tr></thead><tbody><tr><td style="text-align:center">a</td><td style="text-align:center">==  <code>12</code></td></tr><tr><td style="text-align:center">n</td><td style="text-align:center">==  <code>&amp;a</code></td></tr><tr><td style="text-align:center">*n</td><td style="text-align:center">==  <code>a</code>  or == <code>12</code></td></tr><tr><td style="text-align:center">P</td><td style="text-align:center">==  <code>&amp;n</code></td></tr><tr><td style="text-align:center">*p</td><td style="text-align:center">==  <code>n</code>  or ==  <code>&amp;a</code></td></tr><tr><td style="text-align:center">**p</td><td style="text-align:center">==  <code>*n</code>  or ==  <code>a</code>  or ==  <code>12</code></td></tr></tbody></table><h1 id="指针与结构体"><a class="anchor" href="#指针与结构体">#</a> 指针与结构体</h1><p>先来放一个例子：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SIZE</span>  <span class="token expression"><span class="token number">10</span></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">char</span> name<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">int</span> num<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">float</span> score<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span>Student_TypeDef<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>Student_TypeDef stu <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"Tom"</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">136.5</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>                  </pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>Student_TypeDef <span class="token operator">*</span>pstu <span class="token operator">=</span> <span class="token operator">&amp;</span>stu<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment">// 读取结构体成员的值</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s的学号是%d，成绩是%.1f！\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>pstu<span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>pstu<span class="token punctuation">)</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>pstu<span class="token punctuation">)</span><span class="token punctuation">.</span>score<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s的学号是%d，成绩是%.1f！\n"</span><span class="token punctuation">,</span> pstu<span class="token operator">-></span>name<span class="token punctuation">,</span> pstu<span class="token operator">-></span>num<span class="token punctuation">,</span> pstu<span class="token operator">-></span>score<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>输出都是：</p><pre><code>Tom的学号是13，成绩是136.5！</code></pre><p>先来认识一下结构成员的访问：</p><p>直接访问：结构变量的成员是通过点操作符  <code>.</code>  访问的</p><p>间接访问：利用操作符  <code>-&gt;</code>  （也称箭头操作符）通过结构体指针直接取得结构体成员</p><p>值得注意的是：通过结构体指针获取结构体成员，一般形式为：</p><p><code>(*pointer).memberName</code></p><p>或者：</p><p><code>pointer-&gt;memberName</code></p><p>第一种写法中， <code>.</code>  的优先级高于  <code>*</code> ，  <code>(*pointer)</code>  两边的括号不能少。如果去掉括号写作  <code>*pointer.memberName</code>  ，那么就等效于  <code>*( pointer.memberName)</code>  ，这样意义就完全不对了。</p><p>然后我们结合上面的例子来分析一下，为什么在操作结构体指针的时候，这两种输出的情况是一样的</p><p>首先，<mark>①</mark>  <code>pstu = &amp;stu;</code>  指针 pstu 指向了定义为 Student_TypeDef 类型的结构体，这个结构变量名为 stu；和数组不同的是，结构变量名并不是结构的地址；数组名在表达式中会被转换为数组指针，而结构体变量名不会，无论在任何表达式中它表示的都是整个集合本身，要想取得结构体变量的地址，因此得在结构变量名前加上  <code>&amp;</code>  运算符。<mark>②</mark>  <code>pointer-&gt;memberName</code>  输出结构先来分析使用  <code>-&gt;</code>  运算符的，也是最常用的方法；按照上面的，如果  <code>pstu == &amp;stu</code>  ，那么  <code>pstu-&gt;num</code>  即是  <code>stu.num</code>  ；这里 <strong>pstu 是一个指针</strong>，但是  <code>pstu-&gt;num</code>  是该指针所指向结构的一个成员，所以  <code>pstu-&gt;num</code>  是一个 int 类型的变量，至于为什么不能写成  <code>pstu.num</code>  ，因为 <strong>pstu 不是结构体</strong>。<mark>③</mark>  <code>(*pointer).memberName</code>  是等价于  <code>pointer-&gt;memberName</code>  的，如果  <code>pstu == &amp;stu</code>  ，那么  <code>*pstu == stu</code>  ，因为我们从上面学习到  <code>&amp;</code>  和  <code>*</code>  是一对互逆运算符；因此就有了这样的替代：  <code>stu.num == (*pstu).num</code>  。</p><h1 id="函数和指针"><a class="anchor" href="#函数和指针">#</a> 函数和指针</h1><p>1、返回指针的函数</p><p><code>int *pf(void)</code>  ：首先执行的是函数调用操作符 () ，因为它的优先级高于间接访问操作符；因此， <code>pf</code>  是一个函数，它的返回值是一个指向整形的指针。</p><p>2、指向函数的指针（函数指针）</p><p><code>int (*pf)(void)</code>  ：这个声明有两对括号，每对的含义各不相同。第二对括号是函数调用操作符，但第一对括号只起聚组的作用；它迫使间接访问在函数调用之前进行，使 pf 成为一个函数指针，它所指向的函数返回一个整形值 <strong>（你也可以这样理解：  <code>int pam(void)</code>  是我们常见的函数声明，它声明了  <code>pam</code>  是一个返回整形的函数；如果我们将  <code>pam</code>  替换为  <code>*pf</code>  ，由于  <code>pam</code>  是函数，因此  <code>*pf</code>  也是函数；而如果  <code>*pf</code>  是函数，则  <code>pf</code>  就成为指向该类型的指针，也就是函数指针）</strong> 。</p><p>我们知道在声明一个数据指针时，必须声明指针所指向的数据类型。而声明一个函数指针时，必须声明指针指向的函数类型；为了指明函数类型，要指明函数签名，即函数的返回类型和形参类型。在声明了函数指针后，可以把类型匹配的函数地址赋给它。</p><p>下面来个例子熟悉一遍：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NUM1</span>  <span class="token expression"><span class="token number">76</span></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NUM2</span>  <span class="token expression"><span class="token number">83</span></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">int</span> <span class="token function">max</span><span class="token punctuation">(</span> <span class="token keyword">char</span> x<span class="token punctuation">,</span> <span class="token keyword">char</span> y <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span>x<span class="token operator">></span>y <span class="token operator">?</span> x<span class="token operator">:</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">int</span> <span class="token function">min</span><span class="token punctuation">(</span> <span class="token keyword">char</span> x<span class="token punctuation">,</span> <span class="token keyword">char</span> y <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span>x<span class="token operator">&lt;</span>y <span class="token operator">?</span> x<span class="token operator">:</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">double</span> <span class="token function">product</span><span class="token punctuation">(</span> <span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span>x <span class="token operator">*</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">pam</span><span class="token punctuation">(</span> <span class="token keyword">char</span> <span class="token operator">*</span>ptf<span class="token punctuation">)</span>       <span class="token comment">// 返回指针的函数</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">return</span> ptf<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token keyword">char</span> temp<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"hello, world!"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">char</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">calloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>temp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 申请空间</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>pf<span class="token punctuation">)</span><span class="token punctuation">(</span> <span class="token keyword">char</span> a<span class="token punctuation">,</span> <span class="token keyword">char</span> b <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 指向函数的指针</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>    p <span class="token operator">=</span> <span class="token function">pam</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token comment">//  pf = product;     // 错误，编译器警报；product 与指针类型不匹配</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre>    pf <span class="token operator">=</span> max<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"max = %d\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>pf<span class="token punctuation">)</span><span class="token punctuation">(</span>NUM1<span class="token punctuation">,</span> NUM2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre>    pf <span class="token operator">=</span> min<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"min = %d\n"</span><span class="token punctuation">,</span> <span class="token function">pf</span><span class="token punctuation">(</span>NUM1<span class="token punctuation">,</span> NUM2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       </pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>从上面可以看到  <code>(*pf)()</code>  和  <code>pf()</code>  ，两种其中一种都可以；先来看第一种：由于  <code>pf</code>  指向  <code>max()</code>  函数，那么  <code>*pf</code>  就相当于  <code>max()</code>  函数，表达式  <code>(*pf)()</code>  和  <code>max()</code>  相同；第二种：由于函数名是指针，那么指针和函数名可以互换使用。但是我们一般都是使用第一种，也就是  <code>(*pf)()</code>  ，因为它明确指出是通过指针而非函数名来调用函数的，这样我们才好区分函数指针，如果我们用第二种，则看上去和函数调用无异。</p><h1 id="参考"><a class="anchor" href="#参考">#</a> 参考</h1><p><em>《C Primer Plus》</em></p><p><em>《C++ Primer Plus》</em></p><p><em>《C 和指针》</em></p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cucnVub29iLmNvbS93M2Nub3RlL2MtcG9pbnRlci1kZXRhaWwuaHRtbA==">C 指针详解</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21oamN1bXQvYXJ0aWNsZS9kZXRhaWxzLzczNTEwMzI=">C 语言指针的初始化和赋值</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xpbnBlbmdiaW4vYXJ0aWNsZS9kZXRhaWxzLzQzMjQzNTQ5">内存分配函数 malloc 与 calloc 的用法及区别</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21pc3N1ZXZlci9hcnRpY2xlL2RldGFpbHMvNTQwMDQ1">malloc 和 calloc 的区别</span></p><p><span class="exturl" data-url="aHR0cHM6Ly96aGlkYW8uYmFpZHUuY29tL3F1ZXN0aW9uLzI2MTg1ODIyNy5odG1sP3NvcnQ9MTEmYW1wO3JuPTUmYW1wO3BuPTAjd2d0LWFuc3dlcnM=">C 中指针变量何时需要初始化 malloc</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2phY2t5c3R1ZGlvL2FydGljbGUvZGV0YWlscy8xMTUxOTgxNw==">【C++ 基础之二】常量指针和指针常量</span></p><p><span class="exturl" data-url="aHR0cDovL2MuYmlhbmNoZW5nLm5ldC9jcHAvaHRtbC85NC5odG1s">C 语言结构体和指针</span></p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC8yMGU3YzM1NjhhMTI=">指针函数与函数指针（C 语言）</span></p>]]></content>
      
      
      
        <tags>
            
            <tag> history </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>常用逻辑电平标准总结</title>
      <link href="/docs/Essay/%E5%B8%B8%E7%94%A8%E9%80%BB%E8%BE%91%E7%94%B5%E5%B9%B3%E6%A0%87%E5%87%86%E6%80%BB%E7%BB%93/"/>
      <url>/docs/Essay/%E5%B8%B8%E7%94%A8%E9%80%BB%E8%BE%91%E7%94%B5%E5%B9%B3%E6%A0%87%E5%87%86%E6%80%BB%E7%BB%93/</url>
      
        <content type="html"><![CDATA[<blockquote><p>TTL、RS-232、RS422、RS-485 是指的电平标准（电信号），很多人把 RS-232、RS-422、RS-485 误称为通讯协议，这是很不应该的，其实它们仅是关于 UART 通讯的一个机械和电气接口标准（顶多是网络协议中的物理层面）；也就是说对 MCU 等控制器编写了 UART 程序，串行数据会通过硬件电路在设备间进行收发，这个硬件电路要遵循一个电平标准，实现设备间的交互。</p></blockquote><h1 id="前言"><a class="anchor" href="#前言">#</a> 前言</h1><p>要了解逻辑电平的内容，首先要知道以下几个概念的含义：</p><ol><li>输入高电平（VIH）：保证逻辑门的输入为高电平时所允许的最小输入高电平，当输入电平高于 VIH 时，则认为输入电平为高电平。</li><li>输入低电平（VIL）：保证逻辑门的输入为低电平时所允许的最大输入低电平，当输入电平低于 VIL 时，则认为输入电平为低电平。</li><li>输出高电平（VOH）：保证逻辑门的输出为高电平时的输出电平的最小值，逻辑门的输出为高电平时的电平值都必须大于此 VOH。</li><li>输出低电平（VOL）：保证逻辑门的输出为低电平时的输出电平的最大值，逻辑门的输出为低电平时的电平值都必须小于此 VOL。</li><li>阈值电平（VT）：数字电路芯片都存在一个阈值电平，就是电路刚刚勉强能翻转动作时的电平。它是一个界于 VIL、VIH 之间的电压值，对于 CMOS 电路的阈值电平，基本上是二分之一的电源电压值，但要保证稳定的输出，则必须要求输入高电平 &gt; VIH，输入低电平 &lt;VIL。 对于一般的逻辑电平，VIH，VIL，VOH，VOL 以及 VT 的关系可表示如下： VOH&gt; VIH &gt; VT &gt; VIL &gt; VOL。</li><li>IOH：逻辑门输出为高电平时的负载电流（为拉电流）。</li><li>IOL：逻辑门输出为低电平时的负载电流（为灌电流）。</li><li>IIL：逻辑门输入为高电平时的电流（为灌电流）。</li><li>IIL：逻辑门输入为低电平时的电流（为拉电流）。</li></ol><p>/------------------------------------------ 我是分割线  ------------------------------------------/</p><p><mark>串口</mark>：串口是一个泛称，UART、TTL、RS232、RS485 都遵循类似的通信时序协议，因此都被通称为串口。</p><p><mark>UART 接口</mark>：通用异步收发器（Universal Asynchronous Receiver/Transmitter)，UART 是串口收发的逻辑电路，这部分可以独立成芯片，也可以作为模块嵌入到其他芯片里，单片机、SOC、PC 里都会有 UART 模块。</p><p><mark>COM 口</mark>：特指台式计算机或一些电子设备上的 D-SUB 外形（一种连接器结构，VGA 接口的连接器也是 D-SUB）的串行通信口，应用了串口通信时序和 RS232 的逻辑电平。</p><p><mark>USB 口</mark>：通用串行总线，和串口完全是两个概念。虽然也是串行方式通信，但由于 USB 的通信时序和信号电平都和串口完全不同，因此和串口没有任何关系。USB 是高速的通信接口，用于 PC 连接各种外设，U 盘、键鼠、移动硬盘、当然也包括 “USB 转串口” 的模块。（USB 转串口模块，就是 USB 接口的 UART 模块）</p><h1 id="ttl电平标准"><a class="anchor" href="#ttl电平标准">#</a> TTL 电平标准</h1><p><strong>1、TTL</strong></p><p>TTL：Transistor-Transistor Logic 三极管结构。TTL 电平规定，+5V 等价于逻辑 '1'，0V 等价于逻辑 '0'。这样的数据通信及电平规定方式，被称做 TTL（晶体管 - 晶体管逻辑电平）信号系统。</p><p><mark>Vcc：5V；VOH &gt;= 2.4V；VOL &lt;= 0.5V；VIH &gt;= 2V；VIL &lt;= 0.8V。</mark></p><p><strong>2、LVTTL</strong></p><p>LVTTL：Low Voltage TTL。</p><p>3.3V LVTTL：<mark>Vcc：3.3V；VOH &gt;= 2.4V；VOL &lt;= 0.4V；VIH &gt;= 2V；VIL &lt;= 0.8V。</mark></p><p>2.5V LVTTL：Vcc：2.5V；VOH &gt;= 2.0V；VOL &lt;= 0.2V；VIH &gt;= 1.7V；VIL &lt;= 0.7V。</p><p><strong>3、注意事项</strong></p><p>TTL 电平一般过冲都会比较严重，可以在始端串 22 欧或 33 欧电阻； TTL 电平输入脚悬空时是内部认为是高电平。要下拉的话应用 1k 以下电阻下拉。TTL 输出不能驱动 CMOS 输入。</p><p><strong>4、‘0’ 和 ‘1’ 表示</strong></p><p><img data-src="20190827203036406.png" alt="在这里插入图片描述" /></p><h1 id="rs-232电平标准"><a class="anchor" href="#rs-232电平标准">#</a> RS-232 电平标准</h1><p><strong>1、RS-232</strong></p><p>RS-232：是美国电子工业协会 EIA（Electronic Industry Association）制定的一种串行物理接口标准。RS 是英文 “推荐标准” 的缩写，232 为标识号。RS-232 是对电气特性以及物理特性的规定，只作用于数据的传输通路上，它并不内含对数据的处理方式。</p><p>RS-232 标准是<mark>逻辑 '1' 为 -3V～-15V，逻辑 '0' 为 +3～+15V。</mark></p><p><strong>2、拓扑结构</strong></p><p><img data-src="20190827203559913.png" alt="在这里插入图片描述" /><br /><strong> 3、‘0’ 和 ‘1’ 表示</strong></p><p><img data-src="2019082720294271.png" alt="在这里插入图片描述" /></p><h1 id="rs-485电平标准"><a class="anchor" href="#rs-485电平标准">#</a> RS-485 电平标准</h1><p><strong>1、RS-485</strong></p><p>RS-485：RS-232 接口可以实现点对点的通信方式，但这种方式不能实现联网功能。于是，为了解决这个问题，一个新的标准 RS-485 产生了。RS-485 的数据信号采用差分传输方式，也称作平衡传输，它使用一对双绞线，将其中一线定义为 A，另一线定义为 B。</p><p>通常情况下，<mark>驱动器 AB 端口之间的正电平在 +2～+6V 标识为逻辑 '1'，负电平在 -2～-6V 标识为逻辑 '0'（这里的电平指 AB 两线间的电压差）。</mark></p><p>note：AB 两端的电压差最小为 0.2V 以上时有效，任何不大于 12V 或者不小于－7V 的差值对接受端都被认为是正确的。</p><p><strong>2、拓扑结构</strong></p><p><img data-src="20190827204107750.jpg" alt="在这里插入图片描述" /></p><p><strong>3、‘0’和‘1’表示</strong></p><p><img data-src="20190827205158528.png" alt="在这里插入图片描述" /></p><h1 id="rs-422电平标准"><a class="anchor" href="#rs-422电平标准">#</a> RS-422 电平标准</h1><p>RS-422 的电气性能与 RS-485 完全一样。主要的区别在于：RS-422 有 4 根信号线：两根发送、两根接收。由于 RS-422 的收与发是分开的所以可以同时收和发（全双工），也正因为全双工要求收发要有单独的信道，所以 RS-422 适用于两个站之间通信，星型网、环网，不可用于总线网；RS-485 只有 2 根信号线，所以只能工作在半双工模式，常用于总线网。</p><h1 id="rs-232-rs-422-与-rs-485-比较"><a class="anchor" href="#rs-232-rs-422-与-rs-485-比较">#</a> *RS-232、RS-422 与 RS-485 比较</h1><p><strong>RS-232</strong> 在 1962 年发布，命名为 EIA-232-E，作为工业标准，以保证不同 厂家产品之间的兼容。</p><p><strong>RS-422</strong> 由 RS-232 发展而来，它是为弥补 RS-232 之不足而提出的。 为改进 RS-232 通信距离短、速率低的缺点，RS-422 定义了一种平衡通信接口，将传输速率提高到 10Mb/s，传输距离延长到 4000 英尺（速率低于 100kb/s 时），并允许在一条平衡总线上连接最多 10 个接收器。RS-422 是一种单机发送、多机接收的单向、平衡传输规范，被命名为 TIA/EIA-422-A 标准。</p><p>为扩展应用范围，EIA 又于 1983 年在 RS-422 基础上制定了 <strong>RS-485</strong> 标准，增加了多点、双向通信能力，即允许多个发送器连接到同一条总线上， 同时增加了发送器的驱动能力和冲突保护特性，扩展了总线共模范围，后命名为 TIA/EIA-485-A 标准。由于 EIA 提出的建议标准都是以 “RS” 作为前缀，所以在通讯工业领域，仍然习惯将上述标准以 RS 作前缀称谓。</p><table><thead><tr><th style="text-align:center"></th><th style="text-align:center">RS-232</th><th style="text-align:center">RS-422</th><th style="text-align:center">RS-485</th></tr></thead><tbody><tr><td style="text-align:center">Cable</td><td style="text-align:center">Single ended</td><td style="text-align:center">Single ended multi-drop</td><td style="text-align:center">Multi-drop</td></tr><tr><td style="text-align:center">Number of Devices</td><td style="text-align:center">1 transmitter 1 receiver</td><td style="text-align:center">1 transmitter 10 receivers</td><td style="text-align:center">32 transmitters 32 receivers</td></tr><tr><td style="text-align:center">Communication Mode</td><td style="text-align:center">Full duplex</td><td style="text-align:center">Full duplex, Half duplex</td><td style="text-align:center">Full duplex, Half duplex</td></tr><tr><td style="text-align:center">Maximum Distance</td><td style="text-align:center">50 feet at 19.2 kbps</td><td style="text-align:center">4000 feet at 100 kbps</td><td style="text-align:center">4000 feet at 100 kbps</td></tr><tr><td style="text-align:center">Max Data Rate (50 feet)</td><td style="text-align:center">1 mbps</td><td style="text-align:center">10 mbps</td><td style="text-align:center">10 mbps</td></tr></tbody></table><p>RS232：3 线制、全双工、点对点通讯（因点对点通讯方式而无法联网，导致出现 RS485）</p><p>RS422：4 线制、全双工、点对多主从通讯（实际上还有一根信号地线，共 5 根线）</p><p>RS485：2 线式、半双工、点对多主从通讯（4 线制因只能点对点已经淘汰）</p><h1 id="can总线"><a class="anchor" href="#can总线">#</a> CAN 总线</h1><p><strong>1、CAN</strong></p><p>控制器局域网总线（CAN，Controller Area Network）是一种用于实时应用的串行通讯协议总线，它可以使用双绞线来传输信号，是世界上应用最广泛的现场总线之一。</p><p><mark>逻辑 '1' ：-1.5V -- 0V ，逻辑 '0' ：+1.5V -- +3V</mark>（这里的电平指 CAN_High、CAN_Low 两线间的电压差。）</p><p><strong>2、拓扑结构</strong></p><p><img data-src="20190827210438778.jpg" alt="在这里插入图片描述" /></p><p><strong>3、‘0’ 和 ‘1’ 表示</strong></p><p><img data-src="20190827210654200.png" alt="在这里插入图片描述" /></p><p><img data-src="20190827210510722.jpg" alt="在这里插入图片描述" /></p><h1 id="cmos电平标准"><a class="anchor" href="#cmos电平标准">#</a> CMOS 电平标准</h1><p><strong>1、CMOS</strong></p><p>CMOS：Complementary Metal Oxide Semiconductor。</p><p><mark>Vcc：5V；VOH &gt;= 4.45V；VOL &lt;= 0.5V；VIH &gt;= 3.5V；VIL &lt;= 1.5V。</mark></p><p>相对 TTL 有了更大的噪声容限，输入阻抗远大于 TTL 输入阻抗。</p><p><strong>2、LVCMOS</strong></p><p>LVCMOS：Low Voltage Complementary Metal Oxide Semiconductor。</p><p><mark>3.3V LVCMOS： Vcc：3.3V；VOH &gt;= 3.2V；VOL &lt;= 0.1V；VIH &gt;= 2.0V；VIL&lt;=0.7V。</mark></p><p>2.5V LVCMOS： Vcc：2.5V；VOH &gt;= 2V；VOL &lt;= 0.1V；VIH &gt;= 1.7V；VIL &lt;= 0.7V。</p><p><strong>3、注意事项</strong></p><p>LVCMOS 可以与 3.3V 的 LVTTL 直接相互驱动。</p><p>CMOS 电路不使用的输入端不能悬空。</p><h1 id="ecl电平标准"><a class="anchor" href="#ecl电平标准">#</a> ECL 电平标准</h1><p><strong>1、ECL</strong></p><p>ECL：Emitter Coupled Logic 发射极耦合逻辑电路（差分结构）。</p><p>Vcc：0V；Vee：-5.2V；VOH = -0.88V；VOL = -1.72V；VIH = -1.24V；VIL = -1.36V。</p><p><strong>2、PECL</strong></p><p>PECL：Pseudo / Positive ECL。</p><p>Vcc：5V；VOH = 4.12V；VOL = 3.28V；VIH = 3.78V；VIL = 3.64V 。</p><p><strong>3、LVPECL</strong></p><p>LVPECL：Low Voltage PECL。</p><p>Vcc：3.3V；VOH = 2.42V；VOL = 1.58V；VIH = 2.06V；VIL = 1.94V。</p><p><strong>4、注意事项</strong></p><p>射随输出结构，必须有电阻拉到一个直流偏置电压；由于 ECL 需要负电源，为简化电源产生了 PECL 和 LVPECL。</p><p>ECL：速度快，驱动能力强，噪声小，功耗大，很容易达到几百 M 的应用，需要负电源。</p><h1 id="lvds电平标准"><a class="anchor" href="#lvds电平标准">#</a> LVDS 电平标准</h1><p><strong>1、产生原因</strong></p><p>前面的电平标准摆幅都比较大，为降低电磁辐射，同时提高开关速度又推出 LVDS 电平标准。</p><p><strong>2、LVDS</strong></p><p>LVDS：Low Voltage Differential Signaling。LVDS 物理接口使用 1.2V 偏置电压作为基准，提供大约 400mV 摆幅。</p><p>LVDS 信号传输一般由三部分组成：差分信号发送器，差分信号互联器，差分信号接收 器。</p><p><strong>3、注意事项</strong></p><p>PCB 要求较高，差分线要求严格等长，差最好不超过 10mil（0.25mm）。</p><h1 id="gtl电平标准"><a class="anchor" href="#gtl电平标准">#</a> GTL 电平标准</h1><p><strong>1、GTL</strong></p><p>类似 CMOS 的一种结构，输入为比较器结构，比较器一端接参考电平，另一端接输入信号。1.2V 电源供电。</p><p>Vcc：1.2V；VOH &gt;= 1.1V；VOL &lt;= 0.4V；VIH &gt;= 0.85V；VIL &lt;= 0.75V 。</p><p><strong>2、PGTL / GTL+</strong></p><p>Vcc：1.5V；VOH &gt;= 1.4V；VOL &lt;= 0.46V；VIH&gt;=1.2V；VIL &lt;= 0.8V 。</p><h1 id="hstl电平标准"><a class="anchor" href="#hstl电平标准">#</a> HSTL 电平标准</h1><p>HSTL 是主要用于 QDR 存储器的一种电平标准：一般有 VCCIO = 1.8V 和 VCCIO = 1.5V。</p><p>和上面的 GTL 相似，输入为输入为比较器结构，比较器一端接参考电平（VCCIO / 2），另一端接输入信号。对参考电平要求比较高（1% 精度）。</p><h1 id="sstl电平标准"><a class="anchor" href="#sstl电平标准">#</a> SSTL 电平标准</h1><p>SSTL 主要用于 DDR 存储器。和 HSTL 基本相同。VCCIO = 2.5V，输入为输入为比较器结构，比较器一端接参考电平 1.25 V，另一端接输入信号。对参考电平要求比较高（1% 精度）。</p>]]></content>
      
      
      
        <tags>
            
            <tag> history </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DMX512协议</title>
      <link href="/docs/%E9%80%9A%E8%AE%AF%E5%8D%8F%E8%AE%AE/DMX512%E5%8D%8F%E8%AE%AE/"/>
      <url>/docs/%E9%80%9A%E8%AE%AF%E5%8D%8F%E8%AE%AE/DMX512%E5%8D%8F%E8%AE%AE/</url>
      
        <content type="html"><![CDATA[<blockquote><p>DMX512（digital multiplex）</p><p>其实就是主机向从机整包单向广播发送的协议（protocol），从机自取所需。</p><p>DMX512 数据协议是美国舞台灯光协会（USITT）于 1990 年发布的一种灯光控制器与灯具设备进行数据传输的标准。它包括电气特性，数据协议，数据格式等方面的内容。<br />512 协议规定使用的波特率是 250Kbps</p></blockquote><h1 id="链接拓扑network-topology"><a class="anchor" href="#链接拓扑network-topology">#</a> 链接拓扑（network topology）</h1><p>根据后面的协议可以知道，其实就是将所有的 slave 挂到线上去。（线最长可以多长？）</p><p><img data-src="20190805215926835.png" alt="img" /></p><h1 id="协议protocol时序"><a class="anchor" href="#协议protocol时序">#</a> 协议（protocol）时序</h1><p>1） 先说明地址，包的格式是固定的，第一个数据帧就是地址 1（说是 0 也可以），接下来的数据帧，地址逐渐 + 1。</p><p>2） 1 slot 或者叫 1 data frame（数据帧）= 1 start bit（低电平） + 8 data bits + 2 stop bits（高电平） = 11bits， 1bit = 4us，1slot = 44us。（下图右下角的蓝色字体部分）</p><p>3） 1 packet （数据包）= 1 Break + 1 MAB（mark after break） + 1 SC（start code） + 512 slots + 1 MTBP（mark time between packets） （下图红色字体部分）</p><ul><li>1 break 典型值 88us</li><li>MAB 典型值 8us</li><li>SC 就是一帧 44us，第 0 帧</li><li>MTBP，高电平有效，0 - 1s 之间</li></ul><p>time = 88us + 8us + 44us + 512 * 44us + 0 = 22668us = 22.668ms 发包频率 44.11Hz，也就是控制频率了，如果地址用不完，把 slot 减少，时间也可以节省，然后频率可以更高了。(调光控制台每发送一个信息包，可以对全部 512 个受控通道形成一次全面的控制。发送一个信息包的时间大约是 23 ms，每秒钟将对所有 512 个受控通道完成 44 次控制，即受控光路的刷新频率 44 Hz，如果实际受控通道少于 512 个，那么刷新频率将相应提高。)</p><p><img data-src="20190805220038760.png" alt="img" /></p><p>每个 slot 对应右下角放大的每帧时序：</p><p><img data-src="20190805220057706.png" alt="img" /></p><ol><li><p>START BIT 为开始位，宽度为一个比特，是受控灯具准备接收并解码控制数据的开始标志。</p></li><li><p>STOP BITS 为结束位，宽度为两个比特，表示一个指令帧的结束。</p></li><li><p>D0～ D7 为 8 位控制数据，其电平组合从 00000000 ~ 11111111 共有 256 个状态（对应十进制数的 0～255），控制灯光的亮度时，可产生 256 个亮度等级，00000000 (0) 对应灯光最暗，11111111 (255) 对应灯光最亮。</p></li><li><p>无校验位。</p></li><li><p>DMX512 指令的位宽（每比特宽度）是 4 us，每一个指令帧 11 位，故指令帧宽度为 44 us，传输速率为 1 / 44us = 250 kbps。</p></li></ol><p><strong>note：</strong> 一个完整的 DMX512 信息包（Packet）由一个 Break 位、一个 MAB 位、一个 SC 、512 个数据帧和一个 MTBP 位构成。</p><ol><li>Break 为中断位，对应一个信息包结束后的程序复位阶段，宽度不少于两个帧（22 bit，1bit = 4us）。</li><li>程序复位结束后应发送控制数据，但由于每一个数据帧的第一位（即开始位）为低电平，所以必须用一个高电平脉冲间隔前后两个低电平脉冲，这个起间隔、分离作用的高电平脉冲即 MAB（Mark After Break），此脉冲一到，意味着 “新一轮” 的控制又开始了。</li><li>SC（Start Code）意为开始代码帧（slot0），和此后到来的数据帧一样，也是由 11 位构成，除两个高电平的结束位之外，其他 9 位全部是低电平，通常将其叫做第 0 帧或第 0 通道，可理解为一个不存在的通道。</li><li>MTBP（Mark TimeBetween Packets）标志着一个完整的信息包发送完毕，是下一个信息包即将开始的 “空闲位”，高电平有效。</li></ol><h1 id="时序规格标准"><a class="anchor" href="#时序规格标准">#</a> 时序规格标准</h1><p>在 DMX512-A 草案中，执行的标准如下：</p><p><img data-src="image-20230112233937497.png" alt="image-20230112233937497" /></p><ul><li>Timing Diagram Values for Transmitter</li></ul><table><thead><tr><th style="text-align:center">Designation</th><th style="text-align:center">Description</th><th style="text-align:center">Min</th><th style="text-align:center">Typical</th><th style="text-align:center">Max</th><th style="text-align:center">Unit</th></tr></thead><tbody><tr><td style="text-align:center">-</td><td style="text-align:center">Bit Rate</td><td style="text-align:center">245</td><td style="text-align:center">250</td><td style="text-align:center">255</td><td style="text-align:center">kbit / sec</td></tr><tr><td style="text-align:center">-</td><td style="text-align:center">Bit Time</td><td style="text-align:center">3.92</td><td style="text-align:center">4</td><td style="text-align:center">4.08</td><td style="text-align:center">µs</td></tr><tr><td style="text-align:center">-</td><td style="text-align:center">Min. Update time for 513 slots</td><td style="text-align:center">-</td><td style="text-align:center">22.7</td><td style="text-align:center">-</td><td style="text-align:center">ms</td></tr><tr><td style="text-align:center">-</td><td style="text-align:center">Max. Refresh rate for 513 slots</td><td style="text-align:center">-</td><td style="text-align:center">44</td><td style="text-align:center">-</td><td style="text-align:center">updates / sec</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">SPACE for BREAK</td><td style="text-align:center">92</td><td style="text-align:center">176</td><td style="text-align:center">-</td><td style="text-align:center">µs</td></tr><tr><td style="text-align:center">2</td><td style="text-align:center">MARK after BREAK (MAB)</td><td style="text-align:center">12</td><td style="text-align:center">-</td><td style="text-align:center">&lt; 10^6</td><td style="text-align:center">µs</td></tr><tr><td style="text-align:center">9</td><td style="text-align:center">MARK Time between slots</td><td style="text-align:center">0</td><td style="text-align:center">-</td><td style="text-align:center">&lt; 1.00</td><td style="text-align:center">s</td></tr><tr><td style="text-align:center">10</td><td style="text-align:center">MARK before BREAK (MBB)</td><td style="text-align:center">0</td><td style="text-align:center">-</td><td style="text-align:center">&lt; 1.00</td><td style="text-align:center">s</td></tr><tr><td style="text-align:center">11</td><td style="text-align:center">BREAK to BREAK time</td><td style="text-align:center">1204</td><td style="text-align:center">-</td><td style="text-align:center">10^6</td><td style="text-align:center">µs</td></tr><tr><td style="text-align:center">13</td><td style="text-align:center">DMX512 Packet</td><td style="text-align:center">1204</td><td style="text-align:center">-</td><td style="text-align:center">10^6</td><td style="text-align:center">µs</td></tr></tbody></table><ul><li>Timing Diagram Values for Receivers</li></ul><table><thead><tr><th style="text-align:center">Designation</th><th style="text-align:center">Description</th><th style="text-align:center">Min</th><th style="text-align:center">Typical</th><th style="text-align:center">Max</th><th style="text-align:center">Unit</th></tr></thead><tbody><tr><td style="text-align:center">-</td><td style="text-align:center">Bit Rate</td><td style="text-align:center">245</td><td style="text-align:center">250</td><td style="text-align:center">255</td><td style="text-align:center">kbit / sec</td></tr><tr><td style="text-align:center">-</td><td style="text-align:center">Bit Time</td><td style="text-align:center">3.92</td><td style="text-align:center">4</td><td style="text-align:center">4.08</td><td style="text-align:center">µs</td></tr><tr><td style="text-align:center">-</td><td style="text-align:center">Min. Update time for 513 slots</td><td style="text-align:center">-</td><td style="text-align:center">22.7</td><td style="text-align:center">-</td><td style="text-align:center">ms</td></tr><tr><td style="text-align:center">-</td><td style="text-align:center">Max. Refresh rate for 513 slots</td><td style="text-align:center">-</td><td style="text-align:center">44</td><td style="text-align:center">-</td><td style="text-align:center">updates / sec</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">SPACE for BREAK</td><td style="text-align:center">88</td><td style="text-align:center">176</td><td style="text-align:center">-</td><td style="text-align:center">µs</td></tr><tr><td style="text-align:center">2</td><td style="text-align:center">MARK after BREAK (MAB)</td><td style="text-align:center">8</td><td style="text-align:center">-</td><td style="text-align:center">&lt; 10^6</td><td style="text-align:center">µs</td></tr><tr><td style="text-align:center">9</td><td style="text-align:center">MARK Time between slots</td><td style="text-align:center">0</td><td style="text-align:center">-</td><td style="text-align:center">&lt; 1.00</td><td style="text-align:center">s</td></tr><tr><td style="text-align:center">10</td><td style="text-align:center">MARK before BREAK (MBB)</td><td style="text-align:center">0</td><td style="text-align:center">-</td><td style="text-align:center">&lt; 1.00</td><td style="text-align:center">s</td></tr><tr><td style="text-align:center">11</td><td style="text-align:center">BREAK to BREAK time</td><td style="text-align:center">1196</td><td style="text-align:center">-</td><td style="text-align:center">1.25 * 10^6</td><td style="text-align:center">µs</td></tr><tr><td style="text-align:center">13</td><td style="text-align:center">DMX512 Packet</td><td style="text-align:center">1204</td><td style="text-align:center">-</td><td style="text-align:center">1.26 * 10^6</td><td style="text-align:center">µs</td></tr></tbody></table><h1 id="通道控制"><a class="anchor" href="#通道控制">#</a> 通道控制</h1><p>目前由于灯光种类的多样性，不再是只用单通道控制一款灯亮度这么简单了；像摇头灯、彩色灯等灯光设备，需占几个或几十个控制通道；每个通道对应不同的功能，该功能根据灯厂资料提供，如下所例：</p><p><img data-src="_______1.png" alt="img" /></p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuYWJvbGlnaHQuY29tL3Byb2Qvc29ydDIvczYucGhw">https://www.abolight.com/prod/sort2/s6.php</span></p><p><span class="exturl" data-url="aHR0cDovL3d3dy5hYm9saWdodC5jb20vcHJvZC9zb3J0OC9sa2lwLWxlZDE1MGMucGhw">http://www.abolight.com/prod/sort8/lkip-led150c.php</span></p><h1 id="非标程序设计"><a class="anchor" href="#非标程序设计">#</a> 非标程序设计</h1><p>基于 DMX512 控制协议进行调光控制的灯光系统叫做数字灯光系统。目前，包括摇头灯在内的各种舞台灯、调光控制器、控制台、换色器等各种灯光控制设备，都对 DMX512 协议进行支持，已全面实现调光控制的数字化，并在此基础上，逐渐趋于网络化（ArtNet 协议）。那么，根据上面的协议通讯，我们是否可以模拟信号对 DMX512 协议进行非标设计呢？答案是可以的。</p><h1 id="参考"><a class="anchor" href="#参考">#</a> 参考</h1><p>《ANSI-ESTA_E1-11_2008R2018.pdf》</p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuZXJ3aW5yb2wuY29tL3BhZ2UvYXJ0aWNsZXMvZG14NTEyLw==">https://www.erwinrol.com/page/articles/dmx512/</span></p><p><span class="exturl" data-url="aHR0cHM6Ly93dzEubWljcm9jaGlwLmNvbS9kb3dubG9hZHMvZW4vQXBwbm90ZXMvMDEwNzZBLnBkZg==">https://ww1.microchip.com/downloads/en/Appnotes/01076A.pdf</span></p><p><span class="exturl" data-url="aHR0cDovL3BpY3Byb2plY3RzLm9yZy51ay9wcm9qZWN0cy9kbXgvZG14Njg4Lw==">http://picprojects.org.uk/projects/dmx/dmx688/</span></p>]]></content>
      
      
      
        <tags>
            
            <tag> history </tag>
            
            <tag> DMX512 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>来学点 Makefile</title>
      <link href="/docs/Essay/%E6%9D%A5%E5%AD%A6%E7%82%B9%20Makefile/"/>
      <url>/docs/Essay/%E6%9D%A5%E5%AD%A6%E7%82%B9%20Makefile/</url>
      
        <content type="html"><![CDATA[<p><strong>参考链接：</strong></p><p><span class="exturl" data-url="aHR0cHM6Ly9zZWlzbWFuLmdpdGh1Yi5pby9ob3ctdG8td3JpdGUtbWFrZWZpbGUvaW5kZXguaHRtbA==">跟我一起写 Makefile — 跟我一起写 Makefile 1.0 文档</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9mYW56aGVuZy5vcmcvYXJjaGl2ZXMvNDM=">Makefile 简明教程 - FanZheng's blog</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9oYWNrZXIteWhqLmdpdGh1Yi5pby9yZXNvdXJjZXMvZ3VuX21ha2UucGRm">https://hacker-yhj.github.io/resources/gun_make.pdf</span></p><blockquote><p>在使用 gcc 编译器开发的时候，会用到 Makefile，那么，就来记录一下 Makefile 的学习。</p><p>首先呢，先说明一下观看顺序，咳咳，其实就是自己学的时候后面发现这样学更有趣味。</p><p><strong>正式入主题：</strong></p><ol><li>先大致看一下上面链接一的内容，先不用深记，只需大概知道有哪些内容，对应在哪个位置就行了，因为后面还要返回去，毕竟大神写的文章细味斟酌，回头品尝又是一番滋味；</li><li>链接二的内容可谓是初学者福利啊（至少对于我来说是这样），作者挑了一些常用的内容列举出来，话不多说，结合例子容易理解，然后可以每学一个内容可以回去翻看链接一大神写的内容，相互结合更好学习</li><li>链接三是另一个大佬整理出来的 GNU make 中文手册</li><li>最后，下文是本人觉得有要用到的一些知识的整理</li></ol></blockquote><h1 id="makefile结构说明"><a class="anchor" href="#makefile结构说明">#</a> Makefile 结构说明</h1><p>Makefile 里主要包含了五个东西：显式规则、隐晦规则、变量定义、文件指示和注释。</p><ol><li>显式规则。显式规则说明了如何生成一个或多个目标文件。这是由 Makefile 的书写者明显指出要生成的文件、文件的依赖文件和生成的命令。</li><li>隐晦规则。由于我们的 make 有自动推导的功能，所以隐晦的规则可以让我们比较简略地书写 Makefile，这是由 make 所支持的。</li><li>变量的定义。在 Makefile 中我们要定义一系列的变量，变量一般都是字符串，这个有点像你 C 语言中的宏，当 Makefile 被执行时，其中的变量都会被扩展到相应的引用位置上。</li><li>文件指示。其包括了三个部分，一个是在一个 Makefile 中引用另一个 Makefile，就像 C 语言中的  <code>include</code>  一样；另一个是指根据某些情况指定 Makefile 中的有效部分，就像 C 语言中的预编译  <code>#if</code>  一 样；还有就是定义一个多行的命令。</li><li>注释。Makefile 中只有行注释，和 UNIX 的 Shell 脚本一样，其注释是用  <code>#</code>  字符，这个就 像 C/ C++ 中的  <code>//</code>  一样。如果你要在你的 Makefile 中使用  <code>#</code>  字符，可以用反斜杠进行 转义，如： <code> \#</code>  。</li></ol><h1 id="文件说明"><a class="anchor" href="#文件说明">#</a> 文件说明</h1><table><thead><tr><th style="text-align:center"></th><th style="text-align:center"><strong>WINDOWS</strong></th><th style="text-align:center"><strong>LINUX</strong></th></tr></thead><tbody><tr><td style="text-align:center">目标文件</td><td style="text-align:center">.obj</td><td style="text-align:center">.o</td></tr><tr><td style="text-align:center">静态库</td><td style="text-align:center">.lib</td><td style="text-align:center">.a</td></tr><tr><td style="text-align:center">动态库</td><td style="text-align:center">.dll</td><td style="text-align:center">.so</td></tr></tbody></table><p>约定俗成，一般开发者使用的 makefile 文件是大写字母开头的 Makefile，使用者使用的是小写的 makefile（<em>默认的情况下，<strong>make</strong> 命令会在当前目录下按顺序找寻文件名为 <strong>“ GNUmakefile ”</strong> 、 <strong>“ makefile ”</strong> 、 <strong>“ Makefile ”</strong> 的文件，找到了就解析这个文件。在这三个文件名中，最好使用 “Makefile” 这个文件名，因为，这个文件名第一个字符为大写，这样有一种显目的感觉。最好不要用 “ GNUmakefile ” ，这个文件是 GNU 的 make 识别的。有另外一些 make 只对全小写的 “ makefile ” 文件名敏感，但是基本上来说，大多数的 make 都支持 <strong>“ makefile ”</strong> 和 <strong>“ Makefile ”</strong> 这两种默认文件名。<strong>我们也可以使用  <code>make –f filename</code>  指定所要解释的 Makefile 的文件名</strong></em>）</p><h1 id="make-的工作方式"><a class="anchor" href="#make-的工作方式">#</a> <strong>make</strong> 的工作方式</h1><p>- 1. 读入主 Makefile (主 Makefile 中可以引用其他 Makefile)</p><p>- 2. 读入被 include 的其他 Makefile</p><p>- 3. 初始化文件中的变量</p><p>- 4. 推导隐晦规则，并分析所有规则</p><p>- 5. 为所有的目标文件创建依赖关系链</p><p>- 6. 根据依赖关系，决定哪些目标要重新生成</p><p>- 7. 执行生成命令</p><h1 id="makefile-的规则"><a class="anchor" href="#makefile-的规则">#</a> Makefile 的规则</h1><figure class="highlight text"><figcaption data-lang="text"></figcaption><table><tr><td data-num="1"></td><td><pre>target ... : prerequisites ...</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>&lt;tab> command</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>       ...</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>       ...</pre></td></tr></table></figure><p>&quot;目标&quot; 是必需的，不可省略；&quot;前置条件&quot; 和 &quot;命令&quot; 都是可选的，但是两者之中必须至少存在一个。</p><p><strong>Target（目标）</strong></p><p>可以是一个 object file（目标文件），也可以是一个执行文件，还可以是一个标签（label），指明 make 命令所要构建的对象。目标（target）后面必须有冒号  <code>:</code></p><p><strong>Prerequisites（前置条件）</strong></p><p>生成该 target 所依赖的文件和 / 或 target。前置条件通常是一组文件名，之间用空格分隔。它指定了 “目标” 是否重新构建的判断标准：只要有一个前置文件不存在，或者有过更新（前置文件的 late-modification 时间戳比目标的时间戳新），“目标” 就需要重新构建</p><p><strong>Command（命令）</strong></p><p>该 target 要执行的命令（任意的 Shell 命令）。表示如何更新目标文件，有一行或多行的 Shell 命令组成。它是构建 “目标” 的具体命令，他是运行结果通常就是生成目标文件。每行命令行必须以 tap 键作为开头</p><p>注意：</p><ul><li>必须讲明， <strong>Makefile 的命令是要调用 shell 来运行的</strong> ，而到底是使用的哪个 shell 取决于 Makefile 中 SHELL 变量的设置，默认为  <code>/bin/sh</code>  就是 bash。</li><li><strong>在 Makefile 中使用 bash 的变量。</strong> Makefile 中使用  <code>$()</code>  引用的是 Makefile 内的变量，如果想使用 bash 环境的变量要使用双美元引用  <code>$$</code>  ，使用单个  <code>$</code>  引用的变量全部被解释为 Makefile 的变量。以此类推，如果要想试图用 bash 中的进程号码就要使用四个  <code>$</code>  ，即：  <code>$$$$</code>  。</li><li>另外，值得强调的一点是： <strong>Makefile 是一次发送一行命令，每发送一次命令，就会启动一个 subshell 来运行</strong>。这意味着命令之间不能共享变量，而且 bash 中可以使用的 for 和 while，在这里面也不能换行，因为每行会被单独的发送给 bash 来执行。要解决这个问题，要么使用 Makefile 中的换行符  <code>\</code>  ，要么写成单行的形式。</li><li>在命令行之间中的空格或是空行会被忽略，但是如果该空格或空行是以 Tab 键开头的，那么 make 会认为其是一个空命令。</li></ul><h1 id="注释符"><a class="anchor" href="#注释符">#</a>  <code>#</code>  注释符</h1><p><code>#</code>  字符是注释符，Makefile 把  <code>#</code>  字符后面的内容作为注释内容处理（shell、perl 脚本也是使用  <code>#</code>  字符作为注释符）。如果某行的第一个非空字符为  <code>#</code> ，则此行会被 make 解释为注释行（命令行除外，如果 Tab 字符之后使用  <code>#</code>  字符，则会被 make 解释为命令行）。</p><p>注释行的结尾如果存在反斜线  <code>\</code> ，那么下一行也被作为注释行。</p><p>如果需要注视多行，在注释行的结尾加行反斜线 (), 下一行也被注释，可以注释多行。</p><p><strong>建议在书写 Makefile 时将注释作为一个独立的行，而不要和 Makefile 的有效行放在同一行中书写。make 有时候会把 # 字符之前的内容作为有效行的内容（如定义变量的时候）。</strong></p><p>当在 Makefile 中需要使用字符 # 时，可以使用  <code>\</code>  加  <code>#</code> （ <code>\#</code>  ）来实现，表示将  <code>#</code>  字符作为一个普通字符而不是注释符。</p><h1 id="gcc常用参数"><a class="anchor" href="#gcc常用参数">#</a> GCC 常用参数</h1><p>**-c：** 只编译不链接，仅生成目标文件</p><p>**-o：** 指定输出文件名</p><p>**-l：** 手动添加链接库</p><p>**-E：** 生成预处理文件</p><p>**-S：** 生成汇编文件</p><p>**-I：** 将系统缺省的头文件路径扩展到当前路径</p><p>**-O2：** 表示我们希望编译器在编译的时候对我们的程序进行一定程度的优化。2 表示我们优化的级别是 2。范围是 1-3（O/ O2/ O3）。不过习惯上我们都使用 2 的优化级别</p><p>**-g：** 生成调试信息</p><p>**-Wall：** 显示警告信息</p><h1 id="基础变量"><a class="anchor" href="#基础变量">#</a> 基础变量</h1><ul><li><code>=</code>  递归展开：变量<strong>只在引用时</strong>才确定它的值，因此这句话在 Makefile 中的任何位置都没有区别，即使它引用了其他变量，除非对自身多次赋值。需要注意避免循环定义</li><li><code>:=</code>  直接展开：变量的值在写这句话时就已经确定。若它引用了其他变量，则直接用那个变量当前的值，而不管该变量在此之后值如何变化</li><li><code>?=</code>  条件赋值：只有此变量在之前没有赋值的情况下才会对这个变量进行赋值，<strong>它是递归展开的</strong></li><li><code>+=</code>  追加赋值：给变量追加内容，<strong>但会在追加内容之前添加一个空格</strong>。它是直接展开还是递归展开取决于该变量上一次赋值的方式</li></ul><h1 id="自动变量automatic-variables"><a class="anchor" href="#自动变量automatic-variables">#</a> 自动变量（Automatic Variables）</h1><ul><li><code>$@</code>  ：<strong>表示规则中的目标文件集</strong>。在模式规则中，如果有多个目标，那么，  <code>$@</code>  就是匹配于目标中模式定义的集合。</li><li><code>$%</code>  ：仅当目标是函数库文件中，<strong>表示规则中的目标成员名</strong>。例如，如果一个目标是  <code>foo.a(bar.o)</code> ， 那么，  <code>$%</code>  就是  <code>bar.o</code>  ，  <code>$@</code>  就是  <code>foo.a</code>  。如果目标不是函数库文件（Unix 下是  <code>.a</code>  ，Windows 下是  <code>.lib</code>  ），那么，其值为空。</li><li><code>$&lt;</code>  ：<strong>依赖目标中的第一个目标名字</strong>。如果依赖目标是以模式（即  <code>%</code>  ）定义的，那么  <code>$&lt;</code>  将是符合模式的一系列的文件集。注意，其是一个一个取出来的。</li><li><code>$?</code>  ：<strong>所有比目标新的依赖目标的集合</strong>。以空格分隔。</li><li><code>$^</code>  ：<strong>所有的依赖目标的集合</strong>。以空格分隔。如果在依赖目标中有多个重复的，那个这个变量会去除重复的依赖目标，只保留一份。</li><li><code>$+</code>  ：这个变量很像  <code>$^</code>  ，<strong>也是所有依赖目标的集合；只是它不去除重复的依赖目标</strong>。</li><li><code>$*</code>  ：这个变量表示目标模式中  <code>%</code>  及其之前的部分。如果目标是  <code>dir/a.foo.b</code>  ，并且目标的模式是  <code>a.%.b</code>  ，那么，  <code>$*</code>  的值就是  <code>dir/a.foo</code>  。这个变量对于构造有关联的 文件名是比较有较。如果目标中没有模式的定义，那么  <code>$*</code>  也就不能被推导出，但是，如果目标文件的 后缀是 make 所识别的，那么  <code>$*</code>  就是除了后缀的那一部分。例如：如果目标是  <code>foo.c</code>  ，因为  <code>.c</code>  是 make 所能识别的后缀名，所以，  <code>$*</code>  的值就是  <code>foo</code>  。<strong>这个特性是 GNU make 的， 很有可能不兼容于其它版本的 make</strong>，所以，你应该尽量避免使用  <code>$*</code>  ，除非是在隐含规则或是静态模式中。如果目标中的后缀是 make 所不能识别的，那么  <code>$*</code>  就是空值。</li></ul><h1 id="隐晦规则"><a class="anchor" href="#隐晦规则">#</a> 隐晦规则</h1><h2 id="关于命令的变量"><a class="anchor" href="#关于命令的变量">#</a> 关于命令的变量</h2><ul><li>AR : 函数库打包程序。默认命令是  <code>ar</code></li><li>AS : 汇编语言编译程序。默认命令是  <code>as</code></li><li>CC : C 语言编译程序。默认命令是  <code>cc</code></li><li>CXX : C++ 语言编译程序。默认命令是  <code>g++</code></li><li>CO : 从 RCS 文件中扩展文件程序。默认命令是  <code>co</code></li><li>CPP : C 程序的预处理器（输出是标准输出设备）。默认命令是  <code>$(CC) –E</code></li><li>FC : Fortran 和 Ratfor 的编译器和预处理程序。默认命令是  <code>f77</code></li><li>GET : 从 SCCS 文件中扩展文件的程序。默认命令是  <code>get</code></li><li>LEX : Lex 方法分析器程序（针对于 C 或 Ratfor）。默认命令是  <code>lex</code></li><li>PC : Pascal 语言编译程序。默认命令是  <code>pc</code></li><li>YACC : Yacc 文法分析器（针对于 C 程序）。默认命令是  <code>yacc</code></li><li>YACCR : Yacc 文法分析器（针对于 Ratfor 程序）。默认命令是  <code>yacc –r</code></li><li>MAKEINFO : 转换 Texinfo 源文件（ <code>.texi</code> ）到 Info 文件程序。默认命令是  <code>makeinfo</code></li><li>TEX : 从 TeX 源文件创建 TeX DVI 文件的程序。默认命令是  <code>tex</code></li><li>TEXI2DVI : 从 Texinfo 源文件创建军 TeX DVI 文件的程序。默认命令是  <code>texi2dvi</code></li><li>WEAVE : 转换 Web 到 TeX 的程序。默认命令是  <code>weave</code></li><li>CWEAVE : 转换 C Web 到 TeX 的程序。默认命令是  <code>cweave</code></li><li>TANGLE : 转换 Web 到 Pascal 语言的程序。默认命令是  <code>tangle</code></li><li>CTANGLE : 转换 C Web 到 C。默认命令是  <code>ctangle</code></li><li>RM : 删除文件命令。默认命令是  <code>rm –f</code></li></ul><h2 id="关于命令参数的变量"><a class="anchor" href="#关于命令参数的变量">#</a> 关于命令参数的变量</h2><p>下面的这些变量都是相关上面的命令的参数。如果没有指明其默认值，那么其默认值都是空。</p><ul><li>ARFLAGS : 函数库打包程序 AR 命令的参数。默认值是  <code>rv</code></li><li>ASFLAGS : 汇编语言编译器参数。（当明显地调用  <code>.s</code>  或  <code>.S</code>  文件时）</li><li>CFLAGS : C 语言编译器参数。</li><li>CXXFLAGS : C++ 语言编译器参数。</li><li>COFLAGS : RCS 命令参数。</li><li>CPPFLAGS : C 预处理器参数。（ C 和 Fortran 编译器也会用到）。</li><li>FFLAGS : Fortran 语言编译器参数。</li><li>GFLAGS : SCCS “get” 程序参数。</li><li>LDFLAGS : 链接器参数。（如：  <code>ld</code>  ）</li><li>LFLAGS : Lex 文法分析器参数。</li><li>PFLAGS : Pascal 语言编译器参数。</li><li>RFLAGS : Ratfor 程序的 Fortran 编译器参数。</li><li>YFLAGS : Yacc 文法分析器参数。</li></ul><h1 id="make-自动推导"><a class="anchor" href="#make-自动推导">#</a> Make 自动推导</h1><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>foo.o: foo.c foo.h       <span class="token comment"># foo 模块</span></pre></td></tr><tr><td data-num="2"></td><td><pre>gcc <span class="token parameter variable">-c</span> foo.c</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>bar.o: bar.c bar.h </pre></td></tr><tr><td data-num="5"></td><td><pre>gcc <span class="token parameter variable">-c</span> bar.c </pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>main: main.c foo.h bar.h foo.o bar.o </pre></td></tr><tr><td data-num="8"></td><td><pre>gcc main.c <span class="token parameter variable">-o</span> main foo.o bar.o</pre></td></tr></table></figure><p>该例子的场景是：我们要通过  <code>main.c</code>  编译一个叫做  <code>main</code>  的程序，它需要使用  <code>foo.c</code>  和  <code>bar.c</code>  里的函数，同时需要引入相关头文件里的声明。该任务通过  <code>make main</code>  来执行。</p><p><code>foo.o</code>  是我们的目标， <code>foo.c</code>  和  <code>foo.h</code>  是目标所依赖的源文件，而只有一个命令  <code>gcc -c foo.c</code>  （以 Tab 键开头）； <code>bar.o</code>  这个目标同理。这个规则告诉我们两件事：</p><ol><li>文件的依赖关系，  <code>foo.o</code>  依赖于  <code>foo.c</code>  和  <code>foo.h</code>  的文件，如果 foo.c 和  <code>foo.h</code>  的文件日期要比  <code>foo.o</code>  文件日期要新，或是  <code>foo.o</code>  不存在，那么依赖关系发生。</li><li>生成或更新  <code>foo.o</code>  文件，就是那个 gcc 命令。它说明了如何生成  <code>foo.o</code>  这个文件。 （当然， <code>foo.c</code>  文件 include 了  <code>foo.h</code>  文件）</li></ol><p>而  <code>main</code>  的 “依赖” 中有  <code>foo.o</code>  和  <code>bar.o</code>  ，它们两个必须先被构建。当我们执行  <code>make main</code>  时，由于  <code>foo.o</code>  和  <code>bar.o</code>  并不存在， <code>make </code>  程序就会在 Makefile 中寻找这两个 “目标” 的构建方法，构建完成后再进行  <code>main</code>  的构建。</p><p>再看一下下面的例子，执行的结果同样跟上面的例子一样</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>foo.o: foo.h </pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>bar.o: bar.h </pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>main: main.c foo.h bar.h foo.o bar.o </pre></td></tr><tr><td data-num="6"></td><td><pre>gcc main.c <span class="token parameter variable">-o</span> main foo.o bar.o</pre></td></tr></table></figure><p>通过对比发现，  <code>.o</code>  文件所依赖的  <code>.c</code>  文件省略掉了，同时也把命令省略了，这是为什么呢？</p><p>make 很强大，它可以自动推导文件以及文件依赖关系后面的命令，于是我们就没必要去在每一个  <code>.o</code>  文件后都写上类似的命令，因为，我们的 make 会自动识别，并自己推导命令。</p><p>只要 make 看到一个  <code>.o</code>  文件，它就会自动的把  <code>.c</code>  文件加在依赖关系中，如果 make 找到一个  <code>bar.o</code>  ，那么  <code>bar.c</code>  就会是  <code>bar.o</code>  的依赖文件。并且  <code>gcc -c bar.c</code>  也会被推导出来，于是，我们的 Makefile 再也不用写得这么复杂；这样就得到了上面第二个例子。这种方法，也就是 make 的 “隐晦规则” 。</p><p>但在日常使用中，我们为什么要像  <code>foo.o: foo.c foo.h</code>  一样将必然存在的文件设置成 “依赖” 呢？<strong>因为 make 存在这样一种机制，如果 “目标” 中的某个 “依赖项” 的修改时间晚于上次 make 该 “目标” 的时间，就说明该 “目标” 过时了，需要重新构建。如果你不把影响该 “目标” 的所有必要的 “依赖” 都写上，那当你修改某个文件后，make 就会因为 “目标” 已存在而不再构建。</strong></p><p>因此， <code>foo.c/foo.h</code>  或  <code>bar.c/bar.h</code>  的修改会导致  <code>foo.o</code>  或  <code>bar.o</code>  过时而重新构建，从而使得 main 也必须重新构建。</p><h1 id="makefile-的伪目标phony"><a class="anchor" href="#makefile-的伪目标phony">#</a> Makefile 的伪目标（.PHONY）</h1><p>(1) 伪目标意思是这个目标本身不代表一个文件，执行这个目标不是为了得到某个文件或东西，而是单纯为了执行这个目标下面的命令。</p><p>(2) 伪目标一般都没有依赖，因为执行伪目标就是为了执行目标下面的命令。既然一定要执行命令了那就不必加依赖，因为不加依赖意思就是无条件执行。</p><p>(3) 伪目标可以直接写，不影响使用；但是有时候为了明确声明这个目标是伪目标会在伪目标的前面用  <code>.PHONY</code>  来明确声明它是伪目标。</p><p>典型的伪目标是 Makefile 中用来清理编译过程中中间文件的 clean 伪目标，一般格式如下:</p><figure class="highlight makefile"><figcaption data-lang="makefile"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token builtin-target builtin">.PHONY</span><span class="token punctuation">:</span> clean   <span class="token comment"># 这句没有也行，但是最好加上</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token target symbol">clean</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    -rm -f *.o</pre></td></tr></table></figure><p>下面列举一些常用的伪目标，如果在自己项目的 Makefile 合理使用这些伪目标的话，可以让我们自己的 Makefile 看起来更专业</p><table><thead><tr><th>伪目标</th><th>含义</th></tr></thead><tbody><tr><td>all</td><td>所有目标的目标，其功能一般是编译所有的目标</td></tr><tr><td>clean</td><td>删除所有被 make 创建的文件</td></tr><tr><td>install</td><td>安装已编译好的程序，其实就是把目标可执行文件拷贝到指定的目录中去</td></tr><tr><td>print</td><td>列出改变过的源文件</td></tr><tr><td>tar</td><td>把源程序打包备份，也就是一个 tar 文件</td></tr><tr><td>dist</td><td>创建一个压缩文件，一般是把 tar 文件压成 z 文件，或是 gz 文件</td></tr><tr><td>TAGS</td><td>更新所有的目标，以备完整地重编译使用</td></tr><tr><td>check 或 test</td><td>一般用来测试 Makefile 的流程</td></tr></tbody></table><h1 id="条件语句"><a class="anchor" href="#条件语句">#</a> 条件语句</h1><figure class="highlight text"><figcaption data-lang="text"></figcaption><table><tr><td data-num="1"></td><td><pre>&lt;conditional-directive></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>&lt;text-if-true></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>else</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>&lt;text-if-false></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>endif</pre></td></tr></table></figure><p>其中  <code>&lt;conditional-directive&gt;</code>  表示条件关键字，这个关键字有四个。条件语句的目的是通过判断来决定 Makefile 中的相应位置应该有什么内容</p><ul><li><strong>第一个条件关键字是  <code>ifeq</code>  。语法是：</strong></li></ul><pre><code>ifeq (&lt;arg1&gt;, &lt;arg2&gt;)ifeq '&lt;arg1&gt;' '&lt;arg2&gt;'ifeq &quot;&lt;arg1&gt;&quot; &quot;&lt;arg2&gt;&quot;ifeq &quot;&lt;arg1&gt;&quot; '&lt;arg2&gt;'ifeq '&lt;arg1&gt;' &quot;&lt;arg2&gt;&quot;</code></pre><p>比较参数  <code>arg1</code>  和  <code>arg2</code>  的值是否相同，相同为真。</p><ul><li><strong>第二个条件关键字是  <code>ifneq</code>  。语法是：</strong></li></ul><pre><code>ifneq (&lt;arg1&gt;, &lt;arg2&gt;)ifneq '&lt;arg1&gt;' '&lt;arg2&gt;'ifneq &quot;&lt;arg1&gt;&quot; &quot;&lt;arg2&gt;&quot;ifneq &quot;&lt;arg1&gt;&quot; '&lt;arg2&gt;'ifneq '&lt;arg1&gt;' &quot;&lt;arg2&gt;&quot;</code></pre><p>其比较参数  <code>arg1</code>  和  <code>arg2</code>  的值是否相同，如果不同，则为真；和  <code>ifeq</code>  类似。</p><ul><li><strong>第三个条件关键字是  <code>ifdef</code>  。语法是：</strong></li></ul><pre><code>ifdef &lt;variable-name&gt;</code></pre><p>如果变量  <code>&lt;variable-name&gt;</code>  的值非空，那到表达式为真。否则，表达式为假。当然， <code>&lt;variable-name&gt;</code>  同样可以是一个函数的返回值。注意，  <code>ifdef</code>  只是测试一个变量 是否有值，其并不会把变量扩展到当前位置。</p><ul><li><strong>第四个条件关键字是  <code>ifndef</code>  。其语法是：</strong></li></ul><pre><code>ifndef &lt;variable-name&gt;</code></pre><p>如果变量  <code>&lt;variable-name&gt;</code>  的值空，那到表达式为真。否则，表达式为假。，和  <code>ifdef</code>  是相反的意思。</p><h1 id="字符串处理函数"><a class="anchor" href="#字符串处理函数">#</a> 字符串处理函数</h1><h2 id="subst"><a class="anchor" href="#subst">#</a> subst</h2><figure class="highlight html"><figcaption data-lang="HTML"></figcaption><table><tr><td data-num="1"></td><td><pre>$(subst <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>from</span><span class="token punctuation">></span></span>,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>to</span><span class="token punctuation">></span></span>,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span><span class="token punctuation">></span></span>)</pre></td></tr></table></figure><ul><li>名称：字符串替换函数</li><li>功能：把字串  <code>&lt;text&gt;</code>  中的  <code>&lt;from&gt;</code>  字符串替换成  <code>&lt;to&gt;</code>  。</li><li>返回：函数返回被替换过后的字符串。</li><li>示例：</li></ul><pre><code>$(subst ee,EE,feet on the street)</code></pre><p>把  <code>feet on the street</code>  中的  <code>ee</code>  替换成  <code>EE</code>  ，返回结果是  <code>fEEt on the strEEt</code>  。</p><h2 id="patsubst"><a class="anchor" href="#patsubst">#</a> patsubst</h2><figure class="highlight html"><figcaption data-lang="HTML"></figcaption><table><tr><td data-num="1"></td><td><pre>$(patsubst <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pattern</span><span class="token punctuation">></span></span>,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>replacement</span><span class="token punctuation">></span></span>,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span><span class="token punctuation">></span></span>)</pre></td></tr></table></figure><ul><li>名称：模式字符串替换函数。</li><li>功能：查找  <code>&lt;text&gt;</code>  中的单词（单词以 “空格”、“Tab” 或 “回车” “换行” 分隔）是否符合模式  <code>&lt;pattern&gt;</code>  ，如果匹配的话，则以  <code>&lt;replacement&gt;</code>  替换。这里，  <code>&lt;pattern&gt;</code>  可以 包括通配符  <code>%</code> ，表示任意长度的字串。如果  <code>&lt;replacement&gt;</code>  中也包含  <code>%</code>  ，那么，  <code>&lt;replacement&gt;</code>  中的这个  <code>%</code>  将是  <code>&lt;pattern&gt;</code>  中的那个  <code>%</code>  所代表的字串。 （可以用  <code>\</code>  来转义，以  <code>\%</code>  来表示真实含义的  <code>%</code>  字符）</li><li>返回：函数返回被替换过后的字符串。</li><li>示例：</li></ul><pre><code>$(patsubst %.c,%.o,x.c.c bar.c)</code></pre><p>把字串  <code>x.c.c bar.c</code>  符合模式  <code>%.c</code>  的单词替换成  <code>%.o</code>  ，返回结果是  <code>x.c.o bar.o</code></p><ul><li>备注：这和我们前面 “变量章节” 说过的相关知识有点相似。如  <code>$(var:&lt;pattern&gt;=&lt;replacement&gt;;)</code>  相当于  <code>$(patsubst &lt;pattern&gt;,&lt;replacement&gt;,$(var))</code>  ，而  <code>$(var: &lt;suffix&gt;=&lt;replacement&gt;)</code>  则相当于  <code>$(patsubst %&lt;suffix&gt;,%&lt;replacement&gt;,$(var))</code>  。</li></ul><p>例如有:</p><pre><code>objects = foo.o bar.o baz.o，</code></pre><p>那么，  <code>$(objects:.o=.c)</code>  和 ​ <code>$(patsubst %.o,%.c,$(objects))</code>  是一样的。</p><h2 id="strip"><a class="anchor" href="#strip">#</a> strip</h2><figure class="highlight html"><figcaption data-lang="HTML"></figcaption><table><tr><td data-num="1"></td><td><pre>$(strip <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>string</span><span class="token punctuation">></span></span>)</pre></td></tr></table></figure><ul><li>名称：去空格函数。</li><li>功能：去掉  <code>&lt;string&gt;</code>  字串中开头和结尾的空字符。</li><li>返回：返回被去掉空格的字符串值。</li><li>示例：</li></ul><pre><code>$(strip a b c )</code></pre><p>把字串  <code>a b c&lt;空格&gt; </code>  去掉开头和结尾的空格，结果是  <code>a b c</code>  。</p><h2 id="findstring"><a class="anchor" href="#findstring">#</a> findstring</h2><figure class="highlight html"><figcaption data-lang="HTML"></figcaption><table><tr><td data-num="1"></td><td><pre>$(findstring <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>find</span><span class="token punctuation">></span></span>,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>in</span><span class="token punctuation">></span></span>)</pre></td></tr></table></figure><ul><li>名称：查找字符串函数</li><li>功能：在字串  <code>&lt;in&gt;</code>  中查找  <code>&lt;find&gt;</code>  字串。</li><li>返回：如果找到，那么返回  <code>&lt;find&gt;</code>  ，否则返回空字符串。</li><li>示例：</li></ul><pre><code>$(findstring a,a b c)$(findstring a,b c)</code></pre><p>第一个函数返回  <code>a</code>  字符串，第二个返回空字符串</p><h2 id="filter"><a class="anchor" href="#filter">#</a> filter</h2><figure class="highlight html"><figcaption data-lang="HTML"></figcaption><table><tr><td data-num="1"></td><td><pre>$(filter <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pattern...</span><span class="token punctuation">></span></span>,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span><span class="token punctuation">></span></span>)</pre></td></tr></table></figure><ul><li>名称：过滤函数</li><li>功能：以  <code>&lt;pattern&gt;</code>  模式过滤  <code>&lt;text&gt;</code>  字符串中的单词，保留符合模式  <code>&lt;pattern&gt;</code>  的单词。可以有多个模式。</li><li>返回：返回符合模式  <code>&lt;pattern&gt;</code>  的字串。</li><li>示例：</li></ul><pre><code>sources := foo.c bar.c baz.s ugh.hfoo: $(sources)    cc $(filter %.c %.s,$(sources)) -o foo</code></pre><p><code>$(filter %.c %.s,$(sources))</code>  返回的值是  <code>foo.c</code>   <code>bar.c</code>   <code>baz.s</code>  。</p><h2 id="filter-out"><a class="anchor" href="#filter-out">#</a> filter-out</h2><figure class="highlight html"><figcaption data-lang="HTML"></figcaption><table><tr><td data-num="1"></td><td><pre>$(filter-out <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pattern...</span><span class="token punctuation">></span></span>,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span><span class="token punctuation">></span></span>)</pre></td></tr></table></figure><ul><li>名称：反过滤函数</li><li>功能：以  <code>&lt;pattern&gt;</code>  模式过滤  <code>&lt;text&gt;</code>  字符串中的单词，去除符合模式  <code>&lt;pattern&gt;</code>  的单词。可以有多个模式。</li><li>返回：返回不符合模式  <code>&lt;pattern&gt;</code>  的字串。</li><li>示例：</li></ul><pre><code>objects=main1.o foo.o main2.o bar.omains=main1.o main2.o</code></pre><p><code>$(filter-out $(mains),$(objects))</code>  返回值是  <code>foo.o</code>   <code>bar.o</code>  。</p><h2 id="sort"><a class="anchor" href="#sort">#</a> sort</h2><figure class="highlight html"><figcaption data-lang="HTML"></figcaption><table><tr><td data-num="1"></td><td><pre>$(sort <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>list</span><span class="token punctuation">></span></span>)</pre></td></tr></table></figure><ul><li>名称：排序函数</li><li>功能：给字符串  <code>&lt;list&gt;</code>  中的单词排序（升序）。</li><li>返回：返回排序后的字符串。</li><li>示例：  <code>$(sort foo bar lose)</code>  返回  <code>bar foo lose</code>  。</li><li>备注：  <code>sort</code>  函数会去掉  <code>&lt;list&gt;</code>  中相同的单词。</li></ul><h2 id="word"><a class="anchor" href="#word">#</a> word</h2><figure class="highlight html"><figcaption data-lang="HTML"></figcaption><table><tr><td data-num="1"></td><td><pre>$(word <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>n</span><span class="token punctuation">></span></span>,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span><span class="token punctuation">></span></span>)</pre></td></tr></table></figure><ul><li>名称：取单词函数</li><li>功能：取字符串  <code>&lt;text&gt;</code>  中第  <code>&lt;n&gt;</code>  个单词。（从一开始）</li><li>返回：返回字符串  <code>&lt;text&gt;</code>  中第  <code>&lt;n&gt;</code>  个单词。如果  <code>&lt;n&gt;</code>  比  <code>&lt;text&gt;</code>  中的 单词数要大，那么返回空字符串。</li><li>示例：  <code>$(word 2,foo bar baz)</code>  返回值是  <code>bar</code>  。</li></ul><h2 id="wordlist"><a class="anchor" href="#wordlist">#</a> wordlist</h2><figure class="highlight html"><figcaption data-lang="HTML"></figcaption><table><tr><td data-num="1"></td><td><pre>$(wordlist <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ss</span><span class="token punctuation">></span></span>,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>e</span><span class="token punctuation">></span></span>,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span><span class="token punctuation">></span></span>)</pre></td></tr></table></figure><ul><li>名称：取单词串函数</li><li>功能：从字符串  <code>&lt;text&gt;</code>  中取从  <code>&lt;ss&gt;</code>  开始到  <code>&lt;e&gt;</code>  的单词串。  <code>&lt;ss&gt;</code>  和  <code>&lt;e&gt;</code>  是一个数字。</li><li>返回：返回字符串  <code>&lt;text&gt;</code>  中从  <code>&lt;ss&gt;</code>  到  <code>&lt;e&gt;</code>  的单词字串。如果  <code>&lt;ss&gt;</code>  比  <code>&lt;text&gt;</code>  中的单词数要大，那么返回空字符串。如果  <code>&lt;e&gt;</code>  大于  <code>&lt;text&gt;</code>  的单词数， 那么返回从  <code>&lt;ss&gt;</code>  开始，到  <code>&lt;text&gt;</code>  结束的单词串。</li><li>示例：  <code>$(wordlist 2,3,foo bar baz)</code>  返回值是  <code>bar baz</code>  。</li></ul><h2 id="words"><a class="anchor" href="#words">#</a> words</h2><figure class="highlight html"><figcaption data-lang="HTML"></figcaption><table><tr><td data-num="1"></td><td><pre>$(words <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span><span class="token punctuation">></span></span>)</pre></td></tr></table></figure><ul><li>名称：单词个数统计函数</li><li>功能：统计  <code>&lt;text&gt;</code>  中字符串中的单词个数。</li><li>返回：返回  <code>&lt;text&gt;</code>  中的单词数。</li><li>示例：  <code>$(words foo bar baz)</code>  返回值是  <code>3</code>  。</li><li>备注：如果我们要取  <code>&lt;text&gt;</code>  中最后的一个单词，我们可以这样： <code>$(word $(words &lt;text&gt;),&lt;text&gt;)</code>  。</li></ul><h2 id="firstword"><a class="anchor" href="#firstword">#</a> firstword</h2><figure class="highlight html"><figcaption data-lang="HTML"></figcaption><table><tr><td data-num="1"></td><td><pre>$(firstword <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span><span class="token punctuation">></span></span>)</pre></td></tr></table></figure><ul><li>名称：首单词函数 ——firstword。</li><li>功能：取字符串  <code>&lt;text&gt;</code>  中的第一个单词。</li><li>返回：返回字符串  <code>&lt;text&gt;</code>  的第一个单词。</li><li>示例：  <code>$(firstword foo bar)</code>  返回值是  <code>foo</code> 。</li><li>备注：这个函数可以用 word 函数来实现：  <code>$(word 1,&lt;text&gt;)</code>  。</li></ul><p>以上，是所有的字符串操作函数，如果搭配混合使用，可以完成比较复杂的功能。这里，举一个现实中 应用的例子。我们知道，make 使用  <code>VPATH</code>  变量来指定 “依赖文件” 的搜索路径。于是，我们可以 利用这个搜索路径来指定编译器对头文件的搜索路径参数  <code>CFLAGS</code>  ，如：</p><pre><code>override CFLAGS += $(patsubst %,-I%,$(subst :, ,$(VPATH)))</code></pre><p>如果我们的  <code>$(VPATH)</code>  值是  <code>src:../headers</code>  ，那么  <code>$(patsubst %,-I%,$(subst :, ,$(VPATH)))</code>  将返回  <code>-Isrc -I../headers</code>  ， 这正是 cc 或 gcc 搜索头文件路径的参数。</p><h1 id="文件名操作函数"><a class="anchor" href="#文件名操作函数">#</a> 文件名操作函数</h1><p>下面我们要介绍的函数主要是处理文件名的。每个函数的参数字符串都会被当做一个或是一系列的文件名来对待。</p><h2 id="dir"><a class="anchor" href="#dir">#</a> dir</h2><figure class="highlight html"><figcaption data-lang="HTML"></figcaption><table><tr><td data-num="1"></td><td><pre>$(dir <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>names...</span><span class="token punctuation">></span></span>)</pre></td></tr></table></figure><ul><li>名称：取目录函数 —— dir。</li><li>功能：从文件名序列  <code>&lt;names&gt;</code>  中取出目录部分。目录部分是指最后一个反斜杠  <code>/</code>  之前 的部分。如果没有反斜杠，那么返回  <code>./</code>  。</li><li>返回：返回文件名序列  <code>&lt;names&gt;</code>  的目录部分。</li><li>示例：  <code>$(dir src/foo.c hacks)</code>  返回值是  <code>src/ ./</code>  。</li></ul><h2 id="notdir"><a class="anchor" href="#notdir">#</a> notdir</h2><figure class="highlight html"><figcaption data-lang="HTML"></figcaption><table><tr><td data-num="1"></td><td><pre>$(notdir <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>names...</span><span class="token punctuation">></span></span>)</pre></td></tr></table></figure><ul><li>名称：取文件函数 —— notdir。</li><li>功能：从文件名序列  <code>&lt;names&gt;</code>  中取出非目录部分。非目录部分是指最後一个反斜杠  <code>/</code>  之后的部分。</li><li>返回：返回文件名序列  <code>&lt;names&gt;</code>  的非目录部分。</li><li>示例：  <code>$(notdir src/foo.c hacks)</code>  返回值是  <code>foo.c hacks</code>  。</li></ul><h2 id="suffix"><a class="anchor" href="#suffix">#</a> suffix</h2><figure class="highlight html"><figcaption data-lang="HTML"></figcaption><table><tr><td data-num="1"></td><td><pre>$(suffix <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>names...</span><span class="token punctuation">></span></span>)</pre></td></tr></table></figure><ul><li>名称：取後缀函数 —— suffix。</li><li>功能：从文件名序列  <code>&lt;names&gt;</code>  中取出各个文件名的后缀。</li><li>返回：返回文件名序列  <code>&lt;names&gt;</code>  的后缀序列，如果文件没有后缀，则返回空字串。</li><li>示例：  <code>$(suffix src/foo.c src-1.0/bar.c hacks)</code>  返回值是  <code>.c .c</code> 。</li></ul><h2 id="basename"><a class="anchor" href="#basename">#</a> basename</h2><figure class="highlight html"><figcaption data-lang="HTML"></figcaption><table><tr><td data-num="1"></td><td><pre>$(basename <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>names...</span><span class="token punctuation">></span></span>)</pre></td></tr></table></figure><ul><li>名称：取前缀函数 —— basename。</li><li>功能：从文件名序列  <code>&lt;names&gt;</code>  中取出各个文件名的前缀部分。</li><li>返回：返回文件名序列  <code>&lt;names&gt;</code>  的前缀序列，如果文件没有前缀，则返回空字串。</li><li>示例：  <code>$(basename src/foo.c src-1.0/bar.c hacks)</code>  返回值是  <code>src/foo src-1.0/bar hacks</code>  。</li></ul><h2 id="addsuffix"><a class="anchor" href="#addsuffix">#</a> addsuffix</h2><figure class="highlight html"><figcaption data-lang="HTML"></figcaption><table><tr><td data-num="1"></td><td><pre>$(addsuffix <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>suffix</span><span class="token punctuation">></span></span>,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>names...</span><span class="token punctuation">></span></span>)</pre></td></tr></table></figure><ul><li>名称：加后缀函数 —— addsuffix。</li><li>功能：把后缀  <code>&lt;suffix&gt;</code>  加到  <code>&lt;names&gt;</code>  中的每个单词后面。</li><li>返回：返回加过后缀的文件名序列。</li><li>示例：  <code>$(addsuffix .c,foo bar)</code>  返回值是  <code>foo.c bar.c</code>  。</li></ul><h2 id="addprefix"><a class="anchor" href="#addprefix">#</a> addprefix</h2><figure class="highlight html"><figcaption data-lang="HTML"></figcaption><table><tr><td data-num="1"></td><td><pre>$(addprefix <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>prefix</span><span class="token punctuation">></span></span>,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>names...</span><span class="token punctuation">></span></span>)</pre></td></tr></table></figure><ul><li>名称：加前缀函数 —— addprefix。</li><li>功能：把前缀  <code>&lt;prefix&gt;</code>  加到  <code>&lt;names&gt;</code>  中的每个单词后面。</li><li>返回：返回加过前缀的文件名序列。</li><li>示例：  <code>$(addprefix src/,foo bar)</code>  返回值是  <code>src/foo src/bar</code>  。</li></ul><h2 id="join"><a class="anchor" href="#join">#</a> join</h2><figure class="highlight html"><figcaption data-lang="HTML"></figcaption><table><tr><td data-num="1"></td><td><pre>$(join <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>list1</span><span class="token punctuation">></span></span>,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>list2</span><span class="token punctuation">></span></span>)</pre></td></tr></table></figure><ul><li>名称：连接函数 —— join。</li><li>功能：把  <code>&lt;list2&gt;</code>  中的单词对应地加到  <code>&lt;list1&gt;</code>  的单词后面。如果  <code>&lt;list1&gt;</code>  的单词个数要比  <code>&lt;list2&gt;</code>  的多，那么，  <code>&lt;list1&gt;</code>  中的多出来的单词将保持原样。如果  <code>&lt;list2&gt;</code>  的单词个数要比  <code>&lt;list1&gt;</code>  多，那么，  <code>&lt;list2&gt;</code>  多出来的单词将被复制到  <code>&lt;list1&gt;</code>  中。</li><li>返回：返回连接过后的字符串。</li><li>示例：  <code>$(join aaa bbb,111 222 333)</code>  返回值是  <code>aaa111 bbb222 333</code>  。</li></ul><h1 id="foreach-函数"><a class="anchor" href="#foreach-函数">#</a> foreach 函数</h1><p>foreach 函数和别的函数非常的不一样。因为这个函数是用来做循环用的，Makefile 中的 foreach 函数 几乎是仿照于 Unix 标准 Shell（/bin/sh）中的 for 语句，或是 C-Shell（/bin/csh）中的 foreach 语句而构建的。它的语法是：</p><figure class="highlight html"><figcaption data-lang="HTML"></figcaption><table><tr><td data-num="1"></td><td><pre>$(foreach <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>var</span><span class="token punctuation">></span></span>,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>list</span><span class="token punctuation">></span></span>,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span><span class="token punctuation">></span></span>)</pre></td></tr></table></figure><p>这个函数的意思是，把参数  <code>&lt;list&gt;</code>  中的单词逐一取出放到参数  <code>&lt;var&gt;</code>  所指定的变量中， 然后再执行  <code>&lt;text&gt;</code>  所包含的表达式。每一次  <code>&lt;text&gt;</code>  会返回一个字符串，循环过程中，  <code>&lt;text&gt;</code>  的所返回的每个字符串会以空格分隔，最后当整个循环结束时，  <code>&lt;text&gt;</code>  所返回的 每个字符串所组成的整个字符串（以空格分隔）将会是 foreach 函数的返回值。</p><p>所以，  <code>&lt;var&gt;</code>  最好是一个变量名，  <code>&lt;list&gt;</code>  可以是一个表达式，而  <code>&lt;text&gt;</code>  中一般会 使用  <code>&lt;var&gt;</code>  这个参数来依次枚举  <code>&lt;list&gt;</code>  中的单词。举个例子：</p><pre><code>names := a b c dfiles := $(foreach n,$(names),$(n).o)</code></pre><p>上面的例子中，  <code>$(name)</code>  中的单词会被挨个取出，并存到变量 n 中，  <code>$(n).o</code>  每次 根据  <code>$(n)</code>  计算出一个值，这些值以空格分隔，最后作为 foreach 函数的返回，所以，  <code>$(files)</code>  的值是  <code>a.o b.o c.o d.o</code>  。</p><p>注意，foreach 中的  <code>&lt;var&gt;</code>  参数是一个临时的局部变量，foreach 函数执行完后，参数  <code>&lt;var&gt;</code>  的变量将不在作用，其作用域只在 foreach 函数当中。</p><h1 id="if-函数"><a class="anchor" href="#if-函数">#</a> if 函数</h1><p>if 函数很像 GNU 的 make 所支持的条件语句 —— ifeq（参见前面所述的章节），if 函数的语法是：</p><figure class="highlight html"><figcaption data-lang="HTML"></figcaption><table><tr><td data-num="1"></td><td><pre>$(if <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>condition</span><span class="token punctuation">></span></span>,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>then-part</span><span class="token punctuation">></span></span>)</pre></td></tr></table></figure><p>或是</p><figure class="highlight html"><figcaption data-lang="HTML"></figcaption><table><tr><td data-num="1"></td><td><pre>$(if <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>condition</span><span class="token punctuation">></span></span>,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>then-part</span><span class="token punctuation">></span></span>,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>else-part</span><span class="token punctuation">></span></span>)</pre></td></tr></table></figure><p>可见，if 函数可以包含 “else” 部分，或是不含。即 if 函数的参数可以是两个，也可以是三个。 <code>&lt;condition&gt;</code>  参数是 if 的表达式，如果其返回的为非空字符串，那么这个表达式就相当于返回真， 于是，  <code>&lt;then-part&gt;</code>  会被计算，否则  <code>&lt;else-part&gt;</code>  会被计算。</p><p>而 if 函数的返回值是，如果  <code>&lt;condition&gt;</code>  为真（非空字符串），那个  <code>&lt;then-part&gt;</code>  会是整个函数的返回值，如果  <code>&lt;condition&gt;</code>  为假（空字符串），那么  <code>&lt;else-part&gt;</code>  会是 整个函数的返回值，此时如果  <code>&lt;else-part&gt;</code>  没有被定义，那么，整个函数返回空字串。</p><p>所以，  <code>&lt;then-part&gt;</code>  和  <code>&lt;else-part&gt;</code>  只会有一个被计算。</p><h1 id="call函数"><a class="anchor" href="#call函数">#</a> call 函数</h1><p>call 函数是唯一一个可以用来创建新的参数化的函数。你可以写一个非常复杂的表达式，这个表达式中， 你可以定义许多参数，然后你可以 call 函数来向这个表达式传递参数。其语法是：</p><figure class="highlight html"><figcaption data-lang="HTML"></figcaption><table><tr><td data-num="1"></td><td><pre>$(call <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>expression</span><span class="token punctuation">></span></span>,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parm1</span><span class="token punctuation">></span></span>,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parm2</span><span class="token punctuation">></span></span>,...,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parmn</span><span class="token punctuation">></span></span>)</pre></td></tr></table></figure><p>当 make 执行这个函数时，  <code>&lt;expression&gt;</code>  参数中的变量，如 $(1) 、 $(2) 等，会 被参数  <code>&lt;parm1&gt;</code> 、  <code>&lt;parm2&gt;</code>  、  <code>&lt;parm3&gt;</code>  依次取代。而  <code>&lt;expression&gt;</code>  的 返回值就是 call 函数的返回值。例如：</p><pre><code>reverse =  $(1) $(2)foo = $(call reverse,a,b)</code></pre><p>那么，  <code>foo</code>  的值就是  <code>a b</code>  。当然，参数的次序是可以自定义的，不一定是顺序的，如：</p><pre><code>reverse =  $(2) $(1)foo = $(call reverse,a,b)</code></pre><p>此时的  <code>foo</code>  的值就是  <code>b a</code>  。</p><p>需要注意：在向 call 函数传递参数时要尤其注意空格的使用。call 函数在处理参数时，第 2 个及其之后的 参数中的空格会被保留，因而可能造成一些奇怪的效果。因而在向 call 函数提供参数时，最安全的做法是去除所有多余的空格。</p>]]></content>
      
      
      
        <tags>
            
            <tag> history </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ADC采样值转化成电压值详解</title>
      <link href="/docs/Essay/ADC%E9%87%87%E6%A0%B7%E5%80%BC%E8%BD%AC%E5%8C%96%E6%88%90%E7%94%B5%E5%8E%8B%E5%80%BC%E8%AF%A6%E8%A7%A3/"/>
      <url>/docs/Essay/ADC%E9%87%87%E6%A0%B7%E5%80%BC%E8%BD%AC%E5%8C%96%E6%88%90%E7%94%B5%E5%8E%8B%E5%80%BC%E8%AF%A6%E8%A7%A3/</url>
      
        <content type="html"><![CDATA[<blockquote><p>如何利用单片机的 ADC 模块（或者独立的 ADC 芯片）得到接入 ADC 管脚上的实际电压值？ 这个问题，是第一次接触 ADC 时候，大家都会遇到的问题。</p></blockquote><p>单片机会读到什么值？ 需要看一个特性，就是几位的 ADC，在手册上就会给出，例如，STM32 的 ADC 是 12 位的。另外，还有 8 位，10 位，16 位，24 位等。</p><p>我先告诉你答案：STM32 读到的 ADC 值，是从 0 到 4095，当你把 ADC 引脚接了 GND，读到的就是 0，当你把 ADC 引脚接了 VDD，读到的就是 4095。</p><p>接下来告诉你为什么：前面提到，STM32 的 ADC 是 12 位的，我们知道，8 位的值是从 0 ~ 255；16 位的值，是从 0 ~ 65535。这两个位的最大值，是我们最为熟悉的。</p><p>（怎么算出来的？这问题就又降低到另一个层面了，这里我们说的几位的值，每个位只能是 0 或者 1，比如 2 位的值，可以表示为 00 01 10 11 四种不同的值，这是以 2 进制表示的，转换成十进制就是 0 1 2 3，所以得出结论，2 位的值可以表示从 0 ~ 3。同理，3 位的值，可以表示十进制的 0 ~ 7，你可以展开计算一下。4 位的值，可以表示 0 ~ 15，5 位的值，可以表示从 0 ~ 31，同理，你可以得出任意位的值可以表示的范围。）</p><p>所以，12 位的值，可以表示从 0 ~ 4095（2^12），这就是先在感性上，认识了为什么 12 位的 ADC 的值，是从 0 ~ 4095。</p><p><strong>读到的值怎么换算成实际的电压值？</strong><br /><mark>前面提到了，我们输入 GND，读到的值是 0，输入 VDD，得到的值是 4095，那么，当你读到 2035 的时候，你知道输入电压多少 V 吗？这个问题，归根接地，就到了数学 XY 坐标，已知两点坐标值（0, 0）（3.3, 4095），给出任意 X 坐标值，求 Y 值的问题了吧？简单不简单？</mark></p><p>ADC 测电压示意图：</p><p><img data-src="20190705235230125.png" alt="在这里插入图片描述" /></p><p>参考电压是什么？</p><p>讨论这个问题之前，你先拿万用表量一下你的 VDDA 的实际电压是多大？是不是标准的 3.300V？应该不是吧？或许是 2.296V，或许是 3.312V。然后你把 VDD 连接到 ADC 引脚之后，得到的是 4095，也就是，实际上，当你读出 4095 这个数据的时候，实际的电压值不是你想象中的 3.300V。有些初学者，觉得几毫伏的电压差无所谓，但实际应用中，几毫伏就可能代表很大的实际工况，例如，在一个量程为 50 克的电子称上。</p><p>所以，这时候，芯片厂商就想了一个办法，给 ADC 模块中引入参考电压，由非常标准的参考电压芯片来接入参考电压引脚。标准的电压芯片，我们一般叫做参考电压芯片，或者叫做基准电压芯片。例如 REF3133（输出 3.300V） REF3025（输出 2.500V）等等。</p><p>注意：STM32 的 100 脚以上（含 100 脚）有参考电压引脚。在没有参考电压引脚的单片机上，可以把基准电压芯片接入 VDDA，但是 VDDA 和 VDD 的电压差不能超过 0.3V，例如，VDD 是 3.3V 的话，可以给 VDDA 接入一个 3.3V 的参考电压芯片或者 3.0V 的参考电压芯片，但是不能接入 2.5V 的参考电压芯片，后果就是芯片不能工作。</p><p>ADC 引脚的输入电压范围是多大<br />一般情况下，ADC 引脚的输入电压，是从 0 ~ VDD，如果有 REF 引脚，一般是 0 ~ Vref，也有 0 ~ 2Vref 的情况。</p><p>如果被测的电压大于 ADC 的输入电压，例如，要用 STM32 测量 0 ~ 5V 的电压的话，可以在输入 ADC 引脚之前，加入电阻分压和放大器电路。</p><p><mark>注意：如果用内部基准电压作为参考基准，公式就跟用外部芯片供电电压测量有点不同</mark></p><pre><code>#define REF_VOLTAGE     1224UL        // 基准电压千倍#define VOLTAGE         3300UL        // 电压千倍#define ADC_DIP(X)      (X)           // ADC分辨率</code></pre><ul><li><p>一般我们用外部芯片供电电压为参考基准就用下面那个公式，也就是上面说的 XY 比例</p><p>Voltage_value = (uint32_t)(ADC_value*VOLTAGE &gt;&gt; ADC_DIP (12));     // 换算成千倍的电压值</p></li><li><p>若用内部基准电压作为参考则用以下公式</p><p>Voltage_value = (uint32_t)((REF_VOLTAGE &lt;&lt; ADC_DIP (12)) / ADC_value);      // 换算成千倍的电压值</p></li></ul><p><em><strong>内置的参照电压看芯片的 datasheet；外部芯片供电电压最好用万用表测一下</strong></em></p>]]></content>
      
      
      
        <tags>
            
            <tag> history </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Altium Designer常用总结</title>
      <link href="/docs/EDA/Altium%20Designer%E5%B8%B8%E7%94%A8%E6%80%BB%E7%BB%93/"/>
      <url>/docs/EDA/Altium%20Designer%E5%B8%B8%E7%94%A8%E6%80%BB%E7%BB%93/</url>
      
        <content type="html"><![CDATA[<blockquote><p>首先说明一下，== 单个按键直接用字母表示；组合键（是指先按住第一个键不放，然后按下第二个键，再放开这两个键。）则用 “+” 表示；多次按键（是指先按下第一个键并放开，然后按下第二个键并放开，以此类推。）则用 “ - ” 表示。</p></blockquote><p>（以下快捷键只列出一些个人常用的，至于 Ctrl + C/ V 这些熟悉的快捷键以及不怎么用的就不一一罗列出来了，需要的可以到下面链接自个查询）</p><ul><li>这个是在百度文库里面列出来的 <span class="exturl" data-url="aHR0cHM6Ly93ZW5rdS5iYWlkdS5jb20vdmlldy8wOWI5NGYxNjc3MGJmNzhhNjQyOTU0OGYuaHRtbD9mcm9tPXNlYXJjaA==">最全 Altium Designer 快捷键</span></li><li>当然你也可以直接在 AD 软件里面查看，教程：<span class="exturl" data-url="aHR0cHM6Ly9qaW5neWFuLmJhaWR1LmNvbS9hcnRpY2xlLzM1OTkxMWY1N2Q3NzEwNTdmZTAzMDY4My5odG1s">Altium Designer 查看所有快捷键，图文教程</span></li></ul><h1 id="原理图快捷键"><a class="anchor" href="#原理图快捷键">#</a> 原理图快捷键</h1><p>1：按住 Shift 拖动某个元件，可快速复制</p><p>2：按住鼠标滚轮，鼠标上下滑动即为放大缩小（PCB 一样效果）</p><p>3：按住 Ctrl 按住鼠标右键 鼠标上下滑动也放大缩小</p><p>4：按住 Ctrl 拖动某个元件 可以移动位置 并且保持原来的线连接</p><p>5：关于原理图分层画时候  <code>NET PART</code>  属性。在 工程 - 工程参数 - options 设置</p><p>6：Ctrl + F ---- 可以查找相应的文本网络或原件</p><p>7：T - C ---- 交叉探针 在需要寻找 原理图 对应 PCB 的元件位置选下，然后跑到 PCB 就能看到 原理图 那个元件的位置。</p><p>8：Shift + F ---- 查找相识的对象（PCB 一样效果）</p><p>9：Tab 键 ---- 鼠标带着元件移动的时候可以修改属性</p><p>10：Shift + C ---- 清除当前过滤器。（当显示一片灰暗时，可恢复正常显示）（PCB 一样效果）</p><p>11：Alt + 鼠标单击网络 ---- NET 网络呈现高亮状态</p><h1 id="pcb快捷键"><a class="anchor" href="#pcb快捷键">#</a> PCB 快捷键</h1><p>1：Shift + S 键 ---- 切换单层显示</p><p>2：Q ---- 英寸和毫米尺寸切换。若打开了窗口则按 Ctrl + Q 临时切换一次单位制度</p><p>3： D - R ---- 进入布线规则设置。其中 Clearance 是设置最小安全线间距，覆铜时候间距的。比较常用</p><p>4：Ctrl + 鼠标单击某个线 ---- 整个线的 NET 网络 呈现高亮状态</p><p>5：小键盘上的 * （星号键）可以在 Top、Bottom layer 切换，达到快速切换上下层。若在布线过程中，会自动按照你设的规则自动放置过孔并翻转到另一层布线。另外 + - 可以把所有显示的层轮流切换</p><p>6: Delete ---- 删任何东西</p><p>7: Backspace 键 ---- 在交互布线（手动布线）或者敷铜的过程中，放弃上一步操作</p><p>8: M - G ---- 任意调整铜皮</p><p>9：Ctrl + Shift + 鼠标滚轮 ---- 切换不同布线层</p><p>10：E - O - S ---- 设置原点</p><p>11：Ctrl + G/ G - G ---- 设置跳转栅格尺寸</p><p>12：I - L ---- 在区域内排列元器件，先原理图选中一个或多个元器件</p><p>13：J - C ---- 鼠标定位到指定的元件处。在弹出的对话框内输入该元件的编号</p><p>14：N ---- 飞线显示及隐藏（具体自己选择相应的操作）</p><p>15：U ---- 取消布线（具体自己选择相应的操作）</p><p>16：Tab 键 在交互布线或放置元件、过孔等对象的过程中修改对象属性。</p><p>17：Ctrl + M 测量任意两点间的距离</p><p>18：Ctrl + Shift + T、B、L、R 可以快速对齐所选中的元件 上 / 下 / 左 / 右</p><p>19：器件联合 ---- 选中两个器件，然后右击 选择 “联合 - 从选中的器件生成联合” 这样可以操作两个位置在一起的器件<br />当要去掉时候 选中器件 右击 选择 “联合 - 从联合打散器件” 那么连接在一起的就能够单独操作了<br />当选中联合的器件，右击选择联合，有个 “选择所有的联合” 这样一下子选择所有联合的器件。固定的外框就可以联合起来移动操作</p><p>20：M - I ---- 可以把选中所有的元件，翻转过来（其实就是顶层跟底层的切换）；这样可以在上下层切换，方便布线，调整印丝层。 很实用的一个操作。</p><p>21：E - A ---- 特殊粘贴 拼版或复制粘贴元件的时候可以保持网络也一起粘贴（具体自己选择相应的操作）</p><p>22：T - C ---- 交叉探针 在需要寻找 PCB 对应 原理图 的元件位置 选下，然后跑到原理图 就能看到 PCB 那个元件的位置。</p><p>23：T - E ---- 滴泪 <em>ps：别记成<s>泪滴</s> 了</em></p><p>24：L  ---- 视图配置</p><p>25：选中所画的机械层 Mechanical1 边界，选择【Design】|【Board shape】|【Define from selected objects】命令再回车，其快捷键为 D - S - D - Enter，就会按照你设定好的边界定义出 PCB 的形状。</p><p>26：如何把零件放到另一面去？ ----- 鼠标左键点选元件，不要松开，按 L 键，元件就放到另一面了。（也可以用 M - I 键）</p><p>27：T - V - ?（?：以下其中一个） ---- 转换组合键，具体想转换什么看下面解释</p><ul><li>“-G” 转换出来的区域是多边形敷铜的第三种模式，如需更改，双击选自己需要的敷铜方式就行了；</li><li>“- R” 转换出来的是一个实心的区域图形，相当于实心作画；</li><li>“- T” 转换出来的是多边形剪切块，说白了就是拿来挖铜的；</li><li>“- B” 转换出来的是板剪切块，具体干嘛用的还不知道，只知道它相当于一个白色的底层背景，不会覆盖任何一个板层<br /><mark>（注意：转化前必须先对线性封闭图形选中再按快捷键，转换出来的区域是由外围线段决定的，不是封闭图形的话，只会转换选中的线条；转化后得到的区域图形所在的层是你当前的层）</mark></li></ul><p>28：O - B ---- PCB 板参数设置</p><p>29：D - R ---- 规则设置</p><p>30：T - P ---- 优先选项设置</p><p>31:  蛇形走线 ---- 先 P-&gt;T 布线，再 Shift + A 切换成蛇形走线（按数字 1 和 2 调整蛇形线拐角形状，按数字 3 和 4 调整占空比，按左右尖括号 &lt;和&gt; 键调整蛇形线幅度）</p><p>32：P - G ---- 敷铜</p><p><strong>未完待续。。。。。。</strong></p><h1 id="ad设计中三种大面积覆铜的区别"><a class="anchor" href="#ad设计中三种大面积覆铜的区别">#</a> AD 设计中，三种大面积覆铜的区别</h1><p>在 AD 设计中，主要有三种大面积覆铜方式，分别是 <mark>Fill</mark> (铜皮) <mark>Polygon Pour</mark> (灌铜) 和<mark> Plane</mark> (平面层)，这三种方式刚开始的时候没有细细区分，现在分别应用了一下， 总结如下，欢迎指正</p><p><strong>Fill</strong>：表示绘制一块实心的铜皮，有点无差别攻击的味道，就是覆盖区域之内，所有的连线和过孔全都连接在一起，而不考虑是否属于同一个 net。</p><p>应用 —— 如果应用不好，就会造成信号干扰，接地或者短路的严重后果，一般用在散热，比如电源芯片的 GND，可以大面积铺设。快捷键为 Place/Fill (键盘依次 P/F)</p><p><strong>Polygon Pour</strong>：作用类似于 Fill，绘制大面积铜皮，但是区别之处在于，“Pour”, 也就是会主动区分覆盖区域的连线和过孔，网络点，焊盘，如果属于同一个网络，就会按照设定的规则（比如网格形式，实心形式覆铜）。</p><p>应用 —— 一般在画好主要信号线或者控制线之后使用，比如大面积铺地，至于大面积铺地使用的是实心式还是网格式，在下一篇文章中详细介绍。快捷方式为 Place/Polygon Pour (P/G)</p><p><strong>Polygon Pour Cutout</strong> : 在灌铜区建立挖铜区。</p><p>应用 —— 在某些重要元件底部进行挖空处理，像常见的 RF 信号，通常需要做挖空处理，还有变压器下面的，RJ45 等</p><p><strong>Slice Polygon Pour</strong> : 切割灌铜区域，比如需要进行优化缩减，划分成不同的小区域，以便进行删减，快捷方式 P/Y</p><p>tip: 如果想要改变已经设计的好普通形状，比如改成锐角，凹进去形状之类，可以使用快捷键 M/G (Move/polygon vertices)</p><p><strong>Plane</strong> : 平面层，一般用于电源网络，对于两层板，一般用不到，对于四层板，可以当转电源或者地网络使用</p><h1 id="pcb各层含义"><a class="anchor" href="#pcb各层含义">#</a> PCB 各层含义</h1><p>1、Signal layer（信号层）：用于布置电路板上的导线。</p><p>2、Mechanical layer（机械层）：一般用于设置电路板的外形尺寸，数据标记，对齐标记，装配说明以及其它的机械信息。</p><p>3、Solder mask layer（阻焊层）：在焊盘以外的各部位涂覆一层涂料，如防焊漆，用于阻止这些部位上锡；需要走线上开窗只需要在 Solder 是阻焊层的 画出相应图形即可。</p><p>4、Paste mask layer（锡膏防护层，SMD 贴片层）：它和阻焊层的作用相似，不同的是在机器焊接时对应的表面粘贴式元件的焊盘，是用来开钢网漏锡用的。</p><p>5、Keep out layer（禁止布线层）：用于定义在电路板上能够有效放置元件和布线的区域。在该层绘制一个封闭区域作为布线有效区，在该区域外是不能自动布局和布线的。</p><p>6、Silkscreen layer（丝印层）：主要用于放置印制信息，如元件的轮廓和标注，各种注释字符等。</p><p>7、Multi layer（多层）：电路板上焊盘和穿透式过孔要穿透整个电路板，与不同的导电图形层建立电气连接关系，因此系统专门设置了一个抽象的层 ---- 多层。</p><h1 id="个人pcb画板流程"><a class="anchor" href="#个人pcb画板流程">#</a> <s><strong>个人 PCB 画板流程</strong>：</s></h1><p>---&gt; 不定时保存（这个贼重要）</p><p>---&gt; 机械边界（机械层）尺寸规格、板厚标记，一般用 机械层_1</p><p>---&gt; 电气边界（静止布线层）注意螺丝孔等需要往外扩展的边界</p><p>---&gt; 元件布局：核心元件布局在板中央，插件布置在 PCB 边缘，发热元件一般应均匀分布，以利于单板和整机的散热，除温度检测元件以外的温度敏感器件应远离发热量大的元器件</p><p>---&gt; 规则设置：线距、过孔、敷铜（查看：Altium PCB 基本规则的详解）</p><p>---&gt; 布线（查看：华为 PCB 布线规范、datasheet 等）</p><p>---&gt; 添加滴泪（1、避免电路板受到巨大外力的冲撞时，导线与焊盘或者导线与导孔的接触点断开，也可使 PCB 电路板显得更加美观。2、焊接上，可以保护焊盘，避免多次焊接是焊盘的脱落。3、生产时可以避免蚀刻不均，过孔偏位出现的裂缝等。4、信号传输时平滑阻抗，减少阻抗的急剧跳变，避免高频信号传输时由于线宽突然变小而造成反射，可使走线与元件焊盘之间的连接趋于平稳过渡化）</p><p>---&gt; 敷铜</p><p>---&gt; 3d 查看（主要用于查看丝印的遮挡以及各元件之间的间隙，另外对于一些有高度限制的，可以用来作参考）</p><p>---&gt; DRC 检测</p><p>---&gt; 复查</p><p>---&gt; 如果需要拼板，外围两边要分别留出 5mm 宽度传送板边</p>]]></content>
      
      
      
        <tags>
            
            <tag> EDA </tag>
            
            <tag> history </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>关于Keil、IAR编译后数据内存的分析</title>
      <link href="/docs/IDE/%E5%85%B3%E4%BA%8EKeil%E3%80%81IAR%E7%BC%96%E8%AF%91%E5%90%8E%E6%95%B0%E6%8D%AE%E5%86%85%E5%AD%98%E7%9A%84%E5%88%86%E6%9E%90/"/>
      <url>/docs/IDE/%E5%85%B3%E4%BA%8EKeil%E3%80%81IAR%E7%BC%96%E8%AF%91%E5%90%8E%E6%95%B0%E6%8D%AE%E5%86%85%E5%AD%98%E7%9A%84%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1 id="keil-c51编译器"><a class="anchor" href="#keil-c51编译器">#</a> Keil C51 编译器</h1><p>1、首先，在 Options ----&gt; Target ----&gt; Memory Model 里可以设置变量分配的空间，如图示：<br /><img data-src="20190319214430417.png" alt="在这里插入图片描述" /></p><ul><li>Small：变量默认分配到内部存储空间中，通过普通的 MOV 指令寻址，只用低于 2K 的程序空间。</li><li>Compact：变量默认分配到外部页存储空间中，单个函数的代码量不能超过 2K，整个程序可以使用 64K 的程序空间，通过 MOVX, @Ri 之类指令寻址，在不切换页的前提下，最大支持 256 字节外部扩展 RAM。</li><li>Large：变量默认分配到外部存储空间中，通过 MOVX, @DPTR 之类指令寻址，最大支持 64kB 外部扩展 RAM（实际上配合硬件设计以及软件调整，还可以支持更大的扩展空间）。</li></ul><p>2、程序中，如果在变量声明时未声明变量的存储器类型，则该变量的存储器类型，由程序的存储模式来决定，也就是说编译器会根据我们在上面 Memory Model 里所选的模式默认储存在那个区域。</p><ul class="task-list"><li class="task-list-item"><input type="checkbox" id="cbx_0" disabled="true" /><label for="cbx_0"> 小模式（Small model）：默认 data 区</label></li><li class="task-list-item"><input type="checkbox" id="cbx_1" disabled="true" /><label for="cbx_1"> 紧凑模式（Compact model）：默认 pdata 区</label></li><li class="task-list-item"><input type="checkbox" id="cbx_2" disabled="true" /><label for="cbx_2">  大模式（Large model）：默认 xdata 区</label></li></ul><p>3、各分配区域的理解<br /> data：直接寻址的片内 RAM 区低 128B（00H~7FH） , 可以用 acc 直接读写的，速度最快，生成的代码也最小。</p><p>bdata：片内 RAM 的可位寻址区（20H~2FH），允许字节和位混合访问</p><p>idata：单片机间接访问的片内 RAM 区，允许访问全部片内 RAM（前面 0x00-0xff 的 256 个 RAM）, 其中前 128 和 data 的 128 完全相同，只是因为访问的方式不同。idata 是用类似 C 中的指针方式访问的。汇编中的语句为：mox ACC,@Rx.(不重要的补充：C 中 idata 做指针式的访问效果很好)</p><p>pdata：Ri 间接访问的片外 RAM 的低 256B（00H~FFH）</p><p>xdata：外部扩展 RAM，用 DPTR 间接访问片外 RAM，允许访问全部 64KB 片外 RAM（0000H~FFFFH）</p><p>code：单片机的 64KB 程序存储区 ROM，即代码域，它指的是编译器生成的机器指令，这些内容被存储到 ROM 区，写入后就不能再更改，一般当你定义数组不用更改时可以加上这个关键词，对应的 data 是存入 RAM 的意思</p><p>4、如下图所示，编译出来的 “Program Size: data=10.3 xdata=588 code=8732” ，对应的数值就是该区域所占用的空间大小<img data-src="20190319220144298.png" alt="在这里插入图片描述" /><br /> 5、根据上面的信息，可以得知以下的 Flash 和 RAM 占用的空间大小，至于不知道为什么在 data 数据区域内有小数点，估计是因为 51 内核的单片机是 8bit 的，并且支持 bit 数据类型，像我们平时一般定义标志位 flag 都是创建 bit 位的，而在这里显示数据，都是以 Byte 为单位的；估计是因为这样的原因吧；如果有哪个大佬知道，可以说明一下。</p><ul><li>Flash = Code + data + xdata</li><li>RAM = data + xdata</li></ul><h1 id="keil-mdk-arm编译器"><a class="anchor" href="#keil-mdk-arm编译器">#</a> Keil MDK-Arm 编译器</h1><p>1、同样是 Keil 编译器，MDK 相对于 C51，在 Options ----&gt; Target 里并没有 Memory Model 的设置，用的比较多的是下面的这个配置<br /><img data-src="20190319220847231.png" alt="在这里插入图片描述" /><br />这个是程序存储在片内、片外的地址设置（一般下载程序都是下载到片内 FLASH），我们也不用怎么去更改它；只有在项目做大了，或有特殊要求时，片内不够使用了才将程序存储在片外</p><p>2、数据类型的理解<br /> Code：即代码域，它指的是编译器生成的机器指令，这些内容被存储到 ROM 区。</p><p>RO-data：Read Only data，即只读数据域，它指程序中用到的只读数据，这些数据被存储在 ROM 区，因而程序不能修改其内容。例如 C 语言中 const 关键字定义的变量就是典型的 RO-data。</p><p>RW-data：Read Write data，即可读写数据域，它指初始化为 “非 0 值” 的可读写数据，程序刚运行时，这些数据具有非 0 的初始值，且运行的时候它们会常驻在 RAM 区，因而应用程序可以修改其内容。例如 C 语言中使用定义的全局变量，且定义时赋予 “非 0 值” 给该变量进行初始化。</p><p>ZI-data：Zero Initialie data，即 0 初始化数据，它指初始化为 “0 值” 的可读写数据域，它与 RW-data 的区别是程序刚运行时这些数据初始值全都为 0，而后续运行过程与 RW-data 的性质一样，它们也常驻在 RAM 区，因而应用程序可以更改其内容。例如 C 语言中使用定义的全局变量，且定义时赋予 “0 值” 给该变量进行初始化 (若定义该变量时没有赋予初始值，编译器会把它当 ZI-data 来对待，初始化为 0)；</p><p>ZI-data 的栈空间 (Stack) 及堆空间 (Heap)：在 C 语言中，函数内部定义的局部变量属于栈空间，进入函数的时候从向栈空间申请内存给局部变量，退出时释放局部变量，归还内存空间。而使用 malloc 动态分配的变量属于堆空间。在程序中的栈空间和堆空间都是属于 ZI-data 区域的，这些空间都会被初始值化为 0 值。编译器给出的 ZI-data 占用的空间值中包含了堆栈的大小 (经实际测试，若程序中完全没有使用 malloc 动态申请堆空间，编译器会优化，不把堆空间计算在内)。</p><p>3、对比 C51 的，显示的数据类型多了那么几项；那么，根据上面的数据理解，就可以得到：</p><ul><li>Flash = Code + RO-data + RW-data</li><li>RAM = RW-data + ZI-data</li></ul><h1 id="iar-for-stm8ewstm8编译器"><a class="anchor" href="#iar-for-stm8ewstm8编译器">#</a> IAR For STM8 (EWSTM8) 编译器</h1><p>1、IAR 查看编译后内存大小不会像 Keil 那样在编译完直接在 Build 窗口显示出来，需要我们去 Options for node 里面设置一下，具体操作 Options for node ----&gt; Linker ----&gt; List ----&gt; 把 Generate linker map file 打勾；如图：<br /><img data-src="20190319223141520.png" alt="在这里插入图片描述" /><br /> 2、根据上面的操作，设置完后编译，在工作空间窗口 Output 文件下可以找到 .map 的文件，点击打开，在末尾可以看到目标代码占用的空间大小，如图所示：<br /><img data-src="20190319224645748.png" alt="在这里插入图片描述" /></p><ul><li>Flash = readonly  code memory + readonly  data memory</li><li>RAM = readwrite data memory</li></ul><p>括号内的，表示内存的绝对使用量，对应你设的全局变量大小；对应生成的 bin 文件大小 = 5590 + 168</p><h1 id="keil下的-map文件"><a class="anchor" href="#keil下的-map文件">#</a> Keil 下的 .map 文件</h1><p>实际上在 keil 下也是可以找到 .map 编译信息的，在 Options ----&gt; Listings 里：<br /><img data-src="20201010202944218.png" alt="在这里插入图片描述" /><br />如此操作，就可以在 Select Folder for Listings... 设置的文件夹里找到 .map 编译信息文件了。</p><h1 id="优化"><a class="anchor" href="#优化">#</a> 优化</h1><p>一般每个编译器都有优化选项，对应选择不同的优化等级，你会发现同样的代码，编译出来的占用内存大小是不同的，再细心一点同样可以发现存放在 RAM 区域的内存大小是不会怎么变化的，变化较大的是存在 Flash 区域的内存，所以一般的不会定义全局变量（除非真的要用到），并且全局变量处理起来比较麻烦；另外，开了优化后，如果进入调试，可能有些地方会放不了小红点（打断点），因为编译器根据你所选的优化等级，把对应的代码给优化了。</p>]]></content>
      
      
      
        <tags>
            
            <tag> history </tag>
            
            <tag> IDE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(转)Altium PCB 基本规则的详解</title>
      <link href="/docs/EDA/(%E8%BD%AC)Altium%20PCB%20%E5%9F%BA%E6%9C%AC%E8%A7%84%E5%88%99%E7%9A%84%E8%AF%A6%E8%A7%A3/"/>
      <url>/docs/EDA/(%E8%BD%AC)Altium%20PCB%20%E5%9F%BA%E6%9C%AC%E8%A7%84%E5%88%99%E7%9A%84%E8%AF%A6%E8%A7%A3/</url>
      
        <content type="html"><![CDATA[<p><span class="exturl" data-url="aHR0cHM6Ly93ZW5rdS5iYWlkdS5jb20vdmlldy83ZmQ0ZTYwZDc3YzY2MTM3ZWUwNmVmZjlhZWY4OTQxZWE3NmU0Yjc4Lmh0bWw/cmU9dmlldw==">原文出处</span> ☜戳我啊</p><blockquote><p>规则的适应范围越小，则把优先级设得越高。以下只是一些非常基本规则的设置，仅仅是规则设置中的一点皮毛，还需要以后继续学习。</p></blockquote><h1 id="规则列表"><a class="anchor" href="#规则列表">#</a> 规则列表</h1><ul><li>Electrical（电气规则）：安全间距、线网连接等</li><li>Routing（布线）：线宽、过孔形状尺寸、布线拓扑、布线层、封装出 线等</li><li>SMT（表面贴装（贴片））：贴片元件焊盘的一些要求</li><li>Mask（掩膜）：阻焊和焊膏的扩展</li><li>Plane（内电层和铺铜）：内电层和铺铜与焊盘的连接方式</li><li>Testpoint（测试点）</li><li>Manufacturing（加工）：孔、焊盘、丝印和阻焊的尺寸及相关关系</li><li>HighSpeed（高速信号）：串扰、线长、配长、过孔数量等与高速信号相关的</li><li>Placement（放置）：元件放置和元件间距等</li><li>SignalIntegrity（信号完整性）：走线阻抗及高速信号的过冲、摆率等</li></ul><h1 id="内容"><a class="anchor" href="#内容">#</a> 内容</h1><h2 id="electrical-电气设计规则"><a class="anchor" href="#electrical-电气设计规则">#</a> <em><strong>Electrical  （电气设计规则）</strong></em></h2><ol><li>Clearance（安全距离）设置的是 PCB 电路板在布置铜膜导线时，元件焊盘和焊盘之间、焊盘和导线之间、导线和导线之间的最小的距离。</li><li>Short Circuit（短路）选项区域设置短路设置就是否允许电路中有 导线交叉短路。系统默认不允许短路，即取消 Allow Short Circuit 复 选项的选定。</li><li>Un-Routed Net（未布线网络）选项区域设置可以指定网络、检查 网络布线是否成功，如果不成功，将保持用飞线连接。</li><li>Un-Connected Pin（未连接管脚） 选项区域设置对指定的网络检查 是否所有 元件管脚都连线了。</li></ol><h2 id="routing-布线设计规则"><a class="anchor" href="#routing-布线设计规则">#</a> <em><strong>Routing  （布线设计规则）</strong></em></h2><ol><li><p>Width（导线宽度）选项区域设置导线的宽度有三个值可以供设置，分别为 Max width（最大宽度）、Preferred Width（最佳宽度）、 Min width（最小宽度）三个值。系统对导线宽度的默认值为 10mil， 单击每个项直接输入数值进行更改。 这里采用系统默认值 10mil 设置导线宽度。</p></li><li><p>Routing Topology（布线拓扑规则）选项区域设置拓扑规则定义是 采用的布线的拓扑逻辑约束。AD 中常用的布线约束为统计最短逻辑 规则。</p></li></ol><p>从 Topology 下拉菜单中选择拓扑类型选项。</p><p>AD 提供了以下几种布线拓扑规则：<br />①Shortest (最短) 规则设置最短规则， 该选项的定义是在布线时连 接所有节点的连线最短规则。<br />②Horizontal（水平）规则设置水平规则设置它采用连接节点的水 平连线最短规则。<br />③Vertical （垂直） 规则设置垂直规则设置它采和是连接所有节点， 在垂直方向连线最短规则。<br />④Daisy Simple（简单雏菊）规则设置简单雏菊规则设置。它采用的是使用链式连通法则，从一点到另一点连通所有的节点，并使连线 最短。<br />⑤Daisy MidDiven（雏菊中点）规则设置雏菊中点规则设置。该规 则选择一个 Source（源点），以它为中心向左右连通所有的节点， 并 使连线最短。<br />⑥Daisy Balanced（雏菊平衡）规则设置雏菊平衡规则设置。它也 选择一个源点，将所有的中间节点数目平均分成组，所有的组都连接 在源点上，并使连线最短。<br />⑦Star Burst（星形）规则设置星形规则设置。该规则也是采用选 择一个源点，以星形方式去连接别的节点，并使连线最短。</p><ol start="3"><li><p>Routing Priority （布线优先级） 选项区域设置该规则用于设置布线 的优先次序，设置的范围从 0~100，数值越大，优先级越高。</p></li><li><p>Routing Layers（布线图规则）该规则设置布线板导的导线走线方 法。包括顶层和底层布线层，选择允许走线的层。<br />AD 提供了 11 种布线走法。 各种布线方法为： Not Used 该层不进行布线； Horizontal 该层 按水平方向布线；Vertical 该层为垂直方向布线； Any 该层可以任意 方向布线；1.0 Clock 该层为按一点钟方向布线；2.0 Clock 该层为按两 点钟方向布线；4.0 Clock 该层为按四点钟方向布线；5.0 Clock 该层为 按五点钟方向布线； 45Up 该层为向上 45 ° 方向布线、 45Down 该层为向下 45° 方法布线； Fan Out 该层以扇形方式布线。对于系统默认的双面板情况， 一面布线采用 Horizontal 方式另一面采 用 Vertical 方式。</p></li><li><p>Routing Corners（拐角）选项区域设置布线的拐角可以有 45° 拐 角、90° 拐角和圆形拐角三种。</p></li><li><p>Routing Via Style （过孔） 该规则设置用于设置布线中导孔的尺寸。</p></li><li><p>Fatout Contrl（扇出布线）</p></li><li><p>Differential Pairs Routing（利用差分对布线）</p></li></ol><h2 id="smt-表面粘着类规则设计"><a class="anchor" href="#smt-表面粘着类规则设计">#</a> <em><strong>SMT （表面粘着类规则设计）</strong></em></h2><ol><li>SMD To Corner SMD：SMD 焊盘与导线拐角处最小间距规则。</li><li>SMD To Plane：SMD 焊盘与电源层过孔最小间距规则。</li><li>SMD Neck-Down ：SMD 焊盘颈缩率规则。制定焊点宽度与连接 线宽度之比。</li></ol><h2 id="mask-屏蔽类设计规则"><a class="anchor" href="#mask-屏蔽类设计规则">#</a> <em><strong>Mask （屏蔽类设计规则）</strong></em></h2><ol><li>Solder Mask Expansion：阻焊层收缩量规则。</li><li>Paste Mask Expansion：助焊层收缩量规则。</li></ol><h2 id="plane电源层规则"><a class="anchor" href="#plane电源层规则">#</a> <em><strong>Plane（电源层规则）</strong></em></h2><ol><li>Power Plane Connect Style：电源层连接类型规则。</li><li>Power Plane Clearance：电源层安全间距规则。</li><li>Polygon Connect Style：焊盘与覆铜连接类型规则。</li></ol><h2 id="test-point测试点规则"><a class="anchor" href="#test-point测试点规则">#</a> <em><strong>Test Point（测试点规则）</strong></em></h2><ol><li>Test Point Style：测试点样式规则。</li><li>Test Point Usage：测试点使用规则。</li><li>Assembly Test Point Style：装配测试点样式规则。</li></ol><h2 id="manufacturingpcb-制板规则"><a class="anchor" href="#manufacturingpcb-制板规则">#</a> <em><strong>Manufacturing（PCB 制板规则）</strong></em></h2><ol><li>Minimum Annular Ring ：焊盘铜环最小宽度规则，防止焊盘脱落。</li><li>Acute Angle：（导线夹角）锐角限制规则，不小于 90°。</li><li>Hole Size：孔径限制规则</li><li>Layer Pairs：配对层设置规则，设定所有钻孔电气符号（焊盘和过 孔）的起始层和终止层，使用导盲孔的设计。</li><li>Hole To Hole Clearance：孔间间距桂鄂</li><li>Minimum Solder Mask Sliver：</li><li>Silkscreen Over Component Pads：丝印与元器件焊盘间距规则</li><li>Silk To Silk Clearance：丝印间距规则</li><li>Net Antennae：网络天线规则</li></ol><h2 id="high-speed高频电路规则"><a class="anchor" href="#high-speed高频电路规则">#</a> <em><strong>High Speed（高频电路规则）</strong></em></h2><ol><li>ParallelSegment：平行铜膜线段间距限制规则</li><li>Length：网络长度限制规则</li><li>Matched Net Lengths：网络长度匹配规则</li><li>Daisy Chain Stub Length：菊花状布线分支长度限制规则</li><li>Vias Under SMD：SMD 焊盘下过孔限制规则</li><li>Maximum Via Count：最大过孔数目限制规则</li></ol><h2 id="placement元件布置规则"><a class="anchor" href="#placement元件布置规则">#</a> <em><strong>Placement（元件布置规则）</strong></em></h2><ol><li>Room Definition：元件集合定义规则</li><li>Component Clearance：元件间距限制规则</li><li>Component Orientations：元件布置方向规则</li><li>Permitted Layers：允许元件布置板层规则</li><li>Nets To Ignore：网络忽略规则</li><li>Hight：高度规则</li></ol><h2 id="signal-integrity信号完整性规则"><a class="anchor" href="#signal-integrity信号完整性规则">#</a> <em><strong>Signal Integrity（信号完整性规则）</strong></em></h2><ol><li>Signal Stimulus：激励信号规则</li><li>Undershoot-Falling Edge：负下冲超调量限制规则</li><li>Undershoot-Rising Edge：正下冲超调量限制规则</li><li>Impedance：阻抗限制规则</li><li>Signal Top Value：高电平信号规则</li><li>Signal Base Value：低电平信号规则</li><li>Flight Time-Rising Edge：上升飞行时间规则</li><li>Flight Time-Falling Edge：下降飞行时间规则</li><li>Slope-Rising Edge：上升沿时间规则</li><li>Slope-Falling Edge：下降沿时间规则</li><li>Supply Nets：电源网络规则</li></ol>]]></content>
      
      
      
        <tags>
            
            <tag> EDA </tag>
            
            <tag> history </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>

{
    "version": "https://jsonfeed.org/version/1",
    "title": "命运转轮 • All posts by \"freertos\" tag",
    "description": "不曾亏欠, 不曾辜负, 如此足矣",
    "home_page_url": "https://arachnid.cc",
    "items": [
        {
            "id": "https://arachnid.cc/FreeRTOS-newlib-coexist/",
            "url": "https://arachnid.cc/FreeRTOS-newlib-coexist/",
            "title": "关于 FreeRTOS和 newlib库共存问题",
            "date_published": "2021-10-23T15:03:20.000Z",
            "content_html": "<h1 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h1>\n<p>newlib 的 strtod、sprintf、sscanf、snprintf、vsnprintf 这些函数都是非线程安全的，这些函数的行为和 keil \\ IAR 以及我们的认知并不一样，这些函数在使用  <code>%f</code>  or  <code>%lf</code>  来输出浮点时，会在申请一块 <strong>3.5K</strong> 左右的内存空间，该内存空间只申请一次，且不释放。作为全局内存使用。如果有多个线程同时调用 sprintf 来字符串化浮点数据，会有几率或较大几率导致系统死机（尤其是多个线程高密度的调用 sprintf 来输出浮点数据）。如果仅用来输出字符串或整形数据，则不会出该问题，即该问题仅局限于浮点数这一块。</p>\n<p>总而言之，sprintf、sscanf、snprintf、vsnprintf、sscanf 这些函数在不处理浮点数相关的时候还是线程安全的，一旦涉及到浮点数  <code>%f</code>  or  <code>%lf</code>  就会申请一块公共的内存空间 (3.5KB) 导致线程的不安全；而 strtod 以及 printf 是彻头彻底的线程不安全（printf 线程不安全是正常的，printf 在哪个编译链下都是线程不安全的；而 strtod、sprintf 等函数理论上都应该是线程安全的 <a href=\"https://manpages.courier-mta.org/htmlman3/strtod.3.html%EF%BC%89%E3%80%82\">https://manpages.courier-mta.org/htmlman3/strtod.3.html）。</a></p>\n<h1 id=\"版本\"><a class=\"anchor\" href=\"#版本\">#</a> 版本</h1>\n<p>以下说明仅对于：</p>\n<p>1、FreeRTOS v9.0.0（<a href=\"https://github.com/FreeRTOS/FreeRTOS/tree/V9.0.0%EF%BC%89\">https://github.com/FreeRTOS/FreeRTOS/tree/V9.0.0）</a></p>\n<p>2、GNU Arm Embedded Toolchain 10-2020-q4-major（<a href=\"https://launchpad.net/gcc-arm-embedded/10.0/10-2020-q4-major%EF%BC%89%E5%86%85%E7%BD%AE%E7%9A%84\">https://launchpad.net/gcc-arm-embedded/10.0/10-2020-q4-major）内置的</a> newlib 库</p>\n<h1 id=\"freertos-对-newlib-的支持\"><a class=\"anchor\" href=\"#freertos-对-newlib-的支持\">#</a> FreeRTOS 对 newlib 的支持</h1>\n<p>当我们使用 FreeRTOS 的同时，需要值得注意的是，必须要使我们的执行任务处于线程安全之中，否者将会容易出现数据访问异常；而对 newlib 库来讲，其本身是默认不带线程安全保护的（因其内部大多数调用了  <code>malloc()</code>  等内存分配函数），虽是这样，但 FreeRTOS 仍为其上下文管理提供支持，因此当我们在  <code>FreeRTOSconfig.h</code>  中添加：<br />\n <code>#define configUSE_NEWLIB_REENTRANT 1 // newlib sprintf、strtok 等的线程安全需要...</code> ，那么，在使用此选项时 FreeRTOS 将执行以下操作（在  <code>task.c</code>  中）：</p>\n<ul>\n<li>对于每个任务，在任务控制块 (TCB) 中分配并初始化一个 newlib 重入结构。</li>\n<li>每次任务切换，设置  <code>_impure_ptr</code>  指向新激活任务的可重入结构。</li>\n<li>在任务销毁时，清理重入结构（帮助 newlib 释放任何相关内存）。</li>\n</ul>\n<p>当然，newlib 支持是已经包含在 FreeRTOS 的普遍需求中了，但 FreeRTOS 维护者本身并未使用。FreeRTOS 是不负责由此产生的 newlib 操作的，因此用户必须熟悉 newlib，并且必须提供必要存根的系统级实现，即这部分还需要您的供应商提供内置 newlib 中内存管理线程安全的支持，否者，就自己设计实现了一个系统级的内存管理线程安全（主要是  <code>malloc()</code>  等函数的可重入等问题）</p>\n<h1 id=\"当在-freertos-中直接使用-newlib-库的-printfsprintfsnprintfvsprintfvsnprintf-时出现的问题\"><a class=\"anchor\" href=\"#当在-freertos-中直接使用-newlib-库的-printfsprintfsnprintfvsprintfvsnprintf-时出现的问题\">#</a> 当在 FreeRTOS 中直接使用 newlib 库的 printf/sprintf/snprintf/vsprintf/vsnprintf 时出现的问题</h1>\n<p>前面说了  newlib 库本身是默认不带线程安全保护，因此使得一些调用了  <code>malloc()</code>  函数的 API 函数线程不安全了，这样的结果往往就会导致出现 Hardfault 异常，因此也写了 <a href=\"https://arachnid.cc/Cortex-M-abnormal/\">ARM Cortex-M3/M4/M7 Hardfault 异常分析</a> 这篇笔记。嘛，摊牌了，是来填坑的。</p>\n<p>至于这种情况，网上出现很多这样的问题（本次碰到了，为了避免忘记，所以也记录一下吧）：</p>\n<p>FreeRTOS 社区：</p>\n<p><a href=\"https://forums.freertos.org/t/hardfault-from-printf-freertos-9-0-0-stm32f0-gcc-arm-eabi-7-2-0/7533\">HardFault from printf - freertos 9.0.0 / stm32f0 / gcc-arm-eabi 7.2.0</a></p>\n<p><a href=\"https://forums.freertos.org/t/how-to-make-printf-sprintf-strtod-thread-safe/7103\">How to make printf/sprintf/strtod thread safe</a></p>\n<p><a href=\"https://forums.freertos.org/t/how-to-catch-code-that-caused-the-hard-fault/6687\">How to catch code that caused the hard fault</a></p>\n<p><a href=\"https://forums.freertos.org/t/i-o-hardfault/9364\">I/O Hardfault</a></p>\n<p>ST 社区：</p>\n<p><a href=\"https://community.st.com/s/question/0D50X0000BrC7hrSQC/hardfault-debug-in-stm32cubeide\">HardFault Debug in STM32CubeIDE</a></p>\n<p><a href=\"https://community.st.com/s/question/0D50X0000BB1eL7SQJ/bug-cubemx-freertos-projects-corrupt-memory\">BUG: CubeMX FreeRTOS projects corrupt memory</a></p>\n<p>注意：在 CubeMX 中生成的，对 newlib 库可重入函数 _sbrk () 的实现，需要干掉它（至少在我对它进行编译的时候，出现 Hardfault 异常的可能性更大）</p>\n<p>stackoverflow 社区：</p>\n<p><a href=\"https://stackoverflow.com/questions/64118480/problem-with-sprint-printf-with-freertos-on-stm32f7\">problem with sprint/printf with freeRTOS on stm32f7</a></p>\n<p>附：newlib 可重入问题及外部接口定义</p>\n<p><a href=\"https://sourceware.org/newlib/libc.html#Reentrancy\">Reentrancy</a></p>\n<p><a href=\"https://sourceware.org/newlib/libc.html#Stubs\">Definitions for OS interface</a></p>\n<h1 id=\"调用-printfsprintfsnprintfvsprintfvsnprintf的线程安全处理\"><a class=\"anchor\" href=\"#调用-printfsprintfsnprintfvsprintfvsnprintf的线程安全处理\">#</a> 调用 printf/sprintf/snprintf/vsprintf/vsnprintf 的线程安全处理</h1>\n<p>在使用 printf/sprintf/snprintf/vsprintf/vsnprintf 等 newlib 库中的 I/O 输入输出 API 函数时，由于其调用了  <code>malloc()</code>  函数等问题，导致整个任务线程处于非安全状态，然而对于一些任意内部使用 malloc 系列或依赖于特定于线程的可重入上下文的库，您往往无能为力，因为您并没用这么大的精力去主动对  <code>malloc()</code>  等函数进行加锁保护。那么不如考虑一下大佬提供的如下操作：</p>\n<p><a href=\"https://nadler.com/embedded/newlibAndFreeRTOS.html\">https://nadler.com/embedded/newlibAndFreeRTOS.html</a></p>\n<p><a href=\"https://nadler.com/embedded/NXP_newlibAndFreeRTOS.html\">https://nadler.com/embedded/NXP_newlibAndFreeRTOS.html</a></p>\n<p><a href=\"https://github.com/DRNadler/FreeRTOS_helpers\">https://github.com/DRNadler/FreeRTOS_helpers</a></p>\n<h1 id=\"newlib-下-memcpymemset-函数可能导致的死机问题\"><a class=\"anchor\" href=\"#newlib-下-memcpymemset-函数可能导致的死机问题\">#</a> newlib 下 memcpy/memset 函数可能导致的死机问题</h1>\n<p>在 newlib 下面的 memcpy 以及 memset 等函数是不考虑字节对齐问题的，这可能会导致指针地址为非字节对齐时直接死机。</p>\n<p>详见：<a href=\"https://github.com/lvgl/lvgl/issues/2790#issuecomment-980481374\">https://github.com/lvgl/lvgl/issues/2790#issuecomment-980481374</a></p>\n",
            "tags": [
                "history",
                "FreeRTOS"
            ]
        },
        {
            "id": "https://arachnid.cc/freertos-task-notify/",
            "url": "https://arachnid.cc/freertos-task-notify/",
            "title": "FreeRTOS 篇章之任务通知",
            "date_published": "2021-01-25T14:00:14.000Z",
            "content_html": "<h1 id=\"任务通知的特性\"><a class=\"anchor\" href=\"#任务通知的特性\">#</a> 任务通知的特性</h1>\n<p>通过任务通知，无需单独的通信对象，任务就可以与其他任务进行交互，以及与 ISR 同步。通过使用任务通知，任务或 ISR 可以直接向接收任务发送事件。</p>\n<p>任务通知可以通过以下几种方式更新接收任务的通知值：</p>\n<ul>\n<li>直接设置而不用覆写接收任务的通知值。</li>\n<li>覆写接收任务的通知值。</li>\n<li>设置接收任务通知值的一个或多个 bit 位。</li>\n<li>增加接收任务的通知值。</li>\n</ul>\n<p>相对于使用中介对象发送到任务（这样的例子对象是队列，信号量，互斥对象和事件组）如下图：</p>\n<p><img src=\"20210124204637565.png\" alt=\"img\" /></p>\n<p>任务通知是一种将事件直接发送到任务的方法，而无需这样做中介对象：</p>\n<p><img src=\"20210124204803426.png\" alt=\"img\" /></p>\n<p>任务通知功能是可选的，要包含任务通知功能，请在  <code>FreeRTOSConfig.h</code>  中将  <code>configUSE_TASK_NOTIFICATIONS</code>  设置为  <code>1</code>  。</p>\n<p>当  <code>configUSE_TASK_NOTIFICATIONS</code>  设置为  <code>1</code>  时，每个任务都有一个通知状态（待处理或未在等待处理）和一个通知值（一个 32 位无符号整数）。当任务收到通知时，其通知状态将设置为待处理。当任务读取其通知值时，其通知状态将设置为未在等待处理。如果出于节省空间的考虑（每个任务可以节省 4 个字节），可以设置  <code>configUSE_TASK_NOTIFICATIONS</code>  为  <code>0</code>  来禁用。<br />\n任务可在 “被阻止” 状态中等待其通知状态变为待处理，还可以选择指定超时。</p>\n<h1 id=\"存在的限制\"><a class=\"anchor\" href=\"#存在的限制\">#</a> 存在的限制</h1>\n<p>在以下情形中不能使用任务通知：</p>\n<ul>\n<li>\n<p>向 ISR 发送事件或数据。</p>\n<p>通信对象可供 ISR 和任务相互发送事件和数据。</p>\n<p>任务通知可用于从 ISR 向任务发送事件和数据，但不能用于从任务向 ISR 发送事件或数据。</p>\n</li>\n<li>\n<p>启用多个接收任务。</p>\n<p>通信对象可由任何知其句柄（可能是队列句柄、信号灯句柄或事件组句柄）的任务或 ISR 访问。任意数量的任务和 ISR 可处理发送到任何给定通信对象的事件或数据。</p>\n<p>任务通知直接发送给接收任务，因此只能由接收通知的任务来处理。这在多数情况下并不是限制，因为尽管通常有多个任务和 ISR 向相同的通信对象发送事件或数据，但是很少有多个任务和 ISR 接收来自同一通信对象的事件或数据。</p>\n</li>\n<li>\n<p>缓冲多个数据项。</p>\n<p>队列是一次可保存多个数据项的通信对象。已发送到队列但尚未从队列中接收的数据将在队列对象中缓冲。</p>\n<p>任务通知通过更新接收任务的通知值向任务发送数据。任务的通知值一次只能保存一个值。</p>\n</li>\n<li>\n<p>广播到多个任务。</p>\n<p>事件组是可用于一次向多个任务发送事件的通信对象。</p>\n<p>任务通知直接发送给接收任务，因此只能由接收任务来处理。</p>\n</li>\n<li>\n<p>在 “被阻止” 状态中等待发送完成。</p>\n<p>如果通信对象暂时处于无法向其中写入更多数据或事件的状态（例如，当队列已满、无法向该队列发送更多数据时），尝试向该对象写入内容的任务可以选择进入 “被阻止” 状态，以等待其写入操作完成。</p>\n<p>如果一个任务尝试向已有待处理通知的另一个任务发送任务通知，则发送任务无法在 “被阻止” 状态中等待接收任务重置其通知状态。在大多数使用任务通知的情况下，这极少成为限制。</p>\n</li>\n</ul>\n<h1 id=\"api函数\"><a class=\"anchor\" href=\"#api函数\">#</a> API 函数</h1>\n<p>任务通知使用 API 函数  <code>xTaskNotify() </code> 或  <code>xTaskNotifyGive()</code>  来发送，这个通知将一直挂起直到接收任务使用 API 函数  <code>xTaskNotifyWait() </code> 或  <code>ulTaskNotifyTake() </code> 来接收通知。如果接收任务在通知到来时已经被阻塞，则会从阻塞态恢复，同时通知被清除。</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">功能</th>\n<th style=\"text-align:left\">API 接口</th>\n<th style=\"text-align:left\">实际执行函数</th>\n<th style=\"text-align:left\">其它</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">发送通知</td>\n<td style=\"text-align:left\">xTaskNotifyGive()</td>\n<td style=\"text-align:left\">xTaskGenericNotify()</td>\n<td style=\"text-align:left\">没有通知值 （信号量类型）</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">发送通知（用于中断中）</td>\n<td style=\"text-align:left\">vTaskNotifyGiveFromISR()</td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">接收通知</td>\n<td style=\"text-align:left\">ulTaskNotifyTake()</td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">单独对应 xTaskNotifyGive ()</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">发送通知</td>\n<td style=\"text-align:left\">xTaskNotify()</td>\n<td style=\"text-align:left\">xTaskGenericNotify()</td>\n<td style=\"text-align:left\">带通知值</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">发送通知（用于中断中）</td>\n<td style=\"text-align:left\">xTaskNotifyFromISR()</td>\n<td style=\"text-align:left\">xTaskGenericNotifyFromISR()</td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">发送通知</td>\n<td style=\"text-align:left\">xTaskNotifyAndQuery()</td>\n<td style=\"text-align:left\">xTaskGenericNotify()</td>\n<td style=\"text-align:left\">带通知值，并且返回原通知值</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">发送通知（用于中断中）</td>\n<td style=\"text-align:left\">xTaskNotifyAndQueryFromISR()</td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">接收通知</td>\n<td style=\"text-align:left\">xTaskNotifyWait()</td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">清除通知</td>\n<td style=\"text-align:left\">xTaskNotifyStateClear()</td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\"></td>\n</tr>\n</tbody>\n</table>\n<p>在大多数情况下，并不需要  <code>xTaskNotify()</code>  和  <code>xTaskNotifyWait()</code>  API 函数提供的灵活性。更简单的函数就足够了。 <code>xTaskNotifyGive()</code>  API 函数可替代  <code>xTaskNotify()</code>  ，它更简单、但灵活性稍差。 <code>ulTaskNotifyTake()</code>  API 函数可替代  <code>xTaskNotifyWait()</code> ，它更简单、但灵活性稍差。</p>\n<p><strong>1、xTaskNotifyGive () 和 vTaskNotifyGiveFromISR () API 函数</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>BaseType_t  <span class=\"token function\">xTaskNotifyGive</span><span class=\"token punctuation\">(</span> TaskHandle_t  xTaskToNotify <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">vTaskNotifyGiveFromISR</span><span class=\"token punctuation\">(</span> TaskHandle_t  xTaskToNotify<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                             BaseType_t    <span class=\"token operator\">*</span>pxHigherPriorityTaskWoken <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>传入参数：</p>\n<ul>\n<li><strong>xTaskToNotify</strong>：需要通知的任务句柄。这个句柄即是调用  <code>xTaskCreate()</code>  创建任务时传递的句柄。</li>\n<li><strong>pxHigherPriorityTaskWoken</strong>：如果调用  <code>vTaskNotifyGiveFromISR()</code>  发送通知导致被发送通知的任务离开阻塞状态，并且这个任务的优先级高于当前任务（也就是被中断的任务），那么  <code>xSemaphoreGiveFromISR()</code>  会在函数内部将  <code>*pxHigherPriorityTaskWoken</code>  设为  <code>pdTRUE</code>  。如果  <code>vTaskNotifyGiveFromISR()</code>  将此值设为  <code>pdTRUE</code>  ，则在中断退出前应当进行一次上下文切换。</li>\n</ul>\n<p>返回参数（始终返回 pdPASS）：</p>\n<ul>\n<li><strong>pdPASS</strong>：发送成功。</li>\n</ul>\n<p><strong>2、ulTaskNotifyTake () API 函数</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">uint32_t</span>  <span class=\"token function\">ulTaskNotifyTake</span><span class=\"token punctuation\">(</span> BaseType_t  xClearCountOnExit<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                            TickType_t  xTicksToWait <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>传入参数：</p>\n<ul>\n<li><strong>xClearCountOnExit</strong>：当设置为  <code>pdFALSE</code>  ，则在函数退出时任务的通知值递减，这样，通知值就像一个计数信号量；如果是  <code>pdTRUE</code>  ，那么当函数退出时，任务的通知值将被清除为零，这样，通知值就像一个二进制信号量。</li>\n<li><strong>xTicksToWait</strong>：阻塞超时时间。任务进入阻塞态以等待任务通知有效的最长时间。如果  <code>xTicksToWait</code>  为  <code>0</code>  ，则  <code>ulTaskNotifyTake()</code>  在通知无效时会立即返回；如果把  <code>xTicksToWait</code>  设置为  <code>portMAX_DELAY</code>  ，那么阻塞等待将没有超时限制。</li>\n</ul>\n<p>返回参数：</p>\n<ul>\n<li><strong>uint32_t</strong>：在任务的通知计数清空为零或递减之前的任务通知值。</li>\n</ul>\n<p><strong>3、xTaskNotify () 和 xTaskNotifyFromISR () API 函数</strong></p>\n<p>BaseType_t  xTaskNotify( TaskHandle_t  xTaskToNotify,<br />\nuint32_t      ulValue,<br />\neNotifyAction  eAction );</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>BaseType_t  <span class=\"token function\">xTaskNotifyFromISR</span><span class=\"token punctuation\">(</span> TaskHandle_t   xTaskToNotify<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                                <span class=\"token class-name\">uint32_t</span>       ulValue<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                                eNotifyAction  eAction<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                                BaseType_t     <span class=\"token operator\">*</span>pxHigherPriorityTaskWoken <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>传入参数：</p>\n<ul>\n<li><strong>xTaskToNotify</strong>：需要通知的任务句柄。这个句柄即是调用  <code>xTaskCreate()</code>  创建任务时传递的句柄。</li>\n<li><strong>ulValue</strong>：与通知一起发送的数据，如何使用  <code>ulValue</code>  取决于  <code>eNotifyAction</code>  值。</li>\n<li><strong>eAction</strong>：枚举类型，用于指定如何更新接收任务的通知值。</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">枚举成员</th>\n<th style=\"text-align:left\">描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">eNoAction</td>\n<td style=\"text-align:left\">通知任务，而不更新其通知值；参数 ulValue 未使用。可用作更快速的二进制信号量轻型替代方案。始终返回 pdPASS。</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">eSetBits</td>\n<td style=\"text-align:left\">对被通知任务的通知值按位执行或运算。可用作更快速的事件组轻型替代方案。始终返回 pdPASS。</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">eIncrement</td>\n<td style=\"text-align:left\">接收任务的通知值将递增。可用作更快速的计数信号量轻型替代方案。始终返回 pdPASS。</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">eSetValueWithOverwrite</td>\n<td style=\"text-align:left\">即使任务尚未读取前一个值，也将任务的通知值设置为 ulValue 参数中传递的值。始终返回 pdPASS。</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">eSetValueWithoutOverwrite</td>\n<td style=\"text-align:left\">如果任务当前没有通知值，则设置任务的通知值并返回 pdPASS；如果任务没有取出前一个通知值，则不执行任何操作，将返回 pdFAIL。</td>\n</tr>\n</tbody>\n</table>\n<ul>\n<li><strong>pxHigherPriorityTaskWoken</strong>：如果调用  <code>xTaskNotifyFromISR()</code>  发送通知导致被发送通知的任务离开阻塞状态，并且这个任务的优先级高于当前任务 (也就是被中断的任务)，那么  <code>xTaskNotifyFromISR()</code>  会在函数内部将  <code>*pxHigherPriorityTaskWoken</code>  设为  <code>pdTRUE</code>  。如果  <code>xTaskNotifyFromISR()</code>  将此值设为  <code>pdTRUE</code>  ，则在中断退出前应当进行一次上下文切换。</li>\n</ul>\n<p>返回参数：</p>\n<ul>\n<li><strong>BaseType_t</strong>：取决于  <code>eAction</code>  的值。</li>\n</ul>\n<p><strong>4、xTaskNotifyWait () API 函数</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>BaseType_t  <span class=\"token function\">xTaskNotifyWait</span><span class=\"token punctuation\">(</span> <span class=\"token class-name\">uint32_t</span>    ulBitsToClearOnEntry<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                             <span class=\"token class-name\">uint32_t</span>    ulBitsToClearOnExit<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                             <span class=\"token class-name\">uint32_t</span>    <span class=\"token operator\">*</span>pulNotificationValue<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                             TickType_t  xTicksToWait <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>传入参数：</p>\n<ul>\n<li><strong>ulBitsToClearOnEntry</strong>：在使用通知之前，先将任务的通知值与参数  <code>ulBitsToClearOnEntry</code>  的按位取反值按位与操作。设置参数  <code>ulBitsToClearOnEntry</code>  为  <code>0xFFFFFFFF(ULONG_MAX)</code>  ，表示清零任务通知值。</li>\n<li><strong>ulBitsToClearOnExit</strong>：在退出函数之前，将任务的通知值与参数  <code>ulBitsToClearOnExit</code>  的按位取反值按位与操作。设置参数  <code>ulBitsToClearOnExit</code>  为  <code>0xFFFFFFFF(ULONG_MAX)</code>  ，表示清零任务通知值。</li>\n<li><strong>pulNotificationValue</strong>：用于向外回传任务的通知值。这个通知值在参数  <code>ulBitsToClearOnExit</code>  起作用前将通知值拷贝到  <code>*pulNotificationValue</code>  中。可选参数，如果不需要，可将其设置为 NULL。</li>\n<li><strong>xTicksToWait</strong>：阻塞超时时间。任务进入阻塞态以等待任务通知有效的最长时间。如果  <code>xTicksToWait</code>  为  <code>0</code>  ，则  <code>xTaskNotifyWait()</code>  在通知无效时会立即返回；如果把  <code>xTicksToWait</code>  设置为  <code>portMAX_DELAY</code>  ，那么阻塞等待将没有超时限制。</li>\n</ul>\n<p>返回参数：</p>\n<ul>\n<li><strong>pdPASS</strong>：接收成功。</li>\n<li><strong>pdFAIL</strong>：接收失败（超时）。</li>\n</ul>\n<h1 id=\"应用\"><a class=\"anchor\" href=\"#应用\">#</a> 应用</h1>\n<p><strong>1、替代二值信号量 (binary semaphore)</strong></p>\n<p>任务通知比二值信号量快 45% 并且内存占用更小</p>\n<ul>\n<li>发送处理：<strong> <code>xTaskNotifyGive() </code> </strong> 和 <strong> <code>vTaskNotifyGiveFromISR()</code> </strong> 用来代替 <strong> <code>xSemaphoreGive()</code> </strong> 和 <strong> <code>xSemaphoreGiveFromISR()</code> </strong> 。</li>\n<li>接收处理：<strong> <code>ulTaskNotifyTake()</code> </strong> 用来替代 <strong> <code>xSemaphoreTake()</code> </strong> （ps： <code>ulTaskNotifyTake()</code>  的第一个参数  <code>xClearCountOnExit</code>  应设置为  <code>pdTRUE</code>  ）。</li>\n</ul>\n<p><strong>2、替代计数信号量 (counting semaphore)</strong></p>\n<p>与替代二值信号量类似，当使用任务通知来代替计数信号量的时候，接收任务的通知值被用来代替计数信号量的计数值</p>\n<ul>\n<li>发送处理：<strong> <code>xTaskNotifyGive()</code> </strong> 和 <strong> <code>vTaskNotifyGiveFromISR()</code> </strong> 用来代替 <strong> <code>xSemaphoreGive() </code> </strong> 和 <strong> <code>xSemaphoreGiveFromISR()</code> </strong> 。</li>\n<li>接收处理：<strong> <code>ulTaskNotifyTake()</code> </strong> 用来替代 <strong> <code>xSemaphoreTake()</code> </strong> （ps： <code>ulTaskNotifyTake()</code>  的第一个参数  <code>xClearCountOnExit</code>  应设置为  <code>pdFALSE</code>  ）。</li>\n</ul>\n<p><strong>3、替代事件组 (event group)</strong></p>\n<p>当任务通知用来代替时间组的时候，通知值被用来代替事件组的任务值，通知值的每一位被用来代表某个标志</p>\n<ul>\n<li>发送处理：<strong> <code>xTaskNotify()</code> </strong> 和 <strong> <code>xTaskNotifyFromISR()</code> </strong> 用来代替 <strong> <code>xEventGroupSetBits()</code> </strong> 和 <strong> <code>xEventGroupSetBitsFromISR()</code> </strong> 。</li>\n<li>接收处理：<strong> <code>xTaskNotifyWait()</code> </strong> 用来代替 <strong> <code>xEventGroupWaitBits()</code> </strong> 。</li>\n</ul>\n<p><strong>4、替代邮箱队列 (mailbox)</strong></p>\n<p>RTOS 任务通知只能用来发送数据到一个任务中，相比用队列实现，有一些限制：</p>\n<ol>\n<li>只能发送 32-bit 数据。</li>\n<li>保存的是接收任务的值，同一个时刻只能存在一个接收任务。</li>\n</ol>\n<p>因此，使用 “轻量邮箱” 这个短语代替 “轻量队列”。任务的通知值就是邮箱值</p>\n<ul>\n<li>发送处理：使用 <strong> <code>xTaskNotify()</code> </strong> 和 <strong> <code>xTaskNotifyFromISR()</code> </strong> 发送至任务，可以用来替换 <strong> <code>xQueueOverwtite()</code> </strong> 和 <strong> <code>xQueueOverwtiteFromISR()</code> </strong> 。</li>\n<li>接收处理：使用 <strong> <code>xTaskNotifyWait()</code> </strong> 来获取通知值，可以用来代替 <strong> <code>xQueueReceive()</code> </strong> 和 <strong> <code>xQueuePeek()</code> </strong> 。</li>\n</ul>\n",
            "tags": [
                "history",
                "FreeRTOS",
                "RTOS"
            ]
        },
        {
            "id": "https://arachnid.cc/freertos-event/",
            "url": "https://arachnid.cc/freertos-event/",
            "title": "FreeRTOS 篇章之事件位和事件组",
            "date_published": "2020-03-02T13:37:43.000Z",
            "content_html": "<h1 id=\"事件位或标志与事件组\"><a class=\"anchor\" href=\"#事件位或标志与事件组\">#</a> 事件位（或标志）与事件组</h1>\n<p>事件位：用于指示事件是否发生；事件位通常称为事件标志。</p>\n<p>事件组：是一组事件位；事件组中的各个事件位由位号引用（即每一 bit 代表某个事件）</p>\n<h1 id=\"事件组和事件位数据类型\"><a class=\"anchor\" href=\"#事件组和事件位数据类型\">#</a> 事件组和事件位数据类型</h1>\n<p>事件组由  <code>EventGroupHandle_t</code>  类型的变量引用</p>\n<p>如果  <code>configUSE_16_BIT_TICKS</code>  设置为  <code>1</code>  ，则事件组中存储的位数（或标志）为 8；如果  <code>configUSE_16_BIT_TICKS</code>  设置为  <code>0</code>  ，则为 24；对  <code>configUSE_16_BIT_TICKS</code>  的依赖性是由于在内部实现中用于线程本地存储的数据类型任务。</p>\n<p><code>configUSE_16_BIT_TICKS</code>  的具体的描述可以看 <a href=\"https://arachnid.cc/docs/RTOS/FreeRTOS%20%E7%AF%87%E7%AB%A0%E4%B9%8B%20FreeRTOSConfig.h%E5%88%86%E6%9E%90/\">FreeRTOS 篇章之 FreeRTOSConfig.h 分析</a> 。</p>\n<p>事件组中的所有事件位都存储在  <code>EventBits_t</code>  类型的单个无符号变量中。事件位 0 存储在位位置 0，事件位 1 存储在位位置 1，依此类推。</p>\n<p>下图显示了一个 24 位事件组，该组使用三个位来保存已描述的三个示例事件。在图像中，仅事件位 2 被设置。</p>\n<p><img src=\"20200302151607721.png\" alt=\"\" /></p>\n<h1 id=\"使用事件组必须克服的问题\"><a class=\"anchor\" href=\"#使用事件组必须克服的问题\">#</a> 使用事件组必须克服的问题</h1>\n<p>实施事件组时，RTOS 必须克服的两个主要挑战是：</p>\n<p>1、避免在用户的应用程序中创建竞争条件：</p>\n<p>在以下情况下，事件组的实现将会在应用程序中创建竞争条件：</p>\n<ul>\n<li>目前尚不清楚谁负责清除单个位（或标志）。</li>\n<li>尚不清楚何时清除一点。</li>\n<li>尚不清楚在任务退出测试该位值的 API 函数时是否设置了位或清除了位（这可能是因为另一个任务或中断已更改了位的状态）。</li>\n</ul>\n<p>FreeRTOS 事件组的实现通过智能的建立来确保设置、测试和清除位的原子性，从而消除了竞争条件的可能性。线程本地存储和谨慎使用 API 函数返回值使这成为可能。</p>\n<p>2、避免不确定性：</p>\n<p>事件组的概念隐含了不确定性行为，因为它不知道事件组上有多少个任务被阻止，因此，当设置了事件位时，也不知道需要测试多少条件或解除多少任务阻塞。</p>\n<p>FreeRTOS 质量标准不允许不确定的行为在中断禁用或者中断服务中发生。为确保在设置事件位时不会违反这些严格的质量标准，需要以下两点：</p>\n<ul>\n<li>RTOS 调度器的锁定机制用于确保从 RTOS 任务设置事件位时，中断保持启用状态。</li>\n<li>中央延迟中断机制用于在试图从中断服务例程设置事件位时，将设置位的动作延迟到任务。</li>\n</ul>\n<h1 id=\"事件组的-rtos-api-函数\"><a class=\"anchor\" href=\"#事件组的-rtos-api-函数\">#</a> 事件组的 RTOS API 函数</h1>\n<p>事件组的 API 函数允许任务或者其他事项来设置事件组中的一个或多个事件位，清除事件组中的 一个或多个事件位，并暂挂（进入 “阻止” 状态，因此任务不会占用任何处理时间）以等待一个或多个事件位在事件组中被置位。</p>\n<p>事件组还可用于同步任务，创建通常称为任务 “会合” 的任务。任务同步点是应用程序代码中的一个位置，在这个位置上，任务将处于阻塞状态 (不消耗任何 CPU 时间) 等待，直到参与同步的所有其他任务也到达它们的同步点。</p>\n<p>需要  <code>#include &quot;event_groups.h&quot;</code></p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">功能</th>\n<th style=\"text-align:left\">API 接口</th>\n<th style=\"text-align:left\">实际执行函数</th>\n<th style=\"text-align:left\">其它</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">事件组创建（动态）</td>\n<td style=\"text-align:left\">xEventGroupCreate()</td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">事件组响应等待</td>\n<td style=\"text-align:left\">xEventGroupWaitBits()</td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">事件组位清除</td>\n<td style=\"text-align:left\">xEventGroupClearBits()</td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">事件组位清除（用于中断中）</td>\n<td style=\"text-align:left\">xEventGroupClearBitsFromISR()</td>\n<td style=\"text-align:left\">xTimerPendFunctionCallFromISR()</td>\n<td style=\"text-align:left\">实际执行函数由宏决定</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">事件组置位</td>\n<td style=\"text-align:left\">xEventGroupSetBits()</td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">事件组置位（用于中断中）</td>\n<td style=\"text-align:left\">xEventGroupSetBitsFromISR()</td>\n<td style=\"text-align:left\">xTimerPendFunctionCallFromISR()</td>\n<td style=\"text-align:left\">实际执行函数由宏决定</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">事件组位获取</td>\n<td style=\"text-align:left\">xEventGroupGetBits()</td>\n<td style=\"text-align:left\">xEventGroupClearBits()</td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">事件组位获取（用于中断中）</td>\n<td style=\"text-align:left\">xEventGroupGetBitsFromISR()</td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">事件组释放删除</td>\n<td style=\"text-align:left\">vEventGroupDelete()</td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">事件组创建（静态）</td>\n<td style=\"text-align:left\">xEventGroupCreateStatic()</td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\"></td>\n</tr>\n</tbody>\n</table>\n<p><strong>1、xEventGroupCreate () API 函数</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>EventGroupHandle_t  <span class=\"token function\">xEventGroupCreate</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>返回参数（此返回值应当保存下来，以作为操作此队列的句柄）：</p>\n<ul>\n<li><strong>NULL</strong>：表示事件组创建失败。原因是内存堆空间不足导致 FreeRTOS 无法为互斥量分配结构数据空间。</li>\n<li><strong>非 NULL</strong>：值表示事件组创建成功。返回值应当保存起来作为该事件组的句柄。</li>\n</ul>\n<p><strong>2、xEventGroupWaitBits () API 函数</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>EventBits_t  <span class=\"token function\">xEventGroupWaitBits</span><span class=\"token punctuation\">(</span> EventGroupHandle_t  xEventGroup<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                                  <span class=\"token keyword\">const</span> EventBits_t   uxBitsToWaitFor<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                                  <span class=\"token keyword\">const</span> BaseType_t    xClearOnExit<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                                  <span class=\"token keyword\">const</span> BaseType_t    xWaitForAllBits<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                                  <span class=\"token keyword\">const</span> TickType_t    xTicksToWait <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>传入参数：</p>\n<ul>\n<li><strong>xEventGroup</strong>：事件组的目标句柄。这个句柄即是调用  <code>xEventGroupCreate()</code>  创建该事件组时的返回值。</li>\n<li><strong>uxBitsToWaitFor</strong>：一个按位的值，表示在事件组中可设置的事件位（或标志）。</li>\n<li><strong>xClearOnExit</strong>：如果设置为  <code>pdTRUE</code>  ，那么如果满足了等待条件 (如果函数返回的原因不是超时)，则在事件组中设置的  <code>uxBitsToWaitFor</code>  中的任何位都将在  <code>xEventGroupWaitBits()</code>  返回之前被清除；否则，如果设置为  <code>pdFALSE</code>  ，那么当调用  <code>xEventGroupWaitBits()</code>  返回时，事件组中设置的位不会改变。</li>\n<li><strong>xWaitForAllBits</strong>：如果设置为  <code>pdTRUE</code>  ，那么当  <code>uxBitsToWaitFor</code>  中的所有位被设置或者指定的块时间过期时， <code>xEventGroupWaitBits()</code>  将返回；否则，如果设置为  <code>pdFALSE</code>  ，那么当  <code>uxBitsToWaitFor</code>  中设置的任何一个位或者指定的块时间过期时， <code>xEventGroupWaitBits()</code>  将返回。</li>\n<li><strong>xTicksToWait</strong>：阻塞超时时间。</li>\n</ul>\n<p>返回参数：</p>\n<ul>\n<li>事件组中事件位的设置情况。如果  <code>xEventGroupWaitBits()</code>  因为超时而返回，则不会设置所有正在等待的事件位；在  <code>xClearOnExit</code>  参数被设置为  <code>pdTRUE</code>  的情况下，如果  <code>xEventGroupWaitBits()</code>  是因为它正在等待的位被设置而返回，那么返回的值就是在任何位被自动清除之前的事件组值。</li>\n</ul>\n<p><strong>3、xEventGroupClearBits () API 函数</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>EventBits_t  <span class=\"token function\">xEventGroupClearBits</span><span class=\"token punctuation\">(</span> EventGroupHandle_t  xEventGroup<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                                   <span class=\"token keyword\">const</span> EventBits_t   uxBitsToClear <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>传入参数：</p>\n<ul>\n<li><strong>xEventGroup</strong>：要清除其中位的事件组。</li>\n<li><strong>uxBitsToClear</strong> ：位值。表示在事件组中要清除的事件位（或标志）。</li>\n</ul>\n<p>返回参数：</p>\n<ul>\n<li>清除指定位之前的事件组的值</li>\n</ul>\n<p><strong>4、xEventGroupClearBitsFromISR () API 函数</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>BaseType_t  <span class=\"token function\">xEventGroupClearBitsFromISR</span><span class=\"token punctuation\">(</span> EventGroupHandle_t  xEventGroup<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                                         <span class=\"token keyword\">const</span> EventBits_t   uxBitsToClear <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>传入参数：</p>\n<ul>\n<li><strong>xEventGroup</strong>：要清除其中位的事件组。</li>\n<li><strong>uxBitsToClear</strong> ：位值。表示在事件组中要清除的事件位（或标志）。</li>\n</ul>\n<p>返回参数（有两个可能的返回值）：</p>\n<ul>\n<li><strong>pdPASS</strong>：成功发送请求。</li>\n<li><strong>pdFALSE</strong>：发送请求失败。计时器服务队列已满。</li>\n</ul>\n<p><strong>5、xEventGroupSetBits () API 函数</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>EventBits_t  <span class=\"token function\">xEventGroupSetBits</span><span class=\"token punctuation\">(</span> EventGroupHandle_t  xEventGroup<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                                 <span class=\"token keyword\">const</span> EventBits_t   uxBitsToSet <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>传入参数：</p>\n<ul>\n<li><strong>xEventGroup</strong>：要在其中位设置的事件组。</li>\n<li><strong>uxBitsToSet</strong> ：一个按位的值，表示要设置的事件位（或标志）。</li>\n</ul>\n<p>返回参数：</p>\n<ul>\n<li>事件组在调用  <code>xEventGroupSetBits()</code>  时的值。</li>\n</ul>\n<p>注意：用户通过参数  <code>uxBitsToSet</code>  设置的标志位并不一定会保留到此函数的返回值中，返回的值可能清除有以下两种情况：<br />\n　a. 调用此函数的过程中，其它高优先级的任务就绪了，并且也修改了事件标志，此函数返回的事件标志位会发生变化。<br />\n　b. 调用此函数的任务是一个低优先级任务，通过此函数设置了事件标志后，让一个等待此事件标志的高优先级任务就绪了，会立即切换到高优先级任务去执行，相应的事件标志位会被函数  <code>xEventGroupWaitBits</code>  清除掉，等从高优先级任务返回到低优先级任务后，函数  <code>xEventGroupSetBits</code>  的返回值已经被修改。</p>\n<p><strong>6、xEventGroupSetBitsFromISR () API 函数</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>BaseType_t  <span class=\"token function\">xEventGroupSetBitsFromISR</span><span class=\"token punctuation\">(</span> EventGroupHandle_t  xEventGroup<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                                       <span class=\"token keyword\">const</span> EventBits_t   uxBitsToSet<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                                       BaseType_t          <span class=\"token operator\">*</span>pxHigherPriorityTaskWoken <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>传入参数：</p>\n<ul>\n<li><strong>xEventGroup</strong>：要在其中位设置的事件组。</li>\n<li><strong>uxBitsToSet</strong> ：一个按位的值，表示要设置的事件位（或标志）。</li>\n<li><strong>pxHigherPriorityTaskWoken</strong>：用于保存是否有高优先级任务准备就绪。如果函数执行完毕后，此参数的数值是  <code>pdTRUE</code>  ，说明有高优先级任务要执行，否则没有；必须将  <code>xHigherPriorityTaskWoken</code>  初始化为  <code>pdFALSE</code>  。</li>\n</ul>\n<p>返回参数（有两个可能的返回值）：</p>\n<ul>\n<li><strong>pdPASS</strong>：成功发送请求。</li>\n<li><strong>pdFALSE</strong>：发送请求失败。计时器服务队列已满。</li>\n</ul>\n<p><strong>7、xEventGroupGetBits () API 函数</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>EventBits_t  <span class=\"token function\">xEventGroupGetBits</span><span class=\"token punctuation\">(</span> EventGroupHandle_t  xEventGroup <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>传入参数：</p>\n<ul>\n<li><strong>xEventGroup</strong>：需要查询的事件组。</li>\n</ul>\n<p>返回参数：</p>\n<ul>\n<li>调用  <code>xEventGroupGetBits()</code>  时的事件组位。</li>\n</ul>\n<p><strong>8、xEventGroupGetBitsFromISR () API 函数</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>EventBits_t  <span class=\"token function\">xEventGroupGetBitsFromISR</span><span class=\"token punctuation\">(</span> EventGroupHandle_t  xEventGroup <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>传入参数：</p>\n<ul>\n<li><strong>xEventGroup</strong>：需要查询的事件组。</li>\n</ul>\n<p>返回参数：</p>\n<ul>\n<li>调用  <code>xEventGroupGetBitsFromISR()</code>  时的事件组位。</li>\n</ul>\n<p><strong>9、xEventGroupDelete () API 函数</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">xEventGroupDelete</span><span class=\"token punctuation\">(</span> EventGroupHandle_t  xEventGroup <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>传入参数：</p>\n<ul>\n<li><strong>xEventGroup</strong>：需要删除的事件组。</li>\n</ul>\n<p><strong>10、xEventGroupCreateStatic () API 函数</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>EventGroupHandle_t  <span class=\"token function\">xEventGroupCreateStatic</span><span class=\"token punctuation\">(</span> EventGroupHandle_t  <span class=\"token operator\">*</span>pxEventGroupBuffer <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>该函数是用于在静态的时候，利用该函数创建一个事件组，具体可以去看他的注释，这里就不说了。</p>\n<h1 id=\"实例代码\"><a class=\"anchor\" href=\"#实例代码\">#</a> 实例代码</h1>\n<p>相关的实例代码及文档，参看保存在官方文件路径  <code>FreeRTOS/Demo/Common/Minimal</code>  下的  <code>EventGroupsDemo.c</code>  文件</p>\n",
            "tags": [
                "history",
                "FreeRTOS",
                "RTOS"
            ]
        },
        {
            "id": "https://arachnid.cc/freertos-critical-scheduler/",
            "url": "https://arachnid.cc/freertos-critical-scheduler/",
            "title": "FreeRTOS 篇章之临界区与调度器",
            "date_published": "2020-02-25T08:23:59.000Z",
            "content_html": "<h1 id=\"临界区简述\"><a class=\"anchor\" href=\"#临界区简述\">#</a> 临界区简述</h1>\n<p><strong>临界区</strong>指的是一个访问共用资源（例如：共用设备或是共用存储器）的程序片段，而这些共用资源又无法同时被多个线程访问的特性；当有线程进入临界区时，其他线程或是进程必须等待。总的概括来说就是在执行该程序片段区间，不允许其他东西干扰到。</p>\n<p>像我们在 MCU 上面跑实时操作系统，一般都是单核单进程的，而一个进程可以拥有多个线程；FreeRTOS 是主要以抢占式任务调度为主（通过 PendSV 中断），以时间片轮转调度任务为辅（通过 SysTick 系统节拍器中断）的实时操作系统，并且可支持同等优先级切换，具体配置可以看 <a href=\"https://arachnid.cc/freertos-config/\">FreeRTOS 篇章之 FreeRTOSConfig.h 分析</a> ；而刚讲的线程其实就相当于我们用 xTaskCreate 函数创建的各种任务。在这里，我们要实现临界区操作，那么就相当于要保证当前所处在的需要保护的代码片段不要受其他任务（线程）的干扰（例如同等优先级的切换、中断的触发）。</p>\n<p>在 FreeRTOS 中，实现临界区操作有临界段操作和调度器操作两种，一般常用临界段来实现实现临界区操作。</p>\n<hr />\n<h1 id=\"临界段的特性\"><a class=\"anchor\" href=\"#临界段的特性\">#</a> 临界段的特性</h1>\n<p>临界段是提供互斥功能的一种非常原始的实现方法。临界段的工作仅仅是简单地把任务切换和在  <code>configKERNEL_INTERRUPT_PRIORITY</code>  至  <code>configMAX_SYSCAL_INTERRUPT_PRIORITY</code>  之间的中断关掉 —— 依赖于具体使用的 FreeRTOS 移植。</p>\n<p>临界段的使用必须只具有很短的时间，否则会反过来影响中断响应时间；在每次调用  <code>taskENTER_CRITICAL()</code>  之后，必须尽快地配套调用一个  <code>taskEXIT_CRITICAL()</code>  。</p>\n<p>临界段嵌套是安全的，因为内核有维护一个嵌套深度计数。临界段只会在嵌套深度为 0 时才会真正退出 —— 即在为每个之前调用的  <code>taskENTER_CRITICAL()</code>  都配套调用了  <code>taskEXIT_CRITICAL()</code>  之后。</p>\n<h1 id=\"与临界段相关的-api-函数\"><a class=\"anchor\" href=\"#与临界段相关的-api-函数\">#</a> 与临界段相关的 API 函数</h1>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">功能</th>\n<th style=\"text-align:left\">API 函数</th>\n<th style=\"text-align:left\">其它</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">进入临界段</td>\n<td style=\"text-align:left\">taskENTER_CRITICAL()</td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">taskENTER_CRITICAL_FROM_ISR()</td>\n<td style=\"text-align:left\">用于中断中</td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">退出临界段</td>\n<td style=\"text-align:left\">taskEXIT_CRITICAL()</td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">taskEXIT_CRITICAL_FROM_ISR( x )</td>\n<td style=\"text-align:left\">用于中断中</td>\n<td style=\"text-align:left\"></td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * task. h</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * Macro to mark the start of a critical code region.  Preemptive context</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> * switches cannot occur when in a critical region.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> * NOTE: This may alter the stack (depending on the portable implementation)</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> * so must be used with care!</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> * \\defgroup taskENTER_CRITICAL taskENTER_CRITICAL</pre></td></tr><tr><td data-num=\"11\"></td><td><pre> * \\ingroup SchedulerControl</pre></td></tr><tr><td data-num=\"12\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">taskENTER_CRITICAL</span><span class=\"token expression\"><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\t\t<span class=\"token function\">portENTER_CRITICAL</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">taskENTER_CRITICAL_FROM_ISR</span><span class=\"token expression\"><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token function\">portSET_INTERRUPT_MASK_FROM_ISR</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"17\"></td><td><pre> * task. h</pre></td></tr><tr><td data-num=\"18\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"19\"></td><td><pre> * Macro to mark the end of a critical code region.  Preemptive context</pre></td></tr><tr><td data-num=\"20\"></td><td><pre> * switches cannot occur when in a critical region.</pre></td></tr><tr><td data-num=\"21\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"22\"></td><td><pre> * NOTE: This may alter the stack (depending on the portable implementation)</pre></td></tr><tr><td data-num=\"23\"></td><td><pre> * so must be used with care!</pre></td></tr><tr><td data-num=\"24\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"25\"></td><td><pre> * \\defgroup taskEXIT_CRITICAL taskEXIT_CRITICAL</pre></td></tr><tr><td data-num=\"26\"></td><td><pre> * \\ingroup SchedulerControl</pre></td></tr><tr><td data-num=\"27\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">taskEXIT_CRITICAL</span><span class=\"token expression\"><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\t\t\t<span class=\"token function\">portEXIT_CRITICAL</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">taskEXIT_CRITICAL_FROM_ISR</span><span class=\"token expression\"><span class=\"token punctuation\">(</span> x <span class=\"token punctuation\">)</span> <span class=\"token function\">portCLEAR_INTERRUPT_MASK_FROM_ISR</span><span class=\"token punctuation\">(</span> x <span class=\"token punctuation\">)</span></span></span></pre></td></tr></table></figure><hr />\n<h1 id=\"临界段的使用\"><a class=\"anchor\" href=\"#临界段的使用\">#</a> 临界段的使用</h1>\n<p>在 FreeRTOS 中，临界段一般是指宏  <code>taskENTER_CRITICAL()</code>  与  <code>taskEXIT_CRITICAL()</code>  之间的代码区间，而在中断中则是  <code>taskENTER_CRITICAL_FROM_ISR()</code>  和  <code>taskEXIT_CRITICAL_FROM_ISR()</code>  之间。</p>\n<p>例如，在 <a href=\"https://arachnid.cc/docs/RTOS/FreeRTOS%20%E7%AF%87%E7%AB%A0%E4%B9%8B%E4%BA%8C%E5%80%BC%E4%BF%A1%E5%8F%B7%E9%87%8F/\">FreeRTOS 篇章之二值信号量</a> 中的  <code>USART1_IRQHandler(void)</code>  中断函数中，我们可以加入临界区操作，变成：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/************************************************************************/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">/*            STM32F10x USART Interrupt Handlers                        */</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">/************************************************************************/</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  * @brief  This function handles USART1 global interrupt request.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  * @param  None</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  * @retval None</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  */</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">USART1_IRQHandler</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token class-name\">uint32_t</span> ulReturn<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    BaseType_t xHigherPriorityTaskWoken <span class=\"token operator\">=</span> pdFALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token comment\">/* 为了保证在对 DMA 数据进行处理不被打断，将此操作放入临界区 */</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    ulReturn <span class=\"token operator\">=</span> <span class=\"token function\">taskENTER_CRITICAL_FROM_ISR</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// 进入临界段，可以嵌套</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token comment\">/* 在 taskENTER_CRITICAL_FROM_ISR () 与 taskEXIT_CRITICAL_FROM_ISR () 之间或</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>       在 taskENTER_CRITICAL () 与 taskEXIT_CRITICAL () 之间并不会切换到其它任务，</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>       同时，在 configKERNEL_INTERRUPT_PRIORITY 至 configMAX_SYSCAL_INTERRUPT_PRIORITY 之间</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>       的中断将会被关掉，但对于优先级高于 configMAX_SYSCALL_INTERRUPT_PRIORITY 的中断</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>       并没有关掉，而且这些中断不允许访问 FreeRTOS API 函数. */</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">USART_GetITStatus</span><span class=\"token punctuation\">(</span>EVAL_COM1<span class=\"token punctuation\">,</span> USART_IT_IDLE<span class=\"token punctuation\">)</span><span class=\"token operator\">!=</span>RESET<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span>\t\t</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token function\">DMA_Cmd</span><span class=\"token punctuation\">(</span>USART1_RX_DMA_CHANNEL<span class=\"token punctuation\">,</span> DISABLE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token function\">DMA_ClearFlag</span><span class=\"token punctuation\">(</span>DMA1_FLAG_TC5<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        Usart1<span class=\"token punctuation\">.</span>RxCounter <span class=\"token operator\">=</span> RxBUFFER_SIZE <span class=\"token operator\">-</span> <span class=\"token function\">DMA_GetCurrDataCounter</span><span class=\"token punctuation\">(</span>USART1_RX_DMA_CHANNEL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        USART1_RX_DMA_CHANNEL<span class=\"token operator\">-></span>CNDTR <span class=\"token operator\">=</span> RxBUFFER_SIZE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token function\">DMA_Cmd</span><span class=\"token punctuation\">(</span>USART1_RX_DMA_CHANNEL<span class=\"token punctuation\">,</span> ENABLE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t\t\t</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token function\">xSemaphoreGiveFromISR</span><span class=\"token punctuation\">(</span>xBinarySemaphore<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>xHigherPriorityTaskWoken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token function\">portEND_SWITCHING_ISR</span><span class=\"token punctuation\">(</span>xHigherPriorityTaskWoken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token function\">USART_ReceiveData</span><span class=\"token punctuation\">(</span>EVAL_COM1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t\t\t<span class=\"token comment\">// Clear IDLE interrupt flag bit</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token comment\">/* 退出临界段 */</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token function\">taskEXIT_CRITICAL_FROM_ISR</span><span class=\"token punctuation\">(</span> ulReturn <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token comment\">//  if(USART_GetITStatus(EVAL_COM1, USART_IT_TXE) != RESET)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token comment\">//  &#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token comment\">//    /* Write one byte to the transmit data register */</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token comment\">//    USART_SendData(EVAL_COM1, TxBuffer[TxCounter++]);</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token comment\">//    if(TxCounter == RxBUFFER_SIZE)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token comment\">//    &#123;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token comment\">//      /* Disable the EVAL_COM1 Transmit interrupt */</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token comment\">//      USART_ITConfig(EVAL_COM1, USART_IT_TXE, DISABLE);</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token comment\">//    &#125;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token comment\">//  &#125;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"用挂起调度器来创建临界区\"><a class=\"anchor\" href=\"#用挂起调度器来创建临界区\">#</a> 用挂起调度器来创建临界区</h1>\n<p>调度器总是在所有处于就绪态的任务中选择具有最高优先级的任务来执行的（这就是 FreeRTOS 的优先级调度算法）。</p>\n<p>因此创建临界区也可以通过挂起调度器来实现；挂起调度器有些时候也被称为锁定调度器。</p>\n<p>临界段保护一段代码区间不被其它任务或中断打断（此处的中断是指归 FreeRTOS 管理的中断）。通过挂起调度器实现的临界区只可以保护一段代码区间不被其它任务打断，因为这种方式下，中断是使能的（此处的中断是指所有的中断，包含归 FreeRTOS 管理的中断）。<br />\n如果一个临界区太长而不适合简单地关中断来实现，可以考虑采用挂起调度器的方式；但是唤醒（resuming, or un-suspending）调度器却是一个相对较长的操作，所以评估哪种是最佳方式需要结合实际情况。</p>\n<p>利用  <code>vTaskSuspendAll();</code>  把调度器挂起，这样可以停止上下文切换而没有关中断；如果某个中断在调度器挂起过程中要求进行上下文切换，则个这请求也会被挂起，直到调度器被唤醒后才会得到执行（即调用  <code>xTaskResumeAll();</code>  恢复调度器）。</p>\n<p>注意：在调度器处于挂起状态时（即  <code>vTaskSuspendAll();</code>  至  <code>xTaskResumeAll();</code>  之间），不能调用 FreeRTOS API 函数。</p>\n<p><strong>1、vTaskSuspend () API 函数</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">vTaskSuspend</span><span class=\"token punctuation\">(</span> TaskHandle_t  xTaskToSuspend <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>输入参数：</p>\n<ul>\n<li>需要挂起的某个任务的句柄，这个句柄是创建任务时所引用出来的；当传递空值句柄时，将导致当前调用任务暂停；当任务暂停时，将永远无法获得任何微控制器的处理时间，无论其优先级如何。</li>\n</ul>\n<p><strong>2、vTaskResume () API 函数</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">vTaskResume</span><span class=\"token punctuation\">(</span> TaskHandle_t  xTaskToResume <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>输入参数：</p>\n<ul>\n<li>需要恢复成就绪状态的任务的句柄</li>\n</ul>\n<p><strong>3、xTaskResumeFromISR () API 函数</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>BaseType_t  <span class=\"token function\">xTaskResumeFromISR</span><span class=\"token punctuation\">(</span> TaskHandle_t  xTaskToResume <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>输入参数：</p>\n<ul>\n<li>需要恢复成就绪状态的任务的句柄。</li>\n</ul>\n<p>返回参数：</p>\n<ul>\n<li>如果恢复任务，则为  <code>pdTRUE</code>  ，否则为  <code>pdFALSE</code>  。ISR 使用它来确定是否需要在 ISR 之后进行上下文切换。</li>\n</ul>\n<p><strong>4、vTaskSuspendAll () API 函数</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">vTaskSuspendAll</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>说明：挂起调度器而不禁用中断。当调度器挂起时，上下文切换将不会发生。在调用  <code>vTaskSuspendAll()</code>  之后，调用任务将继续执行；在调用  <code>xTaskResumeAll()</code>  之前，不会有被切换出去的风险，直到对  <code>xTaskResumeAll()</code>  的调用完成。当调度器被挂起时，不能调用可能导致上下文切换的 API 函数（例如，  <code>vTaskDelayUntil()</code>  、  <code>xQueueSend()</code>  等）。</p>\n<p><strong>5、xTaskResumeAll () API 函数</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>BaseType_t  <span class=\"token function\">xTaskResumeAll</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>返回参数：</p>\n<ul>\n<li>在调度器挂起过程中，上下文切换请求也会被挂起，直到调度器被唤醒后才会得到执行。如果一个挂起的上下文切换请求在  <code>xTaskResumeAll()</code>  返回前得到执行，则函数返回  <code>pdTRUE</code>  。在其它情况下， <code>xTaskResumeAll()</code>  返回  <code>pdFALSE</code>  。</li>\n</ul>\n<p>说明：在调用  <code>vTaskSuspendAll()</code>  挂起调度程序活动后，恢复该活动。 <code>xTaskResumeAll()</code>  只恢复调度程序。它不会解除先前通过调用  <code>vTaskSuspend()</code>  挂起的任务。</p>\n<p>嵌套调用  <code>vTaskSuspendAll()</code>  和  <code>xTaskResumeAll()</code>  是安全的，因为内核有维护一个嵌套深度计数。调度器只会在嵌套深度计数为 0 时才会被唤醒 —— 即在为每个之前调用的  <code>vTaskSuspendAll()</code>  都配套调用了  <code>xTaskResumAll()</code>  之后</p>\n<h1 id=\"与调度器相关的-api\"><a class=\"anchor\" href=\"#与调度器相关的-api\">#</a> 与调度器相关的 API</h1>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">功能</th>\n<th style=\"text-align:left\">API 函数</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">启动调度器</td>\n<td style=\"text-align:left\">vTaskStartScheduler()</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">停止调度器</td>\n<td style=\"text-align:left\">vTaskEndScheduler()</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">挂起某个任务</td>\n<td style=\"text-align:left\">vTaskSuspend()</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">恢复某个任务</td>\n<td style=\"text-align:left\">vTaskResume()</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">恢复某个任务（用于中断）</td>\n<td style=\"text-align:left\">xTaskResumeFromISR()</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">挂起所有调度器</td>\n<td style=\"text-align:left\">vTaskSuspendAll()</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">恢复所有调度器</td>\n<td style=\"text-align:left\">xTaskResumeAll()</td>\n</tr>\n</tbody>\n</table>\n",
            "tags": [
                "history",
                "FreeRTOS",
                "RTOS"
            ]
        },
        {
            "id": "https://arachnid.cc/freertos-mutex-semaphore/",
            "url": "https://arachnid.cc/freertos-mutex-semaphore/",
            "title": "FreeRTOS 篇章之互斥量",
            "date_published": "2020-02-25T07:06:37.000Z",
            "content_html": "<h1 id=\"与二值量区别及应用\"><a class=\"anchor\" href=\"#与二值量区别及应用\">#</a> 与二值量区别及应用</h1>\n<p>互斥量是一种特殊的二值信号量，用于控制在两个或多个任务间访问共享资源。</p>\n<p>访问一个被多任务共享，或是被任务与中断共享的资源时，需要采用 “互斥” 技术以保证数据在任何时候都保持一致性。这样做的目的是要确保任务从开始访问资源就具有排它性，直至这个资源又恢复到完整状态。</p>\n<p>在用于互斥的场合，互斥量从概念上可看作是与共享资源关联的令牌。一个任务想要合法地访问资源，其必须先成功地得到（Take）该资源对应的令牌（成为令牌持有者）。当令牌持有者完成资源使用，其最好马上归还（Give）令牌，因为只有归还了令牌，其它任务才可能成功持有，也才可能安全地访问该共享资源。一个任务除非持有了令牌，否则不允许访问共享资源。</p>\n<p>它的特性场景：</p>\n<p><img src=\"2020022418230370.gif\" alt=\"img\" /></p>\n<p>这种机制纯粹是工作于应用程序作者制定的规则之下。任务不是在任何时候都可以访问资源是不需要理由的，因为这是所有任务达成的一致，除非它们能成为互斥量的持有者。</p>\n<p>可以对比一下上一篇 <a href=\"https://arachnid.cc/freertos-binary-semaphore/\">FreeRTOS 篇章之二值信号量</a> 的特性图。</p>\n<p>虽然互斥量与二值信号量之间具有很多相同的特性，但两者间最大的区别在于信号量在被获得之后所发生的事情：</p>\n<ul>\n<li>用于互斥的信号量需要归还。</li>\n<li>用于同步的信号量通常是完成同步之后便丢弃，不用归还。</li>\n</ul>\n<p>值得注意的是，互斥量不能在中断中使用：</p>\n<ul>\n<li>互斥量的优先级继承属性意味着只能在任务间使用</li>\n<li>中断在等待一个互斥量保护的资源的时候，不能阻塞</li>\n</ul>\n<h1 id=\"优先级反转\"><a class=\"anchor\" href=\"#优先级反转\">#</a> 优先级反转</h1>\n<p>假设我们创建了两个任务，任务一跟任务二，任务二的优先级高于任务一的优先级，同时还创建了一个互斥量；当运行的时候，任务一获取了这个互斥量（成为令牌持有者），紧接着任务二也需要这个互斥量来共享资源（此时任务一并没有执行完成，释放互斥量），对于正常情况向下，高优先级任务的可以打断低优先任务，但是，由于互斥量的特性（只有归还了令牌，其它任务才可能成功持有，否则不允许访问共享资源，进入阻塞等待令牌归还），高优先级的任务二竟然必须等待低优先级的任务一放弃对互斥量的持有权。因此，高优先级任务被低优先级任务阻塞推迟的行为被称为 “优先级反转” 。</p>\n<p>如果把这种行为再进一步放大，当高优先级任务正等待信号量的时候，一个介于两个任务优先之间的中等优先级任务开始执行 —— 这就会导致一个高优先级任务在等待一个低优先级任务，而低优先级任务却无法执行！</p>\n<p>如下图：</p>\n<p><img src=\"20200225112317242.png\" alt=\"img\" /></p>\n<h1 id=\"优先级继承\"><a class=\"anchor\" href=\"#优先级继承\">#</a> 优先级继承</h1>\n<p>FreeRTOS 中互斥量与二值信号量十分相似 —— 唯一的区别就是互斥量自动提供了一个基本的 ” 优先级继承” 机制。</p>\n<p>优先级继承是最小化优先级反转负面影响的一种方案 —— 其并不能修正优先级反转带来的问题，仅仅是减小优先级反转的影响。优先级继承使得系统行为的数学分析更为复杂，所以如果可以避免的话，并不建议系统实现对优先级继承有所依赖。</p>\n<p>优先级继承暂时地将互斥量持有者的优先级提升至所有等待此互斥量的任务所具有的最高优先级；持有互斥量的低优先级任务 “继承” 了等待互斥量的任务的优先级；互斥量持有者在归还互斥量时，优先级会自动设置为其原来的优先级。</p>\n<p>优先级继承最小化优先级反转的影响：</p>\n<p><img src=\"20200225112349522.png\" alt=\"img\" /></p>\n<h1 id=\"死锁\"><a class=\"anchor\" href=\"#死锁\">#</a> 死锁</h1>\n<p>死锁是利用互斥量提供互斥功能的另一个潜在缺陷。Deadlock 有时候会被更戏剧性地称为 “deadly embrace（抱死）”。</p>\n<p>当两个任务都在等待被对方持有的资源时，两个任务都无法再继续执行，这种情况就被称为死锁。考虑如下情形，任务 A 与任务 B 都需要获得互斥量 X 与互斥量 Y 以完成各自的工作：</p>\n<ol>\n<li>任务 A 执行，并成功获得了互斥量 X。</li>\n<li>任务 A 被任务 B 抢占。</li>\n<li>任务 B 成功获得了互斥量 Y，之后又试图获取互斥量 X —— 但互斥量 X 已经被任务 A 持有，所以对任务 B 无效。任务 B 选择进入阻塞态以等待互斥量 X 被释放。</li>\n<li>任务 A 得以继续执行。其试图获取互斥量 Y —— 但互斥量 Y 已经被任务 B 持有而对任务 A 无效。任务 A 也选择进入阻塞态以等待互斥量 Y 被释放。</li>\n</ol>\n<p>这种情形的最终结局是，任务 A 在等待一个被任务 B 持有的互斥量，而任务 B 也在等待一个被任务 A 持有的互斥量。死锁于是发生，因为两个任务都不可能再执行下去了。</p>\n<p>和优先级反转一样，避免死锁的最好方法就是在设计阶段就考虑到这种潜在风险，这样设计出来的系统就不应该会出现死锁的情况。于实践经验而言，对于一个小型嵌入式系统，死锁并不是一个大问题，因为系统设计者对整个应用程序都非常清楚，所以能够找出发生死锁的代码区域，并消除死锁问题。</p>\n<h1 id=\"api函数\"><a class=\"anchor\" href=\"#api函数\">#</a> API 函数</h1>\n<p>需要  <code>#include &quot;semphr.h&quot;</code></p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">功能</th>\n<th style=\"text-align:left\">API 接口</th>\n<th style=\"text-align:left\">实际执行函数</th>\n<th style=\"text-align:left\">其它</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">互斥量创建（动态）</td>\n<td style=\"text-align:left\">xSemaphoreCreateMutex()</td>\n<td style=\"text-align:left\">xQueueCreateMutex()</td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">互斥量获取</td>\n<td style=\"text-align:left\">xSemaphoreTake()</td>\n<td style=\"text-align:left\">xQueueGenericReceive()</td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">互斥量释放</td>\n<td style=\"text-align:left\">xSemaphoreGive()</td>\n<td style=\"text-align:left\">xQueueGenericSend()</td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">互斥量创建（静态）</td>\n<td style=\"text-align:left\">xSemaphoreCreateMutexStatic()</td>\n<td style=\"text-align:left\">xQueueCreateMutexStatic()</td>\n<td style=\"text-align:left\"></td>\n</tr>\n</tbody>\n</table>\n<p><strong>1、xSemaphoreCreateMutex () API 函数</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>SemaphoreHandle_t  <span class=\"token function\">xSemaphoreCreateMutex</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>返回参数：</p>\n<ul>\n<li><strong>NULL</strong>：表示互斥量创建失败。原因是内存堆空间不足导致 FreeRTOS 无法为互斥量分配结构数据空间。</li>\n<li><strong>非 NULL</strong>：值表示互斥量创建成功。返回值应当保存起来作为该互斥量的句柄。</li>\n</ul>\n<p><strong>2、xSemaphoreTake () API 函数</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>BaseType_t  <span class=\"token function\">xSemaphoreTake</span><span class=\"token punctuation\">(</span> SemaphoreHandle_t  xSemaphore<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                            TickType_t         xBlockTime <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>传入参数：</p>\n<ul>\n<li><strong>xSemaphore</strong>：获取得到的信号量。信号量由定义为 xSemaphoreHandle 类型的变量引用；信号量在使用前必须先创建</li>\n<li><strong>xTicksToWait</strong>：阻塞超时时间。任务进入阻塞态以等待信号量有效的最长时间。如果  <code>xTicksToWait</code>  为  <code>0</code>  ，则  <code>xSemaphoreTake()</code>  在信号量无效时会立即返回；如果把  <code>xTicksToWait</code>  设置为  <code>portMAX_DELAY</code>  ，那么阻塞等待将没有超时限制。</li>\n</ul>\n<p>返回参数（有两个可能的返回值）：</p>\n<ul>\n<li><strong>pdTRUE</strong>：成功获得信号量。</li>\n<li><strong>pdFALSE</strong>：未能获得信号量。</li>\n</ul>\n<p><strong>3、xSemaphoreGive () API 函数</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>BaseType_t  <span class=\"token function\">xSemaphoreGive</span><span class=\"token punctuation\">(</span> SemaphoreHandle_t  xSemaphore <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>传入参数：</p>\n<ul>\n<li><strong>xSemaphore</strong>：给出的信号量。信号量由定义为  <code>xSemaphoreHandle</code>  类型的变量引用；信号量在使用前必须先创建。</li>\n</ul>\n<p>返回参数（有两个可能的返回值）：</p>\n<ul>\n<li><strong>pdTRUE</strong>：信号量被释放。</li>\n<li><strong>pdFALSE</strong>：信号量已经有效，无法给出。</li>\n</ul>\n<p><strong>4、xSemaphoreCreateMutexStatic () API 函数</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>SemaphoreHandle_t  <span class=\"token function\">xSemaphoreCreateMutexStatic</span><span class=\"token punctuation\">(</span> StaticSemaphore_t  <span class=\"token operator\">*</span>pxMutexBuffer <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>该函数是用于在静态的时候，利用该函数创建一个互斥量的，具体可以去看他的注释，这里就不说了。</p>\n<p>值得注意的是：当用  <code>xSemaphoreCreateMutexStatic</code>  创建一个静态互斥量后，该互斥量量是默认 “Give” 给出去了的，所以在  <code>xSemaphoreCreateMutexStatic</code>  创建后没有立即调用  <code>xSemaphoreTake</code>  ，那么，它将通过你的第一次阻塞处理。</p>\n<h1 id=\"其他\"><a class=\"anchor\" href=\"#其他\">#</a> 其他</h1>\n<p>这里就不放整个例程了，跟 <a href=\"https://arachnid.cc/freertos-queue/\">FreeRTOS 篇章之队列管理</a> 中差不多，只不过用互斥量来处理；像我们常用的多线程 printf 输出会出现乱码现象，可以如以下处理：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">extern</span> SemaphoreHandle_t MuxSem_UartPrintf<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">USER_DEBUG</span>\t\t\t\t<span class=\"token expression\"><span class=\"token number\">1</span></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">DEBUG_PRINTF</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>fmt<span class=\"token punctuation\">,</span>arg<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span>\t\t\t<span class=\"token keyword\">do</span><span class=\"token punctuation\">&#123;</span></span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\t\t\t\t\t\t\t\t\t\t<span class=\"token expression\"><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>USER_DEBUG<span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\t\t\t\t\t\t\t\t\t\t\t<span class=\"token expression\"><span class=\"token function\">xSemaphoreTake</span><span class=\"token punctuation\">(</span>MuxSem_UartPrintf<span class=\"token punctuation\">,</span> portMAX_DELAY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t\t\t\t\t\t\t\t\t\t\t<span class=\"token expression\"><span class=\"token function\">printf</span><span class=\"token punctuation\">(</span></span><span class=\"token string\">\"&lt;&lt;-DEBUG INFO->> %s > \"</span><span class=\"token expression\">fmt</span><span class=\"token string\">\"\"</span><span class=\"token expression\"><span class=\"token punctuation\">,</span>__FUNCTION__<span class=\"token punctuation\">,</span> </span><span class=\"token punctuation\">##</span><span class=\"token expression\">arg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t\t\t\t\t\t\t\t\t\t\t<span class=\"token expression\"><span class=\"token function\">xSemaphoreGive</span><span class=\"token punctuation\">(</span>MuxSem_UartPrintf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t\t\t\t\t\t\t\t\t\t<span class=\"token expression\"><span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></span></span></pre></td></tr></table></figure><p>然后，我们只需要在硬件初始化化的创建好互斥量，后面就可以用  <code>DEBUG_PRINTF</code>  宏来打印无乱码现象的数据输出了，而且还可以通过 USER_DEBUG 宏来选择时候显示调试信息。</p>\n<p>前面也都说了，为了避免在 RTOS 中多个任务同时访问公用数据共享资源（或者同一硬件），因此，当有一个任务在访问处理共享资源时，其他的任务要停止对共享资源的访问，以避免出现数据访问（或处理）出错，所以可以用互斥量来处理这些问题；当然在使用互斥量的时候要注意上面所说的那一些缺陷。</p>\n<p>最后，说一下递归互斥量：</p>\n<p>递归互斥量（  <code>Recursive Mutexes</code>  ）是互斥量的一个特例，与互斥量基本相同；除了：递归互斥量可以由拥有者多次获取，但是也要求拥有者释放相同次数。比如，一个递归互斥量被获取了 5 次，那么同样需要释放 5 次。</p>\n",
            "tags": [
                "history",
                "FreeRTOS",
                "RTOS"
            ]
        },
        {
            "id": "https://arachnid.cc/freertos-binary-semaphore/",
            "url": "https://arachnid.cc/freertos-binary-semaphore/",
            "title": "FreeRTOS 篇章之二值信号量",
            "date_published": "2020-02-23T03:57:35.000Z",
            "content_html": "<h1 id=\"采用二值信号量同步\"><a class=\"anchor\" href=\"#采用二值信号量同步\">#</a> 采用二值信号量同步</h1>\n<p>二值信号量可以在某个特殊的中断发生时，让任务解除阻塞，相当于让任务与中断同步。这样就可以让中断事件处理量大的工作在同步任务中完成，中断服务例程 (ISR) 中只是快速处理少部份工作。</p>\n<p>如果某个中断处理要求特别紧急，其延迟处理任务的优先级可以设为最高，以保证延迟处理任务随时都抢占系统中的其它任务。</p>\n<p>在这种中断同步的情形下，信号量可以看作是一个深度为 1 的队列。这个队列由于最多只能保存一个数据单元，所以其非空则满（所谓 “二值” 即二进制，只有 0 / 1）。延迟处理任务调用  <code>xSemaphoreTake()</code>  时，等效于带阻塞时间地读取队列，如果队列为空的话任务则进入阻塞态。当事件发生后，ISR 简单地通过调用  <code>xSemaphoreGiveFromISR()</code>  放置一个令牌（信号量）到队列中，使得队列成为满状态。这也使得延迟处理任务切出阻塞态，并移除令牌，使得队列再次成为空。</p>\n<p>其演示过程：</p>\n<p><img src=\"20200220173730247.gif\" alt=\"img\" /></p>\n<h1 id=\"api-函数\"><a class=\"anchor\" href=\"#api-函数\">#</a> API 函数</h1>\n<p>要想调用以下函数，需要  <code>#include &quot;semphr.h&quot;</code></p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">功能</th>\n<th style=\"text-align:left\">API 接口</th>\n<th style=\"text-align:left\">实际执行函数</th>\n<th style=\"text-align:left\">其它</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">二值信号量创建（动态）</td>\n<td style=\"text-align:left\">vSemaphoreCreateBinary()</td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">弃用</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">二值信号量创建（动态）</td>\n<td style=\"text-align:left\">xSemaphoreCreateBinary()</td>\n<td style=\"text-align:left\">xQueueGenericCreate()</td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">二值信号量获取</td>\n<td style=\"text-align:left\">xSemaphoreTake()</td>\n<td style=\"text-align:left\">xQueueGenericReceive()</td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">二值信号量释放</td>\n<td style=\"text-align:left\">xSemaphoreGive()</td>\n<td style=\"text-align:left\">xQueueGenericSend()</td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">二值信号量获取（用于中断中）</td>\n<td style=\"text-align:left\">xSemaphoreTakeFromISR()</td>\n<td style=\"text-align:left\">xQueueReceiveFromISR()</td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">二值信号量释放（用于中断中）</td>\n<td style=\"text-align:left\">xSemaphoreGiveFromISR()</td>\n<td style=\"text-align:left\">xQueueGiveFromISR()</td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">二值信号量创建（静态）</td>\n<td style=\"text-align:left\">xSemaphoreCreateBinaryStatic()</td>\n<td style=\"text-align:left\">xQueueGenericCreateStatic()</td>\n<td style=\"text-align:left\"></td>\n</tr>\n</tbody>\n</table>\n<p><strong>1、vSemaphoreCreateBinary () API 函数（弃用）</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">vSemaphoreCreateBinary</span><span class=\"token punctuation\">(</span> xSemaphore <span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>传入参数：</p>\n<ul>\n<li><strong>xSemaphore</strong>：创建的二值信号量</li>\n</ul>\n<p>需要说明的是  <code>vSemaphoreCreateBinary()</code>  在实现上是一个宏，所以信号量变量应当直接传入，而不是传址。</p>\n<p>注意：在新的版本中一般是通过  <code>xSemaphoreCreateBinary(void)</code>  函数返回一个  <code>SemaphoreHandle_t</code>  值，并以此创建一个二值信号量。</p>\n<p><strong>2、SemaphoreHandle_t xSemaphoreCreateBinary () API 函数</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">xSemaphoreCreateBinary</span><span class=\"token expression\"><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token function\">xQueueGenericCreate</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> UBaseType_t <span class=\"token punctuation\">)</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> semSEMAPHORE_QUEUE_ITEM_LENGTH<span class=\"token punctuation\">,</span> queueQUEUE_TYPE_BINARY_SEMAPHORE <span class=\"token punctuation\">)</span></span></span></pre></td></tr></table></figure><p>返回参数：</p>\n<ul>\n<li><strong>SemaphoreHandle_t</strong>：创建的二值信号量</li>\n</ul>\n<p>为什么放弃  <code>vSemaphoreCreateBinary()</code>  函数以及它们之间的区别我们可以看一下它的注释：</p>\n<pre><code>/* \n  This old vSemaphoreCreateBinary() macro is now deprecated in favour of \n  the xSemaphoreCreateBinary() function. Note that binary semaphores created using \n  the vSemaphoreCreateBinary() macro are created in a state such \n  that the first call to 'take' the semaphore would pass, \n  whereas binary semaphores created using xSemaphoreCreateBinary() are created \n  in a state such that the the semaphore must first be 'given' before it can be 'taken'.\n*/\n</code></pre>\n<p><strong>3、xSemaphoreTake () API 函数</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>BaseType_t  <span class=\"token function\">xSemaphoreTake</span><span class=\"token punctuation\">(</span> SemaphoreHandle_t  xSemaphore<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                            TickType_t         xBlockTime <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>传入参数：</p>\n<ul>\n<li><strong>xSemaphore</strong>：获取得到的信号量。信号量由定义为  <code>xSemaphoreHandle</code>  类型的变量引用；信号量在使用前必须先创建。</li>\n<li><strong>xTicksToWait</strong>：阻塞超时时间。任务进入阻塞态以等待信号量有效的最长时间。如果  <code>xTicksToWait</code>  为  <code>0</code>  ，则  <code>xSemaphoreTake()</code>  在信号量无效时会立即返回；如果把  <code>xTicksToWait</code>  设置为  <code>portMAX_DELAY</code>  ，那么阻塞等待将没有超时限制。</li>\n</ul>\n<p>返回参数（有两个可能的返回值）：</p>\n<ul>\n<li><strong>pdTRUE</strong>：成功获得信号量。</li>\n<li><strong>pdFALSE</strong>：未能获得信号量。</li>\n</ul>\n<p><strong>4、xSemaphoreGive () API 函数</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>BaseType_t  <span class=\"token function\">xSemaphoreGive</span><span class=\"token punctuation\">(</span> SemaphoreHandle_t  xSemaphore <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>传入参数：</p>\n<ul>\n<li><strong>xSemaphore</strong>：给出的信号量。信号量由定义为  <code>xSemaphoreHandle</code>  类型的变量引用；信号量在使用前必须先创建。</li>\n</ul>\n<p>返回参数（有两个可能的返回值）：</p>\n<ul>\n<li><strong>pdTRUE</strong>：信号量被释放。</li>\n<li><strong>pdFALSE</strong>：信号量已经有效，无法给出。</li>\n</ul>\n<p><strong>5、xSemaphoreTakeFromISR () API 函数</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>BaseType_t  <span class=\"token function\">xSemaphoreTakeFromISR</span><span class=\"token punctuation\">(</span> SemaphoreHandle_t  xSemaphore<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                                   BaseType_t         <span class=\"token operator\">*</span>pxHigherPriorityTaskWoken <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>传入参数：</p>\n<ul>\n<li><strong>xSemaphore</strong>：给出的信号量。信号量由定义为  <code>xSemaphoreHandle</code>  类型的变量引用；信号量在使用前必须先创建。</li>\n<li><strong>pxHigherPriorityTaskWoken</strong>：如果获取该信号量导致一个任务解除阻塞，并且被解除阻塞的任务的优先级高于当前运行的任务，那么  <code>xSemaphoreTakeFromISR()</code>  将把  <code>*pxHigherPriorityTaskWoken</code>  设置为  <code>pdTRUE</code>  。如果  <code>xSemaphoreTakeFromISR()</code>  将该值设置为  <code>pdTRUE</code>  ，则应该在退出中断之前请求上下文切换。</li>\n</ul>\n<p>返回参数（有两个可能的返回值）：</p>\n<ul>\n<li><strong>pdTRUE</strong>：  <code>xSemaphoreTakeFromISR()</code>  调用成功。</li>\n<li><strong>pdFALSE</strong>：信号量释放失败。</li>\n</ul>\n<p><strong>6、xSemaphoreGiveFromISR () API 函数</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>BaseType_t  <span class=\"token function\">xSemaphoreGiveFromISR</span><span class=\"token punctuation\">(</span> SemaphoreHandle_t  xSemaphore<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                                   BaseType_t         <span class=\"token operator\">*</span>pxHigherPriorityTaskWoken <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>传入参数：</p>\n<ul>\n<li><strong>xSemaphore</strong>：给出的信号量。信号量由定义为  <code>xSemaphoreHandle</code>  类型的变量引用；信号量在使用前必须先创建。</li>\n<li><strong>pxHigherPriorityTaskWoken</strong>：如果调用  <code>xSemaphoreGiveFromISR()</code>  使得一个任务解除阻塞，并且这个任务的优先级高于当前任务（也就是被中断的任务），那么  <code>xSemaphoreGiveFromISR()</code>  会在函数内部将  <code>*pxHigherPriorityTaskWoken</code>  设为  <code>pdTRUE</code>  。如果  <code>xSemaphoreGiveFromISR()</code>  将此值设为  <code>pdTRUE</code>  ，则在中断退出前应当进行一次上下文切换。</li>\n</ul>\n<p>返回参数（有两个可能的返回值）：</p>\n<ul>\n<li><strong>pdTRUE</strong>：  <code>xSemaphoreGiveFromISR()</code>  调用成功。</li>\n<li><strong>errQUEUE_FULL</strong>：信号量已经有效，无法给出。</li>\n</ul>\n<p><strong>7、xSemaphoreCreateBinaryStatic () API 函数</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>SemaphoreHandle_t  <span class=\"token function\">xSemaphoreCreateBinaryStatic</span><span class=\"token punctuation\">(</span> StaticSemaphore_t  <span class=\"token operator\">*</span>pxSemaphoreBuffer <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>该函数是用于在静态的时候，利用该函数创建一个二值信号量的，具体可以去看他的注释，这里就不说了。</p>\n<h1 id=\"演示例程\"><a class=\"anchor\" href=\"#演示例程\">#</a> 演示例程</h1>\n<p>二值信号量多用于 1v1 这种情况，因为它只有两个值（0 / 1），非空则满，有点类似于在非 RTOS 中定义的标志位；由于可以在任务与中断同步，并且存在超时机制，那本次例程就可以把它应用到串口 DMA 接收中。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"><span>main.c</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    FreeRTOS V9.0.0 - Copyright (C) 2016 Real Time Engineers Ltd.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    All rights reserved</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    VISIT http://www.FreeRTOS.org TO ENSURE YOU ARE USING THE LATEST VERSION.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    This file is part of the FreeRTOS distribution.</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    FreeRTOS is free software; you can redistribute it and/or modify it under</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    the terms of the GNU General Public License (version 2) as published by the</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    Free Software Foundation >>>> AND MODIFIED BY &lt;&lt;&lt;&lt; the FreeRTOS exception.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    ***************************************************************************</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    >>!   NOTE: The modification to the GPL is included to allow you to     !&lt;&lt;</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    >>!   distribute a combined work that includes FreeRTOS without being   !&lt;&lt;</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    >>!   obliged to provide the source code for proprietary components     !&lt;&lt;</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    >>!   outside of the FreeRTOS kernel.                                   !&lt;&lt;</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    ***************************************************************************</pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    FreeRTOS is distributed in the hope that it will be useful, but WITHOUT ANY</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    FOR A PARTICULAR PURPOSE.  Full license text is available on the following</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    link: http://www.freertos.org/a00114.html</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    ***************************************************************************</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>     *                                                                       *</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>     *    FreeRTOS provides completely free yet professionally developed,    *</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>     *    robust, strictly quality controlled, supported, and cross          *</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>     *    platform software that is more than just the market leader, it     *</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>     *    is the industry's de facto standard.                               *</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>     *                                                                       *</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>     *    Help yourself get started quickly while simultaneously helping     *</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>     *    to support the FreeRTOS project by purchasing a FreeRTOS           *</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>     *    tutorial book, reference manual, or both:                          *</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>     *    http://www.FreeRTOS.org/Documentation                              *</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>     *                                                                       *</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    ***************************************************************************</pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    http://www.FreeRTOS.org/FAQHelp.html - Having a problem?  Start by reading</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    the FAQ page \"My application does not run, what could be wrong?\".  Have you</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    defined configASSERT()?</pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    http://www.FreeRTOS.org/support - In return for receiving this top quality</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    embedded software for free we request you assist our global community by</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    participating in the support forum.</pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    http://www.FreeRTOS.org/training - Investing in training allows your team to</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    be as productive as possible as early as possible.  Now you can receive</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    FreeRTOS training directly from Richard Barry, CEO of Real Time Engineers</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    Ltd, and the world's leading authority on the world's leading RTOS.</pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    http://www.FreeRTOS.org/plus - A selection of FreeRTOS ecosystem products,</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    including FreeRTOS+Trace - an indispensable productivity tool, a DOS</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    compatible FAT file system, and our tiny thread aware UDP/IP stack.</pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    http://www.FreeRTOS.org/labs - Where new FreeRTOS products go to incubate.</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    Come and try FreeRTOS+TCP, our new open source TCP/IP stack for FreeRTOS.</pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    http://www.OpenRTOS.com - Real Time Engineers ltd. license FreeRTOS to High</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    Integrity Systems ltd. to sell under the OpenRTOS brand.  Low cost OpenRTOS</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    licenses offer ticketed support, indemnification and commercial middleware.</pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    http://www.SafeRTOS.com - High Integrity Systems also provide a safety</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    engineered and independently SIL3 certified version for use in safety and</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    mission critical applications that require provable dependability.</pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    1 tab == 4 spaces!</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>*/</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre></pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre><span class=\"token comment\">/* Standard includes. */</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;string.h></span></span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre></pre></td></tr><tr><td data-num=\"75\"></td><td><pre><span class=\"token comment\">/* Scheduler includes. */</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"FreeRTOS.h\"</span></span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"task.h\"</span></span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"queue.h\"</span></span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"semphr.h\"</span>        <span class=\"token comment\">// 信号量相关的头文件</span></span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre></pre></td></tr><tr><td data-num=\"81\"></td><td><pre><span class=\"token comment\">/* Library includes. */</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"stm32f10x_it.h\"</span></span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre></pre></td></tr><tr><td data-num=\"84\"></td><td><pre><span class=\"token comment\">/* Private app includes. */</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"bsp_uart.h\"</span></span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"bsp_gpio.h\"</span></span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre></pre></td></tr><tr><td data-num=\"88\"></td><td><pre></pre></td></tr><tr><td data-num=\"89\"></td><td><pre><span class=\"token comment\">/* Task priorities. */</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">mainCREATOR_TASK_PRIORITY</span>           <span class=\"token expression\"><span class=\"token punctuation\">(</span> tskIDLE_PRIORITY <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre></pre></td></tr><tr><td data-num=\"92\"></td><td><pre><span class=\"token comment\">/*----------------------------- End -----------------------------*/</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre></pre></td></tr><tr><td data-num=\"94\"></td><td><pre><span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"95\"></td><td><pre> * User Private Task.</pre></td></tr><tr><td data-num=\"96\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">prvUser_Task</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>pvParameters <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre></pre></td></tr><tr><td data-num=\"99\"></td><td><pre><span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"100\"></td><td><pre> * Configure the clocks, GPIO and other peripherals as required by the demo.</pre></td></tr><tr><td data-num=\"101\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">prvSetupHardware</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre></pre></td></tr><tr><td data-num=\"104\"></td><td><pre><span class=\"token comment\">/*----------------------------- End -----------------------------*/</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre></pre></td></tr><tr><td data-num=\"106\"></td><td><pre></pre></td></tr><tr><td data-num=\"107\"></td><td><pre><span class=\"token comment\">/************************************************</pre></td></tr><tr><td data-num=\"108\"></td><td><pre>函数名称 ： main</pre></td></tr><tr><td data-num=\"109\"></td><td><pre>功    能 ： 主函数入口</pre></td></tr><tr><td data-num=\"110\"></td><td><pre>参    数 ： 无</pre></td></tr><tr><td data-num=\"111\"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num=\"112\"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifdef</span> <span class=\"token expression\">DEBUG</span></span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>  <span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>\t<span class=\"token function\">prvSetupHardware</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"121\"></td><td><pre>\t<span class=\"token comment\">/* Start the tasks defined within this file/specific to this demo. */</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>\t<span class=\"token function\">xTaskCreate</span><span class=\"token punctuation\">(</span> prvUser_Task<span class=\"token punctuation\">,</span> <span class=\"token string\">\"prvUser_Task\"</span><span class=\"token punctuation\">,</span> configMINIMAL_STACK_SIZE<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> mainCREATOR_TASK_PRIORITY<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"124\"></td><td><pre>\t<span class=\"token comment\">/* Start the scheduler. */</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>\t<span class=\"token function\">vTaskStartScheduler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>\t<span class=\"token comment\">/* Will only get here if there was not enough heap space to create the</pre></td></tr><tr><td data-num=\"128\"></td><td><pre>\tidle task. */</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre><span class=\"token comment\">/*----------------------------- End -----------------------------*/</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre></pre></td></tr><tr><td data-num=\"133\"></td><td><pre><span class=\"token comment\">/************************************************</pre></td></tr><tr><td data-num=\"134\"></td><td><pre>函数名称 ： prvSetupHardware</pre></td></tr><tr><td data-num=\"135\"></td><td><pre>功    能 ： 为了方便管理，所有的用户任务都放在该函数里面</pre></td></tr><tr><td data-num=\"136\"></td><td><pre>参    数 ： 无</pre></td></tr><tr><td data-num=\"137\"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num=\"138\"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">prvUser_Task</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>pvParameters <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre><span class=\"token punctuation\">&#123;</span>\t</pre></td></tr><tr><td data-num=\"141\"></td><td><pre>\t<span class=\"token comment\">/* User-defined private tasks */</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"143\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\">>>>> delete user task\\r\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>\t<span class=\"token function\">vTaskDelete</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">// 删除自己</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre></pre></td></tr><tr><td data-num=\"147\"></td><td><pre><span class=\"token comment\">/************************************************</pre></td></tr><tr><td data-num=\"148\"></td><td><pre>函数名称 ： prvSetupHardware</pre></td></tr><tr><td data-num=\"149\"></td><td><pre>功    能 ： 硬件接口初始化配置</pre></td></tr><tr><td data-num=\"150\"></td><td><pre>参    数 ： 无</pre></td></tr><tr><td data-num=\"151\"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num=\"152\"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">prvSetupHardware</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>\t<span class=\"token comment\">/* Start with the clocks in their expected state. */</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>\t<span class=\"token function\">RCC_DeInit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>\t<span class=\"token comment\">/* Enable HSE (high speed external clock). */</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>\t<span class=\"token function\">RCC_HSEConfig</span><span class=\"token punctuation\">(</span> RCC_HSE_ON <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>\t<span class=\"token comment\">/* Wait till HSE is ready. */</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>\t<span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span> <span class=\"token function\">RCC_GetFlagStatus</span><span class=\"token punctuation\">(</span> RCC_FLAG_HSERDY <span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> RESET <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>\t<span class=\"token comment\">/* 2 wait states required on the flash. */</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre>\t<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> <span class=\"token number\">0x40022000</span> <span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x02</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>\t<span class=\"token comment\">/* HCLK = SYSCLK */</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>\t<span class=\"token function\">RCC_HCLKConfig</span><span class=\"token punctuation\">(</span> RCC_SYSCLK_Div1 <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>\t<span class=\"token comment\">/* PCLK2 = HCLK */</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>\t<span class=\"token function\">RCC_PCLK2Config</span><span class=\"token punctuation\">(</span> RCC_HCLK_Div1 <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>\t<span class=\"token comment\">/* PCLK1 = HCLK/2 */</span></pre></td></tr><tr><td data-num=\"176\"></td><td><pre>\t<span class=\"token function\">RCC_PCLK1Config</span><span class=\"token punctuation\">(</span> RCC_HCLK_Div2 <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre></pre></td></tr><tr><td data-num=\"178\"></td><td><pre>\t<span class=\"token comment\">/* PLLCLK = 8MHz * 9 = 72 MHz. */</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre>\t<span class=\"token function\">RCC_PLLConfig</span><span class=\"token punctuation\">(</span> RCC_PLLSource_HSE_Div1<span class=\"token punctuation\">,</span> RCC_PLLMul_9 <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>\t<span class=\"token comment\">/* Enable PLL. */</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre>\t<span class=\"token function\">RCC_PLLCmd</span><span class=\"token punctuation\">(</span> ENABLE <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre></pre></td></tr><tr><td data-num=\"184\"></td><td><pre>\t<span class=\"token comment\">/* Wait till PLL is ready. */</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>\t<span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token function\">RCC_GetFlagStatus</span><span class=\"token punctuation\">(</span>RCC_FLAG_PLLRDY<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> RESET<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>\t<span class=\"token comment\">/* Select PLL as system clock source. */</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre>\t<span class=\"token function\">RCC_SYSCLKConfig</span><span class=\"token punctuation\">(</span> RCC_SYSCLKSource_PLLCLK <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre></pre></td></tr><tr><td data-num=\"192\"></td><td><pre>\t<span class=\"token comment\">/* Wait till PLL is used as system clock source. */</span></pre></td></tr><tr><td data-num=\"193\"></td><td><pre>\t<span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span> <span class=\"token function\">RCC_GetSYSCLKSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0x08</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"195\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"196\"></td><td><pre></pre></td></tr><tr><td data-num=\"197\"></td><td><pre>\t<span class=\"token comment\">/* Configure HCLK clock as SysTick clock source. */</span></pre></td></tr><tr><td data-num=\"198\"></td><td><pre>\t<span class=\"token function\">SysTick_CLKSourceConfig</span><span class=\"token punctuation\">(</span> SysTick_CLKSource_HCLK <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"199\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"200\"></td><td><pre>\t<span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"201\"></td><td><pre>\t * STM32 中断优先级分组为 4，即 4bit 都用来表示抢占优先级，范围为：0~15</pre></td></tr><tr><td data-num=\"202\"></td><td><pre>\t * 优先级分组只需要分组一次即可，以后如果有其他的任务需要用到中断，</pre></td></tr><tr><td data-num=\"203\"></td><td><pre>\t * 都统一用这个优先级分组，千万不要再分组，切忌。</pre></td></tr><tr><td data-num=\"204\"></td><td><pre>\t */</span></pre></td></tr><tr><td data-num=\"205\"></td><td><pre>\t<span class=\"token function\">NVIC_PriorityGroupConfig</span><span class=\"token punctuation\">(</span> NVIC_PriorityGroup_4 <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"206\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"207\"></td><td><pre>\t<span class=\"token comment\">/* Other peripheral configuration */</span></pre></td></tr><tr><td data-num=\"208\"></td><td><pre><span class=\"token comment\">//\tvSetupTimer();</span></pre></td></tr><tr><td data-num=\"209\"></td><td><pre>\t<span class=\"token function\">vSetupUSART</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"210\"></td><td><pre>\t<span class=\"token function\">vSetupParPort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"211\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"212\"></td><td><pre><span class=\"token comment\">/*----------------------------- End -----------------------------*/</span></pre></td></tr></table></figure><p>主程序没什么好解释的，初始化硬件的配置，建立所需的任务；真正实现的任务在下面的源文件中，主要是方便分类，规范一点便于管理。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"><span>bsp_uart.c</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"bsp_uart.h\"</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;string.h></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">/* Scheduler includes. */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"FreeRTOS.h\"</span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"task.h\"</span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"queue.h\"</span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"semphr.h\"</span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">BAUDRATE_1</span>\t\t<span class=\"token expression\"><span class=\"token number\">115200</span><span class=\"token punctuation\">;</span>\t\t\t</span><span class=\"token comment\">// 波特率设置\t支持的波特率：115200,19200,9600,38400,57600,1200,2400,4800</span></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">BAUDRATE_2</span>\t\t<span class=\"token expression\"><span class=\"token number\">115200</span><span class=\"token punctuation\">;</span>\t\t\t</span><span class=\"token comment\">// 波特率设置\t支持的波特率：115200,19200,9600,38400,57600,1200,2400,4800</span></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>UartRx_Buff_TypeDef Usart1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>QueueHandle_t xQueueUartTx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>QueueHandle_t xQueueUart1_Rx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>SemaphoreHandle_t xBinarySemaphore <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span>      <span class=\"token comment\">// 定义一个二值信号量</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">Uart_DMA_RxConfig</span><span class=\"token punctuation\">(</span> DMA_Channel_TypeDef<span class=\"token operator\">*</span>DMA_CHx<span class=\"token punctuation\">,</span><span class=\"token class-name\">uint32_t</span> PeripheralBaseAddr<span class=\"token punctuation\">,</span><span class=\"token class-name\">uint32_t</span> MemoryBaseAddr<span class=\"token punctuation\">,</span><span class=\"token class-name\">uint16_t</span> Bufsize<span class=\"token punctuation\">,</span><span class=\"token class-name\">uint32_t</span> Priority<span class=\"token punctuation\">,</span><span class=\"token class-name\">uint32_t</span> Mode <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">prvUart1_Rx_Task</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>pvParameters <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#123;</span>\t</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">;</span> <span class=\"token punctuation\">;</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t<span class=\"token function\">xSemaphoreTake</span><span class=\"token punctuation\">(</span>xBinarySemaphore<span class=\"token punctuation\">,</span> portMAX_DELAY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// 无超时阻塞，等待成功获取信号量；此处也没有必要检测返回值</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>Usart1<span class=\"token punctuation\">.</span>RxCounter <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"len=%d 收到数据:%s\\n\"</span><span class=\"token punctuation\">,</span>Usart1<span class=\"token punctuation\">.</span>RxCounter<span class=\"token punctuation\">,</span>Usart1<span class=\"token punctuation\">.</span>RxBuffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t\t<span class=\"token function\">memset</span><span class=\"token punctuation\">(</span>Usart1<span class=\"token punctuation\">.</span>RxBuffer<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> RxBUFFER_SIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token comment\">/************************************************</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>函数名称 ： vSetupUSART</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>功    能 ： UART 初始化接口</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>参    数 ： 无</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">vSetupUSART</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t<span class=\"token function\">UART1_Config</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token comment\">//\tUART2_Config();</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token comment\">//\tvSemaphoreCreateBinary(xBinarySemaphore);            </span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\txBinarySemaphore <span class=\"token operator\">=</span> <span class=\"token function\">xSemaphoreCreateBinary</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>        <span class=\"token comment\">// 创建二值信号量</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t<span class=\"token function\">memset</span><span class=\"token punctuation\">(</span>Usart1<span class=\"token punctuation\">.</span>RxBuffer<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> RxBUFFER_SIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t<span class=\"token function\">xTaskCreate</span><span class=\"token punctuation\">(</span> prvUart1_Rx_Task<span class=\"token punctuation\">,</span> <span class=\"token string\">\"prvUart1_Rx_Task\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">500</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> tskIDLE_PRIORITY <span class=\"token operator\">+</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre></pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token comment\">/************************************************</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>函数名称 ： UART1_Config</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>功    能 ： UART1 端口配置</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>参    数 ： 无</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">UART1_Config</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    GPIO_InitTypeDef GPIO_InitStructure<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    NVIC_InitTypeDef NVIC_InitStructure<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    USART_InitTypeDef USART_InitStructure<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t<span class=\"token comment\">/* config GPIOA clock */</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t<span class=\"token function\">RCC_APB2PeriphClockCmd</span><span class=\"token punctuation\">(</span>RCC_APB2Periph_GPIOA<span class=\"token punctuation\">,</span> ENABLE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    <span class=\"token comment\">/* config USART1 clock */</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    <span class=\"token function\">RCC_APB2PeriphClockCmd</span><span class=\"token punctuation\">(</span>RCC_APB2Periph_USART1<span class=\"token punctuation\">,</span> ENABLE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    <span class=\"token comment\">/* USART1 GPIO config */</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    <span class=\"token comment\">/* Configure USART1 Tx (PA.09) as alternate function push-pull */</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>    GPIO_InitStructure<span class=\"token punctuation\">.</span>GPIO_Pin <span class=\"token operator\">=</span> GPIO_Pin_9<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>    GPIO_InitStructure<span class=\"token punctuation\">.</span>GPIO_Mode <span class=\"token operator\">=</span> GPIO_Mode_AF_PP<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>    GPIO_InitStructure<span class=\"token punctuation\">.</span>GPIO_Speed <span class=\"token operator\">=</span> GPIO_Speed_50MHz<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>    <span class=\"token function\">GPIO_Init</span><span class=\"token punctuation\">(</span>GPIOA<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>GPIO_InitStructure<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>    <span class=\"token comment\">/* Configure USART1 Rx (PA.10) as input floating */</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>    GPIO_InitStructure<span class=\"token punctuation\">.</span>GPIO_Pin <span class=\"token operator\">=</span> GPIO_Pin_10<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>    GPIO_InitStructure<span class=\"token punctuation\">.</span>GPIO_Mode <span class=\"token operator\">=</span> GPIO_Mode_IN_FLOATING<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>    <span class=\"token function\">GPIO_Init</span><span class=\"token punctuation\">(</span>GPIOA<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>GPIO_InitStructure<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>    <span class=\"token comment\">/* Enable the USART1 Interrupt */</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>    NVIC_InitStructure<span class=\"token punctuation\">.</span>NVIC_IRQChannel <span class=\"token operator\">=</span> USART1_IRQn<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>\tNVIC_InitStructure<span class=\"token punctuation\">.</span>NVIC_IRQChannelPreemptionPriority <span class=\"token operator\">=</span> <span class=\"token number\">7</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>    NVIC_InitStructure<span class=\"token punctuation\">.</span>NVIC_IRQChannelSubPriority <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>    NVIC_InitStructure<span class=\"token punctuation\">.</span>NVIC_IRQChannelCmd <span class=\"token operator\">=</span> ENABLE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>    <span class=\"token function\">NVIC_Init</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>NVIC_InitStructure<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>    <span class=\"token comment\">/* USART1 mode config */</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>    USART_InitStructure<span class=\"token punctuation\">.</span>USART_BaudRate <span class=\"token operator\">=</span> BAUDRATE_1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>    USART_InitStructure<span class=\"token punctuation\">.</span>USART_WordLength <span class=\"token operator\">=</span> USART_WordLength_8b<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>    USART_InitStructure<span class=\"token punctuation\">.</span>USART_StopBits <span class=\"token operator\">=</span> USART_StopBits_1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>    USART_InitStructure<span class=\"token punctuation\">.</span>USART_Parity <span class=\"token operator\">=</span> USART_Parity_No <span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>    USART_InitStructure<span class=\"token punctuation\">.</span>USART_HardwareFlowControl <span class=\"token operator\">=</span> USART_HardwareFlowControl_None<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>    USART_InitStructure<span class=\"token punctuation\">.</span>USART_Mode <span class=\"token operator\">=</span> USART_Mode_Rx <span class=\"token operator\">|</span> USART_Mode_Tx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>    <span class=\"token function\">USART_Init</span><span class=\"token punctuation\">(</span>EVAL_COM1<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>USART_InitStructure<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>\t<span class=\"token comment\">/* DMA config */</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>\t<span class=\"token function\">Uart_DMA_RxConfig</span><span class=\"token punctuation\">(</span>USART1_RX_DMA_CHANNEL<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>\t\t\t\t\t<span class=\"token punctuation\">(</span><span class=\"token class-name\">uint32_t</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>USART1<span class=\"token operator\">-></span>DR<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>\t\t\t\t\t<span class=\"token punctuation\">(</span><span class=\"token class-name\">uint32_t</span><span class=\"token punctuation\">)</span>Usart1<span class=\"token punctuation\">.</span>RxBuffer<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>\t\t\t\t\tRxBUFFER_SIZE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>\t\t\t\t\tDMA_Priority_Medium<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>\t\t\t\t\tDMA_Mode_Circular<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>\t<span class=\"token function\">USART_ITConfig</span><span class=\"token punctuation\">(</span>EVAL_COM1<span class=\"token punctuation\">,</span> USART_IT_IDLE<span class=\"token punctuation\">,</span> ENABLE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>          <span class=\"token comment\">// 这里使能的是空闲中断</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>\t<span class=\"token function\">USART_DMACmd</span><span class=\"token punctuation\">(</span>EVAL_COM1<span class=\"token punctuation\">,</span> USART_DMAReq_Rx<span class=\"token punctuation\">,</span> ENABLE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>    <span class=\"token function\">USART_Cmd</span><span class=\"token punctuation\">(</span>EVAL_COM1<span class=\"token punctuation\">,</span> ENABLE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre></pre></td></tr><tr><td data-num=\"116\"></td><td><pre><span class=\"token comment\">/************************************************</pre></td></tr><tr><td data-num=\"117\"></td><td><pre>函数名称 ： Uart_DMA_RxConfig</pre></td></tr><tr><td data-num=\"118\"></td><td><pre>功    能 ： 串口 DMA 接收配置（限串口 1/2/3）</pre></td></tr><tr><td data-num=\"119\"></td><td><pre>参    数 ： DMA_CHx ---- </pre></td></tr><tr><td data-num=\"120\"></td><td><pre>\t\t\tPeripheralBaseAddr ---- Specifies the peripheral base address for DMAy Channelx</pre></td></tr><tr><td data-num=\"121\"></td><td><pre>\t\t\tMemoryBaseAddr ---- Specifies the memory base address for DMAy Channelx</pre></td></tr><tr><td data-num=\"122\"></td><td><pre>\t\t\tBufsize ---- Specifies the buffer size, in data unit, of the specified Channel</pre></td></tr><tr><td data-num=\"123\"></td><td><pre>\t\t\tPriority ---- @ref DMA_priority_level</pre></td></tr><tr><td data-num=\"124\"></td><td><pre>\t\t\tMode ---- @ref DMA_circular_normal_mode</pre></td></tr><tr><td data-num=\"125\"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num=\"126\"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">Uart_DMA_RxConfig</span><span class=\"token punctuation\">(</span> DMA_Channel_TypeDef<span class=\"token operator\">*</span> DMA_CHx<span class=\"token punctuation\">,</span>\t\\</pre></td></tr><tr><td data-num=\"128\"></td><td><pre>\t\t\t\t\t\t\t <span class=\"token class-name\">uint32_t</span> PeripheralBaseAddr<span class=\"token punctuation\">,</span>\t\\</pre></td></tr><tr><td data-num=\"129\"></td><td><pre>\t\t\t\t\t\t\t <span class=\"token class-name\">uint32_t</span> MemoryBaseAddr<span class=\"token punctuation\">,</span>\t\\</pre></td></tr><tr><td data-num=\"130\"></td><td><pre>\t\t\t\t\t\t\t <span class=\"token class-name\">uint16_t</span> Bufsize<span class=\"token punctuation\">,</span>\t\\</pre></td></tr><tr><td data-num=\"131\"></td><td><pre>\t\t\t\t\t\t\t <span class=\"token class-name\">uint32_t</span> Priority<span class=\"token punctuation\">,</span>\t\\</pre></td></tr><tr><td data-num=\"132\"></td><td><pre>\t\t\t\t\t\t\t <span class=\"token class-name\">uint32_t</span> Mode <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>\tDMA_InitTypeDef DMA_InitStructure<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"136\"></td><td><pre>\t<span class=\"token comment\">/* USARTx RX DMA1 Channel (triggered by USARTx Rx event) Config */</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre> \t<span class=\"token function\">RCC_AHBPeriphClockCmd</span><span class=\"token punctuation\">(</span>RCC_AHBPeriph_DMA1<span class=\"token punctuation\">,</span> ENABLE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"139\"></td><td><pre>    <span class=\"token function\">DMA_DeInit</span><span class=\"token punctuation\">(</span>DMA_CHx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>   \tDMA_InitStructure<span class=\"token punctuation\">.</span>DMA_PeripheralBaseAddr <span class=\"token operator\">=</span> PeripheralBaseAddr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>\tDMA_InitStructure<span class=\"token punctuation\">.</span>DMA_MemoryBaseAddr <span class=\"token operator\">=</span> MemoryBaseAddr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>\tDMA_InitStructure<span class=\"token punctuation\">.</span>DMA_DIR <span class=\"token operator\">=</span> DMA_DIR_PeripheralSRC<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>\tDMA_InitStructure<span class=\"token punctuation\">.</span>DMA_BufferSize <span class=\"token operator\">=</span> Bufsize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>\tDMA_InitStructure<span class=\"token punctuation\">.</span>DMA_PeripheralInc <span class=\"token operator\">=</span> DMA_PeripheralInc_Disable<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>\tDMA_InitStructure<span class=\"token punctuation\">.</span>DMA_MemoryInc <span class=\"token operator\">=</span> DMA_MemoryInc_Enable<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>\tDMA_InitStructure<span class=\"token punctuation\">.</span>DMA_PeripheralDataSize <span class=\"token operator\">=</span> DMA_PeripheralDataSize_Byte<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>\tDMA_InitStructure<span class=\"token punctuation\">.</span>DMA_MemoryDataSize <span class=\"token operator\">=</span> DMA_MemoryDataSize_Byte<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>\tDMA_InitStructure<span class=\"token punctuation\">.</span>DMA_Mode <span class=\"token operator\">=</span> Mode<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>\tDMA_InitStructure<span class=\"token punctuation\">.</span>DMA_Priority <span class=\"token operator\">=</span> Priority<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>\tDMA_InitStructure<span class=\"token punctuation\">.</span>DMA_M2M <span class=\"token operator\">=</span> DMA_M2M_Disable<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>\t<span class=\"token function\">DMA_Init</span><span class=\"token punctuation\">(</span>DMA_CHx<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>DMA_InitStructure<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"153\"></td><td><pre>\t<span class=\"token function\">DMA_ClearFlag</span><span class=\"token punctuation\">(</span>DMA1_FLAG_GL3 <span class=\"token operator\">|</span> DMA1_FLAG_GL5 <span class=\"token operator\">|</span> DMA1_FLAG_GL6<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>\t<span class=\"token function\">DMA_ITConfig</span><span class=\"token punctuation\">(</span>DMA_CHx<span class=\"token punctuation\">,</span> DMA_IT_TE<span class=\"token punctuation\">,</span> ENABLE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>\t<span class=\"token function\">DMA_Cmd</span> <span class=\"token punctuation\">(</span>DMA_CHx<span class=\"token punctuation\">,</span>ENABLE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre></pre></td></tr><tr><td data-num=\"158\"></td><td><pre><span class=\"token comment\">/************************************************</pre></td></tr><tr><td data-num=\"159\"></td><td><pre>函数名称 ： USART_SendByte</pre></td></tr><tr><td data-num=\"160\"></td><td><pre>功    能 ： 串口字符发送</pre></td></tr><tr><td data-num=\"161\"></td><td><pre>参    数 ： c ---- 发送的数据</pre></td></tr><tr><td data-num=\"162\"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num=\"163\"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">USART_SendByte</span><span class=\"token punctuation\">(</span> USART_TypeDef<span class=\"token operator\">*</span> USARTx<span class=\"token punctuation\">,</span> <span class=\"token class-name\">uint8_t</span> c <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre><span class=\"token punctuation\">&#123;</span>     </pre></td></tr><tr><td data-num=\"166\"></td><td><pre>\t<span class=\"token function\">USART_SendData</span><span class=\"token punctuation\">(</span>USARTx<span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"168\"></td><td><pre>\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token function\">USART_GetFlagStatus</span><span class=\"token punctuation\">(</span>USARTx<span class=\"token punctuation\">,</span> USART_FLAG_TXE<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> RESET<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre></pre></td></tr><tr><td data-num=\"171\"></td><td><pre><span class=\"token comment\">/************************************************</pre></td></tr><tr><td data-num=\"172\"></td><td><pre>函数名称 ： USART_SendString</pre></td></tr><tr><td data-num=\"173\"></td><td><pre>功    能 ： 串口字符串发送</pre></td></tr><tr><td data-num=\"174\"></td><td><pre>参    数 ： USARTx ---- 串口</pre></td></tr><tr><td data-num=\"175\"></td><td><pre>\t\t\tpData ---- 字符串</pre></td></tr><tr><td data-num=\"176\"></td><td><pre>\t\t\tLength ---- 长度</pre></td></tr><tr><td data-num=\"177\"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num=\"178\"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">USART_SendString</span><span class=\"token punctuation\">(</span> USART_TypeDef<span class=\"token operator\">*</span> USARTx<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token class-name\">uint8_t</span> <span class=\"token operator\">*</span>pData<span class=\"token punctuation\">,</span> <span class=\"token class-name\">uint16_t</span> Length <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>    <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span>Length<span class=\"token operator\">--</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>        <span class=\"token function\">USART_SendByte</span><span class=\"token punctuation\">(</span>USARTx<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>pData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre>        pData<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre></pre></td></tr><tr><td data-num=\"188\"></td><td><pre><span class=\"token comment\">/************************************************</pre></td></tr><tr><td data-num=\"189\"></td><td><pre>函数名称 ： USART_Printf</pre></td></tr><tr><td data-num=\"190\"></td><td><pre>功    能 ： 串口打印输出</pre></td></tr><tr><td data-num=\"191\"></td><td><pre>参    数 ： USARTx ---- 串口</pre></td></tr><tr><td data-num=\"192\"></td><td><pre>\t\t\tString\t---- 字符串</pre></td></tr><tr><td data-num=\"193\"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num=\"194\"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num=\"195\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">USART_Printf</span><span class=\"token punctuation\">(</span> USART_TypeDef<span class=\"token operator\">*</span> USARTx<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>String <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"196\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"197\"></td><td><pre>    <span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"198\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"199\"></td><td><pre>        <span class=\"token function\">USART_SendByte</span><span class=\"token punctuation\">(</span>USARTx<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>String<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"200\"></td><td><pre>        String<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"201\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>String<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token char\">'\\0'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"202\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"203\"></td><td><pre></pre></td></tr><tr><td data-num=\"204\"></td><td><pre></pre></td></tr><tr><td data-num=\"205\"></td><td><pre><span class=\"token comment\">/************************************************</pre></td></tr><tr><td data-num=\"206\"></td><td><pre>函数名称 ： fputc</pre></td></tr><tr><td data-num=\"207\"></td><td><pre>功    能 ： 重定向 c 库函数 printf 到 DEBUG_UART</pre></td></tr><tr><td data-num=\"208\"></td><td><pre>参    数 ： ch</pre></td></tr><tr><td data-num=\"209\"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num=\"210\"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num=\"211\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">fputc</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> ch<span class=\"token punctuation\">,</span> FILE <span class=\"token operator\">*</span>f<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"212\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"213\"></td><td><pre>    <span class=\"token comment\">/* 发送一个字节数据到 DEBUG_UART */</span></pre></td></tr><tr><td data-num=\"214\"></td><td><pre>    <span class=\"token function\">USART_SendData</span><span class=\"token punctuation\">(</span>DEBUG_UART<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">uint8_t</span><span class=\"token punctuation\">)</span> ch<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"215\"></td><td><pre></pre></td></tr><tr><td data-num=\"216\"></td><td><pre>    <span class=\"token comment\">/* 等待发送完毕 */</span></pre></td></tr><tr><td data-num=\"217\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token function\">USART_GetFlagStatus</span><span class=\"token punctuation\">(</span>DEBUG_UART<span class=\"token punctuation\">,</span> USART_FLAG_TXE<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> RESET<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"218\"></td><td><pre></pre></td></tr><tr><td data-num=\"219\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>ch<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"220\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"221\"></td><td><pre></pre></td></tr><tr><td data-num=\"222\"></td><td><pre><span class=\"token comment\">/************************************************</pre></td></tr><tr><td data-num=\"223\"></td><td><pre>函数名称 ： fgetc</pre></td></tr><tr><td data-num=\"224\"></td><td><pre>功    能 ： 重定向 c 库函数 scanf 到 DEBUG_UART</pre></td></tr><tr><td data-num=\"225\"></td><td><pre>参    数 ： f ---- 文件</pre></td></tr><tr><td data-num=\"226\"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num=\"227\"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num=\"228\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">fgetc</span><span class=\"token punctuation\">(</span>FILE <span class=\"token operator\">*</span>f<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"229\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"230\"></td><td><pre>    <span class=\"token comment\">/* 等待 DEBUG_UART 输入数据 */</span></pre></td></tr><tr><td data-num=\"231\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token function\">USART_GetFlagStatus</span><span class=\"token punctuation\">(</span>DEBUG_UART<span class=\"token punctuation\">,</span> USART_FLAG_RXNE<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> RESET<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"232\"></td><td><pre></pre></td></tr><tr><td data-num=\"233\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token function\">USART_ReceiveData</span><span class=\"token punctuation\">(</span>DEBUG_UART<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"234\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"235\"></td><td><pre></pre></td></tr><tr><td data-num=\"236\"></td><td><pre></pre></td></tr><tr><td data-num=\"237\"></td><td><pre><span class=\"token comment\">/************************************************************************/</span></pre></td></tr><tr><td data-num=\"238\"></td><td><pre><span class=\"token comment\">/*            STM32F10x USART Interrupt Handlers                        */</span></pre></td></tr><tr><td data-num=\"239\"></td><td><pre><span class=\"token comment\">/************************************************************************/</span></pre></td></tr><tr><td data-num=\"240\"></td><td><pre></pre></td></tr><tr><td data-num=\"241\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"242\"></td><td><pre>  * @brief  This function handles USART1 global interrupt request.</pre></td></tr><tr><td data-num=\"243\"></td><td><pre>  * @param  None</pre></td></tr><tr><td data-num=\"244\"></td><td><pre>  * @retval None</pre></td></tr><tr><td data-num=\"245\"></td><td><pre>  */</span></pre></td></tr><tr><td data-num=\"246\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">USART1_IRQHandler</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"247\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"248\"></td><td><pre>\tBaseType_t xHigherPriorityTaskWoken <span class=\"token operator\">=</span> pdFALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"249\"></td><td><pre></pre></td></tr><tr><td data-num=\"250\"></td><td><pre></pre></td></tr><tr><td data-num=\"251\"></td><td><pre>\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">USART_GetITStatus</span><span class=\"token punctuation\">(</span>EVAL_COM1<span class=\"token punctuation\">,</span> USART_IT_IDLE<span class=\"token punctuation\">)</span><span class=\"token operator\">!=</span>RESET<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"252\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"253\"></td><td><pre>\t\t<span class=\"token function\">DMA_Cmd</span><span class=\"token punctuation\">(</span>USART1_RX_DMA_CHANNEL<span class=\"token punctuation\">,</span> DISABLE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"254\"></td><td><pre>\t\t<span class=\"token function\">DMA_ClearFlag</span><span class=\"token punctuation\">(</span>DMA1_FLAG_TC5<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"255\"></td><td><pre>\t\tUsart1<span class=\"token punctuation\">.</span>RxCounter <span class=\"token operator\">=</span> RxBUFFER_SIZE <span class=\"token operator\">-</span> <span class=\"token function\">DMA_GetCurrDataCounter</span><span class=\"token punctuation\">(</span>USART1_RX_DMA_CHANNEL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// 获取接收长度</span></pre></td></tr><tr><td data-num=\"256\"></td><td><pre>\t\tUSART1_RX_DMA_CHANNEL<span class=\"token operator\">-></span>CNDTR <span class=\"token operator\">=</span> RxBUFFER_SIZE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"257\"></td><td><pre>\t\t<span class=\"token function\">DMA_Cmd</span><span class=\"token punctuation\">(</span>USART1_RX_DMA_CHANNEL<span class=\"token punctuation\">,</span> ENABLE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"258\"></td><td><pre>\t\t\t\t</pre></td></tr><tr><td data-num=\"259\"></td><td><pre>\t\t<span class=\"token function\">xSemaphoreGiveFromISR</span><span class=\"token punctuation\">(</span>xBinarySemaphore<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>xHigherPriorityTaskWoken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// 'Give' the semaphore to unblock the task</span></pre></td></tr><tr><td data-num=\"260\"></td><td><pre>\t\t<span class=\"token function\">portEND_SWITCHING_ISR</span><span class=\"token punctuation\">(</span>xHigherPriorityTaskWoken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>        <span class=\"token comment\">// 上下切换</span></pre></td></tr><tr><td data-num=\"261\"></td><td><pre>\t\t<span class=\"token function\">USART_ReceiveData</span><span class=\"token punctuation\">(</span>EVAL_COM1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t\t\t<span class=\"token comment\">// Clear IDLE interrupt flag bit</span></pre></td></tr><tr><td data-num=\"262\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"263\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"264\"></td><td><pre></pre></td></tr><tr><td data-num=\"265\"></td><td><pre><span class=\"token comment\">//  if(USART_GetITStatus(EVAL_COM1, USART_IT_TXE) != RESET)</span></pre></td></tr><tr><td data-num=\"266\"></td><td><pre><span class=\"token comment\">//  &#123;</span></pre></td></tr><tr><td data-num=\"267\"></td><td><pre><span class=\"token comment\">//    /* Write one byte to the transmit data register */</span></pre></td></tr><tr><td data-num=\"268\"></td><td><pre><span class=\"token comment\">//    USART_SendData(EVAL_COM1, TxBuffer[TxCounter++]);</span></pre></td></tr><tr><td data-num=\"269\"></td><td><pre></pre></td></tr><tr><td data-num=\"270\"></td><td><pre><span class=\"token comment\">//    if(TxCounter == RxBUFFER_SIZE)</span></pre></td></tr><tr><td data-num=\"271\"></td><td><pre><span class=\"token comment\">//    &#123;</span></pre></td></tr><tr><td data-num=\"272\"></td><td><pre><span class=\"token comment\">//      /* Disable the EVAL_COM1 Transmit interrupt */</span></pre></td></tr><tr><td data-num=\"273\"></td><td><pre><span class=\"token comment\">//      USART_ITConfig(EVAL_COM1, USART_IT_TXE, DISABLE);</span></pre></td></tr><tr><td data-num=\"274\"></td><td><pre><span class=\"token comment\">//    &#125;</span></pre></td></tr><tr><td data-num=\"275\"></td><td><pre><span class=\"token comment\">//  &#125;</span></pre></td></tr><tr><td data-num=\"276\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"277\"></td><td><pre></pre></td></tr><tr><td data-num=\"278\"></td><td><pre></pre></td></tr><tr><td data-num=\"279\"></td><td><pre><span class=\"token comment\">/*---------------------------- END OF FILE ----------------------------*/</span></pre></td></tr></table></figure><p>这里跟往常中的配置不一样，是使用了 DMA + IDLE 来进行串口接收处理，因为 DMA 并不占用 CPU，DMA 只需在传输完成的时候产生一个中断，告诉 CPU 我已经完成了，然后 CPU 知道了就去处理数据，这样子提高了 CPU 的利用率，可以更好的让出硬件资源；若是像在 <a href=\"https://blog.csdn.net/qq_42992084/article/details/104098531\">STM32 笔记之 USART（串口）</a> 中那样直接用接收中断来接收，那样的话，每接收一个数据就要进入中断，这样频繁的进出中断，打断程序的执行，只会让跑起来的程序变得不那么实时性；而且，既然 ST 有这个 DMA 资源可以使用，并且是不占 CPU 的，那我们没必要不使用啊，使用操作系统，无非就是为了提高实时性，榨干 CPU 的资源，又怎会让这串口接收而使得效率降低呢？</p>\n<p>1、串口 DMA 接收的流程：</p>\n<p>串口 DMA 接收在初始化的时候就处于开启状态，一直等待数据的到来，在软件上无需做任何事情，只要在初始化配置的时候设置好配置就可以了。</p>\n<p>2、数据接收完成后处理：</p>\n<p>这里主要通过串口空闲中断来判断接收完成（主要是为了实现串口 DMA 不定长数据的接收），即当串口数据流停止后，就会产生 IDLE 中断。</p>\n<p>然后我们只需要在中断中做以下操作：</p>\n<ul>\n<li>关闭串口接收 DMA 通道（防止数据未处理又接收到数据；为 DMA 重新赋值）。</li>\n<li>清除 DMA 所有标志位。</li>\n<li>从 DMA 寄存器中获取接收到的数据字节数。</li>\n<li>重新设置 DMA 下次要接收的数据字节数（这里是给 DMA 寄存器重新设置接收的计数值，这个数量只能大于或者等于可能接收的字节数，否则当 DMA 接收计数器递减到 0 的时候，就会重载这个计数值，重新循环递减计数，造成接收缓冲区的数据被覆盖丢失。）注意：对 DMA 的相关寄存器配置写入，必须要在关闭 DMA 的条件进行，否则操作无效。</li>\n<li>开启 DMA 通道，等待下一次的数据接收。</li>\n</ul>\n<p>说明一下，STM32 的 IDLE 的中断在串口无数据接收的情况下，并不会一直产生的，产生的条件是：当清除 IDLE 标志位后，必须有接收到至少一个数据后，才开始触发；当一段时间没有接收到数据，便产生 IDLE 中断。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"><span>bsp_uart.h</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifndef</span> <span class=\"token expression\">__BSP_UART_H</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">__BSP_UART_H</span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"stm32f10x.h\"</span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">DEBUG_UART</span>\t\t\t\t<span class=\"token expression\">USART1</span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">EVAL_COM1</span>\t\t\t\t<span class=\"token expression\">USART1</span></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">EVAL_COM2</span>\t\t\t\t<span class=\"token expression\">USART2</span></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">USART1_RX_DMA_CHANNEL</span>\t<span class=\"token expression\">DMA1_Channel5</span></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">USART2_RX_DMA_CHANNEL</span>\t<span class=\"token expression\">DMA1_Channel6</span></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">TxBUFFER_SIZE</span>  \t \t\t<span class=\"token expression\"><span class=\"token number\">100</span></span></span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">RxBUFFER_SIZE</span>  \t\t \t<span class=\"token expression\"><span class=\"token number\">100</span></span></span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">UART_QUEUE_RX_LENGTH</span>\t<span class=\"token expression\"><span class=\"token number\">2</span></span></span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">UART_QUEUE_TX_LENGTH</span>\t<span class=\"token expression\"><span class=\"token number\">2</span></span></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token class-name\">uint8_t</span> Receiving_Time<span class=\"token punctuation\">;</span>\t\t\t\t\t<span class=\"token comment\">// 接收时间</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token class-name\">uint8_t</span> Frame_flag<span class=\"token punctuation\">;</span>\t\t\t\t\t\t<span class=\"token comment\">// 一帧完成标志</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span>EVAL_COMx_TypeDef<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token class-name\">uint8_t</span> RxBuffer<span class=\"token punctuation\">[</span>RxBUFFER_SIZE<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">// 接收暂存缓冲区</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t__IO <span class=\"token class-name\">uint8_t</span> RxCounter<span class=\"token punctuation\">;</span>\t\t\t\t\t<span class=\"token comment\">// 接收数据个数</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">&#125;</span>UartRx_Buff_TypeDef<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token keyword\">extern</span> UartRx_Buff_TypeDef Usart1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t<span class=\"token class-name\">uint8_t</span> TxBuffer<span class=\"token punctuation\">[</span>TxBUFFER_SIZE<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">// 发送暂存缓冲区</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t__IO <span class=\"token class-name\">uint8_t</span> TxCounter<span class=\"token punctuation\">;</span>\t\t\t\t\t<span class=\"token comment\">// 发送数据个数</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\tUSART_TypeDef<span class=\"token operator\">*</span> COMx<span class=\"token punctuation\">;</span>\t\t\t\t\t<span class=\"token comment\">// 串口号</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">&#125;</span>UartTx_Buff_TypeDef<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">vSetupUSART</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">UART1_Config</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">UART2_Config</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">USART_SendByte</span><span class=\"token punctuation\">(</span> USART_TypeDef<span class=\"token operator\">*</span> USARTx<span class=\"token punctuation\">,</span> <span class=\"token class-name\">uint8_t</span> c <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">USART_SendString</span><span class=\"token punctuation\">(</span> USART_TypeDef<span class=\"token operator\">*</span> USARTx<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token class-name\">uint8_t</span> <span class=\"token operator\">*</span>pData<span class=\"token punctuation\">,</span> <span class=\"token class-name\">uint16_t</span> Length <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">USART_Printf</span><span class=\"token punctuation\">(</span> USART_TypeDef<span class=\"token operator\">*</span> USARTx<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>String <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span>\t<span class=\"token comment\">/* __BSP_UART_H */</span></span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token comment\">/*---------------------------- END OF FILE ----------------------------*/</span></pre></td></tr></table></figure>",
            "tags": [
                "history",
                "FreeRTOS",
                "RTOS"
            ]
        },
        {
            "id": "https://arachnid.cc/freertos-queue/",
            "url": "https://arachnid.cc/freertos-queue/",
            "title": "FreeRTOS 篇章之队列管理",
            "date_published": "2020-02-20T06:19:20.000Z",
            "content_html": "<h1 id=\"队列特性\"><a class=\"anchor\" href=\"#队列特性\">#</a> 队列特性</h1>\n<p>队列可以保存有限个具有确定长度的数据单元。队列可以保存的最大单元数目被称为队列的 “深度” ；在队列创建时需要设定其深度和每个单元的大小。</p>\n<p>通常情况下，队列被作为 FIFO（先进先出）使用，即数据由队列尾写入，从队列首读出；当然，由队列首写入也是可能的。</p>\n<p>然后我们看一下队列的处理过程：</p>\n<p><img src=\"20200219230912853.gif\" alt=\"img\" /></p>\n<h1 id=\"队列的-api-函数\"><a class=\"anchor\" href=\"#队列的-api-函数\">#</a> 队列的 API 函数</h1>\n<p>要想调用以下函数，需要  <code>#include &quot;queue.h&quot;</code></p>\n<p><strong>1、队列创建</strong></p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">属性</th>\n<th style=\"text-align:left\">API 接口</th>\n<th style=\"text-align:left\">实际执行函数</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">动态</td>\n<td style=\"text-align:left\">xQueueCreate()</td>\n<td style=\"text-align:left\">xQueueGenericCreate()</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">静态</td>\n<td style=\"text-align:left\">xQueueCreateStatic()</td>\n<td style=\"text-align:left\">xQueueGenericCreateStatic()</td>\n</tr>\n</tbody>\n</table>\n<p><strong>2、队列发送</strong></p>\n<table>\n<thead>\n<tr>\n<th>入队方式</th>\n<th>API 接口</th>\n<th>实际执行函数</th>\n<th style=\"text-align:left\">其他</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>从队列尾部入队</td>\n<td>xQueueSend()</td>\n<td>xQueueGenericSend()</td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td>同上</td>\n<td>xQueueSendToBack()</td>\n<td>同上</td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td>同上</td>\n<td>xQueueOverwrite()</td>\n<td>同上</td>\n<td style=\"text-align:left\">仅用于消息数目为 1 的队列</td>\n</tr>\n<tr>\n<td>从队列首部入队</td>\n<td>xQueueSendToFront()</td>\n<td>同上</td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n<td></td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td>从队列尾部入队 &lt;br/&gt; （用于中断中）</td>\n<td>xQueueSendFromISR()</td>\n<td>xQueueGenericSendFromISR()</td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td>同上</td>\n<td>xQueueSendToBackFromISR()</td>\n<td>同上</td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td>同上</td>\n<td>xQueueOverwriteFromISR()</td>\n<td>同上</td>\n<td style=\"text-align:left\">仅用于消息数目为 1 的队列</td>\n</tr>\n<tr>\n<td>从队列首部入队 &lt;br/&gt; （用于中断中）</td>\n<td>xQueueSendToFrontFromISR()</td>\n<td>同上</td>\n<td style=\"text-align:left\"></td>\n</tr>\n</tbody>\n</table>\n<p><strong>3、队列接收</strong></p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">出队方式</th>\n<th style=\"text-align:left\">API 接口</th>\n<th style=\"text-align:left\">实际执行函数</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">出队并删除</td>\n<td style=\"text-align:left\">xQueueReceive()</td>\n<td style=\"text-align:left\">xQueueGenericReceive()</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">出队不删除</td>\n<td style=\"text-align:left\">xQueuePeek()</td>\n<td style=\"text-align:left\">同上</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">出队并删除 &lt;br/&gt; （用于中断中）</td>\n<td style=\"text-align:left\">xQueueReceiveFromISR()</td>\n<td style=\"text-align:left\">xQueueReceiveFromISR()</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">出队不删除 &lt;br/&gt; （用于中断中）</td>\n<td style=\"text-align:left\">xQueuePeekFromISR()</td>\n<td style=\"text-align:left\">xQueuePeekFromISR()</td>\n</tr>\n</tbody>\n</table>\n<p><strong>4、队列复位及删除</strong></p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">功能</th>\n<th style=\"text-align:left\">API 接口</th>\n<th style=\"text-align:left\">实际执行函数</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">复位清空内存</td>\n<td style=\"text-align:left\">xQueueReset()</td>\n<td style=\"text-align:left\">xQueueGenericReset()</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">删除释放内存</td>\n<td style=\"text-align:left\">vQueueDelete()</td>\n<td style=\"text-align:left\">vQueueDelete()</td>\n</tr>\n</tbody>\n</table>\n<h1 id=\"常用队列函数分析\"><a class=\"anchor\" href=\"#常用队列函数分析\">#</a> 常用队列函数分析</h1>\n<p><strong>1、xQueueCreate () API 函数</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>QueueHandle_t  <span class=\"token function\">xQueueCreate</span><span class=\"token punctuation\">(</span> UBaseType_t  uxQueueLength<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                             UBaseType_t  uxItemSize <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>传入参数：</p>\n<ul>\n<li><strong>uxQueueLength</strong>：队列项长度；即队列能够存储的最大消息数目，也称为队列深度。</li>\n<li><strong>uxItemSize</strong>：信息大小；即队列中每个消息数目的数据大小，以字节为单位。</li>\n</ul>\n<p>返回参数（此返回值应当保存下来，以作为操作此队列的句柄）：</p>\n<ul>\n<li><strong>NULL</strong>：表示没有足够的堆空间分配给队列而导致创建失败。</li>\n<li><strong>非 NULL</strong>：表示队列创建成功。</li>\n</ul>\n<p><strong>2、xQueueSendToBack () 与 xQueueSendToFront () API 函数</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>BaseType_t  <span class=\"token function\">xQueueSendToBack</span><span class=\"token punctuation\">(</span> QueueHandle_t  xQueue<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                              <span class=\"token keyword\">const</span> <span class=\"token keyword\">void</span>     <span class=\"token operator\">*</span>pvItemToQueue<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                              TickType_t     xTicksToWait <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>BaseType_t  <span class=\"token function\">xQueueSendToFront</span><span class=\"token punctuation\">(</span> QueueHandle_t  xQueue<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                               <span class=\"token keyword\">const</span> <span class=\"token keyword\">void</span>     <span class=\"token operator\">*</span>pvItemToQueue<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                               TickType_t     xTicksToWait <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><code>xQueueSendToFront()</code>  与  <code>xQueueSendToBack()</code>  函数参数及返回值。</p>\n<p>传入参数：</p>\n<ul>\n<li><strong>xQueue</strong>：目标队列的句柄。这个句柄即是调用  <code>xQueueCreate()</code>  创建该队列时的返回值。</li>\n<li><strong>pvItemToQueue</strong>：发送数据的指针。其指向将要复制到目标队列中的数据单元。</li>\n<li><strong>xTicksToWait</strong>：阻塞超时时间。如果在发送时队列已满，这个时间即是任务处于阻塞态等待队列空间有效的最长等待时间；如果  <code>xTicksToWait</code>  设为  <code>0</code>  ， 则  <code>xQueueSendToFront()</code>  与  <code>xQueueSendToBack()</code>  均会立即返回；如果把  <code>xTicksToWait</code>  设置为  <code>portMAX_DELAY</code> ，那么阻塞等待将没有超时限制。</li>\n</ul>\n<p>返回参数（有两个可能的返回值）：</p>\n<ul>\n<li><strong>pdTRUE</strong>：数据被成功发送到队列中。</li>\n<li><strong>errQUEUE_FULL</strong>：由于队列已满而无法将数据写入。</li>\n</ul>\n<p><strong>3、xQueueReceive () 与 xQueuePeek () API 函数</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>BaseType_t  <span class=\"token function\">xQueueReceive</span><span class=\"token punctuation\">(</span> QueueHandle_t  xQueue<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                           <span class=\"token keyword\">void</span>           <span class=\"token operator\">*</span>pvBuffer<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                           TickType_t     xTicksToWait <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>BaseType_t  <span class=\"token function\">xQueuePeek</span><span class=\"token punctuation\">(</span> QueueHandle_t  xQueue<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                        <span class=\"token keyword\">void</span>           <span class=\"token operator\">*</span>pvBuffer<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                        TickType_t     xTicksToWait <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><code>xQueueReceive()</code>  与  <code>xQueuePeek()</code>  函数参数与返回值。</p>\n<p>传入参数：</p>\n<ul>\n<li><strong>xQueue</strong>：被读队列的句柄。这个句柄即是调用  <code>xQueueCreate()</code>  创建该队列时的返回值</li>\n<li><strong>pvBuffer</strong>：接收缓存指针。其指向一段内存区域，用于接收从队列中拷贝来的数据</li>\n<li><strong>xTicksToWait</strong>：阻塞超时时间。如果在接收时队列为空，则这个时间是任务处于阻塞状态以等待队列数据有效的最长等待时间；如果  <code>xTicksToWait</code>  设为  <code>0</code>  ， 则  <code>xQueueRecieve()</code>  与  <code>xQueuePeek()</code>  均会立即返回；如果把  <code>xTicksToWait</code>  设置为  <code>portMAX_DELAY</code>  ，那么阻塞等待将没有超时限制。</li>\n</ul>\n<p>返回参数（有两个可能的返回值）：</p>\n<ul>\n<li><strong>pdTRUE</strong>：成功地从队列中读到数据。</li>\n<li><strong>pdFALSE</strong>：在读取时由于队列已空而没有读到任何数据。</li>\n</ul>\n<h1 id=\"大型数据单元处理\"><a class=\"anchor\" href=\"#大型数据单元处理\">#</a> 大型数据单元处理</h1>\n<p>如果队列存储的数据单元尺寸较大，那最好是利用队列来传递数据的指针而不是对数据本身在队列上一字节一字节地拷贝进或拷贝出。传递指针无论是在处理速度上还是内存空间利用上都更有效；但是，当你利用队列传递指针时，一定要十分小心地做到以下两点：</p>\n<p><strong>1、指针指向的内存空间的所有权必须明确</strong></p>\n<p>当任务间通过指针共享内存时，应该从根本上保证所不会有任意两个任务同时修改共享内存中的数据，或是以其它行为方式使得共享内存数据无效或产生一致性问题。原则上，共享内存在其指针发送到队列之前，其内容只允许被发送任务访问；共享内存指针从队列中被读出之后，其内容亦只允许被接收任务访问。</p>\n<p><strong>2、指针指向的内存空间必须有效</strong></p>\n<p>如果指针指向的内存空间是动态分配的，只应该有一个任务负责对其进行内存释放。当这段内存空间被释放之后，就不应该有任何一个任务再访问这段空间。</p>\n<p>切忌用指针访问任务栈上分配的空间。因为当栈帧发生改变后，栈上的数据将不再有效。</p>\n<h1 id=\"例程测试\"><a class=\"anchor\" href=\"#例程测试\">#</a> 例程测试</h1>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"><span>main.c</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* Standard includes. */</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;string.h></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">/* Scheduler includes. */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"FreeRTOS.h\"</span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"task.h\"</span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"queue.h\"</span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">/* Library includes. */</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"stm32f10x_it.h\"</span></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">/* Private app includes. */</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"bsp_time.h\"</span></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"bsp_uart.h\"</span></span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"bsp_gpio.h\"</span></span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">/* Task priorities. */</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">mainCREATOR_TASK_PRIORITY</span>           <span class=\"token expression\"><span class=\"token punctuation\">(</span> tskIDLE_PRIORITY <span class=\"token operator\">+</span> <span class=\"token number\">3</span> <span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\">/*----------------------------- End -----------------------------*/</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"25\"></td><td><pre> * User Private Task.</pre></td></tr><tr><td data-num=\"26\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">prvUser_Task</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>pvParameters <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"30\"></td><td><pre> * Configure the clocks, GPIO and other peripherals as required by the demo.</pre></td></tr><tr><td data-num=\"31\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">prvSetupHardware</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token comment\">/*----------------------------- End -----------------------------*/</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token comment\">/************************************************</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>函数名称 ： main</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>功    能 ： 主函数入口</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>参    数 ： 无</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifdef</span> <span class=\"token expression\">DEBUG</span></span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>  <span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t<span class=\"token function\">prvSetupHardware</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t<span class=\"token comment\">/* Start the tasks defined within this file/specific to this demo. */</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t<span class=\"token function\">xTaskCreate</span><span class=\"token punctuation\">(</span> prvUser_Task<span class=\"token punctuation\">,</span> <span class=\"token string\">\"prvUser_Task\"</span><span class=\"token punctuation\">,</span> configMINIMAL_STACK_SIZE<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> mainCREATOR_TASK_PRIORITY<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t<span class=\"token comment\">/* Start the scheduler. */</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t<span class=\"token function\">vTaskStartScheduler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t<span class=\"token comment\">/* Will only get here if there was not enough heap space to create the</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\tidle task. */</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token comment\">/*----------------------------- End -----------------------------*/</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token keyword\">extern</span> QueueHandle_t xQueueUartTx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">vSender1_Task</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>pvParameters <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token punctuation\">&#123;</span>\t</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\tUartTx_Buff_TypeDef uart_data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\t<span class=\"token function\">strcpy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>uart_data<span class=\"token punctuation\">.</span>TxBuffer<span class=\"token punctuation\">,</span><span class=\"token string\">\"TaskA Running\\r\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\tuart_data<span class=\"token punctuation\">.</span>TxCounter <span class=\"token operator\">=</span> <span class=\"token function\">strlen</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"TaskA running\\r\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Task A was created successfully....\\r\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\tuart_data<span class=\"token punctuation\">.</span>COMx <span class=\"token operator\">=</span> EVAL_COM1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t<span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t\t<span class=\"token comment\">/* 延时 800 个 tick */</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t\t<span class=\"token function\">vTaskDelay</span><span class=\"token punctuation\">(</span><span class=\"token number\">800</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t\t<span class=\"token function\">xQueueSend</span><span class=\"token punctuation\">(</span>xQueueUartTx<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>uart_data<span class=\"token punctuation\">,</span> portMAX_DELAY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre></pre></td></tr><tr><td data-num=\"81\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">vSender2_Task</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>pvParameters <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre><span class=\"token punctuation\">&#123;</span>\t</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\tUartTx_Buff_TypeDef uart_data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t<span class=\"token function\">strcpy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>uart_data<span class=\"token punctuation\">.</span>TxBuffer<span class=\"token punctuation\">,</span><span class=\"token string\">\"TaskB Running\\r\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>\tuart_data<span class=\"token punctuation\">.</span>TxCounter <span class=\"token operator\">=</span> <span class=\"token function\">strlen</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"TaskB running\\r\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Task B was created successfully....\\r\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>\tuart_data<span class=\"token punctuation\">.</span>COMx <span class=\"token operator\">=</span> EVAL_COM1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>\t<span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>\t\t<span class=\"token comment\">/* 延时 800 个 tick */</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>\t\t<span class=\"token function\">vTaskDelay</span><span class=\"token punctuation\">(</span><span class=\"token number\">800</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>\t\t<span class=\"token function\">xQueueSend</span><span class=\"token punctuation\">(</span>xQueueUartTx<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>uart_data<span class=\"token punctuation\">,</span> portMAX_DELAY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre></pre></td></tr><tr><td data-num=\"98\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">prvUser_Task</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>pvParameters <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre><span class=\"token punctuation\">&#123;</span>\t</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>\t<span class=\"token comment\">/* User-defined private tasks */</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>\t<span class=\"token function\">xTaskCreate</span><span class=\"token punctuation\">(</span> vSender1_Task<span class=\"token punctuation\">,</span> <span class=\"token string\">\"vSender1_Task\"</span><span class=\"token punctuation\">,</span> configMINIMAL_STACK_SIZE <span class=\"token operator\">+</span> <span class=\"token number\">300</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> tskIDLE_PRIORITY<span class=\"token operator\">+</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>\t<span class=\"token function\">xTaskCreate</span><span class=\"token punctuation\">(</span> vSender2_Task<span class=\"token punctuation\">,</span> <span class=\"token string\">\"vSender2_Task\"</span><span class=\"token punctuation\">,</span> configMINIMAL_STACK_SIZE <span class=\"token operator\">+</span> <span class=\"token number\">300</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> tskIDLE_PRIORITY<span class=\"token operator\">+</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"delete user task\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>\t<span class=\"token function\">vTaskDelete</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">// 删除自己</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre></pre></td></tr><tr><td data-num=\"108\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">prvSetupHardware</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>\t<span class=\"token comment\">/* Start with the clocks in their expected state. */</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>\t<span class=\"token function\">RCC_DeInit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>\t<span class=\"token comment\">/* Enable HSE (high speed external clock). */</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>\t<span class=\"token function\">RCC_HSEConfig</span><span class=\"token punctuation\">(</span> RCC_HSE_ON <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>\t<span class=\"token comment\">/* Wait till HSE is ready. */</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>\t<span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span> <span class=\"token function\">RCC_GetFlagStatus</span><span class=\"token punctuation\">(</span> RCC_FLAG_HSERDY <span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> RESET <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>\t<span class=\"token comment\">/* 2 wait states required on the flash. */</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>\t<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> <span class=\"token number\">0x40022000</span> <span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x02</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>\t<span class=\"token comment\">/* HCLK = SYSCLK */</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>\t<span class=\"token function\">RCC_HCLKConfig</span><span class=\"token punctuation\">(</span> RCC_SYSCLK_Div1 <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>\t<span class=\"token comment\">/* PCLK2 = HCLK */</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>\t<span class=\"token function\">RCC_PCLK2Config</span><span class=\"token punctuation\">(</span> RCC_HCLK_Div1 <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>\t<span class=\"token comment\">/* PCLK1 = HCLK/2 */</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>\t<span class=\"token function\">RCC_PCLK1Config</span><span class=\"token punctuation\">(</span> RCC_HCLK_Div2 <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>\t<span class=\"token comment\">/* PLLCLK = 8MHz * 9 = 72 MHz. */</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>\t<span class=\"token function\">RCC_PLLConfig</span><span class=\"token punctuation\">(</span> RCC_PLLSource_HSE_Div1<span class=\"token punctuation\">,</span> RCC_PLLMul_9 <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>\t<span class=\"token comment\">/* Enable PLL. */</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>\t<span class=\"token function\">RCC_PLLCmd</span><span class=\"token punctuation\">(</span> ENABLE <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>\t<span class=\"token comment\">/* Wait till PLL is ready. */</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>\t<span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token function\">RCC_GetFlagStatus</span><span class=\"token punctuation\">(</span>RCC_FLAG_PLLRDY<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> RESET<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>\t<span class=\"token comment\">/* Select PLL as system clock source. */</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>\t<span class=\"token function\">RCC_SYSCLKConfig</span><span class=\"token punctuation\">(</span> RCC_SYSCLKSource_PLLCLK <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>\t<span class=\"token comment\">/* Wait till PLL is used as system clock source. */</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>\t<span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span> <span class=\"token function\">RCC_GetSYSCLKSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0x08</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>\t<span class=\"token comment\">/* Configure HCLK clock as SysTick clock source. */</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>\t<span class=\"token function\">SysTick_CLKSourceConfig</span><span class=\"token punctuation\">(</span> SysTick_CLKSource_HCLK <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"155\"></td><td><pre>\t<span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"156\"></td><td><pre>\t * STM32 中断优先级分组为 4，即 4bit 都用来表示抢占优先级，范围为：0~15</pre></td></tr><tr><td data-num=\"157\"></td><td><pre>\t * 优先级分组只需要分组一次即可，以后如果有其他的任务需要用到中断，</pre></td></tr><tr><td data-num=\"158\"></td><td><pre>\t * 都统一用这个优先级分组，千万不要再分组，切忌。</pre></td></tr><tr><td data-num=\"159\"></td><td><pre>\t */</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>\t<span class=\"token function\">NVIC_PriorityGroupConfig</span><span class=\"token punctuation\">(</span> NVIC_PriorityGroup_4 <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"162\"></td><td><pre>\t<span class=\"token comment\">/* Other peripheral configuration */</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre><span class=\"token comment\">//\tvSetupTimer();</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>\t<span class=\"token function\">vSetupUSART</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>\t<span class=\"token function\">vSetupParPort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre></pre></td></tr><tr><td data-num=\"168\"></td><td><pre><span class=\"token comment\">/*----------------------------- End -----------------------------*/</span></pre></td></tr></table></figure><p>由总工程上看到，我们主要创建了两个 task 作为队列的发送；为什么要多此一举用队列来传输打印数据，而不直接调用  <code>printf</code>  函数输出呢？在 RTOS 应用中，我们知道每个任务都相当于是独立的，这样就会出现一种情况就是，Task A 在打印输出数据，而刚好 Task B 也要打印数据，那么在同一时间，输出的数据就可能出现叠加或者丢包乱码了；为了试验一下，所以在代码中把 Task A 和 Task B 的运行例子设计成一样，包括优先级；另外添加像我们以前没用 RTOS 一样直接打印数据，看会有什么情况，然后再贴上队列接收的任务：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"><span>bsp_uart.c</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"bsp_uart.h\"</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">/* Scheduler includes. */</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"FreeRTOS.h\"</span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"task.h\"</span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"queue.h\"</span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">BAUDRATE_1</span>\t\t<span class=\"token expression\"><span class=\"token number\">115200</span><span class=\"token punctuation\">;</span>\t\t\t</span><span class=\"token comment\">// 波特率设置\t支持的波特率：115200,19200,9600,38400,57600,1200,2400,4800</span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">BAUDRATE_2</span>\t\t<span class=\"token expression\"><span class=\"token number\">115200</span><span class=\"token punctuation\">;</span>\t\t\t</span><span class=\"token comment\">// 波特率设置\t支持的波特率：115200,19200,9600,38400,57600,1200,2400,4800</span></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>QueueHandle_t xQueueUartTx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">prvUartTx_Task</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>pvParameters <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tUartTx_Buff_TypeDef uart_data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">;</span> <span class=\"token punctuation\">;</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">xQueueReceive</span><span class=\"token punctuation\">(</span>xQueueUartTx<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>uart_data<span class=\"token punctuation\">,</span> portMAX_DELAY<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> pdPASS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>uart_data<span class=\"token punctuation\">.</span>TxBuffer <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"len = %d\\n\"</span><span class=\"token punctuation\">,</span>uart_data<span class=\"token punctuation\">.</span>TxCounter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t\t\t<span class=\"token function\">USART_SendString</span><span class=\"token punctuation\">(</span>uart_data<span class=\"token punctuation\">.</span>COMx<span class=\"token punctuation\">,</span> uart_data<span class=\"token punctuation\">.</span>TxBuffer<span class=\"token punctuation\">,</span> uart_data<span class=\"token punctuation\">.</span>TxCounter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\">/************************************************</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>函数名称 ： vSetupUSART</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>功    能 ： UART 初始化接口</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>参    数 ： 无</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">vSetupUSART</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t<span class=\"token function\">UART1_Config</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token comment\">//\tUART2_Config();</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t<span class=\"token comment\">/* Create the queue used by the Usart task. */</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\txQueueUartTx <span class=\"token operator\">=</span> <span class=\"token function\">xQueueCreate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> portBASE_TYPE<span class=\"token punctuation\">)</span>UART_QUEUE_TX_LENGTH<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>UartTx_Buff_TypeDef<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t<span class=\"token comment\">// 目标队列的句柄</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token comment\">//\txQueueUart1_Rx = xQueueCreate ((unsigned portBASE_TYPE) UART_QUEUE_RX_LENGTH, sizeof (UartRx_Buff_TypeDef));\t// 目标队列的句柄</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\txQueueUart1_Rx <span class=\"token operator\">=</span> <span class=\"token function\">xQueueCreate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> portBASE_TYPE<span class=\"token punctuation\">)</span><span class=\"token number\">20</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">uint8_t</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t<span class=\"token comment\">// 目标队列的句柄</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t<span class=\"token function\">xTaskCreate</span><span class=\"token punctuation\">(</span> prvUartTx_Task<span class=\"token punctuation\">,</span> <span class=\"token string\">\"prvUartTx_Task\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">300</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> tskIDLE_PRIORITY <span class=\"token operator\">+</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t<span class=\"token function\">xTaskCreate</span><span class=\"token punctuation\">(</span> prvUart1_Rx_Task<span class=\"token punctuation\">,</span> <span class=\"token string\">\"prvUart1_Rx_Task\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">500</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> tskIDLE_PRIORITY <span class=\"token operator\">+</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token comment\">/************************************************</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>函数名称 ： UART1_Config</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>功    能 ： UART1 端口配置</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>参    数 ： 无</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">UART1_Config</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    GPIO_InitTypeDef GPIO_InitStructure<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    NVIC_InitTypeDef NVIC_InitStructure<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    USART_InitTypeDef USART_InitStructure<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    <span class=\"token comment\">/* config GPIOA clock */</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    <span class=\"token function\">RCC_APB2PeriphClockCmd</span><span class=\"token punctuation\">(</span>RCC_APB2Periph_GPIOA<span class=\"token punctuation\">,</span> ENABLE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    <span class=\"token comment\">/* config USART1 clock */</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token function\">RCC_APB2PeriphClockCmd</span><span class=\"token punctuation\">(</span>RCC_APB2Periph_USART1<span class=\"token punctuation\">,</span> ENABLE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    <span class=\"token comment\">/* USART1 GPIO config */</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token comment\">/* Configure USART1 Tx (PA.09) as alternate function push-pull */</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    GPIO_InitStructure<span class=\"token punctuation\">.</span>GPIO_Pin <span class=\"token operator\">=</span> GPIO_Pin_9<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    GPIO_InitStructure<span class=\"token punctuation\">.</span>GPIO_Mode <span class=\"token operator\">=</span> GPIO_Mode_AF_PP<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    GPIO_InitStructure<span class=\"token punctuation\">.</span>GPIO_Speed <span class=\"token operator\">=</span> GPIO_Speed_50MHz<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    <span class=\"token function\">GPIO_Init</span><span class=\"token punctuation\">(</span>GPIOA<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>GPIO_InitStructure<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    <span class=\"token comment\">/* Configure USART1 Rx (PA.10) as input floating */</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    GPIO_InitStructure<span class=\"token punctuation\">.</span>GPIO_Pin <span class=\"token operator\">=</span> GPIO_Pin_10<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>    GPIO_InitStructure<span class=\"token punctuation\">.</span>GPIO_Mode <span class=\"token operator\">=</span> GPIO_Mode_IN_FLOATING<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>    <span class=\"token function\">GPIO_Init</span><span class=\"token punctuation\">(</span>GPIOA<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>GPIO_InitStructure<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>    <span class=\"token comment\">/* Enable the USART1 Interrupt */</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>    NVIC_InitStructure<span class=\"token punctuation\">.</span>NVIC_IRQChannel <span class=\"token operator\">=</span> USART1_IRQn<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\tNVIC_InitStructure<span class=\"token punctuation\">.</span>NVIC_IRQChannelPreemptionPriority <span class=\"token operator\">=</span> <span class=\"token number\">7</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>    NVIC_InitStructure<span class=\"token punctuation\">.</span>NVIC_IRQChannelSubPriority <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>    NVIC_InitStructure<span class=\"token punctuation\">.</span>NVIC_IRQChannelCmd <span class=\"token operator\">=</span> ENABLE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>    <span class=\"token function\">NVIC_Init</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>NVIC_InitStructure<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>    <span class=\"token comment\">/* USART1 mode config */</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>    USART_InitStructure<span class=\"token punctuation\">.</span>USART_BaudRate <span class=\"token operator\">=</span> BAUDRATE_1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>    USART_InitStructure<span class=\"token punctuation\">.</span>USART_WordLength <span class=\"token operator\">=</span> USART_WordLength_8b<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>    USART_InitStructure<span class=\"token punctuation\">.</span>USART_StopBits <span class=\"token operator\">=</span> USART_StopBits_1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>    USART_InitStructure<span class=\"token punctuation\">.</span>USART_Parity <span class=\"token operator\">=</span> USART_Parity_No <span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>    USART_InitStructure<span class=\"token punctuation\">.</span>USART_HardwareFlowControl <span class=\"token operator\">=</span> USART_HardwareFlowControl_None<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>    USART_InitStructure<span class=\"token punctuation\">.</span>USART_Mode <span class=\"token operator\">=</span> USART_Mode_Rx <span class=\"token operator\">|</span> USART_Mode_Tx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>    <span class=\"token function\">USART_Init</span><span class=\"token punctuation\">(</span>EVAL_COM1<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>USART_InitStructure<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>\t<span class=\"token function\">USART_ITConfig</span><span class=\"token punctuation\">(</span>EVAL_COM1<span class=\"token punctuation\">,</span> USART_IT_RXNE<span class=\"token punctuation\">,</span> ENABLE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>    <span class=\"token function\">USART_Cmd</span><span class=\"token punctuation\">(</span>EVAL_COM1<span class=\"token punctuation\">,</span> ENABLE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre></pre></td></tr><tr><td data-num=\"100\"></td><td><pre><span class=\"token comment\">/************************************************</pre></td></tr><tr><td data-num=\"101\"></td><td><pre>函数名称 ： USART_SendByte</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>功    能 ： 串口字符发送</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>参    数 ： c ---- 发送的数据</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">USART_SendByte</span><span class=\"token punctuation\">(</span> USART_TypeDef<span class=\"token operator\">*</span> USARTx<span class=\"token punctuation\">,</span> <span class=\"token class-name\">uint8_t</span> c <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre><span class=\"token punctuation\">&#123;</span>     </pre></td></tr><tr><td data-num=\"108\"></td><td><pre>\t<span class=\"token function\">USART_SendData</span><span class=\"token punctuation\">(</span>USARTx<span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"110\"></td><td><pre>\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token function\">USART_GetFlagStatus</span><span class=\"token punctuation\">(</span>USARTx<span class=\"token punctuation\">,</span> USART_FLAG_TXE<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> RESET<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre></pre></td></tr><tr><td data-num=\"113\"></td><td><pre><span class=\"token comment\">/************************************************</pre></td></tr><tr><td data-num=\"114\"></td><td><pre>函数名称 ： USART_SendString</pre></td></tr><tr><td data-num=\"115\"></td><td><pre>功    能 ： 串口字符串发送</pre></td></tr><tr><td data-num=\"116\"></td><td><pre>参    数 ： USARTx ---- 串口</pre></td></tr><tr><td data-num=\"117\"></td><td><pre>\t\t\tpData ---- 字符串</pre></td></tr><tr><td data-num=\"118\"></td><td><pre>\t\t\tLength ---- 长度</pre></td></tr><tr><td data-num=\"119\"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num=\"120\"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">USART_SendString</span><span class=\"token punctuation\">(</span> USART_TypeDef<span class=\"token operator\">*</span> USARTx<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token class-name\">uint8_t</span> <span class=\"token operator\">*</span>pData<span class=\"token punctuation\">,</span> <span class=\"token class-name\">uint16_t</span> Length <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>    <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span>Length<span class=\"token operator\">--</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>        <span class=\"token function\">USART_SendByte</span><span class=\"token punctuation\">(</span>USARTx<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>pData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>        pData<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre></pre></td></tr><tr><td data-num=\"130\"></td><td><pre><span class=\"token comment\">/************************************************</pre></td></tr><tr><td data-num=\"131\"></td><td><pre>函数名称 ： USART_Printf</pre></td></tr><tr><td data-num=\"132\"></td><td><pre>功    能 ： 串口打印输出</pre></td></tr><tr><td data-num=\"133\"></td><td><pre>参    数 ： USARTx ---- 串口</pre></td></tr><tr><td data-num=\"134\"></td><td><pre>\t\t\tString\t---- 字符串</pre></td></tr><tr><td data-num=\"135\"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num=\"136\"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">USART_Printf</span><span class=\"token punctuation\">(</span> USART_TypeDef<span class=\"token operator\">*</span> USARTx<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>String <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>    <span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>        <span class=\"token function\">USART_SendByte</span><span class=\"token punctuation\">(</span>USARTx<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>String<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>        String<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>String<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token char\">'\\0'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre></pre></td></tr><tr><td data-num=\"146\"></td><td><pre><span class=\"token comment\">/************************************************</pre></td></tr><tr><td data-num=\"147\"></td><td><pre>函数名称 ： fputc</pre></td></tr><tr><td data-num=\"148\"></td><td><pre>功    能 ： 重定向 c 库函数 printf 到 DEBUG_UART</pre></td></tr><tr><td data-num=\"149\"></td><td><pre>参    数 ： ch</pre></td></tr><tr><td data-num=\"150\"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num=\"151\"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">fputc</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> ch<span class=\"token punctuation\">,</span> FILE <span class=\"token operator\">*</span>f<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>    <span class=\"token comment\">/* 发送一个字节数据到 DEBUG_UART */</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>    <span class=\"token function\">USART_SendData</span><span class=\"token punctuation\">(</span>DEBUG_UART<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">uint8_t</span><span class=\"token punctuation\">)</span> ch<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>    <span class=\"token comment\">/* 等待发送完毕 */</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token function\">USART_GetFlagStatus</span><span class=\"token punctuation\">(</span>DEBUG_UART<span class=\"token punctuation\">,</span> USART_FLAG_TXE<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> RESET<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>ch<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre></pre></td></tr><tr><td data-num=\"163\"></td><td><pre><span class=\"token comment\">/************************************************</pre></td></tr><tr><td data-num=\"164\"></td><td><pre>函数名称 ： fgetc</pre></td></tr><tr><td data-num=\"165\"></td><td><pre>功    能 ： 重定向 c 库函数 scanf 到 DEBUG_UART</pre></td></tr><tr><td data-num=\"166\"></td><td><pre>参    数 ： f ---- 文件</pre></td></tr><tr><td data-num=\"167\"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num=\"168\"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">fgetc</span><span class=\"token punctuation\">(</span>FILE <span class=\"token operator\">*</span>f<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>    <span class=\"token comment\">/* 等待 DEBUG_UART 输入数据 */</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token function\">USART_GetFlagStatus</span><span class=\"token punctuation\">(</span>DEBUG_UART<span class=\"token punctuation\">,</span> USART_FLAG_RXNE<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> RESET<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token function\">USART_ReceiveData</span><span class=\"token punctuation\">(</span>DEBUG_UART<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"176\"></td><td><pre></pre></td></tr><tr><td data-num=\"177\"></td><td><pre></pre></td></tr><tr><td data-num=\"178\"></td><td><pre><span class=\"token comment\">/*---------------------------- END OF FILE ----------------------------*/</span></pre></td></tr></table></figure><figure class=\"highlight c\"><figcaption data-lang=\"c\"><span>bsp_uart.h</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifndef</span> <span class=\"token expression\">__BSP_UART_H</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">__BSP_UART_H</span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"stm32f10x.h\"</span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">DEBUG_UART</span>\t\t\t\t<span class=\"token expression\">USART1</span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">EVAL_COM1</span>\t\t\t\t<span class=\"token expression\">USART1</span></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">EVAL_COM2</span>\t\t\t\t<span class=\"token expression\">USART2</span></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">USART1_RX_DMA_CHANNEL</span>\t<span class=\"token expression\">DMA1_Channel5</span></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">USART2_RX_DMA_CHANNEL</span>\t<span class=\"token expression\">DMA1_Channel6</span></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">TxBUFFER_SIZE</span>  \t \t\t<span class=\"token expression\"><span class=\"token number\">100</span></span></span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">RxBUFFER_SIZE</span>  \t\t \t<span class=\"token expression\"><span class=\"token number\">100</span></span></span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">UART_QUEUE_RX_LENGTH</span>\t<span class=\"token expression\"><span class=\"token number\">2</span></span></span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">UART_QUEUE_TX_LENGTH</span>\t<span class=\"token expression\"><span class=\"token number\">2</span></span></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token class-name\">uint8_t</span> Receiving_Time<span class=\"token punctuation\">;</span>\t\t\t\t\t<span class=\"token comment\">// 接收时间</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token class-name\">uint8_t</span> Frame_flag<span class=\"token punctuation\">;</span>\t\t\t\t\t\t<span class=\"token comment\">// 一帧完成标志</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span>EVAL_COMx_TypeDef<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token class-name\">uint8_t</span> RxBuffer<span class=\"token punctuation\">[</span>RxBUFFER_SIZE<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">// 接收暂存缓冲区</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t__IO <span class=\"token class-name\">uint8_t</span> RxCounter<span class=\"token punctuation\">;</span>\t\t\t\t\t<span class=\"token comment\">// 接收数据个数</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">&#125;</span>UartRx_Buff_TypeDef<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token class-name\">uint8_t</span> TxBuffer<span class=\"token punctuation\">[</span>TxBUFFER_SIZE<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">// 发送暂存缓冲区</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t__IO <span class=\"token class-name\">uint8_t</span> TxCounter<span class=\"token punctuation\">;</span>\t\t\t\t\t<span class=\"token comment\">// 发送数据个数</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\tUSART_TypeDef<span class=\"token operator\">*</span> COMx<span class=\"token punctuation\">;</span>\t\t\t\t\t<span class=\"token comment\">// 串口号</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">&#125;</span>UartTx_Buff_TypeDef<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">vSetupUSART</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">UART1_Config</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">UART2_Config</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">USART_SendByte</span><span class=\"token punctuation\">(</span> USART_TypeDef<span class=\"token operator\">*</span> USARTx<span class=\"token punctuation\">,</span> <span class=\"token class-name\">uint8_t</span> c <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">USART_SendString</span><span class=\"token punctuation\">(</span> USART_TypeDef<span class=\"token operator\">*</span> USARTx<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token class-name\">uint8_t</span> <span class=\"token operator\">*</span>pData<span class=\"token punctuation\">,</span> <span class=\"token class-name\">uint16_t</span> Length <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">USART_Printf</span><span class=\"token punctuation\">(</span> USART_TypeDef<span class=\"token operator\">*</span> USARTx<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>String <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span>\t<span class=\"token comment\">/* __BSP_UART_H */</span></span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token comment\">/*---------------------------- END OF FILE ----------------------------*/</span></pre></td></tr></table></figure><p>其实对照之前的 <a href=\"https://blog.csdn.net/qq_42992084/article/details/104098531\">STM32 笔记之 USART（串口）</a> 改动并不大，只是分开处理一下，并且以任务的形式封装起来。</p>\n<p>最后我们可以看一下他的测试结果：</p>\n<p><img src=\"2020022014051323.png\" alt=\"img\" /></p>\n<p>从结果中可以看到，若是直接用 printf 输出，因为两个相同优先级的任务在同一时间输出数据，结果出现了数据叠加（这并不是我们想要的结果），而后面以队列的形式进行输出，数据是可以按照正常打印的（哪怕他们的任务优先级一样，并且运行的流程一样，他都分布好数据位置一并打印；后面测了一下，任务优先级相同，发现会按着任务创建的顺序来处理的；还有其他一些小测试，也会有很多不同的结果，具体可以自己试着探究），这里主要想说的是：为了避免在 RTOS 中多个任务同时访问公用数据（或者同一硬件），最好用队列或者利用后面要说的互斥量等来处理数据（根据实际需求用哪个）。</p>\n<p>多任务系统中存在一种潜在的风险。当一个任务在使用某个资源的过程中，即还没有完全结束对资源的访问时，便被切出运行态，使得资源处于非一致，不完整的状态。如果这个时候有另一个任务或者中断来访问这个资源，则会导致数据损坏或是其它相似的错误，也就是像上面的一开始打印出错那样。</p>\n",
            "tags": [
                "history",
                "FreeRTOS",
                "RTOS"
            ]
        },
        {
            "id": "https://arachnid.cc/freertos-task/",
            "url": "https://arachnid.cc/freertos-task/",
            "title": "FreeRTOS 篇章之任务管理",
            "date_published": "2020-02-17T10:07:18.000Z",
            "content_html": "<h1 id=\"任务状态\"><a class=\"anchor\" href=\"#任务状态\">#</a> 任务状态</h1>\n<p>任务目前存在四种状态，分为：运行、就绪、阻塞、挂起；</p>\n<ol>\n<li><strong>Running — 运行态</strong><br />\n这是任务在执行的时候的状态，处在运行态意味着任务获得 CPU 的使用权，对于单核 CPU，此时不存在其他运行态的任务。</li>\n<li><strong>Ready — 就绪态</strong><br />\n处在就绪态意味着这个任务是可以执行的，比如某个事件发生、队列数据到来、所请求的资源有效等；但是，因为此时有一个相同优先级或者更高优先级的任务正在运行，此时任务无法执行而处于就绪态。</li>\n<li><strong>Blocked — 阻塞态</strong><br />\n如果一个任务正在等待一个时间到来或者外部的事件到来，比如一个调用  <code>vTaskDelay()</code>  函数的任务，在延时时间到来之前，任务将处在阻塞状态。当然，任务在等待队列、信号量、事件组、通知、信号量事件时都会处在阻塞态。通常，这些等待都会设置一个超时 timeout 时间，当等待超时是将任务从阻塞态退出，防止任务被无限挂起。处在阻塞态的任务不占用任何 CPU 时间。</li>\n<li><strong>Suspended — 挂起态</strong><br />\n挂起态无法进入运行态，同时不像阻塞态有超时时间，挂起态无超时时间，除非调用  <code>vTaskResume()</code>  推出挂起态。相应的调用  <code>vTaskSuspend()</code>  将一个任务挂起。挂起态可以描述成 “冻结”；除非 “解冻”，否则无法再有机会被执行到。</li>\n</ol>\n<p>它们的状态关系图：</p>\n<p><img src=\"20200228151607721.png\" alt=\"img\" /></p>\n<h1 id=\"任务优先级\"><a class=\"anchor\" href=\"#任务优先级\">#</a> 任务优先级</h1>\n<p>每个任务在创建的时候都要指定一个从  <code>0</code>  到  <code>configMAX_PRIORITIES - 1</code>  的优先级，与其他 RTOS 不同之处在于，优先级数值越大，优先级越低。 <code>configMAX_PRIORITIES</code>  定义在  <code>freeRTOSConfig.h</code>  头文件中。</p>\n<p><code>configMAX_PRIORITIES</code>  的值可以是任意值，也就是说 FreeRTOS 的任务数量不受限制。事实上，因为 FreeRTOS 允许任务共享同一个优先级， <code>configMAX_PRIORITIES</code>  的大小不会限制到任务数量。但是对于实际应用来说，因为 FreeRTOS 中即使未用到的优先级，任然会占用一定的内存，因此优先级的最大数值，应与实际应用贴近。</p>\n<p>在  <code>freeRTOSConfig.h</code>  头文件中，定义了  <code>configUSE_PORT_OPTIMISED_TASK_SELECTION</code>  ，拥有某些存在任务选择优化机制的架构，此时最大优先级不能超过 32。</p>\n<p>FreeRTOS 中的空闲任务 IDEL Task 总是最低优先级，因此它的优先级为 0。</p>\n<p>FreeRTOS 的调度器总是确保当前得到 CPU 时间的任务的优先级是最高的，换句话说，就绪态中高优先级的任务，总是会优先进入运行态。</p>\n<p>对于共用同一优先级的任务，如果  <code>configUSE_TIME_SLICING</code>  未定义或者定义为  <code>1</code>  , 则 FreeRTOS 将使用时间片轮询的机制去调度这些任务。</p>\n<p>跟多具体的配置信息可以去看 <a href=\"https://arachnid.cc/docs/RTOS/FreeRTOS%20%E7%AF%87%E7%AB%A0%E4%B9%8B%20FreeRTOSConfig.h%E5%88%86%E6%9E%90/\">FreeRTOS 篇章之 FreeRTOSConfig.h 分析</a> 。</p>\n<h1 id=\"任务创建-xtaskcreate\"><a class=\"anchor\" href=\"#任务创建-xtaskcreate\">#</a> 任务创建 - xTaskCreate ()</h1>\n<p>xTaskCreate () API 函数原型实现：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span><span class=\"token expression\"><span class=\"token punctuation\">(</span> configSUPPORT_DYNAMIC_ALLOCATION <span class=\"token operator\">==</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tBaseType_t <span class=\"token function\">xTaskCreate</span><span class=\"token punctuation\">(</span>\tTaskFunction_t pxTaskCode<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">const</span> pcName<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">const</span> <span class=\"token keyword\">uint16_t</span> usStackDepth<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">void</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">const</span> pvParameters<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t\t\tUBaseType_t uxPriority<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t\t\tTaskHandle_t <span class=\"token operator\">*</span> <span class=\"token keyword\">const</span> pxCreatedTask <span class=\"token punctuation\">)</span> <span class=\"token comment\">/*lint !e971 Unqualified char types are allowed for strings and single characters only. */</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tTCB_t <span class=\"token operator\">*</span>pxNewTCB<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tBaseType_t xReturn<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t<span class=\"token comment\">/* If the stack grows down then allocate the stack then the TCB so the stack</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tdoes not grow into the TCB.  Likewise if the stack grows up then allocate</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\tthe TCB then the stack. */</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span><span class=\"token expression\"><span class=\"token punctuation\">(</span> portSTACK_GROWTH <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t\t<span class=\"token comment\">/* Allocate space for the TCB.  Where the memory comes from depends on</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t\tthe implementation of the port malloc function and whether or not static</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t\tallocation is being used. */</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t\tpxNewTCB <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span> TCB_t <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> <span class=\"token function\">pvPortMalloc</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span> TCB_t <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> pxNewTCB <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t\t\t<span class=\"token comment\">/* Allocate space for the stack used by the task being created.</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t\t\tThe base of the stack memory stored in the TCB so the task can</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t\t\tbe deleted later if required. */</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t\t\tpxNewTCB<span class=\"token operator\">-></span>pxStack <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span> StackType_t <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> <span class=\"token function\">pvPortMalloc</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> size_t <span class=\"token punctuation\">)</span> usStackDepth <span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span> StackType_t <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">/*lint !e961 MISRA exception as the casts are only redundant for some ports. */</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> pxNewTCB<span class=\"token operator\">-></span>pxStack <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t\t\t\t<span class=\"token comment\">/* Could not allocate the stack.  Delete the allocated TCB. */</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">vPortFree</span><span class=\"token punctuation\">(</span> pxNewTCB <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t\t\t\tpxNewTCB <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">else</span> <span class=\"token comment\">/* portSTACK_GROWTH */</span></span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\tStackType_t <span class=\"token operator\">*</span>pxStack<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t\t<span class=\"token comment\">/* Allocate space for the stack used by the task being created. */</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t\tpxStack <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span> StackType_t <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> <span class=\"token function\">pvPortMalloc</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> size_t <span class=\"token punctuation\">)</span> usStackDepth <span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span> StackType_t <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">/*lint !e961 MISRA exception as the casts are only redundant for some ports. */</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> pxStack <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\t\t\t<span class=\"token comment\">/* Allocate space for the TCB. */</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t\t\t\tpxNewTCB <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span> TCB_t <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> <span class=\"token function\">pvPortMalloc</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span> TCB_t <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">/*lint !e961 MISRA exception as the casts are only redundant for some paths. */</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> pxNewTCB <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\t\t\t\t<span class=\"token comment\">/* Store the stack location in the TCB. */</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\t\t\t\tpxNewTCB<span class=\"token operator\">-></span>pxStack <span class=\"token operator\">=</span> pxStack<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t\t\t\t\t<span class=\"token comment\">/* The stack cannot be used as the TCB was not created.  Free</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t\t\t\t\tit again. */</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">vPortFree</span><span class=\"token punctuation\">(</span> pxStack <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t\t\t\tpxNewTCB <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t\t<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span> <span class=\"token comment\">/* portSTACK_GROWTH */</span></span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> pxNewTCB <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t\t\t<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span><span class=\"token expression\"><span class=\"token punctuation\">(</span> tskSTATIC_AND_DYNAMIC_ALLOCATION_POSSIBLE <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t\t\t\t<span class=\"token comment\">/* Tasks can be created statically or dynamically, so note this</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t\t\t\ttask was created dynamically in case it is later deleted. */</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t\t\t\tpxNewTCB<span class=\"token operator\">-></span>ucStaticallyAllocated <span class=\"token operator\">=</span> tskDYNAMICALLY_ALLOCATED_STACK_AND_TCB<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t\t\t<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span> <span class=\"token comment\">/* configSUPPORT_STATIC_ALLOCATION */</span></span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t\t\t<span class=\"token function\">prvInitialiseNewTask</span><span class=\"token punctuation\">(</span> pxTaskCode<span class=\"token punctuation\">,</span> pcName<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">uint32_t</span> <span class=\"token punctuation\">)</span> usStackDepth<span class=\"token punctuation\">,</span> pvParameters<span class=\"token punctuation\">,</span> uxPriority<span class=\"token punctuation\">,</span> pxCreatedTask<span class=\"token punctuation\">,</span> pxNewTCB<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t\t\t<span class=\"token function\">prvAddNewTaskToReadyList</span><span class=\"token punctuation\">(</span> pxNewTCB <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t\t\txReturn <span class=\"token operator\">=</span> pdPASS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t\t\txReturn <span class=\"token operator\">=</span> errCOULD_NOT_ALLOCATE_REQUIRED_MEMORY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> xReturn<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre></pre></td></tr><tr><td data-num=\"91\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span> <span class=\"token comment\">/* configSUPPORT_DYNAMIC_ALLOCATION */</span></span></pre></td></tr></table></figure><p>可以看到，该函数是受宏  <code>configSUPPORT_DYNAMIC_ALLOCATION</code>  控制的，该宏位于  <code>FreeRTOSConfig.h</code>  文件中。</p>\n<p>传入参数：</p>\n<ul>\n<li><strong>pvTaskCode</strong>：指向任务函数入口的指针，是一个永不退出的 C 函数，实现常通常是一个死循环。</li>\n<li><strong>pcName</strong>：具有描述性的任务名。这个参数不会被 FreeRTOS 使用，其只是单纯地用于辅助调试；通过定义常量  <code>config_MAX_TASK_NAME_LEN</code>  来定义任务名的最大长度（包括  <code>\\0</code>  结束符），该宏位于  <code>FreeRTOSConfig.h</code>  文件中。</li>\n<li><strong>usStackDepth</strong>：当任务创建时，用于告诉内核为它分配多大的栈空间，这个值指定的是栈空间可以保存多少个字（word），而不是多少个字节（byte）。</li>\n<li><strong>pvParameters</strong>：任务函数接受一个指向 void 的指针（void *），即是传递到任务中的值。</li>\n<li><strong>uxPriority</strong>：用于指定任务执行的优先级。优先级的取值范围可以从最低优先级 (  <code>0</code>  ) 到最高优先级 (  <code>configMAX_PRIORITIES – 1</code>  )； <code>configMAX_PRIORITIES</code>  是一个由用户定义的常量，该宏位于  <code>FreeRTOSConfig.h</code>  文件中。</li>\n<li><strong>pxCreatedTask</strong>：用于传出任务的句柄。这个句柄将在 API 调用中对该创建出来的任务进行引用，比如改变任务优先级，或者删除任务；如果应用程序中不会用到这个任务的句柄，则  <code>pxCreatedTask</code>  可以被设为 NULL。</li>\n</ul>\n<p>返回参数（有两个可能的返回值）：</p>\n<ul>\n<li><strong>pdTRUE</strong>：表明任务创建成功。</li>\n<li><strong>errCOULD_NOT_ALLOCATE_REQUIRED_MEMORY</strong>：由于内存堆空间不足，FreeRTOS 无法分配足够的空间来保存任务结构数据和任务栈，而无法创建任务。</li>\n</ul>\n<h1 id=\"任务删除-vtaskdelete\"><a class=\"anchor\" href=\"#任务删除-vtaskdelete\">#</a> 任务删除 - vTaskDelete ()</h1>\n<p>vTaskDelete () API 函数原型实现：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token punctuation\">(</span> INCLUDE_vTaskDelete <span class=\"token operator\">==</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token keyword\">void</span> <span class=\"token function\">vTaskDelete</span><span class=\"token punctuation\">(</span> TaskHandle_t xTaskToDelete <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tTCB_t <span class=\"token operator\">*</span>pxTCB<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t<span class=\"token function\">taskENTER_CRITICAL</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t\t<span class=\"token comment\">/* If null is passed in here then it is the calling task that is</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t\tbeing deleted. */</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t\tpxTCB <span class=\"token operator\">=</span> <span class=\"token function\">prvGetTCBFromHandle</span><span class=\"token punctuation\">(</span> xTaskToDelete <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t\t<span class=\"token comment\">/* Remove task from the ready list. */</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> <span class=\"token function\">uxListRemove</span><span class=\"token punctuation\">(</span> <span class=\"token operator\">&amp;</span><span class=\"token punctuation\">(</span> pxTCB<span class=\"token operator\">-></span>xStateListItem <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token punctuation\">(</span> UBaseType_t <span class=\"token punctuation\">)</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t\t\t<span class=\"token function\">taskRESET_READY_PRIORITY</span><span class=\"token punctuation\">(</span> pxTCB<span class=\"token operator\">-></span>uxPriority <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t\t\t<span class=\"token function\">mtCOVERAGE_TEST_MARKER</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t\t<span class=\"token comment\">/* Is the task waiting on an event also? */</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> <span class=\"token function\">listLIST_ITEM_CONTAINER</span><span class=\"token punctuation\">(</span> <span class=\"token operator\">&amp;</span><span class=\"token punctuation\">(</span> pxTCB<span class=\"token operator\">-></span>xEventListItem <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">)</span> <span class=\"token function\">uxListRemove</span><span class=\"token punctuation\">(</span> <span class=\"token operator\">&amp;</span><span class=\"token punctuation\">(</span> pxTCB<span class=\"token operator\">-></span>xEventListItem <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t\t\t<span class=\"token function\">mtCOVERAGE_TEST_MARKER</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t\t<span class=\"token comment\">/* Increment the uxTaskNumber also so kernel aware debuggers can</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t\tdetect that the task lists need re-generating.  This is done before</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t\tportPRE_TASK_DELETE_HOOK() as in the Windows port that macro will</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t\tnot return. */</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t\tuxTaskNumber<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> pxTCB <span class=\"token operator\">==</span> pxCurrentTCB <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t\t\t<span class=\"token comment\">/* A task is deleting itself.  This cannot complete within the</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t\t\ttask itself, as a context switch to another task is required.</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t\t\tPlace the task in the termination list.  The idle task will</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\t\t\tcheck the termination list and free up any memory allocated by</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t\t\tthe scheduler for the TCB and stack of the deleted task. */</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t\t\t<span class=\"token function\">vListInsertEnd</span><span class=\"token punctuation\">(</span> <span class=\"token operator\">&amp;</span>xTasksWaitingTermination<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span><span class=\"token punctuation\">(</span> pxTCB<span class=\"token operator\">-></span>xStateListItem <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t\t\t\t<span class=\"token comment\">/* Increment the ucTasksDeleted variable so the idle task knows</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\t\t\tthere is a task that has been deleted and that it should therefore</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t\t\t\tcheck the xTasksWaitingTermination list. */</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\t\t\t<span class=\"token operator\">++</span>uxDeletedTasksWaitingCleanUp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\t\t\t<span class=\"token comment\">/* The pre-delete hook is primarily for the Windows simulator,</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\t\t\tin which Windows specific clean up operations are performed,</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\t\t\tafter which it is not possible to yield away from this task -</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\t\t\thence xYieldPending is used to latch that a context switch is</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t\t\t\trequired. */</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t\t\t\t<span class=\"token function\">portPRE_TASK_DELETE_HOOK</span><span class=\"token punctuation\">(</span> pxTCB<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>xYieldPending <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t\t\t\t<span class=\"token operator\">--</span>uxCurrentNumberOfTasks<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t\t\t\t<span class=\"token function\">prvDeleteTCB</span><span class=\"token punctuation\">(</span> pxTCB <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\t\t\t<span class=\"token comment\">/* Reset the next expected unblock time in case it referred to</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t\t\t\tthe task that has just been deleted. */</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t\t\t\t<span class=\"token function\">prvResetNextTaskUnblockTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t\t\t<span class=\"token function\">traceTASK_DELETE</span><span class=\"token punctuation\">(</span> pxTCB <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t\t<span class=\"token function\">taskEXIT_CRITICAL</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t\t<span class=\"token comment\">/* Force a reschedule if it is the currently running task that has just</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t\tbeen deleted. */</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> xSchedulerRunning <span class=\"token operator\">!=</span> pdFALSE <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> pxTCB <span class=\"token operator\">==</span> pxCurrentTCB <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t\t\t\t<span class=\"token function\">configASSERT</span><span class=\"token punctuation\">(</span> uxSchedulerSuspended <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t\t\t\t<span class=\"token function\">portYIELD_WITHIN_API</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\t\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t\t\t\t<span class=\"token function\">mtCOVERAGE_TEST_MARKER</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre></pre></td></tr><tr><td data-num=\"90\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span> <span class=\"token comment\">/* INCLUDE_vTaskDelete */</span></span></pre></td></tr></table></figure><p>同样的，该函数则是受宏  <code>INCLUDE_vTaskDelete</code>  控制的，该宏位于  <code>FreeRTOSConfig.h</code>  文件中。</p>\n<p>传入参数：</p>\n<ul>\n<li><strong>pxTaskToDelete</strong>：被删除任务的句柄（目标任务）。若传入 NULL，则是删除当前执行的任务（即删除自己）。</li>\n</ul>\n<h1 id=\"代码搭建\"><a class=\"anchor\" href=\"#代码搭建\">#</a> 代码搭建</h1>\n<p>任务（task）是在 FreeRTOS 中执行的基本单位，每个 task 都是由一个 C 函数所组成，意思是你需要先定义一個 C 的函数，然後再用  <code>xTaskCreate()</code>  这个 API 來建立一個 task，這個 C 函数有几个特点，它的返回值必須是 void，其中通常是存于无限循环中（while、for），所有关于这个 task 的工作都会在这个无限循环中进行，而且这个函数不会有 return，FreeRTOS 不允許 task 自行结束（使用 return 或执行到函数的最后一行）；task 被建立出來后，它会配置有自己的堆栈空间和 stack variable （就是 function 中定义的变量）。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"><span>main.c</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    FreeRTOS V9.0.0 - Copyright (C) 2016 Real Time Engineers Ltd.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    All rights reserved</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    VISIT http://www.FreeRTOS.org TO ENSURE YOU ARE USING THE LATEST VERSION.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    This file is part of the FreeRTOS distribution.</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    FreeRTOS is free software; you can redistribute it and/or modify it under</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    the terms of the GNU General Public License (version 2) as published by the</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    Free Software Foundation >>>> AND MODIFIED BY &lt;&lt;&lt;&lt; the FreeRTOS exception.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    ***************************************************************************</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    >>!   NOTE: The modification to the GPL is included to allow you to     !&lt;&lt;</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    >>!   distribute a combined work that includes FreeRTOS without being   !&lt;&lt;</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    >>!   obliged to provide the source code for proprietary components     !&lt;&lt;</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    >>!   outside of the FreeRTOS kernel.                                   !&lt;&lt;</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    ***************************************************************************</pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    FreeRTOS is distributed in the hope that it will be useful, but WITHOUT ANY</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    FOR A PARTICULAR PURPOSE.  Full license text is available on the following</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    link: http://www.freertos.org/a00114.html</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    ***************************************************************************</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>     *                                                                       *</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>     *    FreeRTOS provides completely free yet professionally developed,    *</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>     *    robust, strictly quality controlled, supported, and cross          *</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>     *    platform software that is more than just the market leader, it     *</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>     *    is the industry's de facto standard.                               *</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>     *                                                                       *</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>     *    Help yourself get started quickly while simultaneously helping     *</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>     *    to support the FreeRTOS project by purchasing a FreeRTOS           *</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>     *    tutorial book, reference manual, or both:                          *</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>     *    http://www.FreeRTOS.org/Documentation                              *</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>     *                                                                       *</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    ***************************************************************************</pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    http://www.FreeRTOS.org/FAQHelp.html - Having a problem?  Start by reading</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    the FAQ page \"My application does not run, what could be wrong?\".  Have you</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    defined configASSERT()?</pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    http://www.FreeRTOS.org/support - In return for receiving this top quality</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    embedded software for free we request you assist our global community by</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    participating in the support forum.</pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    http://www.FreeRTOS.org/training - Investing in training allows your team to</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    be as productive as possible as early as possible.  Now you can receive</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    FreeRTOS training directly from Richard Barry, CEO of Real Time Engineers</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    Ltd, and the world's leading authority on the world's leading RTOS.</pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    http://www.FreeRTOS.org/plus - A selection of FreeRTOS ecosystem products,</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    including FreeRTOS+Trace - an indispensable productivity tool, a DOS</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    compatible FAT file system, and our tiny thread aware UDP/IP stack.</pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    http://www.FreeRTOS.org/labs - Where new FreeRTOS products go to incubate.</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    Come and try FreeRTOS+TCP, our new open source TCP/IP stack for FreeRTOS.</pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    http://www.OpenRTOS.com - Real Time Engineers ltd. license FreeRTOS to High</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    Integrity Systems ltd. to sell under the OpenRTOS brand.  Low cost OpenRTOS</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    licenses offer ticketed support, indemnification and commercial middleware.</pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    http://www.SafeRTOS.com - High Integrity Systems also provide a safety</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    engineered and independently SIL3 certified version for use in safety and</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    mission critical applications that require provable dependability.</pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    1 tab == 4 spaces!</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>*/</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre></pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre><span class=\"token comment\">/* Standard includes. */</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre></pre></td></tr><tr><td data-num=\"74\"></td><td><pre><span class=\"token comment\">/* Scheduler includes. */</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"FreeRTOS.h\"</span></span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"task.h\"</span></span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"queue.h\"</span></span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre></pre></td></tr><tr><td data-num=\"79\"></td><td><pre><span class=\"token comment\">/* Library includes. */</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"stm32f10x_it.h\"</span></span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre></pre></td></tr><tr><td data-num=\"82\"></td><td><pre><span class=\"token comment\">/* Private app includes. */</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"bsp_uart.h\"</span></span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"bsp_time.h\"</span></span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"bsp_gpio.h\"</span></span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre></pre></td></tr><tr><td data-num=\"87\"></td><td><pre></pre></td></tr><tr><td data-num=\"88\"></td><td><pre><span class=\"token comment\">/*----------------------------- End -----------------------------*/</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre></pre></td></tr><tr><td data-num=\"90\"></td><td><pre><span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"91\"></td><td><pre> * User Private Task.</pre></td></tr><tr><td data-num=\"92\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">prvUser_Task</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>pvParameters <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre></pre></td></tr><tr><td data-num=\"95\"></td><td><pre><span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"96\"></td><td><pre> * Configure the clocks, GPIO and other peripherals as required by the demo.</pre></td></tr><tr><td data-num=\"97\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">prvSetupHardware</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre></pre></td></tr><tr><td data-num=\"100\"></td><td><pre><span class=\"token comment\">/*----------------------------- End -----------------------------*/</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre></pre></td></tr><tr><td data-num=\"102\"></td><td><pre></pre></td></tr><tr><td data-num=\"103\"></td><td><pre><span class=\"token comment\">/************************************************</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>函数名称 ： main</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>功    能 ： 主函数入口</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>参    数 ： 无</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num=\"108\"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifdef</span> <span class=\"token expression\">DEBUG</span></span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>  <span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>\t<span class=\"token function\">prvSetupHardware</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>\t<span class=\"token comment\">/* Start the tasks defined within this file/specific to this demo. */</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>\t<span class=\"token function\">xTaskCreate</span><span class=\"token punctuation\">(</span> prvUser_Task<span class=\"token punctuation\">,</span> <span class=\"token string\">\"prvUser_Task\"</span><span class=\"token punctuation\">,</span> configMINIMAL_STACK_SIZE<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> tskIDLE_PRIORITY<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>\t<span class=\"token comment\">/* Start the scheduler. */</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>\t<span class=\"token function\">vTaskStartScheduler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>\t<span class=\"token comment\">/* Will only get here if there was not enough heap space to create the</pre></td></tr><tr><td data-num=\"124\"></td><td><pre>\tidle task. */</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre><span class=\"token comment\">/*----------------------------- End -----------------------------*/</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre></pre></td></tr><tr><td data-num=\"129\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">prvUser_Task</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>pvParameters <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>    <span class=\"token comment\">/* User-defined private tasks */</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>    <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>        <span class=\"token comment\">/* do something here */</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"137\"></td><td><pre>    <span class=\"token comment\">/* </pre></td></tr><tr><td data-num=\"138\"></td><td><pre>    * 如果你的 task 就是需要离开 loop 并结束</pre></td></tr><tr><td data-num=\"139\"></td><td><pre>    * 需要用 vTaskDelete 來刪除自己而非使用 return 或自然结束 (执行到最后一行)</pre></td></tr><tr><td data-num=\"140\"></td><td><pre>    * 这个参数的 NULL 值是表示自己 </pre></td></tr><tr><td data-num=\"141\"></td><td><pre>    */</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>    <span class=\"token function\">vTaskDelete</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">// 删除自己</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre></pre></td></tr><tr><td data-num=\"145\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">prvSetupHardware</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>\t<span class=\"token comment\">/* Start with the clocks in their expected state. */</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>\t<span class=\"token function\">RCC_DeInit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>\t<span class=\"token comment\">/* Enable HSE (high speed external clock). */</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>\t<span class=\"token function\">RCC_HSEConfig</span><span class=\"token punctuation\">(</span> RCC_HSE_ON <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>\t<span class=\"token comment\">/* Wait till HSE is ready. */</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>\t<span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span> <span class=\"token function\">RCC_GetFlagStatus</span><span class=\"token punctuation\">(</span> RCC_FLAG_HSERDY <span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> RESET <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>\t<span class=\"token comment\">/* 2 wait states required on the flash. */</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>\t<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> <span class=\"token number\">0x40022000</span> <span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x02</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>\t<span class=\"token comment\">/* HCLK = SYSCLK */</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>\t<span class=\"token function\">RCC_HCLKConfig</span><span class=\"token punctuation\">(</span> RCC_SYSCLK_Div1 <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>\t<span class=\"token comment\">/* PCLK2 = HCLK */</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>\t<span class=\"token function\">RCC_PCLK2Config</span><span class=\"token punctuation\">(</span> RCC_HCLK_Div1 <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre></pre></td></tr><tr><td data-num=\"167\"></td><td><pre>\t<span class=\"token comment\">/* PCLK1 = HCLK/2 */</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>\t<span class=\"token function\">RCC_PCLK1Config</span><span class=\"token punctuation\">(</span> RCC_HCLK_Div2 <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>\t<span class=\"token comment\">/* PLLCLK = 8MHz * 9 = 72 MHz. */</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>\t<span class=\"token function\">RCC_PLLConfig</span><span class=\"token punctuation\">(</span> RCC_PLLSource_HSE_Div1<span class=\"token punctuation\">,</span> RCC_PLLMul_9 <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>\t<span class=\"token comment\">/* Enable PLL. */</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>\t<span class=\"token function\">RCC_PLLCmd</span><span class=\"token punctuation\">(</span> ENABLE <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre></pre></td></tr><tr><td data-num=\"176\"></td><td><pre>\t<span class=\"token comment\">/* Wait till PLL is ready. */</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre>\t<span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token function\">RCC_GetFlagStatus</span><span class=\"token punctuation\">(</span>RCC_FLAG_PLLRDY<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> RESET<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"178\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>\t<span class=\"token comment\">/* Select PLL as system clock source. */</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre>\t<span class=\"token function\">RCC_SYSCLKConfig</span><span class=\"token punctuation\">(</span> RCC_SYSCLKSource_PLLCLK <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre></pre></td></tr><tr><td data-num=\"184\"></td><td><pre>\t<span class=\"token comment\">/* Wait till PLL is used as system clock source. */</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>\t<span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span> <span class=\"token function\">RCC_GetSYSCLKSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0x08</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>\t<span class=\"token comment\">/* Configure HCLK clock as SysTick clock source. */</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre>\t<span class=\"token function\">SysTick_CLKSourceConfig</span><span class=\"token punctuation\">(</span> SysTick_CLKSource_HCLK <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"192\"></td><td><pre>\t<span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"193\"></td><td><pre>\t * STM32 中断优先级分组为 4，即 4bit 都用来表示抢占优先级，范围为：0~15</pre></td></tr><tr><td data-num=\"194\"></td><td><pre>\t * 优先级分组只需要分组一次即可，以后如果有其他的任务需要用到中断，</pre></td></tr><tr><td data-num=\"195\"></td><td><pre>\t * 都统一用这个优先级分组，千万不要再分组，切忌。</pre></td></tr><tr><td data-num=\"196\"></td><td><pre>\t */</span></pre></td></tr><tr><td data-num=\"197\"></td><td><pre>\t<span class=\"token function\">NVIC_PriorityGroupConfig</span><span class=\"token punctuation\">(</span> NVIC_PriorityGroup_4 <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"198\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"199\"></td><td><pre>\t<span class=\"token comment\">/* Other peripheral configuration */</span></pre></td></tr><tr><td data-num=\"200\"></td><td><pre>\t<span class=\"token function\">vSetupTimer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"201\"></td><td><pre>\t<span class=\"token function\">vSetupUSART</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"202\"></td><td><pre>\t<span class=\"token function\">vSetupParPort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"203\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"204\"></td><td><pre><span class=\"token comment\">/*----------------------------- End -----------------------------*/</span></pre></td></tr><tr><td data-num=\"205\"></td><td><pre></pre></td></tr><tr><td data-num=\"206\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifdef</span>  <span class=\"token expression\">DEBUG</span></span></pre></td></tr><tr><td data-num=\"207\"></td><td><pre><span class=\"token comment\">/* Keep the linker happy. */</span></pre></td></tr><tr><td data-num=\"208\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">assert_failed</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> pcFile<span class=\"token punctuation\">,</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> ulLine <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"209\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"210\"></td><td><pre>\t<span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"211\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"212\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"213\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"214\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"215\"></td><td><pre></pre></td></tr><tr><td data-num=\"216\"></td><td><pre></pre></td></tr><tr><td data-num=\"217\"></td><td><pre><span class=\"token comment\">/*---------------------------- END OF FILE ----------------------------*/</span></pre></td></tr></table></figure><p>首先， <code>prvSetupHardware()</code>  函数是配置时钟，并且初始化硬件配置（即  <code>vSetupTimer();</code>    <code>vSetupUSART();</code>    <code>vSetupParPort();</code>  的实现，其实就是封装了一下之前 <a href=\"https://arachnid.cc/categories/STM32\">stm32 笔记中</a> 的 time、uart、gpio 初始化配置）。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"><span>[Other peripheral configuration]</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/************************************************</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>函数名称 ： vSetupTimer</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>功    能 ： Timer 初始化接口</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>参    数 ： 无</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">vSetupTimer</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token function\">Timer2_Config</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">/************************************************</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>函数名称 ： vSetupUSART</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>功    能 ： UART 初始化接口</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>参    数 ： 无</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">vSetupUSART</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token function\">UART1_Config</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\">//\tUART2_Config();</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">/************************************************</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>函数名称 ： vSetupParPort</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>功    能 ： 基础 IO 初始化接口</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>参    数 ： 无</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>返 回 值 ： 无</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>*************************************************/</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">vSetupParPort</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t<span class=\"token function\">LED_Config</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t<span class=\"token function\">Key_Config</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>然后到后面的  <code>main</code>  函数的实现调用，调用  <code>prvSetupHardware()</code>  初始化所有跟硬件相关的配置，创建一个  <code>prvUser_Task</code>  任务，用于管理所有后面创建的任务（其实就是为了方便管理），因为这里面没有创建其他函数，所以放了个 while 循环在里面，最后再调用  <code>vTaskDelete(NULL);</code>  把自己删除；</p>\n<p>这里可能有个疑问，明明有个  <code>while</code>  死循环，执行不到  <code>vTaskDelete()</code>  函数，没什么意义啊，虽然道理是这样，但是最好在每个任务的结尾放上  <code>vTaskDelete()</code>  函数，以确保安全（特殊情况除外）；还有就是，因为在  <code>prvUser_Task</code>  任务中有个死循环，那在  <code>while</code>  之后的程序应该都执行不了啊，包括  <code>prvUser_Task</code>  任务后面的  <code>vTaskStartScheduler();</code>  ，如果是按正常的思维是这样的；但是，这里是在使用 RTOS，调用  <code>xTaskCreate()</code>  创建任务并不表示就已经执行了，只是告诉内核，我创建了这么一个任务，真正使系统开始执行是在调用了  <code>vTaskStartScheduler();</code>  启动调度器之后。</p>\n",
            "tags": [
                "history",
                "FreeRTOS",
                "RTOS"
            ]
        },
        {
            "id": "https://arachnid.cc/freertos-config/",
            "url": "https://arachnid.cc/freertos-config/",
            "title": "FreeRTOS 篇章之 FreeRTOSConfig.h 分析",
            "date_published": "2020-02-17T07:51:45.000Z",
            "content_html": "<h1 id=\"移植修改\"><a class=\"anchor\" href=\"#移植修改\">#</a> 移植修改</h1>\n<p>在 <a href=\"https://arachnid.cc/freertos-system-transplant/\">FreeRTOS 篇章之系统移植</a> 中，我们有把  <code>FreeRTOSv9.0.0\\FreeRTOS\\Demo\\CORTEX_STM32F103_Keil</code>  路径下的  <code>FreeRTOSConfig.h</code>  文件复制到我们用户可修改的  <code>App</code>  文件夹下，并且导入了工程，但是，该  <code>FreeRTOSConfig.h</code>  文件的内容并不是我们真正想要了内容，需要我们进行更改，而源文件内容就只有下面这么点内容</p>\n<p><img src=\"20200216134014732.png\" alt=\"img\" /></p>\n<p>虽然能满足 FreeRTOS 跑起来，但是往往随着功能的添加，我们需要 FreeRTOS 的更多支持，而这里也只是展示了个别裁剪功能；为了物尽其用，避免以后还要继续添加，所以我们直接就导入 FreeRTOS 所提供的功能选择，修改成如下内容：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifndef</span> <span class=\"token expression\">FREERTOS_CONFIG_H</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">FREERTOS_CONFIG_H</span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">/* Here is a good place to include header files that are required across</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>your application. */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"something.h\"</span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configUSE_PREEMPTION</span>                    <span class=\"token expression\"><span class=\"token number\">1</span></span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configUSE_PORT_OPTIMISED_TASK_SELECTION</span> <span class=\"token expression\"><span class=\"token number\">0</span></span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configUSE_TICKLESS_IDLE</span>                 <span class=\"token expression\"><span class=\"token number\">0</span></span></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configCPU_CLOCK_HZ</span>                      <span class=\"token expression\"><span class=\"token number\">60000000</span></span></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configTICK_RATE_HZ</span>                      <span class=\"token expression\"><span class=\"token number\">250</span></span></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configMAX_PRIORITIES</span>                    <span class=\"token expression\"><span class=\"token number\">5</span></span></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configMINIMAL_STACK_SIZE</span>                <span class=\"token expression\"><span class=\"token number\">128</span></span></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configMAX_TASK_NAME_LEN</span>                 <span class=\"token expression\"><span class=\"token number\">16</span></span></span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configUSE_16_BIT_TICKS</span>                  <span class=\"token expression\"><span class=\"token number\">0</span></span></span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configIDLE_SHOULD_YIELD</span>                 <span class=\"token expression\"><span class=\"token number\">1</span></span></span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configUSE_TASK_NOTIFICATIONS</span>            <span class=\"token expression\"><span class=\"token number\">1</span></span></span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configUSE_MUTEXES</span>                       <span class=\"token expression\"><span class=\"token number\">0</span></span></span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configUSE_RECURSIVE_MUTEXES</span>             <span class=\"token expression\"><span class=\"token number\">0</span></span></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configUSE_COUNTING_SEMAPHORES</span>           <span class=\"token expression\"><span class=\"token number\">0</span></span></span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configUSE_ALTERNATIVE_API</span>               <span class=\"token expression\"><span class=\"token number\">0</span> </span><span class=\"token comment\">/* Deprecated! */</span></span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configQUEUE_REGISTRY_SIZE</span>               <span class=\"token expression\"><span class=\"token number\">10</span></span></span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configUSE_QUEUE_SETS</span>                    <span class=\"token expression\"><span class=\"token number\">0</span></span></span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configUSE_TIME_SLICING</span>                  <span class=\"token expression\"><span class=\"token number\">0</span></span></span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configUSE_NEWLIB_REENTRANT</span>              <span class=\"token expression\"><span class=\"token number\">0</span></span></span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configENABLE_BACKWARD_COMPATIBILITY</span>     <span class=\"token expression\"><span class=\"token number\">0</span></span></span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configNUM_THREAD_LOCAL_STORAGE_POINTERS</span> <span class=\"token expression\"><span class=\"token number\">5</span></span></span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configSTACK_DEPTH_TYPE</span>                  <span class=\"token expression\"><span class=\"token keyword\">uint16_t</span></span></span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configMESSAGE_BUFFER_LENGTH_TYPE</span>        <span class=\"token expression\">size_t</span></span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token comment\">/* Memory allocation related definitions. */</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configSUPPORT_STATIC_ALLOCATION</span>         <span class=\"token expression\"><span class=\"token number\">1</span></span></span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configSUPPORT_DYNAMIC_ALLOCATION</span>        <span class=\"token expression\"><span class=\"token number\">1</span></span></span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configTOTAL_HEAP_SIZE</span>                   <span class=\"token expression\"><span class=\"token number\">10240</span></span></span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configAPPLICATION_ALLOCATED_HEAP</span>        <span class=\"token expression\"><span class=\"token number\">1</span></span></span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token comment\">/* Hook function related definitions. */</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configUSE_IDLE_HOOK</span>                     <span class=\"token expression\"><span class=\"token number\">0</span></span></span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configUSE_TICK_HOOK</span>                     <span class=\"token expression\"><span class=\"token number\">0</span></span></span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configCHECK_FOR_STACK_OVERFLOW</span>          <span class=\"token expression\"><span class=\"token number\">0</span></span></span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configUSE_MALLOC_FAILED_HOOK</span>            <span class=\"token expression\"><span class=\"token number\">0</span></span></span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configUSE_DAEMON_TASK_STARTUP_HOOK</span>      <span class=\"token expression\"><span class=\"token number\">0</span></span></span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token comment\">/* Run time and task stats gathering related definitions. */</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configGENERATE_RUN_TIME_STATS</span>           <span class=\"token expression\"><span class=\"token number\">0</span></span></span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configUSE_TRACE_FACILITY</span>                <span class=\"token expression\"><span class=\"token number\">0</span></span></span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configUSE_STATS_FORMATTING_FUNCTIONS</span>    <span class=\"token expression\"><span class=\"token number\">0</span></span></span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token comment\">/* Co-routine related definitions. */</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configUSE_CO_ROUTINES</span>                   <span class=\"token expression\"><span class=\"token number\">0</span></span></span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configMAX_CO_ROUTINE_PRIORITIES</span>         <span class=\"token expression\"><span class=\"token number\">1</span></span></span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token comment\">/* Software timer related definitions. */</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configUSE_TIMERS</span>                        <span class=\"token expression\"><span class=\"token number\">1</span></span></span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configTIMER_TASK_PRIORITY</span>               <span class=\"token expression\"><span class=\"token number\">3</span></span></span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configTIMER_QUEUE_LENGTH</span>                <span class=\"token expression\"><span class=\"token number\">10</span></span></span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configTIMER_TASK_STACK_DEPTH</span>            <span class=\"token expression\">configMINIMAL_STACK_SIZE</span></span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre></pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token comment\">/* Interrupt nesting behaviour configuration. */</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configKERNEL_INTERRUPT_PRIORITY</span>         <span class=\"token expression\"><span class=\"token punctuation\">[</span>dependent of processor<span class=\"token punctuation\">]</span></span></span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configMAX_SYSCALL_INTERRUPT_PRIORITY</span>    <span class=\"token expression\"><span class=\"token punctuation\">[</span>dependent on processor <span class=\"token operator\">and</span> application<span class=\"token punctuation\">]</span></span></span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configMAX_API_CALL_INTERRUPT_PRIORITY</span>   <span class=\"token expression\"><span class=\"token punctuation\">[</span>dependent on processor <span class=\"token operator\">and</span> application<span class=\"token punctuation\">]</span></span></span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token comment\">/* Define to trap errors during development. */</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">configASSERT</span><span class=\"token expression\"><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> x <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> x <span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span> <span class=\"token function\">vAssertCalled</span><span class=\"token punctuation\">(</span> <span class=\"token constant\">__FILE__</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">__LINE__</span> <span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre><span class=\"token comment\">/* FreeRTOS MPU specific definitions. */</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">configINCLUDE_APPLICATION_DEFINED_PRIVILEGED_FUNCTIONS</span> <span class=\"token expression\"><span class=\"token number\">0</span></span></span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre><span class=\"token comment\">/* Optional functions - most linkers will remove unused functions anyway. */</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">INCLUDE_vTaskPrioritySet</span>                <span class=\"token expression\"><span class=\"token number\">1</span></span></span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">INCLUDE_uxTaskPriorityGet</span>               <span class=\"token expression\"><span class=\"token number\">1</span></span></span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">INCLUDE_vTaskDelete</span>                     <span class=\"token expression\"><span class=\"token number\">1</span></span></span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">INCLUDE_vTaskSuspend</span>                    <span class=\"token expression\"><span class=\"token number\">1</span></span></span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">INCLUDE_xResumeFromISR</span>                  <span class=\"token expression\"><span class=\"token number\">1</span></span></span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">INCLUDE_vTaskDelayUntil</span>                 <span class=\"token expression\"><span class=\"token number\">1</span></span></span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">INCLUDE_vTaskDelay</span>                      <span class=\"token expression\"><span class=\"token number\">1</span></span></span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">INCLUDE_xTaskGetSchedulerState</span>          <span class=\"token expression\"><span class=\"token number\">1</span></span></span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">INCLUDE_xTaskGetCurrentTaskHandle</span>       <span class=\"token expression\"><span class=\"token number\">1</span></span></span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">INCLUDE_uxTaskGetStackHighWaterMark</span>     <span class=\"token expression\"><span class=\"token number\">0</span></span></span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">INCLUDE_xTaskGetIdleTaskHandle</span>          <span class=\"token expression\"><span class=\"token number\">0</span></span></span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">INCLUDE_eTaskGetState</span>                   <span class=\"token expression\"><span class=\"token number\">0</span></span></span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">INCLUDE_xEventGroupSetBitFromISR</span>        <span class=\"token expression\"><span class=\"token number\">1</span></span></span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">INCLUDE_xTimerPendFunctionCall</span>          <span class=\"token expression\"><span class=\"token number\">0</span></span></span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">INCLUDE_xTaskAbortDelay</span>                 <span class=\"token expression\"><span class=\"token number\">0</span></span></span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">INCLUDE_xTaskGetHandle</span>                  <span class=\"token expression\"><span class=\"token number\">0</span></span></span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">INCLUDE_xTaskResumeFromISR</span>              <span class=\"token expression\"><span class=\"token number\">1</span></span></span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre></pre></td></tr><tr><td data-num=\"90\"></td><td><pre><span class=\"token comment\">/* A header file that defines trace macro can be included here. */</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre></pre></td></tr><tr><td data-num=\"92\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span> <span class=\"token comment\">/* FREERTOS_CONFIG_H */</span></span></pre></td></tr></table></figure><p>当然，这只是官方提供的，较为完整的配置模版；具体实现什么功能还是要我们对相应的宏进行修改的。</p>\n<h1 id=\"配置项详解\"><a class=\"anchor\" href=\"#配置项详解\">#</a> 配置项详解</h1>\n<p><strong>1、configUSE_PREEMPTION</strong></p>\n<p>置  <code>1</code>  ：RTOS 使用抢占式调度器，即当进程位于内核空间时，有一个更高优先级的任务出现时，如果当前内核允许抢占，则可以将当前任务挂起，执行优先级更高的进程；</p>\n<p>置  <code>0</code>  ：RTOS 使用协作式调度器（时间片），协作式操作系统是任务主动释放 CPU 后，切换到下一个任务，任务切换的时机完全取决于正在运行的任务，因此，高优先级的进程不能中止正在内核中运行的低优先级的进程而抢占 CPU 运行。</p>\n<p><strong>2、configUSE_PORT_OPTIMISED_TASK_SELECTION</strong></p>\n<p>一些 FreeRTOS 硬件端口在选择下一个要执行的任务，具有两种的方法：通用方法和特定于该硬件端口的方法。</p>\n<p>通用方法：</p>\n<ul>\n<li>在  <code>configUSE_PORT_OPTIMISED_TASK_SELECTION</code>  设置为  <code>0</code>  （显式）或未实现特定于硬件端口的方法（隐式）时使用。</li>\n<li>可以与所有 FreeRTOS 硬件端口一起使用。</li>\n<li>完全用 C 编写，使其效率低于使用特定硬件端口的方法。</li>\n<li>不限制可用优先级的最大数量。</li>\n</ul>\n<p>特定于硬件端口的方法：</p>\n<ul>\n<li>不适用于所有硬件端口。</li>\n<li>在  <code>configUSE_PORT_OPTIMISED_TASK_SELECTION</code>  设置为  <code>1</code>  时使用。</li>\n<li>依赖于一个或多个特定于体系结构的汇编指令（通常为计数前导零 [CLZ] 或等效指令），因此只能与专门为其编写的体系结构一起使用。</li>\n<li>比通用方法更有效。</li>\n<li>通常，最大可用优先级数限制为 32。</li>\n</ul>\n<p><strong>3、configUSE_TICKLESS_IDLE</strong></p>\n<p>置  <code>1</code>  ：使能低功耗 tickless 模式；</p>\n<p>置  <code>0</code>  ：保持系统节拍（tick）中断一直运行。</p>\n<p>在低功耗 tickless 模式，通常使用空闲钩子函数设置 CPU 进入低功耗模式来达到省电的目的。</p>\n<p><strong>4、configUSE_IDLE_HOOK</strong></p>\n<p>置  <code>1</code>  ：使用空闲钩子（Idle Hook 类似于回调函数）；</p>\n<p>置  <code>0</code>  ：忽略空闲钩子。</p>\n<p>空闲任务钩子是一个函数，这个函数由用户来实现，FreeRTOS 规定了函数的名字和参数：  <code>void vApplicationIdleHook(void)</code>  ，这个函数在每个空闲任务周期都会被调用。</p>\n<p><strong>5、configUSE_MALLOC_FAILED_HOOK</strong></p>\n<p>每次创建任务，队列或信号量时，内核都会使用对  <code>pvPortMalloc()</code>  的调用从堆中分配内存。FreeRTOS 的官方下载包中包含五个堆内存分配方案；这些方案分别在  <code>heap_1.c</code>  ， <code>heap_2.c</code>  ， <code>heap_3.c</code>  ， <code>heap_4.c</code>  和  <code>heap_5.c</code>  源文件中进行实现；  <code>configUSE_MALLOC_FAILED_HOOK</code>  仅在使用这五个堆内存分配方案之一时才有意义。</p>\n<p>如果定义并正确配置  <code>malloc()</code>  申请失败的钩子函数，则这个函数会在  <code>pvPortMalloc()</code>  函数返回 NULL 时被调用；注意：仅当 FreeRTOS 在响应内存分配请求时发现堆内存不足时，才返回 NULL。</p>\n<p>置  <code>1</code>  ：则应用程序必须定义一个  <code>malloc()</code>  申请失败的挂钩函数；</p>\n<p>置  <code>0</code>  ：则忽略  <code>malloc()</code>  申请失败的挂钩函数，即使定义了这个挂钩函数。</p>\n<p><code>malloc()</code>  申请失败的挂钩函数必须具有如下所示的名称和原型：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">vApplicationMallocFailedHook</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><strong>6、configUSE_DAEMON_TASK_STARTUP_HOOK</strong></p>\n<p>置  <code>1</code>  ：则应用程序必须定义一个具有确切名称和原型的钩子函数；</p>\n<p>置  <code>0</code>  ：则忽略该钩子函数。</p>\n<p>其名称和原型如下所示：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">vApplicationDaemonTaskStartupHook</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>首次执行 RTOS 守护程序任务（也称为 <a href=\"https://www.freertos.org/RTOS-software-timer-service-daemon-task.html\">计时器服务任务</a> ）时，钩子函数将被精确调用一次 。任何需要运行 RTOS 的应用程序初始化代码都可以放在挂钩函数中。</p>\n<p><strong>7、configUSE_TICK_HOOK</strong></p>\n<p>置  <code>1</code>  ：使用时间片钩子（Tick Hook）；</p>\n<p>置  <code>0</code>  ：忽略时间片钩子。</p>\n<p>时间片钩子是一个函数，这个函数由用户来实现，FreeRTOS 规定了函数的名字和参数： <code>void vApplicationTickHook(void)</code> ，时间片中断可以周期性的调用。</p>\n<p><strong>8、configCPU_CLOCK_HZ</strong></p>\n<p>输入以 Hz 为单位的频率，该驱动频率将用于系统滴答中断的外设驱动的内部时钟，通常与驱动内部 CPU 时钟的时钟相同；配置此值是为了正确的配置系统节拍中断周期。</p>\n<p><strong>9、configTICK_RATE_HZ</strong></p>\n<p>配置 RTOS 滴答中断的频率；用于测量时间，即一秒中断的次数，每次中断 RTOS 都会进行任务调度。</p>\n<p>更高的滴答频率意味着同一时间下可以测量到更高的分辨率；但是，较高的滴答频率也意味着 RTOS 内核将使用更多的 CPU 时间，因此使得效率降低。RTOS 演示例程均使用 1000Hz 的滴答频率，这是为了测试 RTOS 内核，因此比实际使用的高得多。（实际使用时不用这么高的系统节拍中断频率）</p>\n<p>多个任务可以共享相同的优先级。通过在每个 RTOS 系统节拍中断到来时切换任务，RTOS 调度程序将在优先级相同的任务之间共享处理器时间；因此，较高的滴答频率会减少分配给每个任务的 “时间片” 。</p>\n<p><strong>10、configMAX_PRIORITIES</strong></p>\n<p>配置应用程序任务可用的优先级数；任何数量的任务都可以共享相同的优先级。协同例程的优先级是分开的，详情见  <code>configMAX_CO_ROUTINE_PRIORITIES</code>  。</p>\n<p>每个可用的优先级都会消耗 RTOS 内核中的 RAM，因此该值不应设置为高于应用程序实际需要的值。</p>\n<p>每一个任务都会被分配一个优先级，优先级值在 0 ~ (configMAX_PRIORITIES - 1) 之间。低优先级数表示低优先级任务，空闲任务的优先级为 0（tskIDLE_PRIORITY），因此它是最低优先级任务。</p>\n<p><strong>11、configMINIMAL_STACK_SIZE</strong></p>\n<p>空闲任务使用的堆栈大小。通常此值不应小于对应处理器演示例程文件  <code>FreeRTOSConfig.h</code>  中定义的数值</p>\n<p>就像 <a href=\"https://www.freertos.org/a00125.html\">xTaskCreate()</a> 和 <a href=\"https://www.freertos.org/xTaskCreateStatic.html\">xTaskCreateStatic()</a> 函数的堆栈大小参数一样，堆栈大小以字为单位而不是字节；如果在 32 位处理器上，当堆栈大小为 100 则表示 400 字节的空间大小。</p>\n<p><strong>12、configMAX_TASK_NAME_LEN</strong></p>\n<p>创建任务时，描述任务信息的字符串的最大允许长度。长度包括  <code>\\0</code>  字符串结束符。</p>\n<p><strong>13、configUSE_TRACE_FACILITY</strong></p>\n<p>置  <code>1</code>  ：表示启动可视化跟踪调试，会激活一些其他的结构成员和函数；</p>\n<p>置  <code>0</code>  ：忽略。</p>\n<p><strong>14、configUSE_STATS_FORMATTING_FUNCTIONS</strong></p>\n<p>将  <code>configUSE_TRACE_FACILITY </code>  和  <code>configUSE_STATS_FORMATTING_FUNCTIONS</code>  都设置为  <code>1</code>  ，则再构建中包含编译  <code>vTaskList()</code>  和  <code>vTaskGetRunTimeStats()</code>  函数；</p>\n<p>否则，其中一个宏为  <code>0</code>  ，就会从构建中省略这两个函数，不进行编译；通常只是在调试时才使用，用来观察各任务，跟 13 的宏连用。</p>\n<p><strong>15、configUSE_16_BIT_TICKS</strong></p>\n<p>时间是以 “ticks” 来衡量的，这是自 RTOS 内核启动以来滴答中断执行的次数；tick 计数保存在  <code>TickType_t</code>  类型的变量中。</p>\n<p>置  <code>1</code>  ： <code>TickType_t</code>  被定义为无符号的 16 位类型；</p>\n<p>置  <code>0</code>  ： <code>TickType_t</code>  被定义为无符号的 32 位类型。</p>\n<p>使用 16 位类型将大大提高 8 位和 16 位处理器系统的性能，但会将最大的可指定时间段限制为 65535 个 “ticks” 。因此，假设滴答频率为 250Hz，则使用 16 位计数器时任务可以延迟或阻止的最长时间为 262 秒，而使用 32 位计数器时为 17179869 秒。</p>\n<p><strong>16、configIDLE_SHOULD_YIELD</strong></p>\n<p>此参数控制处于空闲优先级的任务的行为。它仅在以下情况下起作用：</p>\n<ul>\n<li>正在使用抢占式调度程序。</li>\n<li>该应用程序创建以空闲优先级运行的任务。</li>\n</ul>\n<p>如果  <code>configUSE_TIME_SLICING</code>  被设置为  <code>1</code>  （或未定义），则具有相同优先级的任务将共享使用时间片。如果具有相同优先级的任务，它的优先级高于空闲优先级，并且没有一个任务被抢占，则可以假定这些具有相同优先级的任务，它们分配等量的处理时间；</p>\n<p>但当任务共享空闲优先级时，情况会稍微有些不同。如果  <code>configIDLE_SHOULD_YIELD</code>  设置为  <code>1</code>  ，则任何跟空闲优先级相同的用户任务就绪时，空闲任务会立刻让出 CPU，使用户任务得以运行，这样确保了能最快响应用户任务。但是，此行为可能会产生不良影响（取决于您的应用程序的需求），如下所示：</p>\n<p><img src=\"20200217156805236.png\" alt=\"img\" /></p>\n<p>上图描述了四个处于空闲优先级的任务的执行模式。任务  <code>A</code>  ， <code>B</code>  和  <code>C</code>  是应用程序任务；任务  <code>I</code>  是空闲任务。在时间 T0，T1，…，T6 定期进行上下文切换；在空闲任务运行中，当任务  <code>A</code>  任务产生时，空闲任务立刻让出 CPU，开始执行任务  <code>A</code>  ，但此刻空闲任务  <code>I</code>  已经消耗了当前时间片的一些时间了，这样的结果就是空闲任务  <code>I</code>  和任务  <code>A</code>  共享同一时间片。因此，应用程序任务  <code>B</code>  和  <code>C</code>  比应用程序任务  <code>A</code>  获得更多的处理时间。</p>\n<p>可以通过以下方式避免这种情况：</p>\n<ul>\n<li>如果合适，请使用空闲钩子函数代替空闲优先级的单独任务。</li>\n<li>以高于空闲优先级的优先级创建所有应用程序任务。</li>\n<li>将  <code>configIDLE_SHOULD_YIELD</code>  设置为  <code>0</code>  。</li>\n</ul>\n<p>将  <code>configIDLE_SHOULD_YIELD</code>  设置为  <code>0</code>  可以防止空闲任务产生处理时间，直到其时间片结束为止。这样可以确保为所有处于空闲优先级的任务分配相等的处理时间（如果没有一个任务被抢占），但代价是将更大比例的总处理时间分配给空闲任务。</p>\n<p><strong>17、configUSE_TASK_NOTIFICATIONS</strong></p>\n<p>置  <code>1</code>  （或未定义）：开启任务通知功能，有关的 API 函数会被包含编译；</p>\n<p>置  <code>0</code>  ：直接从程序中关闭任务通知功能及其关联的 API。</p>\n<p>该功能默认是开启的。开启后，每个任务多增加 8 字节 RAM。</p>\n<p><strong>18、configUSE_MUTEXES</strong></p>\n<p>置  <code>1</code>  ：使用互斥量；</p>\n<p>置  <code>0</code>  ：不使用互斥量。</p>\n<p>读者应该了解在 FreeRTOS 中互斥量和二值信号量的区别。</p>\n<p><strong>19、configUSE_RECURSIVE_MUTEXES</strong></p>\n<p>置  <code>1</code>  ：使用递归互斥量；</p>\n<p>置  <code>0</code>  ：不使用递归互斥量。</p>\n<p><strong>20、configUSE_COUNTING_SEMAPHORES</strong></p>\n<p>置  <code>1</code>  ：使用计数信号量；</p>\n<p>置  <code>0</code>  ：不使用计数信号量。</p>\n<p><strong>21、configUSE_ALTERNATIVE_API</strong></p>\n<p>置  <code>1</code>  ：使用 “alternative” 队列函数；</p>\n<p>置  <code>0</code>  ：不使用 “alternative” 队列函数。</p>\n<p>“alternative” API 队列函数在  <code>queue.h</code>  头文件中有详细描述；<strong>“alternative” API 已被弃用，在新的设计中请不要使用它！</strong></p>\n<p><strong>22、configCHECK_FOR_STACK_OVERFLOW</strong></p>\n<p>在 <a href=\"https://www.freertos.org/Stacks-and-stack-overflow-checking.html\">Stack Usage and Stack Overflow Checking</a> 链接中有详细描述堆栈使用情况和堆栈溢出检查的方法，这里就不详细说了。</p>\n<p><strong>23、configQUEUE_REGISTRY_SIZE</strong></p>\n<p>通过此定义来设置可以注册的信号量和消息队列个数。</p>\n<p>队列注册表具有两个目的，这两个目的都与 RTOS 内核调试相关联：</p>\n<ul>\n<li>它允许将文本名称与队列关联，以便在调试 GUI 中轻松识别队列。</li>\n<li>它包含调试器查找每个已注册队列和信号量所需的信息。</li>\n</ul>\n<p>除了进行内核调试外，队列注册表没有其它任何目的；只有注册后的队列和信号量才可以使用 RTOS 内核调试器查看，有关更多信息，请参见 <a href=\"https://www.freertos.org/vQueueAddToRegistry.html\">vQueueAddToRegistry()</a> 和 <a href=\"https://www.freertos.org/vQueueUnregisterQueue.html\">vQueueUnregisterQueue()</a> 的 API 参考文档。</p>\n<p><strong>24、configUSE_QUEUE_SETS</strong></p>\n<p>置  <code>1</code>  ：使能队列集功能（可以阻塞、挂起到多个队列和信号量）；</p>\n<p>置  <code>0</code>  ：忽略队列集功能。</p>\n<p><strong>25、configUSE_TIME_SLICING</strong></p>\n<p>置  <code>1</code>  （或未定义）：默认情况下，FreeRTOS 使用基于时间片的优先级抢占式调度器，这意味着 RTOS 调度器将始终运行处于最高优先级的 “就绪” 状态任务，并会在每个 RTOS 滴答中断时对在优先级相同的任务之间进行切换；</p>\n<p>置  <code>0</code>  ：RTOS 调度程序仍将运行处于最高优先级的 “就绪” 状态任务，但不会由于发生了滴答中断而在优先级相同的任务之间切换。</p>\n<p><strong>26、configUSE_NEWLIB_REENTRANT</strong></p>\n<p>置  <code>1</code>  ：将为每个创建的任务分配一个 <a href=\"http://sourceware.org/newlib/\">newlib</a>（一个嵌入式 C 库）进入结构；</p>\n<p>置  <code>0</code>  ：不分配。</p>\n<p>注意 Newlib 支持是已经包含在普遍需求中了，但 FreeRTOS 维护者本身并未使用。FreeRTOS 是不负责由此产生的 newlib 操作的，因此用户必须熟悉 newlib，并且必须提供必要存根的系统级实现。请注意，（在撰写本文时）当前的 newlib 设计实现了一个系统级的  <code>malloc()</code>  ，这个  <code>malloc()</code>  必须锁上。</p>\n<p><strong>27、configENABLE_BACKWARD_COMPATIBILITY</strong></p>\n<p><code>FreeRTOS.h</code>  头文件包含一组 #define 宏，这些宏将在 V8.0.0 之前的 FreeRTOS 版本中使用的数据类型的名称映射到在 FreeRTOS 的 V8.0.0 版本中使用的名称，这些宏可以确保 RTOS 内核升级到 V8.0.0 或以上版本时，不用对之前的应用代码做任何修改。</p>\n<p>置  <code>1</code>  ：包含这些 #define 宏；</p>\n<p>置  <code>0</code>  ：排除这些宏，从而允许进行验证，以确保未使用 V8.0.0 之前的版本。</p>\n<p>各类型定义如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\">configENABLE_BACKWARD_COMPATIBILITY <span class=\"token operator\">==</span> <span class=\"token number\">1</span></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">eTaskStateGet</span> <span class=\"token expression\">eTaskGetState</span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">portTickType</span> <span class=\"token expression\">TickType_t</span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">xTaskHandle</span> <span class=\"token expression\">TaskHandle_t</span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">xQueueHandle</span> <span class=\"token expression\">QueueHandle_t</span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">xSemaphoreHandle</span> <span class=\"token expression\">SemaphoreHandle_t</span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">xQueueSetHandle</span> <span class=\"token expression\">QueueSetHandle_t</span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">xQueueSetMemberHandle</span> <span class=\"token expression\">QueueSetMemberHandle_t</span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">xTimeOutType</span> <span class=\"token expression\">TimeOut_t</span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">xMemoryRegion</span> <span class=\"token expression\">MemoryRegion_t</span></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">xTaskParameters</span> <span class=\"token expression\">TaskParameters_t</span></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">xTaskStatusType</span>\t<span class=\"token expression\">TaskStatus_t</span></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">xTimerHandle</span> <span class=\"token expression\">TimerHandle_t</span></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">xCoRoutineHandle</span> <span class=\"token expression\">CoRoutineHandle_t</span></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">pdTASK_HOOK_CODE</span> <span class=\"token expression\">TaskHookFunction_t</span></span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">portTICK_RATE_MS</span> <span class=\"token expression\">portTICK_PERIOD_MS</span></span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">pcTaskGetTaskName</span> <span class=\"token expression\">pcTaskGetName</span></span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">pcTimerGetTimerName</span> <span class=\"token expression\">pcTimerGetName</span></span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">pcQueueGetQueueName</span> <span class=\"token expression\">pcQueueGetName</span></span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">vTaskGetTaskInfo</span> <span class=\"token expression\">vTaskGetInfo</span></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token comment\">/* Backward compatibility within the scheduler code only - these definitions</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\tare not really required but are included for completeness. */</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">tmrTIMER_CALLBACK</span> <span class=\"token expression\">TimerCallbackFunction_t</span></span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">pdTASK_CODE</span> <span class=\"token expression\">TaskFunction_t</span></span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">xListItem</span> <span class=\"token expression\">ListItem_t</span></span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">xList</span> <span class=\"token expression\">List_t</span></span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span> <span class=\"token comment\">/* configENABLE_BACKWARD_COMPATIBILITY */</span></span></pre></td></tr></table></figure><p><strong>28、configNUM_THREAD_LOCAL_STORAGE_POINTERS</strong></p>\n<p>设置每个任务的线程本地存储指针数组大小；详情请看链接 <a href=\"https://www.freertos.org/thread-local-storage-pointers.html\">Thread Local Storage Pointers</a> 。</p>\n<p><strong>29、configSTACK_DEPTH_TYPE</strong></p>\n<p>设置用于在调用 <a href=\"https://www.freertos.org/a00125.html\">xTaskCreate()</a> 时指定堆栈深度的类型，并使用其他各种堆栈大小（例如，在返回 <a href=\"https://www.freertos.org/uxTaskGetStackHighWaterMark.html\">堆栈高位标记时</a> ）。</p>\n<p>在较旧的版本中，FreeRTOS 使用  <code>UBaseType_t</code>  类型的变量来指定堆栈大小，但是发现这对 8 位微控制器的限制太大。因此， <code>configSTACK_DEPTH_TYPE</code>  允许应用程序开发人员指定要使用的类型，从而消除了这个限制。</p>\n<p><strong>30、configMESSAGE_BUFFER_LENGTH_TYPE</strong></p>\n<p><a href=\"https://www.freertos.org/RTOS-message-buffer-example.html\">FreeRTOS 消息缓冲区</a> 使用  <code>configMESSAGE_BUFFER_LENGTH_TYPE</code>  类型的变量来存储每个消息的长度；如果未定义  <code>configMESSAGE_BUFFER_LENGTH_TYPE</code>  ，则默认为  <code>size_t</code>  。</p>\n<p>如果存储在消息缓冲区中的消息永远不会大于 255 个字节，那么在 32 位微控制器上将  <code>configMESSAGE_BUFFER_LENGTH_TYPE</code>  定义为  <code>uint8_t</code>  将为每个消息节省 3 个字节；同样，如果存储在消息缓冲区中的消息永远不会大于 65535 字节，则在 32 位微控制器上将  <code>configMESSAGE_BUFFER_LENGTH_TYPE</code>  定义为  <code>uint16_t</code>  将为每条消息节省 2 个字节。</p>\n<p><strong>31、configSUPPORT_STATIC_ALLOCATION</strong></p>\n<p>置  <code>1</code>  ：可以使用应用程序编写者提供的 RAM 创建 RTOS 对象；</p>\n<p>置  <code>0</code>  （或未定义）：只能使用从 FreeRTOS 堆分配的 RAM 创建 RTOS 对象。</p>\n<p>如果将  <code>configSUPPORT_STATIC_ALLOCATION</code>  设置为  <code>1</code>  ，则应用程序编写者还必须提供两个回调函数： <code>vApplicationGetIdleTaskMemory()</code>  提供用于 RTOS 空闲任务的内存，以及（如果  <code>configUSE_TIMERS</code>  设置为  <code>1</code>  ） <code>vApplicationGetTimerTaskMemory()</code>  提供用于以下目的的内存： RTOS 守护程序 / 计时器服务任务。</p>\n<p>下面官方提供了示例：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* configSUPPORT_STATIC_ALLOCATION is set to 1, so the application must provide an</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>implementation of vApplicationGetIdleTaskMemory() to provide the memory that is</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>used by the Idle task. */</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">vApplicationGetIdleTaskMemory</span><span class=\"token punctuation\">(</span> StaticTask_t <span class=\"token operator\">*</span><span class=\"token operator\">*</span>ppxIdleTaskTCBBuffer<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                                    StackType_t <span class=\"token operator\">*</span><span class=\"token operator\">*</span>ppxIdleTaskStackBuffer<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                                    <span class=\"token keyword\">uint32_t</span> <span class=\"token operator\">*</span>pulIdleTaskStackSize <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">/* If the buffers to be provided to the Idle task are declared inside this</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>function then they must be declared static – otherwise they will be allocated on</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>the stack and so not exists after this function exits. */</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">static</span> StaticTask_t xIdleTaskTCB<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">static</span> StackType_t uxIdleTaskStack<span class=\"token punctuation\">[</span> configMINIMAL_STACK_SIZE <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token comment\">/* Pass out a pointer to the StaticTask_t structure in which the Idle task’s</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    state will be stored. */</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token operator\">*</span>ppxIdleTaskTCBBuffer <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>xIdleTaskTCB<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token comment\">/* Pass out the array that will be used as the Idle task’s stack. */</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token operator\">*</span>ppxIdleTaskStackBuffer <span class=\"token operator\">=</span> uxIdleTaskStack<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token comment\">/* Pass out the size of the array pointed to by *ppxIdleTaskStackBuffer.</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    Note that, as the array is necessarily of type StackType_t,</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    configMINIMAL_STACK_SIZE is specified in words, not bytes. */</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token operator\">*</span>pulIdleTaskStackSize <span class=\"token operator\">=</span> configMINIMAL_STACK_SIZE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">/*———————————————————–*/</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\">/* configSUPPORT_STATIC_ALLOCATION and configUSE_TIMERS are both set to 1, so the</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>application must provide an implementation of vApplicationGetTimerTaskMemory()</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>to provide the memory that is used by the Timer service task. */</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">vApplicationGetTimerTaskMemory</span><span class=\"token punctuation\">(</span> StaticTask_t <span class=\"token operator\">*</span><span class=\"token operator\">*</span>ppxTimerTaskTCBBuffer<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                                     StackType_t <span class=\"token operator\">*</span><span class=\"token operator\">*</span>ppxTimerTaskStackBuffer<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                                     <span class=\"token keyword\">uint32_t</span> <span class=\"token operator\">*</span>pulTimerTaskStackSize <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token comment\">/* If the buffers to be provided to the Timer task are declared inside this</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>function then they must be declared static – otherwise they will be allocated on</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>the stack and so not exists after this function exits. */</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token keyword\">static</span> StaticTask_t xTimerTaskTCB<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token keyword\">static</span> StackType_t uxTimerTaskStack<span class=\"token punctuation\">[</span> configTIMER_TASK_STACK_DEPTH <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token comment\">/* Pass out a pointer to the StaticTask_t structure in which the Timer</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    task’s state will be stored. */</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token operator\">*</span>ppxTimerTaskTCBBuffer <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>xTimerTaskTCB<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token comment\">/* Pass out the array that will be used as the Timer task’s stack. */</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token operator\">*</span>ppxTimerTaskStackBuffer <span class=\"token operator\">=</span> uxTimerTaskStack<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token comment\">/* Pass out the size of the array pointed to by *ppxTimerTaskStackBuffer.</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    Note that, as the array is necessarily of type StackType_t,</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    configTIMER_TASK_STACK_DEPTH is specified in words, not bytes. */</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token operator\">*</span>pulTimerTaskStackSize <span class=\"token operator\">=</span> configTIMER_TASK_STACK_DEPTH<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"55\"></td><td><pre> * Examples of the callback functions that must be provided by the application to</pre></td></tr><tr><td data-num=\"56\"></td><td><pre> * supply the RAM used by the Idle and Timer Service tasks if </pre></td></tr><tr><td data-num=\"57\"></td><td><pre> * configSUPPORT_STATIC_ALLOCATION is set to 1.</pre></td></tr><tr><td data-num=\"58\"></td><td><pre> */</span></pre></td></tr></table></figure><p>有关更多信息，请参见 <a href=\"https://www.freertos.org/Static_Vs_Dynamic_Memory_Allocation.html\">Static Vs Dynamic Memory Allocation</a> 页面。</p>\n<p><strong>32、configSUPPORT_DYNAMIC_ALLOCATION</strong></p>\n<p>置  <code>1</code>  （或未定义）：可以使用从 FreeRTOS 堆自动分配的 RAM 创建 RTOS 对象；</p>\n<p>置  <code>0</code>  ：只能使用应用程序编写器提供的 RAM 创建 RTOS 对象。</p>\n<p>有关更多信息，请参见 <a href=\"https://www.freertos.org/Static_Vs_Dynamic_Memory_Allocation.html\">Static Vs Dynamic Memory Allocation</a> 页面。</p>\n<p><strong>33、configTOTAL_HEAP_SIZE</strong></p>\n<p>FreeRTOS 堆中可用的 RAM 总量；仅当 <a href=\"https://www.freertos.org/a00110.html#configSUPPORT_DYNAMIC_ALLOCATION\">configSUPPORT_DYNAMIC_ALLOCATION</a> 设置为  <code>1</code>  且应用程序使用 FreeRTOS 源代码下载中的四个堆内存分配方案之一（  <code>heap_1.c</code>  、 <code>heap_2.c</code>  、 <code>heap_4.c</code>  或  <code>heap_5.c</code>  ）时，才使用此值。</p>\n<p>注意，当使用  <code>heap_3</code>  时，该值的设置无效。</p>\n<p>有关更多详细信息，请参见 <a href=\"https://www.freertos.org/a00111.html\">内存配置</a> 部分。</p>\n<p><strong>34、configAPPLICATION_ALLOCATED_HEAP</strong></p>\n<p>默认情况下，<a href=\"https://www.freertos.org/a00111.html\">FreeRTOS 堆</a> 由 FreeRTOS 声明，并由链接器放置在内存中；将  <code>configAPPLICATION_ALLOCATED_HEAP</code>  设置为  <code>1</code>  可以使堆改为由应用程序编写者声明，这允许应用程序编写者将堆放置在内存中任意位置。</p>\n<p>如果使用  <code>heap_1.c</code>  、 <code>heap_2.c</code>  或  <code>heap_4.c</code>  ，并且  <code>configAPPLICATION_ALLOCATED_HEAP</code>  设置为  <code>1</code>  ，那么应用程序编写者必须提供一个  <code>uint8_t</code>  类型的数组，其名称和维数如下所示；该数组将用作 FreeRTOS 堆：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">uint8_t</span> ucHeap <span class=\"token punctuation\">[</span>configTOTAL_HEAP_SIZE<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>如何将数组放置在特定的内存位置取决于所使用的编译器，请参阅编译器的文档。</p>\n<p><strong>35、configGENERATE_RUN_TIME_STATS</strong></p>\n<p>该 <a href=\"https://www.freertos.org/rtos-run-time-stats.html\">Run Time Stats</a> 页面描述了此参数的用法。</p>\n<p><strong>36、configUSE_CO_ROUTINES</strong></p>\n<p>置  <code>1</code>  ：使用协程；</p>\n<p>置  <code>0</code>  ：不使用协程。</p>\n<p>如果使用协程，必须在工程中包含  <code>croutine.c</code>  文件。</p>\n<p>注意：协程（Co-routines）主要用于资源发非常受限的嵌入式系统（RAM 非常少），通常不会用于 32 位微处理器；<strong>在当前嵌入式硬件环境下，不建议使用协程，FreeRTOS 的开发者早已经停止开发协程</strong> 。</p>\n<p><strong>37、configMAX_CO_ROUTINE_PRIORITIES</strong></p>\n<p><a href=\"https://www.freertos.org/co-routine-priorities.html\">应用程序协程（Co-routines）的有效优先级数目</a> 。任意数量的协同例程可以共享相同的优先级，使用协程可以单独的分配给任务优先级，请参阅  <code>configMAX_PRIORITIES</code>  。</p>\n<p><strong>38、configUSE_TIMERS</strong></p>\n<p>置  <code>1</code>  ：使用软件定时器；</p>\n<p>置  <code>0</code>  ：不使用软件定时器</p>\n<p>有关完整说明，请参见 <a href=\"https://www.freertos.org/RTOS-software-timer.html\">FreeRTOS software timers</a> 页面。</p>\n<p><strong>39、configTIMER_TASK_PRIORITY</strong></p>\n<p>设置软件计时器服务 / 守护程序任务的优先级。</p>\n<p>有关完整说明，请参见 <a href=\"https://www.freertos.org/RTOS-software-timer.html\">FreeRTOS software timers</a> 页面。</p>\n<p><strong>40、configTIMER_QUEUE_LENGTH</strong></p>\n<p>设置软件计时器命令队列的长度。</p>\n<p>有关完整说明，请参见 <a href=\"https://www.freertos.org/RTOS-software-timer.html\">FreeRTOS software timers</a> 页面。</p>\n<p><strong>41、configTIMER_TASK_STACK_DEPTH</strong></p>\n<p>设置分配给软件计时器服务 / 守护程序任务的堆栈深度。</p>\n<p>有关完整说明，请参见 <a href=\"https://www.freertos.org/RTOS-software-timer.html\">FreeRTOS software timers</a> 页面。</p>\n<p><strong>42、configKERNEL_INTERRUPT_PRIORITY 、configMAX_SYSCALL_INTERRUPT_PRIORITY 和 configMAX_API_CALL_INTERRUPT_PRIORITY</strong></p>\n<p>包含  <code>configKERNEL_INTERRUPT_PRIORITY</code>  设置的硬件端口有 ARM Cortex-M3，PIC24，dsPIC，PIC32，SuperH 和 RX600。</p>\n<p>包含  <code>configMAX_SYSCALL_INTERRUPT_PRIORITY</code>  设置的硬件端口有 PIC32，RX600，ARM Cortex-A 和 ARM Cortex-M。</p>\n<p><code>configMAX_API_CALL_INTERRUPT_PRIORITY</code>  是  <code>configMAX_SYSCALL_INTERRUPT_PRIORITY</code>  的新名称，仅由较新的端口使用，两者是等效的。</p>\n<p><code>configKERNEL_INTERRUPT_PRIORITY</code>  应该设置为最低优先级。</p>\n<p>请注意，在以下讨论中，只能从中断服务例程中调用以 “FromISR” 结尾的 API 函数。</p>\n<p>对于仅支持  <code>configKERNEL_INTERRUPT_PRIORITY</code>  的硬件端口：<br />\n <code>configKERNEL_INTERRUPT_PRIORITY</code>  设置 RTOS 内核本身使用的中断优先级。调用 API 函数的中断也必须以此优先级执行。不调用 API 函数的中断可以以更高的优先级执行，因此不会因 RTOS 内核活动（在硬件本身的限制内）而延迟执行。</p>\n<p>对于同时支持  <code>configKERNEL_INTERRUPT_PRIORITY</code>  和  <code>configMAX_SYSCALL_INTERRUPT_PRIORITY</code>  的硬件端口：<br />\n <code>configKERNEL_INTERRUPT_PRIORITY</code>  设置 RTOS 内核本身使用的中断优先级。 <code>configMAX_SYSCALL_INTERRUPT_PRIORITY</code>  设置最高的中断优先级，从中可以调用中断安全的 FreeRTOS API 函数。</p>\n<p>通过设置  <code>configMAX_SYSCALL_INTERRUPT_PRIORITY</code>  的优先级级别高于  <code>configKERNEL_INTERRUPT_PRIORITY</code>  可以实现完整的中断嵌套模式；<strong>这意味着即使在关键部分内部，FreeRTOS 内核也不会完全禁用中断</strong> 。</p>\n<p>此外，这对于分段内核架构的微处理器是有利的。但是请注意，当一个新的中断被接受时，某些微控制器体系结构（在硬件中）将禁用中断，这意味着在硬件接受中断和 FreeRTOS 代码重新启用中断之间的短时间内不可避免地禁用中断。</p>\n<p>不调用 API 函数的中断可以以高于  <code>configMAX_SYSCALL_INTERRUPT_PRIORITY</code>  的优先级执行，因此不会因 RTOS 内核执行而延迟。</p>\n<p>例如：假设一个微控制器有 8 个中断优先级别：0 表示最低优先级，7 表示最高优先级（Cortex-M3 和 Cortex-M4 内核优先数和优先级别正好与之相反，后续文章会专门介绍它们）下在图描述了如果将两个配置常量设置为 4 和 0，则在每个优先级上可以做什么和不能做什么，如下所示：</p>\n<p><img src=\"20200217155104470.png\" alt=\"img\" /></p>\n<p>这些配置参数允许非常灵活的中断处理：</p>\n<ul>\n<li>在系统中可以像其它任务一样为中断处理任务分配优先级。这些任务通过一个相应中断唤醒。中断服务程序（ISR）本身应写得尽可能短，仅用于更新数据然后唤醒高优先级任务；然后，ISR 退出后，直接运行被唤醒的任务，因此中断处理（根据中断获取的数据来进行的相应处理）在时间上是连续的，就像 ISR 在完成这些工作。这样做的好处是，在执行处理程序任务时，所有中断都保持启用状态。</li>\n<li>支持  <code>configMAX_SYSCALL_INTERRUPT_PRIORITY</code>  的硬件端口将进一步扩展：允许使用完全嵌套的模型，其中 RTOS 内核中断优先级和  <code>configMAX_SYSCALL_INTERRUPT_PRIORITY</code>  之间的中断可以嵌套并允许调用 API 函数；而优先级高于 <code>configMAX_SYSCALL_INTERRUPT_PRIORITY</code>  的中断不会因 RTOS 内核活动而延迟。</li>\n<li>在最高系统调用优先级之上运行的 ISR（大于  <code>configMAX_SYSCALL_INTERRUPT_PRIORITY</code>  的优先级中断）不会被 RTOS 内核本身掩盖，因此它们的响应能力不受 RTOS 内核功能的影响。对于要求非常高的时间精度的中断（例如，执行电机转向的中断）而言，这是理想的选择；但是，在这类中断的中断服务例程中绝不可以调用 FreeRTOS 的 API 函数。</li>\n</ul>\n<p>要使用此方案，您的应用程序设计必须遵守以下规则：<strong>使用 FreeRTOS API 的任何中断必须设置为与 RTOS 内核相同的优先级（由  <code>configKERNEL_INTERRUPT_PRIORITY</code>  宏配置）；或者对于包含支持  <code>configMAX_SYSCALL_INTERRUPT_PRIORITY</code>  功能的硬件端口，设置低于  <code>configMAX_SYSCALL_INTERRUPT_PRIORITY</code>  定义的优先级</strong></p>\n<p>针对 ARM Cortex-M3 和 ARM Cortex-M4 用户的特别说明：请阅读 <a href=\"https://www.freertos.org/RTOS-Cortex-M3-M4.html\">专门介绍 ARM Cortex-M 设备上的中断优先级设置的页面</a> 。至少要记住，ARM Cortex-M3 内核使用数字低优先级数字来表示高优先级中断，这看起来似乎违反直觉，而且很容易忘记！如果您希望为中断分配一个低优先级，请不要为其分配优先级 0（或其他低数值），因为这可能导致在系统中实际上是具有最高优先级中断的；因此，如果这个优先级高于  <code>configMAX_SYSCALL_INTERRUPT_PRIORITY</code>  ，将会导致系统崩溃。</p>\n<p>实际上，ARM Cortex-M3 内核的最低优先级为 255，但是，不同的 ARM Cortex-M3 供应商实现了不同数量的优先级位，并提供了期望以不同方式指定优先级的库函数。例如，在 STM32 上，您可以在 ST 驱动程序库调用中，根据实际情况把最低优先级指定为 15，而最高优先级为 0。</p>\n<p>总结一下就是，在 FreeRtos 中调用中断关闭和中断开启 API 函数（例如在临界区区域内），其控制只对  <code>configKERNEL_INTERRUPT_PRIORITY</code>  到  <code>configMAX_SYSCALL_INTERRUPT_PRIORITY</code>  之间的优先级有效，其余的中断不受影响</p>\n<p><strong>43、configASSERT</strong></p>\n<p><code>configASSERT()</code>  宏的语义与标准 C  <code>assert()</code>  宏相同。如果传递给  <code>configASSERT()</code>  的参数为零，则触发断言。</p>\n<p>在整个 FreeRTOS 源文件中都会调用  <code>configASSERT()</code>  来检查应用程序是如何使用 FreeRTOS；因此强烈建议使用定义的  <code>configASSERT()</code>  开发 FreeRTOS 应用程序。</p>\n<p>举一个例子，我们想把非法参数所在的文件名和代码行数打印出来，可以先定义一个函数  <code>vAssertCalled</code>  ，并传入触发  <code>configASSERT()</code>  调用的文件名和行号（__FILE__和 __LINE__是大多数编译器提供的标准宏）：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* Define configASSERT() to call vAssertCalled() if the assertion fails.  The assertion</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>has failed if the value of the parameter passed into configASSERT() equals zero. */</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">configASSERT</span><span class=\"token expression\"><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> x <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span>     <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> x <span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span> <span class=\"token function\">vAssertCalled</span><span class=\"token punctuation\">(</span> <span class=\"token constant\">__FILE__</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">__LINE__</span> <span class=\"token punctuation\">)</span></span></span></pre></td></tr></table></figure><p>这里只是为了演示，因为  <code>vAssertCalled()</code>  不是 FreeRTOS 里面的函数，可以将  <code>configASSERT()</code>  定义为采取应用程序编写者认为适当的任何操作。通常以这样的方式定义  <code>configASSERT()</code>  ，它可以防止应用程序进一步执行；这有两个原因：在断言停止的地方，应用程序编写者可以调试产生断言的原因；若继续执行触发断言之后的程序可能会导致系统崩溃。</p>\n<p>请注意，定义  <code>configASSERT()</code>  会增加应用程序代码的大小和执行时间；当应用程序稳定后，只需注释掉  <code>FreeRTOSConfig.h</code>  中的  <code>configASSERT()</code>  定义，就可以消除额外的开销了。</p>\n<p>如果在调试器的控制下运行 FreeRTOS，则可以把  <code>configASSERT()</code>  定义为禁用中断并处于循环中的状态，如下所示。这将导致在断言测试失败的行上停止代码的运行，应用程序编写者只需要暂停调试器，就会立即将您带到有问题的行，以便您查看失败的原因。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* Define configASSERT() to disable interrupts and sit in a loop. */</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">configASSERT</span><span class=\"token expression\"><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> x <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span>     <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> x <span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token function\">taskDISABLE_INTERRUPTS</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></span></span></pre></td></tr></table></figure><p><strong>44、configINCLUDE_APPLICATION_DEFINED_PRIVILEGED_FUNCTIONS</strong></p>\n<p><code>configINCLUDE_APPLICATION_DEFINED_PRIVILEGED_FUNCTIONS</code>  仅由 FreeRTOS MPU 使用。</p>\n<p>如果  <code>configINCLUDE_APPLICATION_DEFINED_PRIVILEGED_FUNCTIONS</code>  设置为  <code>1</code>  ，则应用程序编写者必须提供一个名为 “  <code>application_defined_privileged_functions.h</code>  ” 的头文件，可以在其之中实现应用程序编写者需要以特权模式执行的功能。请注意，尽管扩展名为  <code>.h</code>  ，但头文件应包含 C 函数的实现，而不仅仅是函数的原型。</p>\n<p>在 “  <code>application_defined_privileged_functions.h</code>  ” 中实现的函数必须分别使用  <code>prvRaisePrivilege()</code>  函数和  <code>portRESET_PRIVILEGE()</code>  宏来保存和恢复处理器的特权状态.</p>\n<p>例如，如果库提供的打印功能访问了应用程序编写者无法控制的 RAM，因此无法分配给受内存保护的用户模式任务，则可以使用以下代码将打印功能封装在特权功能中：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">MPU_debug_printf</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>pcMessage <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">/* State the privilege level of the processor when the function was called. */</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>BaseType_t xRunningPrivileged <span class=\"token operator\">=</span> <span class=\"token function\">prvRaisePrivilege</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">/* Call the library function, which now has access to all RAM. */</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token function\">debug_printf</span><span class=\"token punctuation\">(</span> pcMessage <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">/* Reset the processor privilege level to its original value. */</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token function\">portRESET_PRIVILEGE</span><span class=\"token punctuation\">(</span> xRunningPrivileged <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>该技术只能在开发过程中使用，而不能在部署过程中使用，因为它会绕过内存保护。</p>\n<h1 id=\"包含参数\"><a class=\"anchor\" href=\"#包含参数\">#</a> 包含参数</h1>\n<p>以 “INCLUDE” 开头的宏允许将实时内核中那些未被应用程序使用的组件从构建中排除，这样可以确保 RTOS 使用的 ROM 或 RAM 不会超出特定嵌入式应用程序所需的数量</p>\n<p>每个宏采用以下形式：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>INCLUDE_FunctionName</pre></td></tr></table></figure><p>其中 FunctionName 表示可以选择排除的 API 函数（或函数集）</p>\n<p>置  <code>1</code>  ：使用该 API 函数；</p>\n<p>置  <code>0</code>  ：不使用该 API 函数。</p>\n<p>例如，包含  <code>vTaskDelete()</code>  API 函数，请使用：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">INCLUDE_vTaskDelete</span>    <span class=\"token expression\"><span class=\"token number\">1</span></span></span></pre></td></tr></table></figure><p>要从构建中排除  <code>vTaskDelete()</code>  ，请使用：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">INCLUDE_vTaskDelete</span>    <span class=\"token expression\"><span class=\"token number\">0</span></span></span></pre></td></tr></table></figure><h1 id=\"配置项裁剪\"><a class=\"anchor\" href=\"#配置项裁剪\">#</a> 配置项裁剪</h1>\n<p>在了解完上面的各项参数后，就可以配置了，具体如下：</p>\n<pre><code class=\"language-Swift\">/*\n    FreeRTOS V9.0.0 - Copyright (C) 2016 Real Time Engineers Ltd.\n    All rights reserved\n\n    VISIT http://www.FreeRTOS.org TO ENSURE YOU ARE USING THE LATEST VERSION.\n\n    This file is part of the FreeRTOS distribution.\n\n    FreeRTOS is free software; you can redistribute it and/or modify it under\n    the terms of the GNU General Public License (version 2) as published by the\n    Free Software Foundation &gt;&gt;&gt;&gt; AND MODIFIED BY &lt;&lt;&lt;&lt; the FreeRTOS exception.\n\n    ***************************************************************************\n    &gt;&gt;!   NOTE: The modification to the GPL is included to allow you to     !&lt;&lt;\n    &gt;&gt;!   distribute a combined work that includes FreeRTOS without being   !&lt;&lt;\n    &gt;&gt;!   obliged to provide the source code for proprietary components     !&lt;&lt;\n    &gt;&gt;!   outside of the FreeRTOS kernel.                                   !&lt;&lt;\n    ***************************************************************************\n\n    FreeRTOS is distributed in the hope that it will be useful, but WITHOUT ANY\n    WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS\n    FOR A PARTICULAR PURPOSE.  Full license text is available on the following\n    link: http://www.freertos.org/a00114.html\n\n    ***************************************************************************\n     *                                                                       *\n     *    FreeRTOS provides completely free yet professionally developed,    *\n     *    robust, strictly quality controlled, supported, and cross          *\n     *    platform software that is more than just the market leader, it     *\n     *    is the industry's de facto standard.                               *\n     *                                                                       *\n     *    Help yourself get started quickly while simultaneously helping     *\n     *    to support the FreeRTOS project by purchasing a FreeRTOS           *\n     *    tutorial book, reference manual, or both:                          *\n     *    http://www.FreeRTOS.org/Documentation                              *\n     *                                                                       *\n    ***************************************************************************\n\n    http://www.FreeRTOS.org/FAQHelp.html - Having a problem?  Start by reading\n    the FAQ page &quot;My application does not run, what could be wrong?&quot;.  Have you\n    defined configASSERT()?\n\n    http://www.FreeRTOS.org/support - In return for receiving this top quality\n    embedded software for free we request you assist our global community by\n    participating in the support forum.\n\n    http://www.FreeRTOS.org/training - Investing in training allows your team to\n    be as productive as possible as early as possible.  Now you can receive\n    FreeRTOS training directly from Richard Barry, CEO of Real Time Engineers\n    Ltd, and the world's leading authority on the world's leading RTOS.\n\n    http://www.FreeRTOS.org/plus - A selection of FreeRTOS ecosystem products,\n    including FreeRTOS+Trace - an indispensable productivity tool, a DOS\n    compatible FAT file system, and our tiny thread aware UDP/IP stack.\n\n    http://www.FreeRTOS.org/labs - Where new FreeRTOS products go to incubate.\n    Come and try FreeRTOS+TCP, our new open source TCP/IP stack for FreeRTOS.\n\n    http://www.OpenRTOS.com - Real Time Engineers ltd. license FreeRTOS to High\n    Integrity Systems ltd. to sell under the OpenRTOS brand.  Low cost OpenRTOS\n    licenses offer ticketed support, indemnification and commercial middleware.\n\n    http://www.SafeRTOS.com - High Integrity Systems also provide a safety\n    engineered and independently SIL3 certified version for use in safety and\n    mission critical applications that require provable dependability.\n\n    1 tab == 4 spaces!\n*/\n\n#ifndef FREERTOS_CONFIG_H\n#define FREERTOS_CONFIG_H\n\n/*-----------------------------------------------------------\n * Application specific definitions.\n *\n * These definitions should be adjusted for your particular hardware and\n * application requirements.\n *\n * THESE PARAMETERS ARE DESCRIBED WITHIN THE 'CONFIGURATION' SECTION OF THE\n * FreeRTOS API DOCUMENTATION AVAILABLE ON THE FreeRTOS.org WEB SITE. \n *\n * See http://www.freertos.org/a00110.html.\n *----------------------------------------------------------*/\n\n/* Here is a good place to include header files that are required across\nyour application. */\n// #include &quot;stm32f10x.h&quot;\n\n\n#if defined(__ICCARM__) || defined(__CC_ARM) || defined(__GNUC__)\n    /* Clock manager provides in this variable system core clock frequency */\n    #include &lt;stdint.h&gt;\n\t#include &lt;stdio.h&gt;\n    extern uint32_t SystemCoreClock;\n#endif\n\n#define configUSE_PREEMPTION                    1\n#define configUSE_PORT_OPTIMISED_TASK_SELECTION 1\n#define configUSE_TICKLESS_IDLE                 0\n#define configCPU_CLOCK_HZ                      ( ( unsigned long ) SystemCoreClock )\n#define configTICK_RATE_HZ                      ( ( TickType_t ) 1000 )\n#define configMAX_PRIORITIES                    ( 5 )\n#define configMINIMAL_STACK_SIZE                ( ( unsigned short ) 128 )\n#define configMAX_TASK_NAME_LEN                 ( 16 )\n#define configUSE_16_BIT_TICKS                  0\n#define configIDLE_SHOULD_YIELD                 1\n#define configUSE_TASK_NOTIFICATIONS            1\n#define configUSE_MUTEXES                       0\n#define configUSE_RECURSIVE_MUTEXES             0\n#define configUSE_COUNTING_SEMAPHORES           0\n#define configUSE_ALTERNATIVE_API               0 /* Deprecated! */\n#define configQUEUE_REGISTRY_SIZE               10\n#define configUSE_QUEUE_SETS                    0\n#define configUSE_TIME_SLICING                  1\n#define configUSE_NEWLIB_REENTRANT              0\n#define configENABLE_BACKWARD_COMPATIBILITY     0\n#define configNUM_THREAD_LOCAL_STORAGE_POINTERS 5\n#define configSTACK_DEPTH_TYPE                  uint16_t\n#define configMESSAGE_BUFFER_LENGTH_TYPE        size_t\n\n/* Memory allocation related definitions. */\n#define configSUPPORT_STATIC_ALLOCATION         0\n#define configSUPPORT_DYNAMIC_ALLOCATION        1\n#define configTOTAL_HEAP_SIZE                   ( ( size_t ) ( 17 * 1024 ) )\n#define configAPPLICATION_ALLOCATED_HEAP        0\n\n/* Hook function related definitions. */\n#define configUSE_IDLE_HOOK                     0\n#define configUSE_TICK_HOOK                     0\n#define configCHECK_FOR_STACK_OVERFLOW          0\n#define configUSE_MALLOC_FAILED_HOOK            0\n#define configUSE_DAEMON_TASK_STARTUP_HOOK      0\n\n/* Run time and task stats gathering related definitions. */\n#define configGENERATE_RUN_TIME_STATS           0\n#define configUSE_TRACE_FACILITY                0\n#define configUSE_STATS_FORMATTING_FUNCTIONS    1\n\n/* Co-routine related definitions. */\n#define configUSE_CO_ROUTINES                   0\n#define configMAX_CO_ROUTINE_PRIORITIES         ( 2 )\n\n/* Software timer related definitions. */\n#define configUSE_TIMERS                        0\n#define configTIMER_TASK_PRIORITY               (configMAX_PRIORITIES-1)\n#define configTIMER_QUEUE_LENGTH                10\n#define configTIMER_TASK_STACK_DEPTH            (configMINIMAL_STACK_SIZE*2)\n\n/* Interrupt nesting behaviour configuration. */\n#ifdef __NVIC_PRIO_BITS\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t/* user add */\n\t#define configPRIO_BITS       \t\t\t__NVIC_PRIO_BITS\n#else\n\t#define configPRIO_BITS       \t\t\t4                  \n#endif /* __NVIC_PRIO_BITS */\n/* This is the value being used as per the ST library which permits 16\npriority values, 0 to 15.  This must correspond to the\nconfigKERNEL_INTERRUPT_PRIORITY setting.  Here 15 corresponds to the lowest\nNVIC value of 255. */\n#define configLIBRARY_KERNEL_INTERRUPT_PRIORITY\t\t15\t\t\t\t\t\t\t\t// user add\n#define configLIBRARY_MAX_SYSCALL_INTERRUPT_PRIORITY\t11\t\t\t\t\t\t\t\t// user add\n/* This is the raw value as per the Cortex-M3 NVIC.  Values can be 255\n(lowest) to 0 (1?) (highest). */\n/* equivalent to 0xf0, or NVIC 240. */\n#define configKERNEL_INTERRUPT_PRIORITY         (configLIBRARY_KERNEL_INTERRUPT_PRIORITY &lt;&lt; (8 - configPRIO_BITS))//[dependent of processor]\n/* !!!! configMAX_SYSCALL_INTERRUPT_PRIORITY must not be set to zero !!!! */\n/* equivalent to 0xb0, or priority 11. */\n#define configMAX_SYSCALL_INTERRUPT_PRIORITY    (configLIBRARY_MAX_SYSCALL_INTERRUPT_PRIORITY &lt;&lt; (8 - configPRIO_BITS))//[dependent on processor and application]\n#define configMAX_API_CALL_INTERRUPT_PRIORITY   //[dependent on processor and application]\n\n/* Define to trap errors during development. */\n#define vAssertCalled(char, int)\t\t\tprintf(&quot;Error:%s,%d\\r\\n&quot;,char,int)\t\t// user add\n//#define configASSERT( ( x ) ) if( ( x ) == 0 )\tvAssertCalled( __FILE__, __LINE__ )\n#define configASSERT( x )\t  if( ( x ) == 0 ) \tvAssertCalled(__FILE__,__LINE__)\t\t// The user needs to modify\n\n/* FreeRTOS MPU specific definitions. */\n#define configINCLUDE_APPLICATION_DEFINED_PRIVILEGED_FUNCTIONS 0\n\n/* Optional functions - most linkers will remove unused functions anyway. */\n#define INCLUDE_vTaskPrioritySet                1\n#define INCLUDE_uxTaskPriorityGet               1\n#define INCLUDE_vTaskDelete                     1\n#define INCLUDE_vTaskSuspend                    1\n#define INCLUDE_xResumeFromISR                  1\n#define INCLUDE_vTaskDelayUntil                 1\n#define INCLUDE_vTaskDelay                      1\n#define INCLUDE_xTaskGetSchedulerState          1\n#define INCLUDE_xTaskGetCurrentTaskHandle       1\n#define INCLUDE_uxTaskGetStackHighWaterMark     0\n#define INCLUDE_xTaskGetIdleTaskHandle          0\n#define INCLUDE_eTaskGetState                   1\n#define INCLUDE_xEventGroupSetBitFromISR        1\n#define INCLUDE_xTimerPendFunctionCall          0\n#define INCLUDE_xTaskAbortDelay                 0\n#define INCLUDE_xTaskGetHandle                  0\n#define INCLUDE_xTaskResumeFromISR              1\n\n/* A header file that defines trace macro can be included here. */\n\n#define xPortPendSVHandler   \t\t\tPendSV_Handler\n#define xPortSysTickHandler \t\t\tSysTick_Handler\n#define vPortSVCHandler      \t\t\tSVC_Handler\n\n\n#endif /* FREERTOS_CONFIG_H */\n</code></pre>\n<p>然后，值得注意的是，在 Cortex-M3 硬件端口下，FreeRTOS 使用 SysTick 作为系统节拍时钟，使用 SVC 和 PendSVC 进行上下文切换；异常中断服务代码位于 port.c 文件中，FreeRTOS 的作者已经为各种架构的 CPU 写好了这些代码，可以直接拿来用，因此我们只需要进行更改调用；这里有两种方法：</p>\n<ul>\n<li><strong>第一种是在 Cortex-M3 启动文件中进行替换，将这些异常中断入口地址挂接到启动代码中</strong></li>\n</ul>\n<p><img src=\"20200217153706659.png\" alt=\"img\" /></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>DCD     SVC_Handler            换成：   DCD     vPortSVCHandler</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>DCD     PendSV_Handler         换成：   DCD     xPortPendSVHandler</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>DCD     SysTick_Handler        换成：   DCD     xPortSysTickHandler</pre></td></tr></table></figure><p>在方框中，按照上面的信息把向量地址名替换掉</p>\n<ul>\n<li><strong>第二种是利用宏重定义一下，并且要把 ST 官方预留的中断屏蔽掉，转而使用 FreeRTOS 中实现的函数功能</strong></li>\n</ul>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">xPortPendSVHandler</span>   \t\t\t<span class=\"token expression\">PendSV_Handler</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">xPortSysTickHandler</span> \t\t\t<span class=\"token expression\">SysTick_Handler</span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">vPortSVCHandler</span>      \t\t\t<span class=\"token expression\">SVC_Handler</span></span></pre></td></tr></table></figure><p>在  <code>FreeRTOSConfig.h</code>  头文件中添加以上宏，看上面给出的应用代码，然后再注释掉 ST 预留的中断函数：</p>\n<p><img src=\"20200217154404470.png\" alt=\"img\" /></p>\n<p>在这里是利用了宏  <code>_FreeRTOS</code>  来管理，当然你也可以直接注释，又或者设置成弱定义函数，随你喜欢，只要不出现重命名就好了。</p>\n",
            "tags": [
                "history",
                "FreeRTOS",
                "RTOS"
            ]
        },
        {
            "id": "https://arachnid.cc/freertos-heap/",
            "url": "https://arachnid.cc/freertos-heap/",
            "title": "FreeRTOS 篇章之 heap 堆内存分配分析",
            "date_published": "2020-02-15T12:35:03.000Z",
            "content_html": "<h1 id=\"freertos内存分配选择\"><a class=\"anchor\" href=\"#freertos内存分配选择\">#</a> FreeRTOS 内存分配选择</h1>\n<p>在 FreeRTOS 中，可以用静态（不使用 FreeRTOS 堆）或动态来分配 RTOS 的对象； 因此 FreeRTOS 中提供了 5 种堆管理方案，这些方案的复杂性和功能使得它的使用范围广泛，当然用户也可以自己实现堆管理；在官方的例程中，动静态的使用选择可以通过使能宏  <code>configSUPPORT_STATIC_ALLOCATION</code>  和宏  <code>configSUPPORT_DYNAMIC_ALLOCATION</code>  来进行决定（官方默认是使用动态内存进行分配的），当然，前提是使用 FreeRTOS 提供的 heap 堆分配的其中一个文件，而不是用自己实现的堆管理；甚至你还可以两种方法都在同一 RTOS 应用程序中使用。</p>\n<h1 id=\"静态与动态内存分配\"><a class=\"anchor\" href=\"#静态与动态内存分配\">#</a> 静态与动态内存分配</h1>\n<p>V9.0.0 之前的 FreeRTOS 版本是从特殊的 FreeRTOS 堆中（也就是这几个  <code>heap</code>  文件）分配下面列出的 RTOS 对象使用的内存。而在 FreeRTOS V9.0.0 及更高版本中，人们可以自己实现堆管理提供内存，从而可以选择创建以下对象，而无需动态分配任何内存：</p>\n<ul>\n<li>任务</li>\n<li>软件计时器</li>\n<li>队列</li>\n<li>事件</li>\n<li>二值信号量</li>\n<li>计数信号量</li>\n<li>递归信号量</li>\n<li>互斥量</li>\n</ul>\n<p><strong>1、使用动态分配的 RAM 创建 RTOS 对象</strong></p>\n<p>动态创建 RTOS 对象的好处是可以更加简单、并有可能尽最大程度地减少应用程序的最大 RAM 使用量</p>\n<p>如果  <code>configSUPPORT_DYNAMIC_ALLOCATION</code>  设置为 1 或未定义，以下 API 函数将使用动态分配的 RAM 创建 RTOS 对象：</p>\n<ul>\n<li><a href=\"https://www.freertos.org/a00125.html\">xTaskCreate()</a></li>\n<li><a href=\"https://www.freertos.org/a00116.html\">xQueueCreate()</a></li>\n<li><a href=\"https://www.freertos.org/FreeRTOS-timers-xTimerCreate.html\">xTimerCreate()</a></li>\n<li><a href=\"https://www.freertos.org/xEventGroupCreate.html\">xEventGroupCreate()</a></li>\n<li><a href=\"https://www.freertos.org/xSemaphoreCreateBinary.html\">xSemaphoreCreateBinary()</a></li>\n<li><a href=\"https://www.freertos.org/CreateCounting.html\">xSemaphoreCreateCounting()</a></li>\n<li><a href=\"https://www.freertos.org/CreateMutex.html\">xSemaphoreCreateMutex()</a></li>\n<li><a href=\"https://www.freertos.org/xSemaphoreCreateRecursiveMutex.html\">xSemaphoreCreateRecursiveMutex()</a></li>\n</ul>\n<p><strong>2、使用静态分配的 RAM 创建 RTOS 对象</strong></p>\n<p>使用静态分配的 RAM 创建 RTOS 对象的好处是为应用程序编写者提供了更多控制权</p>\n<p>下列 API 函数（如果  <code>configSUPPORT_STATIC_ALLOCATION</code>  设置为 1 时可用）允许使用应用程序编写者实现的堆管理创建 RTOS 对象。为了提供内存，应用程序编写者只需要声明一个适当对象类型的变量，然后将变量的地址传递给 RTOS API 函数即可。官方也提供了 <a href=\"https://sourceforge.net/p/freertos/code/HEAD/tree/trunk/FreeRTOS/Demo/Common/Minimal/StaticAllocation.c\">StaticAllocation.c</a> 标准的演示 / 测试任务来演示如何使用这些功能：</p>\n<ul>\n<li><a href=\"https://www.freertos.org/xTaskCreateStatic.html\">xTaskCreateStatic()</a></li>\n<li><a href=\"https://www.freertos.org/xQueueCreateStatic.html\">xQueueCreateStatic()</a></li>\n<li><a href=\"https://www.freertos.org/xTimerCreateStatic.html\">xTimerCreateStatic()</a></li>\n<li><a href=\"https://www.freertos.org/xEventGroupCreateStatic.html\">xEventGroupCreateStatic()</a></li>\n<li><a href=\"https://www.freertos.org/xSemaphoreCreateBinaryStatic.html\">xSemaphoreCreateBinaryStatic()</a></li>\n<li><a href=\"https://www.freertos.org/xSemaphoreCreateCountingStatic.html\">xSemaphoreCreateCountingStatic()</a></li>\n<li><a href=\"https://www.freertos.org/xSemaphoreCreateMutexStatic.html\">xSemaphoreCreateMutexStatic()</a></li>\n<li><a href=\"https://www.freertos.org/xSemaphoreCreateRecursiveMutexStatic.html\">xSemaphoreCreateRecursiveMutexStatic()</a></li>\n</ul>\n<h1 id=\"内存管理\"><a class=\"anchor\" href=\"#内存管理\">#</a> 内存管理</h1>\n<p>如果 RTOS 对象是动态创建的，则有时可以使用标准 C 库  <code>malloc()</code>  和  <code>free()</code>  函数来实现此目的，但是 …</p>\n<ol>\n<li>它们并不总是在嵌入式系统上可用；</li>\n<li>他们占用了宝贵的代码空间；</li>\n<li>它们不是线程安全的；</li>\n<li>它们不是确定性的（执行函数所花费的时间因调用而异）。</li>\n</ol>\n<p>因此，通常需要另一种内存分配实现。</p>\n<p>一个嵌入式 / 实时系统可能具有与另一个系统不同的 RAM 和时序要求；因此，单个 RAM 分配算法仅适用于部分应用程序。</p>\n<p>为了解决这个问题，FreeRTOS 将内存分配 API 保留在其可移植层中；当 RTOS 内核需要 RAM 时，它不调用  <code>malloc()</code> ，而是调用  <code>pvPortMalloc()</code>  ；当释放 RAM 时，RTOS 内核将调用  <code>vPortFree()</code>  而不是调用  <code>free()</code>  。</p>\n<p>在  <code>FreeRTOSv9.0.0\\FreeRTOS\\Source\\portable\\MemMang</code>  文档中，FreeRTOS 提供了五个内存分配实现：</p>\n<ul>\n<li><a href=\"https://www.freertos.org/a00111.html#heap_1\">heap_1</a> – 最简单，不允许释放内存。</li>\n<li><a href=\"https://www.freertos.org/a00111.html#heap_2\">heap_2</a> – 允许释放内存，但不合并相邻的空闲块。</li>\n<li><a href=\"https://www.freertos.org/a00111.html#heap_3\">heap_3</a> – 简单包装标准  <code>malloc()</code>  和  <code>free()</code>  以确保线程安全。</li>\n<li><a href=\"https://www.freertos.org/a00111.html#heap_4\">heap_4</a> – 合并相邻的空闲块以避免碎片；包括绝对地址放置选项。</li>\n<li><a href=\"https://www.freertos.org/a00111.html#heap_5\">heap_5</a> – 参照  <code>heap_4</code> ，能够跨多个不相邻的内存区域扩展堆。</li>\n</ul>\n<h2 id=\"heap_1c\"><a class=\"anchor\" href=\"#heap_1c\">#</a> heap_1.c</h2>\n<p>在这个文件中有这么一项注释： <strong>The simplest possible implementation of pvPortMalloc().  Note that this implementation does NOT allow allocated memory to be freed again.</strong> 也就是表明了  <code>heap_1.c</code>  这个文件的功能只能进行分配，不支持释放内存。</p>\n<p>它的分配函数实现：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token function\">pvPortMalloc</span><span class=\"token punctuation\">(</span> size_t xWantedSize <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>pvReturn <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">uint8_t</span> <span class=\"token operator\">*</span>pucAlignedHeap <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token comment\">/* Ensure that blocks are always aligned to the required number of bytes. */</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span><span class=\"token expression\"><span class=\"token punctuation\">(</span> portBYTE_ALIGNMENT <span class=\"token operator\">!=</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> xWantedSize <span class=\"token operator\">&amp;</span> portBYTE_ALIGNMENT_MASK <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t\t<span class=\"token comment\">/* Byte alignment required. */</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\txWantedSize <span class=\"token operator\">+=</span> <span class=\"token punctuation\">(</span> portBYTE_ALIGNMENT <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span> xWantedSize <span class=\"token operator\">&amp;</span> portBYTE_ALIGNMENT_MASK <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token function\">vTaskSuspendAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> pucAlignedHeap <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t\t<span class=\"token comment\">/* Ensure the heap starts on a correctly aligned boundary. */</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t\tpucAlignedHeap <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">uint8_t</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> portPOINTER_SIZE_TYPE <span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span>ucHeap<span class=\"token punctuation\">[</span> portBYTE_ALIGNMENT <span class=\"token punctuation\">]</span> <span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">(</span> <span class=\"token operator\">~</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> portPOINTER_SIZE_TYPE <span class=\"token punctuation\">)</span> portBYTE_ALIGNMENT_MASK <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t<span class=\"token comment\">/* Check there is enough room left for the allocation. */</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> xNextFreeByte <span class=\"token operator\">+</span> xWantedSize <span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> configADJUSTED_HEAP_SIZE <span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t\t<span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> xNextFreeByte <span class=\"token operator\">+</span> xWantedSize <span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> xNextFreeByte <span class=\"token punctuation\">)</span>\t<span class=\"token punctuation\">)</span><span class=\"token comment\">/* Check for overflow. */</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t\t<span class=\"token comment\">/* Return the next free byte then increment the index past this</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t\tblock. */</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t\tpvReturn <span class=\"token operator\">=</span> pucAlignedHeap <span class=\"token operator\">+</span> xNextFreeByte<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t\txNextFreeByte <span class=\"token operator\">+=</span> xWantedSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t<span class=\"token function\">traceMALLOC</span><span class=\"token punctuation\">(</span> pvReturn<span class=\"token punctuation\">,</span> xWantedSize <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t<span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">)</span> <span class=\"token function\">xTaskResumeAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span><span class=\"token expression\"><span class=\"token punctuation\">(</span> configUSE_MALLOC_FAILED_HOOK <span class=\"token operator\">==</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> pvReturn <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t\t<span class=\"token keyword\">extern</span> <span class=\"token keyword\">void</span> <span class=\"token function\">vApplicationMallocFailedHook</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\t\t<span class=\"token function\">vApplicationMallocFailedHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t<span class=\"token keyword\">return</span> pvReturn<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>既然这么简单，就稍微分析一下吧！</p>\n<p>1、首先是对内存对齐的判断，这里，如果内存对齐有效，则执行；如果要分配的内存不是对齐字节 (通常是 8，根据  <code>portBYTE_ALIGNMENT</code>  来确定对齐字节) 的整数倍，则补齐，所以  <code>xWantedSize</code>  要加上要补齐的长度。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* Ensure that blocks are always aligned to the required number of bytes. */</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span><span class=\"token expression\"><span class=\"token punctuation\">(</span> portBYTE_ALIGNMENT <span class=\"token operator\">!=</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> xWantedSize <span class=\"token operator\">&amp;</span> portBYTE_ALIGNMENT_MASK <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t<span class=\"token comment\">/* Byte alignment required. */</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\txWantedSize <span class=\"token operator\">+=</span> <span class=\"token punctuation\">(</span> portBYTE_ALIGNMENT <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span> xWantedSize <span class=\"token operator\">&amp;</span> portBYTE_ALIGNMENT_MASK <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr></table></figure><p>2、接着挂起所有的调度器，防止在分配内存的过程中被打断。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vTaskSuspendAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>3、判断是否为第一次分配，若是，则检查初分配的内存是否有对齐，这里  <code>uheap</code>  是一个静态数组（是 FreeRTOS 为我们申请的一个内存堆，大小由宏  <code>configTOTAL_HEAP_SIZE</code>  决定），首先要确保它是否对齐，因为  <code>uheap</code>  的首地址可能不是 8 的倍数，若是没有对齐，那么进行对齐处理，以确保实际开始分配的地址是对齐的，值得留意的是，这个对齐处理只做一次。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> pucAlignedHeap <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token comment\">/* Ensure the heap starts on a correctly aligned boundary. */</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tpucAlignedHeap <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">uint8_t</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> portPOINTER_SIZE_TYPE <span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span>ucHeap<span class=\"token punctuation\">[</span> portBYTE_ALIGNMENT <span class=\"token punctuation\">]</span> <span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">(</span> <span class=\"token operator\">~</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> portPOINTER_SIZE_TYPE <span class=\"token punctuation\">)</span> portBYTE_ALIGNMENT_MASK <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>4、在正式分配前进行溢出检查，如果空间够用，则记录新分配空间的首地址到  <code>pvReturn</code>  ，并重新记录新的空闲空间的首地址到  <code>NextFreeByte</code>  。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* Check there is enough room left for the allocation. */</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> xNextFreeByte <span class=\"token operator\">+</span> xWantedSize <span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> configADJUSTED_HEAP_SIZE <span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> xNextFreeByte <span class=\"token operator\">+</span> xWantedSize <span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> xNextFreeByte <span class=\"token punctuation\">)</span>\t<span class=\"token punctuation\">)</span><span class=\"token comment\">/* Check for overflow. */</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token comment\">/* Return the next free byte then increment the index past this\tblock. */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tpvReturn <span class=\"token operator\">=</span> pucAlignedHeap <span class=\"token operator\">+</span> xNextFreeByte<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\txNextFreeByte <span class=\"token operator\">+=</span> xWantedSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>5、 <code>traceMALLOC( pvReturn, xWantedSize )</code>  是一个宏，用于输出内存分配的调试信息，这个宏定义在  <code>FreeRTOS.h</code>  中，默认为空，如果需要将这些调试信息输出到串口或其它东西，就可以修改这个宏将信息输出到所需要的地方。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">traceMALLOC</span><span class=\"token punctuation\">(</span> pvReturn<span class=\"token punctuation\">,</span> xWantedSize <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><img src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\" /></p>\n<p>6、最后，恢复之前挂起的调度器</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">)</span> <span class=\"token function\">xTaskResumeAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><img src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\" /></p>\n<p>7、这个取决于宏  <code>configUSE_MALLOC_FAILED_HOOK</code>  是否使能，如果开启了分配失败  <code>hook</code>  函数，就调用该  <code>hook</code>  。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span><span class=\"token expression\"><span class=\"token punctuation\">(</span> configUSE_MALLOC_FAILED_HOOK <span class=\"token operator\">==</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> pvReturn <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\t<span class=\"token keyword\">extern</span> <span class=\"token keyword\">void</span> <span class=\"token function\">vApplicationMallocFailedHook</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t<span class=\"token function\">vApplicationMallocFailedHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr></table></figure><p>适用环境以及功能简介：</p>\n<ul>\n<li>如果您的应用程序从不删除任务，队列，信号量，互斥锁等，则可以使用它（实际上涵盖了使用 FreeRTOS 的大多数应用程序）。</li>\n<li>始终是确定性的（总是花费相同的时间来执行），并且不会导致内存碎片。</li>\n<li>它是非常简单的，可以从静态分配的数组中分配内存，这意味着它通常适用于不允许真正的动态内存分配的应用程序。</li>\n</ul>\n<h2 id=\"heap_2c\"><a class=\"anchor\" href=\"#heap_2c\">#</a> heap_2.c</h2>\n<p>此方案使用了最佳适应算法（best fit algorithm），并且与<strong>方案 1</strong> 不同，它允许释放以前分配的块；它不会将相邻的空闲块合并成一个大块。</p>\n<p>同样的，文件里的注释： <strong>A sample implementation of pvPortMalloc() and vPortFree() that permits allocated blocks to be freed, but does not combine adjacent free blocks into a single larger block (and so will fragment memory).</strong> 也就是说现在支持分配和释放内存，但对内存碎片不做处理。</p>\n<p>1、在实现堆分配之前，有一个堆初始化的过程  <code>prvHeapInit()</code>  ，并且只调用一次（就是第一次进入该函数的时候）</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">prvHeapInit</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>BlockLink_t <span class=\"token operator\">*</span>pxFirstFreeBlock<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">uint8_t</span> <span class=\"token operator\">*</span>pucAlignedHeap<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token comment\">/* Ensure the heap starts on a correctly aligned boundary. */</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tpucAlignedHeap <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">uint8_t</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> portPOINTER_SIZE_TYPE <span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span>ucHeap<span class=\"token punctuation\">[</span> portBYTE_ALIGNMENT <span class=\"token punctuation\">]</span> <span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">(</span> <span class=\"token operator\">~</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> portPOINTER_SIZE_TYPE <span class=\"token punctuation\">)</span> portBYTE_ALIGNMENT_MASK <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token comment\">/* xStart is used to hold a pointer to the first item in the list of free</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tblocks.  The void cast is used to prevent compiler warnings. */</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\txStart<span class=\"token punctuation\">.</span>pxNextFreeBlock <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> pucAlignedHeap<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\txStart<span class=\"token punctuation\">.</span>xBlockSize <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span> size_t <span class=\"token punctuation\">)</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token comment\">/* xEnd is used to mark the end of the list of free blocks. */</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\txEnd<span class=\"token punctuation\">.</span>xBlockSize <span class=\"token operator\">=</span> configADJUSTED_HEAP_SIZE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\txEnd<span class=\"token punctuation\">.</span>pxNextFreeBlock <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token comment\">/* To start with there is a single free block that is sized to take up the</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\tentire heap space. */</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\tpxFirstFreeBlock <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> pucAlignedHeap<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\tpxFirstFreeBlock<span class=\"token operator\">-></span>xBlockSize <span class=\"token operator\">=</span> configADJUSTED_HEAP_SIZE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\tpxFirstFreeBlock<span class=\"token operator\">-></span>pxNextFreeBlock <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>xEnd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这里用到了  <code>BlockLink_t</code>  结构体，这个结构有两个成员，第一个是节点 Next 指针  <code>pxNextFreeBlock</code>  ，第二个是空闲块大小。结构体成员如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* Define the linked list structure.  This is used to link free blocks in order</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>of their size. */</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">A_BLOCK_LINK</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token keyword\">struct</span> <span class=\"token class-name\">A_BLOCK_LINK</span> <span class=\"token operator\">*</span>pxNextFreeBlock<span class=\"token punctuation\">;</span>\t<span class=\"token comment\">/*&lt;&lt; The next free block in the list. */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tsize_t xBlockSize<span class=\"token punctuation\">;</span>\t\t\t<span class=\"token comment\">/*&lt;&lt; The size of the free block. */</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span> BlockLink_t<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>首先，对开辟的堆进行地址对齐工作，对齐的原因的原理与  <code>heap_1</code>  一样，在获取堆的首地址后，对  <code>xStart</code>  链表头和  <code>xEnd</code>  链表尾进行初始化赋值；在  <code>heap_2</code>  中，与  <code>heap_1</code>  不同的是，由于 FreeRTOS 用空闲块对内存堆进行管理，于是用  <code>BlockLink_t</code>  这一个结构来形成一条空闲块链表对空闲块进行组织和管理。</p>\n<p>2、好了，现在回到  <code>pvPortMalloc()</code>  函数中。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token function\">pvPortMalloc</span><span class=\"token punctuation\">(</span> size_t xWantedSize <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>BlockLink_t <span class=\"token operator\">*</span>pxBlock<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>pxPreviousBlock<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>pxNewBlockLink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">static</span> BaseType_t xHeapHasBeenInitialised <span class=\"token operator\">=</span> pdFALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>pvReturn <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token function\">vTaskSuspendAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t<span class=\"token comment\">/* If this is the first call to malloc then the heap will require</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\tinitialisation to setup the list of free blocks. */</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> xHeapHasBeenInitialised <span class=\"token operator\">==</span> pdFALSE <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t\t<span class=\"token function\">prvHeapInit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t\txHeapHasBeenInitialised <span class=\"token operator\">=</span> pdTRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token comment\">/* The wanted size is increased so it can contain a BlockLink_t</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\tstructure in addition to the requested amount of bytes. */</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> xWantedSize <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t\txWantedSize <span class=\"token operator\">+=</span> heapSTRUCT_SIZE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t\t<span class=\"token comment\">/* Ensure that blocks are always aligned to the required number of bytes. */</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> xWantedSize <span class=\"token operator\">&amp;</span> portBYTE_ALIGNMENT_MASK <span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t\t\t<span class=\"token comment\">/* Byte alignment required. */</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t\t\txWantedSize <span class=\"token operator\">+=</span> <span class=\"token punctuation\">(</span> portBYTE_ALIGNMENT <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span> xWantedSize <span class=\"token operator\">&amp;</span> portBYTE_ALIGNMENT_MASK <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> xWantedSize <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span> xWantedSize <span class=\"token operator\">&lt;</span> configADJUSTED_HEAP_SIZE <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t\t<span class=\"token comment\">/* Blocks are stored in byte order - traverse the list from the start</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t\t(smallest) block until one of adequate size is found. */</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t\tpxPreviousBlock <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>xStart<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t\tpxBlock <span class=\"token operator\">=</span> xStart<span class=\"token punctuation\">.</span>pxNextFreeBlock<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t\t<span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> pxBlock<span class=\"token operator\">-></span>xBlockSize <span class=\"token operator\">&lt;</span> xWantedSize <span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span> pxBlock<span class=\"token operator\">-></span>pxNextFreeBlock <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t\t\tpxPreviousBlock <span class=\"token operator\">=</span> pxBlock<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t\t\tpxBlock <span class=\"token operator\">=</span> pxBlock<span class=\"token operator\">-></span>pxNextFreeBlock<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t\t<span class=\"token comment\">/* If we found the end marker then a block of adequate size was not found. */</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> pxBlock <span class=\"token operator\">!=</span> <span class=\"token operator\">&amp;</span>xEnd <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t\t\t<span class=\"token comment\">/* Return the memory space - jumping over the BlockLink_t structure</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\t\t\tat its start. */</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t\t\t\tpvReturn <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">uint8_t</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> pxPreviousBlock<span class=\"token operator\">-></span>pxNextFreeBlock <span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> heapSTRUCT_SIZE <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t\t\t\t<span class=\"token comment\">/* This block is being returned for use so must be taken out of the</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\t\t\tlist of free blocks. */</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\t\t\tpxPreviousBlock<span class=\"token operator\">-></span>pxNextFreeBlock <span class=\"token operator\">=</span> pxBlock<span class=\"token operator\">-></span>pxNextFreeBlock<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\t\t\t<span class=\"token comment\">/* If the block is larger than required it can be split into two. */</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> pxBlock<span class=\"token operator\">-></span>xBlockSize <span class=\"token operator\">-</span> xWantedSize <span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> heapMINIMUM_BLOCK_SIZE <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t\t\t\t\t<span class=\"token comment\">/* This block is to be split into two.  Create a new block</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t\t\t\t\tfollowing the number of bytes requested. The void cast is</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t\t\t\t\tused to prevent byte alignment warnings from the compiler. */</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t\t\t\t\tpxNewBlockLink <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">uint8_t</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> pxBlock <span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> xWantedSize <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t\t\t\t\t<span class=\"token comment\">/* Calculate the sizes of two blocks split from the single</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t\t\t\t\tblock. */</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t\t\t\t\tpxNewBlockLink<span class=\"token operator\">-></span>xBlockSize <span class=\"token operator\">=</span> pxBlock<span class=\"token operator\">-></span>xBlockSize <span class=\"token operator\">-</span> xWantedSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\t\t\t\tpxBlock<span class=\"token operator\">-></span>xBlockSize <span class=\"token operator\">=</span> xWantedSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t\t\t\t\t<span class=\"token comment\">/* Insert the new block into the list of free blocks. */</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">prvInsertBlockIntoFreeList</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> pxNewBlockLink <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t\t\t\txFreeBytesRemaining <span class=\"token operator\">-=</span> pxBlock<span class=\"token operator\">-></span>xBlockSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t\t<span class=\"token function\">traceMALLOC</span><span class=\"token punctuation\">(</span> pvReturn<span class=\"token punctuation\">,</span> xWantedSize <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t<span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">)</span> <span class=\"token function\">xTaskResumeAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span><span class=\"token expression\"><span class=\"token punctuation\">(</span> configUSE_MALLOC_FAILED_HOOK <span class=\"token operator\">==</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> pvReturn <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\t\t\t<span class=\"token keyword\">extern</span> <span class=\"token keyword\">void</span> <span class=\"token function\">vApplicationMallocFailedHook</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t\t\t<span class=\"token function\">vApplicationMallocFailedHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>\t<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>\t<span class=\"token keyword\">return</span> pvReturn<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>同样的，在每次分配空间之前，先挂起调度器，这是没得说的，然后如果是第一次调用  <code>pvPortMalloc()</code>  ，则调用  <code>prvHeapInit()</code>  对内存堆和空闲块链表进行初始化；而下面这段 code：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* The wanted size is increased so it can contain a BlockLink_t</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>structure in addition to the requested amount of bytes. */</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> xWantedSize <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\txWantedSize <span class=\"token operator\">+=</span> heapSTRUCT_SIZE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token comment\">/* Ensure that blocks are always aligned to the required number of bytes. */</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> xWantedSize <span class=\"token operator\">&amp;</span> portBYTE_ALIGNMENT_MASK <span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t<span class=\"token comment\">/* Byte alignment required. */</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\txWantedSize <span class=\"token operator\">+=</span> <span class=\"token punctuation\">(</span> portBYTE_ALIGNMENT <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span> xWantedSize <span class=\"token operator\">&amp;</span> portBYTE_ALIGNMENT_MASK <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>在用户每申请一次内存，FreeRTOS 都会在申请的空间前加上空闲块头部  <code>BlockLink_t</code>  ，用于记录分配出去的空间的大小，因此，实际分配的内存空间大小就等于用户申请的内存空间大小加上空闲块头部的大小；最后再加上头部之后，还要对整个大小进行对齐。</p>\n<p>下一个  <code>if</code>  判断：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> xWantedSize <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span> xWantedSize <span class=\"token operator\">&lt;</span> configADJUSTED_HEAP_SIZE <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token comment\">/* Blocks are stored in byte order - traverse the list from the start</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t(smallest) block until one of adequate size is found. */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tpxPreviousBlock <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>xStart<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tpxBlock <span class=\"token operator\">=</span> xStart<span class=\"token punctuation\">.</span>pxNextFreeBlock<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> pxBlock<span class=\"token operator\">-></span>xBlockSize <span class=\"token operator\">&lt;</span> xWantedSize <span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span> pxBlock<span class=\"token operator\">-></span>pxNextFreeBlock <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\tpxPreviousBlock <span class=\"token operator\">=</span> pxBlock<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\tpxBlock <span class=\"token operator\">=</span> pxBlock<span class=\"token operator\">-></span>pxNextFreeBlock<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token comment\">/* If we found the end marker then a block of adequate size was not found. */</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> pxBlock <span class=\"token operator\">!=</span> <span class=\"token operator\">&amp;</span>xEnd <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t<span class=\"token comment\">/* Return the memory space - jumping over the BlockLink_t structure</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\tat its start. */</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\tpvReturn <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">uint8_t</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> pxPreviousBlock<span class=\"token operator\">-></span>pxNextFreeBlock <span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> heapSTRUCT_SIZE <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t<span class=\"token comment\">/* This block is being returned for use so must be taken out of the</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\tlist of free blocks. */</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\tpxPreviousBlock<span class=\"token operator\">-></span>pxNextFreeBlock <span class=\"token operator\">=</span> pxBlock<span class=\"token operator\">-></span>pxNextFreeBlock<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t<span class=\"token comment\">/* If the block is larger than required it can be split into two. */</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> pxBlock<span class=\"token operator\">-></span>xBlockSize <span class=\"token operator\">-</span> xWantedSize <span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> heapMINIMUM_BLOCK_SIZE <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t\t<span class=\"token comment\">/* This block is to be split into two.  Create a new block</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t\tfollowing the number of bytes requested. The void cast is</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t\tused to prevent byte alignment warnings from the compiler. */</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t\tpxNewBlockLink <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">uint8_t</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> pxBlock <span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> xWantedSize <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t\t<span class=\"token comment\">/* Calculate the sizes of two blocks split from the single</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t\tblock. */</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t\tpxNewBlockLink<span class=\"token operator\">-></span>xBlockSize <span class=\"token operator\">=</span> pxBlock<span class=\"token operator\">-></span>xBlockSize <span class=\"token operator\">-</span> xWantedSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t\tpxBlock<span class=\"token operator\">-></span>xBlockSize <span class=\"token operator\">=</span> xWantedSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t\t<span class=\"token comment\">/* Insert the new block into the list of free blocks. */</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t\t<span class=\"token function\">prvInsertBlockIntoFreeList</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> pxNewBlockLink <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\txFreeBytesRemaining <span class=\"token operator\">-=</span> pxBlock<span class=\"token operator\">-></span>xBlockSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>先是判断用户申请的空间大小是否存在（不等于零）以及是否已经超过堆空间大小，若是不符合那就直接 pass 掉了；在这里，块的大小是按从小到大的顺序排列的，因此从一开始遍历列表 (最小的) 块，直到找到一个合适的大小，最后把位置记录下来。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* If we found the end marker then a block of adequate size was not found. */</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> pxBlock <span class=\"token operator\">!=</span> <span class=\"token operator\">&amp;</span>xEnd <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token comment\">/* Return the memory space - jumping over the BlockLink_t structure</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tat its start. */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tpvReturn <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">uint8_t</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> pxPreviousBlock<span class=\"token operator\">-></span>pxNextFreeBlock <span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> heapSTRUCT_SIZE <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token comment\">/* This block is being returned for use so must be taken out of the</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tlist of free blocks. */</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tpxPreviousBlock<span class=\"token operator\">-></span>pxNextFreeBlock <span class=\"token operator\">=</span> pxBlock<span class=\"token operator\">-></span>pxNextFreeBlock<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token comment\">/* If the block is larger than required it can be split into two. */</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> pxBlock<span class=\"token operator\">-></span>xBlockSize <span class=\"token operator\">-</span> xWantedSize <span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> heapMINIMUM_BLOCK_SIZE <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t<span class=\"token comment\">/* This block is to be split into two.  Create a new block</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\tfollowing the number of bytes requested. The void cast is</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\tused to prevent byte alignment warnings from the compiler. */</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\tpxNewBlockLink <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">uint8_t</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> pxBlock <span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> xWantedSize <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t<span class=\"token comment\">/* Calculate the sizes of two blocks split from the single</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\tblock. */</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\tpxNewBlockLink<span class=\"token operator\">-></span>xBlockSize <span class=\"token operator\">=</span> pxBlock<span class=\"token operator\">-></span>xBlockSize <span class=\"token operator\">-</span> xWantedSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\tpxBlock<span class=\"token operator\">-></span>xBlockSize <span class=\"token operator\">=</span> xWantedSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t<span class=\"token comment\">/* Insert the new block into the list of free blocks. */</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t<span class=\"token function\">prvInsertBlockIntoFreeList</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> pxNewBlockLink <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\txFreeBytesRemaining <span class=\"token operator\">-=</span> pxBlock<span class=\"token operator\">-></span>xBlockSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>紧接着，在上面的一段代码里，先是把返回的空间地址值修改（跳过  <code>BlockLink_t</code>  结构），然后把上一个的下一个的节点指向当前下一个的空闲块；后面，若果分配出去的空闲块的剩余空间是比两倍的空闲块头部结构体大小还要大，则将分配出去的这个空闲块分割剩余的空间出来，重新放到空闲块链表中。</p>\n<p>值得注意的是  <code>prvInsertBlockIntoFreeList</code>  这个是个宏，具体实现如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * Insert a block into the list of free blocks - which is ordered by size of</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * the block.  Small blocks at the start of the list and large blocks at the end</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * of the list.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">prvInsertBlockIntoFreeList</span><span class=\"token expression\"><span class=\"token punctuation\">(</span> pxBlockToInsert <span class=\"token punctuation\">)</span>\t\t\t\t\t\t\t\t</span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token expression\"><span class=\"token punctuation\">&#123;</span>\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token expression\">BlockLink_t <span class=\"token operator\">*</span>pxIterator<span class=\"token punctuation\">;</span>\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token expression\">size_t xBlockSize<span class=\"token punctuation\">;</span>\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token expression\">xBlockSize <span class=\"token operator\">=</span> pxBlockToInsert<span class=\"token operator\">-></span>xBlockSize<span class=\"token punctuation\">;</span>\t\t\t\t\t\t\t\t\t\t</span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token comment\">/* Iterate through the list until a block is found that has a larger size */</span>\t<span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token comment\">/* than the block we are inserting. */</span>\t\t\t\t\t\t\t\t\t\t\t<span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token expression\"><span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span> pxIterator <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>xStart<span class=\"token punctuation\">;</span> pxIterator<span class=\"token operator\">-></span>pxNextFreeBlock<span class=\"token operator\">-></span>xBlockSize <span class=\"token operator\">&lt;</span> xBlockSize<span class=\"token punctuation\">;</span> pxIterator <span class=\"token operator\">=</span> pxIterator<span class=\"token operator\">-></span>pxNextFreeBlock <span class=\"token punctuation\">)</span>\t</span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token expression\"><span class=\"token punctuation\">&#123;</span>\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token comment\">/* There is nothing to do here - just iterate to the correct position. */</span>\t<span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token expression\"><span class=\"token punctuation\">&#125;</span>\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token comment\">/* Update the list to include the block being inserted in the correct */</span>\t\t<span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token comment\">/* position. */</span>\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token expression\">pxBlockToInsert<span class=\"token operator\">-></span>pxNextFreeBlock <span class=\"token operator\">=</span> pxIterator<span class=\"token operator\">-></span>pxNextFreeBlock<span class=\"token punctuation\">;</span>\t\t\t\t\t</span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token expression\">pxIterator<span class=\"token operator\">-></span>pxNextFreeBlock <span class=\"token operator\">=</span> pxBlockToInsert<span class=\"token punctuation\">;</span>\t\t\t\t\t\t\t\t\t</span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token expression\"><span class=\"token punctuation\">&#125;</span></span></span></pre></td></tr></table></figure><p>这个宏的作用就是将新空闲块插入到合适的链表位置中。</p>\n<p>后面的代码执行就跟  <code>heap_1</code>  一样了，修改剩余空闲块空闲大小  <code>xFreeBytesRemaining</code>  、恢复所有挂起的任务等等。</p>\n<p>3、最后剩下的就是  <code>heap_1</code>  中不支持的  <code>vPortFree()</code>  释放函数了。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">vPortFree</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>pv <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">uint8_t</span> <span class=\"token operator\">*</span>puc <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">uint8_t</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> pv<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>BlockLink_t <span class=\"token operator\">*</span>pxLink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> pv <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t<span class=\"token comment\">/* The memory being freed will have an BlockLink_t structure immediately</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\tbefore it. */</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\tpuc <span class=\"token operator\">-=</span> heapSTRUCT_SIZE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t<span class=\"token comment\">/* This unexpected casting is to keep some compilers from issuing</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\tbyte alignment warnings. */</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tpxLink <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> puc<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t<span class=\"token function\">vTaskSuspendAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t\t<span class=\"token comment\">/* Add this block to the list of free blocks. */</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t\t<span class=\"token function\">prvInsertBlockIntoFreeList</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> BlockLink_t <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> pxLink <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t\txFreeBytesRemaining <span class=\"token operator\">+=</span> pxLink<span class=\"token operator\">-></span>xBlockSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t\t<span class=\"token function\">traceFREE</span><span class=\"token punctuation\">(</span> pv<span class=\"token punctuation\">,</span> pxLink<span class=\"token operator\">-></span>xBlockSize <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t<span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">)</span> <span class=\"token function\">xTaskResumeAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这一个函数炒鸡简单，而且非常短，首先判断要释放的内存是否为空；若是不为空，则获取这个内存空间真正的的空闲块（剔除头部的  <code>BlockLink_t</code>  结构），然后挂起所有任务，把释放的内存重新插入到空闲块链表中，最后调用调试信息宏，恢复挂起的任务就结束了。</p>\n<p>特点：</p>\n<p>即使应用程序反复删除任务，队列，信号量，互斥量等对象，也可以使用，有关内存碎片的警告如下：</p>\n<ul>\n<li>如果不是，如果被分配和释放内存使用是随机的大小。例如：\n<ul>\n<li>如果应用程序以动态创建和删除任务，并且分配给正在创建的任务的堆栈大小始终相同，则在大多数情况下可以使用  <code>heap_2.c</code>  ；但是，如果分配给正在创建的任务的堆栈大小并不总是相同，则可用的空闲内存可能会分成许多小块，最终导致分配失败；在这种情况下， <code>heap_4.c</code>  会更好</li>\n<li>如果应用程序以动态创建和删除队列，并且每种情况下队列存储区域都相同（队列存储区域指队列项数目乘以每个队列长度），则在大多数情况下都可以使用  <code>heap_2.c</code>  ；但是，如果队列存储区域在每种情况下都不相同，则可用的空闲内存可能会分成许多小块，最终导致分配失败；在这种情况下， <code>heap_4.c</code>  会更好</li>\n<li>该应用程序直接调用  <code>pvPortMalloc()</code>  和  <code>vPortFree()</code> ，而不仅仅是通过其他 FreeRTOS API 函数间接调用。</li>\n</ul>\n</li>\n<li>如果您的应用程序的队列，任务，信号量，互斥量等处于以不可预测的顺序，则可能会导致内存碎片问题；虽然这是小概率事件，但应牢记。</li>\n<li>不确定型，但比大多数标准 C 库  <code>malloc</code>  实现要有效得多。</li>\n</ul>\n<h2 id=\"heap_3c\"><a class=\"anchor\" href=\"#heap_3c\">#</a> heap_3.c</h2>\n<p>heap_3.c 就更简单了，只是简单的包装一下标准函数  <code>malloc()</code>  和  <code>free()</code>  以确保线程安全，在大多数情况下，这些包装器将需要你的编译器提供，它们依赖于编译器自己的  <code>malloc()</code>  和  <code>free()</code>  实现；文件说明如下： <strong>Implementation of pvPortMalloc() and vPortFree() that relies on the compilers own malloc() and free() implementations.This file can only be used if the linker is configured to to generate a heap memory area.</strong></p>\n<p>1、封装  <code>malloc()</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token function\">pvPortMalloc</span><span class=\"token punctuation\">(</span> size_t xWantedSize <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>pvReturn<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token function\">vTaskSuspendAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\tpvReturn <span class=\"token operator\">=</span> <span class=\"token function\">malloc</span><span class=\"token punctuation\">(</span> xWantedSize <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t<span class=\"token function\">traceMALLOC</span><span class=\"token punctuation\">(</span> pvReturn<span class=\"token punctuation\">,</span> xWantedSize <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">)</span> <span class=\"token function\">xTaskResumeAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span><span class=\"token expression\"><span class=\"token punctuation\">(</span> configUSE_MALLOC_FAILED_HOOK <span class=\"token operator\">==</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> pvReturn <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t\t<span class=\"token keyword\">extern</span> <span class=\"token keyword\">void</span> <span class=\"token function\">vApplicationMallocFailedHook</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t\t<span class=\"token function\">vApplicationMallocFailedHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token keyword\">return</span> pvReturn<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>和  <code>heap_1</code>  、 <code>heap_2</code>  一样，用  <code>vTaskSuspendAll()</code>  挂起所有的任务，以确保分配内存的过程是线程安全的；随后才使用  <code>malloc()</code>  进行内存分配，记录内存地址；然后就是调用调试信息宏  <code>traceMALLOC()</code>  ，最后调用  <code>xTaskResumeAll()</code>  恢复所有被挂起的任务；如果在  <code>FreeRTOS.h</code>  中使能了勾子函数宏  <code>configUSE_MALLOC_FAILED_HOOK</code>  ，则在调用勾子函数  <code>vApplicationMallocFailedHook()</code>  之后再向用户返回分配内存的首地址。</p>\n<p>2、封装  <code>free()</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">vPortFree</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>pv <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> pv <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\t<span class=\"token function\">vTaskSuspendAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t\t<span class=\"token function\">free</span><span class=\"token punctuation\">(</span> pv <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t\t<span class=\"token function\">traceFREE</span><span class=\"token punctuation\">(</span> pv<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t<span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">)</span> <span class=\"token function\">xTaskResumeAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>一样的，检查指针的有效性、挂起全部任务、调用  <code>free()</code>  接口将内存回收、调用调试信息宏、恢复挂起的任务，然后就没了。</p>\n<p>此实现方法及特点：</p>\n<ul>\n<li>需要链接器设置堆，并且需要编译器库提供  <code>malloc()</code>  和  <code>free()</code>  实现。</li>\n<li>具有不确定性。</li>\n<li>可能会大大增加 RTOS 内核代码的大小。</li>\n</ul>\n<p>注意，当使用  <code>heap_3</code>  时， <code>FreeRTOSConfig.h</code>  中的宏  <code>configTOTAL_HEAP_SIZE</code>  设置无效。</p>\n<h2 id=\"heap_4c\"><a class=\"anchor\" href=\"#heap_4c\">#</a> heap_4.c</h2>\n<p>跟<strong>方案 2</strong> 不一样的是，这个方案使用了首次适应算法（first fit algorithm）；它会将相邻的空闲内存块合并成一个更大的块（包含一个合并算法）。</p>\n<p>具体是它们会在释放时合并相邻的内存块，从而限制内存碎片，文件中的注释也有说： <strong>A sample implementation of pvPortMalloc() and vPortFree() that combines (coalescences) adjacent memory blocks as they are freed, and in so doing limits memory fragmentation.</strong></p>\n<p>其实，  <code>heap_4</code>  的代码基本跟  <code>heap_2</code>  的代码实现差不多，只不过增加了些功能（合并算法），而且你别看他代码太长，其实有很多东西都没用到的，就像这个函数  <code>mtCOVERAGE_TEST_MARKER()</code>  ，其实他是个宏，但是他并没有实现什么，根据他的命名可以认定为只是作者预留的一个调试输出窗口而已；还有  <code>configASSERT()</code>  这个也是一个宏，也只是用来调试输出而已，具体配置修改看下一篇。</p>\n<p>1、没错，还是我们首要分析的初始化函数。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">prvHeapInit</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>BlockLink_t <span class=\"token operator\">*</span>pxFirstFreeBlock<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">uint8_t</span> <span class=\"token operator\">*</span>pucAlignedHeap<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>size_t uxAddress<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>size_t xTotalHeapSize <span class=\"token operator\">=</span> configTOTAL_HEAP_SIZE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token comment\">/* Ensure the heap starts on a correctly aligned boundary. */</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tuxAddress <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span> size_t <span class=\"token punctuation\">)</span> ucHeap<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> uxAddress <span class=\"token operator\">&amp;</span> portBYTE_ALIGNMENT_MASK <span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\tuxAddress <span class=\"token operator\">+=</span> <span class=\"token punctuation\">(</span> portBYTE_ALIGNMENT <span class=\"token operator\">-</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tuxAddress <span class=\"token operator\">&amp;=</span> <span class=\"token operator\">~</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> size_t <span class=\"token punctuation\">)</span> portBYTE_ALIGNMENT_MASK <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\txTotalHeapSize <span class=\"token operator\">-=</span> uxAddress <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span> size_t <span class=\"token punctuation\">)</span> ucHeap<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tpucAlignedHeap <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">uint8_t</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> uxAddress<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token comment\">/* xStart is used to hold a pointer to the first item in the list of free</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\tblocks.  The void cast is used to prevent compiler warnings. */</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\txStart<span class=\"token punctuation\">.</span>pxNextFreeBlock <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> pucAlignedHeap<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\txStart<span class=\"token punctuation\">.</span>xBlockSize <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span> size_t <span class=\"token punctuation\">)</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token comment\">/* pxEnd is used to mark the end of the list of free blocks and is inserted</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\tat the end of the heap space. */</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\tuxAddress <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> size_t <span class=\"token punctuation\">)</span> pucAlignedHeap <span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> xTotalHeapSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\tuxAddress <span class=\"token operator\">-=</span> xHeapStructSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\tuxAddress <span class=\"token operator\">&amp;=</span> <span class=\"token operator\">~</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> size_t <span class=\"token punctuation\">)</span> portBYTE_ALIGNMENT_MASK <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\tpxEnd <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> uxAddress<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\tpxEnd<span class=\"token operator\">-></span>xBlockSize <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\tpxEnd<span class=\"token operator\">-></span>pxNextFreeBlock <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t<span class=\"token comment\">/* To start with there is a single free block that is sized to take up the</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\tentire heap space, minus the space taken by pxEnd. */</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\tpxFirstFreeBlock <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> pucAlignedHeap<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\tpxFirstFreeBlock<span class=\"token operator\">-></span>xBlockSize <span class=\"token operator\">=</span> uxAddress <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span> size_t <span class=\"token punctuation\">)</span> pxFirstFreeBlock<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\tpxFirstFreeBlock<span class=\"token operator\">-></span>pxNextFreeBlock <span class=\"token operator\">=</span> pxEnd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t<span class=\"token comment\">/* Only one block exists - and it covers the entire usable heap space. */</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\txMinimumEverFreeBytesRemaining <span class=\"token operator\">=</span> pxFirstFreeBlock<span class=\"token operator\">-></span>xBlockSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\txFreeBytesRemaining <span class=\"token operator\">=</span> pxFirstFreeBlock<span class=\"token operator\">-></span>xBlockSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t<span class=\"token comment\">/* Work out the position of the top bit in a size_t variable. */</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\txBlockAllocatedBit <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> size_t <span class=\"token punctuation\">)</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span> size_t <span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> heapBITS_PER_BYTE <span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img src=\"20200215165421587.png\" alt=\"img\" /></p>\n<p>根据上图现在来对比一下  <code>head_2</code>  的，这里对起始地址做字节对齐处理是跟  <code>head_2</code>  有点不同，他不止对内存堆进行首地址对齐保存  <code>pucAlignedHeap</code>  ，并且还算出可用空间大小为  <code>xTotalHeapSize</code> ；</p>\n<p>然后， <code>xStart</code>  的初始化是一样的，没什么好说的，注意  <code>xStart</code>  是  <code>BlockLink_t</code>  的一个实体变量，存储在静态存储区；</p>\n<p>接着是  <code>pxEnd</code>  ，他是一个  <code>BlockLink_t</code>  的指针，存储在静态存储区中，却指向了内存堆的最后一个  <code>BlockLink_t</code>  大小的位置上。也就是说，内存堆最后的空间是存储着一个  <code>BlockLink_t</code>  ，用来指示空闲块链表的最后位置，这是和  <code>heap_2</code>  所不同的地方：</p>\n<p><img src=\"20200215172529594.png\" alt=\"img\" /></p>\n<p>因为  <code>pxEnd</code>  占用了一个  <code>BlockLink_t</code>  大小的空间，所以在整个堆空间，减去  <code>pxEnd</code>  占用的空间；</p>\n<p>另外，为了安全， <code>heap_4</code>  增加一个位（  <code>BlockLink_t</code>  中  <code>xBlockSize</code>  的最高位）标记某个内存块是否处于空闲状态，因此在初始化的时候设置  <code>xBlockAllocatedBit</code>  的值。</p>\n<p>2、在对比分析  <code>pvPortMalloc()</code>  内存分布的实现之前，我们先分析一下  <code>prvInsertBlockIntoFreeList()</code>  函数。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">prvInsertBlockIntoFreeList</span><span class=\"token punctuation\">(</span> BlockLink_t <span class=\"token operator\">*</span>pxBlockToInsert <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>BlockLink_t <span class=\"token operator\">*</span>pxIterator<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">uint8_t</span> <span class=\"token operator\">*</span>puc<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token comment\">/* Iterate through the list until a block is found that has a higher address</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tthan the block being inserted. */</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span> pxIterator <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>xStart<span class=\"token punctuation\">;</span> pxIterator<span class=\"token operator\">-></span>pxNextFreeBlock <span class=\"token operator\">&lt;</span> pxBlockToInsert<span class=\"token punctuation\">;</span> pxIterator <span class=\"token operator\">=</span> pxIterator<span class=\"token operator\">-></span>pxNextFreeBlock <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t<span class=\"token comment\">/* Nothing to do here, just iterate to the right position. */</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token comment\">/* Do the block being inserted, and the block it is being inserted after</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tmake a contiguous block of memory? */</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tpuc <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">uint8_t</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> pxIterator<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> puc <span class=\"token operator\">+</span> pxIterator<span class=\"token operator\">-></span>xBlockSize <span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">uint8_t</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> pxBlockToInsert <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\tpxIterator<span class=\"token operator\">-></span>xBlockSize <span class=\"token operator\">+=</span> pxBlockToInsert<span class=\"token operator\">-></span>xBlockSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\tpxBlockToInsert <span class=\"token operator\">=</span> pxIterator<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t<span class=\"token function\">mtCOVERAGE_TEST_MARKER</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t<span class=\"token comment\">/* Do the block being inserted, and the block it is being inserted before</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\tmake a contiguous block of memory? */</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\tpuc <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">uint8_t</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> pxBlockToInsert<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> puc <span class=\"token operator\">+</span> pxBlockToInsert<span class=\"token operator\">-></span>xBlockSize <span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">uint8_t</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> pxIterator<span class=\"token operator\">-></span>pxNextFreeBlock <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> pxIterator<span class=\"token operator\">-></span>pxNextFreeBlock <span class=\"token operator\">!=</span> pxEnd <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t\t<span class=\"token comment\">/* Form one big block from the two blocks. */</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t\tpxBlockToInsert<span class=\"token operator\">-></span>xBlockSize <span class=\"token operator\">+=</span> pxIterator<span class=\"token operator\">-></span>pxNextFreeBlock<span class=\"token operator\">-></span>xBlockSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t\tpxBlockToInsert<span class=\"token operator\">-></span>pxNextFreeBlock <span class=\"token operator\">=</span> pxIterator<span class=\"token operator\">-></span>pxNextFreeBlock<span class=\"token operator\">-></span>pxNextFreeBlock<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t\tpxBlockToInsert<span class=\"token operator\">-></span>pxNextFreeBlock <span class=\"token operator\">=</span> pxEnd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\tpxBlockToInsert<span class=\"token operator\">-></span>pxNextFreeBlock <span class=\"token operator\">=</span> pxIterator<span class=\"token operator\">-></span>pxNextFreeBlock<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t<span class=\"token comment\">/* If the block being inserted plugged a gab, so was merged with the block</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\tbefore and the block after, then it's pxNextFreeBlock pointer will have</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\talready been set, and should not be set here as that would make it point</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\tto itself. */</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> pxIterator <span class=\"token operator\">!=</span> pxBlockToInsert <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\tpxIterator<span class=\"token operator\">-></span>pxNextFreeBlock <span class=\"token operator\">=</span> pxBlockToInsert<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t\t<span class=\"token function\">mtCOVERAGE_TEST_MARKER</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这个函数就是合并实现的主要环节了；在  <code>heap_2</code>  中的链表插入是通过宏实现的，并且是按内存块大小进行插入；而  <code>heap_4</code>  的插入操作是写成了一个函数，该函数按内存块地址进行插入（低位前），实际上是将这个空闲块链表里的所有空闲块按地址顺序排列，这么做是为了实现内存块合并；前面也说了，相对于  <code>heap_2</code>  ， <code>heap_4</code>  会将相邻的空闲内存块合并成一个更大的块，若果不这么排列，那么就不能将相邻的空闲块进行合并了。</p>\n<p>首先，通过一次链表的遍历，找出内存块插入点（把  <code>pxIterator</code>  找出来）；然后判断，正在插入的块（ <code>pxBlockToInsert</code> ）和内存块插入点（ <code>pxIterator</code> ）是否构成一个连续的内存块；其标准为  <code>pxIterator</code>  的首地址加上  <code>pxIterator</code>  的块大小之后等于  <code>pxBlockToInsert</code>  的首地址，相等就说明两个块是相邻的，把这个待插入的空闲块插到  <code>pxIterator</code>  的后面，否则就什么事都不做。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* Iterate through the list until a block is found that has a higher address</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>than the block being inserted. */</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span> pxIterator <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>xStart<span class=\"token punctuation\">;</span> pxIterator<span class=\"token operator\">-></span>pxNextFreeBlock <span class=\"token operator\">&lt;</span> pxBlockToInsert<span class=\"token punctuation\">;</span> pxIterator <span class=\"token operator\">=</span> pxIterator<span class=\"token operator\">-></span>pxNextFreeBlock <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token comment\">/* Nothing to do here, just iterate to the right position. */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">/* Do the block being inserted, and the block it is being inserted after</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>make a contiguous block of memory? */</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>puc <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">uint8_t</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> pxIterator<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> puc <span class=\"token operator\">+</span> pxIterator<span class=\"token operator\">-></span>xBlockSize <span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">uint8_t</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> pxBlockToInsert <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tpxIterator<span class=\"token operator\">-></span>xBlockSize <span class=\"token operator\">+=</span> pxBlockToInsert<span class=\"token operator\">-></span>xBlockSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tpxBlockToInsert <span class=\"token operator\">=</span> pxIterator<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token function\">mtCOVERAGE_TEST_MARKER</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>然后，再试着将  <code>pxBlockToInsert</code>  和  <code>pxIterator</code>  指向的下一个空闲块进行合并；这次用  <code>pxBlockToInsert</code>  的首地址加上  <code>pxBlockToInsert</code>  的块大小与  <code>pxIterator</code>  指向的下一个块地址比较，不符合，则要修改  <code>pxBlockToInsert</code>  的 Next 指针，指向 <code>pxIterator</code>  的下一个空闲块；如果符合条件，则再判断  <code>pxIterator</code>  指向的下一个块地址是否已经到了空闲块链表的最后位置了，如果已经到了空闲块链表的最后位置，那么就把  <code>pxIterator</code>  指向的下一个块地址更改为空闲块链表的最后位置的地址，否则就合并内存并且更新链表的数据。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* Do the block being inserted, and the block it is being inserted before</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>make a contiguous block of memory? */</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>puc <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">uint8_t</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> pxBlockToInsert<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> puc <span class=\"token operator\">+</span> pxBlockToInsert<span class=\"token operator\">-></span>xBlockSize <span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">uint8_t</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> pxIterator<span class=\"token operator\">-></span>pxNextFreeBlock <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> pxIterator<span class=\"token operator\">-></span>pxNextFreeBlock <span class=\"token operator\">!=</span> pxEnd <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t<span class=\"token comment\">/* Form one big block from the two blocks. */</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\tpxBlockToInsert<span class=\"token operator\">-></span>xBlockSize <span class=\"token operator\">+=</span> pxIterator<span class=\"token operator\">-></span>pxNextFreeBlock<span class=\"token operator\">-></span>xBlockSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\tpxBlockToInsert<span class=\"token operator\">-></span>pxNextFreeBlock <span class=\"token operator\">=</span> pxIterator<span class=\"token operator\">-></span>pxNextFreeBlock<span class=\"token operator\">-></span>pxNextFreeBlock<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tpxBlockToInsert<span class=\"token operator\">-></span>pxNextFreeBlock <span class=\"token operator\">=</span> pxEnd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\tpxBlockToInsert<span class=\"token operator\">-></span>pxNextFreeBlock <span class=\"token operator\">=</span> pxIterator<span class=\"token operator\">-></span>pxNextFreeBlock<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>最后，要是  <code>pxBlockToInsert</code>  没有和  <code>pxIterator</code>  合并，则还要修改  <code>pxIterator</code>  的 Next 指针。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* If the block being inserted plugged a gab, so was merged with the block</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>before and the block after, then it's pxNextFreeBlock pointer will have</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>already been set, and should not be set here as that would make it point</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>to itself. */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> pxIterator <span class=\"token operator\">!=</span> pxBlockToInsert <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tpxIterator<span class=\"token operator\">-></span>pxNextFreeBlock <span class=\"token operator\">=</span> pxBlockToInsert<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token function\">mtCOVERAGE_TEST_MARKER</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>3、讲了这么多，现在终于到分析  <code>pvPortMalloc()</code>  了。</p>\n<p>先看总代码：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token function\">pvPortMalloc</span><span class=\"token punctuation\">(</span> size_t xWantedSize <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>BlockLink_t <span class=\"token operator\">*</span>pxBlock<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>pxPreviousBlock<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>pxNewBlockLink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>pvReturn <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token function\">vTaskSuspendAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t<span class=\"token comment\">/* If this is the first call to malloc then the heap will require</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\tinitialisation to setup the list of free blocks. */</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> pxEnd <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\t<span class=\"token function\">prvHeapInit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t\t<span class=\"token function\">mtCOVERAGE_TEST_MARKER</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token comment\">/* Check the requested block size is not so large that the top bit is</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tset.  The top bit of the block size member of the BlockLink_t structure</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\tis used to determine who owns the block - the application or the</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\tkernel, so it must be free. */</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> xWantedSize <span class=\"token operator\">&amp;</span> xBlockAllocatedBit <span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t\t<span class=\"token comment\">/* The wanted size is increased so it can contain a BlockLink_t</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t\tstructure in addition to the requested amount of bytes. */</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> xWantedSize <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t\t\txWantedSize <span class=\"token operator\">+=</span> xHeapStructSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t\t\t<span class=\"token comment\">/* Ensure that blocks are always aligned to the required number</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t\t\tof bytes. */</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> xWantedSize <span class=\"token operator\">&amp;</span> portBYTE_ALIGNMENT_MASK <span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0x00</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t\t\t\t<span class=\"token comment\">/* Byte alignment required. */</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t\t\t\txWantedSize <span class=\"token operator\">+=</span> <span class=\"token punctuation\">(</span> portBYTE_ALIGNMENT <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span> xWantedSize <span class=\"token operator\">&amp;</span> portBYTE_ALIGNMENT_MASK <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">configASSERT</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> xWantedSize <span class=\"token operator\">&amp;</span> portBYTE_ALIGNMENT_MASK <span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">mtCOVERAGE_TEST_MARKER</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t\t\t<span class=\"token function\">mtCOVERAGE_TEST_MARKER</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> xWantedSize <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span> xWantedSize <span class=\"token operator\">&lt;=</span> xFreeBytesRemaining <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\t\t\t<span class=\"token comment\">/* Traverse the list from the start\t(lowest address) block until</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\t\t\tone\tof adequate size is found. */</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\t\t\tpxPreviousBlock <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>xStart<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\t\t\tpxBlock <span class=\"token operator\">=</span> xStart<span class=\"token punctuation\">.</span>pxNextFreeBlock<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> pxBlock<span class=\"token operator\">-></span>xBlockSize <span class=\"token operator\">&lt;</span> xWantedSize <span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span> pxBlock<span class=\"token operator\">-></span>pxNextFreeBlock <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t\t\t\t\tpxPreviousBlock <span class=\"token operator\">=</span> pxBlock<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t\t\t\t\tpxBlock <span class=\"token operator\">=</span> pxBlock<span class=\"token operator\">-></span>pxNextFreeBlock<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t\t\t\t<span class=\"token comment\">/* If the end marker was reached then a block of adequate size</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t\t\t\twas\tnot found. */</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> pxBlock <span class=\"token operator\">!=</span> pxEnd <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\t\t\t\t<span class=\"token comment\">/* Return the memory space pointed to - jumping over the</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t\t\t\t\tBlockLink_t structure at its start. */</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t\t\t\t\tpvReturn <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">uint8_t</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> pxPreviousBlock<span class=\"token operator\">-></span>pxNextFreeBlock <span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> xHeapStructSize <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t\t\t\t\t<span class=\"token comment\">/* This block is being returned for use so must be taken out</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t\t\t\t\tof the list of free blocks. */</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t\t\t\t\tpxPreviousBlock<span class=\"token operator\">-></span>pxNextFreeBlock <span class=\"token operator\">=</span> pxBlock<span class=\"token operator\">-></span>pxNextFreeBlock<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t\t\t\t\t<span class=\"token comment\">/* If the block is larger than required it can be split into</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t\t\t\t\ttwo. */</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t\t\t\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> pxBlock<span class=\"token operator\">-></span>xBlockSize <span class=\"token operator\">-</span> xWantedSize <span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> heapMINIMUM_BLOCK_SIZE <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t\t\t\t\t\t<span class=\"token comment\">/* This block is to be split into two.  Create a new</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\t\t\t\t\t\tblock following the number of bytes requested. The void</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t\t\t\t\t\tcast is used to prevent byte alignment warnings from the</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t\t\t\t\t\tcompiler. */</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t\t\t\t\t\tpxNewBlockLink <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">uint8_t</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> pxBlock <span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> xWantedSize <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t\t\t\t\t\t<span class=\"token function\">configASSERT</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> size_t <span class=\"token punctuation\">)</span> pxNewBlockLink <span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> portBYTE_ALIGNMENT_MASK <span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t\t\t\t\t\t<span class=\"token comment\">/* Calculate the sizes of two blocks split from the</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t\t\t\t\t\tsingle block. */</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>\t\t\t\t\t\tpxNewBlockLink<span class=\"token operator\">-></span>xBlockSize <span class=\"token operator\">=</span> pxBlock<span class=\"token operator\">-></span>xBlockSize <span class=\"token operator\">-</span> xWantedSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>\t\t\t\t\t\tpxBlock<span class=\"token operator\">-></span>xBlockSize <span class=\"token operator\">=</span> xWantedSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>\t\t\t\t\t\t<span class=\"token comment\">/* Insert the new block into the list of free blocks. */</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>\t\t\t\t\t\t<span class=\"token function\">prvInsertBlockIntoFreeList</span><span class=\"token punctuation\">(</span> pxNewBlockLink <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>\t\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>\t\t\t\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>\t\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>\t\t\t\t\t\t<span class=\"token function\">mtCOVERAGE_TEST_MARKER</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>\t\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>\t\t\t\t\txFreeBytesRemaining <span class=\"token operator\">-=</span> pxBlock<span class=\"token operator\">-></span>xBlockSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>\t\t\t\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> xFreeBytesRemaining <span class=\"token operator\">&lt;</span> xMinimumEverFreeBytesRemaining <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>\t\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>\t\t\t\t\t\txMinimumEverFreeBytesRemaining <span class=\"token operator\">=</span> xFreeBytesRemaining<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>\t\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>\t\t\t\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>\t\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>\t\t\t\t\t\t<span class=\"token function\">mtCOVERAGE_TEST_MARKER</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>\t\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>\t\t\t\t\t<span class=\"token comment\">/* The block is being returned - it is allocated and owned</pre></td></tr><tr><td data-num=\"109\"></td><td><pre>\t\t\t\t\tby the application and has no \"next\" block. */</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>\t\t\t\t\tpxBlock<span class=\"token operator\">-></span>xBlockSize <span class=\"token operator\">|=</span> xBlockAllocatedBit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>\t\t\t\t\tpxBlock<span class=\"token operator\">-></span>pxNextFreeBlock <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">mtCOVERAGE_TEST_MARKER</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>\t\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>\t\t\t\t<span class=\"token function\">mtCOVERAGE_TEST_MARKER</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>\t\t\t<span class=\"token function\">mtCOVERAGE_TEST_MARKER</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>\t\t<span class=\"token function\">traceMALLOC</span><span class=\"token punctuation\">(</span> pvReturn<span class=\"token punctuation\">,</span> xWantedSize <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>\t<span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">)</span> <span class=\"token function\">xTaskResumeAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>\t<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span><span class=\"token expression\"><span class=\"token punctuation\">(</span> configUSE_MALLOC_FAILED_HOOK <span class=\"token operator\">==</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> pvReturn <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>\t\t\t<span class=\"token keyword\">extern</span> <span class=\"token keyword\">void</span> <span class=\"token function\">vApplicationMallocFailedHook</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>\t\t\t<span class=\"token function\">vApplicationMallocFailedHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>\t\t\t<span class=\"token function\">mtCOVERAGE_TEST_MARKER</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>\t<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>\t<span class=\"token function\">configASSERT</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> size_t <span class=\"token punctuation\">)</span> pvReturn <span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">(</span> size_t <span class=\"token punctuation\">)</span> portBYTE_ALIGNMENT_MASK <span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>\t<span class=\"token keyword\">return</span> pvReturn<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>其实相对于  <code>heap_2</code>  的变动不大，可以看一下它们的对比图：</p>\n<p><img src=\"20200215194716241.png\" alt=\"img\" /></p>\n<p>同样的，只在第一次调用该函数的时候才初始化堆管理，看上图。</p>\n<p><img src=\"2020021519500019.png\" alt=\"img\" /></p>\n<p>接着在这里只是相对于  <code>heap_2</code>  多了个标志位  <code>xBlockAllocatedBit</code>  的判断来是否执行以下的操作，若是符合，则像  <code>heap_2</code>  一样进行块字节对齐，看上图。</p>\n<p>而剩下的，主要的不同也就是因为多了个  <code>xBlockAllocatedBit</code>  操作，所以使用了  <code>xBlockSize</code>  的最高位做标记，因此就添加了相应的操作，如下图：</p>\n<p><img src=\"2020021520080137.png\" alt=\"img\" /></p>\n<p>至于其他差别不大，此处不做赘述。</p>\n<p>4、 <code>vPortFree()</code>  实现</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">vPortFree</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>pv <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">uint8_t</span> <span class=\"token operator\">*</span>puc <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">uint8_t</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> pv<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>BlockLink_t <span class=\"token operator\">*</span>pxLink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> pv <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t<span class=\"token comment\">/* The memory being freed will have an BlockLink_t structure immediately</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\tbefore it. */</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\tpuc <span class=\"token operator\">-=</span> xHeapStructSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t<span class=\"token comment\">/* This casting is to keep the compiler from issuing warnings. */</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\tpxLink <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> puc<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t<span class=\"token comment\">/* Check the block is actually allocated. */</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t<span class=\"token function\">configASSERT</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> pxLink<span class=\"token operator\">-></span>xBlockSize <span class=\"token operator\">&amp;</span> xBlockAllocatedBit <span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token function\">configASSERT</span><span class=\"token punctuation\">(</span> pxLink<span class=\"token operator\">-></span>pxNextFreeBlock <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> pxLink<span class=\"token operator\">-></span>xBlockSize <span class=\"token operator\">&amp;</span> xBlockAllocatedBit <span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> pxLink<span class=\"token operator\">-></span>pxNextFreeBlock <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t\t\t<span class=\"token comment\">/* The block is being returned to the heap - it is no longer</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t\t\tallocated. */</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t\t\tpxLink<span class=\"token operator\">-></span>xBlockSize <span class=\"token operator\">&amp;=</span> <span class=\"token operator\">~</span>xBlockAllocatedBit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t\t\t<span class=\"token function\">vTaskSuspendAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t\t\t\t<span class=\"token comment\">/* Add this block to the list of free blocks. */</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t\t\t\txFreeBytesRemaining <span class=\"token operator\">+=</span> pxLink<span class=\"token operator\">-></span>xBlockSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">traceFREE</span><span class=\"token punctuation\">(</span> pv<span class=\"token punctuation\">,</span> pxLink<span class=\"token operator\">-></span>xBlockSize <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">prvInsertBlockIntoFreeList</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> BlockLink_t <span class=\"token operator\">*</span> <span class=\"token punctuation\">)</span> pxLink <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">(</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">)</span> <span class=\"token function\">xTaskResumeAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t\t\t<span class=\"token function\">mtCOVERAGE_TEST_MARKER</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t\t<span class=\"token function\">mtCOVERAGE_TEST_MARKER</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>相比  <code>heap_2</code>  ， <code>heap_4</code>  只是多了一些检查，使之更加安全，看下图比较：</p>\n<p><img src=\"20200215201418626.png\" alt=\"img\" /></p>\n<p>应用场景及特点：</p>\n<ul>\n<li>即使应用程序反复删除任务，队列，信号量，互斥量等也可以使用。</li>\n<li>与  <code>heap_2</code>  实现相比，即使将要分配和释放的内存具有随机大小，也很难将堆空间严重分割成多个小块。</li>\n<li>不确定性，但比大多数标准 C 库  <code>malloc</code>  实现要有效得多。</li>\n</ul>\n<p>对于希望直接在应用程序代码中使用便携式层内存分配方案的应用程序， <code>heap_4.c</code>  尤其有用（而不是仅通过调用本身调用  <code>pvPortMalloc()</code>  和  <code>vPortFree()</code>  的 API 函数来间接使用）。</p>\n<h2 id=\"heap_5c\"><a class=\"anchor\" href=\"#heap_5c\">#</a> heap_5.c</h2>\n<p>该方案使用与  <code>heap_4</code>  相同，使用首次适应算法和内存合并算法，并允许堆跨越多个不相邻（不连续）的内存区域。</p>\n<p>这个就不说了，跟  <code>heap_4</code>  大同小异，有兴趣可以看看，就只发一下它的文件注释说明吧</p>\n<pre><code>/*\n * A sample implementation of pvPortMalloc() that allows the heap to be defined\n * across multiple non-contigous blocks and combines (coalescences) adjacent\n * memory blocks as they are freed.\n *\n * See heap_1.c, heap_2.c, heap_3.c and heap_4.c for alternative\n * implementations, and the memory management pages of http://www.FreeRTOS.org\n * for more information.\n *\n * Usage notes:\n *\n * vPortDefineHeapRegions() ***must*** be called before pvPortMalloc().\n * pvPortMalloc() will be called if any task objects (tasks, queues, event\n * groups, etc.) are created, therefore vPortDefineHeapRegions() ***must*** be\n * called before any other objects are defined.\n *\n * vPortDefineHeapRegions() takes a single parameter.  The parameter is an array\n * of HeapRegion_t structures.  HeapRegion_t is defined in portable.h as\n *\n * typedef struct HeapRegion\n * &#123;\n *\tuint8_t *pucStartAddress; &lt;&lt; Start address of a block of memory that will be part of the heap.\n *\tsize_t xSizeInBytes;\t  &lt;&lt; Size of the block of memory.\n * &#125; HeapRegion_t;\n *\n * The array is terminated using a NULL zero sized region definition, and the\n * memory regions defined in the array ***must*** appear in address order from\n * low address to high address.  So the following is a valid example of how\n * to use the function.\n *\n * HeapRegion_t xHeapRegions[] =\n * &#123;\n * \t&#123; ( uint8_t * ) 0x80000000UL, 0x10000 &#125;, &lt;&lt; Defines a block of 0x10000 bytes starting at address 0x80000000\n * \t&#123; ( uint8_t * ) 0x90000000UL, 0xa0000 &#125;, &lt;&lt; Defines a block of 0xa0000 bytes starting at address of 0x90000000\n * \t&#123; NULL, 0 &#125;                &lt;&lt; Terminates the array.\n * &#125;;\n *\n * vPortDefineHeapRegions( xHeapRegions ); &lt;&lt; Pass the array into vPortDefineHeapRegions().\n *\n * Note 0x80000000 is the lower address so appears in the array first.\n *\n */\n</code></pre>\n<p>注意： <code>heap_5</code>  通过调用  <code>vPortDefineHeapRegions()</code>  函数实现初始化，只有在  <code>vPortDefineHeapRegions()</code>  执行后才允许使用内存分配和释放。创建 RTOS 对象（任务、队列、信号量等等）会隐含的调用  <code>pvPortMalloc()</code>  ，因此必须注意：使用  <code>heap_5</code>  创建任何对象前，要先执行  <code>vPortDefineHeapRegions()</code>  函数。</p>\n<h1 id=\"其他\"><a class=\"anchor\" href=\"#其他\">#</a> 其他</h1>\n<p>必须吐槽一下，终于结束了。</p>\n<p>官方的这个地址有详细说 <a href=\"https://www.freertos.org/a00111.html\">heap 堆内存管理</a></p>\n<p>然后想要了解 heap 所用到的算法可以查看 -&gt;<a href=\"https://arachnid.cc/partitioning-placement-algorithm/\"> 分区分配算法（Partitioning Placement Algorithm）</a></p>\n",
            "tags": [
                "history",
                "FreeRTOS",
                "RTOS"
            ]
        },
        {
            "id": "https://arachnid.cc/freertos-system-transplant/",
            "url": "https://arachnid.cc/freertos-system-transplant/",
            "title": "FreeRTOS 篇章之系统移植",
            "date_published": "2020-02-13T08:09:38.000Z",
            "content_html": "<blockquote>\n<p>在移植之前，首先说明一下，该篇章，包括之后的文章都是建立在 CM-3 处理器上（用之前写 STM32 笔记的 STM32F103VET6），并且是用 FreeRTOS 的 V9.0.0 版本的核心文件进行移植，我们只需要把原有的 STM32 基础工程（<a href=\"https://arachnid.cc/categories/STM32\">STM32 的教程链接 ☜</a>）二次添加我们所需的 FreeRTOS 核心文件就可以了</p>\n</blockquote>\n<p>1、开发环境：Keil uVision5 V5.21<br />\n2、ST 外设标准固件库： V3.5<br />\n3、FreeRTOS 版本库：V9.0.0<br />\n4、目标芯片：STM32F103VET6（Cotrex-M3）<br />\n5、下载调试工具：J-Link</p>\n<h1 id=\"freertos-核心文件提取\"><a class=\"anchor\" href=\"#freertos-核心文件提取\">#</a> FreeRTOS 核心文件提取</h1>\n<p>在上一篇 <a href=\"https://arachnid.cc/docs/RTOS/FreeRTOS%20%E7%AF%87%E7%AB%A0%E4%B9%8B%E5%AE%98%E6%96%B9%E6%BA%90%E7%A0%81%E6%96%87%E6%A1%A3%E5%88%86%E6%9E%90/\">FreeRTOS 篇章之官方源码文档分析</a> 已经分析出我们真正需要的文件是在 FreeRTOSv9.0.0/FreeRTOS 文件中，那么我们就去提取出需要的东西。</p>\n<p>先在工程主目录上建立一个名为 FreeRTOS 的文档</p>\n<p><img src=\"20200212223821860.png\" alt=\"img\" /></p>\n<p>再在下载下来的  <code>FreeRTOSv9.0.0\\FreeRTOS\\Source</code>  文件夹中把下图的这几个文件放进到工程的文档中，而这些零散的源文件我们创一个  <code>src</code>  文档来对它们进行管理，具体看后面移植完的文件结构分布图：</p>\n<p><img src=\"20200212224344457.png\" alt=\"img\" /></p>\n<p>至于  <code>portable</code>  文档里面的内容，我们只需拿我们需要的接口就好了，全部拷贝文件太大了，不符合轻量级这个要求；所以进入  <code>FreeRTOSv9.0.0\\FreeRTOS\\Source\\portable</code>  文件夹中，你可以发现有好多以编译器命名的文档，由于我们的开发环境是在  <code>Keil</code>  中的，所以我们要使用里面的  <code>Keil</code>  文档的内容，再让我们进去文档里面瞅瞅有些啥？进去你会发现只有一个  <code>See also the RVDS directory.txt</code>  文本，他叫我们查看  <code>RVDS</code>  这个目录，那我们就进去看看呗，看下图：</p>\n<p><img src=\"20200212225436312.png\" alt=\"img\" /></p>\n<p>这下可以了，有支持我们的运行的接口，那就把  <code>RVDS</code>  这个目录复制过去呗</p>\n<p>其中，我们还需要把  <code>FreeRTOS/Source/portable/MemMang</code>  目录也要复制过去，因为我们需要一个对堆进行分配的处理文件，而官方已经为我们提供了几个堆分配方案了，就是里面的几个  <code>heap_x.c</code>  文件</p>\n<p>最后移植完得到下图这样：</p>\n<p><img src=\"2020021920042663.png\" alt=\"img\" /></p>\n<p><img src=\"20200212230410570.png\" alt=\"img\" /></p>\n<p>最最最后，还要再把  <code>FreeRTOSv9.0.0\\FreeRTOS\\Demo\\CORTEX_STM32F103_Keil</code>  路径下（因为官方 demo 中就这个文档最符合我们当前的移植工程）的  <code>FreeRTOSConfig.h</code>  文件复制到我们用户可修改的  <code>App</code>  文件夹下。</p>\n<h1 id=\"工程导入及属性修改\"><a class=\"anchor\" href=\"#工程导入及属性修改\">#</a> 工程导入及属性修改</h1>\n<p>保持之前的工程不变，二次修改并添加下图的文件进入工程：</p>\n<p><img src=\"20200219200521981.png\" alt=\"img\" /></p>\n<p><s>然后再改一下配置的属性为 ARMCM3，</s> 配置属性不用改，是哪款 M3 芯片就选哪个芯片，例如用的是 stm32f103zet6，那就选这个：</p>\n<p><img src=\"20200213160202881.png\" alt=\"img\" /></p>\n<p>好了，基本的工程移植就完成了，然后你可能会疑问为什么选  <code>heap_4</code>  这个堆分配方案的，这个在下一篇再进行解析</p>\n",
            "tags": [
                "history",
                "FreeRTOS",
                "RTOS"
            ]
        },
        {
            "id": "https://arachnid.cc/freertos-file-analyse/",
            "url": "https://arachnid.cc/freertos-file-analyse/",
            "title": "FreeRTOS 篇章之官方源码文档分析",
            "date_published": "2020-02-12T12:55:10.000Z",
            "content_html": "<blockquote>\n<p>FreeRTOS 官网：<a href=\"https://www.freertos.org/index.html\">https://www.freertos.org/index.html</a></p>\n</blockquote>\n<h1 id=\"v900源码版本获取\"><a class=\"anchor\" href=\"#v900源码版本获取\">#</a> V9.0.0 源码版本获取</h1>\n<p>1、官方托管在 SVN 的源代码链接：<a href=\"https://sourceforge.net/projects/freertos/files/FreeRTOS/\">https://sourceforge.net/projects/freertos/files/FreeRTOS/</a></p>\n<p><img src=\"20200212155522823.png\" alt=\"img\" /></p>\n<p>2、官方托管在 GitHub 的源代码链接：<a href=\"https://github.com/FreeRTOS/FreeRTOS\">https://github.com/FreeRTOS/FreeRTOS</a></p>\n<p><img src=\"20200212155628361.png\" alt=\"img\" /></p>\n<p>这里使用 V9.0.0 版本，包括之后都是以 V9.0.0 版本为参考，不要问我为什么，哪个版本成熟稳定用那个。</p>\n<h1 id=\"文件分类\"><a class=\"anchor\" href=\"#文件分类\">#</a> 文件分类</h1>\n<pre><code>FreeRTOSv9.0.0\n     │  \n     ├─ New - Direct to Task Notifications\n     ├─ New - FreeRTOS+TCP\n     ├─ Quick_Start_Guide\n     ├─ Upgrading-to-FreeRTOS-9\n     │\n     ├─ FreeRTOS-Plus            // 包含 FreeRTOS+组件(TCP/CLI/IO/UDP)和演示项目\n     │        │\n     │        ├─ Demo\n     │        ├─ Source\n     │        └─ readme.txt      // 当前目录的一些文档说明\n     │\n     ├─ FreeRTOS                 // 包含 FreeRTOS实时内核源代码文件和演示项目(主要移植这个)\n     │      │\n     │      ├─ Demo              // 包含演示应用程序项目\n     │      ├─ License           // 许可说明\n     │      ├─ Source            // 包含实时内核源代码\n     │      ├─ links_to_doc_pages_for_the_demo_projects\n     │      └─ readme.txt        // 当前目录的一些文档说明\n     │\n     └─ readme.txt               // 主目录文档的大致说明\n</code></pre>\n<p>因为之后的实验是以移植 FreeRTOS 这个文件为主，所以主要讲解这个文件里面的东西</p>\n<p><strong>1、首先是 FreeRTOS/Source 文件</strong></p>\n<pre><code>FreeRTOS\n    └─ Source                     // 核心 FreeRTOS内核文件\n           │\n           ├─ include             // 核心 FreeRTOS内核头文件\n           │\n           ├─ portable            // 与处理器相关的特定代码\n           │     │\n           │     ├─ Compiler x    // 编译器x 支持的所有端口\n           │     ├─ Compiler y    // 编译器y 支持的所有端口\n           │     ├─ MemMang       // 堆实现的示例\n           │     └─ readme.txt    // 当前目录的一些文档说明\n           │\n           └─ readme.txt          // 当前目录的一些文档说明\n</code></pre>\n<p><img src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\" /></p>\n<p><code>FreeRTOS/Source</code>  目录包含 FreeRTOS 源代码，并包含它自己的自述文件。</p>\n<p><code>FreeRTOS/Source/Portable</code>  目录包含特定于特定微控制器和或编译器的文件。</p>\n<p><code>FreeRTOS/Source/include</code>  目录包含实时内核头文件。</p>\n<p>核心 RTOS 代码包含在三个文件中，他们分别是  <code>tasks.c</code> ，  <code>queue.c</code>  和  <code>list.c</code> ，这三个文件位于  <code>FreeRTOS/Source</code>  目录中；同一目录下还包含两个名为  <code>timers.c</code>  和  <code>croutine.c</code>  的可选文件，它们分别实现软件计时器和协同例程功能。</p>\n<p>同样的，官方提供的几个堆的分配方案也位于可移植层中。各种样本  <code>heap_x.c</code>  文件位于  <code>FreeRTOS/Source/portable/MemMang</code>  目录中</p>\n<p><strong>2、FreeRTOS/Demo 文件</strong></p>\n<pre><code>FreeRTOS\n    └─ Demo                       // 演示应用程序项目\n        │\n        ├─ Common                 // 所有演示使用的演示应用程序文件\n        │\n        ├─ Dir x                  // 端口 x的演示应用程序构建文件\n        │\n        ├─ Dir y                  // 端口 y的演示应用程序构建文件\n        │\n        └─ readme.txt             // 当前目录的一些文档说明\n \n</code></pre>\n<p><code>FreeRTOS/Demo</code>  目录包含用于每种处理器体系结构和编译器端口的演示应用程序。演示应用程序的大部分代码对所有端口通用，并且包含在  <code>FreeRTOS/Demo/Common/Minimal</code>  目录中（位于  <code>FreeRTOS/Demo/Common/Full</code>  目录中的代码是旧代码，仅由 PC 端口使用） 。</p>\n<p>其余的  <code>FreeRTOS/Demo</code>  子目录包含用于构建单个演示应用程序的预配置项目，目录被命名以指示它们所关联的端口；每个 RTOS 端口目录下包含着自己的  <code>readme</code>  文件，而且它们还具有其自己的网页，该<a href=\"https://www.freertos.org/a00090.html\">网页</a>详细说明了可在其中找到该端口的演示应用程序的目录。</p>\n<h1 id=\"其他\"><a class=\"anchor\" href=\"#其他\">#</a> 其他</h1>\n<p>具体的关于官方文档解析的更多信息可以看当前目录下的  <code>readme</code>  文件以及在官方的这个链接查看：<a href=\"https://www.freertos.org/a00017.html\">https://www.freertos.org/a00017.html</a></p>\n",
            "tags": [
                "history",
                "FreeRTOS",
                "RTOS"
            ]
        }
    ]
}